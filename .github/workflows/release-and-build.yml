name: Release and PPA Build

on:
  push:
    branches: [ main, dev, stable, 'release/**' ]

permissions:
  contents: write
  pull-requests: write

jobs:
  process-release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with: { fetch-depth: 0 }

      - uses: pnpm/action-setup@v4
        with: { version: 10 }

      - uses: actions/setup-node@v4
        with:
          node-version: 22.15.1
          cache: 'pnpm'

      - name: Calculate Version
        id: calver
        run: |
          VERSION=$(node scripts/calculate-version.cjs)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          if [[ $GITHUB_REF == 'refs/heads/main' ]]; then DEST="ppa-build";
          elif [[ $GITHUB_REF == 'refs/heads/dev' ]]; then DEST="ppa-build-dev";
          elif [[ $GITHUB_REF == 'refs/heads/stable' ]]; then DEST="ppa-build-stable";
          else DEST="ppa-build-${GITHUB_REF##*/}"; fi
          echo "dest_branch=$DEST" >> $GITHUB_OUTPUT

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Create Release Tag
        id: changesets
        uses: changesets/action@v1
        with:
          version: node scripts/manual-version-update.cjs ${{ steps.calver.outputs.version }}
          commit: "chore: version bump to ${{ steps.calver.outputs.version }} [skip ci]"
          title: "Version Packages (${{ steps.calver.outputs.version }})"
          createGithubReleases: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Production Build
        run: pnpm run build
        env:
          VITE_APP_VERSION: ${{ steps.calver.outputs.version }}
          VITE_APP_COMMIT: ${{ github.sha }}
          VITE_API_URL: /api/v2/
          VITE_API_URL_OLD: /api/
          VITE_ROOT_PATH: /new_dashboard/

      - name: Prepare PPA Branch
        run: |
          # Create a temporary directory to hold build artifacts
          mkdir ../ppa-temp
          cp -r dist/* ../ppa-temp/
          cp .gitignore ../ppa-temp/ || true
          
          # Switch to the target branch (cleanly)
          git checkout --orphan tmp-branch
          git rm -rf .
          
          # Move files back to the root
          cp -r ../ppa-temp/* .
          rm -rf ../ppa-temp

      - name: Deploy to Build Branch
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          branch: ${{ steps.calver.outputs.dest_branch }}
          create_branch: true
          push_options: '--force'
          commit_message: 'Build v${{ steps.calver.outputs.version }} [${{ github.sha }}]'