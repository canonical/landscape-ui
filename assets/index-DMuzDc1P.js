import{d as A,k as L,l as M,m as J,ac as X,B as G,P as O,C as B,au as Z,f as x,t as $,n as w,v as U,w as D,j as e,ah as b,e as n,x as p,a3 as N,U as C,J as m,aM as ee,a9 as te,aI as se,o as F,ay as ie,D as ae,S as oe,R as ne,aJ as le,y as re,V as ce,N as ue,K as de,a as pe,aE as me}from"./index-CmSMPezD.js";import{W as ge,a as fe}from"./index-DWWVr521.js";import{b as St,c as _t,d as Tt,u as Ft,e as Ct}from"./index-DWWVr521.js";import{d as V}from"./WslInstancesEmptyState-BFVGDpaK.js";import{e as Rt,u as vt}from"./WslInstancesEmptyState-BFVGDpaK.js";import{A as Q}from"./AssociationBlock-1lK2AqyH.js";import{C as he}from"./CodeEditor-BxMd2z1P.js";import{F as xe}from"./FileInput-D5DnIGS5.js";import{S as H}from"./SidePanelFormButtons-CjUuXzzk.js";import{u as z}from"./useGetWslInstanceTypes-B9nuNzok.js";import{u as W}from"./useRoles-BTw0Yb4r.js";import{P as k}from"./ProfileAssociatedInstancesLink-B8CGCq04.js";import{P as be}from"./ProfileAssociationInfo-0VsIpGaW.js";import"./index-mOkivHGi.js";import{S as Ie}from"./SidePanelTableFilterChips-CJJrkYHs.js";import{L as Pe}from"./constants-Cb-1ccE2.js";import{u as ye}from"./useGetInstances-CQwDkYaW.js";import{u as je}from"./useSelection-CwhE5WgS.js";import"./PageMain-BwmfPOT4.js";import"./useGetWslLimits-5v9FRjSG.js";import"./HeaderWithSearch-DlYciVG-.js";import"./constants-Bo5C7ZUM.js";import"./TextConfirmationModal-B_Arotg1.js";import"./table-CdFwMAPu.js";import"./GroupFilter-Cqjaoau6.js";import"./MultiSelectField-B3pDsC9j.js";import"./useGetTags-DJiNc4pX.js";import"./SidePanelFormButtons.module-CcPyiogC.js";const Se=()=>{const t=A(),i=L(),{isPending:s,mutateAsync:l}=M({mutationFn:async u=>t.post("child-instance-profiles",u),onSuccess:async()=>i.invalidateQueries({queryKey:["wslProfiles"]})});return{isAddingWslProfile:s,addWslProfile:l}},_e=()=>{const t=A(),i=L(),{isPending:s,mutateAsync:l}=M({mutationFn:async({name:u,...g})=>t.patch(`child-instance-profiles/${u}`,g),onSuccess:async()=>i.invalidateQueries({queryKey:["wslProfiles"]})});return{editWslProfile:l,isEditingWslProfile:s}},Te=({profile_name:t},i={})=>{const s=A(),{data:l,isPending:u,error:g}=J({queryKey:["wslProfile",t],queryFn:async({signal:I})=>s.get(`child-instance-profiles/${t}`,{signal:I}),...i});return{wslProfile:l?.data,wslProfileError:g,isGettingWslProfile:u}},Fe=1,K=[{label:"Select",value:""},{label:"From a file",value:"file"},{label:"Plain text",value:"text"}],Ce="You can use a cloud-init configuration YAML file under 1MB to register new WSL instances. Cloud-init streamlines the setup by automating installation and configuration tasks.",we=[/^ubuntu$/,/^ubuntu-preview$/,/^ubuntu-[0-9]{2}\.[0-9]{2}$/],Re={title:"",access_group:X,description:"",instanceType:"",customImageName:"",rootfsImage:"",cloudInitType:"",cloudInit:null,all_computers:!1,tags:[]},Y=t=>{const i=new Blob([t],{type:"application/x-yaml"});return new File([i],"myFile.yaml",{type:"application/x-yaml"})},ve=()=>G().shape({title:x().required("This field is required"),access_group:x().required("This field is required"),description:x().required("This field is required"),instanceType:x().required("This field is required"),rootfsImage:x().when("instanceType",{is:"custom",then:t=>t.required("This field is required"),otherwise:t=>t.notRequired()}),customImageName:x().when("instanceType",{is:"custom",then:t=>t.required("This field is required").test("not-match-reserved-patterns","Instance name cannot match 'ubuntu', 'ubuntu-preview', or 'ubuntu-<dd>.<dd>'",i=>!we.some(s=>s.test(i.toLowerCase()))),otherwise:t=>t.notRequired()}),cloudInitType:x(),cloudInit:Z().nullable().when("cloudInitType",{is:t=>t==="file"||t==="text",then:t=>t.required("This field is required").test("file-size","File size must be less than 1MB",i=>(typeof i=="string"&&(i=Y(i)),i?i.size===void 0?!1:i.size<=Fe*1024*1024:!0)),otherwise:t=>t.notRequired()}),all_computers:B(),tags:O().of(x())}),Ae=t=>{if(t)return new Promise((i,s)=>{const l=new FileReader;l.readAsDataURL(t),l.onload=()=>{i(l.result)},l.onerror=u=>{s(u)}})},Ne=async t=>{if(t===null)return;let i;typeof t=="string"?i=Y(t):i=t;const s=await Ae(i);return s?s.split(",")[1]:void 0},We="_block_tz139_1",Ee={block:We},xt=()=>{const t=$(),{createPageParamsSetter:i}=w(),{notify:s}=U(),{getAccessGroupQuery:l}=W(),{addWslProfile:u}=Se(),{data:g}=l(),{isGettingWslInstanceTypes:I,wslInstanceTypes:P}=z(),y=P.map(({label:o,name:d})=>({label:o,value:d}))||[],j=[{label:"Select",value:""},...y,{label:"From URL",value:"custom"}],f=g?.data.map(({name:o,title:d})=>({label:d,value:o}))??[],S=i({sidePath:[]}),a=D({initialValues:Re,onSubmit:async o=>{try{const d=await Ne(o.cloudInit),c=(await u({title:o.title,access_group:o.access_group,description:o.description,image_name:o.instanceType==="custom"?o.customImageName:o.instanceType,image_source:o.rootfsImage,cloud_init_contents:d,all_computers:o.all_computers,tags:o.tags})).data.computers.constrained.length;S(),s.success({title:`Profile "${o.title}" added successfully`,message:`It has been associated with ${c} instances`})}catch(d){t(d)}},validationSchema:ve()}),T=async o=>{await a.setFieldValue("cloudInit",o[0])},r=async()=>{await a.setFieldValue("cloudInit",null)};return e.jsxs(e.Fragment,{children:[e.jsx(b.Header,{children:"Add WSL profile"}),e.jsx(b.Content,{children:e.jsxs(n.Form,{onSubmit:a.handleSubmit,noValidate:!0,children:[e.jsx(n.Input,{type:"text",label:"Title",required:!0,...a.getFieldProps("title"),error:p(a,"title")}),e.jsx(n.Input,{type:"text",label:"Description",required:!0,...a.getFieldProps("description"),error:p(a,"description")}),e.jsx(n.Select,{label:"Access group","aria-label":"Access group",required:!0,options:f,...a.getFieldProps("access_group"),error:p(a,"access_group")}),e.jsxs("div",{className:Ee.block,children:[(a.values.instanceType!==""||a.values.cloudInitType!=="")&&e.jsx(n.Notification,{severity:"caution",title:"Warning",children:e.jsx("span",{children:"Once the profile is added, you cannot modify the rootfs image or cloud-init file."})}),e.jsx(n.Select,{label:"Rootfs image",disabled:I,"aria-label":"Rootfs image",options:j,required:!0,...a.getFieldProps("instanceType"),error:p(a,"instanceType")}),a.values.instanceType==="custom"&&e.jsxs(e.Fragment,{children:[e.jsx(n.Input,{label:"Image name",type:"text",required:!0,...a.getFieldProps("customImageName"),error:p(a,"customImageName")}),e.jsx(n.Input,{type:"text",label:"Rootfs image URL",required:!0,...a.getFieldProps("rootfsImage"),error:p(a,"rootfsImage"),help:"The file path must be reachable by the affected WSL instances."})]}),e.jsx(n.Select,{label:"Cloud-init","aria-label":"Cloud-init",options:K,...a.getFieldProps("cloudInitType"),onChange:async o=>{a.getFieldProps("cloudInitType").onChange(o),await a.setFieldValue("cloudInit",null)},error:p(a,"cloudInitType")}),a.values.cloudInitType==="file"&&e.jsx(xe,{label:"Upload cloud-init",labelClassName:"u-off-screen",accept:".yaml",...a.getFieldProps("cloudInit"),value:a.values.cloudInit instanceof File?a.values.cloudInit:null,onFileRemove:r,onFileUpload:T,help:Ce,error:p(a,"cloudInit")}),a.values.cloudInitType==="text"&&e.jsx(he,{label:"Cloud-init configuration",onChange:o=>{a.setFieldValue("cloudInit",o??"")},value:typeof a.values.cloudInit=="string"?a.values.cloudInit:"",language:"yaml",defaultValue:"# paste cloud-init config here",error:p(a,"cloudInit")})]}),e.jsx(Q,{formik:a}),e.jsx(H,{submitButtonText:"Add WSL profile",submitButtonAriaLabel:"Add a new WSL profile",submitButtonDisabled:a.isSubmitting,onCancel:S})]})})]})},E=()=>{const{profile:t}=w(),{wslProfile:i,isGettingWslProfile:s,wslProfileError:l}=Te({profile_name:t});if(l)throw l;return s?{wslProfile:void 0,isGettingWslProfile:!0}:{wslProfile:i,isGettingWslProfile:!1}},bt=()=>{const{createSidePathPusher:t}=w(),{getAccessGroupQuery:i}=W(),{wslProfile:s,isGettingWslProfile:l}=E(),{data:u,isPending:g}=i(),{value:I,setTrue:P,setFalse:y}=N();if(l||g)return e.jsx(b.LoadingState,{});const j=t("edit");return e.jsxs(e.Fragment,{children:[e.jsx(b.Header,{children:s.title}),e.jsxs(b.Content,{children:[e.jsx("div",{className:"p-segmented-control",children:e.jsxs("div",{className:"p-segmented-control__list",children:[e.jsxs(n.Button,{type:"button",hasIcon:!0,className:"p-segmented-control__button",onClick:j,children:[e.jsx(n.Icon,{name:"edit"}),e.jsx("span",{children:"Edit"})]}),e.jsxs(n.Button,{type:"button",hasIcon:!0,className:"p-segmented-control__button","aria-label":`Remove ${s.title} profile`,onClick:P,children:[e.jsx(n.Icon,{name:n.ICONS.delete}),e.jsx("span",{children:"Remove"})]})]})}),e.jsxs(C,{children:[e.jsx(C.Item,{children:e.jsxs(m,{children:[e.jsx(m.Item,{label:"Title",value:s.title}),e.jsx(m.Item,{label:"Name",value:s.name}),e.jsx(m.Item,{label:"Access group",value:ee(s.access_group,u)}),e.jsx(m.Item,{label:"Description",large:!0,value:s.description})]})}),e.jsx(C.Item,{children:e.jsxs(m,{children:[e.jsx(m.Item,{label:"Rootfs image name",large:!0,value:s.image_name}),s.image_source!==null&&e.jsx(m.Item,{label:"Rootfs image source",large:!0,value:s.image_source,type:"truncated"}),e.jsx(m.Item,{label:"Cloud-init",large:!0,value:s.cloud_init_contents})]})}),e.jsx(C.Item,{title:"Association",children:e.jsx(be,{profile:s,children:e.jsxs(m,{children:[e.jsx(m.Item,{label:"Tags",large:!0,value:s.tags.join(", "),type:"truncated"}),e.jsx(m.Item,{label:"Associated parents",large:!0,value:e.jsx(k,{count:s.computers.constrained.length,profile:s,query:`wsl:${s.id}`})}),e.jsx(m.Item,{label:"Not compliant",value:e.jsx(ge,{wslProfile:s,onClick:t("noncompliant")})}),e.jsx(m.Item,{label:"Compliant",value:e.jsx(k,{profile:s,count:s.computers.constrained.length-s.computers["non-compliant"].length,query:`wsl:${s.id}:compliant`})})]})})})]})]}),e.jsx(fe,{isOpen:I,close:y,wslProfile:s})]})},ke=()=>G().shape({title:x().required("This field is required"),description:x().required("This field is required"),access_group:x().required("This field is required"),all_computers:B(),tags:O().of(x())}),qe="_block_tz139_1",Le={block:qe},Me=({profile:t})=>{const{getAccessGroupQuery:i}=W(),s=$(),{sidePath:l,popSidePath:u,createPageParamsSetter:g}=w(),{notify:I}=U(),{editWslProfile:P}=_e(),{wslInstanceTypes:y}=z(),j=y.map(({label:o,name:d})=>({label:o,value:d}))||[],f=[{label:"Select",value:""},...j,{label:"From URL",value:"custom"}],{data:S}=i(),h=S?.data.map(({name:o,title:d})=>({label:d,value:o}))??[],a=g({sidePath:[],profile:""}),T=async o=>{try{await P({name:t.name,title:o.title,access_group:o.access_group,description:o.description,all_computers:o.all_computers,tags:o.tags}),a(),I.success({title:"WSL profile updated",message:`WSL profile "${t.title}" updated successfully`})}catch(d){s(d)}},r=D({initialValues:{title:t.title,access_group:t.access_group,description:t.description,instanceType:t.image_source?"custom":t.image_name,customImageName:t.image_source?t.image_name:"",rootfsImage:t.image_source||"",all_computers:t.all_computers,tags:t.tags},onSubmit:T,validationSchema:ke()});return e.jsxs(n.Form,{onSubmit:r.handleSubmit,noValidate:!0,children:[e.jsx(n.Input,{type:"text",label:"Title",required:!0,...r.getFieldProps("title"),error:p(r,"title")}),e.jsx(n.Input,{type:"text",label:"Description",required:!0,...r.getFieldProps("description"),error:p(r,"description")}),e.jsx(n.Select,{label:"Access group","aria-label":"Access group",options:h,required:!0,...r.getFieldProps("access_group"),error:p(r,"access_group")}),e.jsxs("div",{className:Le.block,children:[e.jsx(n.Notification,{severity:"caution",title:"Editing unavailable",children:e.jsx("span",{children:"You cannot edit rootfs image or cloud-init file. To modify these fields, create a new profile."})}),e.jsx(n.Select,{disabled:!0,label:"Rootfs image","aria-label":"Rootfs image",options:f,...r.getFieldProps("instanceType"),error:p(r,"instanceType")}),r.values.instanceType==="custom"&&e.jsxs(e.Fragment,{children:[e.jsx(n.Input,{disabled:!0,label:"Image name",type:"text",required:!0,...r.getFieldProps("customImageName"),error:p(r,"customImageName")}),e.jsx(n.Input,{disabled:!0,type:"text",label:"Rootfs image URL",required:!0,...r.getFieldProps("rootfsImage"),error:p(r,"rootfsImage"),help:"The file path must be reachable by the affected WSL instances."})]}),e.jsx(n.Select,{label:"Cloud-init","aria-label":"Cloud-init",options:K,disabled:!0})]}),e.jsx(Q,{formik:r}),e.jsx(H,{submitButtonText:"Save changes",submitButtonDisabled:r.isSubmitting,onCancel:a,hasBackButton:l.length>1,onBackButtonPress:u})]})},It=()=>{const{wslProfile:t,isGettingWslProfile:i}=E();return i?e.jsx(b.LoadingState,{}):e.jsxs(e.Fragment,{children:[e.jsxs(b.Header,{children:['Edit "',t.title,'" profile']}),e.jsx(b.Content,{children:e.jsx(Me,{profile:t})})]})},Ge="_header_513lp_1",Oe="_search_513lp_8",q={header:Ge,search:Oe},Be=({instance:t})=>{const{value:i,setTrue:s,setFalse:l}=N();return e.jsxs(e.Fragment,{children:[e.jsx(te,{destructiveActions:[{icon:"security-tick",label:"Make compliant",onClick:s}],toggleAriaLabel:`${t.title} actions`}),e.jsx(V,{close:l,instances:[t],isOpen:i})]})},$e=t=>({column:i,row:{index:s}})=>i.id==="profiles"&&t===s?{className:"expandedCell"}:{},Ue=t=>({index:i})=>t===i?{className:"expandedRow"}:{},De=({wslProfile:t})=>{const{expandedRowIndex:i,getTableRowsRef:s,handleExpand:l}=se(),[u,g]=F.useState(""),[I]=F.useState(ie),[P]=F.useState(ae),[y,j]=F.useState(""),{instances:f,isGettingInstances:S}=ye({query:[y,`profile:wsl:${t.id}:noncompliant`].filter(Boolean).join(" "),limit:P,offset:(I-1)*P,with_wsl_profiles:!0}),{selectedItems:h,setSelectedItems:a}=je(f,S),{value:T,setTrue:r,setFalse:o}=N(),d=F.useMemo(()=>[{accessor:"title",Header:e.jsxs(e.Fragment,{children:[e.jsx(n.CheckboxInput,{label:e.jsx("span",{className:"u-off-screen",children:"Toggle all instances"}),inline:!0,disabled:!f.length,indeterminate:!!h.length&&h.length<f.length,checked:!!f.length&&h.length===f.length,onChange:({currentTarget:{checked:c}})=>{a(c?f:[])}}),"Instance name"]}),Cell:({row:{original:c}})=>e.jsxs(e.Fragment,{children:[e.jsx(n.CheckboxInput,{inline:!0,label:e.jsxs("span",{className:"u-off-screen",children:["Select ",c.title]}),checked:h.includes(c),onChange:({currentTarget:{checked:_}})=>{a(_?[...h,c]:h.filter(v=>v!==c))}}),e.jsx(oe,{to:ne.instances.details.single(c.id),children:c.title})]})},{Header:"OS",Cell:({row:{original:c}})=>c.distribution_info?.description},{accessor:"profiles",Header:"WSL profiles",Cell:({row:{original:c,index:_}})=>e.jsx(le,{content:c.wsl_profiles?.map(v=>v.title).join(", "),isExpanded:_===i,onExpand:()=>{l(_)}})},{Header:"Last ping",Cell:({row:{original:c}})=>{const _=re(c.last_ping_time);return _.isValid()?e.jsx("span",{className:"font-monospace",children:_.format(ce)}):e.jsx(ue,{})}},{...Pe,Cell:({row:{original:c}})=>e.jsx(Be,{instance:c})}],[f,h,i]),R=()=>{g(""),j("")};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:q.header,children:[e.jsx(n.SearchBox,{className:de("u-no-margin--bottom",q.search),externallyControlled:!0,value:u,onChange:g,onClear:R,onSearch:j,autoComplete:"off"}),e.jsxs(n.Button,{type:"button",className:"u-no-margin",hasIcon:!0,onClick:r,disabled:!h.length,children:[e.jsx(n.Icon,{name:"security-tick"}),e.jsx("span",{children:"Make compliant"})]})]}),e.jsx(Ie,{filters:[{label:"Search",item:y||void 0,clear:R}]}),S?e.jsx(pe,{}):e.jsx("div",{ref:s,children:e.jsx(me,{columns:d,data:f,emptyMsg:"No Windows instances found according to your search parameters.",getCellProps:$e(i),getRowProps:Ue(i)})}),e.jsx(V,{close:o,instances:h,isOpen:T})]})},Pt=()=>{const{wslProfile:t,isGettingWslProfile:i}=E();return i?e.jsx(b.LoadingState,{}):e.jsxs(e.Fragment,{children:[e.jsxs(b.Header,{children:["Instances not compliant with ",t.title]}),e.jsx(b.Content,{children:e.jsx(De,{wslProfile:t})})]})};export{xt as WslProfileAddSidePanel,bt as WslProfileDetailsSidePanel,It as WslProfileEditSidePanel,Pt as WslProfileNonCompliantInstancesSidePanel,St as WslProfilesEmptyState,_t as WslProfilesHeader,Tt as WslProfilesList,Se as useAddWslProfile,Ft as useDeleteWslProfile,_e as useEditWslProfile,Te as useGetWslProfile,Ct as useGetWslProfiles,Rt as useMakeWindowsInstancesCompliant,vt as useReapplyWslProfile};
