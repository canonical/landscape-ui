import{j as e,g as m,a as $,e as w,l as D,k as A,r,o as L,R as O,B,h as F}from"./index-CreLYkd7.js";import{m as I}from"./moment-CZq-kU5w.js";import{N as V}from"./NoData-DSmFbKcn.js";import{T as q}from"./TruncatedCell-DKXbHzqA.js";import{E as Y}from"./ExpandableTableFooter-96Dq4I1B.js";import{u as G}from"./useConfirm-Bodc886s.js";import{u as W}from"./useUsns-BVJPe5bq.js";import{u as z}from"./usePageParams-MY5k-CLu.js";import{U as J,g as K,c as j,a as Q,h as R,b as S}from"./helpers-BfuBH7Ij.js";import{u as X}from"./useOnClickOutside-C2HBgAKD.js";const _=({additionalCta:d,columns:c,data:s,limit:o,onLimitChange:y,itemNames:t,totalCount:g,getCellProps:l,getRowProps:p,title:u})=>e.jsxs(e.Fragment,{children:[u&&e.jsx("p",{className:"p-heading--5",children:u}),e.jsx(m.ModularTable,{columns:c,data:s,className:"u-no-margin--bottom",getCellProps:l,getRowProps:p}),e.jsx(Y,{additionalCta:d,itemNames:t,limit:o,onLimitChange:y,totalCount:g})]}),E=({limit:d,onLimitChange:c,usn:s,...o})=>{const y=$(),t=w(),{notify:g}=D(),{confirmModal:l,closeConfirmModal:p}=G(),{getAffectedPackagesQuery:u,removeUsnPackagesQuery:k}=W(),{setPageParams:C}=z(),{instanceId:b,childInstanceId:i}=A(),h=Number(b),{mutateAsync:T}=k,a=()=>{y(`${O}instances/${i?`${h}/${i}`:`${h}`}`),C({tab:"activities"}),g.clear()},n=async()=>{try{await T({usns:s,instanceId:h}),g.success({title:"You queued packages to be uninstalled",message:`Packages affected by "${s}" security issue will be uninstalled and are queued in Activities.`,actions:[{label:"View details",onClick:()=>a()}]})}catch(U){t(U)}finally{p()}},f=U=>{l({title:"Uninstall USN packages",body:`This will uninstall packages affected by "${s}" security issue from the "${U}" instance.`,buttons:[e.jsx(m.Button,{type:"button",appearance:"negative",onClick:()=>n(),children:"Uninstall"},"remove")]})},v=o.isRemovable?[e.jsxs(m.Button,{type:"button",small:!0,dense:!0,hasIcon:!0,onClick:()=>f(o.instanceTitle),children:[e.jsx(m.Icon,{name:"delete",className:"u-no-margin--left"}),e.jsx("span",{children:"Uninstall packages"})]},"remove")]:void 0,{data:x,isLoading:H}=u({usn:s,computer_ids:o.isRemovable?[h]:o.instanceIds}),N=r.useMemo(()=>(x==null?void 0:x.data.slice(0,d))||[],[x,d]),M=r.useMemo(()=>[{accessor:"name",Header:"Package"},{accessor:"current_version",Header:"Current version"},{accessor:"new_version",Header:"New version"},{accessor:"summary",Header:"Details"}],[N.length]);return H?e.jsx(L,{}):e.jsx(_,{additionalCta:v,columns:M,data:N,itemNames:{plural:"packages",singular:"package"},limit:d,onLimitChange:c,totalCount:(x==null?void 0:x.data.length)??0})},oe=({isUsnsLoading:d,usns:c,...s})=>{const[o,y]=r.useState(5),[t,g]=r.useState(""),[l,p]=r.useState(-1),[u,k]=r.useState(5),C=r.useRef([]);X({current:l!==-1?C.current[l]:null},()=>p(-1));const b=r.useMemo(()=>d?[J]:K(c,t,s.tableType,o),[c,t,d,o,s.tableType]),i=s.tableType==="paginated"?s.selectedUsns:[],h=a=>{if(s.tableType==="expandable")return;const n=i.filter(f=>f.usn!==a.usn);s.onSelectedUsnsChange(i.length!==n.length?n:[...n,a])},T=r.useMemo(()=>[{accessor:"checkbox",className:j.checkboxColumn,Header:()=>s.tableType==="paginated"&&e.jsx(m.CheckboxInput,{inline:!0,label:e.jsx("span",{className:"u-off-screen",children:"Toggle all security issues"}),disabled:b.length===0||b[0].usn==="loading",indeterminate:i.length>0&&i.length<c.length,checked:i.length>0&&i.length===c.length,onChange:()=>s.onSelectedUsnsChange(i.length>0?[]:c)}),Cell:({row:a})=>s.tableType==="paginated"&&e.jsx(m.CheckboxInput,{labelClassName:"u-no-margin--bottom u-no-padding--top",label:e.jsx("span",{className:"u-off-screen",children:`Toggle ${a.original.usn}`}),name:"usn",checked:i.some(({usn:n})=>n===a.original.usn),onChange:()=>h(a.original)})},{accessor:"usn",Header:"USN",Cell:({row:a})=>a.original.usn==="expandedUsn"?s.tableType==="expandable"?e.jsx(E,{isRemovable:!1,instanceIds:s.instanceIds,limit:u,onLimitChange:()=>k(n=>n+5),usn:t}):e.jsx(E,{isRemovable:!0,instanceTitle:s.instanceTitle,limit:u,onLimitChange:()=>k(n=>n+5),usn:t}):a.original.usn==="loading"?e.jsx(L,{}):e.jsx("a",{href:a.original.usn_link,target:"_blank",rel:"nofollow noopener noreferrer",children:a.original.usn})},{accessor:"cves",Header:"CVE(s)",Cell:({row:{original:a,index:n}})=>e.jsx(q,{content:a.cves.map(({cve:f,cve_link:v})=>e.jsx("span",{className:j.cve,children:e.jsx("a",{href:v,target:"_blank",rel:"nofollow noopener noreferrer",className:j.cveLink,children:f})},f)),isExpanded:l===n,onExpand:()=>{g(""),p(t?n-1:n)}})},{accessor:"date",Header:"Date published",Cell:({row:a})=>e.jsx(e.Fragment,{children:I(a.original.date).isValid()?I(a.original.date).format(B):e.jsx(V,{})})},{accessor:"release_packages",Header:"Affected packages",Cell:({row:a})=>e.jsx(e.Fragment,{children:e.jsx(m.Button,{type:"button",className:F("p-accordion__tab",j.expandButton),"aria-expanded":a.original.usn===t,onClick:()=>{p(-1),g(n=>n===a.original.usn?"":a.original.usn),k(5)},children:`${a.original.usn===t?"Hide":"Show"} packages`})})}].filter(({accessor:a})=>s.tableType==="paginated"||a!=="checkbox"),[b,u,i.length,s.tableType,l]);return e.jsx("div",{ref:Q(C),children:s.tableType==="expandable"?e.jsx(_,{columns:T,data:b,getCellProps:R(s.tableType,l,t),getRowProps:S(l),itemNames:{plural:"security issues",singular:"security issue"},limit:o,onLimitChange:()=>y(a=>a+5),title:"Security issues",totalCount:c.length}):e.jsx(m.ModularTable,{columns:T,data:b,getCellProps:R(s.tableType,l,t),getRowProps:S(l),emptyMsg:`No security issues found with the search "${s.search}"`})})};export{_ as E,oe as U};
