import{i as C,l as n,v as f,k as A,m as P,q as N,s as O,g as $,t as k,j as s,h as i}from"./index-P3tcVer_.js";import{h as u,m as y}from"./usePageParams-CZXld3eS.js";import{M as h}from"./MultiSelectField-BmwwnNbV.js";import{S as R}from"./SidePanelFormButtons-CEx4Wy-H.js";import{u as V}from"./useInstances-Dt0ImR3b.js";import{u as E,D as w}from"./DeliveryBlock-DQX6CCmk.js";import{b as D}from"./helpers-CmPE_LZU.js";import{u as B}from"./useRoles-oaQYE5g1.js";import"./InstancesPageActions-SaA8hNJ6.js";import{g as m}from"./formikErrors-Bw8iTXYS.js";import"./SidePanelFormButtons.module-D2P5PizG.js";import"./useFetchOld-BGcQOp2P.js";import"./index-C4mrLuM2.js";import"./TablePagination-9PvQlVgk.js";import"./TablePaginationBase-DrquMGK2.js";import"./StatusFilter-BjWN4DdL.js";import"./TableFilter-DTXx6h3i.js";import"./TableFilterChips-HMcdOmXT.js";import"./NoData-DfvYDVkG.js";const L={access_group:"",deliver_after:"",deliverImmediately:!0,instanceIds:[],queryType:"tags",tags:[],username:"root",time_limit:300},U=C().shape({access_group:n(),deliverImmediately:A().required("This field is required."),deliver_after:n().when("deliverImmediately",{is:!1,then:r=>r.required("This field is required").test({test:o=>u(o).isValid()&&u(o).isAfter(u()),message:"You have to enter a valid date and time in the future"})}),instanceIds:f().of(P()).when("queryType",{is:"ids",then:r=>r.min(1,"At least one instance is required.")}),queryType:n().required("This field is required."),tags:f().of(n()).when("queryType",{is:"tags",then:r=>r.min(1,"At least one tag is required.")}),username:n().required("This field is required.")}),G="_instanceSelectionContainer_16uxl_1",M={instanceSelectionContainer:G},ue=({script:r})=>{const o=N(),{notify:S}=O(),{closeSidePanel:I}=$(),{getAllInstanceTagsQuery:b,getInstancesQuery:q}=V(),{getAccessGroupQuery:v}=B(),{data:l,isLoading:x}=v(),_=((l==null?void 0:l.data)??[]).map(e=>({label:e.title,value:e.name})),T=[{label:"Select access group",value:""},..._],{runScript:j}=E(),t=k({initialValues:L,onSubmit:async e=>{const a={query:e.queryType==="ids"?`id:${e.instanceIds.join(" OR id:")}`:`tag:${e.tags.join(" OR tag:")}`,script_id:r.id,username:e.username,time_limit:Number(e.time_limit),in_access_group:e.access_group,deliver_after:e.deliverImmediately?void 0:y(e.deliver_after).toISOString().replace(/\.\d+(?=Z$)/,"")};e.deliverImmediately||(a.deliver_after=y(e.deliver_after).toISOString().replace(/\.\d+(?=Z$)/,""));try{await j(a),I(),S.success({message:`"${r.title}" script queued to execute successfully`,title:"Script execution queued"})}catch(F){o(F)}},validationSchema:U}),{data:d}=b(),p=(d==null?void 0:d.data.results.map(e=>({label:e,value:e})))??[],{data:c}=q(),g=(c==null?void 0:c.data.results.filter(e=>D("runScripts",e)).map(({title:e,id:a})=>({label:e,value:a})))??[];return s.jsxs(i.Form,{onSubmit:t.handleSubmit,noValidate:!0,children:[s.jsx("p",{className:"u-no-margin--bottom",children:"Select instances by:"}),s.jsx("div",{className:"is-required",children:s.jsxs("div",{children:[s.jsx(i.Input,{type:"radio",label:"Tags",...t.getFieldProps("queryType"),value:"tags",checked:t.values.queryType==="tags"}),s.jsx(i.Input,{type:"radio",label:"Instance names",...t.getFieldProps("queryType"),value:"ids",checked:t.values.queryType==="ids"}),s.jsxs("div",{className:M.instanceSelectionContainer,children:[t.values.queryType==="tags"&&s.jsx(h,{placeholder:"Select tags",variant:"condensed",label:"Tags",labelClassName:"u-off-screen",required:!0,...t.getFieldProps("tags"),items:p,selectedItems:p.filter(({value:e})=>t.values.tags.includes(e)),onItemsUpdate:async e=>t.setFieldValue("tags",e.map(({value:a})=>a)),error:t.touched.tags&&typeof t.errors.tags=="string"?t.errors.tags:void 0}),t.values.queryType==="ids"&&s.jsx(h,{placeholder:"Select instances",variant:"condensed",label:"Instances",labelClassName:"u-off-screen",required:!0,...t.getFieldProps("instanceIds"),items:g,selectedItems:g.filter(({value:e})=>t.values.instanceIds.includes(e)),onItemsUpdate:async e=>t.setFieldValue("instanceIds",e.map(({value:a})=>a)),error:t.touched.instanceIds&&typeof t.errors.instanceIds=="string"?t.errors.instanceIds:void 0})]})]})}),s.jsx(i.Select,{label:"Access group",disabled:x,options:T,error:m(t,"access_group"),...t.getFieldProps("parent")}),s.jsxs(i.Row,{className:"u-no-padding--left u-no-padding--right",children:[s.jsx(i.Col,{size:6,children:s.jsx(i.Input,{type:"text",label:"Run as user",autoComplete:"off",required:!0,...t.getFieldProps("username"),error:m(t,"username")})}),s.jsx(i.Col,{size:6,children:s.jsx(i.Input,{type:"text",label:"Time limit (seconds)",autoComplete:"off",required:!0,...t.getFieldProps("time_limit"),error:m(t,"time_limit")})})]}),s.jsx(w,{formik:t}),s.jsx(R,{submitButtonDisabled:t.isSubmitting,submitButtonText:"Run script"})]})};export{ue as default};
