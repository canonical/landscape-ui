import{r as _,j as a,N as E,y as H,z as S,C as A,d as w,R as M,e as I,p as D,J as z,G as y}from"./index-CNSDWj8Q.js";import{m as v}from"./index-D-YBZSy_.js";import{E as j,S as L}from"./SelectAllButton-DqKWLeLb.js";import{N}from"./NoData-6ZK9sV5u.js";import{a as $}from"./TablePagination-CFXNvqsZ.js";import{T as F}from"./TruncatedCell-BMum6DLZ.js";import{u as R}from"./useUsns-dCIdMk13.js";import{R as V}from"./ResponsiveTable-BXalKviy.js";const O=({column:e})=>{const s={};return e.id==="title"?s.role="rowheader":e.id==="upgrades.security"&&(s["aria-label"]="Affected packages"),s},Q="_security_16o7z_1",q={security:Q},Y=({instances:e,limit:s,onLimitChange:i,usn:o,usnPackages:r})=>{const l=_.useMemo(()=>e.filter(({id:n})=>r.flatMap(({computer_ids:m})=>m).includes(n)).slice(0,s),[e,s,r]),t=_.useMemo(()=>[{accessor:"title",Header:"Name"},{accessor:"upgrades.security",className:q.security,Header:"Affected packages",Cell:({row:{original:n}})=>r.filter(({computer_ids:m})=>m.includes(n.id)).length}],[l.length]);return a.jsx(j,{columns:t,data:l,itemNames:{plural:"instances",singular:"instance"},onLimitChange:i,totalCount:l.length,title:a.jsxs("p",{className:"p-heading--4",children:["Instances affected by ",a.jsx("b",{children:o})]}),getCellProps:O})},G=({instanceTitle:e,usn:s})=>{const i=E(),o=H(),{notify:r}=S(),{removeUsnPackagesQuery:l}=R(),{instanceId:t,childInstanceId:n}=A(),m=Number(t),{mutateAsync:b,isPending:p}=l,d=()=>{i(M.instances.details.fromParams({instanceId:m,childInstanceId:n},{tab:"activities"})),r.clear()},h=async()=>{try{await b({usns:s,instanceId:m}),r.success({title:"You queued packages to be uninstalled",message:`Packages affected by "${s}" security issue will be uninstalled and are queued in Activities.`,actions:[{label:"View details",onClick:d}]})}catch(k){o(k)}};return a.jsxs(w.ConfirmationButton,{type:"button",className:"is-small is-dense has-icon",confirmationModalProps:{title:"Uninstall USN packages",children:a.jsxs("p",{children:['This will uninstall packages affected by "',s,'" security issue from the "',e,'" instance.']}),confirmButtonLabel:"Uninstall",confirmButtonAppearance:"negative",confirmButtonDisabled:p,confirmButtonLoading:p,onConfirm:h},children:[a.jsx(w.Icon,{name:"delete",className:"u-no-margin--left"}),a.jsx("span",{children:"Uninstall packages"})]},"remove")},J=({column:e})=>{const s={};return e.id==="name"?s.role="rowheader":e.id==="current_version"?s["aria-label"]="Current version":e.id==="new_version"?s["aria-label"]="New version":e.id==="summary"&&(s["aria-label"]="Details"),s},U=({instanceTitle:e,limit:s,onLimitChange:i,showRemoveButton:o,usn:r,usnPackages:l})=>{const t=_.useMemo(()=>l.slice(0,s),[s,l]),n=_.useMemo(()=>[{accessor:"name",Header:"Package"},{accessor:"current_version",Header:"Current version"},{accessor:"new_version",Header:"New version"},{accessor:"summary",Header:"Details"}],[t.length]);return a.jsx(j,{additionalCta:o&&a.jsx(G,{instanceTitle:e,usn:r}),columns:n,data:t,itemNames:{plural:"packages",singular:"package"},onLimitChange:i,title:a.jsxs("p",{className:"p-heading--4",children:["Packages affected by ",a.jsx("b",{children:r})]}),totalCount:l.length,getCellProps:J})},W=({instances:e,isRemovable:s,listType:i,usn:o})=>{const[r,l]=_.useState(5),{getAffectedPackagesQuery:t}=R(),{instanceId:n}=A(),m=Number(n),{data:b,isLoading:p}=t({usn:o,computer_ids:s?[m]:e.map(({id:h})=>h)}),d=b?.data??[];return a.jsxs(a.Fragment,{children:[p&&a.jsx(I,{}),!p&&i==="instances"&&a.jsx(Y,{instances:e,limit:r,onLimitChange:()=>{l(h=>h+5)},usn:o,usnPackages:d}),!p&&i==="packages"&&a.jsx(U,{instanceTitle:e[0].title,limit:r,onLimitChange:()=>{l(h=>h+5)},showRemoveButton:s,usn:o,usnPackages:d})]})},C={computers_count:0,cves:[],date:"",info:"",packages:[],usn:"",usn_link:""},K="_expanded_1vzjs_7",X="_expandButton_1vzjs_25",Z="_hidden_1vzjs_34",ee="_innerTable_1vzjs_38",se="_row_1vzjs_42",ae="_cve_1vzjs_48",te="_cveLink_1vzjs_52",ne="_wrapper_1vzjs_56",f={expanded:K,expandButton:X,hidden:Z,innerTable:ee,row:se,cve:ae,cveLink:te,wrapper:ne},ce=({expandedCell:e,isUsnsLoading:s,showSelectAllButton:i,usns:o})=>{const r=e?.column==="computers_count"||e?.column==="release_packages"?e.row+1:0;return[...[C].slice(i?0:1),...o.slice(0,r||o.length),...o.slice(r?r-1:o.length),...[C].slice(s?0:1)]},T=({expandedCell:e,isUsnsLoading:s,lastUsnIndex:i,showSelectAllButton:o})=>(({column:r,row:{index:l}})=>{const t={};return o&&l===0||s&&l===i||e?.row===l-1&&["computers_count","release_packages"].includes(e.column)?r.id==="usn"?(t.colSpan=5,e?.row===l-1&&["computers_count","release_packages"].includes(e.column)&&(t.className=f.innerTable)):(t.className=f.hidden,t["aria-hidden"]=!0):r.id==="usn"?t.role="rowheader":r.id==="cves"?(t["aria-label"]="CVE(s)",e?.column===r.id&&e.row===l&&(t.className="expandedCell")):r.id==="date"?t["aria-label"]="Date published":r.id==="computers_count"?(t["aria-label"]="Affected instances",t.className=e?.column===r.id&&e.row===l?f.expanded:f.row):r.id==="release_packages"&&(t["aria-label"]="Affected packages",t.className=e?.column===r.id&&e.row===l?f.expanded:f.row),t}),P=e=>({index:s})=>{const i={};return e?.column==="cves"&&e.row===s&&(i.className="expandedRow"),i},re=e=>s=>{s&&(e.current=[...s.querySelectorAll("tbody tr")])},fe=({instances:e,isUsnsLoading:s,onSelectedUsnsChange:i,selectedUsns:o,totalUsnCount:r,usns:l,...t})=>{const[n,m]=_.useState(null),b=_.useRef([]);D({current:n?.column==="cves"?b.current[n.row]:null},()=>{m(null)});const p=t.tableType==="expandable"&&t.showSelectAllButton,d=_.useMemo(()=>ce({expandedCell:n,isUsnsLoading:s,showSelectAllButton:p,usns:l}),[l,n,s,p]),h=c=>{i(o.includes(c)?o.filter(u=>u!==c):[...o,c])},k=(c,u)=>{m(g=>g&&g.column===c&&g.row===u?null:{column:c,row:g&&["computers_count","release_packages"].includes(g.column)&&g.row<u?u-1:u})},x=_.useMemo(()=>[{accessor:"checkbox",className:"checkbox-column",Header:()=>a.jsx(w.CheckboxInput,{inline:!0,label:a.jsx("span",{className:"u-off-screen",children:"Toggle all security issues"}),disabled:d.length===0||s,indeterminate:o.length>0&&o.length<l.length,checked:o.length>0&&o.length===l.length,onChange:()=>{i(o.length>0?[]:l.map(({usn:c})=>c))}}),Cell:({row:{original:c}})=>a.jsx(w.CheckboxInput,{labelClassName:"u-no-margin--bottom u-no-padding--top",label:a.jsx("span",{className:"u-off-screen",children:`Toggle ${c.usn}`}),disabled:s,name:"usn",checked:o.includes(c.usn),onChange:()=>{h(c.usn)}})},{accessor:"usn",Header:"USN",Cell:({row:{index:c,original:u}})=>c===0&&p?a.jsx(L,{count:t.totalSelectedUsnCount,itemName:{plural:"security issues",singular:"security issue"},onClick:t.onSelectAllClick,totalCount:r}):n?.row===c-1&&["computers_count","release_packages"].includes(n.column)?a.jsx(W,{isRemovable:n.column==="release_packages"&&t.tableType==="paginated",instances:e,listType:n.column==="release_packages"?"packages":"instances",usn:d[n.row].usn}):s&&c===d.length-1?a.jsx(I,{}):a.jsx("a",{href:u.usn_link,target:"_blank",rel:"nofollow noopener noreferrer",children:u.usn})},{accessor:"cves",Header:"CVE(s)",Cell:({row:{original:c,index:u}})=>c.cves.length>0?a.jsx(F,{content:c.cves.map(({cve:g,cve_link:B})=>a.jsx("span",{className:f.cve,children:a.jsx("a",{href:B,target:"_blank",rel:"nofollow noopener noreferrer",className:f.cveLink,children:g})},g)),isExpanded:n?.column==="cves"&&n.row===u,onExpand:()=>{k("cves",u)}}):a.jsx(N,{})},{accessor:"date",Header:"Date published",Cell:({row:c})=>a.jsx(a.Fragment,{children:v(c.original.date).isValid()?a.jsx("span",{className:"font-monospace",children:v(c.original.date).format(z)}):a.jsx(N,{})})},{accessor:"computers_count",Header:"Affected instances",Cell:({column:c,row:{index:u,original:g}})=>a.jsx(w.Button,{type:"button",className:y("p-accordion__tab",f.expandButton),"aria-expanded":n?.column===c.id&&n.row===u,onClick:()=>{k(c.id,u)},children:g.computers_count})},{accessor:"release_packages",Header:"Affected packages",Cell:({column:c,row:{index:u}})=>a.jsx(w.Button,{type:"button",className:y("p-accordion__tab",f.expandButton),"aria-expanded":n?.column===c.id&&n.row===u,onClick:()=>{k(c.id,u)},children:`${n?.column===c.id&&n.row===u?"Hide":"Show"} packages`})}].filter(({accessor:c})=>t.tableType==="paginated"?c!=="computers_count":c!=="date"),[d,s,o.length,t.tableType,n]);return a.jsx("div",{ref:re(b),className:f.wrapper,children:t.tableType==="expandable"?a.jsx(j,{columns:x,data:d,getCellProps:T({expandedCell:n,isUsnsLoading:s,lastUsnIndex:d.length-1,showSelectAllButton:p}),getRowProps:P(n),itemCount:l.length,itemNames:{plural:"security issues",singular:"security issue"},onLimitChange:t.onNextPageFetch,totalCount:r}):a.jsxs(a.Fragment,{children:[a.jsx(V,{columns:x,data:d,getCellProps:T({expandedCell:n,isUsnsLoading:s}),getRowProps:P(n),emptyMsg:`No security issues found with the search "${t.search}"`}),a.jsx($,{handleClearSelection:()=>{i([])},totalItems:r,currentItemCount:l.length})]})})};export{fe as U};
