import{r as d,j as u,n as S,g as P,m as T}from"./index-aJwsc68L.js";import{S as A,E as y}from"./SelectAllButton-gzQqZ10u.js";import{a as D}from"./usePackages-BAul2i7z.js";import"./usePageParams-CzH8WT2r.js";import"./ExpandableTableFooter-CMBk9S8b.js";import"./useFetchOld-DqwB-ncC.js";try{let e=typeof window<"u"?window:typeof global<"u"?global:typeof globalThis<"u"?globalThis:typeof self<"u"?self:{},t=new e.Error().stack;t&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[t]="53fffdbe-84c9-4c8c-94da-75b76cbb20b4",e._sentryDebugIdIdentifier="sentry-dbid-53fffdbe-84c9-4c8c-94da-75b76cbb20b4")}catch{}const E="_hidden_vofak_1",B={hidden:E},H=({lastPackageIndex:e,loading:t,showToggle:r})=>({column:s,row:{index:o}})=>{const n={};return(r&&o===0||t&&o===e)&&(s.id==="checkbox"?n.colSpan=5:(n.className=B.hidden,n["aria-hidden"]=!0)),n},M=(e,t,r)=>[...e.slice(t?-1:e.length),...e,...e.slice(r?-1:e.length)],v=(e,t)=>{const r=new Set(e),s=t.filter(({id:o})=>!r.has(o)).length;return s===0?"unchecked":s===t.length?"checked":"indeterminate"},R=({excludedPackages:e,instance:t,onExcludedPackagesChange:r,onLimitChange:s,packages:o,packagesCount:n,packagesLoading:g})=>{var h;const f=((h=e.find(({id:l})=>l===t.id))==null?void 0:h.exclude_packages)??[],b=d.useMemo(()=>{const l=new Set(o.map(({id:a})=>a));return f.length>0&&f.some(a=>!l.has(a))},[f.length,o]),m=d.useMemo(()=>M(o,b,g),[o,b,g]),w=()=>{const l=o.map(({id:a})=>a);r(e.map(({id:a,exclude_packages:i})=>a!==t.id?{id:a,exclude_packages:i}:{id:a,exclude_packages:i.length<l.length?l:[]}))},x=l=>{r(e.map(({id:a,exclude_packages:i})=>a!==t.id?{id:a,exclude_packages:i}:{id:a,exclude_packages:i.includes(l)?i.filter(k=>k!==l):[...i,l]}))},_=v(f,o),N=d.useMemo(()=>[{accessor:"checkbox",className:"checkbox-column",Header:u.jsx(P.CheckboxInput,{inline:!0,label:u.jsx("span",{className:"u-off-screen",children:"Toggle all packages"}),disabled:m.length===0,checked:_==="checked",indeterminate:_==="indeterminate",onChange:w}),Cell:({row:{index:l,original:a}})=>g&&l===m.length-1?u.jsx(S,{}):l===0&&b?u.jsx(A,{count:n-f.length,itemName:{plural:"packages",singular:"package"},onClick:()=>r(e.map(({id:i,exclude_packages:k})=>({id:i,exclude_packages:i!==t.id?k:[]}))),totalCount:n}):u.jsx(P.CheckboxInput,{inline:!0,label:u.jsxs("span",{className:"u-off-screen",children:["Toggle ",a.name," package"]}),checked:!f.includes(a.id),onChange:()=>x(a.id)})},{accessor:"name",Header:"Name"},{accessor:"current_version",Header:"Current version"},{accessor:"available_version",Header:"New version"},{accessor:"summary",Header:"Details"}],[m.length,g,f.length]);return g&&!o.length?u.jsx(S,{}):u.jsx(y,{columns:N,data:m,itemCount:o.length,itemNames:{plural:"packages",singular:"package"},onLimitChange:s,totalCount:n,title:u.jsxs("p",{className:"p-heading--4",children:["Packages affected on ",u.jsx("b",{children:t.title})]}),getCellProps:H({lastPackageIndex:m.length-1,loading:g,showToggle:b})})},L="_nameColumn_ku09w_1",$="_expanded_ku09w_5",O="_expandButton_ku09w_23",Q="_hidden_ku09w_32",q="_innerTable_ku09w_36",z="_row_ku09w_40",C={nameColumn:L,expanded:$,expandButton:O,hidden:Q,innerTable:q,row:z},F=e=>({column:t,row:{index:r}})=>{const s={};return e>-1&&e===r-1?t.id==="title"?(s.colSpan=2,e>-1&&e===r-1&&(s.className=C.innerTable)):(s.className=C.hidden,s["aria-hidden"]=!0):t.id==="title"?s.role="rowheader":t.id==="upgrades"&&(s["aria-label"]="Affected packages",s.className=e===r?C.expanded:C.row),s},X=({excludedPackages:e,instances:t,onExcludedPackagesChange:r})=>{var j;const[s,o]=d.useState(5),[n,g]=d.useState(-1),[f,b]=d.useState([]),[m,w]=d.useState(0),x=d.useRef(0),_=d.useRef(-1),{getInstancePackagesQuery:N}=D(),{data:h,isLoading:l}=N({instance_id:(j=t[n])==null?void 0:j.id,limit:5,offset:m,upgrade:!0},{enabled:n>-1});d.useEffect(()=>{h&&(x.current=h.data.count,m!==_.current?(_.current=m,b(c=>[...c,...h.data.results])):(_.current=m,b(c=>[...c.slice(0,-1*h.data.results.length),...h.data.results])))},[h]);const a=c=>{w(0),b([]),g(p=>p===c?-1:p>-1&&p<c?c-1:c)},i=d.useMemo(()=>n>-1?[...t.slice(0,n+1),...t.slice(n,s)]:t.slice(0,s),[t,s,n]),k=d.useMemo(()=>[{accessor:"title",className:C.nameColumn,Header:"Name",Cell:({row:{index:c,original:p}})=>n===-1||c!==n+1?p.title:u.jsx(R,{excludedPackages:e,instance:p,onExcludedPackagesChange:r,onLimitChange:()=>w(I=>I+5),packages:f,packagesCount:x.current,packagesLoading:l})},{accessor:"upgrades",Header:"Affected packages",Cell:({row:{index:c,original:p}})=>u.jsx(P.Button,{type:"button",className:T("p-accordion__tab",C.expandButton),"aria-expanded":n===c,onClick:()=>a(c),children:null})}],[e,n,l,f,i.length]);return u.jsx(y,{columns:k,data:i,getCellProps:F(n),itemNames:{plural:"instances",singular:"instance"},onLimitChange:()=>o(c=>c+5),totalCount:t.length})};export{X as default};
