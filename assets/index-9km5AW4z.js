import{r as c,j as e,f as v,d as _,y as b,e as N,h as w,t as I}from"./index-CQs3wXys.js";import{P as L,a as P,b as T}from"./PageMain-BTzMuvvj.js";import{h as j}from"./moment-Cl4UOzQZ.js";import{u as F}from"./useQuery-DrwXjJzc.js";import{T as H}from"./TablePagination-DIiSuGph.js";const M="_message_1hc9t_1",z={message:M},A="_container_1m3ln_1",D="_truncated_1m3ln_5",O="_hidden_1m3ln_12",R="_expandedString_1m3ln_17",$="_showScroll_1m3ln_21",Y="_item_1m3ln_25",k="_count_1m3ln_29",g={container:A,truncated:D,hidden:O,expandedString:R,showScroll:$,item:Y,count:k},f=120,B=({items:n})=>{const[s,t]=c.useState(0),[l,d]=c.useState(!1),[h,m]=c.useState(!1),a=n.length===1&&typeof n[0]=="string",r=c.useRef(null),o=()=>{if(!r.current)return;const i=r.current.querySelectorAll(`span.${g.item}`);t(Array.from(i).filter(({offsetHeight:p,offsetTop:x})=>x>p).length)};return c.useEffect(()=>{if(r.current)return window.addEventListener("resize",o),()=>{window.removeEventListener("resize",o)}},[r.current]),c.useEffect(()=>{l&&(r.current&&m(r.current.scrollHeight>r.current.clientHeight),window.removeEventListener("resize",o))},[l]),c.useEffect(()=>{o()},[n]),e.jsxs("div",{className:g.container,children:[e.jsx("div",{ref:r,className:v(g.truncated,{[g.hidden]:!l,[g.expandedString]:a&&l,[g.showScroll]:h}),children:a?e.jsxs(e.Fragment,{children:[n[0].slice(0,f),e.jsx("span",{className:v({[g.hidden]:!l}),children:n[0].slice(f)})]}):n.map((i,p)=>e.jsx("span",{className:g.item,children:i},p))}),(s>0||a&&n[0].length>f)&&!l&&e.jsx(_.Button,{type:"button",appearance:"base",onClick:()=>{d(!0)},className:v("u-no-margin--bottom u-no-padding",g.count),children:a?e.jsx("span",{className:"p-text--small u-text--muted",children:"show more"}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"u-text--muted",children:" +"}),e.jsx("span",{className:"u-text--muted",children:s})]})})]})},U=({eventsLog:n})=>{const s=c.useMemo(()=>[{accessor:"creation_time",Header:"creation time",Cell:({row:t})=>e.jsx(e.Fragment,{children:j(t.original.creation_time).format(b)})},{accessor:"person_name",Header:"username",Cell:({row:t})=>e.jsx(e.Fragment,{children:t.original.person_name})},{accessor:"entity_type",Header:"entity type",Cell:({row:t})=>e.jsx(e.Fragment,{children:t.original.entity_type})},{accessor:"entity_name",Header:"entity name",Cell:({row:t})=>e.jsx(e.Fragment,{children:t.original.entity_name})},{accessor:"message",className:z.message,Header:"event log message",Cell:({row:t})=>t.original.message.length<120?e.jsx(e.Fragment,{children:t.original.message}):e.jsx(B,{items:[t.original.message]})}],[n]);return e.jsx(_.ModularTable,{columns:s,data:n,sortable:!0,emptyMsg:"No events found"})},V="_container_r415z_1",q="_searchContainer_r415z_8",G="_select_r415z_12",y={container:V,searchContainer:q,select:G},K=[{label:"1 day",value:1},{label:"7 days",value:7},{label:"30 days",value:30},{label:"90 days",value:90},{label:"180 days",value:180},{label:"365 days",value:365}],Q=({setSearch:n,handleResetPage:s,dayFilter:t,handleDayChange:l})=>{const[d,h]=c.useState(""),m=()=>{n(d),s()},a=()=>{h(""),s()},r=o=>{o.preventDefault(),m()};return e.jsxs("div",{className:y.container,children:[e.jsx("div",{className:y.searchContainer,children:e.jsx(_.Form,{onSubmit:r,noValidate:!0,children:e.jsx(_.SearchBox,{value:d,onChange:o=>{h(o)},onSearch:m,onClear:a})})}),e.jsx(_.Select,{wrapperClassName:y.select,label:"Days",labelClassName:"u-no-margin--bottom",options:K,value:t,onChange:o=>l(Number(o.target.value))})]})};function Z(){const n=N();return{getEventsLog:(t,l={})=>F({queryKey:["events",t],queryFn:()=>n.get("events",{params:t}),...l})}}const J=(n,s)=>{const t=["creation_time","person_id","person_name","entity_type","entity_id","entity_name","message"],d=[["Creation Time","Person ID","Person Name","Entity Type","Entity ID","Entity Name","Message"].join(","),...n.map(r=>t.map(o=>r[o]).join(","))].join(`\r
`),h=new Blob([d],{type:"text/csv;charset=utf-8;"}),m=URL.createObjectURL(h),a=document.createElement("a");a.href=m,a.download=s,document.body.appendChild(a),a.click(),document.body.removeChild(a)},W=()=>{const[n,s]=c.useState(1),[t,l]=c.useState(20),[d,h]=c.useState(""),[m,a]=c.useState(7),{user:r}=w(),{getEventsLog:o}=Z(),{data:i,isLoading:p}=o({days:m,limit:t,offset:(n-1)*t,search:d}),x=c.useMemo(()=>(i==null?void 0:i.data.results.filter(u=>u.message.includes(d)))??[],[i,d]),S=u=>{s(u)},C=u=>{l(u),S(1)},E=u=>{a(u),s(1)};return e.jsxs(L,{children:[e.jsx(P,{title:"Events log",actions:[e.jsx(_.Button,{onClick:()=>J(x,`Event Log - ${r.current_account}-${j().format("YYYY-MM-DDTHH mm ss[Z]")}.csv`),children:"Download as CSV"},"download-as-cv")]}),e.jsxs(T,{children:[e.jsx(Q,{setSearch:u=>h(u),handleResetPage:()=>s(1),dayFilter:m,handleDayChange:E}),p?e.jsx(I,{}):e.jsx(U,{eventsLog:x}),e.jsx(H,{currentPage:n,totalItems:i==null?void 0:i.data.count,paginate:S,pageSize:t,setPageSize:C,currentItemCount:x.length})]})]})},ae=W;export{ae as default};
