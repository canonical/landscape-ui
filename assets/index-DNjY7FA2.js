const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-BOQfb8l4.js","assets/index-gc_gETRV.js","assets/index-Dkc_mJ0y.css","assets/useRoles-BwARvS0C.js","assets/SidePanelFormButtons-DXWxyXZ6.js","assets/SidePanelFormButtons.module-D2P5PizG.js","assets/SidePanelFormButtons-JM1G8Sq6.css","assets/PageMain-BI0GhwLg.js","assets/PageMain-DJy-4N2e.css"])))=>i.map(i=>d[i]);
import{r as p,j as o,d as v,B as k,C as L,m as P,F as B,K as $,R as y,O as R,am as V,aq as Q,y as H,q as j,n as z,ai as U,aA as C,ar as q,E as Y,a1 as I}from"./index-gc_gETRV.js";import{P as K,a as J,b as W}from"./PageMain-BI0GhwLg.js";import{u as w}from"./useRoles-BwARvS0C.js";import{S as X}from"./SidePanelFormButtons-DXWxyXZ6.js";const E=s=>s.reduce((e,{global:r,name:t,title:c})=>{if(t==="RemoveComputerFromAccessGroup")return e;const n=/view/i.test(t)?"view":"manage",i=t==="AddComputerToAccessGroup"?"access group":c.replace(/(view|manage) /i,"").replace(/computer/i,"instance"),l=e.find(({label:u})=>u===i)||{global:r,label:i,values:{manage:"",view:""}};return l.values[n]=t,[...e.filter(({label:u})=>u!==i),l]},[]),Z=s=>{const e={maxDepth:0,options:s.filter(r=>r.parent==="").map(({name:r,title:t})=>({children:[],depth:0,label:t,parents:[],value:r}))};for(;e.maxDepth>=0;){const r=e.options.filter(({depth:c})=>c===e.maxDepth);e.maxDepth++;const t=s.filter(({parent:c})=>r.some(({value:n})=>n===c));if(t.length===0)break;for(const{name:c,parent:n,title:i}of t){const l=r.find(({value:a})=>a===n);if(!l)continue;const u=[n,...l.parents];e.options.push({children:[],depth:e.maxDepth,label:i,parents:u,value:c});for(const a of u)e.options.filter(({value:d})=>d===a)[0].children.push(c)}}return e.options},T=(s,e,r)=>r.filter(t=>t.depth===e).filter(({value:t})=>s.includes(t))[0].value,ee=s=>s.sort((e,r)=>{if(e.children.includes(r.value))return-1;if(r.children.includes(e.value))return 1;for(let t=0;t<Math.min(e.depth,r.depth);t++){const c=T(e.parents,t,s),n=T(r.parents,t,s);if(c!==n)return c.localeCompare(n)}return e.value.localeCompare(r.value)}),se=(s,e)=>{const r=Math.max(...e.map(({depth:c})=>c)),t=s;if(s.length>0)for(let c=0;c<r;c++){const n=e.filter(({depth:i})=>i===c).filter(({value:i})=>s.includes(i));for(const i of n)if(i.children.every(l=>s.includes(l))){const l=s.filter(u=>!i.children.includes(u));s.splice(0,s.length,...l)}}return t},ne="_container_1rjk0_1",te="_checkboxColumn_1rjk0_7",A={container:ne,checkboxColumn:te},S=({description:s,onPermissionChange:e,options:r,permissions:t,title:c})=>{const n=p.useMemo(()=>r.sort((a,d)=>a.values.view===""&&d.values.view!==""?-1:a.values.view!==""&&d.values.view===""?1:a.label.localeCompare(d.label)),[r]),i=a=>{var d;return a.values.view===""||t.includes((d=r.filter(({label:m})=>m===a.label)[0])==null?void 0:d.values.manage)},l=(a,d)=>{t.includes(a.values[d])?e(t.filter(m=>m!==a.values[d])):e(d==="view"?[...t,a.values.view]:a.values.view!==""&&!t.includes(a.values.view)?[...t,a.values.manage,a.values.view]:[...t,a.values.manage])},u=p.useMemo(()=>[{accessor:"label",Header:"Property",Cell:({row:a})=>a.original.label.replace(/^\w/,d=>d.toUpperCase())},{accessor:"view",className:A.checkboxColumn,Header:"View",Cell:({row:a})=>o.jsx(v.CheckboxInput,{inline:!0,label:o.jsx("span",{className:"u-off-screen",children:`View ${a.original.label}`}),name:"permissions",value:a.original.values.view,disabled:i(a.original),checked:a.original.values.view===""||t.includes(a.original.values.view),onChange:()=>{l(a.original,"view")}})},{accessor:"manage",className:A.checkboxColumn,Header:"Manage",Cell:({row:a})=>o.jsx(v.CheckboxInput,{inline:!0,label:o.jsx("span",{className:"u-off-screen",children:`Manage ${a.original.label}`}),name:"permissions",value:a.original.values.manage,disabled:a.original.values.manage==="",checked:t.includes(a.original.values.manage),onChange:()=>{l(a.original,"manage")}})}],[n,t.length]);return o.jsxs("div",{className:A.container,children:[o.jsx("p",{className:"p-heading--5 u-no-margin--bottom",children:c}),o.jsx("p",{className:"p-text--small u-text--muted",children:s}),o.jsx(v.ModularTable,{columns:u,data:n,getHeaderProps:()=>({className:"u-text--muted"})})]})},ae={"depth-1":"_depth-1_1twyj_1","depth-2":"_depth-2_1twyj_5","depth-3":"_depth-3_1twyj_9","depth-4":"_depth-4_1twyj_13","depth-5":"_depth-5_1twyj_17","depth-6":"_depth-6_1twyj_21","depth-7":"_depth-7_1twyj_25","depth-8":"_depth-8_1twyj_29","depth-9":"_depth-9_1twyj_33","depth-10":"_depth-10_1twyj_37"},oe=({accessGroupOptions:s,accessGroups:e,onAccessGroupChange:r})=>{const t=(n,i)=>{if(e.includes(n.value)||e.some(l=>n.children.includes(l)))r(e.filter(l=>![n.value,...n.children,...n.parents].includes(l)));else{const l=[...e,n.value,...n.children];for(let u=n.depth-1;u>=0;u--){const a=i.filter(({depth:d})=>d===u).find(({value:d})=>n.parents.includes(d));if(a&&a.children.every(d=>l.includes(d)))l.push(a.value);else break}r(l)}},c=n=>n.some(i=>e.includes(i))&&n.some(i=>!e.includes(i));return o.jsxs(o.Fragment,{children:[o.jsx("p",{className:"p-heading--5 u-no-margin--bottom",children:"Access Groups"}),s.map((n,i,l)=>o.jsx(v.CheckboxInput,{label:n.label,labelClassName:ae[`depth-${n.depth}`],name:"access_groups",checked:e.includes(n.value),indeterminate:c(n.children),onChange:()=>t(n,l)},n.value))]})},re=(s,e,r,t)=>{const c=s.permissions.filter(m=>t.find(({global:b,values:g})=>b&&(g.manage===m||g.view===m))),n=s.permissions.filter(m=>!c.includes(m)),i=n.filter(m=>!e.permissions.includes(m));i.includes("AddComputerToAccessGroup")&&i.push("RemoveComputerFromAccessGroup"),c.length>0&&i.push(...c);const l=e.permissions.filter(m=>!n.includes(m));l.includes("AddComputerToAccessGroup")&&l.push("RemoveComputerFromAccessGroup");const u=se(s.accessGroups,r),a=u.filter(m=>!e.access_groups.includes(m)),d=e.access_groups.filter(m=>!u.includes(m));return{accessGroupsToAdd:a,accessGroupsToRemove:d,permissionsToAdd:i,permissionsToRemove:l}},ie=(s,e,r,t,c)=>{const{addAccessGroups:n,addPermissions:i,removeAccessGroups:l,removePermissions:u}=c,a={},{accessGroupsToAdd:d,accessGroupsToRemove:m,permissionsToAdd:b,permissionsToRemove:g}=re(s,e,r,t);return d.length>0&&(a.addAccessGroupsPromise=n({name:e.name,access_groups:d})),m.length>0&&(a.removeAccessGroupsPromise=l({name:e.name,access_groups:m})),g.length>0&&(a.removePermissionsPromise=u({name:e.name,permissions:g})),b.length>0&&(a.addPermissionsPromise=i({name:e.name,permissions:b})),a},le=(s,e,r)=>{const t=[...s.access_groups,...s.access_groups.flatMap(i=>{var l;return((l=e.find(({value:u})=>u===i))==null?void 0:l.children)||[]})],c=s.global_permissions?[...s.permissions,...s.global_permissions]:s.permissions,n=[...new Set([...c,...r.filter(({values:i})=>c.includes(i.manage)).map(({values:i})=>i.view)])];return{accessGroups:t,permissions:n}},ce={accessGroups:[],permissions:[]},de=$().shape({accessGroups:y().of(R()),permissions:y().of(R())}),ue=({role:s})=>{const e=k(),{notify:r}=L(),{closeSidePanel:t}=P(),{addPermissionsToRoleQuery:c,addAccessGroupsToRoleQuery:n,getAccessGroupQuery:i,getPermissionsQuery:l,removeAccessGroupsFromRoleQuery:u,removePermissionsFromRoleQuery:a}=w(),{data:d}=l(),m=d?E(d.data):[],{data:b}=i(),g=b?ee(Z(b.data)):[],{mutateAsync:F}=c,{mutateAsync:N}=n,{mutateAsync:O}=u,{mutateAsync:D}=a,f=B({initialValues:ce,validationSchema:de,onSubmit:async h=>{const x=ie(h,s,g,m,{addAccessGroups:N,addPermissions:F,removeAccessGroups:O,removePermissions:D});if(!Object.values(x).some(Boolean))return t();try{x.addPermissionsPromise&&x.removePermissionsPromise?(await Promise.all(Object.entries(x).filter(([_,M])=>_!=="addPermissionsPromise"&&M).map(([,_])=>_)),await x.addPermissionsPromise):await Promise.all(Object.values(x).filter(Boolean)),t(),r.success({title:"Role changes have been saved",message:`You modified the role '${s.name}'`})}catch(_){e(_)}}});return p.useEffect(()=>{f.setValues(le(s,g,m))},[s,g.length]),o.jsxs(v.Form,{onSubmit:f.handleSubmit,noValidate:!0,children:[o.jsx(S,{description:"These permissions are for managing the account as a whole. They are not limited to the specified access groups, but instead apply globally.",onPermissionChange:h=>f.setFieldValue("permissions",h),options:m.filter(({global:h})=>h),permissions:f.values.permissions,title:"Global permissions"}),o.jsx(S,{description:"These permissions only apply to selected access groups.",onPermissionChange:h=>f.setFieldValue("permissions",h),options:m.filter(({global:h})=>!h),permissions:f.values.permissions,title:"Permissions"}),o.jsx(oe,{accessGroupOptions:g,accessGroups:f.values.accessGroups,onAccessGroupChange:h=>{f.setFieldValue("accessGroups",h)}}),o.jsx(X,{submitButtonDisabled:f.isSubmitting,submitButtonText:"Save changes"})]})},me=({role:s})=>{const e=k(),{setSidePanelContent:r}=P(),{removeRoleQuery:t}=w(),{value:c,setTrue:n,setFalse:i}=V(),{mutateAsync:l,isPending:u}=t,a=async()=>{try{await l({name:s.name})}catch(m){e(m)}finally{i()}},d=()=>{r(`Edit "${s.name}" role`,o.jsx(p.Suspense,{fallback:o.jsx(j,{}),children:o.jsx(ue,{role:s})}))};return o.jsxs(o.Fragment,{children:[o.jsx(Q,{toggleAriaLabel:`${s.name} role actions`,actions:[{icon:"edit",label:"Edit","aria-label":`Edit "${s.group}" role`,onClick:d}],destructiveActions:[{icon:"delete",label:"Remove","aria-label":`Remove "${s.group}" role`,onClick:n}]}),c&&o.jsx(v.ConfirmationModal,{close:i,title:`Remove '${s.name}' role`,confirmButtonLabel:"Remove",confirmButtonAppearance:"negative",confirmButtonDisabled:u,confirmButtonLoading:u,onConfirm:a,children:o.jsxs("p",{children:[o.jsx("span",{children:`This will remove '${s.name}' role.`}),s.persons.length>0&&o.jsxs(o.Fragment,{children:[o.jsx("br",{}),o.jsx("strong",{children:`This will affect ${s.persons.length} ${H(s.persons.length,"administrator")}.`})]})]})})]})},G=(s,e,r)=>{const t=s.global_permissions?[...s.permissions,...s.global_permissions]:s.permissions,c=[...new Set(t.filter(n=>r==="manage"?!/(view|remove)/i.test(n):!/(remove)/i.test(n)&&!e.find(({values:i})=>i.manage===n&&!i.view)).map(n=>{var i;return((i=e.find(({values:l})=>r==="manage"?l.manage===n:l.view===n||l.manage===n))==null?void 0:i.label)??""}))];return c.length===0?"":c.length!==e.filter(({values:n})=>!!n[r]).length?c.map((n,i)=>i>0?n:n.replace(/^\w/,l=>l.toUpperCase())).join(", "):"All properties"},pe=s=>({column:e,row:{index:r}})=>{const t={};return(s==null?void 0:s.rowIndex)===r&&s.columnId===e.id&&(t.className="expandedCell"),e.id==="name"?t.role="rowheader":e.id==="persons"?t["aria-label"]="Administrators":e.id==="view"?t["aria-label"]="View permissions":e.id==="manage"?t["aria-label"]="Manage permissions":e.id==="actions"&&(t["aria-label"]="Actions"),t},he=s=>({index:e})=>{const r={};return s===e&&(r.className="expandedRow"),r},ge=s=>e=>{e&&(s.current=[...e.querySelectorAll("tbody tr")])},fe="_administrators_18216_1",ve={administrators:fe},be=({roleList:s})=>{const[e,r]=p.useState(null),t=p.useRef([]);z({current:e?t.current[e.rowIndex]:null},()=>{r(null)});const{getPermissionsQuery:c}=w(),{data:n}=c(),i=n?E(n.data):[],l=p.useMemo(()=>s,[s]),u=p.useMemo(()=>[{accessor:"name",Header:"Name"},{accessor:"persons",Header:"Administrators",className:ve.administrators,Cell:({row:a})=>a.original.persons.length},{accessor:"view",Header:"View",Cell:({row:{original:a,index:d}})=>o.jsx(C,{content:G(a,i,"view"),isExpanded:(e==null?void 0:e.rowIndex)===d&&e.columnId==="view",onExpand:()=>{r({rowIndex:d,columnId:"view"})}})},{accessor:"manage",Header:"Manage",Cell:({row:{original:a,index:d}})=>o.jsx(C,{content:G(a,i,"manage"),isExpanded:(e==null?void 0:e.rowIndex)===d&&e.columnId==="manage",onExpand:()=>{r({rowIndex:d,columnId:"manage"})}})},{...U,Cell:({row:a})=>a.original.name=="GlobalAdmin"?null:o.jsx(me,{role:a.original})}],[l,n,e]);return o.jsx("div",{ref:ge(t),children:o.jsx(q,{columns:u,data:l,getCellProps:pe(e),getRowProps:he(e==null?void 0:e.rowIndex)})})},xe=p.lazy(()=>I(()=>import("./index-BOQfb8l4.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8]))),_e=()=>{const{setSidePanelContent:s}=P(),{getRolesQuery:e}=w(),{data:r,isLoading:t}=e();return o.jsxs(o.Fragment,{children:[t&&o.jsx(j,{}),!t&&(!r||!r.data.length)&&o.jsx(Y,{title:"No roles found",body:o.jsxs(o.Fragment,{children:[o.jsx("p",{className:"u-no-margin--bottom",children:"You havenâ€™t added any roles yet."}),o.jsx("a",{href:"https://ubuntu.com/landscape/docs/administrators",target:"_blank",rel:"nofollow noopener noreferrer",children:"How to manage administrators in Landscape"})]}),cta:[o.jsx(v.Button,{type:"button",appearance:"positive",onClick:()=>{s("Add role",o.jsx(p.Suspense,{fallback:o.jsx(j,{}),children:o.jsx(xe,{})}))},children:"Add role"},"add")]}),!t&&r&&r.data.length>0&&o.jsx(be,{roleList:r.data})]})},je=p.lazy(()=>I(()=>import("./index-BOQfb8l4.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8]))),Pe=()=>{const{setSidePanelContent:s}=P(),e=()=>{s("Add Role",o.jsx(p.Suspense,{fallback:o.jsx(j,{}),children:o.jsx(je,{})}))};return o.jsxs(K,{children:[o.jsx(J,{title:"Roles",actions:[o.jsx(v.Button,{type:"button",onClick:e,appearance:"positive",children:"Add role"},"add-role")]}),o.jsx(W,{children:o.jsx(_e,{})})]})},Te=Object.freeze(Object.defineProperty({__proto__:null,default:Pe},Symbol.toStringTag,{value:"Module"}));export{oe as A,S as P,E as a,ee as b,Z as c,se as g,Te as i};
