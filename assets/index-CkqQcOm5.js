import{r as m,j as i,e as j,d as P,I}from"./index-DYykpNVa.js";import{S as A,E as S}from"./SelectAllButton-BIeygsoJ.js";import{a as B}from"./useUsns-Ky-uaXGZ.js";import"./ExpandableTableFooter-BN-Raj69.js";import"./constants-CXofZZ4i.js";import"./ResponsiveTable-C-8YbfBJ.js";import"./InstancesPageActions-nbDXpXLr.js";import"./index-C2TKYmcI.js";import"./NoData-CT6SeJUX.js";import"./TablePagination-CIA4CRba.js";import"./TableFilterChips-DLH4XQ-H.js";import"./useFetchOld-BGD2hIpr.js";import"./PageParamFilter-LH49uHXA.js";import"./TableFilter-C7yTBfOe.js";import"./formikErrors-Bw8iTXYS.js";import"./ListTitle-anvzyHx6.js";import"./StaticLink-BX9qJBBO.js";import"./TruncatedCell-DQQZxgbr.js";import"./Truncated-DtD6hAHP.js";import"./useExpandableRow-CGDZ27WS.js";import"./index-Cbj0Sz5k.js";import"./TextConfirmationModal-DuGXYB1S.js";import"./InfoGrid-CVtcW3Y8.js";import"./InfoItem-DMBAN7ig.js";const E="_hidden_vofak_1",H={hidden:E},M=({lastPackageIndex:e,loading:t,showToggle:o})=>({column:r,row:{index:l}})=>{const n={};return(o&&l===0||t&&l===e)&&(r.id==="checkbox"?n.colSpan=5:(n.className=H.hidden,n["aria-hidden"]=!0)),n},v=(e,t,o)=>[...e.slice(t?-1:e.length),...e,...e.slice(o?-1:e.length)],D=(e,t)=>{const o=new Set(e),r=t.filter(({id:l})=>!o.has(l)).length;return r===0?"unchecked":r===t.length?"checked":"indeterminate"},R=({excludedPackages:e,instance:t,onExcludedPackagesChange:o,onLimitChange:r,packages:l,packagesCount:n,packagesLoading:p})=>{const d=e.find(({id:s})=>s===t.id)?.exclude_packages??[],g=m.useMemo(()=>{const s=new Set(l.map(({id:a})=>a));return d.length>0&&d.some(a=>!s.has(a))},[d.length,l]),h=m.useMemo(()=>v(l,g,p),[l,g,p]),x=()=>{const s=l.map(({id:a})=>a);o(e.map(({id:a,exclude_packages:u})=>a!==t.id?{id:a,exclude_packages:u}:{id:a,exclude_packages:u.length<s.length?s:[]}))},k=s=>{o(e.map(({id:a,exclude_packages:u})=>a!==t.id?{id:a,exclude_packages:u}:{id:a,exclude_packages:u.includes(s)?u.filter(C=>C!==s):[...u,s]}))},b=D(d,l),N=m.useMemo(()=>[{accessor:"checkbox",className:"checkbox-column",Header:i.jsx(P.CheckboxInput,{inline:!0,label:i.jsx("span",{className:"u-off-screen",children:"Toggle all packages"}),disabled:h.length===0,checked:b==="checked",indeterminate:b==="indeterminate",onChange:x}),Cell:({row:{index:s,original:a}})=>p&&s===h.length-1?i.jsx(j,{}):s===0&&g?i.jsx(A,{count:n-d.length,itemName:{plural:"packages",singular:"package"},onClick:()=>{o(e.map(({id:u,exclude_packages:C})=>({id:u,exclude_packages:u!==t.id?C:[]})))},totalCount:n}):i.jsx(P.CheckboxInput,{inline:!0,label:i.jsxs("span",{className:"u-off-screen",children:["Toggle ",a.name," package"]}),checked:!d.includes(a.id),onChange:()=>{k(a.id)}})},{accessor:"name",Header:"Name"},{accessor:"current_version",Header:"Current version"},{accessor:"available_version",Header:"New version"},{accessor:"summary",Header:"Details"}],[h.length,p,d.length]);return p&&!l.length?i.jsx(j,{}):i.jsx(S,{columns:N,data:h,itemCount:l.length,itemNames:{plural:"packages",singular:"package"},onLimitChange:r,totalCount:n,title:i.jsxs("p",{className:"p-heading--4",children:["Packages affected on ",i.jsx("b",{children:t.title})]}),getCellProps:M({lastPackageIndex:h.length-1,loading:p,showToggle:g})})},y="_nameColumn_sab67_7",L="_expanded_sab67_11",$="_expandButton_sab67_29",O="_hidden_sab67_38",Q="_innerTable_sab67_42",q="_row_sab67_49",_={nameColumn:y,expanded:L,expandButton:$,hidden:O,innerTable:Q,row:q},z=e=>({column:t,row:{index:o}})=>{const r={};return e>-1&&e===o-1?t.id==="title"?(r.colSpan=2,e>-1&&e===o-1&&(r.className=_.innerTable)):(r.className=_.hidden,r["aria-hidden"]=!0):t.id==="title"?r.role="rowheader":t.id==="upgrades"&&(r["aria-label"]="Affected packages",r.className=e===o?_.expanded:_.row),r},pe=({excludedPackages:e,instances:t,onExcludedPackagesChange:o})=>{const[r,l]=m.useState(5),[n,p]=m.useState(-1),[d,g]=m.useState([]),[h,x]=m.useState(0),k=m.useRef(0),b=m.useRef(-1),{getInstancePackagesQuery:N}=B(),{data:s,isLoading:a}=N({instance_id:t[n]?.id,limit:5,offset:h,upgrade:!0},{enabled:n>-1});m.useEffect(()=>{s&&(k.current=s.data.count,h!==b.current?(b.current=h,g(c=>[...c,...s.data.results])):(b.current=h,g(c=>[...c.slice(0,-1*s.data.results.length),...s.data.results])))},[s]);const u=c=>{x(0),g([]),p(f=>f===c?-1:f>-1&&f<c?c-1:c)},C=m.useMemo(()=>n>-1?[...t.slice(0,n+1),...t.slice(n,r)]:t.slice(0,r),[t,r,n]),w=m.useMemo(()=>[{accessor:"title",className:_.nameColumn,Header:"Name",Cell:({row:{index:c,original:f}})=>n===-1||c!==n+1?f.title:i.jsx(R,{excludedPackages:e,instance:f,onExcludedPackagesChange:o,onLimitChange:()=>{x(T=>T+5)},packages:d,packagesCount:k.current,packagesLoading:a})},{accessor:"upgrades",Header:"Affected packages",Cell:({row:{index:c,original:f}})=>i.jsx(P.Button,{type:"button",className:I("p-accordion__tab",_.expandButton),"aria-expanded":n===c,onClick:()=>{u(c)},children:null})}],[e,n,a,d,C.length]);return i.jsx(S,{columns:w,data:C,getCellProps:z(n),itemNames:{plural:"instances",singular:"instance"},onLimitChange:()=>{l(c=>c+5)},totalCount:t.length})};export{pe as default};
