import{j as e,r as h,m as n,y as L,af as K,n as f,o as P,l as Q,J as Y,B as R,F as y,G as W,v,$ as O}from"./index-uBNuGD_s.js";import{A as X}from"./AssociationBlock-CN2USJHv.js";import{t as B,u as Z}from"./index-bPPWbYHN.js";import{S as ee}from"./SidePanelFormButtons-CqnuUz9i.js";import{u as te}from"./useInstances-D8I8Bnnt.js";import{g as _}from"./formikErrors-Bw8iTXYS.js";import{b as re,u as se}from"./ScriptsTabs-BL_Ec28r.js";import"./index-DvBUHKUn.js";import{D as ne}from"./downshift.esm-XXFvb1iA.js";import"./MultiSelectField-DOFnZ5Iz.js";import"./HeaderWithSearch-CQzaJkQW.js";import"./SidePanelFormButtons.module-D2P5PizG.js";import"./TruncatedCell-COALXWFW.js";import"./SingleInstanceTabs.module-Cm1BYFZQ.js";const C=({label:s,value:i})=>e.jsxs("div",{children:[e.jsx("div",{className:"p-heading--1 u-no-padding--top u-no-margin--bottom",children:i}),e.jsx("div",{className:"p-text--x-small u-text--muted",children:s})]}),ie="_example_16wh9_1",ae="_table_16wh9_6",A={example:ie,table:ae},oe=()=>{const[s,i]=h.useState(!1),a=()=>{i(!0)},d=()=>{i(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(n.Button,{type:"button",appearance:"base",className:"u-no-margin--bottom",hasIcon:!0,onClick:a,children:e.jsx(n.Icon,{name:n.ICONS.help})}),s&&e.jsxs(n.Modal,{title:"Cron job format",close:d,children:[e.jsxs("section",{children:[e.jsx("h1",{className:"p-text--small-caps",children:"Example"}),e.jsxs("div",{className:A.example,children:[e.jsx(C,{label:"Minute",value:"1"}),e.jsx(C,{label:"Hour",value:"*"}),e.jsx(C,{label:e.jsxs(e.Fragment,{children:["Day",e.jsx("br",{}),"(month)"]}),value:"2"}),e.jsx(C,{label:"Month",value:"1-3"}),e.jsx(C,{label:e.jsxs(e.Fragment,{children:["Day",e.jsx("br",{}),"(week)"]}),value:"*"})]}),e.jsx("p",{children:'"At minute 1 on day-of-month 2 in every month from January through March"'})]}),e.jsxs("section",{children:[e.jsx("h1",{className:"p-text--small-caps",children:"Accepted values"}),e.jsx(n.MainTable,{className:A.table,rows:[{columns:[{content:"* (asterisk)"},{content:"Any value"}]},{columns:[{content:", (comma)"},{content:"List separator"}]},{columns:[{content:"- (dash)"},{content:"Range"}]},{columns:[{content:"/ (slash)"},{content:"Step values"}]}]}),e.jsx(n.MainTable,{className:A.table,rows:[{columns:[{content:"Minute"},{content:"0-59"}]},{columns:[{content:"Hour"},{content:"0-23"}]},{columns:[{content:"Day of the month"},{content:"1-31"}]},{columns:[{content:"Month"},{content:"1-12 or JAN-DEC"}]},{columns:[{content:"Day of the week"},{content:"0-6 or SUN-SAT"}]}]})]})]})]})},le=({touched:s,value:i,...a})=>{const d=h.useId();let o="",p="";try{const u=B(i.toString());o=`"${u.charAt(0).toUpperCase()}${u.slice(1)}"`}catch(u){if(!(u instanceof Error))return;p=u.message}return e.jsxs(e.Fragment,{children:[e.jsx("label",{htmlFor:d,children:"* Schedule"}),e.jsx(oe,{}),e.jsx(n.Input,{id:d,type:"text",...a,help:o,value:i,error:s&&p,required:!0})]})},ce="_description_19733_1",de="_indent_19733_6",ue="_notification_19733_11",T={description:ce,indent:de,notification:ue},me="_container_z9mfx_1",pe="_suggestionsContainer_z9mfx_6",he="_pointer_z9mfx_13",ge="_highlighted_z9mfx_18",xe="_selectedContainer_z9mfx_22",_e="_marginTop_z9mfx_29",S={container:me,suggestionsContainer:pe,pointer:he,highlighted:ge,selectedContainer:xe,marginTop:_e},fe=200,je=(s,i)=>{const a=s.toLowerCase(),d=i.toLowerCase(),o=a.indexOf(d);return o>=0?e.jsxs(e.Fragment,{children:[s.substring(0,o),e.jsx("strong",{children:s.substring(o,o+i.length)}),s.substring(o+i.length)]}):s},be=({script:s,setScript:i,existingScriptId:a,errorMessage:d})=>{const[o,p]=h.useState(""),[u,j]=h.useState(!1),[m,w]=h.useState(""),{script:g,isScriptLoading:r}=re(a||0,{enabled:!!a});h.useEffect(()=>{a&&(s==null?void 0:s.id)!==(g==null?void 0:g.id)&&i(g)},[g]);const N=L(),{scripts:q,isScriptsLoading:b}=se({listenToUrlParams:!1},{search:o,script_type:"active",limit:20,offset:0},{enabled:o.length>2}),F=c=>(s==null?void 0:s.id)!==c.id,t=q.filter(F),l=()=>{i(null)},x=()=>{j(!1)},E=()=>{w(""),p("")},k=()=>{m.length>2?j(!0):j(!1)},$=c=>{w(c),c.length>2&&p(c)},z=K(()=>{try{k()}catch(c){N(c)}},fe),U=c=>{c&&(i(c),j(!1),E())},V=c=>{c.key==="Escape"?c.currentTarget.blur():z()},I=!u&&m.length<3?"Min 3. characters":q.length===0&&o&&!b?`No scripts found by "${o}"`:a?"Scripts can't be replaced after the profile has been created.":null;return e.jsxs("div",{className:f(S.container,"p-form__group p-form-validation"),children:[e.jsx("label",{className:"is-required p-form__label",htmlFor:a?"script-selected":"script-search",children:"Script"}),!a&&e.jsx(ne,{onSelect:U,itemToString:()=>"",isOpen:u,children:({getInputProps:c,getItemProps:G,getMenuProps:H,highlightedIndex:J})=>e.jsxs("div",{className:"p-autocomplete",children:[e.jsx(n.SearchBox,{...c(),id:a?void 0:"script-search",placeholder:"Search for scripts",required:!0,className:"u-no-margin--bottom",shouldRefocusAfterReset:!0,externallyControlled:!0,autocomplete:"off",value:m,onChange:$,onClear:E,onBlur:x,onFocus:k,onKeyUp:V}),I?e.jsx("span",{className:"p-form-help-text",children:I}):null,d&&!u?e.jsx("div",{className:"is-error",children:e.jsx("span",{className:"p-form-validation__message",id:"script-error",children:e.jsx("span",{children:d})})}):null,u&&(t.length>0||b)?e.jsx("ul",{className:f("p-list p-card--highlighted u-no-padding u-no-margin--bottom p-autocomplete__suggestions",S.suggestionsContainer),...H(),children:b?e.jsx(P,{}):t.map((D,M)=>e.jsx("li",{className:f("p-list__item",S.pointer,{[S.highlighted]:J===M}),...G({item:D,index:M}),children:e.jsx("div",{className:"u-truncate","data-testid":"dropdownElement",children:je(D.title,o)})},D.id))}):null]})}),r?e.jsx(P,{}):null,s&&e.jsxs("div",{id:"script-selected",className:f("p-autocomplete__result p-list__item p-card u-no-margin--bottom",S.selectedContainer,{[S.marginTop]:!a}),children:[e.jsx("div",{children:e.jsx("div",{children:s.title})}),a?null:e.jsx(n.Button,{type:"button",appearance:"link",className:"u-no-margin--bottom",onClick:l,children:e.jsx(n.Icon,{name:n.ICONS.delete})})]},s.id)]})},Me=({onSubmit:s,onSuccess:i,initialValues:a,disabledFields:d={},submitButtonText:o,submitting:p=!1})=>{const u=L(),{closeSidePanel:j}=Q(),{scriptProfileLimits:m,isGettingScriptProfileLimits:w}=Z(),{getInstancesQuery:g}=te(),r=Y({initialValues:a,validationSchema:R().shape({interval:y().when("trigger_type",([t],l)=>t=="recurring"?l.required("This field is required").test({test:x=>{try{return B(x),!0}catch{return!1}}}):l),script:R().when("script_id",([t],l)=>t==null?l.required("This field is required"):l),start_after:y().when("trigger_type",([t],l)=>t=="recurring"?l.required("This field is required").test({test:x=>v(x).utc(!0).isSameOrAfter(v()),message:"The start date must not be in the past."}):l),time_limit:W().required("This field is required"),timestamp:y().when("trigger_type",([t],l)=>t=="one_time"?l.required("This field is required").test({test:x=>v(x).utc(!0).isSameOrAfter(v()),message:"The date must not be in the past."}):l),title:y().required("This field is required"),trigger_type:y().required("This field is required"),username:y().required("This field is required")}),onSubmit:async t=>{if(console.log("values",t),!(!t.trigger_type||t.script_id==null)){try{switch(t.trigger_type){case"event":{await s({...t,script_id:t.script_id,trigger:{trigger_type:"event",event_type:"post_enrollment"}});break}case"one_time":{if(!t.timestamp)return;await s({...t,script_id:t.script_id,trigger:{trigger_type:"one_time",timestamp:t.timestamp,last_run:"",next_run:""}});break}case"recurring":{if(!t.interval||!t.start_after)return;await s({...t,script_id:t.script_id,trigger:{trigger_type:"recurring",interval:t.interval,start_after:t.start_after,last_run:"",next_run:""}});break}}}catch(l){u(l);return}j(),i(t)}}}),{data:N,isLoading:q}=g({query:r.values.all_computers?void 0:r.values.tags.map(t=>`tag:${t}`).join(" OR ")}),[b,F]=h.useState(!1);if(h.useEffect(()=>{if(!(!N||!m)){if(!r.values.tags.length&&!r.values.all_computers){F(!1);return}F(N.data.count>=m.max_num_computers)}},[N]),w)return e.jsx(P,{});if(m)return e.jsxs(e.Fragment,{children:[e.jsx(n.Input,{type:"text",label:"Name",required:!0,...r.getFieldProps("title"),error:_(r,"title")}),e.jsx(be,{script:r.values.script,existingScriptId:r.values.script_id,setScript:async t=>{await r.setFieldValue("script",t),await r.setFieldValue("script_id",t==null?void 0:t.id)},errorMessage:_(r,"script")}),e.jsxs(n.Row,{className:"u-no-padding",children:[e.jsx(n.Col,{size:6,children:e.jsx(n.Input,{type:"text",label:"Run as user",required:!0,...r.getFieldProps("username"),error:_(r,"username")})}),e.jsx(n.Col,{size:6,children:e.jsx(n.Input,{type:"number",label:"Time limit (seconds)",required:!0,...r.getFieldProps("time_limit"),error:_(r,"time_limit")})})]}),e.jsx(n.CustomSelect,{label:"Trigger",required:!0,onChange:async t=>{await r.setFieldValue("trigger_type",t)},value:r.values.trigger_type,disabled:d.trigger_type,error:_(r,"trigger_type"),options:[{label:e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"u-no-padding--top u-no-margin--bottom",children:"Post enrollment"}),e.jsx("p",{className:f(T.description,"u-no-margin--bottom"),children:e.jsx("small",{children:"Run the script after a new instance is enrolled"})})]}),value:"event",text:"Post enrollment"},{label:e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"u-no-padding--top u-no-margin--bottom",children:"On a date"}),e.jsx("p",{className:f(T.description,"u-no-margin--bottom"),children:e.jsx("small",{children:"Run the script on a selected date"})})]}),value:"one_time",text:"On a date"},{label:e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"u-no-padding--top u-no-margin--bottom",children:"Recurring"}),e.jsx("p",{className:f(T.description,"u-no-margin--bottom"),children:e.jsx("small",{children:"Run the script on a recurring schedule"})})]}),value:"recurring",text:"Recurring"}],help:d.trigger_type&&"Trigger type can't be changed after the script is created."}),e.jsxs("div",{className:T.indent,children:[r.values.trigger_type=="one_time"&&e.jsx(n.Input,{type:"datetime-local",label:"Date",required:!0,min:v().utc(!0).format(O),...r.getFieldProps("timestamp"),error:_(r,"timestamp")}),r.values.trigger_type=="recurring"&&e.jsxs(e.Fragment,{children:[e.jsx(n.Input,{type:"datetime-local",label:"Start date",required:!0,min:v().utc(!0).format(O),...r.getFieldProps("start_after"),error:_(r,"start_after")}),e.jsxs(n.Notification,{severity:"caution",className:T.notification,children:["There is a minimum interval of"," ",e.jsxs("strong",{children:[m==null?void 0:m.min_interval," minutes"]})," ","between runs. Depending on the schedule, run times may be adjusted."]}),e.jsx(le,{required:!0,touched:r.touched.interval,...r.getFieldProps("interval")})]})]}),b&&e.jsxs(n.Notification,{severity:"negative",inline:!0,title:"Associated instances limit reached:",children:["You've reached the limit of"," ",e.jsxs("strong",{children:[m.max_num_computers," associated instances"]}),". Decrease the number of associated instances."]}),e.jsx(X,{formik:r}),e.jsx(ee,{onSubmit:()=>{r.handleSubmit()},submitButtonDisabled:!r.isValid||p||b||q,submitButtonLoading:p||r.isSubmitting,submitButtonText:o})]})};export{Me as default};
