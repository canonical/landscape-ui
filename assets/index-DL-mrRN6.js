import{j as e,r as b,A as P,am as H,n as c,o as j,p as K,w as $,D as B,J as V,M as I,B as Y,k as z,C as J,F as L,x as O}from"./index-B1w7_YBY.js";import{C as Q}from"./CodeEditor-DNjyY52_.js";import{S as W}from"./SidePanelFormButtons-C2zp_f8i.js";import{u as X}from"./useAddAutoinstallFile-DwUvpelf.js";import{b as U}from"./EmployeeGroupIdentityIssuerList-CAg3281E.js";import{u as Z}from"./useUpdateEmployeeGroups-Fu4kA8hG.js";import{D as G}from"./downshift.esm-BJ-Eto29.js";import"./index-DWU9a5N7.js";import"./SidePanelFormButtons.module-D2P5PizG.js";import"./HeaderWithSearch-ChRiJ5L0.js";import"./SidePanelTablePagination-JsaCwssU.js";const ee=200,te=(t,l)=>{const r=t.toLowerCase(),u=l.toLowerCase(),o=r.indexOf(u);return o>=0?e.jsxs(e.Fragment,{children:[t.substring(0,o),e.jsx("strong",{children:t.substring(o,o+l.length)}),t.substring(o+l.length)]}):t},ne="_container_1a977_1",se="_suggestionsContainer_1a977_5",ie="_pointer_1a977_12",ae="_highlighted_1a977_17",le="_selectedContainer_1a977_21",f={container:ne,suggestionsContainer:se,pointer:ie,highlighted:ae,selectedContainer:le},oe=({selectedItem:t,setSelectedItem:l})=>{const[r,u]=b.useState(""),[o,d]=b.useState(!1),[h,C]=b.useState(""),S=P(),{autoinstallFiles:y,autoinstallFilesCount:N,isFetching:p}=U({limit:20,offset:0,with_groups:!1,search:r},{enabled:!!r}),_=y.filter(i=>(t==null?void 0:t.id)!==i.id),v=()=>{l(null)},n=()=>{d(!1)},g=()=>{C(""),u("")},m=()=>{h.length>2?d(!0):d(!1)},E=i=>{C(i),i.length>2&&u(i)},D=H(()=>{try{m()}catch(i){S(i)}},ee),T=i=>{l(i),g()},q=i=>{i&&(T(i),d(!1))},w=i=>{i.key==="Escape"?i.currentTarget.blur():D()},a=!o&&h.length<3?"Min 3. characters":N===0&&r&&!p?`No autoinstall files found by "${r}"`:null;return e.jsxs("div",{className:f.container,children:[e.jsx(G,{onSelect:q,itemToString:()=>"",isOpen:o,children:({getInputProps:i,getItemProps:A,getMenuProps:R,highlightedIndex:M})=>e.jsxs("div",{className:"p-autocomplete",children:[e.jsx(c.SearchBox,{...i(),placeholder:"Search for available autoinstall files",className:"u-no-margin--bottom",shouldRefocusAfterReset:!0,externallyControlled:!0,autocomplete:"off",value:h,onChange:E,onClear:g,onBlur:n,onFocus:m,onKeyUp:w}),a?e.jsx("span",{className:"p-form-help-text",children:a}):null,o&&(_.length>0||p)?e.jsx("ul",{className:j("p-list p-card--highlighted u-no-padding u-no-margin--bottom p-autocomplete__suggestions",f.suggestionsContainer),...R(),children:p?e.jsx(K,{}):_.map((F,k)=>e.jsxs("li",{className:j("p-list__item",f.pointer,{[f.highlighted]:M===k}),...A({item:F,index:k}),children:[e.jsx("div",{className:"u-truncate","data-testid":"dropdownElement",children:te(F.filename,r)}),e.jsx("div",{children:e.jsxs("small",{className:"u-text-muted",children:["Last edited:"," ",$(F.last_modified_at).format(B)]})})]},F.filename))}):null]})}),e.jsx("ul",{className:"p-list p-autocomplete__result-list u-no-margin--bottom",children:t?e.jsxs("li",{className:j("p-autocomplete__result p-list__item p-card u-no-margin--bottom",f.selectedContainer),children:[e.jsxs("div",{children:[e.jsx("div",{children:t.filename}),e.jsxs("small",{className:"u-text-muted p-text--small",children:["Last edited:"," ",$(t.last_modified_at).format(B)]})]}),e.jsx(c.Button,{type:"button",appearance:"link",className:"u-no-margin--bottom",onClick:v,children:e.jsx(c.Icon,{name:c.ICONS.delete})})]},t.filename):null})]})},re="_form_1nqr5_1",ce="_code_1nqr5_7",ue="_inputContainer_1nqr5_11",de="_input_1nqr5_11",he="_inputDescription_1nqr5_20",x={form:re,code:ce,inputContainer:ue,input:de,inputDescription:he},pe=[{label:"Select",value:""},{label:"Add new autoinstall file",value:"new"},{label:"Assign existing autoinstall file",value:"assign-existing"},{label:"Inherit default autoinstall file",value:"inherit"}],me={dropdownChoice:"",filename:"",contents:"",selectedAutoinstallFile:null},ge=V().shape({dropdownChoice:I().required("This field is required"),filename:I().when("dropdownChoice",{is:"new",then:t=>t.required("This field is required")}),contents:I().when("dropdownChoice",{is:"new",then:t=>t.required("This field is required")}),selectedAutoinstallFile:V().when("dropdownChoice",{is:"assign-existing",then:t=>t.required("This field is required"),otherwise:t=>t.nullable()})}),Ne=({employeeGroups:t,clearSelectedGroups:l})=>{var w;const r=b.useRef(null),u=P(),{notify:o}=Y(),{closeSidePanel:d}=z(),{updateEmployeeGroups:h,isUpdatingEmployeeGroups:C}=Z(),{addAutoinstallFile:S,isAutoinstallFileAdding:y}=X(),N=t.reduce((s,{employee_count:a=0})=>s+(a??0),0),p=s=>{var a,i;o.success({title:`Successfully reassigned ${s} to ${O(t.length,`${((a=t[0])==null?void 0:a.name)??"1"} group`,`${t.length} groups`)}.`,message:`Autoinstall file assigned to ${N} employees${O(t.length,` in ${((i=t[0])==null?void 0:i.name)??"1"} group`,` across ${t.length} groups`)}.`})},_=async(s,a)=>{try{const{data:i}=await S({contents:s,filename:a});await h(t.map(A=>({autoinstall_file:i,id:A.id,priority:A.priority}))),d(),p(a),l&&l()}catch(i){u(i)}},v=async s=>{try{await h(t.map(a=>({autoinstall_file:s,id:a.id,priority:a.priority}))),d(),p(s.filename),l&&l()}catch(a){u(a)}},n=J({initialValues:me,validationSchema:ge,onSubmit:async s=>{s.dropdownChoice==="new"?await _(s.contents,s.filename):s.selectedAutoinstallFile&&await v(s.selectedAutoinstallFile)}}),{autoinstallFiles:g}=U({is_default:!0},{enabled:n.values.dropdownChoice==="inherit"}),m=g.length>0?g[0]:null,E=async({target:{files:s}})=>{if(!s)return;const[a]=s;await n.setFieldValue("contents",await a.text()),!n.values.filename&&await n.setFieldValue("filename",a.name)},D=async s=>{await n.setFieldValue("contents",s)},T=()=>{var s;(s=r.current)==null||s.click()},q=n.values.dropdownChoice==="assign-existing"&&n.values.selectedAutoinstallFile||n.values.dropdownChoice==="inherit";return e.jsxs(c.Form,{className:x.form,noValidate:!0,onSubmit:n.handleSubmit,children:[e.jsx("p",{children:"This file will only be used during the initial setup of the instance. Changing this autoinstall file will not affect instances that are already registered in landscape."}),e.jsx(c.Select,{label:"Autoinstall file",options:pe,error:L(n,"dropdownChoice"),required:!0,...n.getFieldProps("dropdownChoice"),onChange:async s=>{n.resetForm(),n.getFieldProps("autoinstallFile").onChange(s)}}),n.values.dropdownChoice==="assign-existing"&&e.jsx(oe,{selectedItem:n.values.selectedAutoinstallFile,setSelectedItem:async s=>await n.setFieldValue("selectedAutoinstallFile",s)}),q&&e.jsx(c.CodeSnippet,{className:j({[x.code]:n.values.dropdownChoice==="assign-existing"&&n.values.selectedAutoinstallFile}),blocks:[{title:"Code preview",code:n.values.dropdownChoice==="assign-existing"?(w=n.values.selectedAutoinstallFile)==null?void 0:w.contents:m==null?void 0:m.contents,wrapLines:!0,appearance:"numbered"}]}),n.values.dropdownChoice==="new"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:x.inputContainer,children:[e.jsx(c.Input,{wrapperClassName:x.input,type:"text",label:"File name",...n.getFieldProps("filename"),error:L(n,"filename"),required:!0}),e.jsx("span",{className:x.inputDescription,children:".yaml"})]}),e.jsx("input",{ref:r,className:"u-hide",type:"file",accept:".yaml",onChange:E}),e.jsx(Q,{label:"Code",value:n.values.contents,onChange:D,error:L(n,"contents"),required:!0,language:"yaml",headerContent:e.jsxs(c.Button,{className:"u-no-margin--bottom",appearance:"base",hasIcon:!0,onClick:T,type:"button",children:[e.jsx(c.Icon,{name:"upload"}),e.jsx("span",{children:"Populate from file"})]})})]}),e.jsx(W,{submitButtonDisabled:C||y||n.values.dropdownChoice==="assign-existing"&&!n.values.selectedAutoinstallFile,submitButtonText:"Assign"})]})};export{Ne as default};
