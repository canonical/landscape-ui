import{f as J,e as K,r as g,j as s,g as c}from"./index-Dt7YhOS0.js";import{u as W,C as X,c as l}from"./index-C_GwVjC9.js";import{u as Z}from"./formik.esm-g8btJLb9.js";import{c as N,a as m,f as ee,g as u,b as te}from"./index.esm-Cy_yj1Qh.js";import{u as ie}from"./useRoles-C-Re2CJT.js";import{S as ae}from"./SidePanelFormButtons-Cs6mvCpL.js";import"./useConfirm-CR6bT57R.js";import"./useFetchOld-BGspy5lX.js";import"./useMutation-B0Ge1lYR.js";import"./useQuery-Dlf2yvOE.js";import"./EmptyState-BG0AupYF.js";import"./moment-Cl4UOzQZ.js";import"./SidePanelFormButtons.module-DyBJG5lm.js";const se={add:"Add script",copy:"Copy script",edit:"Save changes"},re={title:"",code:"",access_group:"",time_limit:300,username:"",attachments:{first:null,second:null,third:null,fourth:null,fifth:null},attachmentsToRemove:[]},ce=i=>{var _,S,y,x,F,j,A,C,T,V;const{closeSidePanel:P}=J(),B=K(),{getAccessGroupQuery:$}=ie(),{createScriptQuery:q,editScriptQuery:E,copyScriptQuery:R,getScriptCodeQuery:v,createScriptAttachmentQuery:Q,removeScriptAttachmentQuery:L}=W(),{mutateAsync:O}=q,{mutateAsync:h}=E,{mutateAsync:k}=R,{mutateAsync:D}=Q,{mutateAsync:M}=L,G=N().shape({title:m().required("This field is required"),time_limit:ee().required("This field is required"),code:m().test({name:"required",message:"This field is required",test:t=>i.action==="copy"||i.action==="edit"||!!t}),username:m(),access_group:m(),attachments:N().shape({first:u().nullable(),second:u().nullable(),third:u().nullable(),fourth:u().nullable(),fifth:u().nullable()}),attachmentsToRemove:te().of(m())}),f=async(t,a)=>{const r=[],o=[],w=[];for(const n of a)n&&(o.push(n.arrayBuffer()),w.push(n.name));const I=await Promise.all(o);for(let n=0;n<I.length;n++)r.push(D({script_id:t,file:`${w[n]}$$${l.Buffer.from(I[n]).toString("base64")}`}));await Promise.all(r)},e=Z({initialValues:re,validationSchema:G,onSubmit:async t=>{try{if(i.action==="add"){const a=await O({title:t.title,time_limit:t.time_limit,code:l.Buffer.from(t.code).toString("base64"),username:t.username,access_group:t.access_group});await f(a.data.id,Object.values(t.attachments))}else if(i.action==="edit"){const a=[],r=Object.values(t.attachments).filter(o=>o);for(const o of t.attachmentsToRemove)a.push(M({script_id:i.script.id,filename:o}));a.length?(await Promise.all([...a,h({script_id:i.script.id,title:t.title,time_limit:t.time_limit,code:l.Buffer.from(t.code).toString("base64"),username:t.username})]),r.length&&await f(i.script.id,r)):r.length?await Promise.all([h({script_id:i.script.id,title:t.title,time_limit:t.time_limit,code:l.Buffer.from(t.code).toString("base64"),username:t.username}),f(i.script.id,Object.values(t.attachments))]):await h({script_id:i.script.id,title:t.title,time_limit:t.time_limit,code:l.Buffer.from(t.code).toString("base64"),username:t.username})}else i.action==="copy"&&await k({script_id:i.script.id,destination_title:t.title,access_group:t.access_group});H()}catch(a){B(a)}}}),H=()=>{e.resetForm(),P()};g.useEffect(()=>{i.action!=="add"&&(i.action==="copy"?e.setFieldValue("access_group",i.script.access_group):i.action==="edit"&&(e.setFieldValue("title",i.script.title),e.setFieldValue("time_limit",i.script.time_limit),e.setFieldValue("username",i.script.username),e.setFieldValue("access_group",i.script.access_group)))},[i.action]);const{data:p,isFetching:b}=v({script_id:i.action==="edit"?i.script.id:0},{enabled:i.action==="edit"});g.useEffect(()=>{b||e.setFieldValue("code",(p==null?void 0:p.data)??"")},[b]);const{data:d}=$(),U=g.useMemo(()=>((d==null?void 0:d.data)??[]).map(({name:t,title:a})=>({label:a,value:t})),[d]),Y=[s.jsx(c.Input,{type:"file",label:"First attachment",labelClassName:"u-off-screen",onChange:t=>{var a;e.setFieldValue("attachments.first",((a=t.target.files)==null?void 0:a[0])??null)},error:((_=e.touched.attachments)==null?void 0:_.first)&&((S=e.errors.attachments)==null?void 0:S.first)},"first"),s.jsx(c.Input,{type:"file",label:"Second attachment",labelClassName:"u-off-screen",onChange:t=>{var a;e.setFieldValue("attachments.second",((a=t.target.files)==null?void 0:a[0])??null)},error:((y=e.touched.attachments)==null?void 0:y.second)&&((x=e.errors.attachments)==null?void 0:x.second)},"second"),s.jsx(c.Input,{type:"file",label:"Third attachment",labelClassName:"u-off-screen",onChange:t=>{var a;e.setFieldValue("attachments.third",((a=t.target.files)==null?void 0:a[0])??null)},error:((F=e.touched.attachments)==null?void 0:F.third)&&((j=e.errors.attachments)==null?void 0:j.third)},"third"),s.jsx(c.Input,{type:"file",label:"Fourth attachment",labelClassName:"u-off-screen",onChange:t=>{var a;e.setFieldValue("attachments.fourth",((a=t.target.files)==null?void 0:a[0])??null)},error:((A=e.touched.attachments)==null?void 0:A.fourth)&&((C=e.errors.attachments)==null?void 0:C.fourth)},"fourth"),s.jsx(c.Input,{type:"file",label:"Fifth attachment",labelClassName:"u-off-screen",onChange:t=>{var a;e.setFieldValue("attachments.fifth",((a=t.target.files)==null?void 0:a[0])??null)},error:((T=e.touched.attachments)==null?void 0:T.fifth)&&((V=e.errors.attachments)==null?void 0:V.fifth)},"fifth")],z=()=>{const t=Y;if(i.action==="edit"){const a=i.script.attachments.filter(r=>!e.values.attachmentsToRemove.includes(r)).reverse();for(const r of a)t.unshift(s.jsxs("div",{children:[s.jsx("span",{children:r}),s.jsxs(c.Button,{hasIcon:!0,appearance:"base",className:"u-no-margin--bottom u-no-padding--left p-tooltip--top-center","aria-label":`Remove ${r} attachment`,onClick:()=>{e.setFieldValue("attachmentsToRemove",[...e.values.attachmentsToRemove,r])},children:[s.jsx("span",{className:"p-tooltip__message",children:"Remove"}),s.jsx("i",{className:"p-icon--delete"})]})]},r))}return t.slice(0,5)};return s.jsxs(c.Form,{onSubmit:e.handleSubmit,noValidate:!0,children:[s.jsx(c.Input,{type:"text",label:"Title",required:!0,...e.getFieldProps("title"),error:e.touched.title&&e.errors.title?e.errors.title:void 0}),(i.action==="add"||i.action==="edit")&&s.jsxs(s.Fragment,{children:[s.jsx(c.Input,{type:"number",label:"Time limit (seconds)",required:!0,...e.getFieldProps("time_limit"),error:e.touched.time_limit&&e.errors.time_limit?e.errors.time_limit:void 0}),s.jsx(X,{label:"Code",required:!0,onChange:t=>{e.setFieldValue("code",t??"")},value:e.values.code,error:e.touched.code&&e.errors.code?e.errors.code:void 0}),s.jsx(c.Input,{type:"text",label:"Run as user",...e.getFieldProps("username"),error:e.touched.username&&e.errors.username?e.errors.username:void 0})]}),s.jsx(c.Select,{label:"Access group",options:[{label:"Select access group",value:""},...U],...e.getFieldProps("access_group"),error:e.touched.access_group&&e.errors.access_group?e.errors.access_group:void 0}),(i.action==="add"||i.action==="edit")&&s.jsxs(s.Fragment,{children:[s.jsx("h5",{children:"List of attachments"}),s.jsx("p",{className:"u-text--muted",children:"Attachments that will be sent along with the script. You can attach up to 5 files, for a maximum of 1.00MB. Filenames must be unique. On the client, the attachments will be placed in the directory whose name is accessible through the environment variable LANDSCAPE_ATTACHMENTS. They'll be deleted once the script has been run."})]}),(i.action==="add"||i.action==="edit")&&z(),s.jsx(ae,{submitButtonDisabled:e.isSubmitting,submitButtonText:se[i.action]})]})},xe=ce;export{xe as default};
