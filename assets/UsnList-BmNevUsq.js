import{j as a,e as x,a as D,c as H,l as $,m as M,r as g,x as w,R as B,t as O,g as F}from"./index-USfFY6y3.js";import{m as U}from"./moment-CMR6lHyh.js";import{T as V}from"./TruncatedCell-Bvd7ix8v.js";import{E as q}from"./ExpandableTableFooter-BY0XMpEO.js";import{u as P}from"./useConfirm-CBkoo4y2.js";import{u as Y}from"./useUsns-BzmxRksB.js";import{u as G}from"./usePageParams-C993n8qJ.js";import{u as W}from"./useOnClickOutside-CiLzDwfe.js";const E=({additionalCta:s,columns:t,data:e,limit:l,onLimitChange:d,itemNames:c,totalCount:i,getCellProps:r,getRowProps:b,title:p})=>a.jsxs(a.Fragment,{children:[p&&a.jsx("p",{className:"p-heading--5",children:p}),a.jsx(x.ModularTable,{columns:t,data:e,className:"u-no-margin--bottom",getCellProps:r,getRowProps:b}),a.jsx(q,{additionalCta:s,itemNames:c,limit:l,onLimitChange:d,totalCount:i})]}),I=({limit:s,onLimitChange:t,usn:e,...l})=>{const d=D(),c=H(),{notify:i}=$(),{confirmModal:r,closeConfirmModal:b}=P(),{getAffectedPackagesQuery:p,removeUsnPackagesQuery:k}=Y(),{setPageParams:C}=G(),{instanceId:f,childInstanceId:u}=M(),y=Number(f),{mutateAsync:T}=k,n=()=>{d(`${B}instances/${u?`${y}/${u}`:`${y}`}`),C({tab:"activities"}),i.clear()},o=async()=>{try{await T({usns:e,instanceId:y}),i.success({title:"You queued packages to be uninstalled",message:`Packages affected by "${e}" security issue will be uninstalled and are queued in Activities.`,actions:[{label:"View details",onClick:()=>n()}]})}catch(j){c(j)}finally{b()}},_=j=>{r({title:"Uninstall USN packages",body:`This will uninstall packages affected by "${e}" security issue from the "${j}" instance.`,buttons:[a.jsx(x.Button,{type:"button",appearance:"negative",onClick:()=>o(),children:"Uninstall"},"remove")]})},v=l.isRemovable?[a.jsxs(x.Button,{type:"button",small:!0,dense:!0,hasIcon:!0,onClick:()=>_(l.instanceTitle),children:[a.jsx(x.Icon,{name:"delete",className:"u-no-margin--left"}),a.jsx("span",{children:"Uninstall packages"})]},"remove")]:void 0,{data:h,isLoading:L}=p({usn:e,computer_ids:l.isRemovable?[y]:l.instanceIds}),N=g.useMemo(()=>(h==null?void 0:h.data.slice(0,s))||[],[h,s]),A=g.useMemo(()=>[{accessor:"name",Header:"Package"},{accessor:"current_version",Header:"Current version"},{accessor:"new_version",Header:"New version"},{accessor:"summary",Header:"Details"}],[N.length]);return L?a.jsx(w,{}):a.jsx(E,{additionalCta:v,columns:A,data:N,itemNames:{plural:"packages",singular:"package"},limit:s,onLimitChange:t,totalCount:(h==null?void 0:h.data.length)??0})},X={computers_count:0,cves:[],date:"",info:"",packages:[],usn:"loading",usn_link:""},z={computers_count:0,cves:[],date:"",info:"",packages:[],usn:"expandedUsn",usn_link:""},J="_checkboxColumn_1yn78_1",K="_expanded_1yn78_5",Q="_expandButton_1yn78_23",Z="_hidden_1yn78_31",ee="_innerTable_1yn78_35",ae="_expandedRow_1yn78_39",ne="_expandedCell_1yn78_44",se="_cve_1yn78_49",te="_cveLink_1yn78_53",m={checkboxColumn:J,expanded:K,expandButton:Q,hidden:Z,innerTable:ee,expandedRow:ae,expandedCell:ne,cve:se,cveLink:te},le=(s,t,e,l)=>{if(t==="")return e==="expandable"?s.slice(0,l):s;const d=s.findIndex(({usn:c})=>c===t)+1;return[...s.slice(0,d),z,...s.slice(d,e==="expandable"?l:s.length)]},R=(s,t,e)=>({column:l,row:{original:{usn:d},index:c}})=>{const i={};return d===e?l.id==="release_packages"&&(i.className=m.expanded):["expandedUsn","loading"].includes(d)?l.id==="usn"?(i.colSpan=s==="expandable"?4:5,d==="expandedUsn"&&(i.className=m.innerTable)):(i.className=m.hidden,i["aria-hidden"]=!0):l.id==="usn"?i.role="rowheader":l.id==="cves"?(i["aria-label"]="CVE(s)",t===c&&(i.className=m.expandedCell)):l.id==="date"?i["aria-label"]="Date published":l.id==="release_packages"&&(i["aria-label"]="Affected packages"),i},S=s=>({index:t})=>{const e={};return s===t&&(e.className=m.expandedRow),e},ie=s=>t=>{t&&(s.current=[...t.querySelectorAll("tbody tr")])},xe=({isUsnsLoading:s,usns:t,...e})=>{const[l,d]=g.useState(5),[c,i]=g.useState(""),[r,b]=g.useState(-1),[p,k]=g.useState(5),C=g.useRef([]);W({current:r!==-1?C.current[r]:null},()=>b(-1));const f=g.useMemo(()=>s?[X]:le(t,c,e.tableType,l),[t,c,s,l,e.tableType]),u=e.tableType==="paginated"?e.selectedUsns:[],y=n=>{if(e.tableType==="expandable")return;const o=u.filter(_=>_.usn!==n.usn);e.onSelectedUsnsChange(u.length!==o.length?o:[...o,n])},T=g.useMemo(()=>[{accessor:"checkbox",className:m.checkboxColumn,Header:()=>e.tableType==="paginated"&&a.jsx(x.CheckboxInput,{inline:!0,label:a.jsx("span",{className:"u-off-screen",children:"Toggle all security issues"}),disabled:f.length===0||f[0].usn==="loading",indeterminate:u.length>0&&u.length<t.length,checked:u.length>0&&u.length===t.length,onChange:()=>e.onSelectedUsnsChange(u.length>0?[]:t)}),Cell:({row:n})=>e.tableType==="paginated"&&a.jsx(x.CheckboxInput,{labelClassName:"u-no-margin--bottom u-no-padding--top",label:a.jsx("span",{className:"u-off-screen",children:`Toggle ${n.original.usn}`}),name:"usn",checked:u.some(({usn:o})=>o===n.original.usn),onChange:()=>y(n.original)})},{accessor:"usn",Header:"USN",Cell:({row:n})=>n.original.usn==="expandedUsn"?e.tableType==="expandable"?a.jsx(I,{isRemovable:!1,instanceIds:e.instanceIds,limit:p,onLimitChange:()=>k(o=>o+5),usn:c}):a.jsx(I,{isRemovable:!0,instanceTitle:e.instanceTitle,limit:p,onLimitChange:()=>k(o=>o+5),usn:c}):n.original.usn==="loading"?a.jsx(w,{}):a.jsx("a",{href:n.original.usn_link,target:"_blank",rel:"nofollow noopener noreferrer",children:n.original.usn})},{accessor:"cves",Header:"CVE(s)",Cell:({row:{original:n,index:o}})=>a.jsx(V,{content:n.cves.map(({cve:_,cve_link:v})=>a.jsx("span",{className:m.cve,children:a.jsx("a",{href:v,target:"_blank",rel:"nofollow noopener noreferrer",className:m.cveLink,children:_})},_)),isExpanded:r===o,onExpand:()=>{i(""),b(c?o-1:o)}})},{accessor:"date",Header:"Date published",Cell:({row:n})=>a.jsx(a.Fragment,{children:U(n.original.date).isValid()?U(n.original.date).format(O):"---"})},{accessor:"release_packages",Header:"Affected packages",Cell:({row:n})=>a.jsx(a.Fragment,{children:a.jsx(x.Button,{type:"button",className:F("p-accordion__tab",m.expandButton),"aria-expanded":n.original.usn===c,onClick:()=>{b(-1),i(o=>o===n.original.usn?"":n.original.usn),k(5)},children:`${n.original.usn===c?"Hide":"Show"} packages`})})}].filter(({accessor:n})=>e.tableType==="paginated"||n!=="checkbox"),[f,p,u.length,e.tableType,r]);return a.jsx("div",{ref:ie(C),children:e.tableType==="expandable"?a.jsx(E,{columns:T,data:f,getCellProps:R(e.tableType,r,c),getRowProps:S(r),itemNames:{plural:"security issues",singular:"security issue"},limit:l,onLimitChange:()=>d(n=>n+5),title:"Security issues",totalCount:t.length}):a.jsx(x.ModularTable,{columns:T,data:f,getCellProps:R(e.tableType,r,c),getRowProps:S(r),emptyMsg:`No security issues found with the search "${e.search}"`})})};export{E,xe as U};
