import{k as z,n as l,l as V,O as q,w as P,r as k,q as K,i as W,t as Q,j as t,h as a,W as F}from"./index-ChL2S0eU.js";import{C as v,U as Y}from"./UdebCheckboxInput-D4kGw8Lz.js";import{S as J}from"./SidePanelFormButtons-BSzys4oQ.js";import{u as X}from"./useGPGKeys-D9a4aE21.js";import{h as n}from"./moment-C5S46NFB.js";import{I as E,S as g,f as p,c as Z,u as ee,h as re,C as te,A as se,D as C,i as j,j as S,g as f,P as I}from"./constants-DWkEqbMP.js";import{t as A}from"./tests-DFnZqbNV.js";import"./SidePanelFormButtons.module-yv6Qz3cN.js";import"./useFetchOld-DIiLQM9i.js";import"./InfoItem-B_e41MQz.js";import"./NoData-9Q0i8yik.js";import"./index-CFnR-9aM.js";import"./moment-BLNajCvU.js";import"./TablePagination-DNBQxF-y.js";import"./TablePagination.module-CgQ3jx4B.js";import"./usePageParams-BCQ4b1Cy.js";import"./SearchHelpPopup-DQ_hKs0k.js";const ae=o=>o.replace(/\/[^\\/@]*@/,"/"),ie=o=>o?{...E,distribution:o.name}:E,oe=(o,d)=>z().shape({distribution:l().required("This field is required."),type:l().required("This field is required."),name:l().required("This field is required.").test({test:A.test,message:A.message}).test({test:(i,s)=>!!s.parent.distribution,message:"First select the distribution."}).test({params:{distribution:d,distributions:o},test:(i,s)=>s.parent.distribution?!(d?d.series.map(({name:c})=>c):o.filter(({name:c})=>c===s.parent.distribution)[0].series.map(({name:c})=>c)).includes(i):!0,message:"It must be unique within series within the distribution."}),hasPockets:V(),mirror_series:l(),mirror_gpg_key:l(),mirror_uri:l().when("hasPockets",(i,s)=>i[0]?s.nonNullable().required("This field is required."):s),snapshotDate:l().when("type",(i,s)=>i[0]==="ubuntu-snapshot"?s.required("This field is required.").test({test:h=>n(h).isBetween(n(g),n()),message:`The date must be after ${n(g).format(q)} and not in the future.`}):s),gpg_key:l().when("hasPockets",(i,s)=>i[0]?s.required("This field is required."):s),pockets:P().of(l()),components:P().of(l()).when("hasPockets",(i,s)=>i[0]?s.min(1,"Please choose at least one component."):s),architectures:P().of(l()).when("hasPockets",(i,s)=>i[0]?s.min(1,"Please choose at least one architecture."):s),include_udeb:V().required()}),fe=({distribution:o,ctaText:d="Add mirror"})=>{const[i,s]=k.useState(p),[h,c]=k.useState([]),D=K(),{closeSidePanel:O}=W(),{getGPGKeysQuery:N}=X(),{createSeriesQuery:R,getRepoInfo:U}=Z(),{getDistributionsQuery:G}=ee(),{data:b}=G({include_latest_sync:!0},{enabled:!o}),T=(b==null?void 0:b.data)??[],{data:y}=N(),{mutateAsync:L}=R,w=(y==null?void 0:y.data)??[],M=T.map(({name:r})=>({label:r,value:r})),e=Q({initialValues:ie(o),validationSchema:oe(T,o),onSubmit:async r=>{try{await L({name:r.name,distribution:r.distribution,mirror_series:r.mirror_series,gpg_key:r.gpg_key,include_udeb:r.include_udeb,mirror_uri:r.mirror_uri,components:r.components,pockets:r.pockets,architectures:r.architectures,mirror_gpg_key:r.mirror_gpg_key}),O()}catch(u){D(u)}}}),$=async r=>{await e.setFieldValue("snapshotDate",r.target.value),await e.setFieldValue("mirror_uri",`${C}/${n(r.target.value).format(j)}`)},B=async r=>{var u;await e.setFieldValue("type",r.target.value),r.target.value==="ubuntu"?(await e.setFieldValue("mirror_uri",p),await e.setFieldValue("pockets",S.ubuntu),await e.setFieldValue("hasPockets",!0),await e.setFieldValue("components",f.ubuntu),await e.setFieldValue("architectures",I.ubuntu),r.target.value==="ubuntu"&&!((u=e.values.mirror_uri)!=null&&u.startsWith(p))&&await e.setFieldValue("mirror_uri",p),s(p)):r.target.value==="third-party"?(await e.setFieldValue("mirror_uri",""),await e.setFieldValue("pockets",S.thirdParty),await e.setFieldValue("hasPockets",!0),await e.setFieldValue("components",f.thirdParty),await e.setFieldValue("architectures",I.thirdParty),s("")):r.target.value==="ubuntu-snapshot"&&(await e.setFieldValue("mirror_uri",`${C}/${n(e.values.snapshotDate).format(j)}`),await e.setFieldValue("pockets",S.ubuntu),await e.setFieldValue("hasPockets",!0),await e.setFieldValue("components",f.ubuntu),s(p))},H=async r=>{const u=r.target.value;await e.setFieldValue("mirror_series",u),!(!u||e.values.name)&&await e.setFieldValue("name",e.values.type==="ubuntu-snapshot"?`${u}-snapshot-${n(e.values.snapshotDate).format(F)}`:u)},{data:_}=U({mirror_uri:ae(i)},{enabled:!!i}),m=_==null?void 0:_.data;return k.useEffect(()=>{var r;if(!m){c([]);return}m.ubuntu?(r=e.values.mirror_uri)!=null&&r.startsWith(p)&&e.setFieldValue("type","ubuntu"):e.setFieldValue("type","third-party"),c(m.repos.map(({description:u,repo:x})=>({label:m.ubuntu?u:x,value:x})))},[m]),t.jsxs(a.Form,{onSubmit:e.handleSubmit,noValidate:!0,children:[t.jsx(a.Select,{label:"Type",required:!0,options:[{label:"Ubuntu Archive",value:"ubuntu"},{label:"Ubuntu Snapshot",value:"ubuntu-snapshot"},{label:"Third party",value:"third-party"}],...e.getFieldProps("type"),onChange:B,error:e.touched.type&&e.errors.type?e.errors.type:void 0}),e.values.type!=="ubuntu-snapshot"&&t.jsx(a.Input,{type:"text",label:"Mirror URI",required:e.values.hasPockets,help:"Absolute URL or file path",...e.getFieldProps("mirror_uri"),onBlur:r=>{s(r.target.value)},error:e.touched.mirror_uri&&e.errors.mirror_uri?e.errors.mirror_uri:void 0}),e.values.type==="ubuntu-snapshot"&&t.jsx(a.Input,{type:"date",min:n(g).format(F),max:n().format(F),label:"Snapshot date",required:!0,...e.getFieldProps("snapshotDate"),onChange:$,error:e.touched.snapshotDate&&e.errors.snapshotDate?e.errors.snapshotDate:void 0,help:`Starting from approximately ${n(g).format(q)} in dd.mm.yyyy format`}),!o&&t.jsx(a.Select,{label:"Distribution",required:!0,options:[{label:"Select distribution",value:""},...M],...e.getFieldProps("distribution"),error:e.touched.distribution&&e.errors.distribution?e.errors.distribution:void 0}),t.jsxs(a.Row,{className:"u-no-padding",children:[t.jsx(a.Col,{size:6,medium:3,small:2,children:t.jsx(a.Select,{label:"Mirror series",options:[{label:"Select series",value:""},...h],...e.getFieldProps("mirror_series"),onChange:H,error:e.touched.mirror_series&&e.errors.mirror_series?e.errors.mirror_series:void 0})}),t.jsx(a.Col,{size:6,medium:3,small:2,children:t.jsx(a.Input,{type:"text",label:"Series name",required:!0,...e.getFieldProps("name"),error:e.touched.name&&e.errors.name?e.errors.name:void 0})})]}),t.jsxs(a.Row,{className:"u-no-padding",children:[e.values.type!=="ubuntu-snapshot"&&t.jsx(a.Col,{size:6,medium:3,small:2,children:t.jsx(a.Select,{label:"Mirror GPG key",options:[{label:"Select mirror GPG key",value:""},...w.filter(({has_secret:r})=>!r).map(({name:r})=>({label:r,value:r}))],...e.getFieldProps("mirror_gpg_key"),error:e.touched.mirror_gpg_key&&e.errors.mirror_gpg_key?e.errors.mirror_gpg_key:void 0,help:"If none is given, the stock Ubuntu archive one will be used."})}),t.jsx(a.Col,{size:6,medium:3,small:2,children:t.jsx(a.Select,{label:"GPG key",required:e.values.hasPockets,options:[{label:"Select GPG key",value:""},...w.filter(({has_secret:r})=>r).map(({name:r})=>({label:r,value:r}))],...e.getFieldProps("gpg_key"),error:e.touched.gpg_key&&e.errors.gpg_key?e.errors.gpg_key:void 0})})]}),["ubuntu","ubuntu-snapshot"].includes(e.values.type)&&t.jsxs(t.Fragment,{children:[t.jsx(v,{label:"Pockets",style:{marginTop:"1.5rem"},options:re,...e.getFieldProps("pockets"),onChange:async r=>{await e.setFieldValue("pockets",r),await e.setFieldValue("hasPockets",!!r.length)},error:e.touched.pockets&&e.errors.pockets?e.errors.pockets:void 0}),t.jsx(v,{label:"Components",required:e.values.hasPockets,options:te,...e.getFieldProps("components"),onChange:async r=>{await e.setFieldValue("components",r)},error:e.touched.components&&e.errors.components?e.errors.components:void 0}),t.jsx(v,{label:"Architectures",required:e.values.hasPockets,options:se,...e.getFieldProps("architectures"),onChange:async r=>{await e.setFieldValue("architectures",r)},error:e.touched.architectures&&e.errors.architectures?e.errors.architectures:void 0})]}),e.values.type==="third-party"&&t.jsxs(t.Fragment,{children:[t.jsx(a.Input,{type:"text",label:"Pockets",placeholder:"E.g. releases, security, etc.",...e.getFieldProps("pockets"),value:e.values.pockets.join(","),onChange:async r=>{await e.setFieldValue("pockets",r.target.value.replace(/\s/g,"").split(",")),await e.setFieldValue("hasPockets",!!r.target.value)},error:e.touched.pockets&&e.errors.pockets?e.errors.pockets:void 0,help:"List the pocket names separated by commas"}),t.jsx(a.Input,{type:"text",label:"Components",required:e.values.hasPockets,placeholder:"E.g. main, universe, etc.",...e.getFieldProps("components"),value:e.values.components.join(","),onChange:async r=>{await e.setFieldValue("components",r.target.value.replace(/\s/g,"").split(","))},error:e.touched.components&&e.errors.components?e.errors.components:void 0,help:"List the component names separated by commas"}),t.jsx(a.Input,{type:"text",label:"Architectures",required:e.values.hasPockets,placeholder:"E.g. amd64, riscv, etc.",...e.getFieldProps("architectures"),value:e.values.architectures.join(","),onChange:async r=>{await e.setFieldValue("architectures",r.target.value.replace(/\s/g,"").split(","))},error:e.touched.architectures&&e.errors.architectures?e.errors.architectures:void 0,help:"List the architectures separated by commas"})]}),t.jsx(Y,{formik:e}),t.jsx(J,{submitButtonDisabled:e.isSubmitting,submitButtonText:d})]})};export{fe as default};
