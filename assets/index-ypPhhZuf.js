import{j as e,d as o,G as v,a5 as $,k as O,h as x,H as N,m as I,l as D,au as R,av as H,y as k,z as L,q as S,B as V,c as z,o as Q,J as X,w as T,U as Y,an as J}from"./index-CNSDWj8Q.js";import{A as K}from"./AssociationBlock-B4LnXWNE.js";import{S as W}from"./SidePanelFormButtons-DIizKTix.js";import{u as E}from"./useRoles-DYJzr0u4.js";import{g as y}from"./formikErrors-Bw8iTXYS.js";import{u as Z,U as ee}from"./index-DXXtCRC6.js";import{a as lt,b as dt,c as ut}from"./index-DXXtCRC6.js";import{M as te}from"./MultiSelectField-CqoYdMk0.js";import{R as re}from"./RandomizationBlock-DfhzodqZ.js";import{r as ae}from"./helpers-kPKhnyjI.js";import{S as _}from"./SidePanel-ChyjtMJv.js";import{P as ie}from"./ProfileAssociationInfo-DMGjDKb4.js";import{B as j}from"./Blocks-yjg-J-3E.js";import{I as p}from"./InfoGrid-3w5mqARw.js";import{I as se}from"./InfoItem-Bt7JBIPo.js";import{u as oe}from"./useFetchOld-BAAs34Op.js";import"./useGetTags-B_HL7bdb.js";import"./SidePanelFormButtons.module-CcPyiogC.js";import"./PageMain-C8MVZwda.js";import"./TableFilterChips-06YfpJdc.js";import"./ProfileAssociatedInstancesLink-Neer6jGU.js";import"./NoData-6ZK9sV5u.js";import"./StaticLink-BEYCGcPv.js";import"./constants-CDnVvJTb.js";import"./constants-cpRdwKHL.js";import"./ListTitle-BUruUKn1.js";import"./ResponsiveTable-BXalKviy.js";import"./TruncatedCell-BMum6DLZ.js";import"./Truncated-Dtg97i8C.js";import"./useExpandableRow-B4jhRgod.js";import"./TextConfirmationModal-q88mH05g.js";import"./table-CdFwMAPu.js";import"./HeaderWithSearch-D2tNhOlz.js";import"./RadioGroup-BVZkBsDq.js";const w=[{label:"Sunday",order:0,value:"su"},{label:"Monday",order:1,value:"mo"},{label:"Tuesday",order:2,value:"tu"},{label:"Wednesday",order:3,value:"we"},{label:"Thursday",order:4,value:"th"},{label:"Friday",order:5,value:"fr"},{label:"Saturday",order:6,value:"sa"}],ne=`If Landscape cannot upgrade the
associated instances by this point,
the upgrade will be canceled.`,le="_container_x7xq2_1",de="_radioGroup_x7xq2_7",ue="_timeContainer_x7xq2_13",ce="_time_x7xq2_13",pe="_timeInput_x7xq2_27",me="_inputDescriptionAfter_x7xq2_32",ge="_inputDescriptionBefore_x7xq2_37",_e="_colon_x7xq2_42",he="_tooltip_x7xq2_48",fe="_expiration_x7xq2_52",d={container:le,radioGroup:de,timeContainer:ue,time:ce,timeInput:pe,inputDescriptionAfter:me,inputDescriptionBefore:ge,colon:_e,tooltip:he,expiration:fe},xe=({formik:t})=>{const r=[y(t,"at_hour"),y(t,"at_minute"),y(t,"deliver_within")];return e.jsxs("div",{className:d.container,children:[e.jsx("p",{className:"p-heading--5",children:"Schedule"}),e.jsx(te,{variant:"condensed",label:"Days",items:w,selectedItems:w.filter(({value:a})=>t.values.on_days.includes(a)),onItemsUpdate:a=>t.setFieldValue("on_days",a.map(({value:l})=>l)),isSortedAlphabetically:!1,hasSelectedItemsFirst:!1,error:y(t,"on_days")}),e.jsxs("div",{className:d.radioGroup,children:[e.jsx(o.RadioInput,{label:"At a specific time",...t.getFieldProps("every"),checked:t.values.every==="week",onChange:()=>t.setFieldValue("every","week")}),e.jsx(o.RadioInput,{label:"Hourly",...t.getFieldProps("every"),checked:t.values.every==="hour",onChange:()=>t.setFieldValue("every","hour")})]}),e.jsxs("div",{className:d.timeContainer,children:[e.jsxs("div",{className:d.time,children:[t.values.every==="week"&&e.jsxs(e.Fragment,{children:[e.jsx(o.Input,{type:"number",label:"Time","aria-label":"at hour",placeholder:"HH",className:d.timeInput,wrapperClassName:v({"is-error":r[0]}),...t.getFieldProps("at_hour"),"aria-errormessage":r[0]?"hour-error":void 0}),e.jsx("span",{className:d.colon,children:":"})]}),t.values.every==="hour"&&e.jsx("span",{className:d.inputDescriptionBefore,children:"at"}),e.jsx(o.Input,{type:"number",label:"At minute",labelClassName:"u-off-screen","aria-label":"at minute",className:d.timeInput,wrapperClassName:v({"is-error":r[1]}),placeholder:"MM",...t.getFieldProps("at_minute"),"aria-errormessage":r[1]?"minute-error":void 0}),t.values.every==="hour"&&e.jsx("span",{className:d.inputDescriptionAfter,children:"minute"}),e.jsx(o.Input,{type:"number",label:e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"Expires after "}),e.jsx(o.Tooltip,{message:ne,position:"top-right",tooltipClassName:d.tooltip,children:e.jsx(o.Icon,{name:"help"})})]}),wrapperClassName:v(d.expiration,{"is-error":r[2]}),className:d.timeInput,...t.getFieldProps("deliver_within"),"aria-errormessage":"expires-error"}),e.jsx("span",{className:d.inputDescriptionAfter,children:"hours"})]}),r.filter(Boolean).length>0&&e.jsxs("div",{className:v({"is-error":r.filter(Boolean).length>0}),children:[r[0]&&e.jsx("p",{className:"p-form-validation__message",id:"hour-error",children:e.jsx("span",{children:r[0]})}),r[1]&&e.jsx("p",{className:"p-form-validation__message",id:"minute-error",children:e.jsx("span",{children:r[1]})}),r[2]&&e.jsxs("p",{className:"p-form-validation__message",id:"expires-error",children:[e.jsx("strong",{children:"Error: "}),e.jsx("span",{children:r[2]})]})]})]}),e.jsx(re,{formik:t})]})},ye={add:"Add upgrade profile",edit:"Save changes"},ve={access_group:$,all_computers:!1,at_hour:"",at_minute:"",autoremove:!1,deliver_delay_window:0,deliver_within:1,every:"week",on_days:[],randomize_delivery:!1,tags:[],title:"",upgrade_type:"all"},U={add:"added",edit:"updated"},je=t=>O().shape({...ae,access_group:x(),all_computers:D(),at_hour:I().when("every",{is:"week",then:r=>r.required("Hour is required.").integer("Hour must be an integer.").min(0,"Hour must be between 0 and 23.").max(H,"Hour must be between 0 and 23.")}),at_minute:I().required("Minute is required.").integer("Minute must be an integer.").min(0,"Minute must be between 0 and 59.").max(R,"Minute must be between 0 and 59."),deliver_within:I().integer("'Expires after' must be an integer.").min(0,"'Expires after' must be at least 0."),every:x().required("This field is required."),on_days:N().of(x()).when("every",{is:"week",then:r=>r.min(1,"At least one day must be selected.")}),tags:N().of(x()),title:x().test({name:"required",message:"This field is required.",params:{action:t},test:r=>!!r||t!=="add"}),upgrade_type:x().required("This field is required.")}),C=t=>{const r=k(),{notify:a}=L(),{sidePath:l,popSidePath:h,createPageParamsSetter:u}=S(),{createUpgradeProfileQuery:c,editUpgradeProfileQuery:g}=Z(),{getAccessGroupQuery:m}=E(),{data:f}=m({},{enabled:t.action==="add"}),b=f?.data.map(({name:i,title:s})=>({label:s,value:i}))??[],{mutateAsync:P}=c,{mutateAsync:M}=g,A=u({sidePath:[],profile:""}),B=async i=>{const s={all_computers:i.all_computers,at_minute:i.at_minute,autoremove:i.autoremove,deliver_within:i.deliver_within,every:i.every,on_days:i.on_days,title:i.title,upgrade_type:i.upgrade_type};t.action==="add"&&(s.access_group=i.access_group),i.every==="week"&&(s.at_hour=i.at_hour),i.randomize_delivery&&(s.deliver_delay_window=`${i.deliver_delay_window}`),!i.all_computers&&i.tags.length&&(s.tags=i.tags);try{t.action==="edit"?await M({all_computers:s.all_computers,at_hour:s.at_hour,at_minute:s.at_minute,autoremove:s.autoremove,deliver_delay_window:s.deliver_delay_window,deliver_within:s.deliver_within,every:s.every,name:t.profile.name,on_days:s.on_days,tags:s.tags,title:s.title,upgrade_type:s.upgrade_type}):await P(s),A(),a.success({message:`Upgrade profile "${i.title}" has been ${U[t.action]} `,title:`Upgrade profile ${U[t.action]}`})}catch(G){r(G)}},n=V({initialValues:t.action==="edit"?{all_computers:t.profile.all_computers,at_hour:t.profile.at_hour?parseInt(t.profile.at_hour):"",at_minute:parseInt(t.profile.at_minute),autoremove:t.profile.autoremove,deliver_delay_window:parseInt(t.profile.deliver_delay_window),deliver_within:parseInt(t.profile.deliver_within),every:t.profile.every,on_days:t.profile.on_days??[],randomize_delivery:t.profile.deliver_delay_window!=="0",tags:t.profile.tags,title:t.profile.title,upgrade_type:t.profile.upgrade_type}:ve,onSubmit:B,validationSchema:je(t.action)});return e.jsxs(o.Form,{onSubmit:n.handleSubmit,noValidate:!0,children:[e.jsx(o.Input,{type:"text",required:t.action==="add",label:"Title",...n.getFieldProps("title"),error:y(n,"title")}),e.jsx(o.Input,{type:"checkbox",label:"Only upgrade security issues",help:"Regular upgrades will not be applied",...n.getFieldProps("upgrade_type"),checked:n.values.upgrade_type==="security",onChange:async()=>n.setFieldValue("upgrade_type",n.values.upgrade_type==="all"?"security":"all")}),e.jsx(o.Input,{type:"checkbox",label:"Remove packages that are no longer needed",help:"This will affect packages installed to satisfy dependencies that are no longer required after upgrading.",...n.getFieldProps("autoremove"),checked:n.values.autoremove}),e.jsx(o.Select,{label:"Access group","aria-label":"Access group",options:b,disabled:t.action==="edit",...n.getFieldProps("access_group"),error:y(n,"access_group")}),e.jsx(xe,{formik:n}),e.jsx(K,{formik:n}),e.jsx(W,{submitButtonDisabled:n.isSubmitting,submitButtonText:ye[t.action],onCancel:A,hasBackButton:l.length>1,onBackButtonPress:h})]})},at=()=>e.jsxs(e.Fragment,{children:[e.jsx(_.Header,{children:"Add upgrade profile"}),e.jsx(_.Content,{children:e.jsx(C,{action:"add"})})]}),be=t=>{const r=oe(),{data:a,isPending:l,error:h}=z({queryKey:["upgradeProfile",t],queryFn:async({signal:c})=>r.get("GetUpgradeProfiles",{signal:c})}),u=a?.data.find(({id:c})=>c===t);return{upgradeProfile:u,upgradeProfileError:a&&!u?new Error("The upgrade profile could not be found."):h,isGettingUpgradeProfile:l}},q=()=>{const{profile:t}=S(),{isGettingUpgradeProfile:r,upgradeProfile:a,upgradeProfileError:l}=be(parseInt(t));if(l)throw l;return r?{upgradeProfile:void 0,isGettingUpgradeProfile:!0}:{upgradeProfile:a,isGettingUpgradeProfile:!1}},F=t=>w.filter(({value:r})=>t.includes(r)).sort((r,a)=>r.order-a.order).map(({label:r})=>r).join(", ").replace(/,(?= \w+$)/," and"),Pe=t=>{const{at_hour:r,deliver_within:a,every:l,next_run:h,on_days:u}=t,c=Q(h).utc().format(`ddd, ${X} [UTC (expires after ${a}h)]`);let g="Every ";const m=parseInt(t.at_minute);if(l==="hour"&&(g+=`hour at ${m} ${T(m,"minute")}`,u&&(g+=` on ${F(u)}`)),l==="week"){if(!u||!r)return{scheduleMessage:"Every week",nextRunMessage:c};const f=parseInt(r);g+=`${F(u)} at ${f>9?f:`0${f}`}:${m>9?m:`0${m}`} UTC`}return{scheduleMessage:g,nextRunMessage:c}},it=()=>{const{createSidePathPusher:t}=S(),{getAccessGroupQuery:r}=E(),{upgradeProfile:a,isGettingUpgradeProfile:l}=q(),{data:h,isPending:u}=r(),{value:c,setTrue:g,setFalse:m}=Y();if(l||u)return e.jsx(_.LoadingState,{});const{scheduleMessage:f,nextRunMessage:b}=Pe(a),P=t("edit");return e.jsxs(e.Fragment,{children:[e.jsx(_.Header,{children:a.title}),e.jsxs(_.Content,{children:[e.jsxs("div",{className:"p-segmented-control",children:[e.jsxs(o.Button,{type:"button",hasIcon:!0,className:"p-segmented-control__button",onClick:P,"aria-label":`Edit upgrade profile ${a.title}`,children:[e.jsx(o.Icon,{name:"edit"}),e.jsx("span",{children:"Edit"})]}),e.jsxs(o.Button,{className:"has-icon p-segmented-control__button","aria-label":`Remove upgrade profile ${a.title}`,type:"button",onClick:g,children:[e.jsx(o.Icon,{name:o.ICONS.delete}),e.jsx("span",{children:"Remove"})]})]}),e.jsxs(j,{children:[e.jsx(j.Item,{children:e.jsxs(p,{children:[e.jsx(p.Item,{label:"Title",value:a.title}),e.jsx(p.Item,{label:"Name",value:a.name}),e.jsx(p.Item,{label:"Access group",value:J(a.access_group,h)}),e.jsx(p.Item,{label:"Upgrade type",value:a.upgrade_type==="all"?"All":"Security"}),e.jsx(p.Item,{label:"Auto remove packages",value:a.autoremove?"On":"Off"})]})}),e.jsx(j.Item,{title:"Schedule",children:e.jsxs(p,{children:[e.jsx(p.Item,{label:"Schedule",large:!0,value:f}),e.jsx(p.Item,{label:"Next run",large:!0,value:b}),e.jsx(p.Item,{label:"Delivery delay window",large:!0,value:`${a.deliver_delay_window} ${T(Number(a.deliver_delay_window),"minute")}`})]})}),e.jsx(j.Item,{title:"Association",children:e.jsx(ie,{profile:a,children:e.jsx(se,{label:"Tags",value:a.tags.join(", ")})})})]})]}),e.jsx(ee,{close:m,isOpen:c,upgradeProfile:a})]})},st=()=>{const{upgradeProfile:t,isGettingUpgradeProfile:r}=q();return r?e.jsx(_.LoadingState,{}):e.jsxs(e.Fragment,{children:[e.jsxs(_.Header,{children:['Edit "',t.title,'" profile']}),e.jsxs(_.Content,{children:[e.jsx(C,{action:"edit",profile:t}),";"]})]})};export{C as SingleUpgradeProfileForm,at as UpgradeProfileAddSidePanel,it as UpgradeProfileDetailsSidePanel,st as UpgradeProfileEditSidePanel,lt as UpgradeProfileList,dt as UpgradeProfilesEmptyState,ut as UpgradeProfilesHeader,Z as useUpgradeProfiles};
