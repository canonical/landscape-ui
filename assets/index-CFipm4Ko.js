import{b as M,g as ie,h as H,i as he,l as E,aQ as Z,j as e,d,F as Q,a$ as j,aS as D,z as g,N as z,K as h,C as R,u as ge,s as P,a6 as W,o as K,k as F,q as ae,v as re,a5 as ne,x as B,y as V,p as k,a7 as b,Z as fe,M as L,$ as xe,aO as C,A as be,Q as ve}from"./index-CYddq1Dt.js";import{aP as kt,aU as Gt,aT as Vt}from"./index-CYddq1Dt.js";import{p as le,g as Se,n as oe,u as je,a as Pe,b as we,c as Ie,S as Ne,d as Ae,e as Fe,f as Te,h as de,i as De,j as Be}from"./index-CDgPeLKz.js";import{A as Ut,k as Ht,l as Qt,m as Wt}from"./index-CDgPeLKz.js";import{S as q}from"./SidePanelFormButtons-y29iSwpX.js";import{A as Re}from"./AssociationBlock-B72vcgBb.js";import{u as Ce}from"./useGetInstances-CV0aoWi6.js";import{F as Ee}from"./FileInput-d7zKrlcC.js";import{u as Le}from"./useOrgSettings-B17X1fDW.js";import{u as ce}from"./useRoles-CskDJFuI.js";import{M as X}from"./MultiSelectField-Gz723sxa.js";import"./PageMain-wcB-RWYa.js";import"./HeaderWithSearch-LK3eyMPY.js";import"./constants-BvfXqWjy.js";import"./constants-Cj2pKWow.js";import"./TextConfirmationModal-D1Pp81Mj.js";import"./useGetActivities-DHDdEukS.js";import"./SidePanelFormButtons.module-BuIu-Bem.js";import"./useGetTags-CnCFjIwc.js";const ue=()=>{const t=M(),i=ie(),{isPending:s,mutateAsync:a}=H({mutationFn:async c=>t.post("security-profiles",c),onSuccess:async()=>i.invalidateQueries({queryKey:["securityProfiles"]})});return{isSecurityProfileAdding:s,addSecurityProfile:a}},qe=(t,i)=>{const s=M(),{data:a,isPending:c,error:l}=he({queryKey:["securityProfile",t],queryFn:async({signal:r})=>s.get("security-profiles",{signal:r}),...i}),o=a?.data.results.find(({id:r})=>r===t);return{securityProfile:o,securityProfileError:a&&!o?new Error("The security profile could not be found."):l,isGettingSecurityProfile:c}},$e=()=>{const t=M(),{isPending:i,mutateAsync:s}=H({mutationFn:async({id:a,...c})=>t.get(`security-profiles/${a}/report`,{params:c})});return{getSecurityProfileReport:s,isSecurityProfileReportLoading:i}},Oe=()=>{const t=M(),i=ie(),{isPending:s,mutateAsync:a}=H({mutationFn:async({id:c,...l})=>t.patch(`security-profiles/${c}`,l),onSuccess:async()=>i.invalidateQueries({queryKey:["securityProfiles"]})});return{isSecurityProfileUpdating:s,updateSecurityProfile:a}},U=[{label:"Sundays",value:"SU"},{label:"Mondays",value:"MO"},{label:"Tuesdays",value:"TU"},{label:"Wednesdays",value:"WE"},{label:"Thursdays",value:"TH"},{label:"Fridays",value:"FR"},{label:"Saturdays",value:"SA"}],ee=[{label:"January",value:1},{label:"February",value:2},{label:"March",value:3},{label:"April",value:4},{label:"May",value:5},{label:"June",value:6},{label:"July",value:7},{label:"August",value:8},{label:"September",value:9},{label:"October",value:10},{label:"November",value:11},{label:"December",value:12}];function Ye(t){const{instancesCount:i,isGettingInstances:s}=Ce({query:t.values.all_computers?void 0:t.values.tags.map(l=>`tag:${l}`).join(" OR "),limit:1}),[a,c]=E.useState(!1);return E.useEffect(()=>{if(i!==void 0){if(!t.values.tags.length&&!t.values.all_computers){c(!1);return}c(i>Z)}},[i]),{isLoading:s,isValid:!a,description:"Associate the security profile. Apply it to all instances or limit it to specific instances using a tag.",content:e.jsxs(e.Fragment,{children:[a&&e.jsxs(d.Notification,{severity:"negative",inline:!0,title:"Associated instances limit reached:",children:["You've reached the limit of"," ",e.jsxs("strong",{children:[Z," associated instances"]}),". Decrease the number of associated instances."]}),e.jsx(Re,{formik:t})]}),submitButtonText:"Next"}}const Me="_description_lcyzv_1",ke="_link_lcyzv_6",te={description:Me,link:ke},A=({className:t,description:i,label:s,link:a})=>e.jsxs(e.Fragment,{children:[e.jsx("p",{className:Q("u-no-margin--bottom",t),children:s}),e.jsxs("small",{className:te.description,children:[i,a&&e.jsx("a",{className:te.link,href:a,target:"_blank",rel:"noreferrer",onClick:c=>{c.stopPropagation()},children:"learn more"})]})]});function Ge(t,i){const s=async c=>{await t.setFieldValue("tailoring_file",c[0])},a=async()=>{await t.setFieldValue("tailoring_file",null)};return{isValid:!t.errors.benchmark&&!t.errors.mode,description:"Select a security profile benchmark, choose the profile mode, and optionally upload a tailoring file to customize the security profile.",content:e.jsxs(e.Fragment,{children:[!i&&e.jsx(d.Notification,{severity:"caution",title:"Changes restricted:",inline:!0,children:"After profile creation, the security profile benchmark and mode cannot be changed. Please review before proceeding."}),e.jsx(d.CustomSelect,{label:"Base profile",disabled:i,options:[{label:e.jsx(A,{className:"u-no-padding--top",label:j.cis_level1_workstation,description:"Center for Internet Security",link:"https://ubuntu.com/security/cis"}),value:"cis_level1_workstation",text:j.cis_level1_workstation},{label:e.jsx(A,{className:"u-no-padding--top",label:j.cis_level1_server,description:"Center for Internet Security",link:"https://ubuntu.com/security/cis"}),value:"cis_level1_server",text:j.cis_level1_server},{label:e.jsx(A,{className:"u-no-padding--top",label:j.cis_level2_workstation,description:"Center for Internet Security",link:"https://ubuntu.com/security/cis"}),value:"cis_level2_workstation",text:j.cis_level2_workstation},{label:e.jsx(A,{className:"u-no-padding--top",label:j.cis_level2_server,description:"Center for Internet Security",link:"https://ubuntu.com/security/cis"}),value:"cis_level2_server",text:j.cis_level2_server},{label:e.jsx(A,{className:"u-no-padding--top",label:j.disa_stig,description:"Defense Information System Agency (DISA) for the U.S. Department of Defense (DoD)",link:"https://ubuntu.com/security/disa-stig"}),value:"disa_stig",text:j.disa_stig}],value:t.values.benchmark??"",onChange:async c=>t.setFieldValue("benchmark",c),required:!0,searchable:"never"}),e.jsx(d.CustomSelect,{label:"Mode",disabled:i,options:[{label:e.jsx(A,{className:"u-no-padding--top",label:D.audit,description:"Generates an audit without applying any fixes or remediation."}),value:"audit",text:D.audit},{label:e.jsx(A,{className:"u-no-padding--top",label:D["audit-fix"],description:"Applies fixes and generates an audit after remediation."}),value:"audit-fix",text:D["audit-fix"]},{label:e.jsx(A,{className:"u-no-padding--top",label:D["audit-fix-restart"],description:`Applies fixes, requires a machine restart, and generates an
                  audit after remediation.`}),value:"audit-fix-restart",text:D["audit-fix-restart"]}],value:t.values.mode??"",onChange:async c=>t.setFieldValue("mode",c),required:!0}),e.jsx(Ee,{label:"Upload tailoring file",disabled:i,accept:".xml",...t.getFieldProps("tailoring_file"),help:e.jsxs(e.Fragment,{children:["Customize your security profile by adjusting or disabling rules to fit your system while staying compliant.",e.jsx("br",{}),"Max file size: 5mb. Supported format: .xml."]}),onFileRemove:a,onFileUpload:s})]}),submitButtonText:"Next"}}const Ve="_body_reuiw_1",ze="_header_reuiw_5",Ue="_description_reuiw_11",He="_line_reuiw_16",Qe="_smallCard_reuiw_23",We="_children_reuiw_29",N={body:Ve,header:ze,description:Ue,line:He,smallCard:Qe,children:We},pe=({cards:t})=>e.jsxs(e.Fragment,{children:[e.jsx("div",{className:N.smallCard,children:"Start"}),e.jsx("div",{className:N.line}),t.map((i,s)=>e.jsxs("div",{children:[e.jsx(d.Card,{className:"u-no-margin--bottom",children:e.jsxs("div",{children:[e.jsxs("div",{className:N.header,children:[e.jsx(d.Icon,{name:i.iconName,className:N.cardIcon}),e.jsx("p",{className:"u-no-margin--bottom u-no-padding--top",children:e.jsx("strong",{children:i.header})})]}),e.jsxs("div",{className:N.body,children:[e.jsx("p",{className:"u-no-margin--bottom u-no-padding--top",children:e.jsx("small",{className:N.description,children:i.description})}),i.children&&e.jsx("div",{className:N.children,children:i.children})]})]})}),e.jsx("div",{className:N.line})]},s)),e.jsx("div",{className:N.smallCard,children:"End"})]});function Ke(t){return{isValid:!0,description:`This will ${le([t.values.mode!="audit"?"apply fixes":null,t.values.mode=="audit-fix-restart"?"restart instances":null,"generate an audit"].filter(i=>i!=null))} on the selected next run date.`,content:e.jsx(pe,{cards:[{header:"Next run date",description:e.jsxs(e.Fragment,{children:["Security profile's next run date arrives",e.jsx("br",{}),g(t.values.start_date).format(`${z}`)]}),iconName:"revisions"},t.values.mode!="audit"?{header:"Apply fixes",description:"Security profile will attempt to apply remediations before the next audit, helping maintain instances' compliance with the security profile.",iconName:"open-terminal"}:null,t.values.mode=="audit-fix-restart"?{header:"Restart instances",description:"To complete the fixes, instances must be restarted.",iconName:"restart",children:e.jsxs(h,{children:[e.jsx(h.Item,{label:"Delivery time",large:!0,value:t.values.delivery_time==="asap"?"As soon as possible":`Delayed by ${t.values.restart_deliver_delay} ${R(t.values.restart_deliver_delay,"hour")}`}),e.jsx(h.Item,{label:"Randomize delivery over a time window",large:!0,value:t.values.randomize_delivery==="yes"?`Yes, over ${t.values.restart_deliver_delay_window} ${R(t.values.restart_deliver_delay_window,"minute")}`:"No"})]})}:null,{header:"Generate an audit",description:"Security profile will generate an audit for all instances associated, aggregated in the audit view to show pass/fail results and allow detailed inspection.",iconName:"file-blank"}].filter(i=>i!=null)}),submitButtonText:"Add"}}function Je(t){const{isSelfHosted:i}=ge(),{getOrganisationPreferences:s}=Le(),{getAccessGroupQuery:a}=ce(),{data:c,isLoading:l}=a(),{data:o,isLoading:r}=s(),p=()=>{const m=o?.data.audit_retention_period;return!m||m===-1?"Infinite":`${m} ${R(m,"day")}`};return{isLoading:l||r,isValid:!t.errors.title,description:"Choose a descriptive title and the right access group for your security profile.",content:e.jsxs(e.Fragment,{children:[e.jsx(d.Input,{type:"text",label:"Title",...t.getFieldProps("title"),error:P(t,"title"),required:!0}),e.jsx(d.Select,{label:"Access group",options:c?.data.map(m=>({label:m.title,value:m.name})),...t.getFieldProps("access_group"),error:P(t,"access_group"),required:!0,disabled:l}),i&&e.jsx(d.Input,{type:"text",label:"Audit retention",required:!0,disabled:!0,value:p(),help:"You can change this limit in the Landscape server configuration file."})]}),submitButtonText:"Next"}}const Ze="_indent_1ojbb_1",Xe={indent:Ze},me=({children:t})=>e.jsx("div",{className:Xe.indent,children:t}),et="_help_japqx_1",tt="_noMargin_japqx_6",se={help:et,noMargin:tt},Y=({field:t,formik:i,inputs:s=[],label:a})=>e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"u-no-margin--bottom",children:a}),e.jsx("div",{children:s.map(({expansion:c,help:l,key:o,...r})=>{const p=i.values[t]==o;return e.jsxs("div",{children:[e.jsx("div",{className:l?se.noMargin:void 0,children:e.jsx(d.RadioInput,{...r,...i.getFieldProps(t),checked:p,onChange:async()=>i.setFieldValue(t,o)})}),l&&e.jsx("p",{className:Q(se.help,"u-no-padding--top u-no-margin--bottom"),children:e.jsx("small",{children:l})}),p&&e.jsx(me,{children:c})]},o)})})]}),st=({formik:{values:t,...i}})=>{switch(t.unit_of_time){case"WEEKLY":return e.jsx(X,{variant:"condensed",label:"On",items:[...U],selectedItems:U.filter(({value:s})=>t.days.includes(s)),onItemsUpdate:async s=>i.setFieldValue("days",s.map(({value:a})=>a)),isSortedAlphabetically:!1,hasSelectedItemsFirst:!1,required:!0});case"MONTHLY":return!!t.start_date&&e.jsx(d.Select,{label:"On",options:Se(new Date(t.start_date)),...i.getFieldProps("day_of_month_type"),required:!0});case"YEARLY":return e.jsx(X,{variant:"condensed",label:"On",items:[...ee],selectedItems:ee.filter(({value:s})=>t.months.includes(s)),onItemsUpdate:async s=>i.setFieldValue("months",s.map(({value:a})=>a)),isSortedAlphabetically:!1,hasSelectedItemsFirst:!1,required:!0});default:return null}},it=({formik:t})=>{const i=g().format(W);switch(t.values.start_type){case"on-a-date":return e.jsx(d.Input,{type:"datetime-local",label:"Date",min:i,...t.getFieldProps("start_date"),error:P(t,"start_date"),required:!0});case"recurring":return e.jsxs(e.Fragment,{children:[e.jsx(d.Input,{type:"datetime-local",label:"Start date",min:i,...t.getFieldProps("start_date"),error:P(t,"start_date"),required:!0}),e.jsxs(d.Row,{className:"u-no-padding",children:[e.jsx(d.Col,{size:6,children:e.jsx(d.Input,{...t.getFieldProps("every"),type:"number",label:"Repeat every",min:t.values.unit_of_time==="DAILY"?7:1,error:P(t,"every"),required:!0})}),e.jsx(d.Col,{size:6,children:e.jsx(d.Select,{label:"Repeat every",options:[{label:"Day",value:"DAILY"},{label:"Week",value:"WEEKLY"},{label:"Month",value:"MONTHLY"},{label:"Year",value:"YEARLY"}].map(s=>t.values.every==1?s:{...s,label:`${s.label}s`}),...t.getFieldProps("unit_of_time"),required:!0})})]}),e.jsx(st,{formik:t}),e.jsx(d.Select,{label:"Ends",options:[{label:"Never",value:"never"},{label:"On a date",value:"on-a-date"}],...t.getFieldProps("end_type"),required:!0}),t.values.end_type=="on-a-date"&&e.jsx(d.Input,{type:"datetime-local",label:"End date",min:t.values.start_date,...t.getFieldProps("end_date"),error:P(t,"end_date"),required:!0})]})}},at=({formik:t})=>e.jsxs(e.Fragment,{children:[e.jsx(d.Select,{label:"Schedule",options:[{label:"Select",value:"",hidden:!0},{label:"On a date",value:"on-a-date"},{label:"Recurring",value:"recurring"}],...t.getFieldProps("start_type"),required:!0}),e.jsx(me,{children:e.jsx(it,{formik:t})})]}),rt="_inputContainer_1k4iz_1",nt="_input_1k4iz_1",lt="_inputDescription_1k4iz_10",T={inputContainer:rt,input:nt,inputDescription:lt};function ot(t){return{isValid:!t.errors.start_type&&!t.errors.start_date&&!t.errors.every&&!t.errors.end_date&&!t.errors.restart_deliver_delay_window&&!t.errors.restart_deliver_delay,description:"Add a schedule for the security profile. Select a specific date or a recurring schedule for continuous audit generation.",content:e.jsxs(e.Fragment,{children:[e.jsx(at,{formik:t}),t.values.mode=="audit-fix-restart"&&e.jsxs(e.Fragment,{children:[e.jsx(A,{label:"Restart schedule",description:"You can choose when to perform the required restart."}),e.jsx(Y,{field:"delivery_time",formik:t,label:"Delivery time",inputs:[{label:"As soon as possible",key:"asap"},{label:"Delayed",key:"delayed",expansion:e.jsxs("div",{className:T.inputContainer,children:[e.jsx(d.Input,{type:"number",required:!0,className:T.input,wrapperClassName:T.inputWrapper,...t.getFieldProps("restart_deliver_delay"),error:P(t,"restart_deliver_delay")}),e.jsx("span",{className:T.inputDescription,children:"hours"})]})}]}),e.jsx(Y,{field:"randomize_delivery",formik:t,label:"Randomize delivery over a time window",inputs:[{label:"No",key:"no"},{label:"Yes",key:"yes",expansion:e.jsxs("div",{className:T.inputContainer,children:[e.jsx(d.Input,{type:"number",required:!0,className:T.input,wrapperClassName:T.inputWrapper,...t.getFieldProps("restart_deliver_delay_window"),error:P(t,"restart_deliver_delay_window")}),e.jsx("span",{className:T.inputDescription,children:"minutes"})]})}]})]})]}),submitButtonText:"Next"}}const _e=({initialValues:t,mutate:i,benchmarkStepDisabled:s,onSuccess:a=()=>{}})=>{const c=K(),{setPageParams:l}=F(),o=ae({initialValues:t,validateOnMount:!0,validationSchema:re().shape({benchmark:B().required("This field is required."),end_date:B().when(["start_date","start_type","end_type"],([n,_,y],S)=>_=="recurring"&&y=="on-a-date"?S.required("This field is required.").test({test:x=>g(x).isAfter(g(n)),message:"The end date must be after the start date."}):S),every:V().when("start_type",([n],_)=>n=="recurring"?_.required("This field is required.").positive("Enter a positive number.").integer("Enter an integer.").when("unit_of_time",([y])=>y==="DAILY"?_.min(7,"Enter an interval of at least 7 days."):_):_),mode:B().required("This field is required."),restart_deliver_delay_window:V().when(["mode","randomize_delivery"],([n,_],y)=>n=="audit-fix-restart"&&_=="yes"?y.required("This field is required.").positive("Enter a positive number.").integer("Enter an integer."):y),restart_deliver_delay:V().when(["mode","delivery_time"],([n,_],y)=>n=="audit-fix-restart"&&_=="delayed"?y.required("This field is required.").positive("Enter a positive number.").integer("Enter an integer."):y),start_date:B().required("This field is required."),title:B().required("This field is required.")}),onSubmit:async n=>{if(!n.benchmark||!n.mode)return;const _=[];if(n.start_type=="recurring"){switch(_.push(`FREQ=${n.unit_of_time}`,`INTERVAL=${n.every}`),n.unit_of_time){case"WEEKLY":{_.push(`BYDAY=${n.days.join(",")}`);break}case"MONTHLY":{const y=new Date(n.start_date),S=y.getDate();switch(n.day_of_month_type){case"day-of-month":{_.push(`BYMONTHDAY=${S}`);break}case"day-of-week":{const x=Math.ceil(S/7);_.push(`BYDAY=${x>4?-1:x}${U[y.getDay()].value}`);break}}break}case"YEARLY":{_.push(`BYMONTH=${n.months.join(",")}`);break}}n.end_type=="on-a-date"&&_.push(`UNTIL=${g(n.end_date).format("YYYYMMDDTHHmmss")}Z`)}else _.push("FREQ=WEEKLY","COUNT=1");try{await i({access_group:n.access_group==ne?void 0:n.access_group,all_computers:n.all_computers||void 0,benchmark:n.benchmark,mode:n.mode,restart_deliver_delay_window:n.mode=="audit-fix-restart"?n.restart_deliver_delay_window:void 0,restart_deliver_delay:n.mode=="audit-fix-restart"?n.restart_deliver_delay:void 0,schedule:_.join(";"),start_date:`${g(n.start_date).format(W)}Z`,tags:n.all_computers?void 0:n.tags,tailoring_file:await n.tailoring_file?.text(),title:n.title})}catch(y){c(y);return}l({sidePath:[],profile:""}),a(n)}}),r=Je(o),p=Ge(o,s),m=ot(o),f=Ye(o),u=Ke(o);return{formik:o,steps:[r,p,m,f,u]}},dt="_step_koqdi_1",ct={step:dt},Ct=({onSuccess:t})=>{const{notify:i}=k(),{setPageParams:s}=F(),{addSecurityProfile:a,isSecurityProfileAdding:c}=ue(),[l,o]=E.useState(0),{formik:r,steps:p}=_e({initialValues:{all_computers:!1,access_group:ne,day_of_month_type:"day-of-month",days:[],delivery_time:"asap",end_date:"",end_type:"never",every:7,months:[],randomize_delivery:"no",restart_deliver_delay_window:1,restart_deliver_delay:1,start_date:g().utc().format(W),start_type:"on-a-date",tags:[],tailoring_file:null,title:"",unit_of_time:"DAILY"},mutate:async u=>{a({access_group:u.access_group,all_computers:u.all_computers,benchmark:u.benchmark,mode:u.mode,restart_deliver_delay:u.restart_deliver_delay,restart_deliver_delay_window:u.restart_deliver_delay_window,schedule:u.schedule,start_date:u.start_date,tags:u.tags,tailoring_file:u.tailoring_file,title:u.title})},onSuccess:u=>{oe(u,i),t(u)}}),m=()=>{o(l-1)},f=()=>{l<p.length-1?o(l+1):r.handleSubmit()};return e.jsxs(e.Fragment,{children:[e.jsxs(b.Header,{children:["Add security profile",e.jsxs("small",{className:Q(ct.step,"u-text--muted"),children:["Step ",l+1," of ",p.length]})]}),e.jsxs(b.Content,{children:[e.jsx("p",{children:p[l].description}),p[l].content,e.jsx(q,{hasBackButton:l>0,onBackButtonPress:l>0?m:void 0,onSubmit:f,submitButtonDisabled:p[l].isLoading||!p[l].isValid||c,submitButtonLoading:p[l].isLoading||c,submitButtonText:p[l].submitButtonText,onCancel:()=>{s({sidePath:[]})}})]})]})},$=()=>{const{profile:t}=F(),{isGettingSecurityProfile:i,securityProfile:s,securityProfileError:a}=qe(parseInt(t));if(a)throw a;return i?{securityProfile:void 0,isGettingSecurityProfile:!0}:{securityProfile:s,isGettingSecurityProfile:!1}},Et=()=>{const{pushSidePath:t}=F(),{getAccessGroupQuery:i}=ce(),{securityProfile:s,isGettingSecurityProfile:a}=$(),c=je(),{data:l,isPending:o}=i(),{value:r,setTrue:p,setFalse:m}=fe();return a||o?e.jsx(b.LoadingState,{}):e.jsxs(e.Fragment,{children:[e.jsx(b.Header,{children:s.title}),e.jsxs(b.Content,{children:[e.jsx("div",{className:"p-segmented-control",children:e.jsxs("div",{className:"p-segmented-control__list",children:[e.jsxs(d.Button,{className:"p-segmented-control__button",type:"button",hasIcon:!0,onClick:()=>{t("download")},children:[e.jsx(d.Icon,{name:"file-blank"}),e.jsx("span",{children:"Download audit"})]}),s.status!=="archived"&&e.jsxs(d.Button,{className:"p-segmented-control__button",type:"button",hasIcon:!0,onClick:()=>{t("edit")},children:[e.jsx(d.Icon,{name:"edit"}),e.jsx("span",{children:"Edit"})]}),s.status!=="archived"&&e.jsxs(d.Button,{className:"p-segmented-control__button",type:"button",hasIcon:!0,onClick:()=>{t("run")},disabled:!s.associated_instances,children:[e.jsx(d.Icon,{name:"play"}),e.jsx("span",{children:"Run"})]}),e.jsxs(d.Button,{className:"p-segmented-control__button",type:"button",hasIcon:!0,onClick:()=>{t("duplicate")},disabled:c,children:[e.jsx(d.Icon,{name:"canvas"}),e.jsx("span",{children:"Duplicate"})]}),s.status!=="archived"&&e.jsxs(d.Button,{className:"p-segmented-control__button",type:"button",hasIcon:!0,onClick:p,children:[e.jsx(d.Icon,{name:"archive"}),e.jsx("span",{children:"Archive"})]})]})}),e.jsxs(L,{children:[e.jsx(L.Item,{children:e.jsxs(h,{children:[e.jsx(h.Item,{label:"Title",value:s.title}),e.jsx(h.Item,{label:"Name",value:s.name}),e.jsx(h.Item,{label:"Access group",value:l?.data.find(f=>f.name==s.access_group)?.title??s.access_group}),e.jsx(h.Item,{label:"Status",value:Pe(s).label})]})}),e.jsx(L.Item,{title:"Security profile",children:e.jsxs(h,{children:[e.jsx(h.Item,{label:"Benchmark",value:j[s.benchmark]}),e.jsx(h.Item,{label:"Tailoring file",value:we(s)}),e.jsx(h.Item,{label:"Mode",large:!0,value:D[s.mode]})]})}),e.jsx(L.Item,{title:"Schedule",children:e.jsxs(h,{children:[e.jsx(h.Item,{label:"Schedule",large:!0,value:Ie(s)}),e.jsx(h.Item,{label:"Last run",value:s.last_run_results.timestamp?`${g(s.last_run_results.timestamp).format(z)} GMT`:null}),e.jsx(h.Item,{label:"Next run",value:s.next_run_time?`${g(s.next_run_time).format(z)} GMT`:null}),s.mode==="audit-fix-restart"&&e.jsx(h.Item,{label:"Restart schedule",large:!0,value:`${s.restart_deliver_delay?`Delayed by ${s.restart_deliver_delay} ${R(s.restart_deliver_delay,"hour")}`:"As soon as possible"}${s.restart_deliver_delay_window?`, randomize delivery over ${s.restart_deliver_delay_window} ${R(s.restart_deliver_delay_window,"minute")}`:""}`})]})}),e.jsx(L.Item,{title:"Association",children:e.jsxs(h,{children:[e.jsx(h.Item,{label:"Associated instances",large:!0,value:e.jsx(Ne,{securityProfile:s})}),e.jsx(h.Item,{label:"Tags",large:!0,value:Ae(s),type:"truncated"})]})})]})]}),e.jsx(Fe,{close:m,opened:r,profile:s})]})},ut="_dateRange_1sfaj_1",pt="_date_1sfaj_1",mt="_separator_1sfaj_9",O={dateRange:ut,date:pt,separator:mt},_t=({securityProfile:t})=>{const i=K(),{sidePath:s,popSidePath:a,setPageParams:c}=F(),{getSingleActivityQuery:l}=xe(),{getSecurityProfileReport:o,isSecurityProfileReportLoading:r}=$e(),p=Te(),[m,f]=E.useState({type:"okay"}),u=JSON.parse(localStorage.getItem("_landscape_pendingSecurityProfileReports")??"[]"),{id:w}=t,n=u.find(v=>v.profileId==w),{data:_,isLoading:y,isError:S}=l({activityId:n?.activityId??0},{enabled:!!n&&m.type=="pending",refetchInterval:1e3});S&&m.type!="error"&&f({type:"error"}),E.useEffect(()=>{_&&(_.data.activity_status=="succeeded"?f({type:"ready",report_uri:_.data.result_text}):f({type:"pending"}))},[_]);const x=ae({initialValues:{audit_timeframe:"specific-date",end_date:g().format(C),start_date:g().format(C),level_of_detail:"summary-only"},validateOnMount:!0,validationSchema:re().shape({end_date:B().when(["audit_timeframe","start_date"],([v,I],J)=>v=="date-range"?J.required("This field is required.").test({test:G=>g(G).isSameOrAfter(g(I)),message:"The end date must not be before the start date."}).test({test:G=>g(G).utc(!0).isSameOrBefore(g()),message:"The end date must not be in the future."}):J),start_date:B().required("This field is required.").test({test:v=>g(v).utc(!0).isSameOrBefore(g()),message:"The date must not be in the future."})}),onSubmit:async v=>{try{const I=(await o({id:w,detailed:v.level_of_detail=="detailed-view"||void 0,end_date:v.end_date,start_date:v.start_date})).data;if(I.activity_status=="succeeded"){f({type:"ready",report_uri:I.result_text});return}f({type:"pending"}),n?n.activityId=I.id:u.push({activityId:I.id,profileId:w}),localStorage.setItem("_landscape_pendingSecurityProfileReports",JSON.stringify(u))}catch(I){i(I);return}}});return y?e.jsx(be,{}):e.jsxs(e.Fragment,{children:[m.type=="pending"&&e.jsx(d.Notification,{inline:!0,title:"Your audit is being generated:",children:"Depending on the size and complexity of the audit, this may take up to 5 minutes."}),m.type=="ready"&&e.jsxs(d.Notification,{inline:!0,title:"Your requested audit is ready:",onDismiss:()=>{const v=u.findIndex(I=>I.profileId==w);f({type:"okay"}),v!=-1&&(u.splice(v,1),u.length?localStorage.setItem("_landscape_pendingSecurityProfileReports",JSON.stringify(u)):localStorage.removeItem("_landscape_pendingSecurityProfileReports"))},children:["It has been successfully generated and is now available for download."," ",e.jsx(d.Button,{appearance:"link",type:"button",className:"u-no-margin--bottom u-no-padding--top",onClick:()=>{p(m.report_uri)},children:"Download audit"})]}),e.jsx("p",{children:"Customize the audit by selecting the scope and the timeframe."}),e.jsx(Y,{label:"Audit timeframe",field:"audit_timeframe",formik:x,inputs:[{key:"specific-date",label:"Specific date",expansion:e.jsx(d.Input,{type:"date",...x.getFieldProps("start_date"),error:P(x,"start_date"),max:g().utc().format(C)})},{key:"date-range",label:"Date range",expansion:e.jsxs("div",{className:O.dateRange,children:[e.jsx("div",{className:O.date,children:e.jsx(d.Input,{type:"date",...x.getFieldProps("start_date"),error:P(x,"start_date"),max:g(x.values.end_date).utc().format(C)})}),e.jsx("span",{className:O.separator,children:"-"}),e.jsx("div",{className:O.date,children:e.jsx(d.Input,{type:"date",...x.getFieldProps("end_date"),error:P(x,"end_date"),max:g().utc().format(C),min:g(x.values.start_date).format(C)})})]})}]}),e.jsx(Y,{label:"Level of detail",field:"level_of_detail",formik:x,inputs:[{key:"summary-only",label:"Summary only",help:"High-level overview of audit results"},{key:"detailed-view",label:"Detailed view",help:"Includes rules ID, severity, identifiers and references, description, rationale"}]}),e.jsx(q,{onSubmit:()=>{x.handleSubmit()},submitButtonDisabled:!x.isValid||r,submitButtonLoading:r,submitButtonText:"Generate CSV",hasBackButton:s.length>1,onBackButtonPress:a,onCancel:()=>{c({sidePath:[],profile:""})}})]})},Lt=()=>{const{securityProfile:t,isGettingSecurityProfile:i}=$();return i?e.jsx(b.LoadingState,{}):e.jsxs(e.Fragment,{children:[e.jsxs(b.Header,{children:["Download audit for ",t.title," security profile"]}),e.jsx(b.Content,{children:e.jsx(_t,{securityProfile:t})})]})},yt="_container_6gega_1",ht={container:yt},ye=({getConfirmationStepDisabled:t=()=>!1,confirmationStepDescription:i,submitButtonText:s="",submitting:a=!1,hasBackButton:c,onBackButtonPress:l,...o})=>{const{setPageParams:r}=F(),{formik:p,steps:m}=_e(o),[f,u]=E.useState(!1),w=()=>{p.handleSubmit()},n=()=>{if(t(p.values)){w();return}u(!0)},_=()=>{u(!1)};if(f){const y=m[m.length-1];return e.jsxs(e.Fragment,{children:[e.jsxs("p",{children:[i," This will"," ",le([p.values.mode!="audit"?"apply fixes":null,p.values.mode=="audit-fix-restart"?"restart instances":null,"generate an audit"].filter(S=>S!=null))," ","on the selected next run date."]}),y.content,e.jsx(q,{hasBackButton:!0,onBackButtonPress:_,onSubmit:w,submitButtonDisabled:!!y.isLoading||a,submitButtonLoading:y.isLoading||a,submitButtonText:s,onCancel:()=>{r({sidePath:[],profile:""})}})]})}return e.jsxs(e.Fragment,{children:[m[0].content,m.slice(1,-1).map((y,S)=>e.jsx("div",{className:ht.container,children:y.content},S)),e.jsx(q,{onSubmit:n,submitButtonDisabled:!p.isValid||a,submitButtonLoading:m.some(y=>y.isLoading)||a,submitButtonText:s,hasBackButton:c,onBackButtonPress:l,onCancel:()=>{r({sidePath:[],profile:""})}})]})},qt=()=>{const{notify:t}=k(),{sidePath:i,popSidePath:s}=F(),{securityProfile:a,isGettingSecurityProfile:c}=$(),{addSecurityProfile:l,isSecurityProfileAdding:o}=ue();return c?e.jsx(b.LoadingState,{}):e.jsxs(e.Fragment,{children:[e.jsxs(b.Header,{children:["Duplicate ",a.title]}),e.jsxs(b.Content,{children:[e.jsx(ye,{confirmationStepDescription:"To duplicate the profile, you need to run it.",initialValues:{...de(a),title:`${a.title} copy`},mutate:async r=>{l({access_group:r.access_group,all_computers:r.all_computers,benchmark:r.benchmark,mode:r.mode,restart_deliver_delay:r.restart_deliver_delay,restart_deliver_delay_window:r.restart_deliver_delay_window,schedule:r.schedule,start_date:r.start_date,tags:r.tags,tailoring_file:r.tailoring_file,title:r.title})},onSuccess:r=>{oe(r,t)},submitButtonText:"Duplicate",submitting:o,hasBackButton:i.length>1,onBackButtonPress:s}),";"]})]})},$t=()=>{const{notify:t}=k(),{sidePath:i,popSidePath:s}=F(),{securityProfile:a,isGettingSecurityProfile:c}=$(),{updateSecurityProfile:l,isSecurityProfileUpdating:o}=Oe();return c?e.jsx(b.LoadingState,{}):e.jsxs(e.Fragment,{children:[e.jsxs(b.Header,{children:["Edit ",a.title]}),e.jsx(b.Content,{children:e.jsx(ye,{benchmarkStepDisabled:!0,confirmationStepDescription:"To save your changes, you need to run the profile.",getConfirmationStepDisabled:r=>r.mode=="audit",initialValues:de(a),mutate:async r=>{l({id:a.id,access_group:r.access_group,all_computers:r.all_computers,restart_deliver_delay:r.restart_deliver_delay,restart_deliver_delay_window:r.restart_deliver_delay_window,schedule:r.schedule,tags:r.tags,title:r.title})},onSuccess:r=>{t.success({title:`You have successfully saved changes for ${r.title} security profile.`,message:"Your changes have been saved successfully."})},submitButtonText:"Save changes",submitting:o,hasBackButton:i.length>1,onBackButtonPress:s})})]})},Ot=()=>{const t=K(),i=ve(),{notify:s}=k(),{sidePath:a,popSidePath:c,setPageParams:l}=F(),{securityProfile:o,isGettingSecurityProfile:r}=$(),{runSecurityProfile:p}=De();if(r)return e.jsx(b.LoadingState,{});const m=async f=>{f.preventDefault();try{const{data:u}=await p({id:o.id});l({sidePath:[],profile:""});const w=Be(o.mode);s.success({title:`You have successfully initiated run of the ${o.title} security profile`,message:w,actions:[{label:"View details",onClick:()=>{i(`/activities?query=parent-id%3A${u.id}`)}}]})}catch(u){t(u)}};return e.jsxs(e.Fragment,{children:[e.jsxs(b.Header,{children:['Run "',o.title,'" profile']}),e.jsx(b.Content,{children:e.jsxs(d.Form,{style:{display:"flex",flexDirection:"column"},onSubmit:m,children:[e.jsx("p",{children:"Running this profile will apply remediation fixes to the associated instances, restart them, and generate an audit. Proceed to execute the run manually."}),e.jsx(pe,{cards:[{header:"Apply fixes",description:"Security profile will attempt to apply remediations before the next audit, helping maintain instances' compliance with the security profile.",iconName:"open-terminal"},{header:"Restart instances",description:"To complete the fixes, instances must be restarted.",iconName:"restart",children:e.jsxs(h,{children:[e.jsx(h.Item,{label:"Delivery time",large:!0,value:o.restart_deliver_delay===0?"As soon as possible":`Delayed by ${o.restart_deliver_delay} ${R(o.restart_deliver_delay,"hour")}`}),e.jsx(h.Item,{label:"Randomize delivery over a time window",large:!0,value:o.restart_deliver_delay_window?`Yes, over ${o.restart_deliver_delay_window} ${R(o.restart_deliver_delay_window,"minute")}`:"No"})]})},{header:"Generate an audit",description:"Security profile will generate an audit for all instances associated, aggregated in the audit view to show pass/fail results and allow detailed inspection.",iconName:"file-blank"}].filter(f=>o.mode.includes("restart")||f.header!=="Restart instances")}),e.jsx(q,{submitButtonDisabled:!1,submitButtonText:"Run",onCancel:()=>{l({sidePath:[],profile:""})},hasBackButton:a.length>1,onBackButtonPress:c})]})})]})};export{kt as ACTIVE_SECURITY_PROFILES_LIMIT,Ut as AddSecurityProfileButton,Z as SECURITY_PROFILE_ASSOCIATED_INSTANCES_LIMIT,Ct as SecurityProfileAddSidePanel,Et as SecurityProfileDetailsSidePanel,Lt as SecurityProfileDownloadAuditSidePanel,qt as SecurityProfileDuplicateSidePanel,$t as SecurityProfileEditSidePanel,ye as SecurityProfileForm,Ot as SecurityProfileRunFixSidePanel,Ht as SecurityProfilesContainer,Qt as SecurityProfilesHeader,Wt as SecurityProfilesList,Gt as useGetOverLimitSecurityProfiles,Vt as useGetSecurityProfiles,je as useIsSecurityProfilesLimitReached,Oe as useUpdateSecurityProfile};
