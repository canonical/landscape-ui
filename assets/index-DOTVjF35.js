import{d as Q,i as Z,k as U,y as W,B as E,j as e,K as f,aS as J,n as i,e as g,aT as X,aN as Y,a as G,p as ee,q as te,s as se,a0 as ne,t as ae,v as B}from"./index-DN_YS9_3.js";import{S as re}from"./SidePanelFormButtons-CeIrPige.js";import{u as oe,T as ie}from"./TagsAddConfirmationModal-BdKrluXr.js";import{u as R}from"./useGetTags-DarKgUFs.js";import{u as ce}from"./useRoles-DoFQPeH6.js";import"./SidePanelFormButtons.module-CcPyiogC.js";import"./ModalTablePagination-CMX1al9b.js";const le=()=>{const t=Q(),a=Z(),{isPending:c,mutateAsync:p}=U({mutationFn:async({instanceId:h,...o})=>t.put(`computers/${h}`,o),onSuccess:async()=>Promise.all([a.invalidateQueries({queryKey:["instances"]}),a.invalidateQueries({queryKey:["instanceTags"]})])});return{editInstance:p,isEditingInstance:c}},ue=W().shape({access_group:E(),comment:E(),title:E()}),de="_infoContainer_1ca11_1",me="_amount_1ca11_9",D={infoContainer:de,amount:me},pe=({isExpanded:t,overflowingChipsAmount:a})=>a>0&&!t&&e.jsx("div",{className:D.infoContainer,children:e.jsx("span",{className:f("u-text--muted",D.amount),children:`+${a}`})}),he=({containerRef:t,onDismiss:a,onOverflowingItemsAmountChange:c,tagData:p})=>{const h=()=>{if(!t.current)return;const o=t.current.querySelectorAll("span.p-chip");c(Array.from(o).filter(({offsetHeight:x,offsetTop:d})=>d>x).length)};return J("resize",h),i.useEffect(()=>{h()},[p.length]),p.map(o=>e.jsx(g.Chip,{value:o,onDismiss:()=>{a(o)}},o))},ge="_container_1f6mu_1",fe="_list_1f6mu_6",xe="_listItem_1f6mu_11",_e="_search_1f6mu_17",T={container:ge,list:fe,listItem:xe,search:_e},je=({onTagClick:t,tags:a})=>a.length?e.jsxs("div",{className:T.container,children:[e.jsx("p",{className:"p-text--small-caps u-text--muted p-text--small",children:"Tags"}),e.jsx("ul",{className:f("p-list--divided u-no-margin--bottom",T.list),children:a.map(c=>e.jsx("li",{children:e.jsx("div",{className:T.listItem,children:e.jsx(g.Button,{type:"button",appearance:"base",className:T.search,onClick:()=>{t(c)},children:c})})},c))})]}):null,Ce="_container_fqj7b_1",be="_prompt_fqj7b_10",ve="_saveButton_fqj7b_17",P={container:Ce,prompt:be,saveButton:ve},ye=({onTagAdd:t,search:a})=>e.jsx(e.Fragment,{children:a&&e.jsxs("div",{className:P.container,children:[e.jsxs("span",{className:P.prompt,children:[e.jsx("span",{children:"Search for "}),e.jsx("span",{className:"p-search-and-filter__search-query",children:a}),e.jsx("span",{children:"..."})]}),e.jsx(g.Button,{type:"button",appearance:"link",onClick:t,className:P.saveButton,children:"Add tag"})]})}),O=E().matches(/^[a-zA-Z]/,{message:"Tag must starts with a letter",excludeEmptyString:!0}).matches(/^[a-zA-Z][a-zA-Z0-9_-]*$/,{message:"Tag can only contain letters, numbers, hyphens, and underscores",excludeEmptyString:!0}),Se="_root_1j0bz_1",Te="_searchContainer_1j0bz_5",Ee="_box_1j0bz_13",Ie="_inputContainer_1j0bz_18",Ne="_inputError_1j0bz_23",we="_input_1j0bz_18",C={root:Se,searchContainer:Te,box:Ee,inputContainer:Ie,inputError:Ne,input:we},Ae=({onTagsChange:t,tags:a,label:c,labelClassName:p,required:h})=>{const[o,x]=i.useState(""),[d,_]=i.useState(""),[I,v]=i.useState(!1),[b,N]=i.useState(""),[r,m]=i.useState(!1),[w,A]=i.useState(0),{height:y}=X(),[F,S]=i.useState({top:"100%",bottom:"auto"}),{tags:s,isGettingTags:j}=R(),k=i.useRef(null),l=i.useRef(null);i.useEffect(()=>{if(!l.current)return;const n=l.current.querySelector("input");n&&N(n.id)},[l.current]);const L=()=>{if(!l.current)return;const{top:n,height:u}=l.current.getBoundingClientRect();n+u+379<y?S({top:"100%",bottom:"auto"}):S({top:"auto",bottom:"100%"})};i.useEffect(()=>{!r||!l.current||L()},[y,r,l.current,l.current?.clientHeight]);const q=()=>{m(!1)};Y(k,q);const M=n=>{t(a.filter(u=>u!==n))},V=i.useMemo(()=>!o&&!a.length?s:s.filter(n=>!a.includes(n)).filter(n=>n.toLowerCase().includes(o.trim().toLowerCase())),[s,o,a]),$=n=>{t([...a,n])},z=()=>{if(o.trim())try{const n=O.validateSync(o.trim())??"";$(n),x(""),_(""),v(!1)}catch(n){n instanceof Error&&(_(n.message),v(!0))}},H=n=>{if(x(n.target.value),I)try{O.validateSync(n.target.value),_("")}catch(u){u instanceof Error&&_(u.message)}},K=n=>{const{key:u}=n;r?(u==="Escape"&&q(),u==="Enter"&&z()):u==="Enter"&&m(!0)};return e.jsxs("div",{className:C.root,children:[e.jsx("label",{className:f("p-form__label",{"is-required":h},p),htmlFor:b,children:c||"Tags"}),e.jsxs("div",{className:"p-search-and-filter",ref:k,children:[e.jsxs("div",{className:f("p-search-and-filter__search-container",C.searchContainer),"aria-expanded":r,ref:l,onClick:()=>{m(!0)},children:[e.jsx(he,{containerRef:l,onDismiss:M,onOverflowingItemsAmountChange:n=>{A(n)},tagData:a}),e.jsx("div",{className:f("p-search-and-filter__box",C.box),children:e.jsx("div",{className:C.inputContainer,children:e.jsx(g.Input,{type:"text",autoComplete:"off",value:o,onChange:H,placeholder:"Add tags",className:f("u-no-margin--bottom",C.input),onClick:()=>{m(!0)},onKeyUp:K,wrapperClassName:d?"is-error":"","aria-errormessage":d?`${b}-error`:void 0,"aria-invalid":!!d})})}),d&&e.jsx("div",{className:"is-error",children:e.jsxs("p",{className:f("p-form-validation__message",C.inputError),id:`${b}-error`,children:[e.jsx("strong",{children:"Error: "}),e.jsx("span",{children:d})]})}),e.jsx(pe,{isExpanded:r,overflowingChipsAmount:w})]}),r&&j&&e.jsx(G,{}),r&&!j&&e.jsxs("div",{className:"p-search-and-filter__panel",style:F,children:[e.jsx(ye,{onTagAdd:z,search:o}),e.jsx(je,{onTagClick:$,tags:V})]})]})]})},Oe=({instance:t})=>{const{closeSidePanel:a}=ee(),c=te(),{notify:p}=se(),{getAccessGroupQuery:h}=ce(),{data:o,isPending:x}=h(),{tags:d,isGettingTags:_}=R(),{editInstance:I}=le(),{value:v,setTrue:b,setFalse:N}=ne(),r=ae({initialValues:{title:t.title,comment:t.comment,access_group:t.access_group,tags:t.tags},onSubmit:async s=>{try{await I({instanceId:t.id,...s}),a(),p.success({title:"Instance updated",message:`Instance "${t.title}" updated successfully`})}catch(j){c(j)}},validationSchema:ue}),m=r.values.tags.filter(s=>!t.tags.includes(s)),{isFetchingProfileChanges:w,refetchProfileChanges:A}=oe({instance_ids:[t.id],tags:m,limit:10},{enabled:!1}),y=async()=>{if(m.length){const s=await A();s.isSuccess?s.data.data.count?b():r.handleSubmit():c(s.error)}else r.handleSubmit()};if(x||_)return e.jsx(G,{});const F=o?.data.map(({name:s,title:j})=>({label:j,value:s}))??[],S=d.map(s=>({label:s,value:s}))??[];return e.jsxs(e.Fragment,{children:[e.jsxs(g.Form,{onSubmit:s=>{s.preventDefault(),y()},className:"l-form",noValidate:!0,children:[e.jsx(g.Input,{label:"Title","aria-label":"Title",type:"text",required:!0,disabled:t.is_wsl_instance,...r.getFieldProps("title"),error:B(r,"title")}),e.jsx(g.Select,{label:"Access group",options:F,...r.getFieldProps("access_group"),error:B(r,"access_group")}),e.jsx(Ae,{onTagsChange:async s=>r.setFieldValue("tags",s),tags:S.filter(({value:s})=>r.values.tags.includes(s)).map(({value:s})=>s)}),e.jsx(g.Textarea,{label:"Comment",rows:3,...r.getFieldProps("comment"),error:B(r,"comment")}),e.jsx(re,{submitButtonLoading:r.isSubmitting||m&&w,submitButtonText:"Save changes"})]}),v&&e.jsx(ie,{instances:[t],tags:m,onConfirm:()=>{r.handleSubmit()},confirmButtonLoading:r.isSubmitting,close:N})]})};export{Oe as default};
