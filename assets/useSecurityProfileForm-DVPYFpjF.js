import{r as N,a5 as I,j as e,m as i,n as R,S as c,s as b,az as C,v as x,D as M,I as A,u as $,aA as B,$ as Y,y as z,l as U,J as V,B as H,F as v,G as S}from"./index-TxmzAx1n.js";import{A as W}from"./AssociationBlock-CF1RjlBK.js";import{u as G}from"./useInstances-lQt7962R.js";import{F as K}from"./FileInput-fWV62KUF.js";import{F as J}from"./Flow-DNamsoLK.js";import{u as Q}from"./useOrgSettings-CXQ-9bFr.js";import{u as Z}from"./useRoles-4zz9Rnmf.js";import{g as _}from"./formikErrors-Bw8iTXYS.js";import{I as X,R as T}from"./RadioGroup-CiEgvHCE.js";import{M as E}from"./MultiSelectField-tC5ft40G.js";const F=[{label:"Sundays",value:"SU"},{label:"Mondays",value:"MO"},{label:"Tuesdays",value:"TU"},{label:"Wednesdays",value:"WE"},{label:"Thursdays",value:"TH"},{label:"Fridays",value:"FR"},{label:"Saturdays",value:"SA"}],q=[{label:"January",value:1},{label:"February",value:2},{label:"March",value:3},{label:"April",value:4},{label:"May",value:5},{label:"June",value:6},{label:"July",value:7},{label:"August",value:8},{label:"September",value:9},{label:"October",value:10},{label:"November",value:11},{label:"December",value:12}];function k(t){const{getInstancesQuery:r}=G(),{data:s,isLoading:d}=r({query:t.values.all_computers?void 0:t.values.tags.map(n=>`tag:${n}`).join(" OR ")}),[o,h]=N.useState(!1);return N.useEffect(()=>{if(s){if(!t.values.tags.length&&!t.values.all_computers){h(!1);return}h(s.data.count>I)}},[s]),{isLoading:d,isValid:!o,description:"Associate the security profile. Apply it to all instances or limit it to specific instances using a tag.",content:e.jsxs(e.Fragment,{children:[o&&e.jsxs(i.Notification,{severity:"negative",inline:!0,title:"Associated instances limit reached:",children:["You've reached the limit of"," ",e.jsxs("strong",{children:[I," associated instances"]}),". Decrease the number of associated instances."]}),e.jsx(W,{formik:t})]}),submitButtonText:"Next"}}const ee="_description_18qzl_1",te="_link_18qzl_6",D={description:ee,link:te},p=({className:t,description:r,label:s,link:d})=>e.jsxs(e.Fragment,{children:[e.jsx("p",{className:R("u-no-margin--bottom",t),children:s}),e.jsxs("small",{className:D.description,children:[r,d&&e.jsx("a",{className:D.link,href:d,target:"_blank",rel:"noreferrer",onClick:o=>{o.stopPropagation()},children:"learn more"})]})]});function ae(t,r){const s=async o=>{await t.setFieldValue("tailoring_file",o[0])},d=async()=>{await t.setFieldValue("tailoring_file",null)};return{isValid:!t.errors.benchmark&&!t.errors.mode,description:"Select a security profile benchmark, choose the profile mode, and optionally upload a tailoring file to customize the security profile.",content:e.jsxs(e.Fragment,{children:[!r&&e.jsx(i.Notification,{severity:"caution",title:"Changes restricted:",inline:!0,children:"After profile creation, the security profile benchmark and mode cannot be changed. Please review before proceeding."}),e.jsx(i.CustomSelect,{label:"Base profile",disabled:r,options:[{label:e.jsx(p,{className:"u-no-padding--top",label:c.cis_level1_workstation,description:"Center for Internet Security",link:"https://ubuntu.com/security/cis"}),value:"cis_level1_workstation",text:c.cis_level1_workstation},{label:e.jsx(p,{className:"u-no-padding--top",label:c.cis_level1_server,description:"Center for Internet Security",link:"https://ubuntu.com/security/cis"}),value:"cis_level1_server",text:c.cis_level1_server},{label:e.jsx(p,{className:"u-no-padding--top",label:c.cis_level2_workstation,description:"Center for Internet Security",link:"https://ubuntu.com/security/cis"}),value:"cis_level2_workstation",text:c.cis_level2_workstation},{label:e.jsx(p,{className:"u-no-padding--top",label:c.cis_level2_server,description:"Center for Internet Security",link:"https://ubuntu.com/security/cis"}),value:"cis_level2_server",text:c.cis_level2_server},{label:e.jsx(p,{className:"u-no-padding--top",label:c.disa_stig,description:"Defense Information System Agency (DISA) for the U.S. Department of Defense (DoD)",link:"https://ubuntu.com/security/disa-stig"}),value:"disa_stig",text:c.disa_stig}],value:t.values.benchmark??"",onChange:async o=>t.setFieldValue("benchmark",o),required:!0,searchable:"never"}),e.jsx(i.CustomSelect,{label:"Mode",disabled:r,options:[{label:e.jsx(p,{className:"u-no-padding--top",label:b.audit,description:"Generates an audit without applying any fixes or remediation."}),value:"audit",text:b.audit},{label:e.jsx(p,{className:"u-no-padding--top",label:b["audit-fix"],description:"Applies fixes and generates an audit after remediation."}),value:"audit-fix",text:b["audit-fix"]},{label:e.jsx(p,{className:"u-no-padding--top",label:b["audit-fix-restart"],description:`Applies fixes, requires a machine restart, and generates an
                  audit after remediation.`}),value:"audit-fix-restart",text:b["audit-fix-restart"]}],value:t.values.mode??"",onChange:async o=>t.setFieldValue("mode",o),required:!0}),e.jsx(K,{label:"Upload tailoring file",disabled:r,accept:".xml",...t.getFieldProps("tailoring_file"),help:e.jsxs(e.Fragment,{children:["Customize your security profile by adjusting or disabling rules to fit your system while staying compliant.",e.jsx("br",{}),"Max file size: 5mb. Supported format: .xml."]}),onFileRemove:d,onFileUpload:s})]}),submitButtonText:"Next"}}function re(t){return{isValid:!0,description:`This will ${C([t.values.mode!="audit"?"apply fixes":null,t.values.mode=="audit-fix-restart"?"restart instances":null,"generate an audit"].filter(r=>r!=null))} on the selected next run date.`,content:e.jsx(J,{cards:[{header:"Next run date",description:e.jsxs(e.Fragment,{children:["Security profile's next run date arrives",e.jsx("br",{}),x(t.values.start_date).format(`${M}`)]}),iconName:"revisions"},t.values.mode!="audit"?{header:"Apply fixes",description:"Security profile will attempt to apply remediations before the next audit, helping maintain instances' compliance with the security profile.",iconName:"open-terminal"}:null,t.values.mode=="audit-fix-restart"?{header:"Restart instances",description:"To complete the fixes, instances must be restarted.",iconName:"restart",children:e.jsxs(e.Fragment,{children:[e.jsx(i.Row,{className:"u-no-padding",children:e.jsx(A,{label:"Delivery time",value:t.values.delivery_time=="asap"?"As soon as possible":"Scheduled"})}),e.jsx(i.Row,{className:"u-no-padding",children:e.jsx(A,{label:"Randomize delivery over a time window",value:t.values.randomize_delivery?"Yes":"No"})})]})}:null,{header:"Generate an audit",description:"Security profile will generate an audit for all instances associated, aggregated in the audit view to show pass/fail results and allow detailed inspection.",iconName:"file-blank"}].filter(r=>r!=null)}),submitButtonText:"Add"}}function se(t){const{isSelfHosted:r}=$(),{getOrganisationPreferences:s}=Q(),{getAccessGroupQuery:d}=Z(),{data:o,isLoading:h}=d(),{data:n,isLoading:j}=s();return{isLoading:h||j,isValid:!t.errors.title,description:"Choose a descriptive profile name and the right access group for your security profile.",content:e.jsxs(e.Fragment,{children:[e.jsx(i.Input,{type:"text",label:"Profile name",...t.getFieldProps("title"),error:_(t,"title"),required:!0}),e.jsx(i.Select,{label:"Access group",options:o==null?void 0:o.data.map(g=>({label:g.title,value:g.name})),...t.getFieldProps("access_group"),error:_(t,"access_group"),required:!0,disabled:h}),r&&e.jsx(i.Input,{type:"text",label:"Audit retention",required:!0,disabled:!0,value:(n==null?void 0:n.data.audit_retention_period)==-1?"Infinite":`${n==null?void 0:n.data.audit_retention_period} day${(n==null?void 0:n.data.audit_retention_period)==1?"":"s"}`,help:"You can change this limit in the Landscape server configuration file."})]}),submitButtonText:"Next"}}const ie=({formik:{values:t,...r}})=>{switch(t.unit_of_time){case"WEEKLY":return e.jsx(E,{variant:"condensed",label:"On",items:[...F],selectedItems:F.filter(({value:s})=>t.days.includes(s)),onItemsUpdate:async s=>r.setFieldValue("days",s.map(({value:d})=>d)),scrollOverflow:!0,required:!0});case"MONTHLY":return!!t.start_date&&e.jsx(i.Select,{label:"On",options:B(new Date(t.start_date)),...r.getFieldProps("day_of_month_type"),required:!0});case"YEARLY":return e.jsx(E,{variant:"condensed",label:"On",items:[...q],selectedItems:q.filter(({value:s})=>t.months.includes(s)),onItemsUpdate:async s=>r.setFieldValue("months",s.map(({value:d})=>d)),scrollOverflow:!0,required:!0})}},ne=({formik:t})=>{const r=x().format(Y);switch(t.values.start_type){case"on-a-date":return e.jsx(i.Input,{type:"datetime-local",label:"Date",min:r,...t.getFieldProps("start_date"),error:_(t,"start_date"),required:!0});case"recurring":return e.jsxs(e.Fragment,{children:[e.jsx(i.Input,{type:"datetime-local",label:"Start date",min:r,...t.getFieldProps("start_date"),error:_(t,"start_date"),required:!0}),e.jsxs(i.Row,{className:"u-no-padding",children:[e.jsx(i.Col,{size:6,children:e.jsx(i.Input,{...t.getFieldProps("every"),type:"number",label:"Repeat every",min:1,error:_(t,"every"),required:!0})}),e.jsx(i.Col,{size:6,children:e.jsx(i.Select,{label:"Repeat every",options:[{label:"Day",value:"DAILY"},{label:"Week",value:"WEEKLY"},{label:"Month",value:"MONTHLY"},{label:"Year",value:"YEARLY"}].map(s=>t.values.every==1?s:{...s,label:`${s.label}s`}),...t.getFieldProps("unit_of_time"),required:!0})})]}),e.jsx(ie,{formik:t}),e.jsx(i.Select,{label:"Ends",options:[{label:"Never",value:"never"},{label:"On a date",value:"on-a-date"}],...t.getFieldProps("end_type"),required:!0}),t.values.end_type=="on-a-date"&&e.jsx(i.Input,{type:"datetime-local",label:"End date",min:t.values.start_date,...t.getFieldProps("end_date"),error:_(t,"end_date"),required:!0})]})}},le=({formik:t})=>e.jsxs(e.Fragment,{children:[e.jsx(i.Select,{label:"Schedule",options:[{label:"Select",value:"",hidden:!0},{label:"On a date",value:"on-a-date"},{label:"Recurring",value:"recurring"}],...t.getFieldProps("start_type"),required:!0}),e.jsx(X,{children:e.jsx(ne,{formik:t})})]}),oe="_inputContainer_1k4iz_1",de="_input_1k4iz_1",ue="_inputDescription_1k4iz_10",m={inputContainer:oe,input:de,inputDescription:ue};function ce(t){return{isValid:!t.errors.start_type&&!t.errors.start_date&&!t.errors.every&&!t.errors.end_date&&!t.errors.restart_deliver_delay_window&&!t.errors.restart_deliver_delay,description:"Add a schedule for the security profile. Select a specific date or a recurring schedule for continuous audit generation.",content:e.jsxs(e.Fragment,{children:[e.jsx(le,{formik:t}),t.values.mode=="audit-fix-restart"&&e.jsxs(e.Fragment,{children:[e.jsx(p,{label:"Restart schedule",description:"You can choose when to perform the required restart."}),e.jsx(T,{field:"delivery_time",formik:t,label:"Delivery time",inputs:[{label:"As soon as possible",key:"asap"},{label:"Delayed",key:"delayed",expansion:e.jsxs("div",{className:m.inputContainer,children:[e.jsx(i.Input,{type:"number",required:!0,className:m.input,wrapperClassName:m.inputWrapper,...t.getFieldProps("restart_deliver_delay"),error:_(t,"restart_deliver_delay")}),e.jsx("span",{className:m.inputDescription,children:"hours"})]})}]}),e.jsx(T,{field:"randomize_delivery",formik:t,label:"Randomize delivery over a time window",inputs:[{label:"No",key:"no"},{label:"Yes",key:"yes",expansion:e.jsxs("div",{className:m.inputContainer,children:[e.jsx(i.Input,{type:"number",required:!0,className:m.input,wrapperClassName:m.inputWrapper,...t.getFieldProps("restart_deliver_delay_window"),error:_(t,"restart_deliver_delay_window")}),e.jsx("span",{className:m.inputDescription,children:"minutes"})]})}]})]})]}),submitButtonText:"Next"}}const Se=({initialValues:t,mutate:r,benchmarkStepDisabled:s,onSuccess:d=()=>{}})=>{const o=z(),{closeSidePanel:h}=U(),n=V({initialValues:t,validateOnMount:!0,validationSchema:H().shape({benchmark:v().required("This field is required."),end_date:v().when(["start_date","start_type","end_type"],([a,l,u],y)=>l=="recurring"&&u=="on-a-date"?y.required("This field is required.").test({test:f=>x(f).isAfter(x(a)),message:"The end date must be after the start date."}):y),every:S().when("start_type",([a],l)=>a=="recurring"?l.required("This field is required.").positive("Enter a positive number.").integer("Enter an integer."):l),mode:v().required("This field is required."),restart_deliver_delay_window:S().when(["mode","randomize_delivery"],([a,l],u)=>a=="audit-fix-restart"&&l=="yes"?u.required("This field is required.").positive("Enter a positive number.").integer("Enter an integer."):u),restart_deliver_delay:S().when(["mode","delivery_time"],([a,l],u)=>a=="audit-fix-restart"&&l=="delayed"?u.required("This field is required.").positive("Enter a positive number.").integer("Enter an integer."):u),start_date:v().required("This field is required."),start_type:v().required("This field is required."),title:v().required("This field is required.")}),onSubmit:async a=>{var u;if(!a.benchmark||!a.mode)return;const l=[];if(a.start_type=="recurring"){switch(l.push(`FREQ=${a.unit_of_time}`,`INTERVAL=${a.every}`),a.unit_of_time){case"WEEKLY":{l.push(`BYDAY=${a.days.join(",")}`);break}case"MONTHLY":{const y=new Date(a.start_date),f=y.getDate();switch(a.day_of_month_type){case"day-of-month":{l.push(`BYMONTHDAY=${f}`);break}case"day-of-week":{const w=Math.ceil(f/7);l.push(`BYDAY=${w>4?-1:w}${F[y.getDay()].value}`);break}}break}case"YEARLY":{l.push(`BYMONTH=${a.months.join(",")}`);break}}a.end_type=="on-a-date"&&l.push(`UNTIL=${x(a.end_date).format("YYYYMMDDTHHmmss")}Z`)}else l.push("FREQ=WEEKLY","COUNT=1");try{await r({access_group:a.access_group=="global"?void 0:a.access_group,all_computers:a.all_computers||void 0,benchmark:a.benchmark,mode:a.mode,restart_deliver_delay_window:a.mode=="audit-fix-restart"?a.restart_deliver_delay_window:void 0,restart_deliver_delay:a.mode=="audit-fix-restart"?a.restart_deliver_delay:void 0,schedule:l.join(";"),start_date:`${x(a.start_date).format(Y)}Z`,tags:a.all_computers?void 0:a.tags,tailoring_file:await((u=a.tailoring_file)==null?void 0:u.text()),title:a.title})}catch(y){o(y);return}h(),d(a)}}),j=se(n),g=ae(n,s),L=ce(n),O=k(n),P=re(n);return{formik:n,steps:[j,g,L,O,P]}};export{Se as u};
