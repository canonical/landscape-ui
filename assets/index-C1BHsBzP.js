import{r as p,j as c,d as j,e as y,G as U}from"./index-CNSDWj8Q.js";import{a as F}from"./useUsns-dCIdMk13.js";import{S as k,E as R}from"./SelectAllButton-DqKWLeLb.js";import"./constants-CDnVvJTb.js";import"./InstancesPageActions-DL7_pmR1.js";import"./index-D-YBZSy_.js";import"./NoData-6ZK9sV5u.js";import"./TablePagination-CFXNvqsZ.js";import"./TableFilterChips-06YfpJdc.js";import"./useFetchOld-BAAs34Op.js";import"./PageParamFilter-ChSwlZqZ.js";import"./TableFilter-2AKF5NjJ.js";import"./formikErrors-Bw8iTXYS.js";import"./ResponsiveTable-BXalKviy.js";import"./ListTitle-BUruUKn1.js";import"./StaticLink-BEYCGcPv.js";import"./TruncatedCell-BMum6DLZ.js";import"./Truncated-Dtg97i8C.js";import"./useExpandableRow-B4jhRgod.js";import"./index-CySvbr4l.js";import"./TextConfirmationModal-q88mH05g.js";import"./InfoGrid-3w5mqARw.js";import"./InfoItem-Bt7JBIPo.js";import"./ExpandableTableFooter-DEy5-E1E.js";const x=(e,t)=>{const r=new Set(t.computers.map(n=>n.id));return e.some(({exclude_packages:n,id:s})=>r.has(s)&&!n.includes(t.id))},N=(e,t,r)=>{const n=new Set(t.computers.map(({id:s})=>s));return e.map(({id:s,exclude_packages:o})=>{if(!n.has(s))return{id:s,exclude_packages:o};const u=o.filter(a=>a!==t.id);return{id:s,exclude_packages:r?[...u,t.id]:u}})},M=(e,t)=>N(e,t,x(e,t)),E=e=>({column:t,row:r})=>{const n={};return e&&r.index===0?t.id==="checkbox"?n.colSpan=4:(n.style=n.style||{},n.style.display="none",n["aria-hidden"]=!0):t.id==="checkbox"?n["aria-label"]=`Toggle ${r.original.name} instance`:t.id==="title"?n.role="rowheader":t.id==="current_version"?n["aria-label"]="Current version":t.id==="available_version"&&(n["aria-label"]="New version"),n},z=(e,t,r)=>!e.find(({id:n})=>n===t)?.exclude_packages.includes(r),L=(e,t,r)=>e.map(({id:n,exclude_packages:s})=>n!==t?{id:n,exclude_packages:s}:{id:n,exclude_packages:s.includes(r)?s.filter(o=>o!==o):[...s,r]}),D=({excludePackages:e,instances:t,limit:r,pkg:n})=>{const s=new Set(n.computers.map(({id:l})=>l)),o=t.filter(({id:l})=>s.has(l)).slice(0,r),u=new Set(e.filter(({exclude_packages:l})=>l.includes(n.id)).map(({id:l})=>l)),a=o.filter(({id:l})=>!u.has(l)).length;return a===0?"unchecked":a===o.length?"checked":"indeterminate"},Q=(e,t)=>{const r=new Set(t.computers.map(({id:n})=>n));return e.filter(({exclude_packages:n,id:s})=>r.has(s)&&!n.includes(t.id)).length},$=(e,t)=>N(e,t,!1),G=({currentPackage:e,excludedPackages:t,limit:r,onExcludedPackagesChange:n,onLimitChange:s,selectedInstances:o})=>{const u=new Set(e.computers.map(({id:m})=>m)),a=t.filter(({exclude_packages:m})=>m.includes(e.id)),l=p.useMemo(()=>{const m=new Set(o.slice(0,r).map(({id:d})=>d));return a.some(({id:d})=>!m.has(d))},[a.length,o.length,r]),w=p.useMemo(()=>[...o.slice(0,l?1:0),...o.filter(({id:m})=>u.has(m)).slice(0,r)],[u,r,o,l]),g=()=>{n(M(t,e))},b=m=>{n(L(t,m,e.id))},f=()=>{n($(t,e))},C=D({excludePackages:t,instances:o,limit:r,pkg:e}),S=p.useMemo(()=>[{accessor:"checkbox",className:"checkbox-column",Header:c.jsx(j.CheckboxInput,{inline:!0,label:c.jsx("span",{className:"u-off-screen",children:"Toggle all instances"}),checked:C==="checked",indeterminate:C==="indeterminate",onChange:g}),Cell:({row:{index:m,original:d}})=>l&&m===0?c.jsx(k,{count:Q(t,e),itemName:{plural:"instances",singular:"instance"},onClick:f,totalCount:u.size}):c.jsx(j.CheckboxInput,{inline:!0,label:c.jsxs("span",{className:"u-off-screen",children:["Toggle ",d.title," instance"]}),checked:z(t,d.id,e.id),onChange:()=>{b(d.id)}})},{accessor:"title",Header:"Name"},{accessor:"current_version",Header:"Current version",Cell:({row:{original:m}})=>c.jsx(c.Fragment,{children:e.computers.find(({id:d})=>d===m.id)?.current_version})},{accessor:"available_version",Header:"New version",Cell:({row:{original:m}})=>c.jsx(c.Fragment,{children:e.computers.find(({id:d})=>d===m.id)?.available_version})}],[e,t,w]);return c.jsx(R,{columns:S,data:w,getCellProps:E(l),itemNames:{plural:"instances",singular:"instance"},onLimitChange:s,totalCount:u.size,title:c.jsxs("p",{className:"p-heading--4",children:["Instances affected by ",c.jsx("b",{children:e.name})]})})},v={name:"",computers:[],summary:"",id:-1},O="_nameColumn_1u6wc_7",V="_expanded_1u6wc_11",K="_expandButton_1u6wc_29",P="_hidden_1u6wc_38",Y="_innerTable_1u6wc_42",J="_row_1u6wc_46",_={nameColumn:O,expanded:V,expandButton:K,hidden:P,innerTable:Y,row:J},W=({expandedRow:e,isPackagesLoading:t,lastPackageIndex:r,showSelectAllButton:n})=>({column:s,row:{index:o,original:u}})=>{const a={};return n&&o===0||t&&o===r||e>-1&&e===o-1?s.id==="name"?(a.colSpan=3,e>-1&&e===o-1&&(a.className=_.innerTable)):(a.className=_.hidden,a["aria-hidden"]=!0):s.id==="checkbox"?a["aria-label"]=`Toggle ${u.name} package`:s.id==="name"?a.role="rowheader":s.id==="version"?a["aria-label"]="Current version":s.id==="new_version"?a["aria-label"]="New version":s.id==="computers.upgrades"&&(a["aria-label"]="Affected instances",a.className=e===o?_.expanded:_.row),a},X=(e,t)=>t.some(r=>x(e,r)),Z=(e,t)=>t.length>0&&t.every(({computers:r,id:n})=>e.filter(({id:s})=>r.some(o=>o.id===s)).every(({exclude_packages:s})=>!s.includes(n))),ee=(e,t,r)=>t.reduce((n,s)=>N(n,s,r),e),te=({expandedRow:e,isPackagesLoading:t,packages:r,showSelectAllButton:n})=>{const s=e>-1?e+1:0;return[...[v].slice(n?0:1),...r.slice(0,s||r.length),...r.slice(s?s-1:r.length),...[v].slice(t?0:1)]},A=(e,t)=>{const r=new Set(t.computers.map(({id:n})=>n));return e.every(({exclude_packages:n,id:s})=>!r.has(s)||!n.includes(t.id))},ne=({excludedPackages:e,hasNoMoreItems:t,instances:r,isPackagesLoading:n,onExcludedPackagesChange:s,onTableLimitChange:o,packages:u,totalPackageCount:a})=>{const[l,w]=p.useState(-1),[g,b]=p.useState(5),f=new Set(e.flatMap(({exclude_packages:i})=>i)),C=p.useMemo(()=>{const i=new Set(u.map(({id:h})=>h));for(const h of f)if(!i.has(h))return!0;return!1},[u.length,f]),S=p.useMemo(()=>te({expandedRow:l,isPackagesLoading:n,packages:u,showSelectAllButton:C}),[u,l,n,C]),m=X(e,u),d=()=>{s(ee(e,u,m))},q=i=>{s(M(e,i))},B=i=>{b(5),w(h=>h===i?-1:i>h&&h!==-1?i-1:i)},T=Z(e,u),H=p.useMemo(()=>[{accessor:"checkbox",className:"checkbox-column",Header:c.jsx(j.CheckboxInput,{inline:!0,label:c.jsx("span",{className:"u-off-screen",children:"Toggle all packages"}),disabled:S.length===0,checked:T,indeterminate:!T&&m,onChange:d}),Cell:({row:{original:i}})=>c.jsx(j.CheckboxInput,{inline:!0,label:c.jsxs("span",{className:"u-off-screen",children:["Toggle ",i.name," package"]}),checked:A(e,i),indeterminate:!A(e,i)&&x(e,i),onChange:()=>{q(i)}})},{accessor:"name",className:_.nameColumn,Header:"Package name",Cell:({row:{index:i,original:h}})=>C&&i===0?c.jsx(k,{count:a-f.size,itemName:{plural:"packages",singular:"package"},onClick:()=>{s(e.map(({id:I})=>({id:I,exclude_packages:[]})))},totalCount:a}):l!==-1&&l===i-1?c.jsx(G,{currentPackage:h,excludedPackages:e,limit:g,onExcludedPackagesChange:s,onLimitChange:()=>{b(I=>I+5)},selectedInstances:r}):n&&i===S.length-1?c.jsx(y,{}):h.name},{accessor:"computers.upgrades",Header:"Affected instances",Cell:({row:{index:i,original:h}})=>c.jsx(j.Button,{type:"button",className:U("p-accordion__tab",_.expandButton),"aria-expanded":l===i,onClick:()=>{B(i)},children:new Set(h.computers.map(({id:I})=>I)).size})}],[S,r,e,l,n,g]);return c.jsx(R,{columns:H,data:S,itemCount:u.length,hasNoMoreItems:t,getCellProps:W({expandedRow:l,isPackagesLoading:n,lastPackageIndex:S.length-1,showSelectAllButton:C}),itemNames:{plural:"packages",singular:"package"},onLimitChange:o,totalCount:a})},ve=({excludedPackages:e,instances:t,onExcludedPackagesChange:r})=>{const[n,s]=p.useState([]),[o,u]=p.useState(0),a=p.useRef(0),l=p.useRef(-1),{getPackagesQuery:w}=F(),{data:g,isLoading:b}=w({query:`id:${t.map(({id:f})=>f).join(" OR id:")}`,upgrade:!0,limit:5,offset:o});return p.useEffect(()=>{!g||o===l.current||(a.current=g.data.count,l.current=o,s(f=>[...f,...g.data.results]))},[g]),b&&!n.length?c.jsx(y,{}):c.jsx(ne,{excludedPackages:e,hasNoMoreItems:g?.data.next===null,instances:t,isPackagesLoading:b,onExcludedPackagesChange:r,onTableLimitChange:()=>{u(f=>f+5)},packages:n,totalPackageCount:a.current})};export{ve as default};
