import{i as w,g as F,y as D,V as N,r as b,A as T,C as E,v as i,G as j,a5 as l,j as e,o as O,m as u}from"./index-2fzpjuii.js";import{R as I}from"./RadioGroup-J9y92R_h.js";import{S as B}from"./SidePanelFormButtons-DAl7F5tV.js";import{g as S}from"./formikErrors-Bw8iTXYS.js";import{u as L}from"./useSecurityProfileDownloadAudit-CIhOAci0.js";import"./SidePanelFormButtons.module-D2P5PizG.js";const q=()=>{const o=w(),{isPending:f,mutateAsync:y}=F({mutationFn:async({id:g,..._})=>o.get(`security-profiles/${g}/report`,{params:_})});return{getSecurityProfileReport:y,isSecurityProfileReportLoading:f}},G="_dateRange_1sfaj_1",C="_date_1sfaj_1",V="_separator_1sfaj_9",m={dateRange:G,date:C,separator:V},H=({profileId:o,hasBackButton:f,onBackButtonPress:y})=>{const g=D(),{getSingleActivityQuery:_}=N(),{getSecurityProfileReport:R,isSecurityProfileReportLoading:v}=q(),P=L(),[c,n]=b.useState({type:"okay"}),s=JSON.parse(localStorage.getItem("_landscape_pendingSecurityProfileReports")??"[]"),d=s.find(a=>a.profileId==o),{data:p,isLoading:A,isError:k}=_({activityId:(d==null?void 0:d.activityId)??0},{enabled:!!d&&c.type=="pending",refetchInterval:1e3});k&&c.type!="error"&&n({type:"error"}),b.useEffect(()=>{p&&(p.data.activity_status=="succeeded"?n({type:"ready",report_uri:p.data.result_text}):n({type:"pending"}))},[p]);const t=T({initialValues:{audit_timeframe:"specific-date",end_date:i().format(l),start_date:i().format(l),level_of_detail:"summary-only"},validateOnMount:!0,validationSchema:E().shape({end_date:j().when(["audit_timeframe","start_date"],([a,r],x)=>a=="date-range"?x.required("This field is required.").test({test:h=>i(h).isSameOrAfter(i(r)),message:"The end date must not be before the start date."}).test({test:h=>i(h).utc(!0).isSameOrBefore(i()),message:"The end date must not be in the future."}):x),start_date:j().required("This field is required.").test({test:a=>i(a).utc(!0).isSameOrBefore(i()),message:"The date must not be in the future."})}),onSubmit:async a=>{try{const r=(await R({id:o,detailed:a.level_of_detail=="detailed-view"||void 0,end_date:a.end_date,start_date:a.start_date})).data;if(r.activity_status=="succeeded"){n({type:"ready",report_uri:r.result_text});return}n({type:"pending"}),d?d.activityId=r.id:s.push({activityId:r.id,profileId:o}),localStorage.setItem("_landscape_pendingSecurityProfileReports",JSON.stringify(s))}catch(r){g(r);return}}});return A?e.jsx(O,{}):e.jsxs(e.Fragment,{children:[c.type=="pending"&&e.jsx(u.Notification,{inline:!0,title:"Your audit is being generated:",children:"Depending on the size and complexity of the audit, this may take up to 5 minutes."}),c.type=="ready"&&e.jsxs(u.Notification,{inline:!0,title:"Your requested audit is ready:",onDismiss:()=>{const a=s.findIndex(r=>r.profileId==o);n({type:"okay"}),a!=-1&&(s.splice(a,1),s.length?localStorage.setItem("_landscape_pendingSecurityProfileReports",JSON.stringify(s)):localStorage.removeItem("_landscape_pendingSecurityProfileReports"))},children:["It has been successfully generated and is now available for download."," ",e.jsx(u.Button,{appearance:"link",type:"button",className:"u-no-margin--bottom u-no-padding--top",onClick:()=>{P(c.report_uri)},children:"Download audit"})]}),e.jsx("p",{children:"Customize the audit by selecting the scope and the timeframe."}),e.jsx(I,{label:"Audit timeframe",field:"audit_timeframe",formik:t,inputs:[{key:"specific-date",label:"Specific date",expansion:e.jsx(u.Input,{type:"date",...t.getFieldProps("start_date"),error:S(t,"start_date"),max:i().utc().format(l)})},{key:"date-range",label:"Date range",expansion:e.jsxs("div",{className:m.dateRange,children:[e.jsx("div",{className:m.date,children:e.jsx(u.Input,{type:"date",...t.getFieldProps("start_date"),error:S(t,"start_date"),max:i(t.values.end_date).utc().format(l)})}),e.jsx("span",{className:m.separator,children:"-"}),e.jsx("div",{className:m.date,children:e.jsx(u.Input,{type:"date",...t.getFieldProps("end_date"),error:S(t,"end_date"),max:i().utc().format(l),min:i(t.values.start_date).format(l)})})]})}]}),e.jsx(I,{label:"Level of detail",field:"level_of_detail",formik:t,inputs:[{key:"summary-only",label:"Summary only",help:"High-level overview of audit results"},{key:"detailed-view",label:"Detailed view",help:"Includes rules ID, severity, identifiers and references, description, rationale"}]}),e.jsx(B,{onSubmit:()=>{t.handleSubmit()},submitButtonDisabled:!t.isValid||v,submitButtonLoading:v,submitButtonText:"Generate CSV",hasBackButton:f,onBackButtonPress:y})]})};export{H as default};
