import{b as P,e as K,c as x,d as T,p as Q,q as W,r as A,s as L,h as $,t as H,k as z,j as e,g as c,B as R,x as k,m as V,I as _,n as B}from"./index-DclVhhmy.js";import{P as U,a as Y,b as G}from"./PageMain-BkNv1XRT.js";import{d as J,s as j}from"./constants-Cm4xeet5.js";import"./usePageParams-SH8h85Vf.js";import{b as F}from"./output-C-v9YuU8.js";import{u as O}from"./useFetchOld-jhWToNPA.js";import{M as X}from"./MultiSelectField-TXS6ntsL.js";import{u as Z}from"./useInstances-C8zJiNI2.js";import"./NoData-CNaQCMLs.js";import"./index-DzPCcXFi.js";import"./TablePagination-CYCmz9Ae.js";import"./TablePaginationBase-KhYyVat7.js";import"./StatusFilter-B-voT8N1.js";import"./TableFilter-Bqvzf4yv.js";import"./TableFilterChips-DGnB8Azr.js";try{let s=typeof window<"u"?window:typeof global<"u"?global:typeof globalThis<"u"?globalThis:typeof self<"u"?self:{},a=new s.Error().stack;a&&(s._sentryDebugIds=s._sentryDebugIds||{},s._sentryDebugIds[a]="9ffcc139-2653-4bc7-95b8-00fcb0093cc4",s._sentryDebugIdIdentifier="sentry-dbid-9ffcc139-2653-4bc7-95b8-00fcb0093cc4")}catch{}function S(){const s=P(),a=K(),l=O(),i=()=>T({queryKey:["alert"],queryFn:()=>a.get("alerts")}),o=x({mutationKey:["alert","subscribe"],mutationFn:r=>l.get("SubscribeToAlert",{params:r}),onSuccess:()=>s.invalidateQueries({queryKey:["alert"]})}),p=x({mutationKey:["alert","unsubscribe"],mutationFn:r=>l.get("UnsubscribeFromAlert",{params:r}),onSuccess:()=>s.invalidateQueries({queryKey:["alert"]})}),u=x({mutationKey:["alert","associate"],mutationFn:r=>l.get("AssociateAlert",{params:r}),onSuccess:()=>s.invalidateQueries({queryKey:["alert"]})}),d=x({mutationKey:["alert","disassociate"],mutationFn:r=>l.get("DisassociateAlert",{params:r}),onSuccess:()=>s.invalidateQueries({queryKey:["alert"]})});return{getAlertsQuery:i,subscribeQuery:o,unsubscribeQuery:p,associateAlert:u,disassociateAlert:d}}const ee="_footer_122x2_1",se="_multiSelect_122x2_7",I={footer:ee,multiSelect:se},E=(s,a)=>{const l=new Set(a);return s.filter(i=>!l.has(i))},M=({alert:s,availableTagOptions:a})=>{const l=Q(),{notify:i}=W(),{associateAlert:o,disassociateAlert:p}=S(),u=A.useRef(null),{mutateAsync:d}=o,{mutateAsync:r}=p,g=s.all_computers?["All"]:s.tags,C=async({tags:n})=>{try{const m=E(s.tags,n),b=E(n,s.tags),N=n.includes("All"),D=s.all_computers&&!N;if(N)await d({name:s.alert_type,tags:void 0,all_computers:!0});else if(D)await Promise.all([d({name:s.alert_type,tags:n.filter(y=>y!=="All"),all_computers:!1}),r({name:s.alert_type,all_computers:!0})]);else{const y=[];b.length>0&&y.push(d({name:s.alert_type,tags:b,all_computers:!1})),m.length>0&&y.push(r({name:s.alert_type,tags:m,all_computers:!1})),await Promise.all(y)}i.success({title:"Alert tags updated",message:`You changed ${s.label}'s tags`})}catch(m){l(m)}},t=L({initialValues:{tags:g},validationSchema:$().shape({tags:H().of(z())}),onSubmit:C}),f=t.values.tags.includes("All")?a.filter(({value:n})=>n!=="All"):void 0,v=t.values.tags.includes("All")?a:a.filter(({value:n})=>t.values.tags.includes(n)),q=n=>{const m=n.some(({value:b})=>b==="All")?["All"]:n.map(({value:b})=>b);t.setValues({tags:m})};A.useEffect(()=>{var m,b;const n=(m=u.current)==null?void 0:m.querySelector(".multi-select__condensed-text");(b=n==null?void 0:n.textContent)!=null&&b.includes("All instances")&&(n.textContent="All instances")},[t.values.tags]);const w=()=>t.isSubmitting?!0:g.length===t.values.tags.length&&g.every(n=>t.values.tags.includes(n));return e.jsx(c.Form,{onSubmit:t.handleSubmit,noValidate:!0,children:e.jsx(X,{innerRef:u,required:!0,variant:"condensed",className:I.multiSelect,items:a,selectedItems:v,disabledItems:f,onItemsUpdate:q,placeholder:"Select tags",error:t.touched.tags&&typeof t.errors.tags=="string"?t.errors.tags:void 0,dropdownFooter:e.jsxs("div",{className:I.footer,children:[e.jsx(c.Button,{type:"button",dense:!0,small:!0,className:"u-no-margin--bottom",disabled:w(),onClick:()=>t.setFieldValue("tags",g),children:"Revert"}),e.jsx(c.Button,{type:"submit",dense:!0,small:!0,appearance:"positive",className:"u-no-margin--bottom",disabled:w(),children:"Save changes"})]})})})},te="_noWrap_6cam7_19",ae="_alertsWrapper_6cam7_23",le="_emailColumn_6cam7_31",ne="_nameColumn_6cam7_35",re="_tags_6cam7_39",h={switch:"_switch_6cam7_1",noWrap:te,alertsWrapper:ae,emailColumn:le,nameColumn:ne,tags:re},ie=s=>{const a={};switch(s.column.id){case"label":a.role="rowheader";break;case"subscribed":a["aria-label"]="Email";break;case"tags":a["aria-label"]="Tags";break;case"description":a["aria-label"]="Description";break}return a},ce=({alerts:s,availableTagOptions:a})=>{const l=R("(min-width: 620px)"),i=Q(),{unsubscribeQuery:o,subscribeQuery:p}=S(),{user:u}=k(),{mutateAsync:d}=p,{mutateAsync:r}=o,g=async t=>{const f=t.subscribed?r:d;try{await f({alert_type:t.alert_type})}catch(v){i(v)}},C=A.useMemo(()=>[{accessor:"label",className:h.nameColumn,Header:"Name"},{Header:e.jsxs("div",{className:h.noWrap,children:[e.jsx("span",{children:"Email "}),u&&e.jsx(c.Tooltip,{position:"btm-left",message:`Enabling email notifications will send alerts to ${u.email}, associated with your account`,children:e.jsx(c.Icon,{name:"help"})})]}),accessor:"subscribed",className:h.emailColumn,Cell:({row:t})=>e.jsx("div",{className:h.switch,children:e.jsx(c.Switch,{label:F(t.original.subscribed),defaultChecked:t.original.subscribed,onChange:()=>g(t.original)})})},{accessor:"tags",Header:"Enabled for",className:h.tags,Cell:({row:{original:t}})=>e.jsx(M,{alert:t,availableTagOptions:a})},{Header:"Description",accessor:"description",Cell:({row:{original:t}})=>e.jsx(e.Fragment,{children:t.description})}],[s]);return l?e.jsx(c.ModularTable,{columns:C,data:s,getCellProps:ie,emptyMsg:"No data available"}):s.map((t,f)=>e.jsxs(c.Row,{className:V("u-no-padding--left u-no-padding--right",h.alertsWrapper),children:[e.jsx(c.Col,{size:2,small:2,children:e.jsx(_,{label:"Name",value:t.label})}),e.jsx(c.Col,{size:2,small:2,children:e.jsx(_,{label:"Email",value:e.jsx("div",{className:h.switch,children:e.jsx(c.Switch,{label:F(t.subscribed),defaultChecked:t.subscribed,onChange:()=>g(t)})})})}),e.jsx(c.Col,{size:2,small:2,children:e.jsx(_,{label:"Enabled for",value:e.jsx(M,{alert:t,availableTagOptions:a})})}),e.jsx(c.Col,{size:2,small:2,children:e.jsx(_,{label:"Description",value:t.description})})]},f))},oe=({alerts:s,availableTagOptions:a})=>{const{user:l}=k(),i=l==null?void 0:l.accounts.find(o=>o.name===l.current_account);return e.jsx("div",{className:J.item,children:e.jsxs("div",{className:j.card,children:[e.jsx("div",{className:j.header,children:e.jsx("p",{className:j.title,children:(i==null?void 0:i.title)||"Alerts"})}),e.jsx("div",{className:j.content,children:e.jsx(ce,{alerts:s,availableTagOptions:a})})]})})},Se=()=>{const{getAlertsQuery:s}=S(),{getAllInstanceTagsQuery:a}=Z(),{data:l}=a(),{data:i,isLoading:o}=s(),p=A.useMemo(()=>(i==null?void 0:i.data.filter(r=>!r.alert_type.toUpperCase().includes("LICENSE")))??[],[i]),u=(l==null?void 0:l.data.results.map(r=>({label:r,value:r,group:"Tags"})))??[],d=[{label:"All instances",value:"All"},...u];return e.jsxs(U,{children:[e.jsx(Y,{title:"Alerts"}),e.jsxs(G,{children:[o&&e.jsx(B,{}),!o&&p&&e.jsx(oe,{alerts:p,availableTagOptions:d})]})]})};export{Se as default};
