import{b as A,g as B,h as G,v as L,I as E,y as x,w as D,x as w,aN as z,aO as H,aP as Q,a5 as Y,o as $,k as S,p as k,q as U,s as v,j as e,aQ as V,d as l,F as j,a8 as _,i as K,Z as W,M as P,K as f,z as X,N as Z}from"./index-u3-RAyfG.js";import{A as J}from"./AssociationBlock-fsM2pgDT.js";import{M as ee}from"./MultiSelectField-CDc9Ngoy.js";import{S as te}from"./SidePanelFormButtons-DQWWEfaM.js";import{u as O}from"./useRoles-aTSChSCW.js";import{T as oe}from"./TextConfirmationModal-Ia9Wzkzd.js";import{u as ie,R as re}from"./index-CpdaROQL.js";import{a as Qe,b as Ye,c as Ue}from"./index-CpdaROQL.js";import"./useGetTags-xCWOoIoo.js";import"./SidePanelFormButtons.module-BuIu-Bem.js";import"./PageMain-CdSZokyu.js";import"./HeaderWithSearch-DuxVyN2q.js";import"./constants-CBW_8zE3.js";function se(){const t=A(),i=B(),n=G({mutationKey:["rebootprofiles","create"],mutationFn:async u=>t.post("rebootprofiles",u),onSuccess:async()=>i.invalidateQueries({queryKey:["rebootprofiles"]})}),{mutateAsync:a,isPending:d}=n;return{createRebootProfile:a,isCreatingRebootProfile:d}}function ne(){const t=A(),i=B(),n=G({mutationKey:["rebootprofiles","edit"],mutationFn:async({id:u,...p})=>t.patch(`rebootprofiles/${u}`,p),onSuccess:async()=>i.invalidateQueries({queryKey:["rebootprofiles"]})}),{mutateAsync:a,isPending:d}=n;return{editRebootProfile:a,isEditingRebootProfile:d}}const T={add:"added",edit:"updated",duplicate:"added"},ae={add:"Add reboot profile",duplicate:"Add reboot profile",edit:"Save changes"},M=[{label:"Sunday",order:0,value:"su"},{label:"Monday",order:1,value:"mo"},{label:"Tuesday",order:2,value:"tu"},{label:"Wednesday",order:3,value:"we"},{label:"Thursday",order:4,value:"th"},{label:"Friday",order:5,value:"fr"},{label:"Saturday",order:6,value:"sa"}],le=`If Landscape cannot reboot the
associated instances by this point,
the reboot will be canceled.`,q=t=>{const i=new Map(t.split(";").map(p=>{const[h,g]=p.split("=");return[h.toUpperCase(),g]})),n=i.get("FREQ")?.toLowerCase()??"",a=parseInt(i.get("BYHOUR")??"",10),d=parseInt(i.get("BYMINUTE")??"",10),u=(i.get("BYDAY")??"").split(",").map(p=>p.toLowerCase());return{freq:n,at_hour:a,at_minute:d,on_days:u}},de=t=>L().shape({title:w().test({name:"required",message:"This field is required.",test:i=>!!i||t!=="add"}),access_group:w(),all_computers:D(),at_hour:x().required("Hour is required.").integer("Hour must be an integer.").min(0,"Hour must be between 0 and 23.").max(Q,"Hour must be between 0 and 23."),at_minute:x().required("Minute is required.").integer("Minute must be an integer.").min(0,"Minute must be between 0 and 59.").max(H,"Minute must be between 0 and 59."),randomize_delivery:D(),deliver_delay_window:x().when("randomize_delivery",{is:!0,then:i=>i.required("This field is required.").integer("This field must be an integer.").max(z,"Deliver delay window in minutes must be a number less than or equal to 30 days (43200 minutes)").test((n,{createError:a,parent:d})=>n<parseInt(d.deliver_within)*60||a({message:`Deliver delay window of '${n}' minutes should be shorter than the 'deliver within' expiration time of ${d.deliver_within} ${d.deliver_within==="1"?"hour":"hours"}.`})).min(0,"Deliver delay window must be at least 0.")}),deliver_within:x().integer("'Expires after' must be an integer.").min(0,"'Expires after' must be at least 0."),tags:E().of(w()),on_days:E().of(w()).min(1,"At least one day must be selected.")}),ce=t=>{if(t.action==="add")return{title:"",access_group:Y,all_computers:!1,randomize_delivery:!1,deliver_delay_window:"",tags:[],at_hour:"",at_minute:"",deliver_within:0,on_days:[]};const{at_hour:i,at_minute:n,on_days:a}=q(t.profile.schedule);return{title:t.action==="duplicate"?`${t.profile.title} (copy)`:t.profile.title,access_group:t.profile.access_group,all_computers:t.profile.all_computers,randomize_delivery:!!t.profile.deliver_delay_window,deliver_delay_window:t.profile.deliver_delay_window.toString()||"",tags:t.profile.tags,at_hour:i,at_minute:n,deliver_within:t.profile.deliver_within,on_days:a}},ue="_container_gex1r_1",me="_radioGroup_gex1r_7",pe="_timeContainer_gex1r_13",_e="_time_gex1r_13",he="_timeInput_gex1r_27",be="_inputDescriptionAfter_gex1r_32",fe="_colon_gex1r_37",ge="_tooltip_gex1r_43",ye="_expiration_gex1r_47",xe="_windowInputContainer_gex1r_54",we="_windowInput_gex1r_54",ve="_windowInputDescription_gex1r_63",m={container:ue,radioGroup:me,timeContainer:pe,time:_e,timeInput:he,inputDescriptionAfter:be,colon:fe,tooltip:ge,expiration:ye,windowInputContainer:xe,windowInput:we,windowInputDescription:ve},C=t=>{const{getAccessGroupQuery:i}=O(),n=$(),{sidePath:a,popSidePath:d,setPageParams:u}=S(),{notify:p}=k(),{data:h}=i(),{createRebootProfile:g,isCreatingRebootProfile:s}=se(),{editRebootProfile:I,isEditingRebootProfile:R}=ne(),N=h?.data.map(({name:r,title:b})=>({label:b,value:r}))??[],y=()=>{u({sidePath:[],profile:""})},o=U({initialValues:ce(t),enableReinitialize:!0,onSubmit:async r=>{try{t.action==="edit"?await I({id:t.profile.id,access_group:r.access_group,at_hour:Number(r.at_hour),at_minute:Number(r.at_minute),deliver_delay_window:r.randomize_delivery?Number(r.deliver_delay_window):0,deliver_within:Number(r.deliver_delay_window),on_days:r.on_days,title:r.title,tags:r.tags,every:"week",all_computers:r.all_computers}):await g({title:r.title,tags:r.tags,access_group:r.access_group,on_days:r.on_days,every:"week",at_hour:Number(r.at_hour),at_minute:Number(r.at_minute),deliver_delay_window:r.randomize_delivery?Number(r.deliver_delay_window):0,deliver_within:Number(r.deliver_within),all_computers:r.all_computers}),y(),p.success({message:`Reboot profile "${r.title}" has been ${T[t.action]} `,title:`Reboot profile ${T[t.action]}`})}catch(b){n(b)}},validationSchema:de(t.action)}),c=[v(o,"at_hour"),v(o,"at_minute"),v(o,"deliver_within")];return e.jsx(V,{value:o,children:e.jsxs(l.Form,{onSubmit:o.handleSubmit,noValidate:!0,children:[e.jsx(l.Input,{type:"text",label:"Title",required:t.action==="add",...o.getFieldProps("title"),error:o.touched.title&&o.errors.title}),e.jsx(l.Select,{label:"Access group","aria-label":"Access group",options:N,...o.getFieldProps("access_group"),error:v(o,"access_group")}),e.jsxs("div",{className:m.container,children:[e.jsx("p",{className:"p-heading--5",children:"Schedule"}),e.jsx(ee,{variant:"condensed",label:"Days",items:M,selectedItems:M.filter(({value:r})=>o.values.on_days.includes(r)),onItemsUpdate:async r=>o.setFieldValue("on_days",r.map(({value:b})=>b)),isSortedAlphabetically:!1,hasSelectedItemsFirst:!1,error:o.touched.on_days&&typeof o.errors.on_days=="string"?o.errors.on_days:void 0}),e.jsxs("div",{className:m.timeContainer,children:[e.jsxs("div",{className:m.time,children:[e.jsxs(e.Fragment,{children:[e.jsx(l.Input,{type:"number",label:"Time","aria-label":"at hour",placeholder:"HH",className:m.timeInput,wrapperClassName:j({"is-error":c[0]}),...o.getFieldProps("at_hour"),"aria-errormessage":c[0]?"hour-error":void 0}),e.jsx("span",{className:m.colon,children:":"})]}),e.jsx(l.Input,{type:"number",label:"At minute",labelClassName:"u-off-screen","aria-label":"at minute",className:m.timeInput,wrapperClassName:j({"is-error":c[1]}),placeholder:"MM",...o.getFieldProps("at_minute"),"aria-errormessage":c[1]?"minute-error":void 0}),e.jsx(l.Input,{type:"number",label:e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"Expires after "}),e.jsx(l.Tooltip,{message:le,position:"top-right",tooltipClassName:m.tooltip,children:e.jsx(l.Icon,{name:"help"})})]}),wrapperClassName:j(m.expiration,{"is-error":c[2]}),className:m.timeInput,...o.getFieldProps("deliver_within"),"aria-errormessage":"expires-error"}),e.jsx("span",{className:m.inputDescriptionAfter,children:"hours"})]}),c.filter(Boolean).length>0&&e.jsxs("div",{className:j({"is-error":c.filter(Boolean).length>0}),children:[c[0]&&e.jsx("p",{className:"p-form-validation__message",id:"hour-error",children:e.jsx("span",{children:c[0]})}),c[1]&&e.jsx("p",{className:"p-form-validation__message",id:"minute-error",children:e.jsx("span",{children:c[1]})}),c[2]&&e.jsxs("p",{className:"p-form-validation__message",id:"expires-error",children:[e.jsx("strong",{children:"Error: "}),e.jsx("span",{children:c[2]})]})]})]}),e.jsx("p",{children:"Randomise delivery over a time window"}),e.jsxs("div",{className:m.radioGroup,children:[e.jsx(l.RadioInput,{label:"No",...o.getFieldProps("randomize_delivery"),checked:!o.values.randomize_delivery,onChange:async()=>{await o.setFieldValue("randomize_delivery",!1),await o.setFieldValue("deliver_delay_window","")}}),e.jsx(l.RadioInput,{label:"Yes",...o.getFieldProps("randomize_delivery"),checked:o.values.randomize_delivery,onChange:async()=>o.setFieldValue("randomize_delivery",!0)})]}),o.values.randomize_delivery&&e.jsxs("div",{className:m.windowInputContainer,children:[e.jsx(l.Input,{type:"number",inputMode:"numeric",min:0,label:"Deliver delay window",labelClassName:"u-off-screen",className:m.windowInput,...o.getFieldProps("deliver_delay_window"),error:o.touched.deliver_delay_window&&o.errors.deliver_delay_window?o.errors.deliver_delay_window:void 0}),e.jsx("span",{className:m.windowInputDescription,children:"minutes"})]})]}),e.jsx(J,{formik:o}),e.jsx(te,{submitButtonText:ae[t.action],submitButtonDisabled:o.isSubmitting||s||R,onCancel:y,hasBackButton:a.length>1,onBackButtonPress:d})]})})},ke=()=>e.jsxs(e.Fragment,{children:[e.jsx(_.Header,{children:"Add reboot profile"}),e.jsx(_.Content,{children:e.jsx(C,{action:"add"})})]});function je(t,i={}){const n=A(),{data:a,isPending:d,error:u}=K({queryKey:["rebootprofile",t.id],queryFn:async({signal:h})=>n.get("rebootprofiles",{signal:h}),...i}),p=a?.data.results.find(({id:h})=>h===t.id);return{rebootProfile:p,rebootProfileError:a&&!p?new Error("The reboot profile could not be found."):u,isGettingRebootProfile:d}}const F=()=>{const{profile:t}=S(),{isGettingRebootProfile:i,rebootProfile:n,rebootProfileError:a}=je({id:parseInt(t)});if(a)throw a;return i?{rebootProfile:void 0,isGettingRebootProfile:!0}:{rebootProfile:n,isGettingRebootProfile:!1}},Pe={mo:"Monday",tu:"Tuesday",we:"Wednesday",th:"Thursday",fr:"Friday",sa:"Saturday",su:"Sunday"},Ie=t=>t.length===2?`${t[0]} and ${t[1]}`:t.length>2?`${t.slice(0,-1).join(", ")}, and ${t[t.length-1]}`:t[0]??"",Re=t=>{const{freq:i,on_days:n}=q(t.schedule);if(i!=="weekly"||!n.length)return"One-time";const a=n.map(u=>Pe[u.toLowerCase()]);return`Every week on ${Ie(a)}`},Oe=()=>{const{value:t,setFalse:i,setTrue:n}=W(),a=$(),{notify:d}=k(),{pushSidePath:u,setPageParams:p}=S(),{removeRebootProfile:h,isRemovingRebootProfile:g}=ie(),{rebootProfile:s,isGettingRebootProfile:I}=F(),{getAccessGroupQuery:R}=O(),{data:N,isPending:y}=R();if(I||y)return e.jsx(_.LoadingState,{});const o=async()=>{try{await h({id:s.id}),p({sidePath:[],profile:""}),d.success({title:"Reboot profile removed",message:`Reboot profile ${s.title} has been removed`})}catch(b){a(b)}finally{i()}},c=()=>{u("edit")},r=()=>{u("duplicate")};return e.jsxs(e.Fragment,{children:[e.jsx(_.Header,{children:s.title}),e.jsxs(_.Content,{children:[e.jsxs("div",{className:"p-segmented-control",children:[e.jsxs(l.Button,{type:"button",hasIcon:!0,className:"p-segmented-control__button",onClick:c,"aria-label":`Edit reboot profile ${s.title}`,children:[e.jsx(l.Icon,{name:"edit"}),e.jsx("span",{children:"Edit"})]}),e.jsxs(l.Button,{type:"button",hasIcon:!0,className:"p-segmented-control__button",onClick:r,"aria-label":`Edit reboot profile ${s.title}`,children:[e.jsx(l.Icon,{name:"canvas"}),e.jsx("span",{children:"Duplicate"})]}),e.jsxs(l.Button,{className:"p-segmented-control__button has-icon",type:"button",hasIcon:!0,onClick:n,"aria-label":`Remove reboot profile ${s.title}`,children:[e.jsx(l.Icon,{name:l.ICONS.delete}),e.jsx("span",{children:"Remove"})]})]}),e.jsxs(P,{children:[e.jsx(P.Item,{children:e.jsxs(f,{children:[e.jsx(f.Item,{label:"Title",value:s.title}),e.jsx(f.Item,{label:"Access group",value:N?.data.find(b=>b.name===s.access_group)?.title??s.access_group})]})}),e.jsx(P.Item,{title:"Reboot schedule",children:e.jsxs(f,{children:[e.jsx(f.Item,{label:"Schedule",large:!0,value:Re(s)}),e.jsx(f.Item,{label:"Next reboot",large:!0,value:X(s.next_run).format(Z)})]})}),e.jsxs(P.Item,{title:"Association",children:[s.all_computers&&e.jsx("p",{children:"This profile has been associated with all instances."}),!s.all_computers&&!s.tags.length&&e.jsx("p",{children:"This profile has not yet been associated with any instances."}),(s.all_computers||!!s.tags.length)&&e.jsxs(f,{children:[!s.all_computers&&e.jsx(f.Item,{label:"Tags",large:!0,value:s.tags.join(", ")||null,type:"truncated"}),e.jsx(f.Item,{label:"Associated instances",large:!0,value:e.jsx(re,{rebootProfile:s})})]})]})]})]}),e.jsx(oe,{isOpen:t,title:"Remove reboot profile",confirmButtonLabel:"Remove",confirmButtonAppearance:"negative",onConfirm:o,confirmButtonDisabled:g,confirmButtonLoading:g,close:i,confirmationText:`remove ${s.title}`,children:e.jsxs("p",{children:['Are you sure you want to remove "',s.title,'" reboot profile? The removal of "',s.title,'" reboot profile is irreversible and might adversely affect your system.']})})]})},qe=()=>{const{rebootProfile:t,isGettingRebootProfile:i}=F();return i?e.jsx(_.LoadingState,{}):e.jsxs(e.Fragment,{children:[e.jsxs(_.Header,{children:["Duplicate ",t.title]}),e.jsx(_.Content,{children:e.jsx(C,{action:"duplicate",profile:t})})]})},Le=()=>{const{rebootProfile:t,isGettingRebootProfile:i}=F();return i?e.jsx(_.LoadingState,{}):e.jsxs(e.Fragment,{children:[e.jsxs(_.Header,{children:["Edit ",t.title]}),e.jsxs(_.Content,{children:[e.jsx(C,{action:"edit",profile:t}),";"]})]})};export{ke as RebootProfileAddSidePanel,Oe as RebootProfileDetailsSidePanel,qe as RebootProfileDuplicateSidePanel,Le as RebootProfileEditSidePanel,Qe as RebootProfilesContainer,C as RebootProfilesForm,Ye as RebootProfilesHeader,Ue as RebootProfilesList};
