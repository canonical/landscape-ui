import{d as W,i as L,k as q,l as Y,a7 as X,y as M,N as G,z as O,ar as Z,B as x,q as B,m as w,s as $,t as D,j as e,ad as b,e as l,v as p,a1 as A,P as C,I as g,a5 as J,aF as ee,n as F,av as te,D as se,S as ie,R as ae,aG as ne,w as le,Q as oe,ay as re,K as ce,a as ue,aC as de}from"./index-DjXnPsWV.js";import{W as pe,a as me,b as ge,c as fe}from"./index-CLbAAb5o.js";import{d as Pt,e as jt,f as yt,u as _t,g as St}from"./index-CLbAAb5o.js";import{d as U}from"./WslInstancesEmptyState-hoU8xM6a.js";import{e as Ft,u as Ct}from"./WslInstancesEmptyState-hoU8xM6a.js";import{A as V}from"./AssociationBlock-C0vwxd2z.js";import{C as he}from"./CodeEditor-CAs7k84y.js";import{F as xe}from"./FileInput-DC295WUk.js";import{S as Q}from"./SidePanelFormButtons-oHcEekp6.js";import{u as H}from"./useGetWslInstanceTypes-Dx8envRF.js";import{u as N}from"./useRoles-1YhtLlUX.js";import"./index-D_HXFdwE.js";import{S as be}from"./SidePanelTableFilterChips-ujydKm91.js";import{L as Ie}from"./constants-CFW2eS4m.js";import{u as Pe}from"./useGetInstances-vcp3nVXo.js";import{u as je}from"./useSelection-CVh2fQGL.js";import"./PageMain-Decu-NBe.js";import"./useGetWslLimits-Bgo8OzPe.js";import"./HeaderWithSearch-DByF44RZ.js";import"./constants-C4CwXN4Z.js";import"./TextConfirmationModal-DZDP6pzd.js";import"./table-CdFwMAPu.js";import"./GroupFilter-BVlUEjp5.js";import"./MultiSelectField-kUmoIU02.js";import"./useGetTags-1g_ZPp3M.js";import"./SidePanelFormButtons.module-CcPyiogC.js";const ye=()=>{const t=W(),i=L(),{isPending:s,mutateAsync:o}=q({mutationFn:async u=>t.post("child-instance-profiles",u),onSuccess:async()=>i.invalidateQueries({queryKey:["wslProfiles"]})});return{isAddingWslProfile:s,addWslProfile:o}},_e=()=>{const t=W(),i=L(),{isPending:s,mutateAsync:o}=q({mutationFn:async({name:u,...f})=>t.patch(`child-instance-profiles/${u}`,f),onSuccess:async()=>i.invalidateQueries({queryKey:["wslProfiles"]})});return{editWslProfile:o,isEditingWslProfile:s}},Se=({profile_name:t},i={})=>{const s=W(),{data:o,isPending:u,error:f}=Y({queryKey:["wslProfile",t],queryFn:async({signal:I})=>s.get(`child-instance-profiles/${t}`,{signal:I}),...i});return{wslProfile:o?.data,wslProfileError:f,isGettingWslProfile:u}},Te=1,z=[{label:"Select",value:""},{label:"From a file",value:"file"},{label:"Plain text",value:"text"}],Fe="You can use a cloud-init configuration YAML file under 1MB to register new WSL instances. Cloud-init streamlines the setup by automating installation and configuration tasks.",Ce=[/^ubuntu$/,/^ubuntu-preview$/,/^ubuntu-[0-9]{2}\.[0-9]{2}$/],we={title:"",access_group:X,description:"",instanceType:"",customImageName:"",rootfsImage:"",cloudInitType:"",cloudInit:null,all_computers:!1,tags:[]},K=t=>{const i=new Blob([t],{type:"application/x-yaml"});return new File([i],"myFile.yaml",{type:"application/x-yaml"})},Re=()=>M().shape({title:x().required("This field is required"),access_group:x().required("This field is required"),description:x().required("This field is required"),instanceType:x().required("This field is required"),rootfsImage:x().when("instanceType",{is:"custom",then:t=>t.required("This field is required"),otherwise:t=>t.notRequired()}),customImageName:x().when("instanceType",{is:"custom",then:t=>t.required("This field is required").test("not-match-reserved-patterns","Instance name cannot match 'ubuntu', 'ubuntu-preview', or 'ubuntu-<dd>.<dd>'",i=>!Ce.some(s=>s.test(i.toLowerCase()))),otherwise:t=>t.notRequired()}),cloudInitType:x(),cloudInit:Z().nullable().when("cloudInitType",{is:t=>t==="file"||t==="text",then:t=>t.required("This field is required").test("file-size","File size must be less than 1MB",i=>(typeof i=="string"&&(i=K(i)),i?i.size===void 0?!1:i.size<=Te*1024*1024:!0)),otherwise:t=>t.notRequired()}),all_computers:O(),tags:G().of(x())}),ve=t=>{if(t)return new Promise((i,s)=>{const o=new FileReader;o.readAsDataURL(t),o.onload=()=>{i(o.result)},o.onerror=u=>{s(u)}})},We=async t=>{if(t===null)return;let i;typeof t=="string"?i=K(t):i=t;const s=await ve(i);return s?s.split(",")[1]:void 0},Ae="_block_tz139_1",Ne={block:Ae},gt=()=>{const t=B(),{setPageParams:i}=w(),{notify:s}=$(),{getAccessGroupQuery:o}=N(),{addWslProfile:u}=ye(),{data:f}=o(),{isGettingWslInstanceTypes:I,wslInstanceTypes:P}=H(),j=P.map(({label:n,name:d})=>({label:n,value:d}))||[],y=[{label:"Select",value:""},...j,{label:"From URL",value:"custom"}],m=f?.data.map(({name:n,title:d})=>({label:d,value:n}))??[],_=()=>{i({sidePath:[]})},a=D({initialValues:we,onSubmit:async n=>{try{const d=await We(n.cloudInit),c=(await u({title:n.title,access_group:n.access_group,description:n.description,image_name:n.instanceType==="custom"?n.customImageName:n.instanceType,image_source:n.rootfsImage,cloud_init_contents:d,all_computers:n.all_computers,tags:n.tags})).data.computers.constrained.length;_(),s.success({title:`Profile "${n.title}" added successfully`,message:`It has been associated with ${c} instances`})}catch(d){t(d)}},validationSchema:Re()}),T=async n=>{await a.setFieldValue("cloudInit",n[0])},r=async()=>{await a.setFieldValue("cloudInit",null)};return e.jsxs(e.Fragment,{children:[e.jsx(b.Header,{children:"Add WSL profile"}),e.jsx(b.Content,{children:e.jsxs(l.Form,{onSubmit:a.handleSubmit,noValidate:!0,children:[e.jsx(l.Input,{type:"text",label:"Title",required:!0,...a.getFieldProps("title"),error:p(a,"title")}),e.jsx(l.Input,{type:"text",label:"Description",required:!0,...a.getFieldProps("description"),error:p(a,"description")}),e.jsx(l.Select,{label:"Access group","aria-label":"Access group",required:!0,options:m,...a.getFieldProps("access_group"),error:p(a,"access_group")}),e.jsxs("div",{className:Ne.block,children:[(a.values.instanceType!==""||a.values.cloudInitType!=="")&&e.jsx(l.Notification,{severity:"caution",title:"Warning",children:e.jsx("span",{children:"Once the profile is added, you cannot modify the rootfs image or cloud-init file."})}),e.jsx(l.Select,{label:"Rootfs image",disabled:I,"aria-label":"Rootfs image",options:y,required:!0,...a.getFieldProps("instanceType"),error:p(a,"instanceType")}),a.values.instanceType==="custom"&&e.jsxs(e.Fragment,{children:[e.jsx(l.Input,{label:"Image name",type:"text",required:!0,...a.getFieldProps("customImageName"),error:p(a,"customImageName")}),e.jsx(l.Input,{type:"text",label:"Rootfs image URL",required:!0,...a.getFieldProps("rootfsImage"),error:p(a,"rootfsImage"),help:"The file path must be reachable by the affected WSL instances."})]}),e.jsx(l.Select,{label:"Cloud-init","aria-label":"Cloud-init",options:z,...a.getFieldProps("cloudInitType"),onChange:async n=>{a.getFieldProps("cloudInitType").onChange(n),await a.setFieldValue("cloudInit",null)},error:p(a,"cloudInitType")}),a.values.cloudInitType==="file"&&e.jsx(xe,{label:"Upload cloud-init",labelClassName:"u-off-screen",accept:".yaml",...a.getFieldProps("cloudInit"),value:a.values.cloudInit instanceof File?a.values.cloudInit:null,onFileRemove:r,onFileUpload:T,help:Fe,error:p(a,"cloudInit")}),a.values.cloudInitType==="text"&&e.jsx(he,{label:"Cloud-init configuration",onChange:n=>{a.setFieldValue("cloudInit",n??"")},value:typeof a.values.cloudInit=="string"?a.values.cloudInit:"",language:"yaml",defaultValue:"# paste cloud-init config here",error:p(a,"cloudInit")})]}),e.jsx(V,{formik:a}),e.jsx(Q,{submitButtonText:"Add WSL profile",submitButtonAriaLabel:"Add a new WSL profile",submitButtonDisabled:a.isSubmitting,onCancel:_})]})})]})},E=()=>{const{profile:t}=w(),{wslProfile:i,isGettingWslProfile:s,wslProfileError:o}=Se({profile_name:t});if(o)throw o;return s?{wslProfile:void 0,isGettingWslProfile:!0}:{wslProfile:i,isGettingWslProfile:!1}},ft=()=>{const{pushSidePath:t}=w(),{getAccessGroupQuery:i}=N(),{wslProfile:s,isGettingWslProfile:o}=E(),{data:u,isPending:f}=i(),{value:I,setTrue:P,setFalse:j}=A();if(o||f)return e.jsx(b.LoadingState,{});const y=()=>{t("edit")};return e.jsxs(e.Fragment,{children:[e.jsx(b.Header,{children:s.title}),e.jsxs(b.Content,{children:[e.jsx("div",{className:"p-segmented-control",children:e.jsxs("div",{className:"p-segmented-control__list",children:[e.jsxs(l.Button,{type:"button",hasIcon:!0,className:"p-segmented-control__button",onClick:y,children:[e.jsx(l.Icon,{name:"edit"}),e.jsx("span",{children:"Edit"})]}),e.jsxs(l.Button,{type:"button",hasIcon:!0,className:"p-segmented-control__button","aria-label":`Remove ${s.title} profile`,onClick:P,children:[e.jsx(l.Icon,{name:l.ICONS.delete}),e.jsx("span",{children:"Remove"})]})]})}),e.jsxs(C,{children:[e.jsx(C.Item,{children:e.jsxs(g,{children:[e.jsx(g.Item,{label:"Title",value:s.title}),e.jsx(g.Item,{label:"Name",value:s.name}),e.jsx(g.Item,{label:"Access group",value:u?.data.find(m=>m.name===s.access_group)?.title??s.access_group}),e.jsx(g.Item,{label:"Description",large:!0,value:s.description})]})}),e.jsx(C.Item,{children:e.jsxs(g,{children:[e.jsx(g.Item,{label:"Rootfs image name",large:!0,value:s.image_name}),s.image_source!==null&&e.jsx(g.Item,{label:"Rootfs image source",large:!0,value:s.image_source,type:"truncated"}),e.jsx(g.Item,{label:"Cloud-init",large:!0,value:s.cloud_init_contents||null})]})}),e.jsxs(C.Item,{title:"Association",children:[s.all_computers&&e.jsx("p",{children:"This profile has been associated with all instances."}),!s.all_computers&&!s.tags.length&&e.jsx("p",{children:"This profile has not yet been associated with any instances."}),(s.all_computers||!!s.tags.length)&&e.jsxs(g,{children:[!s.all_computers&&e.jsx(g.Item,{label:"Tags",large:!0,value:s.tags.join(", ")||null,type:"truncated"}),e.jsx(g.Item,{label:"Associated parents",large:!0,value:e.jsx(pe,{wslProfile:s})}),e.jsx(g.Item,{label:"Not compliant",value:e.jsx(me,{wslProfile:s,onClick:()=>{t("noncompliant")}})}),e.jsx(g.Item,{label:"Compliant",value:e.jsx(ge,{wslProfile:s})})]})]})]})]}),e.jsx(fe,{isOpen:I,close:j,wslProfile:s})]})},Ee=()=>M().shape({title:x().required("This field is required"),description:x().required("This field is required"),access_group:x().required("This field is required"),all_computers:O(),tags:G().of(x())}),ke="_block_tz139_1",Le={block:ke},qe=({profile:t})=>{const{getAccessGroupQuery:i}=N(),s=B(),{sidePath:o,popSidePath:u,setPageParams:f}=w(),{notify:I}=$(),{editWslProfile:P}=_e(),{wslInstanceTypes:j}=H(),y=j.map(({label:n,name:d})=>({label:n,value:d}))||[],m=[{label:"Select",value:""},...y,{label:"From URL",value:"custom"}],{data:_}=i(),h=_?.data.map(({name:n,title:d})=>({label:d,value:n}))??[],a=()=>{f({sidePath:[],profile:""})},T=async n=>{try{await P({name:t.name,title:n.title,access_group:n.access_group,description:n.description,all_computers:n.all_computers,tags:n.tags}),a(),I.success({title:"WSL profile updated",message:`WSL profile "${t.title}" updated successfully`})}catch(d){s(d)}},r=D({initialValues:{title:t.title,access_group:t.access_group,description:t.description,instanceType:t.image_source?"custom":t.image_name,customImageName:t.image_source?t.image_name:"",rootfsImage:t.image_source||"",all_computers:t.all_computers,tags:t.tags},onSubmit:T,validationSchema:Ee()});return e.jsxs(l.Form,{onSubmit:r.handleSubmit,noValidate:!0,children:[e.jsx(l.Input,{type:"text",label:"Title",required:!0,...r.getFieldProps("title"),error:p(r,"title")}),e.jsx(l.Input,{type:"text",label:"Description",required:!0,...r.getFieldProps("description"),error:p(r,"description")}),e.jsx(l.Select,{label:"Access group","aria-label":"Access group",options:h,required:!0,...r.getFieldProps("access_group"),error:p(r,"access_group")}),e.jsxs("div",{className:Le.block,children:[e.jsx(l.Notification,{severity:"caution",title:"Editing unavailable",children:e.jsx("span",{children:"You cannot edit rootfs image or cloud-init file. To modify these fields, create a new profile."})}),e.jsx(l.Select,{disabled:!0,label:"Rootfs image","aria-label":"Rootfs image",options:m,...r.getFieldProps("instanceType"),error:p(r,"instanceType")}),r.values.instanceType==="custom"&&e.jsxs(e.Fragment,{children:[e.jsx(l.Input,{disabled:!0,label:"Image name",type:"text",required:!0,...r.getFieldProps("customImageName"),error:p(r,"customImageName")}),e.jsx(l.Input,{disabled:!0,type:"text",label:"Rootfs image URL",required:!0,...r.getFieldProps("rootfsImage"),error:p(r,"rootfsImage"),help:"The file path must be reachable by the affected WSL instances."})]}),e.jsx(l.Select,{label:"Cloud-init","aria-label":"Cloud-init",options:z,disabled:!0})]}),e.jsx(V,{formik:r}),e.jsx(Q,{submitButtonText:"Save changes",submitButtonDisabled:r.isSubmitting,onCancel:a,hasBackButton:o.length>1,onBackButtonPress:u})]})},ht=()=>{const{wslProfile:t,isGettingWslProfile:i}=E();return i?e.jsx(b.LoadingState,{}):e.jsxs(e.Fragment,{children:[e.jsxs(b.Header,{children:['Edit "',t.title,'" profile']}),e.jsx(b.Content,{children:e.jsx(qe,{profile:t})})]})},Me="_header_513lp_1",Ge="_search_513lp_8",k={header:Me,search:Ge},Oe=({instance:t})=>{const{value:i,setTrue:s,setFalse:o}=A();return e.jsxs(e.Fragment,{children:[e.jsx(J,{destructiveActions:[{icon:"security-tick",label:"Make compliant",onClick:s}],toggleAriaLabel:`${t.title} actions`}),e.jsx(U,{close:o,instances:[t],isOpen:i})]})},Be=t=>({column:i,row:{index:s}})=>i.id==="profiles"&&t===s?{className:"expandedCell"}:{},$e=t=>({index:i})=>t===i?{className:"expandedRow"}:{},De=({wslProfile:t})=>{const{expandedRowIndex:i,getTableRowsRef:s,handleExpand:o}=ee(),[u,f]=F.useState(""),[I]=F.useState(te),[P]=F.useState(se),[j,y]=F.useState(""),{instances:m,isGettingInstances:_}=Pe({query:[j,`profile:wsl:${t.id}:noncompliant`].filter(Boolean).join(" "),limit:P,offset:(I-1)*P,with_wsl_profiles:!0}),{selectedItems:h,setSelectedItems:a}=je(m,_),{value:T,setTrue:r,setFalse:n}=A(),d=F.useMemo(()=>[{accessor:"title",Header:e.jsxs(e.Fragment,{children:[e.jsx(l.CheckboxInput,{label:e.jsx("span",{className:"u-off-screen",children:"Toggle all instances"}),inline:!0,disabled:!m.length,indeterminate:!!h.length&&h.length<m.length,checked:!!m.length&&h.length===m.length,onChange:({currentTarget:{checked:c}})=>{a(c?m:[])}}),"Instance name"]}),Cell:({row:{original:c}})=>e.jsxs(e.Fragment,{children:[e.jsx(l.CheckboxInput,{inline:!0,label:e.jsxs("span",{className:"u-off-screen",children:["Select ",c.title]}),checked:h.includes(c),onChange:({currentTarget:{checked:S}})=>{a(S?[...h,c]:h.filter(v=>v!==c))}}),e.jsx(ie,{to:ae.instances.details.single(c.id),children:c.title})]})},{Header:"OS",Cell:({row:{original:c}})=>c.distribution_info?.description},{accessor:"profiles",Header:"WSL profiles",Cell:({row:{original:c,index:S}})=>e.jsx(ne,{content:c.wsl_profiles?.map(v=>v.title).join(", "),isExpanded:S===i,onExpand:()=>{o(S)}})},{Header:"Last ping",Cell:({row:{original:c}})=>{const S=le(c.last_ping_time);return S.isValid()?e.jsx("span",{className:"font-monospace",children:S.format(oe)}):e.jsx(re,{})}},{...Ie,Cell:({row:{original:c}})=>e.jsx(Oe,{instance:c})}],[m,h,i]),R=()=>{f(""),y("")};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:k.header,children:[e.jsx(l.SearchBox,{className:ce("u-no-margin--bottom",k.search),externallyControlled:!0,value:u,onChange:f,onClear:R,onSearch:y,autoComplete:"off"}),e.jsxs(l.Button,{type:"button",className:"u-no-margin",hasIcon:!0,onClick:r,disabled:!h.length,children:[e.jsx(l.Icon,{name:"security-tick"}),e.jsx("span",{children:"Make compliant"})]})]}),e.jsx(be,{filters:[{label:"Search",item:j||void 0,clear:R}]}),_?e.jsx(ue,{}):e.jsx("div",{ref:s,children:e.jsx(de,{columns:d,data:m,emptyMsg:"No Windows instances found according to your search parameters.",getCellProps:Be(i),getRowProps:$e(i)})}),e.jsx(U,{close:n,instances:h,isOpen:T})]})},xt=()=>{const{wslProfile:t,isGettingWslProfile:i}=E();return i?e.jsx(b.LoadingState,{}):e.jsxs(e.Fragment,{children:[e.jsxs(b.Header,{children:["Instances not compliant with ",t.title]}),e.jsx(b.Content,{children:e.jsx(De,{wslProfile:t})})]})};export{gt as WslProfileAddSidePanel,ft as WslProfileDetailsSidePanel,ht as WslProfileEditSidePanel,xt as WslProfileNonCompliantInstancesSidePanel,Pt as WslProfilesEmptyState,jt as WslProfilesHeader,yt as WslProfilesList,ye as useAddWslProfile,_t as useDeleteWslProfile,_e as useEditWslProfile,Se as useGetWslProfile,St as useGetWslProfiles,Ft as useMakeWindowsInstancesCompliant,Ct as useReapplyWslProfile};
