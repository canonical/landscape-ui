import{i as R,h as k,e as I,f as q,g as N,F as S,M as B,H as h,aa as m,r as x,l as L,y as V,z as $,A as D,j as s,m as c,B as p,L as v,o as M,N as O}from"./index-B2Vbvr_z.js";import{C as H}from"./CodeEditor-DeQdtIaF.js";import{S as K}from"./SidePanelFormButtons-BjJqvXrc.js";import{u as Q}from"./useEditScript-C93GPG1R.js";import{u as Y,D as z,S as G}from"./ScriptFormAttachments-B6h5Ysth.js";import{g as U,h as J,i as W}from"./ScriptsTabs-DaHrrSt2.js";import"./index-X6zfrMT6.js";import"./SidePanelFormButtons.module-D2P5PizG.js";import"./AttachmentFile-CQeINqvs.js";import"./TruncatedCell-C95V3Amb.js";import"./useRoles-j4Ho2ToQ.js";import"./HeaderWithSearch-D4RJ5hlf.js";import"./SingleInstanceTabs.module-Cm1BYFZQ.js";const X=(e,r={enabled:!0})=>{const l=R(),{data:o,isPending:u}=k({queryKey:["scripts","profiles",e],queryFn:async()=>l.get(`scripts/${e}/script-profiles`),...r});return{associatedScriptProfiles:(o==null?void 0:o.data.results)??[],isAssociatedScriptProfilesLoading:u}},Z=()=>{const e=I(),r=q(),{mutateAsync:l,isPending:o}=N({mutationKey:["scripts","removeAttachment"],mutationFn:async u=>e.get("RemoveScriptAttachment",{params:u}),onSuccess:async()=>r.invalidateQueries({queryKey:["scripts"]})});return{removeScriptAttachment:l,isRemovingScriptAttachment:o}},ee="_modal_ud99a_1",te="_link_ud99a_5",f={modal:ee,link:te},se=()=>S().shape({title:h().required("This field is required"),code:h().required("This field is required"),attachments:S().shape({first:m().nullable(),second:m().nullable(),third:m().nullable(),fourth:m().nullable(),fifth:m().nullable()}),attachmentsToRemove:B().of(h())}),ae=e=>({title:e.title,code:U({code:e.code,interpreter:e.interpreter}),time_limit:e.time_limit,username:e.username,attachments:{first:null,second:null,third:null,fourth:null,fifth:null},attachmentsToRemove:[]}),ne=e=>{const r=e.lastIndexOf(".");return r!==-1?e.slice(0,r):e},Se=({script:e})=>{const r=x.useRef(null),[l,o]=x.useState(!1),{closeSidePanel:u}=L(),y=V(),{notify:A}=$(),{createScriptAttachment:F}=Y(),{removeScriptAttachment:j}=Z(),{editScript:C,isEditing:g}=Q(),{associatedScriptProfiles:b,isAssociatedScriptProfilesLoading:w}=X(e.id,{enabled:l}),T=async t=>{const i=Object.values(t.attachments).filter(a=>a!==null);try{const a=[C(J({scriptId:e.id,values:t}))];if(t.attachmentsToRemove.length)for(const d of t.attachmentsToRemove)a.push(j({script_id:e.id,filename:d}));i.length&&a.push(...await W({attachments:i,createScriptAttachment:F,script_id:e.id})),await Promise.all(a),u(),o(!1),A.success({title:`You have successfully submitted a new version of ${e.title}`,message:"All its associated profiles will now be run using this new version."})}catch(a){o(!1),y(a)}},n=D({initialValues:ae(e),validationSchema:se(),onSubmit:T}),P=async({target:{files:t}})=>{if(!t)return;const[i]=t,a=n.setFieldValue("code",await i.text());if(n.values.title){await a;return}await Promise.all([n.setFieldValue("title",ne(i.name)),a])},_=async t=>{await n.setFieldValue("code",t)},E=()=>{var t;return(t=r.current)==null?void 0:t.click()};return s.jsxs(c.Form,{onSubmit:n.handleSubmit,noValidate:!0,children:[s.jsx(c.Input,{type:"text",label:"Title",required:!0,...n.getFieldProps("title"),error:p(n,"title")}),s.jsx("input",{ref:r,className:"u-hide",type:"file",onChange:P}),s.jsx(H,{label:"Code",value:n.values.code,onChange:_,error:p(n,"code"),required:!0,defaultValue:z,headerContent:s.jsxs(c.Button,{className:"u-no-margin--bottom",appearance:"base",hasIcon:!0,onClick:E,type:"button",children:[s.jsx(c.Icon,{name:"upload"}),s.jsx("span",{children:"Populate from file"})]})}),s.jsxs(s.Fragment,{children:[s.jsx("h5",{children:"List of attachments"}),s.jsx("p",{className:"u-text--muted",children:"Attachments that will be sent along with the script. You can attach up to 5 files, for a maximum of 1.00MB. Filenames must be unique. On the client, the attachments will be placed in the directory whose name is accessible through the environment variable LANDSCAPE_ATTACHMENTS. They'll be deleted once the script has been run."})]}),s.jsx(G,{attachments:n.values.attachments,attachmentsToRemove:n.values.attachmentsToRemove,getFileInputError:t=>p(n,["attachments",t]),initialAttachments:e.attachments,onFileInputChange:t=>async i=>{var a;return n.setFieldValue(`attachments.${t}`,((a=i.target.files)==null?void 0:a[0])??null)},onInitialAttachmentDelete:async t=>n.setFieldValue("attachmentsToRemove",[...n.values.attachmentsToRemove,t]),scriptId:e.id}),s.jsx(K,{onSubmit:()=>{o(!0)},submitButtonText:"Submit new version"}),l&&s.jsx(c.ConfirmationModal,{title:`Submit new version of "${e.title}"`,confirmButtonLabel:"Submit new version",onConfirm:()=>{n.handleSubmit()},confirmButtonAppearance:"positive",confirmButtonDisabled:g,confirmButtonLoading:g,close:()=>{o(!1)},className:f.modal,confirmButtonProps:{type:"button"},children:b.length>0?s.jsxs(s.Fragment,{children:[s.jsx("p",{children:"All future script runs will be done using the latest version of the code. Submitting these changes will affect the following profiles:"}),s.jsx(c.ModularTable,{columns:[{Header:"active profiles",accessor:"title",Cell:({row:t})=>s.jsx(v,{to:"/scripts?tab=profiles",state:{scriptProfileId:t.original.id},target:"_blank",className:f.link,children:t.original.title})},{Header:"associated instances",Cell:({row:t})=>{const i=b.find(d=>d.id===t.original.id),a=i==null?void 0:i.computers.num_associated_computers;return w?s.jsx(M,{}):a?s.jsxs(v,{to:`/instances?tags=${i==null?void 0:i.tags.join(",")}`,target:"_blank",className:f.link,children:[a," instance",a>1?"s":""]}):s.jsx(O,{})}}],data:e.script_profiles})]}):s.jsx("p",{children:"All future script runs will be done using the latest version of the code."})})]})};export{Se as default};
