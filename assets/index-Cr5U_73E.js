import{O as w,j as e,h as l,g as A,r as E,E as T,p as M,o as q}from"./index-BldH9338.js";import{T as H}from"./TablePagination-IE5OE8Yu.js";import{I as V}from"./InfoItem-DrDR8tP4.js";import{h as d}from"./moment-C5S46NFB.js";import{N as p}from"./NoData-CBJkG1Ac.js";import{u as U,K as Y}from"./index-n3YiW-5-.js";import{u as $}from"./usePageParams-C9cd70Uu.js";import"./TablePagination.module-CgQ3jx4B.js";import"./PageMain-nLBqjole.js";import"./useUsns-BoK3Cs1P.js";import"./useFetchOld-BoUXaNFb.js";import"./useInstances-Bi0wjWgI.js";import"./moment-BljOPy2t.js";const z=(a,t)=>{switch(a){case"Fully patched":return"All available kernel security patches have been applied. You have no pending patches";case"Kernel upgrade available":return`A new kernel version is available. The current version is covered by Livepatch until ${d(t).format(w)}`;case"Restart required":return"Low and/or medium patches have been installed. You must restart to complete patching.";case"End of life":return"The kernel is no longer covered by Livepatch. It is not getting high and critical security patches.";case"Livepatch disabled":return"Livepatch is disabled. Kernel patches will not be applied automatically until you enabled Livepatch.";default:return"There was an error getting the status"}},Q=a=>{switch(a){case"Patched by Livepatch":case"Fully patched":case"Kernel upgrade available":return"status-succeeded-small";case"Restart required":return"status-waiting-small";case"End of life":return"status-failed-small";default:return"status-failed-small"}},R=(a,t)=>{const s=d(t),n=d(),c=s.diff(n,"days");return c<0||!a||!d(t).isValid()?"status-failed-small":c<7?"status-waiting-small":"status-succeeded-small"},G=(a,t)=>{if(!a)return"Livepatch is disabled";const s=d(t),n=d();return s.diff(n,"days")<0?"Expired":`Expires on ${d(t).format(w)}`},J="_statusIcon_s1xwo_1",W="_tooltipIcon_s1xwo_5",X="_container_s1xwo_9",u={statusIcon:J,tooltipIcon:W,container:X},Z=({kernelOverview:a})=>{const t=a.status!=="Livepatch disabled",s=[{label:"current kernel version",value:a.currentVersion||e.jsx(p,{})},{label:"kernel status",value:e.jsxs(e.Fragment,{children:[e.jsx("span",{children:t?a.status||e.jsx(p,{}):"Not covered by Livepatch"}),e.jsxs(l.Tooltip,{message:z(a.status,a.expirationDate),className:u.tooltipIcon,children:[e.jsx(l.Icon,{name:"help","aria-hidden":!0}),e.jsx("span",{className:"u-off-screen",children:"Help"})]})]})},{label:"livepatch coverage",value:G(t,a.expirationDate)}];return e.jsx(l.Row,{className:A("u-no-padding--left u-no-padding--right u-no-max-width",u.container),children:s.map(({label:n,value:c})=>e.jsxs(l.Col,{size:3,children:[n==="status"&&e.jsx(l.Icon,{name:Q(a.status),"aria-hidden":!0,className:u.statusIcon}),n==="livepatch coverage"&&e.jsx(l.Icon,{name:R(t,a.expirationDate),"aria-hidden":!0,className:u.statusIcon}),e.jsx(V,{label:n,value:c})]},n))})},k=`There are no pending kernel security patches to apply at this time.
                Livepatch applies critical and high security patches in the background without requiring a system restart.
                Patches found since last restart and their status will be shown here.`,O=a=>`https://cve.mitre.org/cgi-bin/cvename.cgi?name=${a}`,ee=a=>{const t={};switch(a.column.id){case"Name":t.role="rowheader";break;case"Patched":t["aria-label"]="Status";break;case"Description":t["aria-label"]="Description";break;case"Bug":t["aria-label"]="Bug";break}return t},ae="_description_1s9gq_1",te={description:ae},se=({kernelData:a})=>{const t=E.useMemo(()=>[{Header:e.jsx("span",{children:"CVE"}),accessor:"Name",Cell:({row:s})=>e.jsx(l.Link,{href:O(s.original.Name),target:"_blank",rel:"nofollow noopener noreferrer",className:"u-no-margin--bottom u-no-padding--top",children:s.original.Name})},{Header:"Status",accessor:"Patched",Cell:({row:{original:s}})=>s.Patched?"Patched by Livepatch":"Unpatched",getCellIcon:({row:{original:s}})=>s.Patched?"status-succeeded-small":"status-failed-small",disableSortBy:!0},{Header:"Description",accessor:"Description",className:te.description,Cell:({row:s})=>s.original.Description||e.jsx(p,{}),disableSortBy:!0},{Header:"Bug",accessor:"Bug",Cell:({row:s})=>s.original.Bug||e.jsx(p,{}),disableSortBy:!0}],[]);return e.jsxs(e.Fragment,{children:[e.jsx("h3",{className:"p-heading--5 u-no-padding u-no-margin",children:"Patches discovered since last restart"}),a.length===0?e.jsx(T,{title:"No outstanding kernel patches",body:k}):e.jsx(l.ModularTable,{columns:t,data:a,getCellProps:ee,sortable:!0,initialSortColumn:"Name",initialSortDirection:"ascending"})]})},be=({instanceTitle:a})=>{var b,v,f,j,y,_,I,N,L,P;const{instanceId:t,childInstanceId:s}=M(),{pageSize:n,currentPage:c}=$(),{getKernelQuery:C,getLivepatchInfoQuery:K}=U(),x=Number(s??t),{data:i,isPending:h}=C({id:x}),{data:o}=K({id:x}),r=(f=(v=(b=o==null?void 0:o.data.livepatch_info)==null?void 0:b.json)==null?void 0:v.output)!=null&&f.Status&&((_=(y=(j=o==null?void 0:o.data.livepatch_info)==null?void 0:j.json)==null?void 0:y.output)==null?void 0:_.Status.length)>0?(L=(N=(I=o==null?void 0:o.data.livepatch_info)==null?void 0:I.json)==null?void 0:N.output)==null?void 0:L.Status[0]:void 0,m=(r==null?void 0:r.Livepatch.Fixes)??[],F=(B,D)=>m.slice(D,D+B),g=E.useMemo(()=>F(n,(c-1)*n),[m,c,n]),S={currentVersion:(r==null?void 0:r.Kernel)??((P=i==null?void 0:i.data.installed)==null?void 0:P.version_rounded)??"",expirationDate:r&&d(r==null?void 0:r.UpgradeRequiredDate).isValid()?r.UpgradeRequiredDate:"",status:(i==null?void 0:i.data.smart_status)??""};return e.jsxs(e.Fragment,{children:[h&&e.jsx(q,{}),!h&&!(i!=null&&i.data.installed)&&e.jsx(T,{title:"Kernel Information Unavailable",body:(i==null?void 0:i.data.message)||"No kernel information available"}),!h&&(i==null?void 0:i.data.installed)&&e.jsxs(e.Fragment,{children:[e.jsx(Y,{instanceName:a,hasTableData:g.length>0,kernelStatuses:i.data}),e.jsx(Z,{kernelOverview:S}),e.jsx(se,{kernelData:g}),e.jsx(H,{totalItems:m.length,currentItemCount:g.length})]})]})};export{be as default};
