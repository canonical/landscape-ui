import{r as A,a9 as E,j as t,n as i,o as C,S as c,t as v,aH as M,w as g,D as $,I as T,x as F,u as B,F as h,aI as z,a2 as Y,A as U,m as H,C as V,H as W,K as x,M as w}from"./index-2G8kPGdZ.js";import{A as K}from"./AssociationBlock-EqxJPBP5.js";import{u as G}from"./useInstances-mRXaR19R.js";import{F as Q}from"./FileInput-x4gOouzg.js";import{F as J}from"./Flow-DdOQn03X.js";import{u as Z}from"./useOrgSettings-DPFG5fZG.js";import{u as X}from"./useRoles-Delhp72k.js";import{I as k,R as D}from"./RadioGroup-DT992nZ1.js";import{M as q}from"./MultiSelectField-D8ghYzhC.js";const N=[{label:"Sundays",value:"SU"},{label:"Mondays",value:"MO"},{label:"Tuesdays",value:"TU"},{label:"Wednesdays",value:"WE"},{label:"Thursdays",value:"TH"},{label:"Fridays",value:"FR"},{label:"Saturdays",value:"SA"}],P=[{label:"January",value:1},{label:"February",value:2},{label:"March",value:3},{label:"April",value:4},{label:"May",value:5},{label:"June",value:6},{label:"July",value:7},{label:"August",value:8},{label:"September",value:9},{label:"October",value:10},{label:"November",value:11},{label:"December",value:12}];function ee(e){const{getInstancesQuery:s}=G(),{data:r,isLoading:o}=s({query:e.values.all_computers?void 0:e.values.tags.map(d=>`tag:${d}`).join(" OR "),limit:1}),[l,y]=A.useState(!1);return A.useEffect(()=>{if(r){if(!e.values.tags.length&&!e.values.all_computers){y(!1);return}y(r.data.count>E)}},[r]),{isLoading:o,isValid:!l,description:"Associate the security profile. Apply it to all instances or limit it to specific instances using a tag.",content:t.jsxs(t.Fragment,{children:[l&&t.jsxs(i.Notification,{severity:"negative",inline:!0,title:"Associated instances limit reached:",children:["You've reached the limit of"," ",t.jsxs("strong",{children:[E," associated instances"]}),". Decrease the number of associated instances."]}),t.jsx(K,{formik:e})]}),submitButtonText:"Next"}}const te="_description_18qzl_1",ae="_link_18qzl_6",R={description:te,link:ae},_=({className:e,description:s,label:r,link:o})=>t.jsxs(t.Fragment,{children:[t.jsx("p",{className:C("u-no-margin--bottom",e),children:r}),t.jsxs("small",{className:R.description,children:[s,o&&t.jsx("a",{className:R.link,href:o,target:"_blank",rel:"noreferrer",onClick:l=>{l.stopPropagation()},children:"learn more"})]})]});function se(e,s){const r=async l=>{await e.setFieldValue("tailoring_file",l[0])},o=async()=>{await e.setFieldValue("tailoring_file",null)};return{isValid:!e.errors.benchmark&&!e.errors.mode,description:"Select a security profile benchmark, choose the profile mode, and optionally upload a tailoring file to customize the security profile.",content:t.jsxs(t.Fragment,{children:[!s&&t.jsx(i.Notification,{severity:"caution",title:"Changes restricted:",inline:!0,children:"After profile creation, the security profile benchmark and mode cannot be changed. Please review before proceeding."}),t.jsx(i.CustomSelect,{label:"Base profile",disabled:s,options:[{label:t.jsx(_,{className:"u-no-padding--top",label:c.cis_level1_workstation,description:"Center for Internet Security",link:"https://ubuntu.com/security/cis"}),value:"cis_level1_workstation",text:c.cis_level1_workstation},{label:t.jsx(_,{className:"u-no-padding--top",label:c.cis_level1_server,description:"Center for Internet Security",link:"https://ubuntu.com/security/cis"}),value:"cis_level1_server",text:c.cis_level1_server},{label:t.jsx(_,{className:"u-no-padding--top",label:c.cis_level2_workstation,description:"Center for Internet Security",link:"https://ubuntu.com/security/cis"}),value:"cis_level2_workstation",text:c.cis_level2_workstation},{label:t.jsx(_,{className:"u-no-padding--top",label:c.cis_level2_server,description:"Center for Internet Security",link:"https://ubuntu.com/security/cis"}),value:"cis_level2_server",text:c.cis_level2_server},{label:t.jsx(_,{className:"u-no-padding--top",label:c.disa_stig,description:"Defense Information System Agency (DISA) for the U.S. Department of Defense (DoD)",link:"https://ubuntu.com/security/disa-stig"}),value:"disa_stig",text:c.disa_stig}],value:e.values.benchmark??"",onChange:async l=>e.setFieldValue("benchmark",l),required:!0,searchable:"never"}),t.jsx(i.CustomSelect,{label:"Mode",disabled:s,options:[{label:t.jsx(_,{className:"u-no-padding--top",label:v.audit,description:"Generates an audit without applying any fixes or remediation."}),value:"audit",text:v.audit},{label:t.jsx(_,{className:"u-no-padding--top",label:v["audit-fix"],description:"Applies fixes and generates an audit after remediation."}),value:"audit-fix",text:v["audit-fix"]},{label:t.jsx(_,{className:"u-no-padding--top",label:v["audit-fix-restart"],description:`Applies fixes, requires a machine restart, and generates an
                  audit after remediation.`}),value:"audit-fix-restart",text:v["audit-fix-restart"]}],value:e.values.mode??"",onChange:async l=>e.setFieldValue("mode",l),required:!0}),t.jsx(Q,{label:"Upload tailoring file",disabled:s,accept:".xml",...e.getFieldProps("tailoring_file"),help:t.jsxs(t.Fragment,{children:["Customize your security profile by adjusting or disabling rules to fit your system while staying compliant.",t.jsx("br",{}),"Max file size: 5mb. Supported format: .xml."]}),onFileRemove:o,onFileUpload:r})]}),submitButtonText:"Next"}}function re(e){return{isValid:!0,description:`This will ${M([e.values.mode!="audit"?"apply fixes":null,e.values.mode=="audit-fix-restart"?"restart instances":null,"generate an audit"].filter(s=>s!=null))} on the selected next run date.`,content:t.jsx(J,{cards:[{header:"Next run date",description:t.jsxs(t.Fragment,{children:["Security profile's next run date arrives",t.jsx("br",{}),g(e.values.start_date).format(`${$}`)]}),iconName:"revisions"},e.values.mode!="audit"?{header:"Apply fixes",description:"Security profile will attempt to apply remediations before the next audit, helping maintain instances' compliance with the security profile.",iconName:"open-terminal"}:null,e.values.mode=="audit-fix-restart"?{header:"Restart instances",description:"To complete the fixes, instances must be restarted.",iconName:"restart",children:t.jsxs(t.Fragment,{children:[t.jsx(i.Row,{className:"u-no-padding",children:t.jsx(T,{label:"Delivery time",value:e.values.delivery_time=="asap"?"As soon as possible":`Delayed by ${e.values.restart_deliver_delay} ${F(e.values.restart_deliver_delay,"hour")}`})}),t.jsx(i.Row,{className:"u-no-padding",children:t.jsx(T,{label:"Randomize delivery over a time window",value:e.values.randomize_delivery=="yes"?`Yes, over ${e.values.restart_deliver_delay_window} ${F(e.values.restart_deliver_delay_window,"minute")}`:"No"})})]})}:null,{header:"Generate an audit",description:"Security profile will generate an audit for all instances associated, aggregated in the audit view to show pass/fail results and allow detailed inspection.",iconName:"file-blank"}].filter(s=>s!=null)}),submitButtonText:"Add"}}function ie(e){const{isSelfHosted:s}=B(),{getOrganisationPreferences:r}=Z(),{getAccessGroupQuery:o}=X(),{data:l,isLoading:y}=o(),{data:d,isLoading:S}=r(),j=()=>{const p=d==null?void 0:d.data.audit_retention_period;return!p||p===-1?"Infinite":`${p} ${F(p,"day")}`};return{isLoading:y||S,isValid:!e.errors.title,description:"Choose a descriptive profile name and the right access group for your security profile.",content:t.jsxs(t.Fragment,{children:[t.jsx(i.Input,{type:"text",label:"Profile name",...e.getFieldProps("title"),error:h(e,"title"),required:!0}),t.jsx(i.Select,{label:"Access group",options:l==null?void 0:l.data.map(p=>({label:p.title,value:p.name})),...e.getFieldProps("access_group"),error:h(e,"access_group"),required:!0,disabled:y}),s&&t.jsx(i.Input,{type:"text",label:"Audit retention",required:!0,disabled:!0,value:j(),help:"You can change this limit in the Landscape server configuration file."})]}),submitButtonText:"Next"}}const ne=({formik:{values:e,...s}})=>{switch(e.unit_of_time){case"WEEKLY":return t.jsx(q,{variant:"condensed",label:"On",items:[...N],selectedItems:N.filter(({value:r})=>e.days.includes(r)),onItemsUpdate:async r=>s.setFieldValue("days",r.map(({value:o})=>o)),scrollOverflow:!0,isSortedAlphabetically:!1,hasSelectedItemsFirst:!1,required:!0});case"MONTHLY":return!!e.start_date&&t.jsx(i.Select,{label:"On",options:z(new Date(e.start_date)),...s.getFieldProps("day_of_month_type"),required:!0});case"YEARLY":return t.jsx(q,{variant:"condensed",label:"On",items:[...P],selectedItems:P.filter(({value:r})=>e.months.includes(r)),onItemsUpdate:async r=>s.setFieldValue("months",r.map(({value:o})=>o)),isSortedAlphabetically:!1,hasSelectedItemsFirst:!1,scrollOverflow:!0,required:!0})}},le=({formik:e})=>{const s=g().format(Y);switch(e.values.start_type){case"on-a-date":return t.jsx(i.Input,{type:"datetime-local",label:"Date",min:s,...e.getFieldProps("start_date"),error:h(e,"start_date"),required:!0});case"recurring":return t.jsxs(t.Fragment,{children:[t.jsx(i.Input,{type:"datetime-local",label:"Start date",min:s,...e.getFieldProps("start_date"),error:h(e,"start_date"),required:!0}),t.jsxs(i.Row,{className:"u-no-padding",children:[t.jsx(i.Col,{size:6,children:t.jsx(i.Input,{...e.getFieldProps("every"),type:"number",label:"Repeat every",min:1,error:h(e,"every"),required:!0})}),t.jsx(i.Col,{size:6,children:t.jsx(i.Select,{label:"Repeat every",options:[{label:"Day",value:"DAILY"},{label:"Week",value:"WEEKLY"},{label:"Month",value:"MONTHLY"},{label:"Year",value:"YEARLY"}].map(r=>e.values.every==1?r:{...r,label:`${r.label}s`}),...e.getFieldProps("unit_of_time"),required:!0})})]}),t.jsx(ne,{formik:e}),t.jsx(i.Select,{label:"Ends",options:[{label:"Never",value:"never"},{label:"On a date",value:"on-a-date"}],...e.getFieldProps("end_type"),required:!0}),e.values.end_type=="on-a-date"&&t.jsx(i.Input,{type:"datetime-local",label:"End date",min:e.values.start_date,...e.getFieldProps("end_date"),error:h(e,"end_date"),required:!0})]})}},oe=({formik:e})=>t.jsxs(t.Fragment,{children:[t.jsx(i.Select,{label:"Schedule",options:[{label:"Select",value:"",hidden:!0},{label:"On a date",value:"on-a-date"},{label:"Recurring",value:"recurring"}],...e.getFieldProps("start_type"),required:!0}),t.jsx(k,{children:t.jsx(le,{formik:e})})]}),de="_inputContainer_1k4iz_1",ue="_input_1k4iz_1",ce="_inputDescription_1k4iz_10",m={inputContainer:de,input:ue,inputDescription:ce};function pe(e){return{isValid:!e.errors.start_type&&!e.errors.start_date&&!e.errors.every&&!e.errors.end_date&&!e.errors.restart_deliver_delay_window&&!e.errors.restart_deliver_delay,description:"Add a schedule for the security profile. Select a specific date or a recurring schedule for continuous audit generation.",content:t.jsxs(t.Fragment,{children:[t.jsx(oe,{formik:e}),e.values.mode=="audit-fix-restart"&&t.jsxs(t.Fragment,{children:[t.jsx(_,{label:"Restart schedule",description:"You can choose when to perform the required restart."}),t.jsx(D,{field:"delivery_time",formik:e,label:"Delivery time",inputs:[{label:"As soon as possible",key:"asap"},{label:"Delayed",key:"delayed",expansion:t.jsxs("div",{className:m.inputContainer,children:[t.jsx(i.Input,{type:"number",required:!0,className:m.input,wrapperClassName:m.inputWrapper,...e.getFieldProps("restart_deliver_delay"),error:h(e,"restart_deliver_delay")}),t.jsx("span",{className:m.inputDescription,children:"hours"})]})}]}),t.jsx(D,{field:"randomize_delivery",formik:e,label:"Randomize delivery over a time window",inputs:[{label:"No",key:"no"},{label:"Yes",key:"yes",expansion:t.jsxs("div",{className:m.inputContainer,children:[t.jsx(i.Input,{type:"number",required:!0,className:m.input,wrapperClassName:m.inputWrapper,...e.getFieldProps("restart_deliver_delay_window"),error:h(e,"restart_deliver_delay_window")}),t.jsx("span",{className:m.inputDescription,children:"minutes"})]})}]})]})]}),submitButtonText:"Next"}}const je=({initialValues:e,mutate:s,benchmarkStepDisabled:r,onSuccess:o=()=>{}})=>{const l=U(),{closeSidePanel:y}=H(),d=V({initialValues:e,validateOnMount:!0,validationSchema:W().shape({benchmark:x().required("This field is required."),end_date:x().when(["start_date","start_type","end_type"],([a,n,u],b)=>n=="recurring"&&u=="on-a-date"?b.required("This field is required.").test({test:f=>g(f).isAfter(g(a)),message:"The end date must be after the start date."}):b),every:w().when("start_type",([a],n)=>a=="recurring"?n.required("This field is required.").positive("Enter a positive number.").integer("Enter an integer."):n),mode:x().required("This field is required."),restart_deliver_delay_window:w().when(["mode","randomize_delivery"],([a,n],u)=>a=="audit-fix-restart"&&n=="yes"?u.required("This field is required.").positive("Enter a positive number.").integer("Enter an integer."):u),restart_deliver_delay:w().when(["mode","delivery_time"],([a,n],u)=>a=="audit-fix-restart"&&n=="delayed"?u.required("This field is required.").positive("Enter a positive number.").integer("Enter an integer."):u),start_date:x().required("This field is required."),title:x().required("This field is required.")}),onSubmit:async a=>{var u;if(!a.benchmark||!a.mode)return;const n=[];if(a.start_type=="recurring"){switch(n.push(`FREQ=${a.unit_of_time}`,`INTERVAL=${a.every}`),a.unit_of_time){case"WEEKLY":{n.push(`BYDAY=${a.days.join(",")}`);break}case"MONTHLY":{const b=new Date(a.start_date),f=b.getDate();switch(a.day_of_month_type){case"day-of-month":{n.push(`BYMONTHDAY=${f}`);break}case"day-of-week":{const I=Math.ceil(f/7);n.push(`BYDAY=${I>4?-1:I}${N[b.getDay()].value}`);break}}break}case"YEARLY":{n.push(`BYMONTH=${a.months.join(",")}`);break}}a.end_type=="on-a-date"&&n.push(`UNTIL=${g(a.end_date).format("YYYYMMDDTHHmmss")}Z`)}else n.push("FREQ=WEEKLY","COUNT=1");try{await s({access_group:a.access_group=="global"?void 0:a.access_group,all_computers:a.all_computers||void 0,benchmark:a.benchmark,mode:a.mode,restart_deliver_delay_window:a.mode=="audit-fix-restart"?a.restart_deliver_delay_window:void 0,restart_deliver_delay:a.mode=="audit-fix-restart"?a.restart_deliver_delay:void 0,schedule:n.join(";"),start_date:`${g(a.start_date).format(Y)}Z`,tags:a.all_computers?void 0:a.tags,tailoring_file:await((u=a.tailoring_file)==null?void 0:u.text()),title:a.title})}catch(b){l(b);return}y(),o(a)}}),S=ie(d),j=se(d,r),p=pe(d),O=ee(d),L=re(d);return{formik:d,steps:[S,j,p,O,L]}};export{je as u};
