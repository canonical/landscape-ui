const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-DUBLScBU.js","assets/index-CXNm0bld.js","assets/index-zKdb8HNb.css","assets/SidePanelFormButtons-ByCHTjrf.js","assets/SidePanelFormButtons.module-D2P5PizG.js","assets/SidePanelFormButtons-JM1G8Sq6.css","assets/MultiSelectField-DatqmchJ.js","assets/MultiSelectField-GyNA33om.css","assets/helpers-BdZlAyfq.js","assets/ResponsiveButtons-D8N5ZFCe.js","assets/ResponsiveButtons-C56n2q_V.css","assets/HeaderWithSearch-BngRzBTL.js","assets/HeaderWithSearch-C2lwo0VI.css","assets/output-DFRNcfG-.js","assets/index-CUWyWL4h.js"])))=>i.map(i=>d[i]);
import{c as O,r as p,i as ce,f as ie,g as j,h as B,P as Q,A as H,k as F,C as ue,J as le,M as k,R as de,j as e,n as r,B as me,o as L,p as v,a0 as $,ao as pe,d as K,ah as A,N as he,ap as ge,E as ye,L as be,aq as xe}from"./index-CXNm0bld.js";import{S as ke}from"./SidePanelFormButtons-ByCHTjrf.js";import{g as fe,r as G,U as R,a as je}from"./helpers-BdZlAyfq.js";import{R as Se}from"./ResponsiveButtons-D8N5ZFCe.js";import{H as we}from"./HeaderWithSearch-BngRzBTL.js";import{g as Ue}from"./output-DFRNcfG-.js";const E=5e3;function _e({data:s,sortFunctions:n}){const{sortBy:c,sort:u}=O();return p.useMemo(()=>{const l=n[c];return!c||!u||!l?s:s.toSorted((m,h)=>{const g=l(m,h);return u==="asc"?g:-g})},[s,c,u,n])}function T(){const s=ce(),n=ie(),c=(t,y={})=>B({queryKey:["users",{...t}],queryFn:async()=>s.get("users",{params:t}),...y}),u=j({mutationKey:["users","new"],mutationFn:async t=>s.post("users",t),onSuccess:async()=>n.invalidateQueries({queryKey:["users"]})}),l=j({mutationKey:["users","edit"],mutationFn:async t=>s.put("users",t),onSuccess:async()=>n.invalidateQueries({queryKey:["users"]})}),m=j({mutationKey:["users","remove"],mutationFn:async t=>s.delete("users",{params:t}),onSuccess:async()=>n.invalidateQueries({queryKey:["users"]})}),h=j({mutationKey:["users","lock"],mutationFn:async t=>s.post("users/lock",t),onSuccess:async()=>n.invalidateQueries({queryKey:["users"]})}),g=j({mutationKey:["users","unlock"],mutationFn:async t=>s.post("users/unlock",t),onSuccess:async()=>n.invalidateQueries({queryKey:["users"]})}),b=(t,y={})=>B({queryKey:["groups",(t==null?void 0:t.computer_id)??""],queryFn:async()=>{if(!t)throw new Error("Missing required parameters");return s.get(`computers/${t.computer_id}/groups`)},...y}),x=(t,y={})=>B({queryKey:["userGroups",(t==null?void 0:t.computer_id)??"",(t==null?void 0:t.username)??""],queryFn:async()=>{if(!t)throw new Error("Missing required parameters");return s.get(`computers/${t.computer_id}/users/${t.username}/groups`)},...y}),i=j({mutationKey:["groups","add"],mutationFn:async t=>s.post(`computers/${t.computer_id}/usergroups/update_bulk`,t),onSuccess:async()=>n.invalidateQueries({queryKey:["users"]})}),o=j({mutationKey:["groups","remove"],mutationFn:async t=>s.post(`computers/${t.computer_id}/usergroups/update_bulk`,t),onSuccess:async()=>n.invalidateQueries({queryKey:["users"]})});return{getUsersQuery:c,getGroupsQuery:b,getUserGroupsQuery:x,createUserQuery:u,removeUserQuery:m,editUserQuery:l,lockUserQuery:h,unlockUserQuery:g,addUserToGroupQuery:i,removeUserFromGroupQuery:o}}const Ce="_actions_1l3g0_1",Ne={actions:Ce},z=()=>{const{instanceId:s}=Q(),n=H(),{closeSidePanel:c}=F(),{createUserQuery:u,getGroupsQuery:l}=T(),m=Number(s),{mutateAsync:h}=u,{data:g,isLoading:b}=l({computer_id:m}),i=((g==null?void 0:g.data.groups)??[]).map(t=>({label:t.name,value:t.name})),o=ue({initialValues:{name:"",username:"",password:"",confirmPassword:"",requirePasswordReset:!1,location:"",homePhoneNumber:"",workPhoneNumber:"",primaryGroupValue:""},validationSchema:le().shape({name:k().required("This field is required"),username:k().required("This field is required"),password:k().required("This field is required"),confirmPassword:k().required("This field is required").oneOf([de("password"),""],"Passwords must match"),location:k(),homePhoneNumber:k(),workPhoneNumber:k(),primaryGroupValue:k().required("This field is required")}),onSubmit:async t=>{try{await h({computer_ids:[m],name:t.name,username:t.username,password:t.password,require_password_reset:t.requirePasswordReset,location:t.location,home_phone:t.homePhoneNumber,work_phone:t.workPhoneNumber,primary_groupname:t.primaryGroupValue}),c()}catch(y){n(y)}}});return e.jsxs(r.Form,{noValidate:!0,onSubmit:o.handleSubmit,name:"add-new-user",children:[e.jsx(r.Input,{type:"text",label:"Username",autoComplete:"new-username",required:!0,error:o.touched.username&&o.errors.username?o.errors.username:void 0,...o.getFieldProps("username")}),e.jsx(r.Input,{type:"text",label:"Name",required:!0,error:o.touched.name&&o.errors.name?o.errors.name:void 0,...o.getFieldProps("name")}),e.jsx(r.Input,{type:"password",label:"Passphrase",autoComplete:"new-password",required:!0,error:o.touched.password&&o.errors.password?o.errors.password:void 0,...o.getFieldProps("password")}),e.jsx(r.Input,{type:"password",label:"Confirm passphrase",autoComplete:"new-password",required:!0,error:o.touched.confirmPassword&&o.errors.confirmPassword?o.errors.confirmPassword:void 0,...o.getFieldProps("confirmPassword")}),e.jsx(r.Input,{type:"checkbox",label:"Require passphrase reset",help:"User must change password at first login.",...o.getFieldProps("requirePasswordReset"),checked:o.values.requirePasswordReset}),e.jsx(r.Select,{label:"Primary Group",disabled:b,options:[{label:"Select",value:""},...i],...o.getFieldProps("primaryGroupValue"),error:o.touched.primaryGroupValue&&o.errors.primaryGroupValue?o.errors.primaryGroupValue:void 0}),e.jsx(r.Input,{type:"text",label:"Location",error:o.touched.location&&o.errors.location?o.errors.location:void 0,...o.getFieldProps("location")}),e.jsx(r.Input,{type:"text",label:"Home phone",error:o.touched.homePhoneNumber&&o.errors.homePhoneNumber?o.errors.homePhoneNumber:void 0,...o.getFieldProps("homePhoneNumber")}),e.jsx(r.Input,{type:"text",label:"Work phone",error:o.touched.workPhoneNumber&&o.errors.workPhoneNumber?o.errors.workPhoneNumber:void 0,...o.getFieldProps("workPhoneNumber")}),e.jsx(ke,{submitButtonDisabled:o.isSubmitting,submitButtonText:"Add user"})]})},Ie=p.lazy(async()=>$(()=>import("./index-DUBLScBU.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13]))),ve=({selectedUsers:s,handleClearSelection:n,sidePanel:c=!1})=>{const[u,l]=p.useState(!1),{instanceId:m}=Q(),h=H(),{notify:g}=me(),{setSidePanelContent:b,closeSidePanel:x}=F(),{removeUserQuery:i,lockUserQuery:o,unlockUserQuery:t}=T(),[y,a]=p.useState(!1),[S,f]=p.useState(!1),[N,I]=p.useState(!1),{mutateAsync:w,isPending:U}=i,{mutateAsync:Y,isPending:D}=o,{mutateAsync:W,isPending:M}=t,J=Number(m),d=s.length===1?s[0]:void 0,{locked:X,unlocked:Z}=fe(s),P=async(_,q)=>{try{await _({computer_ids:[J],usernames:je(s),delete_home:q==="removed"?u:void 0}),n&&n(),x(),g.success({message:`Successfully requested to be ${q}`})}catch(ae){h(ae)}},ee=async()=>{await P(Y,"locked")},se=async()=>{await P(W,"unlocked")},te=async()=>{await P(w,"removed")},oe=()=>{b("Add new user",e.jsx(z,{}))},ne=_=>{b("Edit user",e.jsx(p.Suspense,{fallback:e.jsx(v,{}),children:e.jsx(Ie,{user:_})}))},re=()=>{l(_=>!_)};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:L("p-panel__controls u-no-padding--top",{"u-no-margin--left":c}),children:[!c&&e.jsxs(r.Button,{className:L("u-no-margin--right",{"u-no-margin--bottom":!c}),type:"button",hasIcon:!0,onClick:oe,children:[e.jsx(r.Icon,{name:r.ICONS.plus}),e.jsx("span",{children:"Add user"})]}),e.jsx(Se,{collapseFrom:"lg",buttons:[((d==null?void 0:d.enabled)||!c)&&e.jsxs(r.Button,{hasIcon:!0,type:"button",disabled:Z===0,onClick:()=>{a(!0)},children:[e.jsx(r.Icon,{name:"lock-locked"}),e.jsx("span",{children:"Lock"})]},"lock"),(!(d!=null&&d.enabled)||!c)&&e.jsxs(r.Button,{hasIcon:!0,type:"button",disabled:X===0,onClick:()=>{f(!0)},children:[e.jsx(r.Icon,{name:"lock-unlock"}),e.jsx("span",{children:"Unlock"})]},"unlock"),c&&d&&e.jsxs(r.Button,{className:L("p-segmented-control__button has-icon",{"u-no-margin--bottom":!c}),type:"button",onClick:()=>{ne(d)},children:[e.jsx(r.Icon,{name:"edit"}),e.jsx("span",{children:"Edit"})]},"edit"),e.jsxs(r.Button,{hasIcon:!0,type:"button",disabled:s.length===0,onClick:()=>{I(!0)},children:[e.jsx(r.Icon,{name:r.ICONS.delete}),e.jsx("span",{children:"Delete"})]},"delete")]})]}),y&&e.jsx(r.ConfirmationModal,{title:`Lock ${d?`user ${d.username}`:`${s.length} users`}`,close:()=>{a(!1)},confirmButtonLabel:"Lock",confirmButtonAppearance:"positive",confirmButtonLoading:D,confirmButtonDisabled:D,onConfirm:ee,children:G({user:d,selectedUsers:s,userAction:R.Lock})}),S&&e.jsx(r.ConfirmationModal,{title:`Unlock ${d?`user ${d.username}`:`${s.length} users`}`,close:()=>{f(!1)},confirmButtonLabel:"Unlock",confirmButtonAppearance:"positive",confirmButtonLoading:M,confirmButtonDisabled:M,onConfirm:se,children:G({user:d,selectedUsers:s,userAction:R.Unlock})}),N&&e.jsx(r.ConfirmationModal,{title:`Delete ${d?d.username:"users"}`,close:()=>{I(!1)},confirmButtonLabel:"Delete",confirmButtonAppearance:"negative",confirmButtonLoading:U,confirmButtonDisabled:U,onConfirm:te,children:e.jsxs("div",{children:[e.jsx("p",{className:"u-no-margin--bottom",children:d?`This will delete user ${d.username}. You can delete this user's home folders at the same time.`:"This will delete selected users. You can delete their home folders as well."}),e.jsx(r.Input,{label:"Delete the home folders as well",type:"checkbox",checked:u,onChange:re})]})})]})},Fe=(s,n)=>s.filter(c=>n.includes(c.uid)),Pe=({selected:s,handleClearSelection:n,users:c})=>e.jsxs(e.Fragment,{children:[e.jsx(we,{actions:e.jsx("div",{className:Ne.actions,children:e.jsx(ve,{handleClearSelection:n,selectedUsers:Fe(c,s)})})}),e.jsx(pe,{filtersToDisplay:["search"]})]}),C={username:"username",status:"status",name:"name",uid:"uid"},Be={username:(s,n)=>s.username.localeCompare(n.username),status:(s,n)=>Number(s.enabled)-Number(n.enabled),name:(s,n)=>(s.name||"").localeCompare(n.name||""),uid:(s,n)=>s.uid-n.uid},Le="_status_xcrdk_1",Ae="_statusCell_xcrdk_7",V={status:Le,statusCell:Ae},Ee=p.lazy(async()=>$(()=>import("./index-DUBLScBU.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13]))),Oe=p.lazy(async()=>$(()=>import("./index-CUWyWL4h.js"),__vite__mapDeps([14,1,2,3,4,5,8,9,10,11,12,13]))),Qe=({users:s,selected:n,setSelected:c})=>{const{setPageParams:u,sortBy:l,sort:m}=O(),{setSidePanelContent:h}=F();K("sortBy",Object.values(C)),K("sort",["asc","desc"]);const g=a=>{h("Edit user",e.jsx(p.Suspense,{fallback:e.jsx(v,{}),children:e.jsx(Ee,{user:a})}))},b=a=>{h("User details",e.jsx(p.Suspense,{fallback:e.jsx(v,{}),children:e.jsx(Oe,{user:a})}))},x=()=>{c(n.length!==0?[]:s.map(({uid:a})=>a))},i=a=>{n.includes(a)?c(n.filter(S=>S!==a)):c([...n,a])},o=p.useMemo(()=>[{className:"checkbox-column",content:e.jsx(r.CheckboxInput,{label:e.jsx("span",{className:"u-off-screen",children:"Toggle all"}),labelClassName:"u-no-margin--bottom u-no-padding--top",onChange:x,checked:s.length>0&&n.length===s.length,indeterminate:n.length>0&&n.length<s.length,disabled:s.length===0})},{sortKey:C.username,content:"username"},{content:"status",sortKey:C.status},{content:"uid",sortKey:C.uid},{content:"full name",sortKey:C.name},{content:A.Header,className:A.className}],[s,n]),t=p.useMemo(()=>s.map(a=>({columns:[{accessor:"checkbox",className:"checkbox-column",content:e.jsx(r.CheckboxInput,{inline:!0,label:e.jsxs("span",{className:"u-off-screen",children:["Select user ",a.username]}),disabled:s.length===0,checked:n.includes(a.uid),onChange:()=>{i(a.uid)}})},{content:e.jsx(r.Button,{type:"button",appearance:"link",className:"u-no-margin--bottom u-no-padding--top",onClick:()=>{b(a)},"aria-label":`Show details of user ${a.username}`,children:a.username}),role:"rowheader"},{className:V.statusCell,content:e.jsx("div",{className:V.status,children:a.enabled?e.jsxs(e.Fragment,{children:[e.jsx(r.Icon,{name:"lock-unlock"}),e.jsx("span",{children:"Unlocked"})]}):e.jsxs(e.Fragment,{children:[e.jsx(r.Icon,{name:"lock-locked-active"}),e.jsx("span",{children:"Locked"})]})})},{content:a.uid},{content:a.name||e.jsx(he,{})},{className:A.className,content:e.jsx(ge,{toggleAriaLabel:`"${a.name}" user actions`,actions:[{icon:"edit",label:"Edit","aria-label":`Edit "${a.name}" user`,onClick:()=>{g(a)}}]})}]})),[s,n]),y=a=>{if(c([]),!a){u({sort:null,sortBy:""});return}u({sort:a===l&&m==="asc"?"desc":"asc",sortBy:a})};return e.jsx(r.MainTable,{headers:o,rows:t,onUpdateSort:y,defaultSort:l,defaultSortDirection:Ue(m),sortable:!0,emptyStateMsg:"No users available"})},$e=(s,n)=>s?n.filter(({username:c,name:u})=>{const l=u==null?void 0:u.toUpperCase().includes(s.toUpperCase()),m=c.toUpperCase().includes(s.toUpperCase());return l||m}):n,Te="_link_1wvsk_1",De={link:Te},Me=()=>{const[s,n]=p.useState([]),{instanceId:c,childInstanceId:u}=Q(),{search:l,currentPage:m,pageSize:h}=O(),{setSidePanelContent:g}=F(),{getUsersQuery:b}=T(),x=Number(u??c),{data:i,isLoading:o}=b({computer_id:x,limit:E}),t=(i==null?void 0:i.data.results)??[],y=_e({data:t,sortFunctions:Be}),a=$e(l,y),S=(w,U)=>a.slice(U,U+w),f=p.useMemo(()=>S(h,(m-1)*h),[l,a,m,h]),N=()=>{n([])},I=()=>{g("Add new user",e.jsx(z,{}))};return e.jsxs(e.Fragment,{children:[!l&&o&&e.jsx(v,{}),!o&&!l&&(!i||i.data.results.length===0)&&e.jsx(ye,{title:"No users found",body:"Add new users by clicking the button below.",icon:"connected",cta:[e.jsx(r.Button,{type:"button",appearance:"positive",onClick:I,children:"Add user"},"empty-state-add-new-user")]}),(l||!o&&f.length>0)&&e.jsxs(e.Fragment,{children:[e.jsx(Pe,{selected:s,handleClearSelection:N,users:f}),(i==null?void 0:i.data.count)&&i.data.count>E&&e.jsx(r.Notification,{severity:"caution",title:`Fetched ${E} out of ${i==null?void 0:i.data.count} users`,children:e.jsxs("span",{children:["The number of requested users is too high. Please"," ",e.jsx(be,{to:"https://support-portal.canonical.com/",className:De.link,children:"contact our support team."})]})}),e.jsx(Qe,{selected:s,setSelected:w=>{n(w)},users:f})]}),e.jsx(xe,{handleClearSelection:N,totalItems:a.length,currentItemCount:f.length})]})},ze=Object.freeze(Object.defineProperty({__proto__:null,default:Me},Symbol.toStringTag,{value:"Module"}));export{ve as U,ze as i,T as u};
