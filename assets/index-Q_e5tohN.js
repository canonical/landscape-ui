import{t as K,f as R,v as x,c as T,y as k,z as W,r as A,B as D,k as H,H as L,h as $,j as e,d as o,a3 as z,u as q,G as V,e as B}from"./index-CNSDWj8Q.js";import{P as U,a as G,b as Y}from"./PageMain-C8MVZwda.js";import{d as J,s as _}from"./constants-DvWgdSYC.js";import{I as j}from"./InfoItem-Bt7JBIPo.js";import{u as O}from"./useFetchOld-BAAs34Op.js";import{M as X}from"./MultiSelectField-CqoYdMk0.js";import{g as Z}from"./formikErrors-Bw8iTXYS.js";import{R as ee}from"./ResponsiveTable-BXalKviy.js";import{u as se}from"./useGetTags-B_HL7bdb.js";import"./constants-CDnVvJTb.js";import"./NoData-6ZK9sV5u.js";import"./index-D-YBZSy_.js";import"./TablePagination-CFXNvqsZ.js";import"./TableFilterChips-06YfpJdc.js";import"./PageParamFilter-ChSwlZqZ.js";import"./TableFilter-2AKF5NjJ.js";import"./Truncated-Dtg97i8C.js";const F=s=>s?"Yes":"No";function S(){const s=K(),a=R(),n=O(),r=()=>T({queryKey:["alert"],queryFn:async()=>a.get("alerts")}),u=x({mutationKey:["alert","subscribe"],mutationFn:async c=>n.get("SubscribeToAlert",{params:c}),onSuccess:async()=>s.invalidateQueries({queryKey:["alert"]})}),d=x({mutationKey:["alert","unsubscribe"],mutationFn:async c=>n.get("UnsubscribeFromAlert",{params:c}),onSuccess:async()=>s.invalidateQueries({queryKey:["alert"]})}),m=x({mutationKey:["alert","associate"],mutationFn:async c=>n.get("AssociateAlert",{params:c}),onSuccess:async()=>s.invalidateQueries({queryKey:["alert"]})}),i=x({mutationKey:["alert","disassociate"],mutationFn:async c=>n.get("DisassociateAlert",{params:c}),onSuccess:async()=>s.invalidateQueries({queryKey:["alert"]})});return{getAlertsQuery:r,subscribeQuery:u,unsubscribeQuery:d,associateAlert:m,disassociateAlert:i}}const te="_footer_1qn3u_1",ae="_multiSelect_1qn3u_7",E={footer:te,multiSelect:ae},Q=(s,a)=>{const n=new Set(a);return s.filter(r=>!n.has(r))},M=({alert:s,availableTagOptions:a})=>{const n=k(),{notify:r}=W(),{associateAlert:u,disassociateAlert:d}=S(),m=A.useRef(null),{mutateAsync:i}=u,{mutateAsync:c}=d,p=s.all_computers?["All"]:s.tags,C=async({tags:l})=>{try{const b=Q(s.tags,l),h=Q(l,s.tags),w=l.includes("All"),P=s.all_computers&&!w;if(w)await i({name:s.alert_type,tags:void 0,all_computers:!0});else if(P)await Promise.all([i({name:s.alert_type,tags:l.filter(f=>f!=="All"),all_computers:!1}),c({name:s.alert_type,all_computers:!0})]);else{const f=[];h.length>0&&f.push(i({name:s.alert_type,tags:h,all_computers:!1})),b.length>0&&f.push(c({name:s.alert_type,tags:b,all_computers:!1})),await Promise.all(f)}r.success({title:"Alert tags updated",message:`You changed ${s.label}'s tags`})}catch(b){n(b)}},t=D({initialValues:{tags:p},validationSchema:H().shape({tags:L().of($())}),onSubmit:C}),y=t.values.tags.includes("All")?a.filter(({value:l})=>l!=="All"):void 0,v=t.values.tags.includes("All")?a:a.filter(({value:l})=>t.values.tags.includes(l)),I=l=>{const b=l.some(({value:h})=>h==="All")?["All"]:l.map(({value:h})=>h);t.setValues({tags:b})};A.useEffect(()=>{const l=m.current?.querySelector(".multi-select__condensed-text");l&&l.textContent.includes("All instances")&&(l.textContent="All instances")},[t.values.tags]);const N=()=>t.isSubmitting?!0:p.length===t.values.tags.length&&p.every(l=>t.values.tags.includes(l));return e.jsx(o.Form,{onSubmit:t.handleSubmit,noValidate:!0,children:e.jsx(X,{innerRef:m,required:!0,variant:"condensed",className:E.multiSelect,items:a,selectedItems:v,disabledItems:y,onItemsUpdate:I,placeholder:"Select tags",error:Z(t,"tags"),dropdownFooter:e.jsxs("div",{className:E.footer,children:[e.jsx(o.Button,{type:"button",dense:!0,small:!0,className:"u-no-margin--bottom",disabled:N(),onClick:()=>t.setFieldValue("tags",p),children:"Revert"}),e.jsx(o.Button,{type:"button",dense:!0,small:!0,appearance:"positive",className:"u-no-margin--bottom",disabled:N(),onClick:()=>t.submitForm(),children:"Save changes"})]})})})},le="_noWrap_1ld5g_19",ne="_alertsWrapper_1ld5g_23",re="_emailColumn_1ld5g_31",ie="_nameColumn_1ld5g_35",ce="_tags_1ld5g_39",g={switch:"_switch_1ld5g_1",noWrap:le,alertsWrapper:ne,emailColumn:re,nameColumn:ie,tags:ce},oe=s=>{const a={};switch(s.column.id){case"label":a.role="rowheader";break;case"subscribed":a["aria-label"]="Email";break;case"tags":a["aria-label"]="Tags";break;case"description":a["aria-label"]="Description";break}return a},ue=({alerts:s,availableTagOptions:a})=>{const n=z("(min-width: 620px)"),r=k(),{unsubscribeQuery:u,subscribeQuery:d}=S(),{user:m}=q(),{mutateAsync:i}=d,{mutateAsync:c}=u,p=async t=>{const y=t.subscribed?c:i;try{await y({alert_type:t.alert_type})}catch(v){r(v)}},C=A.useMemo(()=>[{accessor:"label",className:g.nameColumn,Header:"Name"},{Header:e.jsxs("div",{className:g.noWrap,children:[e.jsx("span",{children:"Email "}),m&&e.jsx(o.Tooltip,{position:"btm-left",message:`Enabling email notifications will send alerts to ${m.email}, associated with your account`,children:e.jsx(o.Icon,{name:"help"})})]}),accessor:"subscribed",className:g.emailColumn,Cell:({row:t})=>e.jsx("div",{className:g.switch,children:e.jsx(o.Switch,{label:F(t.original.subscribed),defaultChecked:t.original.subscribed,onChange:()=>p(t.original)})})},{accessor:"tags",Header:"Enabled for",className:g.tags,Cell:({row:{original:t}})=>e.jsx(M,{alert:t,availableTagOptions:a})},{Header:"Description",accessor:"description",Cell:({row:{original:t}})=>e.jsx(e.Fragment,{children:t.description})}],[s]);return n?e.jsx(ee,{columns:C,data:s,getCellProps:oe,emptyMsg:"No data available"}):s.map((t,y)=>e.jsxs(o.Row,{className:V("u-no-padding--left u-no-padding--right",g.alertsWrapper),children:[e.jsx(o.Col,{size:2,small:2,children:e.jsx(j,{label:"Name",value:t.label})}),e.jsx(o.Col,{size:2,small:2,children:e.jsx(j,{label:"Email",value:e.jsx("div",{className:g.switch,children:e.jsx(o.Switch,{label:F(t.subscribed),defaultChecked:t.subscribed,onChange:()=>p(t)})})})}),e.jsx(o.Col,{size:2,small:2,children:e.jsx(j,{label:"Enabled for",value:e.jsx(M,{alert:t,availableTagOptions:a})})}),e.jsx(o.Col,{size:2,small:2,children:e.jsx(j,{label:"Description",value:t.description})})]},y))},me=({alerts:s,availableTagOptions:a})=>{const{user:n}=q(),r=n?.accounts.find(u=>u.name===n.current_account);return e.jsx("div",{className:J.item,children:e.jsxs("div",{className:_.card,children:[e.jsx("div",{className:_.header,children:e.jsx("p",{className:_.title,children:r?.title||"Alerts"})}),e.jsx("div",{className:_.content,children:e.jsx(ue,{alerts:s,availableTagOptions:a})})]})})},Ee=()=>{const{getAlertsQuery:s}=S(),{tags:a}=se(),{data:n,isLoading:r}=s(),u=A.useMemo(()=>n?.data.filter(i=>!i.alert_type.toUpperCase().includes("LICENSE"))??[],[n]),d=a.map(i=>({label:i,value:i,group:"Tags"}))??[],m=[{label:"All instances",value:"All"},...d];return e.jsxs(U,{children:[e.jsx(G,{title:"Alerts"}),e.jsxs(Y,{children:[r&&e.jsx(B,{}),!r&&u&&e.jsx(me,{alerts:u,availableTagOptions:m})]})]})};export{Ee as default};
