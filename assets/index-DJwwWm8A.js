import{b as j,g as R,h as S,v as C,w as u,x as F,y as k,z as h,o as T,H as N,n as B,p as P,$ as D,q as V,j as t,d as a,F as z}from"./index-D5Rc4jDZ.js";import{u as E}from"./index-Bzv_we7k.js";import{U}from"./constants-Dwl1JGyb.js";import"./PageMain-C4jpM5QQ.js";import"./useGetInstance-BKe7w4Tn.js";import"./useUsns-CrVdNnbS.js";import"./constants-Dxoi_PrG.js";import"./SingleInstanceTabs.module-Cm1BYFZQ.js";const $=()=>{const r=j(),s=R(),{isPending:d,mutateAsync:c}=S({mutationFn:async({id:l,...o})=>r.post(`computers/${l}/restart`,o),onSuccess:async()=>s.invalidateQueries({queryKey:["instances"]})});return{restartInstance:c,isRestartingInstance:d}},G=C().shape({deliver_immediately:u(),randomize_delivery:u(),deliver_delay_window:k().min(0,"Delivery delay must be greater than or equal to 0"),deliver_after:F().test({test:r=>r?h(r).isValid():!0,message:"You have to enter a valid date and time"}),upgrade_and_restart:u()}),L={deliver_immediately:!0,randomize_delivery:!1,deliver_delay_window:0,deliver_after:"",upgrade_and_restart:!1},q="To save patches, upgrade your kernel and then Restart. If you Restart without upgrading, you will lose patches until Livepatch automatically applies them again.",M="_radioGroup_1yu2c_1",O="_marginTop_1yu2c_6",m={radioGroup:M,marginTop:O},ee=({showNotification:r,instanceName:s,newKernelVersionId:d})=>{const c=T(),{instanceId:l}=N(),{closeSidePanel:o}=B(),{notify:p}=P(),{upgradeKernelQuery:f}=E(),{openActivityDetails:y}=D(),{restartInstance:b,isRestartingInstance:v}=$(),{mutateAsync:w,isPending:_}=f,e=V({initialValues:L,validationSchema:G,onSubmit:async i=>{try{i.upgrade_and_restart?await x():await A(i)}catch(n){c(n)}}}),g=async i=>{const n=i.currentTarget.value==="true";await e.setFieldValue("deliver_immediately",n),n||await e.setFieldValue("deliver_after",h().toISOString().slice(0,16))},I=async()=>{await e.setFieldValue("upgrade_and_restart",!0),e.handleSubmit()},x=async()=>{const{data:i}=await w({id:Number(l),kernel_package_id:Number(d),reboot_after:!0});o(),p.success({title:`You queued kernel upgrade for "${s}"`,message:U,actions:[{label:"View details",onClick:()=>{y(i)}}]})},A=async i=>{const{data:n}=await b({id:Number(l),deliver_after:i.deliver_after,deliver_delay_window:i.deliver_delay_window});o(),p.success({title:`You queued "${s}" to be restarted.`,message:`Instance "${s}" will be restarted and is queued in Activities`,actions:[{label:"View details",onClick:()=>{y(n)}}]})};return t.jsxs(a.Form,{onSubmit:e.handleSubmit,children:[r&&t.jsx(a.Notification,{title:"Restart recommended",severity:"caution",children:q}),t.jsx("strong",{children:"Delivery time"}),t.jsxs("div",{className:m.radioGroup,children:[t.jsx(a.Input,{type:"radio",label:"As soon as possible",name:"deliver_immediately",value:"true",onChange:g,checked:e.values.deliver_immediately}),t.jsx(a.Input,{type:"radio",label:"Scheduled",name:"deliver_immediately",value:"false",onChange:g,checked:!e.values.deliver_immediately})]}),!e.values.deliver_immediately&&t.jsx(a.Input,{type:"datetime-local",label:"Deliver after",labelClassName:"u-off-screen",...e.getFieldProps("deliver_after"),error:e.touched.deliver_after&&e.errors.deliver_after?e.errors.deliver_after:void 0}),t.jsx("strong",{className:z(m.marginTop),children:"Randomise delivery over a time window"}),t.jsxs("div",{className:m.radioGroup,children:[t.jsx(a.Input,{type:"radio",label:"No",...e.getFieldProps("randomize_delivery"),onChange:async()=>{await e.setFieldValue("randomize_delivery",!1),await e.setFieldValue("deliver_delay_window",0)},checked:!e.values.randomize_delivery}),t.jsx(a.Input,{type:"radio",label:"Yes",...e.getFieldProps("randomize_delivery"),onChange:async()=>await e.setFieldValue("randomize_delivery",!0),checked:e.values.randomize_delivery})]}),e.values.randomize_delivery&&t.jsx(a.Input,{type:"number",inputMode:"numeric",min:0,label:"Delivery delay window",labelClassName:"u-off-screen",help:"Time in minutes",...e.getFieldProps("deliver_delay_window"),error:e.touched.deliver_delay_window&&e.errors.deliver_delay_window?e.errors.deliver_delay_window:void 0}),t.jsxs("div",{className:"form-buttons",children:[t.jsx(a.Button,{type:"button",appearance:"base",onClick:o,children:"Cancel"}),r&&d&&t.jsx(a.ConfirmationButton,{type:"button",confirmationModalProps:{title:"Upgrading kernel and restarting instance",children:t.jsx("p",{children:"Are you sure? This action will upgrade the kernel and restart the instance."}),confirmButtonLabel:"Upgrade and Restart",confirmButtonAppearance:"negative",confirmButtonLoading:_,confirmButtonDisabled:_,onConfirm:I},children:"Upgrade and Restart"}),t.jsx(a.ConfirmationButton,{type:"button",appearance:"negative",confirmationModalProps:{title:"Restarting instance",children:t.jsx("p",{children:"Are you sure? This action will restart the instance."}),confirmButtonLabel:"Restart",confirmButtonAppearance:"negative",confirmButtonLoading:v,confirmButtonDisabled:v,onConfirm:()=>{e.handleSubmit()}},children:"Restart"})]})]})};export{ee as default};
