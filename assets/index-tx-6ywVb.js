import{j as e,r as f,m as s,y as C,l as k,J as D,B as E,F as u,G as N,v as d,o as O,n as y,$ as T}from"./index-Dvy4ms_D.js";import{A as $}from"./AssociationBlock-BGURkm4x.js";import{t as F,u as L}from"./index-BwZuo0vb.js";import{S as B}from"./SidePanelFormButtons-BISe-rRz.js";import{u as G}from"./ScriptsTabs-CcH-04-B.js";import{g as m}from"./formikErrors-Bw8iTXYS.js";import"./index-BTfAVzTK.js";import{u as U}from"./useInstances-BfPjAVkM.js";import"./MultiSelectField-DCcFOjud.js";import"./HeaderWithSearch-Ca4sX-j3.js";import"./SidePanelFormButtons.module-D2P5PizG.js";import"./TruncatedCell-C1pVnlah.js";import"./SingleInstanceTabs.module-Cm1BYFZQ.js";const g=({label:n,value:a})=>e.jsxs("div",{children:[e.jsx("div",{className:"p-heading--1 u-no-padding--top u-no-margin--bottom",children:a}),e.jsx("div",{className:"p-text--x-small u-text--muted",children:n})]}),H="_example_16wh9_1",J="_table_16wh9_6",v={example:H,table:J},z=()=>{const[n,a]=f.useState(!1),p=()=>{a(!0)},o=()=>{a(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(s.Button,{type:"button",appearance:"base",className:"u-no-margin--bottom",hasIcon:!0,onClick:p,children:e.jsx(s.Icon,{name:s.ICONS.help})}),n&&e.jsxs(s.Modal,{title:"Cron job format",close:o,children:[e.jsxs("section",{children:[e.jsx("h1",{className:"p-text--small-caps",children:"Example"}),e.jsxs("div",{className:v.example,children:[e.jsx(g,{label:"Minute",value:"1"}),e.jsx(g,{label:"Hour",value:"*"}),e.jsx(g,{label:e.jsxs(e.Fragment,{children:["Day",e.jsx("br",{}),"(month)"]}),value:"2"}),e.jsx(g,{label:"Month",value:"1-3"}),e.jsx(g,{label:e.jsxs(e.Fragment,{children:["Day",e.jsx("br",{}),"(week)"]}),value:"*"})]}),e.jsx("p",{children:'"At minute 1 on day-of-month 2 in every month from January through March"'})]}),e.jsxs("section",{children:[e.jsx("h1",{className:"p-text--small-caps",children:"Accepted values"}),e.jsx(s.MainTable,{className:v.table,rows:[{columns:[{content:"* (asterisk)"},{content:"Any value"}]},{columns:[{content:", (comma)"},{content:"List separator"}]},{columns:[{content:"- (dash)"},{content:"Range"}]},{columns:[{content:"/ (slash)"},{content:"Step values"}]}]}),e.jsx(s.MainTable,{className:v.table,rows:[{columns:[{content:"Minute"},{content:"0-59"}]},{columns:[{content:"Hour"},{content:"0-23"}]},{columns:[{content:"Day of the month"},{content:"1-31"}]},{columns:[{content:"Month"},{content:"1-12 or JAN-DEC"}]},{columns:[{content:"Day of the week"},{content:"0-6 or SUN-SAT"}]}]})]})]})]})},Q=({touched:n,value:a,...p})=>{const o=f.useId();let x="",_="";try{const l=F(a.toString());x=`"${l.charAt(0).toUpperCase()}${l.slice(1)}"`}catch(l){if(!(l instanceof Error))return;_=l.message}return e.jsxs(e.Fragment,{children:[e.jsx("label",{htmlFor:o,children:"* Schedule"}),e.jsx(z,{}),e.jsx(s.Input,{id:o,type:"text",...p,help:x,value:a,error:n&&_,required:!0})]})},V="_description_1xonp_1",Y="_indent_1xonp_6",j={description:V,indent:Y},ce=({onSubmit:n,onSuccess:a,initialValues:p,disabledFields:o={},submitButtonText:x,submitting:_=!1})=>{const l=C(),{closeSidePanel:P}=k(),{isScriptsLoading:I,scripts:w}=G({listenToUrlParams:!1},{script_type:"v2"}),{scriptProfileLimits:c,isGettingScriptProfileLimits:M}=L(),{getInstancesQuery:A}=U(),r=D({initialValues:p,validateOnMount:!0,validationSchema:E().shape({interval:u().when("trigger_type",([t],i)=>t=="recurring"?i.required("This field is required").test({test:h=>{try{return F(h),!0}catch{return!1}}}):i),script_id:N().required("This field is required"),start_after:u().when("trigger_type",([t],i)=>t=="recurring"?i.required("This field is required").test({test:h=>d(h).utc(!0).isSameOrAfter(d()),message:"The start date must not be in the past."}):i),time_limit:N().required("This field is required"),timestamp:u().when("trigger_type",([t],i)=>t=="one_time"?i.required("This field is required").test({test:h=>d(h).utc(!0).isSameOrAfter(d()),message:"The date must not be in the past."}):i),title:u().required("This field is required"),trigger_type:u().required("This field is required"),username:u().required("This field is required")}),onSubmit:async t=>{if(!(!t.trigger_type||t.script_id==null)){try{switch(t.trigger_type){case"event":{await n({...t,script_id:t.script_id,trigger:{trigger_type:"event",event_type:"post_enrollment"}});break}case"one_time":{if(!t.timestamp)return;await n({...t,script_id:t.script_id,trigger:{trigger_type:"one_time",timestamp:t.timestamp,last_run:"",next_run:""}});break}case"recurring":{if(!t.interval||!t.start_after)return;await n({...t,script_id:t.script_id,trigger:{trigger_type:"recurring",interval:t.interval,start_after:t.start_after,last_run:"",next_run:""}});break}}}catch(i){l(i);return}P(),a(t)}}}),{data:b,isLoading:R}=A({query:r.values.all_computers?void 0:r.values.tags.map(t=>`tag:${t}`).join(" OR ")}),[S,q]=f.useState(!1);if(f.useEffect(()=>{if(!(!b||!c)){if(!r.values.tags.length&&!r.values.all_computers){q(!1);return}q(b.data.count>=c.max_num_computers)}},[b]),I||M)return e.jsx(O,{});if(c)return e.jsxs(e.Fragment,{children:[e.jsx(s.Input,{type:"text",label:"Name",required:!0,...r.getFieldProps("title"),error:m(r,"title")}),e.jsx(s.Select,{label:"Script",required:!0,options:[{hidden:!0},...w.map(t=>({label:t.title,value:t.id}))],...r.getFieldProps("script_id"),error:m(r,"script_id"),disabled:o.script_id,help:o.script_id&&"Scripts can't be replaced after the profile has been created."}),e.jsxs(s.Row,{className:"u-no-padding",children:[e.jsx(s.Col,{size:6,children:e.jsx(s.Input,{type:"text",label:"Run as user",required:!0,...r.getFieldProps("username"),error:m(r,"username")})}),e.jsx(s.Col,{size:6,children:e.jsx(s.Input,{type:"number",label:"Time limit (seconds)",required:!0,...r.getFieldProps("time_limit"),error:m(r,"time_limit")})})]}),e.jsx(s.CustomSelect,{label:"Trigger",required:!0,onChange:async t=>{await r.setFieldValue("trigger_type",t)},value:r.values.trigger_type,disabled:o.trigger_type,options:[{label:e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"u-no-padding--top u-no-margin--bottom",children:"Post enrollment"}),e.jsx("p",{className:y(j.description,"u-no-margin--bottom"),children:e.jsx("small",{children:"Run the script after a new instance is enrolled"})})]}),value:"event",text:"Post enrollment"},{label:e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"u-no-padding--top u-no-margin--bottom",children:"On a date"}),e.jsx("p",{className:y(j.description,"u-no-margin--bottom"),children:e.jsx("small",{children:"Run the script on a selected date"})})]}),value:"one_time",text:"On a date"},{label:e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"u-no-padding--top u-no-margin--bottom",children:"Recurring"}),e.jsx("p",{className:y(j.description,"u-no-margin--bottom"),children:e.jsx("small",{children:"Run the script on a recurring schedule"})})]}),value:"recurring",text:"Recurring"}],help:o.trigger_type&&"Trigger type can't be changed after the script is created."}),e.jsxs("div",{className:j.indent,children:[r.values.trigger_type=="one_time"&&e.jsx(s.Input,{type:"datetime-local",label:"Date",required:!0,min:d().utc(!0).format(T),...r.getFieldProps("timestamp"),error:m(r,"timestamp")}),r.values.trigger_type=="recurring"&&e.jsxs(e.Fragment,{children:[e.jsx(s.Input,{type:"datetime-local",label:"Start date",required:!0,min:d().utc(!0).format(T),...r.getFieldProps("start_after"),error:m(r,"start_after")}),e.jsxs(s.Notification,{severity:"caution",children:["There is a minimum interval of"," ",e.jsxs("strong",{children:[c==null?void 0:c.min_interval," minutes"]})," ","between runs. Depending on the schedule, run times may be adjusted."]}),e.jsx(Q,{required:!0,touched:r.touched.interval,...r.getFieldProps("interval")})]})]}),S&&e.jsxs(s.Notification,{severity:"negative",inline:!0,title:"Associated instances limit reached:",children:["You've reached the limit of"," ",e.jsxs("strong",{children:[c.max_num_computers," associated instances"]}),". Decrease the number of associated instances."]}),e.jsx($,{formik:r}),e.jsx(B,{onSubmit:()=>{r.handleSubmit()},submitButtonDisabled:!r.isValid||_||S||R,submitButtonText:x})]})};export{ce as default};
