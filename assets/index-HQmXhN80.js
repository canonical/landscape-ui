import{i as z,k as K,m as N,n as l,t as W,J as m,o as X,l as Z,r as g,j as s,h as c}from"./index-yURGZBtd.js";import{u as ee,c as u}from"./index-DRFLVSxN.js";import{C as te}from"./CodeEditor-kB3ZaHo2.js";import{u as ie}from"./useRoles-C-294Oa-.js";import{S as ae}from"./SidePanelFormButtons-0z4hyvOE.js";import"./useFetchOld-B9cJ707T.js";import"./moment-C5S46NFB.js";import"./SidePanelFormButtons.module-yv6Qz3cN.js";const se={add:"Add script",copy:"Copy script",edit:"Save changes"},re={title:"",code:"",access_group:"",time_limit:300,username:"",attachments:{first:null,second:null,third:null,fourth:null,fifth:null},attachmentsToRemove:[]},pe=i=>{var _,S,y,x,F,j,A,C,T,V;const{closeSidePanel:P}=z(),B=K(),{getAccessGroupQuery:q}=ie(),{createScriptQuery:E,editScriptQuery:R,copyScriptQuery:$,getScriptCodeQuery:v,createScriptAttachmentQuery:Q,removeScriptAttachmentQuery:L}=ee(),{mutateAsync:O}=E,{mutateAsync:h}=R,{mutateAsync:k}=$,{mutateAsync:D}=Q,{mutateAsync:M}=L,G=N().shape({title:l().required("This field is required"),time_limit:W().required("This field is required"),code:l().test({name:"required",message:"This field is required",test:t=>i.action==="copy"||i.action==="edit"||!!t}),username:l(),access_group:l(),attachments:N().shape({first:m().nullable(),second:m().nullable(),third:m().nullable(),fourth:m().nullable(),fifth:m().nullable()}),attachmentsToRemove:X().of(l())}),f=async(t,a)=>{const r=[],o=[],w=[];for(const n of a)n&&(o.push(n.arrayBuffer()),w.push(n.name));const I=await Promise.all(o);for(let n=0;n<I.length;n++)r.push(D({script_id:t,file:`${w[n]}$$${u.Buffer.from(I[n]).toString("base64")}`}));await Promise.all(r)},e=Z({initialValues:re,validationSchema:G,onSubmit:async t=>{try{if(i.action==="add"){const a=await O({title:t.title,time_limit:t.time_limit,code:u.Buffer.from(t.code).toString("base64"),username:t.username,access_group:t.access_group});await f(a.data.id,Object.values(t.attachments))}else if(i.action==="edit"){const a=[],r=Object.values(t.attachments).filter(o=>o);for(const o of t.attachmentsToRemove)a.push(M({script_id:i.script.id,filename:o}));a.length?(await Promise.all([...a,h({script_id:i.script.id,title:t.title,time_limit:t.time_limit,code:u.Buffer.from(t.code).toString("base64"),username:t.username})]),r.length&&await f(i.script.id,r)):r.length?await Promise.all([h({script_id:i.script.id,title:t.title,time_limit:t.time_limit,code:u.Buffer.from(t.code).toString("base64"),username:t.username}),f(i.script.id,Object.values(t.attachments))]):await h({script_id:i.script.id,title:t.title,time_limit:t.time_limit,code:u.Buffer.from(t.code).toString("base64"),username:t.username})}else i.action==="copy"&&await k({script_id:i.script.id,destination_title:t.title,access_group:t.access_group});H()}catch(a){B(a)}}}),H=()=>{e.resetForm(),P()};g.useEffect(()=>{i.action!=="add"&&(i.action==="copy"?e.setFieldValue("access_group",i.script.access_group):i.action==="edit"&&(e.setFieldValue("title",i.script.title),e.setFieldValue("time_limit",i.script.time_limit),e.setFieldValue("username",i.script.username),e.setFieldValue("access_group",i.script.access_group)))},[i.action]);const{data:p,isFetching:b}=v({script_id:i.action==="edit"?i.script.id:0},{enabled:i.action==="edit"});g.useEffect(()=>{b||e.setFieldValue("code",(p==null?void 0:p.data)??"")},[b]);const{data:d}=q(),J=g.useMemo(()=>((d==null?void 0:d.data)??[]).map(({name:t,title:a})=>({label:a,value:t})),[d]),U=[s.jsx(c.Input,{type:"file",label:"First attachment",labelClassName:"u-off-screen",onChange:t=>{var a;e.setFieldValue("attachments.first",((a=t.target.files)==null?void 0:a[0])??null)},error:((_=e.touched.attachments)==null?void 0:_.first)&&((S=e.errors.attachments)==null?void 0:S.first)},"first"),s.jsx(c.Input,{type:"file",label:"Second attachment",labelClassName:"u-off-screen",onChange:t=>{var a;e.setFieldValue("attachments.second",((a=t.target.files)==null?void 0:a[0])??null)},error:((y=e.touched.attachments)==null?void 0:y.second)&&((x=e.errors.attachments)==null?void 0:x.second)},"second"),s.jsx(c.Input,{type:"file",label:"Third attachment",labelClassName:"u-off-screen",onChange:t=>{var a;e.setFieldValue("attachments.third",((a=t.target.files)==null?void 0:a[0])??null)},error:((F=e.touched.attachments)==null?void 0:F.third)&&((j=e.errors.attachments)==null?void 0:j.third)},"third"),s.jsx(c.Input,{type:"file",label:"Fourth attachment",labelClassName:"u-off-screen",onChange:t=>{var a;e.setFieldValue("attachments.fourth",((a=t.target.files)==null?void 0:a[0])??null)},error:((A=e.touched.attachments)==null?void 0:A.fourth)&&((C=e.errors.attachments)==null?void 0:C.fourth)},"fourth"),s.jsx(c.Input,{type:"file",label:"Fifth attachment",labelClassName:"u-off-screen",onChange:t=>{var a;e.setFieldValue("attachments.fifth",((a=t.target.files)==null?void 0:a[0])??null)},error:((T=e.touched.attachments)==null?void 0:T.fifth)&&((V=e.errors.attachments)==null?void 0:V.fifth)},"fifth")],Y=()=>{const t=U;if(i.action==="edit"){const a=i.script.attachments.filter(r=>!e.values.attachmentsToRemove.includes(r)).reverse();for(const r of a)t.unshift(s.jsxs("div",{children:[s.jsx("span",{children:r}),s.jsxs(c.Button,{hasIcon:!0,appearance:"base",className:"u-no-margin--bottom u-no-padding--left p-tooltip--top-center","aria-label":`Remove ${r} attachment`,onClick:()=>{e.setFieldValue("attachmentsToRemove",[...e.values.attachmentsToRemove,r])},children:[s.jsx("span",{className:"p-tooltip__message",children:"Remove"}),s.jsx("i",{className:"p-icon--delete"})]})]},r))}return t.slice(0,5)};return s.jsxs(c.Form,{onSubmit:e.handleSubmit,noValidate:!0,children:[s.jsx(c.Input,{type:"text",label:"Title",required:!0,...e.getFieldProps("title"),error:e.touched.title&&e.errors.title?e.errors.title:void 0}),(i.action==="add"||i.action==="edit")&&s.jsxs(s.Fragment,{children:[s.jsx(c.Input,{type:"number",label:"Time limit (seconds)",required:!0,...e.getFieldProps("time_limit"),error:e.touched.time_limit&&e.errors.time_limit?e.errors.time_limit:void 0}),s.jsx(te,{label:"Code",required:!0,onChange:t=>{e.setFieldValue("code",t??"")},value:e.values.code,error:e.touched.code&&e.errors.code?e.errors.code:void 0}),s.jsx(c.Input,{type:"text",label:"Run as user",...e.getFieldProps("username"),error:e.touched.username&&e.errors.username?e.errors.username:void 0})]}),s.jsx(c.Select,{label:"Access group",options:[{label:"Select access group",value:""},...J],...e.getFieldProps("access_group"),error:e.touched.access_group&&e.errors.access_group?e.errors.access_group:void 0}),(i.action==="add"||i.action==="edit")&&s.jsxs(s.Fragment,{children:[s.jsx("h5",{children:"List of attachments"}),s.jsx("p",{className:"u-text--muted",children:"Attachments that will be sent along with the script. You can attach up to 5 files, for a maximum of 1.00MB. Filenames must be unique. On the client, the attachments will be placed in the directory whose name is accessible through the environment variable LANDSCAPE_ATTACHMENTS. They'll be deleted once the script has been run."})]}),(i.action==="add"||i.action==="edit")&&Y(),s.jsx(ae,{submitButtonDisabled:e.isSubmitting,submitButtonText:se[i.action]})]})};export{pe as default};
