import{r as y,j as T,B as K,d as C}from"./index-CNSDWj8Q.js";import{g as D}from"./formikErrors-Bw8iTXYS.js";import{C as F}from"./CodeEditor-DBPYuwcp.js";import{Q as M,b as U,L as _,V as X,I as H,P as L,d as O,W as A,B as N,e as B,A as $,T as V,f as W,h as j,N as q,K as Q,i as Y,j as z,C as J,k as Z,l as ee}from"./InstancesPageActions-DL7_pmR1.js";import{S as te}from"./SidePanelFormButtons-DIizKTix.js";import{u as re}from"./useInstanceSearchHelpTerms-Djw2vq_i.js";import"./index-CySvbr4l.js";import"./index-D-YBZSy_.js";import"./NoData-6ZK9sV5u.js";import"./TablePagination-CFXNvqsZ.js";import"./TableFilterChips-06YfpJdc.js";import"./useFetchOld-BAAs34Op.js";import"./PageParamFilter-ChSwlZqZ.js";import"./TableFilter-2AKF5NjJ.js";import"./ResponsiveTable-BXalKviy.js";import"./ListTitle-BUruUKn1.js";import"./StaticLink-BEYCGcPv.js";import"./TruncatedCell-BMum6DLZ.js";import"./Truncated-Dtg97i8C.js";import"./useExpandableRow-B4jhRgod.js";import"./TextConfirmationModal-q88mH05g.js";import"./InfoGrid-3w5mqARw.js";import"./InfoItem-Bt7JBIPo.js";import"./SidePanelFormButtons.module-CcPyiogC.js";const ne=({label:e,value:t,onChange:n,onBlur:s,error:r=!1,required:i=!1,className:c,labelClassName:u,headerContent:a,options:o,languageId:p,terms:f,configureSearchLanguage:h})=>{const g=y.useCallback(d=>{f.length>0&&h(d,p,f)},[p,f,h]);return T.jsx(F,{label:e,value:t,onChange:n,onBlur:s,error:r,required:i,className:c,labelClassName:u,headerContent:a,language:p,monacoBeforeMount:g,options:{fixedOverflowWidgets:!0,suggestOnTriggerCharacters:!0,quickSuggestions:!0,...o}})},G=e=>H.test(e),se=e=>O.includes(e),ie=e=>A.includes(e),oe=e=>L.includes(e),ae=e=>B.includes(e),ue=e=>N.includes(e),ce=e=>_.includes(e),le=e=>X.includes(e),l=(e,t)=>`"${e}" ${t}`,de=(e,t,n,s)=>!!(!(e===t)||n||s),me=(e,t)=>{const n=e.toUpperCase();if(ce(n))return t===0&&(n==="AND"||n==="OR")?`"${n}" cannot start a query.`:void 0},pe=e=>{if(!$.includes(e))return l("alert",`has invalid value "${e}".`)},fe=e=>{if(!ae(e))return l("license-type",`has invalid value "${e}".`)},Ee=e=>{if(!ue(e))return l("has-pro-management",'must be "true", "false", "1", or "0".')},he=e=>{if(!["reboot","license"].includes(e))return l("needs",`has invalid value "${e}".`)},Te=e=>{const r="profile",i=e[1],c=e[2],u=e[3];if(!oe(i))return l(r,`has invalid profile type "${i}".`);if(!c||!c.trim())return l(r,"requires an ID.");if(!G(c))return l(r,"ID must be a number.");if(i==="security"||i==="wsl"){if(!u)return l(`${r}:${i}`,"requires a status.");if(i==="security"&&!se(u))return l(`${r}:${i}`,`has invalid security status "${u}".`);if(i==="wsl"&&!ie(u))return l(`${r}:${i}`,`has invalid WSL status "${u}".`)}},ge=(e,t)=>{if(!G(t))return l(e,"requires a number.")},Se=e=>{if(!e.trim())return l("annotation","key cannot be empty.")},ve=e=>{const s=e[0],r=e[1];if(!le(s))return l(s,"is not a valid query key.");if(!r||!r.trim())return l(s,"requires a value.");switch(s){case"alert":return pe(r);case"license-type":return fe(r);case"has-pro-management":return Ee(r);case"needs":return he(r);case"profile":return Te(e);case"annotation":return Se(r);case"id":case"contract":case"contract-expires-within-days":case"license-expires-within-days":return ge(s,r);default:return}},ye=(e,t)=>{if(!e.includes(":"))return me(e,t);const n=e.split(":");return ve(n)},b=(e,t=!1)=>{if(!e||!e.trim())return;const n=V.test(e),s=e.match(M)??[],r=s.length-1;for(let i=0;i<s.length;i++){if(!de(i,r,t,n))continue;const u=s[i].replace(U,""),a=ye(u,i);if(a)return a}},S=(e,t)=>!e||!e.trim()?"This field is required.":t==="typing"?b(e,!1):b(e,!0),k=new Set,I=new Set,R={},xe=e=>e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),Ce=e=>new RegExp(`\\b(${e})(?=:)`),be=(e,t,n,s)=>{const r=(a,o,p=!1)=>({label:a,kind:p?s.languages.CompletionItemKind.Keyword:s.languages.CompletionItemKind.EnumMember,insertText:a,range:n,detail:o}),i=(a,o)=>({label:`<${a}>`,kind:s.languages.CompletionItemKind.Text,insertText:`<${a}>`,range:n,detail:o});if(t===1)return L.map(a=>r(a,"Profile Type"));const u=e[1];if(t===2)return[i("profile_id",`ID for ${u}`)];if(t===3){if(u==="security")return O.map(a=>r(a,"Audit Result"));if(u==="wsl")return A.map(a=>r(a,"Compliance Status"))}return[]},ke=(e,t,n)=>{const s=(r,i)=>({label:`<${r}>`,kind:n.languages.CompletionItemKind.Text,insertText:`<${r}>`,range:t,detail:i});return e===1?[s("key","Annotation Key")]:e===2?[s("string","Value substring match")]:[]},v=(e,t,n,s)=>e.map(r=>({label:r,kind:s.languages.CompletionItemKind.EnumMember,insertText:r,range:n,detail:t})),Ie=(e,t,n)=>{const[s]=e,r=e.length-1;switch(s){case"profile":return be(e,r,t,n);case"alert":return r===1?v($,"Alert Type",t,n):[];case"license-type":return r===1?v(B,"License Type",t,n):[];case"needs":return r===1?v(["reboot","license"],"Requirement",t,n):[];case"has-pro-management":return r===1?v(N,"Boolean",t,n):[];case"annotation":return ke(r,t,n);default:return[]}},Re=(e,t,n)=>{const s=n.map(c=>c.trim()).filter(Boolean),r=Array.from(new Set(s));R[t]=r;const i=r.length>0?r.map(xe).join("|"):"NEVER_MATCH";k.has(t)||(e.languages.register({id:t}),k.add(t)),e.languages.setMonarchTokensProvider(t,{tokenizer:{root:[[W,"white"],[j,"keyword"],[Ce(i),"type.identifier"],[q,"number"],[Q,"type.identifier"],[Y,"string"],[z,"number"],[J,"delimiter"]]}}),I.has(t)||(e.languages.registerCompletionItemProvider(t,{triggerCharacters:[":"," ",'"'],provideCompletionItems(c,u){const a=c.getWordUntilPosition(u),o={startLineNumber:u.lineNumber,endLineNumber:u.lineNumber,startColumn:a.startColumn,endColumn:a.endColumn},p=c.getLineContent(u.lineNumber),f=u.column-1,m=(p.slice(0,f).match(Z)?.[1]??"").split(":");if(m.length>1)return{suggestions:Ie(m,o,e)};const P=(R[t]??[]).map(E=>({label:E,kind:e.languages.CompletionItemKind.Keyword,insertText:`${E}:`,range:o,detail:"Search term"})),w=_.map(E=>({label:E,kind:e.languages.CompletionItemKind.Operator,insertText:E,range:o,detail:"Logical operator"}));return{suggestions:[...P,...w]}}}),I.add(t))},_e="instance-search-query",et=({initialValues:e,onSubmit:t,mode:n,onBackButtonPress:s})=>{const r=re(),i=!!e.search?.trim(),c=i?S(e.search,"strict"):void 0,[u,a]=y.useState(c),o=K({initialValues:e,validationSchema:ee,enableReinitialize:!0,validateOnMount:!0,initialTouched:{title:!1,search:i},onSubmit:async d=>{await t(d)}}),p=y.useMemo(()=>Array.from(new Set(r.flatMap(({term:d})=>d.split(/\s+OR\s+/i).map(m=>m.split(":")[0]).filter(Boolean)))),[r]),f=()=>{o.setFieldTouched("search",!0,!1);const d=S(o.values.search,"strict");a(d)},h=async d=>{d.preventDefault();const m=S(o.values.search,"strict");a(m),!m&&o.handleSubmit()},g=o.isSubmitting||!o.values.search.trim()||!!o.errors.title;return T.jsxs(C.Form,{noValidate:!0,onSubmit:h,children:[T.jsx(C.Input,{type:"text",label:"Title",disabled:n==="edit",required:!0,...o.getFieldProps("title"),error:D(o,"title")}),T.jsx(ne,{label:"Search query",required:!0,value:o.values.search,onBlur:f,configureSearchLanguage:Re,onChange:d=>{const m=d??"";o.setFieldValue("search",m),o.setFieldTouched("search",!0,!1);const x=S(m,"typing");a(x)},error:o.touched.search?u:void 0,languageId:_e,terms:p,options:{wordWrap:"on",automaticLayout:!0,lineNumbers:"off",lineDecorationsWidth:0,lineNumbersMinChars:0}}),T.jsx(te,{submitButtonText:n==="create"?"Add saved search":"Save changes",submitButtonLoading:o.isSubmitting,submitButtonDisabled:g,hasBackButton:!!s,onBackButtonPress:s})]})};export{et as default};
