const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-DVJDkkPa.js","assets/index-DdVy3CIu.js","assets/index-DCq_vsqr.css","assets/SidePanelFormButtons-CKYzlbXP.js","assets/SidePanelFormButtons.module-D2P5PizG.js","assets/SidePanelFormButtons-JM1G8Sq6.css","assets/MultiSelectField-BiM8Lbq3.js","assets/MultiSelectField-GyNA33om.css","assets/TablePagination-DcRP3nto.js","assets/usePageParams-CcklzBaA.js","assets/TablePaginationBase-ZnL0qmAy.js","assets/TablePaginationBase-CJl3HN1X.css","assets/helpers-CLKhnhEx.js","assets/HeaderWithSearch-w77Jjk9W.js","assets/HeaderWithSearch-C2lwo0VI.css","assets/TableFilterChips-3QiSvy-H.js","assets/TableFilterChips-CHqetGbX.css","assets/NoData-Chqc7NTj.js","assets/output-DFRNcfG-.js","assets/index-By5ur2gA.js"])))=>i.map(i=>d[i]);
import{r as b,e as ee,b as se,c as k,d as A,o as L,p as V,f as P,s as te,h as oe,k as x,v as ne,j as e,g as r,q as re,m as w,n as F,_ as Q,E as ae,L as ie}from"./index-DdVy3CIu.js";import{u as K,T as ce}from"./TablePagination-DcRP3nto.js";import{u as T}from"./usePageParams-CcklzBaA.js";import{S as ue}from"./SidePanelFormButtons-CKYzlbXP.js";import{g as le,r as O,U as G,a as de}from"./helpers-CLKhnhEx.js";import{H as me}from"./HeaderWithSearch-w77Jjk9W.js";import{T as pe}from"./TableFilterChips-3QiSvy-H.js";import{N as he}from"./NoData-Chqc7NTj.js";import{g as ge}from"./output-DFRNcfG-.js";const E=5e3;function be({data:s,sortFunctions:n}){const{sortBy:i,sort:l}=T();return b.useMemo(()=>{const d=n[i];return!i||!l||!d?s:s.toSorted((m,p)=>{const h=d(m,p);return l==="asc"?h:-h})},[s,i,l,n])}function $(){const s=ee(),n=se(),i=(t,g={})=>A({queryKey:["users",{...t}],queryFn:async()=>s.get("users",{params:t}),...g}),l=k({mutationKey:["users","new"],mutationFn:async t=>s.post("users",t),onSuccess:async()=>n.invalidateQueries({queryKey:["users"]})}),d=k({mutationKey:["users","edit"],mutationFn:async t=>s.put("users",t),onSuccess:async()=>n.invalidateQueries({queryKey:["users"]})}),m=k({mutationKey:["users","remove"],mutationFn:async t=>s.delete("users",{params:t}),onSuccess:async()=>n.invalidateQueries({queryKey:["users"]})}),p=k({mutationKey:["users","lock"],mutationFn:async t=>s.post("users/lock",t),onSuccess:async()=>n.invalidateQueries({queryKey:["users"]})}),h=k({mutationKey:["users","unlock"],mutationFn:async t=>s.post("users/unlock",t),onSuccess:async()=>n.invalidateQueries({queryKey:["users"]})}),y=(t,g={})=>A({queryKey:["groups",(t==null?void 0:t.computer_id)??""],queryFn:async()=>{if(!t)throw new Error("Missing required parameters");return s.get(`computers/${t.computer_id}/groups`)},...g}),f=(t,g={})=>A({queryKey:["userGroups",(t==null?void 0:t.computer_id)??"",(t==null?void 0:t.username)??""],queryFn:async()=>{if(!t)throw new Error("Missing required parameters");return s.get(`computers/${t.computer_id}/users/${t.username}/groups`)},...g}),u=k({mutationKey:["groups","add"],mutationFn:async t=>s.post(`computers/${t.computer_id}/usergroups/update_bulk`,t),onSuccess:async()=>n.invalidateQueries({queryKey:["users"]})}),o=k({mutationKey:["groups","remove"],mutationFn:async t=>s.post(`computers/${t.computer_id}/usergroups/update_bulk`,t),onSuccess:async()=>n.invalidateQueries({queryKey:["users"]})});return{getUsersQuery:i,getGroupsQuery:y,getUserGroupsQuery:f,createUserQuery:l,removeUserQuery:m,editUserQuery:d,lockUserQuery:p,unlockUserQuery:h,addUserToGroupQuery:u,removeUserFromGroupQuery:o}}const ye="_actions_1l3g0_1",fe={actions:ye},R=()=>{const{instanceId:s}=L(),n=V(),{closeSidePanel:i}=P(),{createUserQuery:l,getGroupsQuery:d}=$(),m=Number(s),{mutateAsync:p}=l,{data:h,isLoading:y}=d({computer_id:m}),u=((h==null?void 0:h.data.groups)??[]).map(t=>({label:t.name,value:t.name})),o=te({initialValues:{name:"",username:"",password:"",confirmPassword:"",requirePasswordReset:!1,location:"",homePhoneNumber:"",workPhoneNumber:"",primaryGroupValue:""},validationSchema:oe().shape({name:x().required("This field is required"),username:x().required("This field is required"),password:x().required("This field is required"),confirmPassword:x().required("This field is required").oneOf([ne("password"),""],"Passwords must match"),location:x(),homePhoneNumber:x(),workPhoneNumber:x(),primaryGroupValue:x().required("This field is required")}),onSubmit:async t=>{try{await p({computer_ids:[m],name:t.name,username:t.username,password:t.password,require_password_reset:t.requirePasswordReset,location:t.location,home_phone:t.homePhoneNumber,work_phone:t.workPhoneNumber,primary_groupname:t.primaryGroupValue}),i()}catch(g){n(g)}}});return e.jsxs(r.Form,{noValidate:!0,onSubmit:o.handleSubmit,name:"add-new-user",children:[e.jsx(r.Input,{type:"text",label:"Username",autoComplete:"new-username",required:!0,error:o.touched.username&&o.errors.username?o.errors.username:void 0,...o.getFieldProps("username")}),e.jsx(r.Input,{type:"text",label:"Name",required:!0,error:o.touched.name&&o.errors.name?o.errors.name:void 0,...o.getFieldProps("name")}),e.jsx(r.Input,{type:"password",label:"Passphrase",autoComplete:"new-password",required:!0,error:o.touched.password&&o.errors.password?o.errors.password:void 0,...o.getFieldProps("password")}),e.jsx(r.Input,{type:"password",label:"Confirm passphrase",autoComplete:"new-password",required:!0,error:o.touched.confirmPassword&&o.errors.confirmPassword?o.errors.confirmPassword:void 0,...o.getFieldProps("confirmPassword")}),e.jsx(r.Input,{type:"checkbox",label:"Require passphrase reset",help:"User must change password at first login",...o.getFieldProps("requirePasswordReset"),checked:o.values.requirePasswordReset}),e.jsx(r.Select,{label:"Primary Group",disabled:y,options:[{label:"Select",value:""},...u],...o.getFieldProps("primaryGroupValue"),error:o.touched.primaryGroupValue&&o.errors.primaryGroupValue?o.errors.primaryGroupValue:void 0}),e.jsx(r.Input,{type:"text",label:"Location",error:o.touched.location&&o.errors.location?o.errors.location:void 0,...o.getFieldProps("location")}),e.jsx(r.Input,{type:"text",label:"Home phone",error:o.touched.homePhoneNumber&&o.errors.homePhoneNumber?o.errors.homePhoneNumber:void 0,...o.getFieldProps("homePhoneNumber")}),e.jsx(r.Input,{type:"text",label:"Work phone",error:o.touched.workPhoneNumber&&o.errors.workPhoneNumber?o.errors.workPhoneNumber:void 0,...o.getFieldProps("workPhoneNumber")}),e.jsx(ue,{submitButtonDisabled:o.isSubmitting,submitButtonText:"Add user"})]})},xe=b.lazy(async()=>Q(()=>import("./index-DVJDkkPa.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18]))),je=({selectedUsers:s,handleClearSelection:n,sidePanel:i=!1})=>{const[l,d]=b.useState(!1),{instanceId:m}=L(),p=V(),{notify:h}=re(),{setSidePanelContent:y,closeSidePanel:f}=P(),{removeUserQuery:u,lockUserQuery:o,unlockUserQuery:t}=$(),{mutateAsync:g,isPending:a}=u,{mutateAsync:_,isPending:j}=o,{mutateAsync:C,isPending:v}=t,S=Number(m),c=s.length===1?s[0]:void 0,{locked:D,unlocked:M}=le(s),B=async(U,q)=>{try{await U({computer_ids:[S],usernames:de(s),delete_home:q==="removed"?l:void 0}),n&&n(),f(),h.success({message:`Successfully requested to be ${q}`})}catch(Z){p(Z)}},H=async()=>{await B(_,"locked")},z=async()=>{await B(C,"unlocked")},Y=async()=>{await B(g,"removed")},W=()=>{y("Add new user",e.jsx(R,{}))},X=U=>{y("Edit user",e.jsx(b.Suspense,{fallback:e.jsx(F,{}),children:e.jsx(xe,{user:U})}))},J=()=>{d(U=>!U)};return e.jsxs("div",{className:w("p-panel__controls u-no-padding--top",{"u-no-margin--left":i}),children:[!i&&e.jsxs(r.Button,{className:w("u-no-margin--right",{"u-no-margin--bottom":!i}),type:"button",hasIcon:!0,onClick:W,children:[e.jsx(r.Icon,{name:r.ICONS.plus}),e.jsx("span",{children:"Add user"})]}),e.jsx("div",{className:"p-segmented-control",children:e.jsxs("div",{className:"p-segmented-control__list",children:[((c==null?void 0:c.enabled)||!i)&&e.jsxs(r.ConfirmationButton,{className:w("p-segmented-control__button has-icon",{"u-no-margin--bottom":!i}),type:"button",disabled:M===0,"aria-disabled":M===0,confirmationModalProps:{title:`Lock ${c?`user ${c.username}`:`${s.length} users`}`,children:O({user:c,selectedUsers:s,userAction:G.Lock}),confirmButtonLabel:"Lock",confirmButtonAppearance:"positive",confirmButtonLoading:j,confirmButtonDisabled:j,onConfirm:H},children:[e.jsx(r.Icon,{name:"lock-locked"}),e.jsx("span",{children:"Lock"})]}),(!(c!=null&&c.enabled)||!i)&&e.jsxs(r.ConfirmationButton,{className:w("p-segmented-control__button has-icon",{"u-no-margin--bottom":!i}),type:"button",disabled:D===0,"aria-disabled":D===0,confirmationModalProps:{title:`Unlock ${c?`user ${c.username}`:`${s.length} users`}`,children:O({user:c,selectedUsers:s,userAction:G.Unlock}),confirmButtonLabel:"Unlock",confirmButtonAppearance:"positive",confirmButtonLoading:v,confirmButtonDisabled:v,onConfirm:z},children:[e.jsx(r.Icon,{name:"lock-unlock"}),e.jsx("span",{children:"Unlock"})]}),i&&c&&e.jsxs(r.Button,{className:w("p-segmented-control__button has-icon",{"u-no-margin--bottom":!i}),type:"button",onClick:()=>{X(c)},children:[e.jsx(r.Icon,{name:"edit"}),e.jsx("span",{children:"Edit"})]}),e.jsxs(r.ConfirmationButton,{className:w("p-segmented-control__button has-icon",{"u-no-margin--bottom":!i}),type:"button",disabled:s.length===0,"aria-disabled":s.length===0,confirmationModalProps:{title:`Delete ${c?c.username:"users"}`,children:e.jsxs("div",{children:[e.jsx("p",{className:"u-no-margin--bottom",children:c?`This will delete user ${c.username}. You can delete this user's home folders at the same time.`:"This will delete selected users. You can delete their home folders as well."}),e.jsx(r.Input,{label:"Delete the home folders as well",type:"checkbox",checked:l,onChange:J})]}),confirmButtonLabel:"Delete",confirmButtonAppearance:"negative",confirmButtonLoading:a,confirmButtonDisabled:a,onConfirm:Y},children:[e.jsx(r.Icon,{name:r.ICONS.delete}),e.jsx("span",{children:"Delete"})]})]})})]})},ke=(s,n)=>s.filter(i=>n.includes(i.uid)),_e=({selected:s,handleClearSelection:n,users:i})=>e.jsxs(e.Fragment,{children:[e.jsx(me,{actions:e.jsx("div",{className:fe.actions,children:e.jsx(je,{handleClearSelection:n,selectedUsers:ke(i,s)})})}),e.jsx(pe,{filtersToDisplay:["search"]})]}),N={username:"username",status:"status",name:"name",uid:"uid"},we={username:(s,n)=>s.username.localeCompare(n.username),status:(s,n)=>Number(s.enabled)-Number(n.enabled),name:(s,n)=>(s.name||"").localeCompare(n.name||""),uid:(s,n)=>s.uid-n.uid},Se="_status_r5cf6_1",Ue="_statusCell_r5cf6_7",Ne="_actions_r5cf6_12",I={status:Se,statusCell:Ue,actions:Ne},Ce=b.lazy(()=>Q(()=>import("./index-DVJDkkPa.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18]))),ve=b.lazy(()=>Q(()=>import("./index-By5ur2gA.js"),__vite__mapDeps([19,1,2,17,8,9,10,11,3,4,5,12,13,14,15,16,18]))),Ie=({users:s,selected:n,setSelected:i})=>{const{setPageParams:l,sortBy:d,sort:m}=T(),{setSidePanelContent:p}=P();K("sortBy",Object.values(N)),K("sort",["asc","desc"]);const h=a=>{p("Edit user",e.jsx(b.Suspense,{fallback:e.jsx(F,{}),children:e.jsx(Ce,{user:a})}))},y=a=>{p("User details",e.jsx(b.Suspense,{fallback:e.jsx(F,{}),children:e.jsx(ve,{user:a})}))},f=()=>{i(n.length!==0?[]:s.map(({uid:a})=>a))},u=a=>{n.includes(a)?i(n.filter(_=>_!==a)):i([...n,a])},o=b.useMemo(()=>[{className:"checkbox-column",content:e.jsx(r.CheckboxInput,{label:e.jsx("span",{className:"u-off-screen",children:"Toggle all"}),labelClassName:"u-no-margin--bottom u-no-padding--top",onChange:f,checked:s.length>0&&n.length===s.length,indeterminate:n.length>0&&n.length<s.length,disabled:s.length===0})},{sortKey:N.username,content:"username"},{content:"status",sortKey:N.status},{content:"uid",sortKey:N.uid},{content:"full name",sortKey:N.name},{content:null,className:I.actions}],[s,n]),t=b.useMemo(()=>s.map(a=>({columns:[{accessor:"checkbox",className:"checkbox-column",content:e.jsx(r.CheckboxInput,{inline:!0,label:e.jsxs("span",{className:"u-off-screen",children:["Select user ",a.username]}),disabled:s.length===0,checked:n.includes(a.uid),onChange:()=>u(a.uid)})},{content:e.jsx(r.Button,{type:"button",appearance:"link",className:"u-no-margin--bottom u-no-padding--top",onClick:()=>y(a),"aria-label":`Show details of user ${a.username}`,children:a.username}),role:"rowheader"},{className:I.statusCell,content:e.jsx("div",{className:I.status,children:a.enabled?e.jsxs(e.Fragment,{children:[e.jsx(r.Icon,{name:"lock-unlock"}),e.jsx("span",{children:"Unlocked"})]}):e.jsxs(e.Fragment,{children:[e.jsx(r.Icon,{name:"lock-locked-active"}),e.jsx("span",{children:"Locked"})]})})},{content:a.uid},{content:a.name||e.jsx(he,{})},{className:I.actions,content:e.jsx(r.Tooltip,{message:"Edit",position:"btm-center",children:e.jsx(r.Button,{type:"button",small:!0,hasIcon:!0,appearance:"base",className:"u-no-margin--bottom u-no-padding--left","aria-label":`Edit ${a.name} profile`,onClick:()=>h(a),children:e.jsx(r.Icon,{name:"edit",className:"u-no-margin--left"})})})}]})),[s,n]),g=a=>{if(i([]),!a){l({sort:null,sortBy:""});return}l({sort:a===d&&m==="asc"?"desc":"asc",sortBy:a})};return e.jsx(r.MainTable,{headers:o,rows:t,onUpdateSort:g,defaultSort:d,defaultSortDirection:ge(m),sortable:!0,emptyStateMsg:"No users available"})},Fe=(s,n)=>s?n.filter(({username:i,name:l})=>{const d=l==null?void 0:l.toUpperCase().includes(s.toUpperCase()),m=i.toUpperCase().includes(s.toUpperCase());return d||m}):n,Pe="_link_1wvsk_1",Be={link:Pe},Ae=()=>{const[s,n]=b.useState([]),{instanceId:i,childInstanceId:l}=L(),{search:d,currentPage:m,pageSize:p}=T(),{setSidePanelContent:h}=P(),{getUsersQuery:y}=$(),f=Number(l??i),{data:u,isLoading:o}=y({computer_id:f,limit:E}),t=(u==null?void 0:u.data.results)??[],g=be({data:t,sortFunctions:we}),a=Fe(d,g),_=(S,c)=>a.slice(c,c+S),j=b.useMemo(()=>_(p,(m-1)*p),[d,a,m,p]),C=()=>{n([])},v=()=>{h("Add new user",e.jsx(R,{}))};return e.jsxs(e.Fragment,{children:[!d&&o&&e.jsx(F,{}),!o&&!d&&(!u||u.data.results.length===0)&&e.jsx(ae,{title:"No users found",body:"Add new users by clicking the button below",icon:"connected",cta:[e.jsx(r.Button,{type:"button",appearance:"positive",onClick:v,children:"Add user"},"empty-state-add-new-user")]}),(d||!o&&j.length>0)&&e.jsxs(e.Fragment,{children:[e.jsx(_e,{selected:s,handleClearSelection:C,users:j}),(u==null?void 0:u.data.count)&&u.data.count>E&&e.jsx(r.Notification,{severity:"caution",title:`Fetched ${E} out of ${u==null?void 0:u.data.count} users`,children:e.jsxs("span",{children:["The number of requested users is too high. Please"," ",e.jsx(ie,{to:"https://support-portal.canonical.com/",className:Be.link,children:"contact our support team."})]})}),e.jsx(Ie,{selected:s,setSelected:S=>n(S),users:j})]}),e.jsx(ce,{handleClearSelection:C,totalItems:a.length,currentItemCount:j.length})]})},Oe=Object.freeze(Object.defineProperty({__proto__:null,default:Ae},Symbol.toStringTag,{value:"Module"}));export{je as U,Oe as i,$ as u};
