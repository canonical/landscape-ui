import{f as E,t as q,v as M,b as X,A as Z,c as J,a5 as ee,k as G,H as O,l as B,af as te,h as b,y as U,q as w,z as $,B as D,j as e,d as o,U as W,an as se,a4 as ie,r as F,ag as ae,D as ne,R as oe,o as le,J as re,G as ce,e as ue}from"./index-CNSDWj8Q.js";import{W as de,a as pe}from"./index-D36MiFLv.js";import{b as Dt,c as Vt,d as Ht,e as Qt,u as zt,f as Yt}from"./index-D36MiFLv.js";import{d as V}from"./WslInstancesEmptyState-Lmf8S52Y.js";import{e as Xt,u as Zt}from"./WslInstancesEmptyState-Lmf8S52Y.js";import{A as H}from"./AssociationBlock-B4LnXWNE.js";import{C as me}from"./CodeEditor-DBPYuwcp.js";import{F as ge}from"./FileInput-DsRDkpd1.js";import{R as fe}from"./RadioGroup-BVZkBsDq.js";import{S as Q}from"./SidePanelFormButtons-DIizKTix.js";import{S as x}from"./SidePanel-ChyjtMJv.js";import{u as z}from"./useGetWslInstanceTypes-BrOE29s-.js";import{u as R}from"./useRoles-DYJzr0u4.js";import{g as m}from"./formikErrors-Bw8iTXYS.js";import{B as v}from"./Blocks-yjg-J-3E.js";import{I as p}from"./InfoGrid-3w5mqARw.js";import"./InstancesPageActions-DL7_pmR1.js";import{P as N}from"./ProfileAssociatedInstancesLink-Neer6jGU.js";import{P as he}from"./ProfileAssociationInfo-DMGjDKb4.js";import"./index-CySvbr4l.js";import{a as be}from"./TableFilterChips-06YfpJdc.js";import{L as xe}from"./constants-CDnVvJTb.js";import{N as Ie}from"./NoData-6ZK9sV5u.js";import{R as ye}from"./ResponsiveTable-BXalKviy.js";import{S as Pe}from"./StaticLink-BEYCGcPv.js";import{T as je}from"./TruncatedCell-BMum6DLZ.js";import{u as Se}from"./useGetInstances-rIFBd_bT.js";import{u as _e}from"./useExpandableRow-B4jhRgod.js";import{u as Te}from"./useSelection-BsZpRomB.js";import"./PageMain-C8MVZwda.js";import"./useGetWslLimits-BVyD1a37.js";import"./HeaderWithSearch-D2tNhOlz.js";import"./constants-cpRdwKHL.js";import"./ListTitle-BUruUKn1.js";import"./TextConfirmationModal-q88mH05g.js";import"./table-CdFwMAPu.js";import"./PageParamFilter-ChSwlZqZ.js";import"./TableFilter-2AKF5NjJ.js";import"./MultiSelectField-CqoYdMk0.js";import"./useGetTags-B_HL7bdb.js";import"./SidePanelFormButtons.module-CcPyiogC.js";import"./useFetchOld-BAAs34Op.js";import"./InfoItem-Bt7JBIPo.js";import"./Truncated-Dtg97i8C.js";import"./index-D-YBZSy_.js";import"./TablePagination-CFXNvqsZ.js";const Fe=()=>{const t=E(),i=q(),{isPending:s,mutateAsync:l}=M({mutationFn:async u=>t.post("child-instance-profiles",u),onSuccess:async()=>i.invalidateQueries({queryKey:["wslProfiles"]})});return{isAddingWslProfile:s,addWslProfile:l}},ve=()=>{const t=q(),i=X.create({baseURL:Z}),{isPending:s,mutateAsync:l}=M({mutationFn:async({name:u,...g})=>i.patch(`child-instance-profiles/${u}`,g),onSuccess:async()=>t.invalidateQueries({queryKey:["wslProfiles"]})});return{editWslProfile:l,isEditingWslProfile:s}},we=({profile_name:t},i={})=>{const s=E(),{data:l,isPending:u,error:g}=J({queryKey:["wslProfile",t],queryFn:async({signal:I})=>s.get(`child-instance-profiles/${t}`,{signal:I}),...i});return{wslProfile:l?.data,wslProfileError:g,isGettingWslProfile:u}},Ce=1,Y=[{label:"Select",value:""},{label:"From a file",value:"file"},{label:"Plain text",value:"text"}],Le="You can use a cloud-init configuration YAML file under 1MB to register new WSL instances. cloud-init streamlines the setup by automating installation and configuration tasks.",We=[/^ubuntu$/,/^ubuntu-preview$/,/^ubuntu-[0-9]{2}\.[0-9]{2}$/],Re={title:"",access_group:ee,description:"",instanceType:"",customImageName:"",rootfsImage:"",cloudInitType:"",cloudInit:null,all_computers:!1,tags:[],only_landscape_created:!1},K=t=>{const i=new Blob([t],{type:"application/x-yaml"});return new File([i],"myFile.yaml",{type:"application/x-yaml"})},Ae=()=>G().shape({title:b().required("This field is required"),access_group:b().required("This field is required"),description:b().required("This field is required"),instanceType:b().required("This field is required"),rootfsImage:b().when("instanceType",{is:"custom",then:t=>t.required("This field is required"),otherwise:t=>t.notRequired()}),customImageName:b().when("instanceType",{is:"custom",then:t=>t.required("This field is required").test("not-match-reserved-patterns","Instance name cannot match 'ubuntu', 'ubuntu-preview', or 'ubuntu-<dd>.<dd>'",i=>!We.some(s=>s.test(i.toLowerCase()))),otherwise:t=>t.notRequired()}),cloudInitType:b(),cloudInit:te().nullable().when("cloudInitType",{is:t=>t==="file"||t==="text",then:t=>t.required("This field is required").test("file-size","File size must be less than 1MB",i=>(typeof i=="string"&&(i=K(i)),i?i.size===void 0?!1:i.size<=Ce*1024*1024:!0)),otherwise:t=>t.notRequired()}),all_computers:B(),tags:O().of(b())}),Ne=t=>{if(t)return new Promise((i,s)=>{const l=new FileReader;l.readAsDataURL(t),l.onload=()=>{i(l.result)},l.onerror=u=>{s(u)}})},ke=async t=>{if(t===null)return;let i;typeof t=="string"?i=K(t):i=t;const s=await Ne(i);return s?s.split(",")[1]:void 0},Ee="_block_tz139_1",qe={block:Ee},Mt=()=>{const t=U(),{createPageParamsSetter:i}=w(),{notify:s}=$(),{getAccessGroupQuery:l}=R(),{addWslProfile:u}=Fe(),{data:g}=l(),{isGettingWslInstanceTypes:I,wslInstanceTypes:y}=z(),P=y.map(({label:n,name:d})=>({label:n,value:d}))||[],j=[{label:"Select",value:""},...P,{label:"From URL",value:"custom"}],f=g?.data.map(({name:n,title:d})=>({label:d,value:n}))??[],S=i({sidePath:[]}),a=D({initialValues:Re,onSubmit:async n=>{try{const d=await ke(n.cloudInit),c=(await u({title:n.title,access_group:n.access_group,description:n.description,image_name:n.instanceType==="custom"?n.customImageName:n.instanceType,image_source:n.rootfsImage,cloud_init_contents:d,all_computers:n.all_computers,only_landscape_created:n.only_landscape_created,tags:n.tags})).data.computers.constrained.length;S(),s.success({title:`Profile "${n.title}" added successfully`,message:`It has been associated with ${c} instances`})}catch(d){t(d)}},validationSchema:Ae()}),T=async n=>{await a.setFieldValue("cloudInit",n[0])},r=async()=>{await a.setFieldValue("cloudInit",null)};return e.jsxs(e.Fragment,{children:[e.jsx(x.Header,{children:"Add WSL profile"}),e.jsx(x.Content,{children:e.jsxs(o.Form,{onSubmit:a.handleSubmit,noValidate:!0,children:[e.jsx(o.Input,{type:"text",label:"Title",required:!0,...a.getFieldProps("title"),error:m(a,"title")}),e.jsx(o.Input,{type:"text",label:"Description",required:!0,...a.getFieldProps("description"),error:m(a,"description")}),e.jsx(o.Select,{label:"Access group","aria-label":"Access group",required:!0,options:f,...a.getFieldProps("access_group"),error:m(a,"access_group")}),e.jsxs("div",{className:qe.block,children:[(a.values.instanceType!==""||a.values.cloudInitType!=="")&&e.jsx(o.Notification,{severity:"caution",title:"Warning",children:e.jsx("span",{children:"Once the profile is added, you cannot modify the rootfs image or cloud-init file."})}),e.jsx(o.Select,{label:"rootfs image",disabled:I,"aria-label":"rootfs image",options:j,required:!0,...a.getFieldProps("instanceType"),error:m(a,"instanceType")}),a.values.instanceType==="custom"&&e.jsxs(e.Fragment,{children:[e.jsx(o.Input,{label:"Image name",type:"text",required:!0,...a.getFieldProps("customImageName"),error:m(a,"customImageName")}),e.jsx(o.Input,{type:"text",label:"rootfs image URL",required:!0,...a.getFieldProps("rootfsImage"),error:m(a,"rootfsImage"),help:"The file path must be reachable by the affected WSL instances."})]}),e.jsx(o.Select,{label:"cloud-init","aria-label":"cloud-init",options:Y,...a.getFieldProps("cloudInitType"),onChange:async n=>{a.getFieldProps("cloudInitType").onChange(n),await a.setFieldValue("cloudInit",null)},error:m(a,"cloudInitType")}),a.values.cloudInitType==="file"&&e.jsx(ge,{label:"Upload cloud-init",labelClassName:"u-off-screen",accept:".yaml",...a.getFieldProps("cloudInit"),value:a.values.cloudInit instanceof File?a.values.cloudInit:null,onFileRemove:r,onFileUpload:T,help:Le,error:m(a,"cloudInit")}),a.values.cloudInitType==="text"&&e.jsx(me,{label:"cloud-init configuration",onChange:n=>{a.setFieldValue("cloudInit",n??"")},value:typeof a.values.cloudInit=="string"?a.values.cloudInit:"",language:"yaml",defaultValue:"# paste cloud-init config here",error:m(a,"cloudInit")})]}),e.jsx(fe,{label:"Compliance settings",formik:a,field:"only_landscape_created",inputs:[{key:"ignore",value:!1,label:"Ignore WSL child instances that have not been created by Landscape"},{key:"uninstall",value:!0,label:"Uninstall WSL child instances that have not been created by Landscape"}]}),e.jsx(H,{formik:a}),e.jsx(Q,{submitButtonText:"Add WSL profile",submitButtonAriaLabel:"Add a new WSL profile",submitButtonDisabled:a.isSubmitting,onCancel:S})]})})]})},A=()=>{const{profile:t}=w(),{wslProfile:i,isGettingWslProfile:s,wslProfileError:l}=we({profile_name:t});if(l)throw l;return s?{wslProfile:void 0,isGettingWslProfile:!0}:{wslProfile:i,isGettingWslProfile:!1}},Gt=()=>{const{createSidePathPusher:t}=w(),{getAccessGroupQuery:i}=R(),{wslProfile:s,isGettingWslProfile:l}=A(),{data:u,isPending:g}=i(),{value:I,setTrue:y,setFalse:P}=W();if(l||g)return e.jsx(x.LoadingState,{});const j=t("edit");return e.jsxs(e.Fragment,{children:[e.jsx(x.Header,{children:s.title}),e.jsxs(x.Content,{children:[e.jsx("div",{className:"p-segmented-control",children:e.jsxs("div",{className:"p-segmented-control__list",children:[e.jsxs(o.Button,{type:"button",hasIcon:!0,className:"p-segmented-control__button",onClick:j,children:[e.jsx(o.Icon,{name:"edit"}),e.jsx("span",{children:"Edit"})]}),e.jsxs(o.Button,{type:"button",hasIcon:!0,className:"p-segmented-control__button","aria-label":`Remove ${s.title} profile`,onClick:y,children:[e.jsx(o.Icon,{name:o.ICONS.delete}),e.jsx("span",{children:"Remove"})]})]})}),e.jsxs(v,{children:[e.jsx(v.Item,{children:e.jsxs(p,{children:[e.jsx(p.Item,{label:"Title",value:s.title}),e.jsx(p.Item,{label:"Name",value:s.name}),e.jsx(p.Item,{label:"Access group",value:se(s.access_group,u)}),e.jsx(p.Item,{label:"Description",large:!0,value:s.description})]})}),e.jsx(v.Item,{children:e.jsxs(p,{children:[e.jsx(p.Item,{label:"rootfs image name",large:!0,value:s.image_name}),s.image_source!==null&&e.jsx(p.Item,{label:"rootfs image source",large:!0,value:s.image_source,type:"truncated"}),e.jsx(p.Item,{label:"cloud-init",large:!0,value:s.cloud_init_contents}),e.jsx(p.Item,{label:"Compliance settings",large:!0,value:s.only_landscape_created?"Uninstall WSL child instances that have not been created by Landscape":"Ignore WSL child instances that have not been created by Landscape"})]})}),e.jsx(v.Item,{title:"Association",children:e.jsx(he,{profile:s,children:e.jsxs(p,{children:[e.jsx(p.Item,{label:"Tags",large:!0,value:s.tags.join(", "),type:"truncated"}),e.jsx(p.Item,{label:"Associated parents",large:!0,value:e.jsx(N,{count:s.computers.constrained.length,profile:s,query:`wsl:${s.id}`})}),e.jsx(p.Item,{label:"Not compliant",value:e.jsx(de,{wslProfile:s,onClick:t("noncompliant")})}),e.jsx(p.Item,{label:"Compliant",value:e.jsx(N,{profile:s,count:s.computers.constrained.length-s.computers["non-compliant"].length,query:`wsl:${s.id}:compliant`})})]})})})]})]}),e.jsx(pe,{isOpen:I,close:P,wslProfile:s})]})},Me=()=>G().shape({title:b().required("This field is required"),description:b().required("This field is required"),access_group:b().required("This field is required"),all_computers:B(),tags:O().of(b())}),Ge="_block_tz139_1",Oe={block:Ge},Be=({profile:t})=>{const{getAccessGroupQuery:i}=R(),s=U(),{sidePath:l,popSidePath:u,createPageParamsSetter:g}=w(),{notify:I}=$(),{editWslProfile:y}=ve(),{wslInstanceTypes:P}=z(),j=P.map(({label:n,name:d})=>({label:n,value:d}))||[],f=[{label:"Select",value:""},...j,{label:"From URL",value:"custom"}],{data:S}=i(),h=S?.data.map(({name:n,title:d})=>({label:d,value:n}))??[],a=g({sidePath:[],profile:""}),T=async n=>{try{await y({name:t.name,title:n.title,description:n.description,all_computers:n.all_computers,tags:n.tags}),a(),I.success({title:"WSL profile updated",message:`WSL profile "${t.title}" updated successfully`})}catch(d){s(d)}},r=D({initialValues:{title:t.title,description:t.description,instanceType:t.image_source?"custom":t.image_name,customImageName:t.image_source?t.image_name:"",rootfsImage:t.image_source||"",all_computers:t.all_computers,tags:t.tags},onSubmit:T,validationSchema:Me()});return e.jsxs(o.Form,{onSubmit:r.handleSubmit,noValidate:!0,children:[e.jsx(o.Notification,{severity:"caution",title:"Editing unavailable",children:e.jsx("span",{children:"You cannot edit access group, rootfs image, cloud-init file, or compliance settings. To modify these fields, create a new profile."})}),e.jsx(o.Input,{type:"text",label:"Title",required:!0,...r.getFieldProps("title"),error:m(r,"title")}),e.jsx(o.Input,{type:"text",label:"Description",required:!0,...r.getFieldProps("description"),error:m(r,"description")}),e.jsx(o.Select,{label:"Access group","aria-label":"Access group",options:h,disabled:!0,required:!0}),e.jsxs("div",{className:Oe.block,children:[e.jsx(o.Select,{disabled:!0,label:"rootfs image","aria-label":"rootfs image",options:f,...r.getFieldProps("instanceType"),error:m(r,"instanceType")}),r.values.instanceType==="custom"&&e.jsxs(e.Fragment,{children:[e.jsx(o.Input,{disabled:!0,label:"Image name",type:"text",required:!0,...r.getFieldProps("customImageName"),error:m(r,"customImageName")}),e.jsx(o.Input,{disabled:!0,type:"text",label:"rootfs image URL",required:!0,...r.getFieldProps("rootfsImage"),error:m(r,"rootfsImage"),help:"The file path must be reachable by the affected WSL instances."})]}),e.jsx(o.Select,{label:"cloud-init","aria-label":"cloud-init",options:Y,disabled:!0}),e.jsx(o.Select,{label:"Compliance settings",options:[{label:"Ignore WSL child instances that have not been created by Landscape",value:"ignore"},{label:"Uninstall WSL child instances that have not been created by Landscape",value:"uninstall"}],disabled:!0,value:t.only_landscape_created?"uninstall":"ignore"})]}),e.jsx(H,{formik:r}),e.jsx(Q,{submitButtonText:"Save changes",submitButtonDisabled:r.isSubmitting,onCancel:a,hasBackButton:l.length>1,onBackButtonPress:u})]})},Ot=()=>{const{wslProfile:t,isGettingWslProfile:i}=A();return i?e.jsx(x.LoadingState,{}):e.jsxs(e.Fragment,{children:[e.jsxs(x.Header,{children:['Edit "',t.title,'" profile']}),e.jsx(x.Content,{children:e.jsx(Be,{profile:t})})]})},Ue="_header_513lp_1",$e="_search_513lp_8",k={header:Ue,search:$e},De=({instance:t})=>{const{value:i,setTrue:s,setFalse:l}=W();return e.jsxs(e.Fragment,{children:[e.jsx(ie,{destructiveActions:[{icon:"security-tick",label:"Make compliant",onClick:s}],toggleAriaLabel:`${t.title} actions`}),e.jsx(V,{close:l,instances:[t],isOpen:i})]})},Ve=t=>({column:i,row:{index:s}})=>i.id==="profiles"&&t===s?{className:"expandedCell"}:{},He=t=>({index:i})=>t===i?{className:"expandedRow"}:{},Qe=({wslProfile:t})=>{const{expandedRowIndex:i,getTableRowsRef:s,handleExpand:l}=_e(),[u,g]=F.useState(""),[I]=F.useState(ae),[y]=F.useState(ne),[P,j]=F.useState(""),{instances:f,isGettingInstances:S}=Se({query:[P,`profile:wsl:${t.id}:noncompliant`].filter(Boolean).join(" "),limit:y,offset:(I-1)*y,with_wsl_profiles:!0}),{selectedItems:h,setSelectedItems:a}=Te(f,S),{value:T,setTrue:r,setFalse:n}=W(),d=F.useMemo(()=>[{accessor:"title",Header:e.jsxs(e.Fragment,{children:[e.jsx(o.CheckboxInput,{label:e.jsx("span",{className:"u-off-screen",children:"Toggle all instances"}),inline:!0,disabled:!f.length,indeterminate:!!h.length&&h.length<f.length,checked:!!f.length&&h.length===f.length,onChange:({currentTarget:{checked:c}})=>{a(c?f:[])}}),"Instance name"]}),Cell:({row:{original:c}})=>e.jsxs(e.Fragment,{children:[e.jsx(o.CheckboxInput,{inline:!0,label:e.jsxs("span",{className:"u-off-screen",children:["Select ",c.title]}),checked:h.includes(c),onChange:({currentTarget:{checked:_}})=>{a(_?[...h,c]:h.filter(L=>L!==c))}}),e.jsx(Pe,{to:oe.instances.details.single(c.id),children:c.title})]})},{Header:"OS",Cell:({row:{original:c}})=>c.distribution_info?.description},{accessor:"profiles",Header:"WSL profiles",Cell:({row:{original:c,index:_}})=>e.jsx(je,{content:c.wsl_profiles?.map(L=>L.title).join(", "),isExpanded:_===i,onExpand:()=>{l(_)}})},{Header:"Last ping",Cell:({row:{original:c}})=>{const _=le(c.last_ping_time);return _.isValid()?e.jsx("span",{className:"font-monospace",children:_.format(re)}):e.jsx(Ie,{})}},{...xe,Cell:({row:{original:c}})=>e.jsx(De,{instance:c})}],[f,h,i]),C=()=>{g(""),j("")};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:k.header,children:[e.jsx(o.SearchBox,{className:ce("u-no-margin--bottom",k.search),externallyControlled:!0,value:u,onChange:g,onClear:C,onSearch:j,autoComplete:"off"}),e.jsxs(o.Button,{type:"button",className:"u-no-margin",hasIcon:!0,onClick:r,disabled:!h.length,children:[e.jsx(o.Icon,{name:"security-tick"}),e.jsx("span",{children:"Make compliant"})]})]}),e.jsx(be,{filters:[{label:"Search",item:P||void 0,clear:C}]}),S?e.jsx(ue,{}):e.jsx("div",{ref:s,children:e.jsx(ye,{columns:d,data:f,emptyMsg:"No Windows instances found according to your search parameters.",getCellProps:Ve(i),getRowProps:He(i)})}),e.jsx(V,{close:n,instances:h,isOpen:T})]})},Bt=()=>{const{wslProfile:t,isGettingWslProfile:i}=A();return i?e.jsx(x.LoadingState,{}):e.jsxs(e.Fragment,{children:[e.jsxs(x.Header,{children:["Instances not compliant with ",t.title]}),e.jsx(x.Content,{children:e.jsx(Qe,{wslProfile:t})})]})};export{Dt as WslProfileAddButton,Mt as WslProfileAddSidePanel,Gt as WslProfileDetailsSidePanel,Ot as WslProfileEditSidePanel,Bt as WslProfileNonCompliantInstancesSidePanel,Vt as WslProfilesEmptyState,Ht as WslProfilesHeader,Qt as WslProfilesList,Fe as useAddWslProfile,zt as useDeleteWslProfile,ve as useEditWslProfile,we as useGetWslProfile,Yt as useGetWslProfiles,Xt as useMakeWindowsInstancesCompliant,Zt as useReapplyWslProfile};
