import{r as x,j as e,m as P,g as p,L as K,D as q,b as Z,c as L,d as W,p as M,q as Q,s as Y,h as J,k as X,W as ee,n as G,a3 as se}from"./index-BJrExKCU.js";import{P as te,a as ne,b as ae}from"./PageMain-xFzgJ6AX.js";import{u as w,T as re}from"./TablePagination-BwnCVTFB.js";import{N}from"./NoData-pu69q1jp.js";import{u as b,h as k}from"./usePageParams-DK6tFkJI.js";import{h as oe,a as H,c as A,g as E,b as D,d as ie,e as ce}from"./helpers-B7LPy4Ik.js";import{T as B}from"./TableFilter-Bk8jPaab.js";import{G as le}from"./GroupFilter-CbNCU-jw.js";import{S as de}from"./StatusFilter-DCu7JXAt.js";import{T as ue}from"./TableFilterChips-fdKA1Tjf.js";import{S as he}from"./index-4Ex9sJin.js";import{u as pe}from"./useFetchOld-CJ4oV8HI.js";import{u as U}from"./useInstances-9pmLwDYD.js";import{u as me}from"./useRoles-d5sysCza.js";import{F as I,P as xe,I as ge}from"./InstancesPageActions-Dd2wf0ip.js";import"./TablePaginationBase-CNdouFxR.js";import"./helpers-C1HhordC.js";const je=({instances:s,selectedInstances:t,setColumnFilterOptions:o,setSelectedInstances:n})=>{const{disabledColumns:i,groupBy:c,...r}=b(),d=Object.values(r).some(a=>{if(typeof a=="string")return a.length>0;if(Array.isArray(a))return a.length>0}),h=()=>{n(t.length!==0?[]:s)},l=x.useMemo(()=>c==="parent"?s.map(a=>({...a,subRows:a.children.map(u=>({...u,parent:a,children:[]}))})):s,[s,c]),g=x.useMemo(()=>[{accessor:"title",canBeHidden:!1,optionLabel:"Instance name",Header:e.jsxs(e.Fragment,{children:[e.jsx(p.CheckboxInput,{label:e.jsx("span",{className:"u-off-screen",children:"Toggle all instances"}),inline:!0,onChange:h,disabled:s.length===0,checked:t.length===s.length&&s.length!==0,indeterminate:t.length!==0&&t.length<s.length}),e.jsx("span",{id:"column-1-label",children:"Name"})]}),Cell:({row:a})=>e.jsxs("div",{className:P(A.rowHeader,{[A.nested]:a.depth>0}),children:[e.jsx(p.CheckboxInput,{label:e.jsx("span",{className:"u-off-screen",children:a.original.title}),labelClassName:"u-no-margin--bottom u-no-padding--top",checked:H({groupBy:c,instance:a.original,selectedInstances:t})==="checked",indeterminate:H({groupBy:c,instance:a.original,selectedInstances:t})==="indeterminate",onChange:()=>{oe({groupBy:c,instance:a.original,selectedInstances:t,setSelectedInstances:n})}}),e.jsx(K,{to:a.original.parent?`/instances/${a.original.parent.id}/${a.original.id}`:`/instances/${a.original.id}`,children:a.original.title})]})},{accessor:"status",canBeHidden:!0,optionLabel:"Status",Header:"Status",Cell:({row:{original:a}})=>{const{label:u}=E(a);return u},getCellIcon:({row:{original:a}})=>{const{icon:u}=E(a);return u}},{accessor:"upgrades",canBeHidden:!0,optionLabel:"Upgrades",Header:"Upgrades",Cell:({row:{original:a}})=>{const{label:u}=D(a);return u},getCellIcon:({row:{original:a}})=>{const{icon:u}=D(a);return u}},{accessor:"os",canBeHidden:!0,optionLabel:"OS",Header:"OS",Cell:({row:{original:a}})=>{var u;return e.jsx(e.Fragment,{children:((u=a.distribution_info)==null?void 0:u.description)??e.jsx(N,{})})}},{accessor:"availability_zone",canBeHidden:!0,optionLabel:"Availability zone",Header:"Availability zone",Cell:({row:{original:a}})=>{var u;return e.jsx(e.Fragment,{children:((u=a.cloud_init)==null?void 0:u.availability_zone)??e.jsx(N,{})})}},{accessor:"ubuntu_pro",canBeHidden:!0,optionLabel:"Ubuntu pro",Header:"Ubuntu pro",Cell:({row:a})=>e.jsx(e.Fragment,{children:a.original.ubuntu_pro_info&&k(a.original.ubuntu_pro_info.expires).isValid()?`Exp. ${k(a.original.ubuntu_pro_info.expires).format(q)}`:e.jsx(N,{})})},{accessor:"last_ping",canBeHidden:!0,optionLabel:"Last ping",Header:"Last ping time",Cell:({row:a})=>e.jsx(e.Fragment,{children:k(a.original.last_ping_time).isValid()?k(a.original.last_ping_time).format(q):e.jsx(N,{})})}],[t.length,s,c]);x.useEffect(()=>{o(ie(g))},[]);const m=x.useMemo(()=>g.filter(({accessor:a})=>typeof a=="string"&&!i.includes(a)),[i.length,g]);return e.jsx(p.ModularTable,{emptyMsg:d?"No instances found according to your search parameters.":"No instances found",columns:m,data:l,getHeaderProps:ce})},fe="_label_1i8qt_1",Se={label:fe},be=({options:s})=>{const{disabledColumns:t,setPageParams:o}=b(),n=i=>s.filter(({value:c})=>!i.includes(c)).map(({value:c})=>c);return w("disabledColumns",s.filter(i=>i.canBeHidden).map(i=>i.value)),e.jsx(B,{multiple:!0,showSelectedItemCount:!0,label:e.jsxs(e.Fragment,{children:[e.jsx(p.Icon,{name:"settings"}),e.jsx("span",{className:Se.label,children:"Columns"})]}),onItemsSelect:i=>o({disabledColumns:n(i)}),options:s,disabledOptions:s.filter(({canBeHidden:i})=>!i),selectedItems:n(t)})},$=()=>{const s=pe(),t=Z(),o=(r={},d={})=>W({queryKey:["savedSearches",r],queryFn:async()=>s.get("GetSavedSearches",{params:r}),...d}),n=L({mutationFn:async r=>s.get("CreateSavedSearch",{params:r}),onSuccess:async()=>t.invalidateQueries({queryKey:["savedSearches"]})}),i=L({mutationFn:async r=>s.get("EditSavedSearch",{params:r}),onSuccess:async()=>t.invalidateQueries({queryKey:["savedSearches"]})}),c=L({mutationFn:async r=>s.get("RemoveSavedSearch",{params:r}),onSuccess:async()=>t.invalidateQueries({queryKey:["savedSearches"]})});return{getSavedSearchesQuery:o,createSavedSearchQuery:n,editSavedSearchQuery:i,removeSavedSearchQuery:c}},ve="_container_5hvuq_1",ye="_list_5hvuq_6",_e="_listItem_5hvuq_11",Ce="_search_5hvuq_17",Ie="_row_5hvuq_25",we="_truncated_5hvuq_33",v={container:ve,list:ye,listItem:_e,search:Ce,row:Ie,truncated:we},Be=({onSavedSearchClick:s,onSavedSearchRemove:t,savedSearches:o})=>{if(!o.length)return null;const n=M(),{notify:i}=Q(),{removeSavedSearchQuery:c}=$(),{mutateAsync:r,isPending:d}=c,h=async l=>{try{await r({name:l}),t(),i.success({message:`Saved search ${l} successfully removed`,title:"Saved search removed"})}catch(g){n(g)}};return e.jsxs("div",{className:v.container,children:[e.jsx("p",{className:"p-text--small-caps u-text--muted p-text--small",children:"Saved searches"}),e.jsx("ul",{className:P("p-list--divided u-no-margin--bottom",v.list),children:o.map(l=>e.jsx("li",{children:e.jsxs("div",{className:v.listItem,children:[e.jsx(p.Button,{type:"button",appearance:"base",className:v.search,onClick:()=>s(l),children:e.jsxs(p.Row,{className:v.row,children:[e.jsx(p.Col,{size:4,children:e.jsx(p.Tooltip,{message:l.name,positionElementClassName:v.truncated,children:e.jsx("span",{children:l.name})})}),e.jsx(p.Col,{size:8,children:e.jsx(p.Tooltip,{message:l.search,positionElementClassName:v.truncated,children:e.jsx("span",{children:l.search})})})]})}),e.jsx(p.ConfirmationButton,{className:"has-icon u-no-margin--bottom u-no-padding--bottom u-no-padding--top",type:"button",appearance:"base",confirmationModalProps:{title:"Remove saved search",children:e.jsxs("p",{children:['This will remove the saved search "',l.name,'".']}),confirmButtonLabel:"Remove",confirmButtonAppearance:"negative",confirmButtonDisabled:d,confirmButtonLoading:d,onConfirm:()=>h(l.name)},children:e.jsx(p.Icon,{name:"delete"})})]})},l.name))})]})},Ne="_infoContainer_zti77_1",ke="_helpButtonContainer_zti77_9",Fe="_helpButton_zti77_9",O={infoContainer:Ne,helpButtonContainer:ke,helpButton:Fe},Pe=({onHelpButtonClick:s})=>e.jsx("div",{className:O.infoContainer,children:e.jsx("div",{className:O.helpButtonContainer,children:e.jsx(p.Button,{type:"button",appearance:"base",hasIcon:!0,className:O.helpButton,onClick:t=>{t.stopPropagation(),s()},children:e.jsx(p.Icon,{name:p.ICONS.help})})})}),Le=({onClose:s,onSearchSave:t,search:o})=>{const n=M(),{notify:i}=Q(),{createSavedSearchQuery:c}=$(),{mutateAsync:r}=c,h=Y({initialValues:{name:""},onSubmit:async({name:l})=>{try{await r({search:o,name:l,title:l}),i.success({message:`Saved search ${l} successfully added`,title:"Saved search added"}),t(),s()}catch(g){n(g)}},validationSchema:J({name:X().required("This field is required").test({message:"Name must consist of only lowercase alphanumeric characters and hyphens",test:l=>/^[a-z0-9][-a-z0-9]*$/.test(l)})})});return e.jsxs(p.Form,{onSubmit:h.handleSubmit,noValidate:!0,children:[e.jsx(p.Input,{type:"text",autoComplete:"off",autoFocus:!0,label:"Search name",...h.getFieldProps("name"),error:h.touched.name&&h.errors.name?h.errors.name:void 0}),e.jsxs("div",{className:"form-buttons",children:[e.jsx(p.Button,{type:"button",disabled:h.isSubmitting,onClick:s,children:"Cancel"}),e.jsx(p.Button,{type:"submit",disabled:h.isSubmitting,appearance:"positive","aria-label":`Saved search as ${h.values.name}`,children:"Save search"})]})]})},Oe="_container_fqj7b_1",Te="_prompt_fqj7b_10",$e="_saveButton_fqj7b_17",T={container:Oe,prompt:Te,saveButton:$e},qe=({onSearchSave:s,search:t})=>{const[o,n]=x.useState(!1);return e.jsxs(e.Fragment,{children:[t&&o&&e.jsx(Le,{onClose:()=>n(!1),onSearchSave:s,search:t}),t&&!o&&e.jsxs("div",{className:T.container,children:[e.jsxs("span",{className:T.prompt,children:[e.jsx("span",{children:"Search for "}),e.jsx("span",{className:"p-search-and-filter__search-query",children:t}),e.jsx("span",{children:"..."})]}),e.jsx(p.Button,{type:"button",appearance:"link",onClick:()=>n(!0),className:T.saveButton,children:"Save search"})]})]})},He="_searchContainer_t00ki_1",Ae="_form_t00ki_8",Ee="_searchBoxContainer_t00ki_13",De="_input_t00ki_17",F={searchContainer:He,form:Ae,searchBoxContainer:Ee,input:De},z=({inputText:s,savedSearches:t,search:o})=>{if(!t)return[];let n=t;if(o){const i=o.split(",").filter(Boolean);n=n.filter(({name:c})=>i.every(r=>r!==`search:${c}`))}return s&&(n=n.filter(({name:i,search:c})=>i.toLowerCase()!==s.trim().toLowerCase()&&c.toLowerCase()!==s.trim().toLowerCase())),n},ze=({onHelpButtonClick:s})=>{const{query:t,setPageParams:o}=b(),[n,i]=x.useState(""),[c,r]=x.useState(!1),{getSavedSearchesQuery:d}=$(),h=x.useRef(null),l=x.useRef(null);ee(h,j=>{const S=document.querySelector(".p-modal");S&&S.contains(j.target)||r(!1)});const{data:m,isLoading:a}=d(),u=x.useMemo(()=>z({inputText:n,savedSearches:m==null?void 0:m.data,search:t}),[m,n,t]),y=()=>{if(!n)return;const S=z({inputText:"",savedSearches:m==null?void 0:m.data,search:t}).some(({name:V})=>V.toLowerCase()===n.trim().toLowerCase())?"search:":"";o({query:t?`${t},${S}${n}`:`${S}${n}`}),i("")},f=j=>{o({query:t?`${t},search:${j.name}`:`search:${j.name}`})},_=j=>{const{key:S}=j;c?(S==="Escape"&&r(!1),S==="Enter"&&y()):S==="Enter"&&r(!0)};return e.jsxs("div",{className:"p-search-and-filter",ref:h,children:[e.jsxs("div",{className:P("p-search-and-filter__search-container",F.searchContainer),"aria-expanded":c,ref:l,onClick:()=>r(!0),children:[e.jsx(p.Form,{onSubmit:j=>{j.preventDefault(),y()},className:P("p-search-and-filter__box",F.form),children:e.jsx("div",{className:F.searchBoxContainer,children:e.jsx(p.SearchBox,{externallyControlled:!0,shouldRefocusAfterReset:!0,autocomplete:"off",className:F.input,value:n,onChange:j=>i(j),onClear:()=>i(""),onSearch:y,onClick:()=>r(!0),onKeyUp:_})})}),e.jsx(Pe,{onHelpButtonClick:s})]}),c&&a&&e.jsx(G,{}),c&&!a&&e.jsxs("div",{className:"p-search-and-filter__panel",children:[e.jsx(qe,{onSearchSave:()=>i(""),search:n.trim()}),e.jsx(Be,{onSavedSearchClick:f,onSavedSearchRemove:()=>r(!0),savedSearches:u})]})]})},Re=({options:s})=>{const{accessGroups:t,setPageParams:o}=b();return w("accessGroups",s.map(n=>n.value)),e.jsx(B,{multiple:!0,label:"Access group",hasToggleIcon:!0,hasBadge:!0,options:s,onItemsSelect:n=>o({accessGroups:n}),selectedItems:t})},Me=({options:s})=>{const[t,o]=x.useState(""),{availabilityZones:n,setPageParams:i}=b(),c=s.length>9&&t?s.filter(({value:d})=>d!=="none"&&d.includes(t)):s;w("availabilityZones",c.map(d=>d.value));const r=d=>{d[d.length-1]==="none"?i({availabilityZones:["none"]}):i({availabilityZones:d[0]!=="none"?d:d.filter(h=>h!=="none")})};return e.jsx(B,{multiple:!0,label:"Availability zone",hasToggleIcon:!0,hasBadge:!0,onSearch:s.length>9?d=>o(d):void 0,options:c,onItemsSelect:r,selectedItems:n})},Qe=({options:s})=>{const{os:t,setPageParams:o}=b();return w("os",s.map(n=>n.value)),e.jsx(B,{multiple:!1,hasBadge:!0,label:"OS",hasToggleIcon:!0,options:s,onItemSelect:n=>o({os:n}),selectedItem:t})},Ge=({options:s})=>{const[t,o]=x.useState(""),{tags:n,setPageParams:i}=b(),c=s.filter(({value:r})=>r.includes(t));return w("tags",c.map(r=>r.value)),e.jsx(B,{multiple:!0,label:"Tag",hasToggleIcon:!0,hasBadge:!0,options:c,onItemsSelect:r=>i({tags:r}),onSearch:r=>o(r),selectedItems:n})},Ue=[{term:"<keyword>",description:e.jsxs("span",{children:["Instances with the title or hostname ",e.jsx("code",{children:"<keyword>"})]})},{term:"distribution:<keyword>",description:e.jsxs("span",{children:["Instances with the installed distribution named"," ",e.jsx("code",{children:"<keyword>"})]})},{term:"needs:reboot",description:"Instances needing a reboot"},{term:"alert:<type>",description:e.jsxs(e.Fragment,{children:[e.jsxs("span",{children:["Instances with outstanding alerts of the specified"," ",e.jsx("code",{children:"<type>"})]}),e.jsx("br",{}),e.jsxs("span",{children:[e.jsx("code",{children:"<type>"})," can be ",e.jsx("code",{children:"package-upgrades"}),","," ",e.jsx("code",{children:"security-upgrades"}),",",e.jsx("code",{children:"package-profiles"}),","," ",e.jsx("code",{children:"package-reporter"}),", ",e.jsx("code",{children:"esm-disabled"}),","," ",e.jsx("code",{children:"computer-offline"}),",",e.jsx("code",{children:"computer-reboot"}),","," ",e.jsx("code",{children:"computer-duplicates"}),", ",e.jsx("code",{children:"unapproved-activities"}),"."]})]})},{term:"ip:<address>",description:e.jsxs(e.Fragment,{children:[e.jsxs("span",{children:["Instances with IP addresses like ",e.jsx("code",{children:"<address>"})]}),e.jsx("br",{}),e.jsxs("span",{children:[e.jsx("code",{children:"<address>"})," can be a fragment or partial IP address representing a subnet such as 91.185.94 to match any instances in the subnet."]})]})},{term:"mac:<address>",description:e.jsxs("span",{children:["Instances with the MAC address ",e.jsx("code",{children:"<address>"})]})},{term:"id:<instance_id>",description:e.jsxs("span",{children:["Instance with the id ",e.jsx("code",{children:"<instance_id>"})]})},{term:"access-group:<name>",description:e.jsxs("span",{children:["Instances associated with the ",e.jsx("code",{children:"<name>"})," access group"]})},{term:"search:<name>",description:e.jsxs("span",{children:["Instances meeting the terms of the ",e.jsx("code",{children:"<name>"})," saved search"]})},{term:"upgrade-profile:<name>",description:e.jsxs("span",{children:["Instances associated with the ",e.jsx("code",{children:"<name>"})," upgrade profile"]})},{term:"removal-profile:<name>",description:e.jsxs("span",{children:["Instances associated with the ",e.jsx("code",{children:"<name>"})," removal profile"]})},{term:"tag:<keyword>",description:e.jsxs("span",{children:["Instances associated with the ",e.jsx("code",{children:"<keyword>"})," tag"]})},{term:"hostname:<keyword>",description:e.jsxs("span",{children:["Instance with the hostname ",e.jsx("code",{children:"<keyword>"})]})},{term:"title:<keyword>",description:e.jsxs("span",{children:["Instance with the title ",e.jsx("code",{children:"<keyword>"})]})},{term:"license-id:<license_id>",description:e.jsxs("span",{children:["Search for instances licensed to the specified"," ",e.jsx("code",{children:"<license_id>"})]})},{term:"needs:license OR license-id:none",description:"Search for instances that do not have a Landscape license, and, as a result, are not managed"},{term:"annotation:<key>",description:e.jsxs("span",{children:["Search for instances which define the specified annotation key. Optionally specify ",e.jsx("code",{children:"annotation:<key>:<string>"})," ","which will only return instances whose key matches and value also contains the ",e.jsx("code",{children:"<string>"})," specified"]})}],Ve="_top_unlra_1",Ke="_searchContainer_unlra_13",Ze="_filters_unlra_17",We="_divider_unlra_22",C={top:Ve,searchContainer:Ke,filters:Ze,divider:We},Ye=({columnFilterOptions:s})=>{const[t,o]=x.useState(!1),{getAccessGroupQuery:n}=me(),{getAllInstanceTagsQuery:i,getAvailabilityZonesQuery:c}=U(),{data:r}=i(),d=(r==null?void 0:r.data.results.map(f=>({label:f,value:f})))??[],{data:h}=c(),l=((h==null?void 0:h.data.values)??[]).reduce((f,_)=>(f.push({label:_,value:_}),f),[{label:"Without zones",value:"none",group:"1"}]),{data:g}=n(),m=(g==null?void 0:g.data.map(({name:f,title:_})=>({value:f,label:_})))??[],a=I.groupBy.options,u=I.status.options,y=I.os.options;return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:C.top,children:[e.jsx("div",{className:C.searchContainer,children:e.jsx(ze,{onHelpButtonClick:()=>o(!0)})}),e.jsxs("div",{className:C.filters,children:[e.jsx(le,{options:a}),e.jsx("span",{className:C.divider}),e.jsx(de,{options:u}),e.jsx(Qe,{options:y}),e.jsx(Me,{options:l}),e.jsx(Re,{options:m}),e.jsx(Ge,{options:d}),e.jsx("span",{className:C.divider}),e.jsx(be,{options:s})]})]}),e.jsx(ue,{filtersToDisplay:["accessGroups","os","availabilityZones","status","tags","query"],accessGroupOptions:m,availabilityZonesOptions:l,osOptions:y,statusOptions:u,tagOptions:d}),e.jsx(he,{open:t,data:Ue,onClose:()=>o(!1)}),e.jsx(xe,{})]})},R=(s,t)=>{var o;return s.type==="select"?((o=s.options.find(n=>n.value===t))==null?void 0:o.query)??"":""},Je=({accessGroups:s,availabilityZones:t,os:o,query:n,status:i,tags:c})=>{const r=[];return o&&r.push(R(I.os,o)),i&&r.push(R(I.status,i)),n&&r.push(...n.split(",")),c.length&&r.push(`tag:${c.join(" OR tag:")}`),s.length&&r.push(`access-group:${s.join(" OR access-group:")}`),t.length&&r.push(t.includes("none")?"availability-zone:null":`availability-zone:${t.join(" OR availability-zone:")}`),r.join(" ")},Xe=({selectedInstances:s,setSelectedInstances:t})=>{const[o,n]=x.useState([]),{currentPage:i,pageSize:c,groupBy:r,...d}=b(),{getInstancesQuery:h}=U(),{data:l,isLoading:g}=h({query:Je(d),root_only:r==="parent",with_alerts:!0,with_upgrades:se,limit:c,offset:(i-1)*c}),m=(l==null?void 0:l.data.results)??[],a=()=>{t([])};return e.jsxs(e.Fragment,{children:[e.jsx(Ye,{columnFilterOptions:o}),g?e.jsx(G,{}):e.jsx(je,{instances:m,selectedInstances:s,setColumnFilterOptions:u=>n(u),setSelectedInstances:u=>t(u)}),e.jsx(re,{totalItems:l==null?void 0:l.data.count,handleClearSelection:a,currentItemCount:m.length})]})},es="_header_116wp_1",ss={header:es},Ss=()=>{const[s,t]=x.useState([]);return e.jsxs(te,{children:[e.jsx(ne,{title:"Instances",className:ss.header,actions:[e.jsx(ge,{selected:s},"actions")]}),e.jsx(ae,{children:e.jsx(Xe,{selectedInstances:s,setSelectedInstances:o=>{t(o)}})})]})};export{Ss as default};
