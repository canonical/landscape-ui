import{b as S,g as B,h as D,w as q,M as F,al as A,x as L,y as P,z as H,aP as Q,aQ as U,a5 as z,o as k,k as N,p as O,q as Y,s as x,j as e,aR as K,d as c,J as j,a9 as p,i as V,a0 as W,O as R,I as _,t as X,P as J}from"./index-P7aY8_ih.js";import{A as Z}from"./AssociationBlock-DhzdWX6s.js";import{M as ee}from"./MultiSelectField-D04ckKNL.js";import{S as te}from"./SidePanelFormButtons-CfC2kumX.js";import{u as $}from"./useRoles-CiHskr-F.js";import{R as oe}from"./RandomizationBlock-CcuC1iIo.js";import{T as re}from"./TextConfirmationModal-ALqYLh0P.js";import{u as ie,R as se}from"./index-APDQPcgZ.js";import{a as Qe,b as Ue,c as ze}from"./index-APDQPcgZ.js";import"./useGetTags-Bw8JBcJb.js";import"./SidePanelFormButtons.module-BuIu-Bem.js";import"./RadioGroup-DKJHZL_u.js";import"./PageMain-BfWG-qpd.js";import"./HeaderWithSearch-qGmhTnPt.js";import"./constants-BwD2f_1_.js";function ae(){const t=S(),r=B(),n=D({mutationKey:["rebootprofiles","create"],mutationFn:async d=>t.post("rebootprofiles",d),onSuccess:async()=>r.invalidateQueries({queryKey:["rebootprofiles"]})}),{mutateAsync:a,isPending:u}=n;return{createRebootProfile:a,isCreatingRebootProfile:u}}function ne(){const t=S(),r=B(),n=D({mutationKey:["rebootprofiles","edit"],mutationFn:async({id:d,...m})=>t.patch(`rebootprofiles/${d}`,m),onSuccess:async()=>r.invalidateQueries({queryKey:["rebootprofiles"]})}),{mutateAsync:a,isPending:u}=n;return{editRebootProfile:a,isEditingRebootProfile:u}}const T={add:"added",edit:"updated",duplicate:"added"},le={add:"Add reboot profile",duplicate:"Add reboot profile",edit:"Save changes"},M=[{label:"Sunday",order:0,value:"su"},{label:"Monday",order:1,value:"mo"},{label:"Tuesday",order:2,value:"tu"},{label:"Wednesday",order:3,value:"we"},{label:"Thursday",order:4,value:"th"},{label:"Friday",order:5,value:"fr"},{label:"Saturday",order:6,value:"sa"}],ce=`If Landscape cannot reboot the
associated instances by this point,
the reboot will be canceled.`,G=t=>{const r=new Map(t.split(";").map(m=>{const[b,g]=m.split("=");return[b.toUpperCase(),g]})),n=r.get("FREQ")?.toLowerCase()??"",a=parseInt(r.get("BYHOUR")??"",10),u=parseInt(r.get("BYMINUTE")??"",10),d=(r.get("BYDAY")??"").split(",").map(m=>m.toLowerCase());return{freq:n,at_hour:a,at_minute:u,on_days:d}},de=t=>q().shape({...H,title:P().test({name:"required",message:"This field is required.",test:r=>!!r||t!=="add"}),access_group:P(),all_computers:L(),at_hour:A().required("Hour is required.").integer("Hour must be an integer.").min(0,"Hour must be between 0 and 23.").max(U,"Hour must be between 0 and 23."),at_minute:A().required("Minute is required.").integer("Minute must be an integer.").min(0,"Minute must be between 0 and 59.").max(Q,"Minute must be between 0 and 59."),deliver_within:A().integer("'Expires after' must be an integer.").min(0,"'Expires after' must be at least 0."),tags:F().of(P()),on_days:F().of(P()).min(1,"At least one day must be selected.")}),ue=t=>{if(t.action==="add")return{title:"",access_group:z,all_computers:!1,randomize_delivery:!1,deliver_delay_window:0,tags:[],at_hour:"",at_minute:"",deliver_within:0,on_days:[]};const{at_hour:r,at_minute:n,on_days:a}=G(t.profile.schedule);return{title:t.action==="duplicate"?`${t.profile.title} (copy)`:t.profile.title,access_group:t.profile.access_group,all_computers:t.profile.all_computers,randomize_delivery:!!t.profile.deliver_delay_window,deliver_delay_window:t.profile.deliver_delay_window||0,tags:t.profile.tags,at_hour:r,at_minute:n,deliver_within:t.profile.deliver_within,on_days:a}},me="_container_gex1r_1",pe="_timeContainer_gex1r_13",fe="_time_gex1r_13",be="_timeInput_gex1r_27",he="_inputDescriptionAfter_gex1r_32",_e="_colon_gex1r_37",ge="_tooltip_gex1r_43",xe="_expiration_gex1r_47",f={container:me,timeContainer:pe,time:fe,timeInput:be,inputDescriptionAfter:he,colon:_e,tooltip:ge,expiration:xe},C=t=>{const{getAccessGroupQuery:r}=$(),n=k(),{sidePath:a,popSidePath:u,setPageParams:d}=N(),{notify:m}=O(),{data:b}=r(),{createRebootProfile:g,isCreatingRebootProfile:i}=ae(),{editRebootProfile:v,isEditingRebootProfile:w}=ne(),I=b?.data.map(({name:o,title:h})=>({label:h,value:o}))??[],y=()=>{d({sidePath:[],profile:""})},s=Y({initialValues:ue(t),enableReinitialize:!0,onSubmit:async o=>{try{t.action==="edit"?await v({id:t.profile.id,access_group:o.access_group,at_hour:Number(o.at_hour),at_minute:Number(o.at_minute),deliver_delay_window:o.randomize_delivery?o.deliver_delay_window:0,deliver_within:o.deliver_within,on_days:o.on_days,title:o.title,tags:o.tags,every:"week",all_computers:o.all_computers}):await g({title:o.title,tags:o.tags,access_group:o.access_group,on_days:o.on_days,every:"week",at_hour:Number(o.at_hour),at_minute:Number(o.at_minute),deliver_delay_window:o.randomize_delivery?o.deliver_delay_window:0,deliver_within:o.deliver_within,all_computers:o.all_computers}),y(),m.success({message:`Reboot profile "${o.title}" has been ${T[t.action]} `,title:`Reboot profile ${T[t.action]}`})}catch(h){n(h)}},validationSchema:de(t.action)}),l=[x(s,"at_hour"),x(s,"at_minute"),x(s,"deliver_within")];return e.jsx(K,{value:s,children:e.jsxs(c.Form,{onSubmit:s.handleSubmit,noValidate:!0,children:[e.jsx(c.Input,{type:"text",label:"Title",required:t.action==="add",...s.getFieldProps("title"),error:s.touched.title&&s.errors.title}),e.jsx(c.Select,{label:"Access group","aria-label":"Access group",options:I,...s.getFieldProps("access_group"),error:x(s,"access_group")}),e.jsxs("div",{className:f.container,children:[e.jsx("p",{className:"p-heading--5",children:"Schedule"}),e.jsx(ee,{variant:"condensed",label:"Days",items:M,selectedItems:M.filter(({value:o})=>s.values.on_days.includes(o)),onItemsUpdate:async o=>s.setFieldValue("on_days",o.map(({value:h})=>h)),isSortedAlphabetically:!1,hasSelectedItemsFirst:!1,error:x(s,"on_days")}),e.jsxs("div",{className:f.timeContainer,children:[e.jsxs("div",{className:f.time,children:[e.jsxs(e.Fragment,{children:[e.jsx(c.Input,{type:"number",label:"Time","aria-label":"at hour",placeholder:"HH",className:f.timeInput,wrapperClassName:j({"is-error":l[0]}),...s.getFieldProps("at_hour"),"aria-errormessage":l[0]?"hour-error":void 0}),e.jsx("span",{className:f.colon,children:":"})]}),e.jsx(c.Input,{type:"number",label:"At minute",labelClassName:"u-off-screen","aria-label":"at minute",className:f.timeInput,wrapperClassName:j({"is-error":l[1]}),placeholder:"MM",...s.getFieldProps("at_minute"),"aria-errormessage":l[1]?"minute-error":void 0}),e.jsx(c.Input,{type:"number",label:e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"Expires after "}),e.jsx(c.Tooltip,{message:ce,position:"top-right",tooltipClassName:f.tooltip,children:e.jsx(c.Icon,{name:"help"})})]}),wrapperClassName:j(f.expiration,{"is-error":l[2]}),className:f.timeInput,...s.getFieldProps("deliver_within"),"aria-errormessage":"expires-error"}),e.jsx("span",{className:f.inputDescriptionAfter,children:"hours"})]}),l.filter(Boolean).length>0&&e.jsxs("div",{className:j({"is-error":l.filter(Boolean).length>0}),children:[l[0]&&e.jsx("p",{className:"p-form-validation__message",id:"hour-error",children:e.jsx("span",{children:l[0]})}),l[1]&&e.jsx("p",{className:"p-form-validation__message",id:"minute-error",children:e.jsx("span",{children:l[1]})}),l[2]&&e.jsxs("p",{className:"p-form-validation__message",id:"expires-error",children:[e.jsx("strong",{children:"Error: "}),e.jsx("span",{children:l[2]})]})]})]}),e.jsx(oe,{formik:s})]}),e.jsx(Z,{formik:s}),e.jsx(te,{submitButtonText:le[t.action],submitButtonDisabled:s.isSubmitting||i||w,onCancel:y,hasBackButton:a.length>1,onBackButtonPress:u})]})})},Oe=()=>e.jsxs(e.Fragment,{children:[e.jsx(p.Header,{children:"Add reboot profile"}),e.jsx(p.Content,{children:e.jsx(C,{action:"add"})})]});function ye(t,r={}){const n=S(),{data:a,isPending:u,error:d}=V({queryKey:["rebootprofile",t.id],queryFn:async({signal:b})=>n.get("rebootprofiles",{signal:b}),...r}),m=a?.data.results.find(({id:b})=>b===t.id);return{rebootProfile:m,rebootProfileError:a&&!m?new Error("The reboot profile could not be found."):d,isGettingRebootProfile:u}}const E=()=>{const{profile:t}=N(),{isGettingRebootProfile:r,rebootProfile:n,rebootProfileError:a}=ye({id:parseInt(t)});if(a)throw a;return r?{rebootProfile:void 0,isGettingRebootProfile:!0}:{rebootProfile:n,isGettingRebootProfile:!1}},Pe={mo:"Monday",tu:"Tuesday",we:"Wednesday",th:"Thursday",fr:"Friday",sa:"Saturday",su:"Sunday"},je=t=>t.length===2?`${t[0]} and ${t[1]}`:t.length>2?`${t.slice(0,-1).join(", ")}, and ${t[t.length-1]}`:t[0]??"",Re=t=>{const{freq:r,on_days:n}=G(t.schedule);if(r!=="weekly"||!n.length)return"One-time";const a=n.map(d=>Pe[d.toLowerCase()]);return`Every week on ${je(a)}`},$e=()=>{const{value:t,setFalse:r,setTrue:n}=W(),a=k(),{notify:u}=O(),{pushSidePath:d,setPageParams:m}=N(),{removeRebootProfile:b,isRemovingRebootProfile:g}=ie(),{rebootProfile:i,isGettingRebootProfile:v}=E(),{getAccessGroupQuery:w}=$(),{data:I,isPending:y}=w();if(v||y)return e.jsx(p.LoadingState,{});const s=async()=>{try{await b({id:i.id}),m({sidePath:[],profile:""}),u.success({title:"Reboot profile removed",message:`Reboot profile ${i.title} has been removed`})}catch(h){a(h)}finally{r()}},l=()=>{d("edit")},o=()=>{d("duplicate")};return e.jsxs(e.Fragment,{children:[e.jsx(p.Header,{children:i.title}),e.jsxs(p.Content,{children:[e.jsxs("div",{className:"p-segmented-control",children:[e.jsxs(c.Button,{type:"button",hasIcon:!0,className:"p-segmented-control__button",onClick:l,"aria-label":`Edit reboot profile ${i.title}`,children:[e.jsx(c.Icon,{name:"edit"}),e.jsx("span",{children:"Edit"})]}),e.jsxs(c.Button,{type:"button",hasIcon:!0,className:"p-segmented-control__button",onClick:o,"aria-label":`Edit reboot profile ${i.title}`,children:[e.jsx(c.Icon,{name:"canvas"}),e.jsx("span",{children:"Duplicate"})]}),e.jsxs(c.Button,{className:"p-segmented-control__button has-icon",type:"button",hasIcon:!0,onClick:n,"aria-label":`Remove reboot profile ${i.title}`,children:[e.jsx(c.Icon,{name:c.ICONS.delete}),e.jsx("span",{children:"Remove"})]})]}),e.jsxs(R,{children:[e.jsx(R.Item,{children:e.jsxs(_,{children:[e.jsx(_.Item,{label:"Title",value:i.title}),e.jsx(_.Item,{label:"Access group",value:I?.data.find(h=>h.name===i.access_group)?.title??i.access_group})]})}),e.jsx(R.Item,{title:"Reboot schedule",children:e.jsxs(_,{children:[e.jsx(_.Item,{label:"Schedule",large:!0,value:Re(i)}),e.jsx(_.Item,{label:"Next reboot",large:!0,value:X(i.next_run).format(J)})]})}),e.jsxs(R.Item,{title:"Association",children:[i.all_computers&&e.jsx("p",{children:"This profile has been associated with all instances."}),!i.all_computers&&!i.tags.length&&e.jsx("p",{children:"This profile has not yet been associated with any instances."}),(i.all_computers||!!i.tags.length)&&e.jsxs(_,{children:[!i.all_computers&&e.jsx(_.Item,{label:"Tags",large:!0,value:i.tags.join(", ")||null,type:"truncated"}),e.jsx(_.Item,{label:"Associated instances",large:!0,value:e.jsx(se,{rebootProfile:i})})]})]})]})]}),e.jsx(re,{isOpen:t,title:"Remove reboot profile",confirmButtonLabel:"Remove",confirmButtonAppearance:"negative",onConfirm:s,confirmButtonDisabled:g,confirmButtonLoading:g,close:r,confirmationText:`remove ${i.title}`,children:e.jsxs("p",{children:['Are you sure you want to remove "',i.title,'" reboot profile? The removal of "',i.title,'" reboot profile is irreversible and might adversely affect your system.']})})]})},Ge=()=>{const{rebootProfile:t,isGettingRebootProfile:r}=E();return r?e.jsx(p.LoadingState,{}):e.jsxs(e.Fragment,{children:[e.jsxs(p.Header,{children:["Duplicate ",t.title]}),e.jsx(p.Content,{children:e.jsx(C,{action:"duplicate",profile:t})})]})},qe=()=>{const{rebootProfile:t,isGettingRebootProfile:r}=E();return r?e.jsx(p.LoadingState,{}):e.jsxs(e.Fragment,{children:[e.jsxs(p.Header,{children:["Edit ",t.title]}),e.jsxs(p.Content,{children:[e.jsx(C,{action:"edit",profile:t}),";"]})]})};export{Oe as RebootProfileAddSidePanel,$e as RebootProfileDetailsSidePanel,Ge as RebootProfileDuplicateSidePanel,qe as RebootProfileEditSidePanel,Qe as RebootProfilesContainer,C as RebootProfilesForm,Ue as RebootProfilesHeader,ze as RebootProfilesList};
