import{i as F,g as w,y as A,V as k,r as b,A as D,C as N,v as i,G as j,a5 as o,j as e,o as T,m as l}from"./index-Df03TKU2.js";import{R as I}from"./RadioGroup-DXzIQ1ZC.js";import{S as O}from"./SidePanelFormButtons-DUBJux5O.js";import{g as x}from"./formikErrors-Bw8iTXYS.js";import"./SidePanelFormButtons.module-D2P5PizG.js";const B=()=>{const r=F(),{isPending:f,mutateAsync:m}=w({mutationFn:async({id:y,...g})=>r.get(`security-profiles/${y}/report`,{params:g})});return{getSecurityProfileReport:m,isSecurityProfileReportLoading:f}},E="_dateRange_1sfaj_1",L="_date_1sfaj_1",q="_separator_1sfaj_9",p={dateRange:E,date:L,separator:q},$=({profileId:r,hasBackButton:f,onBackButtonPress:m})=>{const y=A(),{getSingleActivityQuery:g}=k(),{getSecurityProfileReport:R,isSecurityProfileReportLoading:S}=B(),[_,u]=b.useState({type:"okay"}),d=JSON.parse(localStorage.getItem("_landscape_pendingSecurityProfileReports")??"[]"),n=d.find(a=>a.profileId==r),{data:c,isLoading:P}=g({activityId:(n==null?void 0:n.activityId)??0},{enabled:!!n,refetchInterval:1e3});b.useEffect(()=>{c&&(c.data.activity_status=="succeeded"?u({type:"ready",report_uri:c.data.result_text}):u({type:"pending"}))},[c]);const t=D({initialValues:{audit_timeframe:"specific-date",end_date:i().format(o),start_date:i().format(o),level_of_detail:"summary-only"},validateOnMount:!0,validationSchema:N().shape({end_date:j().when(["audit_timeframe","start_date"],([a,s],v)=>a=="date-range"?v.required("This field is required.").test({test:h=>i(h).isSameOrAfter(i(s)),message:"The end date must not be before the start date."}).test({test:h=>i(h).utc(!0).isSameOrBefore(i()),message:"The end date must not be in the future."}):v),start_date:j().required("This field is required.").test({test:a=>i(a).utc(!0).isSameOrBefore(i()),message:"The date must not be in the future."})}),onSubmit:async a=>{try{const s=(await R({id:r,detailed:a.level_of_detail=="detailed-view"||void 0,end_date:a.end_date,start_date:a.start_date})).data;if(s.activity_status=="succeeded"){u({type:"ready",report_uri:s.result_text});return}u({type:"pending"}),n?n.activityId=s.id:d.push({activityId:s.id,profileId:r}),localStorage.setItem("_landscape_pendingSecurityProfileReports",JSON.stringify(d))}catch(s){y(s);return}}});return P?e.jsx(T,{}):e.jsxs(e.Fragment,{children:[_.type=="pending"&&e.jsx(l.Notification,{inline:!0,title:"Your audit is being generated:",children:"Depending on the size and complexity of the audit, this may take up to 5 minutes."}),_.type=="ready"&&e.jsxs(l.Notification,{inline:!0,title:"Your requested audit is ready:",onDismiss:()=>{const a=d.findIndex(s=>s.profileId==r);a!=-1&&(d.splice(a,1),localStorage.setItem("_landscape_pendingSecurityProfileReports",JSON.stringify(d)))},children:["It has been successfully generated and is now available for download."," ",e.jsx("a",{href:_.report_uri,download:!0,children:"Download audit"})]}),e.jsx("p",{children:"Customize the audit by selecting the scope and the timeframe."}),e.jsx(I,{label:"Audit timeframe",field:"audit_timeframe",formik:t,inputs:[{key:"specific-date",label:"Specific date",expansion:e.jsx(l.Input,{type:"date",...t.getFieldProps("start_date"),error:x(t,"start_date"),max:i().utc().format(o)})},{key:"date-range",label:"Date range",expansion:e.jsxs("div",{className:p.dateRange,children:[e.jsx("div",{className:p.date,children:e.jsx(l.Input,{type:"date",...t.getFieldProps("start_date"),error:x(t,"start_date"),max:i(t.values.end_date).utc().format(o)})}),e.jsx("span",{className:p.separator,children:"-"}),e.jsx("div",{className:p.date,children:e.jsx(l.Input,{type:"date",...t.getFieldProps("end_date"),error:x(t,"end_date"),max:i().utc().format(o),min:i(t.values.start_date).format(o)})})]})}]}),e.jsx(I,{label:"Level of detail",field:"level_of_detail",formik:t,inputs:[{key:"summary-only",label:"Summary only",help:"High-level overview of audit results"},{key:"detailed-view",label:"Detailed view",help:"Includes rules ID, severity, identifiers and references, description, rationale"}]}),e.jsx(O,{onSubmit:()=>{t.handleSubmit()},submitButtonDisabled:!t.isValid||S,submitButtonLoading:S,submitButtonText:"Generate CSV",hasBackButton:f,onBackButtonPress:m})]})};export{$ as default};
