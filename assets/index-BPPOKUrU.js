import{f as A,v as $,w as k,j as e,g as V,r as T,ap as L,d as y,e as B,I as _,G as H,z as Q,B as Y,y as K,C as W,p as v,i as G,l as U}from"./index-DYykpNVa.js";import{S as J}from"./SidePanelFormButtons-Aj5ThB2m.js";import"./EmployeeList-BGX_o-u-.js";import{D as X}from"./downshift.esm-CVSNbv_O.js";import{u as Z}from"./useInfiniteQuery-uvFBsnEF.js";import{g as ee}from"./formikErrors-Bw8iTXYS.js";import"./SidePanelFormButtons.module-CcPyiogC.js";import"./constants-CXofZZ4i.js";import"./NoData-CT6SeJUX.js";import"./ResponsiveTable-C-8YbfBJ.js";import"./TruncatedCell-DQQZxgbr.js";import"./Truncated-DtD6hAHP.js";const te=()=>{const t=A(),n=$(),{mutateAsync:l,isPending:i}=k({mutationKey:["employee","associate"],mutationFn:async({employee_id:s,...a})=>t.post(`employees/${s}/computers`,a),onSuccess:(s,a)=>{n.invalidateQueries({queryKey:["instances",a.computer_id]})}});return{associateEmployeeWithInstance:l,isAssociating:i}},se=({search:t,limit:n,enabled:l})=>{const i=A(),s=["employees",t],{data:a,isPending:h,isFetchingNextPage:g,hasNextPage:d,fetchNextPage:m,error:u}=Z({queryKey:s,queryFn:async({pageParam:r=0})=>i.get("employees",{params:{search:t||void 0,limit:n,offset:r*n}}),initialPageParam:0,getNextPageParam:(r,b,E)=>{const x=E+1;if(r.data.count>x*n)return x},enabled:l});return{employees:a?a.pages.flatMap(r=>r.data.results):[],isPending:h,isFetchingNextPage:g,hasNextPage:d,fetchNextPage:m,error:u}},oe="_container_1xz3o_1",ne="_suggestionsContainer_1xz3o_5",ae="_pointer_1xz3o_14",le="_highlighted_1xz3o_19",ie="_selectedEmployee__container_1xz3o_23",re="_selectedEmployee__name_1xz3o_31",ce="_selectedEmployee__button_1xz3o_36",me="_selectedEmployee__icon_1xz3o_45",ue="_errorMessage_1xz3o_49",p={container:oe,suggestionsContainer:ne,pointer:ae,highlighted:le,selectedEmployee__container:ie,selectedEmployee__name:re,selectedEmployee__button:ce,selectedEmployee__icon:me,errorMessage:ue},pe=200,de=20,he=1.25,ge=(t,n)=>{const l=t.toLowerCase(),i=n.toLowerCase(),s=l.indexOf(i);return s>=0?e.jsxs(e.Fragment,{children:[t.substring(0,s),e.jsx("strong",{children:t.substring(s,s+n.length)}),t.substring(s+n.length)]}):t},_e=({employee:t,setEmployee:n,error:l})=>{const{value:i,setTrue:s,setFalse:a}=V(!1),[h,g]=T.useState(""),[d,m]=L("",pe),u=T.useRef(null),{employees:c,isPending:r,isFetchingNextPage:b,hasNextPage:E,fetchNextPage:x,error:I}=se({search:d,limit:de,enabled:i});if(I)throw I;const D=o=>t?.id!==o.id,P=c.filter(D),z=()=>{n(null)},w=(o=!0)=>{g(""),m.cancel(),m(""),o&&s()},R=()=>{s()},q=o=>{if(g(o),!o){m.cancel(),m(""),s();return}m(o),s()},M=o=>{o&&(n(o),a(),w(!1),u.current?.blur())},O=o=>{const{scrollTop:N,scrollHeight:S,clientHeight:j}=o.currentTarget;S-N<=j*he&&E&&!b&&x()},C=c.length===0&&d&&!r?`No employees found by "${d}"`:null;return e.jsxs("div",{className:_(p.container,{"is-error":!!l}),children:[e.jsx(X,{onSelect:M,itemToString:o=>o?o.name:"",isOpen:i,onOuterClick:a,children:({getInputProps:o,getItemProps:N,getMenuProps:S,highlightedIndex:j})=>e.jsxs("div",{className:"p-autocomplete",children:[e.jsx("label",{className:"p-form__label",htmlFor:"employee-searchbox",id:"employee-searchbox-label",children:"Employee"}),e.jsx(y.SearchBox,{...o(),id:"employee-searchbox",placeholder:"Search for an employee",className:"u-no-margin--bottom",shouldRefocusAfterReset:!0,externallyControlled:!0,autocomplete:"off",value:h,ref:u,onChange:q,onClear:w,onBlur:a,onFocus:R}),C?e.jsx("span",{className:"p-form-help-text",children:C}):null,i&&(P.length>0||r)?e.jsx("ul",{className:_("p-list p-card--highlighted u-no-padding u-no-margin--bottom p-autocomplete__suggestions",p.suggestionsContainer),...S(),onScroll:O,children:r?e.jsx(B,{}):e.jsxs(e.Fragment,{children:[P.map((f,F)=>e.jsx("li",{className:_("p-list__item",p.pointer,{[p.highlighted]:j===F}),...N({item:f,index:F}),children:e.jsx("div",{className:"u-truncate","data-testid":"dropdownElement",children:ge(f.name,h)})},f.id)),b&&e.jsx("li",{className:"p-list__item u-align--center",children:e.jsx(B,{})})]})}):null]})}),!!l&&e.jsx("p",{className:_(p.errorMessage,"p-form-validation__message is-error"),children:l}),t&&e.jsx("ul",{className:"p-list p-autocomplete__result-list u-no-margin--bottom",children:e.jsxs("li",{className:_("p-autocomplete__result p-list__item p-card u-no-margin--bottom",p.selectedEmployee__container),children:[e.jsx("span",{className:p.selectedEmployee__name,children:t.name}),e.jsx(y.Button,{type:"button",title:"Remove",appearance:"link",className:_("u-no-margin--bottom",p.selectedEmployee__button),onClick:z,children:e.jsx(y.Icon,{name:y.ICONS.delete,className:p.selectedEmployee__icon})})]},t.id)})]})},Te=({instanceTitle:t})=>{const{instanceId:n,childInstanceId:l}=H(),i=Q(),{notify:s}=Y(),{closeSidePanel:a}=K(),h=Number(l??n),{associateEmployeeWithInstance:g,isAssociating:d}=te(),m=async c=>{if(c.employee)try{await g({computer_id:h,employee_id:c.employee.id}),a(),s.success({title:`You have successfully associated ${c.employee.name}`,message:`${c.employee.name} has been successfully associated with ${t}.`})}catch(r){i(r)}},u=W({initialValues:{employee:null},validationSchema:v().shape({employee:v().shape({id:U().required(),name:G().required()}).nullable().required("This field is required.")}),enableReinitialize:!0,onSubmit:m});return e.jsxs(y.Form,{noValidate:!0,onSubmit:u.handleSubmit,children:[e.jsx("p",{children:"You can associate the instance with the selected employee, allowing them to view its details and recovery key."}),e.jsx(_e,{employee:u.values.employee,setEmployee:async c=>await u.setFieldValue("employee",c),error:ee(u,"employee")}),e.jsx(J,{submitButtonDisabled:d,submitButtonText:"Associate",submitButtonAppearance:"positive"})]})};export{Te as default};
