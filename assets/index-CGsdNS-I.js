import{j as e,f as S,b as U,c as I,d as i,a as se,R as Y,r as b,L as ne,t as V,i as te}from"./index-CQs3wXys.js";import{T as le}from"./TablePagination-DIiSuGph.js";import{a as T}from"./useUsns-PbelDNjT.js";import{I as $}from"./InfoItem-BtzYmEJw.js";import{u as re}from"./useConfirm-9PPCxKmU.js";import{u as ie}from"./formik.esm-C_3GEhhV.js";import{h as M}from"./moment-Cl4UOzQZ.js";import{S as W}from"./SidePanelFormButtons-CTKwSU1t.js";import{c as oe,a as R,f as de,d as G}from"./index.esm-85kEx3I1.js";import{u as ce,D as ue}from"./downshift.esm-DQPiC2RL.js";import"./useFetchOld-D-5JyUuM.js";import"./useMutation-D9dT1mhA.js";import"./useQuery-DrwXjJzc.js";import"./SidePanelFormButtons.module-CoxOjuX8.js";const me="_bold_c3q8d_1",pe="_radioGroup_c3q8d_5",he="_marginTop_c3q8d_10",k={bold:me,radioGroup:pe,marginTop:he},ge={deliver_after:"",deliver_delay_window:0,deliver_immediately:!0,randomize_delivery:!1,version:""},be={remove:"Remove",upgrade:"Upgrade",downgrade:"Downgrade"},ve="_bold_nffzr_1",F={bold:ve},xe=({packageCount:s,securityUpgradePackageCount:a,totalUpgradePackageCount:n})=>{const l=n-a,d=s-n;return e.jsxs("div",{children:[e.jsx("span",{children:"You selected "}),e.jsx("span",{className:F.bold,children:s}),e.jsx("span",{children:" packages. This will:"}),e.jsxs("ul",{className:S({"u-no-margin--bottom":d>0}),children:[a>0&&e.jsxs("li",{children:[e.jsx("span",{children:"apply "}),e.jsx("span",{className:F.bold,children:a}),e.jsx("span",{children:a===1?" security upgrade":" security upgrades"})]}),l>0&&e.jsxs("li",{children:[e.jsx("span",{children:"apply "}),e.jsx("span",{className:F.bold,children:l}),e.jsx("span",{children:l===1?" regular upgrade":" regular upgrades"})]})]}),d>0&&e.jsxs("p",{children:[e.jsx("span",{children:"No upgrades for "}),e.jsx("span",{className:F.bold,children:d}),e.jsx("span",{children:d===1?" package needed.":" packages needed."})]})]})},K=({action:s,instanceId:a,packages:n})=>{const l=U(),{closeSidePanel:d}=I(),{downgradePackageVersionQuery:o,getDowngradePackageVersionsQuery:m,removePackagesQuery:g,upgradePackagesQuery:h}=T(),{data:v}=m({instanceId:a,packageName:n[0].name},{enabled:s==="downgrade"}),c=v&&v.data.results.length>0?v.data.results.map(({version:p})=>({label:p,value:p})):[];c.unshift({label:"Select version",value:""});const j=n.filter(({status:p})=>["upgrade","security"].includes(p)).map(({name:p})=>p),x=n.filter(({status:p})=>p==="security").length,{mutateAsync:f}=o,{mutateAsync:y}=g,{mutateAsync:C}=h,_=oe({deliver_after:R().test({test:p=>p?M(p).isValid():!0,message:"You have to enter a valid date and time"}),deliver_delay_window:de().min(0,"Delivery delay must be greater than or equal to 0"),deliver_immediately:G(),randomize_delivery:G(),version:R().test({name:"required",message:"This field is required",params:{action:s},test:p=>s!=="downgrade"||!!p})}),t=ie({initialValues:ge,validationSchema:_,onSubmit:async p=>{const A={query:`id:${a}`,deliver_after:p.deliver_immediately?void 0:`${p.deliver_after}:00Z`,deliver_delay_window:p.randomize_delivery?p.deliver_delay_window:void 0};try{s==="remove"?await y({...A,packages:n.filter(N=>N.current_version).map(({name:N})=>N)}):s==="upgrade"?await C({...A,packages:j}):s==="downgrade"&&await f({instanceId:a,package_name:n[0].name,package_version:p.version}),d()}catch(N){l(N)}}});return e.jsxs(i.Form,{onSubmit:t.handleSubmit,noValidate:!0,children:[s==="downgrade"&&e.jsxs(i.Row,{className:"u-no-padding--left u-no-padding--right",children:[e.jsx(i.Col,{size:6,children:e.jsx($,{label:"Current version",value:n[0].current_version})}),e.jsx(i.Col,{size:6,children:c.length>1?e.jsx(i.Select,{label:"New version",className:"",labelClassName:"p-text--small u-text--muted u-no-margin--bottom p-text--small-caps",...t.getFieldProps("version"),options:c}):e.jsx("p",{children:"No downgrade versions"})})]}),s==="upgrade"&&(n.length!==j.length||x>0)&&e.jsx(xe,{packageCount:n.length,securityUpgradePackageCount:x,totalUpgradePackageCount:j.length}),["remove","upgrade"].includes(s)&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:k.bold,children:"Delivery time"}),e.jsxs("div",{className:k.radioGroup,children:[e.jsx(i.Input,{type:"radio",label:"As soon as possible",name:"deliver_immediately",checked:t.values.deliver_immediately,onChange:()=>{t.setFieldValue("deliver_immediately",!0)}}),e.jsx(i.Input,{type:"radio",label:"Scheduled",name:"deliver_immediately",checked:!t.values.deliver_immediately,onChange:()=>{t.setFieldValue("deliver_immediately",!1),t.setFieldValue("deliver_after",M().toISOString().slice(0,16))}})]}),!t.values.deliver_immediately&&e.jsx(i.Input,{type:"datetime-local",label:"Deliver after",labelClassName:"u-off-screen",...t.getFieldProps("deliver_after"),error:t.touched.deliver_after&&t.errors.deliver_after?t.errors.deliver_after:void 0}),e.jsx("span",{className:S(k.bold,k.marginTop),children:"Randomise delivery over a time window"}),e.jsxs("div",{className:k.radioGroup,children:[e.jsx(i.Input,{type:"radio",label:"No",name:"randomize_delivery",checked:!t.values.randomize_delivery,onChange:async()=>{await t.setFieldValue("randomize_delivery",!1),await t.setFieldValue("deliver_delay_window",0)}}),e.jsx(i.Input,{type:"radio",label:"Yes",name:"randomize_delivery",checked:t.values.randomize_delivery,onChange:()=>t.setFieldValue("randomize_delivery",!0)})]}),t.values.randomize_delivery&&e.jsx(i.Input,{type:"number",inputMode:"numeric",min:0,label:"Delivery delay window",labelClassName:"u-off-screen",help:"Time in minutes",...t.getFieldProps("deliver_delay_window"),error:t.touched.deliver_delay_window&&t.errors.deliver_delay_window?t.errors.deliver_delay_window:void 0})]}),(["remove","upgrade"].includes(s)||c.length>1)&&e.jsx(W,{submitButtonDisabled:t.isSubmitting,submitButtonText:be[s],submitButtonAppearance:s==="remove"?"negative":"positive"})]})},_e=({instanceId:s,singlePackage:a})=>{const n=U(),{setSidePanelContent:l}=I(),{confirmModal:d,closeConfirmModal:o}=re(),{installPackagesQuery:m}=T(),{mutateAsync:g,isLoading:h}=m,v=x=>{l(`${{remove:"Uninstall",upgrade:"Upgrade",downgrade:"Downgrade"}[x]} ${a.name}`,e.jsx(K,{action:x,instanceId:s,packages:[a]}))},c=async()=>{try{await g({packages:[a.name],query:`id:${s}`})}catch(x){n(x)}finally{o()}},j=()=>{d({title:"Install package",body:`Are you sure you want to install "${a.name}" package?`,buttons:[e.jsx(i.Button,{appearance:"positive",disabled:h,onClick:c,children:"Install"},"install")]})};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-segmented-control",children:[a.current_version&&e.jsxs(i.Button,{type:"button",className:"p-segmented-control__button has-icon",onClick:()=>{v("remove")},children:[e.jsx("i",{className:"p-icon--delete"}),e.jsx("span",{children:"Uninstall"})]}),a.available_version&&e.jsxs(i.Button,{type:"button",className:"p-segmented-control__button has-icon",onClick:()=>{v("upgrade")},children:[e.jsx("i",{className:"p-icon--change-version"}),e.jsx("span",{children:"Upgrade"})]}),a.current_version&&e.jsxs(i.Button,{type:"button",className:"p-segmented-control__button has-icon",onClick:()=>{v("downgrade")},children:[e.jsx("i",{className:"p-icon--begin-downloading"}),e.jsx("span",{children:"Downgrade"})]}),a.available_version&&!a.current_version&&e.jsxs(i.Button,{type:"button",className:"p-segmented-control__button has-icon",onClick:j,children:[e.jsx("i",{className:"p-icon--plus"}),e.jsx("span",{children:"Install"})]})]},"buttons"),e.jsx("div",{children:e.jsx($,{label:"Package name",value:a.name})}),e.jsx("div",{children:e.jsx($,{label:"Summary",value:a.summary})}),e.jsxs(i.Row,{className:"u-no-padding--left u-no-padding--right",children:[e.jsx(i.Col,{size:6,children:e.jsx($,{label:"Current version",value:a.current_version})}),a.available_version&&e.jsx(i.Col,{size:6,children:e.jsx($,{label:"Upgeradable to",value:a.available_version})})]})]})},je=({instance:s,onDismiss:a})=>{const n=se();return e.jsxs(i.Notification,{severity:"caution",onDismiss:a,children:[e.jsx("strong",{children:"Some upgrades require Ubuntu Pro: "}),e.jsxs("span",{children:["Your current Ubuntu package upgrades are limited. To unlock full upgrades, please upgrade to Ubuntu Pro."," "]}),e.jsx(i.Button,{type:"button",appearance:"link",onClick:()=>{n(`${Y}instances/${s.parent?`${s.parent.id}/${s.id}`:s.id}`,{state:{tab:"ubuntu-pro"}})},children:"Learn more"})]})},fe={available_version:null,current_version:null,name:"loading",status:"available",summary:""},ye="_checkbox_p36ti_1",Ce="_details_p36ti_5",Ne="_tooltipLink_p36ti_9",Se="_hidden_p36ti_13",L={checkbox:ye,details:Ce,tooltipLink:Ne,hidden:Se},q=s=>!!s.available_version&&!!s.current_version&&s.available_version.includes("ubuntu-pro"),Q=s=>{const a={label:"Unknown",icon:""};return s.status==="available"?(a.label="Available",a.icon="status-queued-small"):s.status==="held"?(a.label="Held",a.icon="status-in-progress-small"):s.status==="security"?(a.label="Security upgrade",a.icon="status-failed-small"):s.status==="upgrade"?(a.label="Regular upgrade",a.icon="status-waiting-small"):s.status==="installed"&&(a.label="Installed",a.icon="status-succeeded-small"),a},we=({column:s,row:a})=>{const n={};return a.original.name==="loading"?s.id==="name"?n.colSpan=5:(n.className=L.hidden,n["aria-hidden"]=!0):s.id==="checkbox"?n["aria-label"]=`Toggle ${a.original.name} package`:s.id==="name"?n.role="rowheader":s.id==="status"?n["aria-label"]="Status":s.id==="current_version"?n["aria-label"]="Current version":s.id==="available_version"?n["aria-label"]="Available version":s.id==="summary"&&(n["aria-label"]="Details"),n},ke=({emptyMsg:s,instance:a,onPackagesSelect:n,packages:l,packagesLoading:d,selectedPackages:o,selectAll:m})=>{const[g,h]=b.useState(!1),[v,c]=b.useState(!1),{setSidePanelContent:j}=I(),x=b.useMemo(()=>d?[fe]:l,[l,d]),f=r=>{n(o.some(({name:t})=>t===r.name)?o.filter(({name:t})=>t!==r.name):[...o,r])},y=()=>{n(o.length>0?[]:l.filter(r=>!q(r)))};b.useEffect(()=>{!m||g||!l.length||(y(),h(!0))},[m,l]);const C=r=>{j("Package details",e.jsx(_e,{singlePackage:r,instanceId:a.id}))},_=b.useMemo(()=>[{accessor:"checkbox",className:L.checkbox,Header:e.jsx(i.CheckboxInput,{inline:!0,label:e.jsx("span",{className:"u-off-screen",children:"Toggle all"}),checked:o.length===l.length&&l.length>0,indeterminate:o.length<l.length&&o.length>0,disabled:l.length===0,onChange:y}),Cell:({row:r})=>q(r.original)?e.jsx(i.Tooltip,{message:e.jsxs("div",{children:[e.jsx("p",{className:"u-no-padding--top",children:"Ubuntu Pro is required"}),e.jsx(ne,{to:`${Y}instances/${a.parent?`${a.parent.id}/${a.id}`:a.id}`,state:{tab:"ubuntu-pro"},className:L.tooltipLink,children:"learn more"})]}),children:e.jsx(i.CheckboxInput,{inline:!0,disabled:!0,label:e.jsx("span",{className:"u-off-screen",children:`Toggle ${r.original.name}`}),checked:o.some(({name:t})=>t===r.original.name),onChange:()=>{f(r.original)}})}):e.jsx(i.CheckboxInput,{inline:!0,label:e.jsx("span",{className:"u-off-screen",children:`Toggle ${r.original.name}`}),checked:o.some(({name:t})=>t===r.original.name),onChange:()=>{f(r.original)}})},{accessor:"name",Header:"Name",Cell:({row:r})=>r.original.name==="loading"?e.jsx(V,{}):e.jsx(i.Button,{type:"button",appearance:"link",className:"u-no-margin--bottom u-no-padding--top u-align-text--left",onClick:()=>{C(r.original)},children:r.original.name})},{accessor:"status",Header:"Status",Cell:({row:{original:r}})=>Q(r).label,getCellIcon:({row:{original:r}})=>Q(r).icon},{accessor:"current_version",Header:"Current version"},{accessor:"summary",className:L.details,Header:"Details",Cell:({row:{original:r}})=>r.available_version?e.jsxs(e.Fragment,{children:[e.jsx("span",{children:r.summary}),e.jsx("br",{}),e.jsx("span",{children:`available version: ${r.available_version}`})]}):r.summary}],[l,o.length]);return e.jsxs(e.Fragment,{children:[!v&&l.some(q)&&e.jsx(je,{instance:a,onDismiss:()=>c(!0)}),e.jsx(i.ModularTable,{columns:_,data:x,getCellProps:we,emptyMsg:s})]})},Pe="_container_1qwn6_1",$e="_searchContainer_1qwn6_6",Ie="_selectContainer_1qwn6_10",Te="_cta_1qwn6_15",B={container:Pe,searchContainer:$e,selectContainer:Ie,cta:Te},Ae="_container_1d6qb_1",De="_suggestionsContainer_1d6qb_5",Fe="_pointer_1d6qb_12",Be="_highlighted_1d6qb_17",Le="_selectedContainer_1d6qb_21",P={container:Ae,suggestionsContainer:De,pointer:Fe,highlighted:Be,selectedContainer:Le},Ue=200,qe=(s,a)=>{const n=s.toLowerCase(),l=a.toLowerCase(),d=n.indexOf(l);return d>=0?e.jsxs(e.Fragment,{children:[s.substring(0,d),e.jsx("strong",{children:s.substring(d,d+a.length)}),s.substring(d+a.length)]}):s},ze=({instanceId:s,selectedItems:a,setSelectedItems:n})=>{var H;const[l,d]=b.useState(""),[o,m]=b.useState(!1),[g,h]=b.useState(""),v=U(),{getInstancePackagesQuery:c}=T(),{data:j,isFetching:x}=c({instance_id:s,available:!0,installed:!1,upgrade:!1,held:!1,limit:50,search:l},{enabled:l.length>2}),f=((H=j==null?void 0:j.data)==null?void 0:H.results)??[],y=u=>!a.map(w=>w.name).includes(u.name),C=f.filter(y),_=u=>{n(a.filter(w=>w.name!==u))},r=()=>{m(!1)},t=()=>{h(""),d("")},p=()=>{g.length>2?m(!0):m(!1)},A=u=>{h(u),u.length>2&&d(u)},N=ce(()=>{try{p()}catch(u){v(u)}},Ue),Z=u=>{n([...a,u]),t()},J=u=>{u&&(Z(u),m(!1))},X=u=>{u.key==="Escape"?u.currentTarget.blur():N()},E=!o&&g.length<3?"Min 3. characters":f.length===0&&l&&!x?`No packages found by "${l}"`:null;return e.jsxs("div",{className:P.container,children:[e.jsx(ue,{onSelect:J,itemToString:()=>"",isOpen:o,children:({getInputProps:u,getItemProps:w,getMenuProps:ee,highlightedIndex:ae})=>e.jsxs("div",{className:"p-autocomplete",children:[e.jsx(i.SearchBox,{...u(),placeholder:"Search for available packages",className:"u-no-margin--bottom",shouldRefocusAfterReset:!0,externallyControlled:!0,autocomplete:"off",value:g,onChange:A,onClear:t,onBlur:r,onFocus:p,onKeyUp:X}),E?e.jsx("span",{className:"p-form-help-text",children:E}):null,o&&(C.length>0||x)?e.jsx("ul",{className:S("p-list p-card--highlighted u-no-padding u-no-margin--bottom p-autocomplete__suggestions",P.suggestionsContainer),...ee(),children:x?e.jsx(V,{}):C.map((D,O)=>e.jsxs("li",{className:S("p-list__item",P.pointer,{[P.highlighted]:ae===O}),...w({item:D,index:O}),children:[e.jsx("div",{className:"u-truncate","data-testid":"dropdownElement",children:qe(D.name,l)}),e.jsx("div",{children:e.jsx("small",{className:"u-text-muted",children:D.current_version})})]},D.name))}):null]})}),e.jsx("ul",{className:"p-list p-autocomplete__result-list u-no-margin--bottom",children:a.length?a.map(u=>e.jsxs("li",{className:S("p-autocomplete__result p-list__item p-card u-no-margin--bottom",P.selectedContainer),children:[e.jsxs("div",{children:[e.jsx("div",{children:u.name}),e.jsx("span",{children:e.jsx("small",{className:"u-text--muted p-text--small",children:u.current_version})})]}),e.jsx(i.Button,{appearance:"link",className:"u-no-margin--bottom u-no-padding--top",onClick:()=>_(u.name),children:e.jsx("i",{className:"p-icon--delete"})})]},u.name)):null})]})},Ve=({instanceId:s})=>{const[a,n]=b.useState([]),l=U(),{notify:d}=te(),{installPackagesQuery:o}=T(),{closeSidePanel:m}=I(),{mutateAsync:g,isLoading:h}=o,v=async()=>{try{await g({packages:a.map(({name:c})=>c),query:`id:${s}`}),m(),d.success({message:`You queued ${a.length===1?`package ${a[0].name}`:`${a.length} packages`} to be installed.`})}catch(c){l(c)}};return e.jsxs(e.Fragment,{children:[e.jsx(ze,{instanceId:s,selectedItems:a,setSelectedItems:c=>n(c)}),e.jsx(W,{submitButtonDisabled:h||a.length===0,submitButtonText:"Install packages",submitButtonAppearance:"positive",onSubmit:v})]})},Ee="_container_1nwlw_1",He="_noWrap_1nwlw_5",z={container:Ee,noWrap:He},Oe=({instance:s,selectedPackages:a})=>{const{setSidePanelContent:n}=I(),l=o=>{const m=a.length===1?a[0].name:`${a.length} selected packages`;n(o==="remove"?`Remove ${m}`:`Upgrade ${m}`,e.jsx(K,{action:o,packages:a,instanceId:s.id}))},d=()=>{n("Install packages",e.jsx(Ve,{instanceId:s.id}))};return e.jsxs("div",{className:z.container,children:[e.jsxs(i.Button,{type:"button",onClick:d,hasIcon:!0,className:z.noWrap,children:[e.jsx("i",{className:"p-icon--plus"}),e.jsx("span",{children:"Install"})]}),e.jsxs("div",{className:S("p-segmented-control is-small",z.noWrap),children:[e.jsxs(i.Button,{type:"button",className:"p-segmented-control__button has-icon",disabled:a.length===0||a.every(o=>!o.current_version),onClick:()=>l("remove"),children:[e.jsx("i",{className:"p-icon--delete"}),e.jsx("span",{children:"Uninstall"})]}),e.jsxs(i.Button,{type:"button",className:"p-segmented-control__button has-icon",disabled:a.length===0||a.every(o=>!o.available_version),onClick:()=>l("upgrade"),children:[e.jsx("i",{className:"p-icon--change-version"}),e.jsx("span",{children:"Upgrade"})]})]},"buttons")]})},Me=[{label:"All",value:""},{label:"Installed",value:"installed"},{label:"Upgrades",value:"upgrade"},{label:"Security upgrades",value:"security"},{label:"Held",value:"held"}],Re=({filter:s,instance:a,onFilterChange:n,onPackageSearchChange:l,selectedPackages:d})=>{const[o,m]=b.useState(""),g=h=>{h.preventDefault(),l(o)};return e.jsxs("div",{className:B.container,children:[e.jsx("div",{className:B.searchContainer,children:e.jsx(i.Form,{onSubmit:g,noValidate:!0,children:e.jsx(i.SearchBox,{shouldRefocusAfterReset:!0,externallyControlled:!0,autocomplete:"off",value:o,onChange:h=>m(h),onSearch:()=>l(o),onClear:()=>{m(""),l("")}})})}),e.jsx(i.Select,{label:"Status",wrapperClassName:B.selectContainer,options:Me,value:s,onChange:h=>{n(h.target.value)}}),e.jsx("div",{className:B.cta,children:e.jsx(Oe,{selectedPackages:d,instance:a})})]})},Ge=(s,a)=>{let n;return s===""?n="No packages found":s==="upgrade"?n="No available upgrades found":s==="security"?n="No available security upgrades found":s==="installed"?n="No installed packages found":n="No held packages found",a?`${n} with the search "${a}"`:n},Qe=({instance:s,tabState:a})=>{const[n,l]=b.useState(1),[d,o]=b.useState(20),[m,g]=b.useState([]),[h,v]=b.useState(""),[c,j]=b.useState("");b.useEffect(()=>{a&&f(a.filter)},[a]);const x=t=>{v(t),l(1),g([])},f=t=>{j(t),l(1),g([])},y=t=>{o(t),l(1)},{getInstancePackagesQuery:C}=T(),{data:_,isLoading:r}=C({instance_id:s.id,search:h,limit:d,offset:(n-1)*d,available:!1,installed:c==="installed"||!c||void 0,upgrade:c==="upgrade"||void 0,held:c==="held"||void 0,security:c==="security"||void 0},{enabled:!!s});return e.jsxs(e.Fragment,{children:[!h&&!c&&n===1&&d===20&&r&&e.jsx(V,{}),(h||c||n!==1||d!==20||!r)&&e.jsxs(e.Fragment,{children:[e.jsx(Re,{instance:s,selectedPackages:m,filter:c,onFilterChange:f,onPackageSearchChange:x}),e.jsx(ke,{packages:(_==null?void 0:_.data.results)??[],packagesLoading:r,selectedPackages:m,onPackagesSelect:t=>{g(t)},instance:s,emptyMsg:Ge(c,h),selectAll:(a==null?void 0:a.selectAll)??!1})]}),e.jsx(le,{currentPage:n,totalItems:_==null?void 0:_.data.count,paginate:t=>{l(t)},pageSize:d,setPageSize:y,currentItemCount:_==null?void 0:_.data.results.length})]})},da=Qe;export{da as default};
