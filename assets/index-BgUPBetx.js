import{r as g,ax as V,J as R,j as t,d as i,n as B,M as G,P as l,U as _,O as D,Q as k,x as b,B as U,C as z,o as Z,F as H,q as J,G as m,as as F}from"./index-DdDZs9iJ.js";import{M as C}from"./MultiSelectField-CAV9jDpg.js";import{S as Q}from"./SidePanelFormButtons-BSX-z9y0.js";import"./InstancesPageActions-BB322Y5M.js";import{c as $}from"./ResponsiveButtons-D85C5YGV.js";import{u as Y}from"./useInstances-xzL-A-Ng.js";import{u as K,D as W}from"./DeliveryBlock-B22Fcpek.js";import"./SidePanelFormButtons.module-BuIu-Bem.js";const X="_pagination_svwl5_1",ee={pagination:X},se=({instances:a})=>{const[n,p]=g.useState(V),[o,f]=g.useState(R),c=g.useMemo(()=>[{Header:"Instance",Cell:({row:{original:e}})=>e.title}],[]),d=(n-1)*o,h=a.slice(d,d+o);return t.jsxs(t.Fragment,{children:[t.jsx(i.ModularTable,{columns:c,data:h}),t.jsx(B,{className:ee.pagination,currentItemCount:h.length,currentPage:n,pageSize:o,paginate:p,setPageSize:f,totalItems:a.length})]})},te={deliver_after:"",deliverImmediately:!0,instanceIds:[],queryType:"tags",tags:[],username:"root",time_limit:300},ae=G().shape({access_group:l(),deliverImmediately:D().required("This field is required."),deliver_after:l().when("deliverImmediately",{is:!1,then:a=>a.required("This field is required").test({test:n=>b(n).isValid()&&b(n).isAfter(b()),message:"You have to enter a valid date and time in the future"})}),instanceIds:_().of(k()).when("queryType",{is:"ids",then:a=>a.min(1,"At least one instance is required.")}),queryType:l().required("This field is required."),tags:_().of(l()).when("queryType",{is:"tags",then:a=>a.min(1,"At least one tag is required.")}),username:l().required("This field is required.")}),ie="_instanceSelectionContainer_f2qf2_1",ne="_radioGroup_f2qf2_9",P={instanceSelectionContainer:ie,radioGroup:ne},fe=({script:a})=>{const n=U(),{notify:p}=z(),{closeSidePanel:o}=Z(),{getAllInstanceTagsQuery:f,getInstancesQuery:c}=Y(),{runScript:d}=K(),e=H({initialValues:te,onSubmit:async s=>{const r={query:s.queryType==="ids"?`id:${s.instanceIds.join(" OR id:")}`:`tag:${s.tags.join(" OR tag:")}`,script_id:a.id,username:s.username,time_limit:Number(s.time_limit),deliver_after:s.deliverImmediately?void 0:F(s.deliver_after).toISOString().replace(/\.\d+(?=Z$)/,"")};s.deliverImmediately||(r.deliver_after=F(s.deliver_after).toISOString().replace(/\.\d+(?=Z$)/,""));try{await d(r),o(),p.success({message:`"${a.title}" script queued to execute successfully`,title:"Script execution queued"})}catch(O){n(O)}},validateOnMount:!0,validationSchema:ae}),[w,x]=g.useState(!1),{data:y,isLoading:A}=f(),{data:I,isLoading:E}=c({query:`access-group-recursive:${a.access_group}`}),{data:S,isLoading:q,error:v}=c({query:`access-group-recursive:${a.access_group} ${e.values.tags.map(s=>`tag:${s}`).join(" OR ")}`},{enabled:!!e.values.tags.length});if(A||E)return t.jsx(J,{});v&&n(v);const N=()=>{x(!1)},L=()=>{x(!0)},T=(y==null?void 0:y.data.results.map(s=>({label:s,value:s})))??[],u=((I==null?void 0:I.data.results.filter(s=>$("runScripts",s)))??[]).map(({title:s,id:r})=>({label:s,value:r})),M=(S==null?void 0:S.data.results.filter(s=>$("runScripts",s)))??[],j=()=>{e.values.queryType=="tags"?L():e.handleSubmit()};return t.jsxs(t.Fragment,{children:[t.jsxs(i.Form,{onSubmit:j,noValidate:!0,children:[t.jsx("p",{className:"u-no-margin--bottom",children:"Select instances by:"}),t.jsx("div",{className:"is-required",children:t.jsxs("div",{children:[t.jsxs("div",{className:P.radioGroup,children:[t.jsx(i.Input,{type:"radio",label:"Tags",...e.getFieldProps("queryType"),onChange:async s=>{e.getFieldProps("queryType").onChange(s),await Promise.all([e.setFieldValue("tags",[]),e.setFieldTouched("tags",!1),e.setFieldValue("instanceIds",[]),e.setFieldTouched("instanceIds",!1)])},value:"tags",checked:e.values.queryType==="tags"}),t.jsx(i.Input,{type:"radio",label:"Instance names",...e.getFieldProps("queryType"),value:"ids",checked:e.values.queryType==="ids",disabled:!u.length,help:!u.length&&"There are no available instances in this script's access group."})]}),t.jsxs("div",{className:P.instanceSelectionContainer,children:[e.values.queryType==="tags"&&t.jsx(C,{placeholder:"Select tags",variant:"condensed",label:"Tags",labelClassName:"u-off-screen",required:!0,...e.getFieldProps("tags"),items:T,selectedItems:T.filter(({value:s})=>e.values.tags.includes(s)),onItemsUpdate:async s=>{e.setFieldValue("tags",s.map(({value:r})=>r)),e.setFieldTouched("tags",!0,!1)},error:m(e,"tags"),scrollOverflow:!0}),e.values.queryType==="ids"&&t.jsx(C,{placeholder:"Select instances",variant:"condensed",label:"Instances",labelClassName:"u-off-screen",required:!0,...e.getFieldProps("instanceIds"),items:u,selectedItems:u.filter(({value:s})=>e.values.instanceIds.includes(s)),onItemsUpdate:async s=>{e.setFieldValue("instanceIds",s.map(({value:r})=>r)),e.setFieldTouched("instanceIds",!0,!1)},error:m(e,"instanceIds"),scrollOverflow:!0})]})]})}),t.jsxs(i.Row,{className:"u-no-padding--left u-no-padding--right",children:[t.jsx(i.Col,{size:6,children:t.jsx(i.Input,{type:"text",label:"Run as user",autoComplete:"off",required:!0,...e.getFieldProps("username"),error:m(e,"username")})}),t.jsx(i.Col,{size:6,children:t.jsx(i.Input,{type:"text",label:"Time limit (seconds)",autoComplete:"off",required:!0,...e.getFieldProps("time_limit"),error:m(e,"time_limit")})})]}),t.jsx(W,{formik:e}),t.jsx(Q,{submitButtonDisabled:e.isSubmitting||!e.isValid,submitButtonText:"Run script",onSubmit:j})]}),w&&t.jsxs(i.ConfirmationModal,{title:`Run ${a.title} script on ${e.values.tags.length>1?`${e.values.tags.length} tags`:`${e.values.tags[0]} tag`}`,confirmButtonLabel:"Run script",onConfirm:()=>{e.handleSubmit()},confirmButtonDisabled:e.isSubmitting||!!v||q,confirmButtonLoading:q,close:N,confirmButtonAppearance:"positive",children:[t.jsxs("p",{children:["This script will run on the following instances, which are associated with the selected"," ",e.values.tags.length==1?"tag":"tags","."]}),t.jsx(se,{instances:M})]})]})};export{fe as default};
