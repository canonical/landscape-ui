import{C as A,G as n,K as h,F as M,H as P,v as u,y as R,z as V,l as k,A as B,r as f,j as t,m as r,a8 as y}from"./index-BnS9w30E.js";import{M as b}from"./MultiSelectField-DTznET1G.js";import{S as O}from"./SidePanelFormButtons-BXVlB7eJ.js";import{b as D}from"./helpers-CotMLEuG.js";import{u as E}from"./useInstances-DlfWyY8u.js";import"./InstancesPageActions-DQ7s6aYe.js";import{g as v}from"./formikErrors-Bw8iTXYS.js";import{u as L,D as z}from"./DeliveryBlock-q6qtsRFf.js";import"./SidePanelFormButtons.module-D2P5PizG.js";const H={deliver_after:"",deliverImmediately:!0,instanceIds:[],queryType:"tags",tags:[],username:"root",time_limit:300},U=A().shape({access_group:n(),deliverImmediately:M().required("This field is required."),deliver_after:n().when("deliverImmediately",{is:!1,then:i=>i.required("This field is required").test({test:l=>u(l).isValid()&&u(l).isAfter(u()),message:"You have to enter a valid date and time in the future"})}),instanceIds:h().of(P()).when("queryType",{is:"ids",then:i=>i.min(1,"At least one instance is required.")}),queryType:n().required("This field is required."),tags:h().of(n()).when("queryType",{is:"tags",then:i=>i.min(1,"At least one tag is required.")}),username:n().required("This field is required.")}),Z="_instanceSelectionContainer_1cpy5_1",G="_table_1cpy5_9",I={instanceSelectionContainer:Z,table:G},ae=({script:i})=>{const l=R(),{notify:S}=V(),{closeSidePanel:q}=k(),{getAllInstanceTagsQuery:x,getInstancesQuery:T}=E(),{runScript:j}=L(),e=B({initialValues:H,onSubmit:async s=>{const a={query:s.queryType==="ids"?`id:${s.instanceIds.join(" OR id:")}`:`tag:${s.tags.join(" OR tag:")}`,script_id:i.id,username:s.username,time_limit:Number(s.time_limit),deliver_after:s.deliverImmediately?void 0:y(s.deliver_after).toISOString().replace(/\.\d+(?=Z$)/,"")};s.deliverImmediately||(a.deliver_after=y(s.deliver_after).toISOString().replace(/\.\d+(?=Z$)/,""));try{await j(a),q(),S.success({message:`"${i.title}" script queued to execute successfully`,title:"Script execution queued"})}catch(N){l(N)}},validationSchema:U}),[_,m]=f.useState(!1),C=()=>{m(!1)},F=()=>{m(!0)},{data:c}=x(),p=(c==null?void 0:c.data.results.map(s=>({label:s,value:s})))??[],{data:d}=T({query:`access-group-recursive:${i.access_group}`}),g=(d==null?void 0:d.data.results.filter(s=>D("runScripts",s)))??[],o=g.map(({title:s,id:a})=>({label:s,value:a})),$=f.useMemo(()=>[{Header:"Instance",Cell:({row:{original:s}})=>s.title}],[]),w=()=>{e.values.queryType=="tags"?F():e.handleSubmit()};return t.jsxs(t.Fragment,{children:[t.jsxs(t.Fragment,{children:[t.jsx("p",{className:"u-no-margin--bottom",children:"Select instances by:"}),t.jsx("div",{className:"is-required",children:t.jsxs("div",{children:[t.jsx(r.Input,{type:"radio",label:"Tags",...e.getFieldProps("queryType"),value:"tags",checked:e.values.queryType==="tags"}),t.jsx(r.Input,{type:"radio",label:"Instance names",...e.getFieldProps("queryType"),value:"ids",checked:e.values.queryType==="ids",disabled:!o.length,help:!o.length&&"There are no available instances in this script's access group"}),t.jsxs("div",{className:I.instanceSelectionContainer,children:[e.values.queryType==="tags"&&t.jsx(b,{placeholder:"Select tags",variant:"condensed",label:"Tags",labelClassName:"u-off-screen",required:!0,...e.getFieldProps("tags"),items:p,selectedItems:p.filter(({value:s})=>e.values.tags.includes(s)),onItemsUpdate:async s=>e.setFieldValue("tags",s.map(({value:a})=>a)),error:e.touched.tags&&typeof e.errors.tags=="string"?e.errors.tags:void 0}),e.values.queryType==="ids"&&t.jsx(b,{placeholder:"Select instances",variant:"condensed",label:"Instances",labelClassName:"u-off-screen",required:!0,...e.getFieldProps("instanceIds"),items:o,selectedItems:o.filter(({value:s})=>e.values.instanceIds.includes(s)),onItemsUpdate:async s=>e.setFieldValue("instanceIds",s.map(({value:a})=>a)),error:e.touched.instanceIds&&typeof e.errors.instanceIds=="string"?e.errors.instanceIds:void 0})]})]})}),t.jsxs(r.Row,{className:"u-no-padding--left u-no-padding--right",children:[t.jsx(r.Col,{size:6,children:t.jsx(r.Input,{type:"text",label:"Run as user",autoComplete:"off",required:!0,...e.getFieldProps("username"),error:v(e,"username")})}),t.jsx(r.Col,{size:6,children:t.jsx(r.Input,{type:"text",label:"Time limit (seconds)",autoComplete:"off",required:!0,...e.getFieldProps("time_limit"),error:v(e,"time_limit")})})]}),t.jsx(z,{formik:e}),t.jsx(O,{submitButtonDisabled:e.isSubmitting,submitButtonText:"Run script",onSubmit:w})]}),_&&t.jsxs(r.ConfirmationModal,{title:`Run ${i.title} script on ${e.values.tags.length>1?`${e.values.tags.length} tags`:`${e.values.tags[0]} tag`}`,confirmButtonLabel:"Run script",onConfirm:()=>{e.handleSubmit()},confirmButtonDisabled:e.isSubmitting,close:C,confirmButtonAppearance:"positive",children:[t.jsxs("p",{children:["This script will run on the following instances, which are associated with the selected"," ",e.values.tags.length==1?"tag":"tags","."]}),t.jsx(r.ModularTable,{columns:$,data:g.filter(s=>s.tags.some(a=>e.values.tags.includes(a))),className:I.table})]})]})};export{ae as default};
