import{j as e,r as b,y as O,af as M,m as c,n as j,o as H,v as $,D as V,C as B,G as I,z as K,l as Y,A as z}from"./index-2fzpjuii.js";import{C as J}from"./CodeEditor-egO5wbn8.js";import{S as Q}from"./SidePanelFormButtons-DAl7F5tV.js";import{u as W}from"./useAddAutoinstallFile-CWExjdGm.js";import{u as P}from"./EmployeeGroupIdentityIssuerList-CJir__7d.js";import{g as L}from"./formikErrors-Bw8iTXYS.js";import{u as X}from"./useUpdateEmployeeGroups-e4h6J9cK.js";import{D as Z}from"./downshift.esm-jxkUgyVF.js";import"./index-0zPblRXu.js";import"./SidePanelFormButtons.module-D2P5PizG.js";import"./HeaderWithSearch-BIg5d4wD.js";import"./TruncatedCell-CgdNfcLB.js";const G=200,ee=(t,l)=>{const r=t.toLowerCase(),u=l.toLowerCase(),o=r.indexOf(u);return o>=0?e.jsxs(e.Fragment,{children:[t.substring(0,o),e.jsx("strong",{children:t.substring(o,o+l.length)}),t.substring(o+l.length)]}):t},te="_container_1a977_1",ne="_suggestionsContainer_1a977_5",se="_pointer_1a977_12",ie="_highlighted_1a977_17",ae="_selectedContainer_1a977_21",f={container:te,suggestionsContainer:ne,pointer:se,highlighted:ie,selectedContainer:ae},le=({selectedItem:t,setSelectedItem:l})=>{const[r,u]=b.useState(""),[o,d]=b.useState(!1),[h,C]=b.useState(""),S=O(),{autoinstallFiles:y,autoinstallFilesCount:N,isFetching:p}=P({limit:20,offset:0,with_groups:!1,search:r},{enabled:!!r}),_=y.filter(i=>(t==null?void 0:t.id)!==i.id),v=()=>{l(null)},n=()=>{d(!1)},g=()=>{C(""),u("")},m=()=>{h.length>2?d(!0):d(!1)},E=i=>{C(i),i.length>2&&u(i)},D=M(()=>{try{m()}catch(i){S(i)}},G),T=i=>{l(i),g()},q=i=>{i&&(T(i),d(!1))},w=i=>{i.key==="Escape"?i.currentTarget.blur():D()},a=!o&&h.length<3?"Min 3. characters":N===0&&r&&!p?`No autoinstall files found by "${r}"`:null;return e.jsxs("div",{className:f.container,children:[e.jsx(Z,{onSelect:q,itemToString:()=>"",isOpen:o,children:({getInputProps:i,getItemProps:A,getMenuProps:U,highlightedIndex:R})=>e.jsxs("div",{className:"p-autocomplete",children:[e.jsx(c.SearchBox,{...i(),placeholder:"Search for available autoinstall files",className:"u-no-margin--bottom",shouldRefocusAfterReset:!0,externallyControlled:!0,autocomplete:"off",value:h,onChange:E,onClear:g,onBlur:n,onFocus:m,onKeyUp:w}),a?e.jsx("span",{className:"p-form-help-text",children:a}):null,o&&(_.length>0||p)?e.jsx("ul",{className:j("p-list p-card--highlighted u-no-padding u-no-margin--bottom p-autocomplete__suggestions",f.suggestionsContainer),...U(),children:p?e.jsx(H,{}):_.map((F,k)=>e.jsxs("li",{className:j("p-list__item",f.pointer,{[f.highlighted]:R===k}),...A({item:F,index:k}),children:[e.jsx("div",{className:"u-truncate","data-testid":"dropdownElement",children:ee(F.filename,r)}),e.jsx("div",{children:e.jsxs("small",{className:"u-text-muted",children:["Last edited:"," ",$(F.last_modified_at).format(V)]})})]},F.filename))}):null]})}),e.jsx("ul",{className:"p-list p-autocomplete__result-list u-no-margin--bottom",children:t?e.jsxs("li",{className:j("p-autocomplete__result p-list__item p-card u-no-margin--bottom",f.selectedContainer),children:[e.jsxs("div",{children:[e.jsx("div",{children:t.filename}),e.jsxs("small",{className:"u-text-muted p-text--small",children:["Last edited:"," ",$(t.last_modified_at).format(V)]})]}),e.jsx(c.Button,{type:"button",appearance:"link",className:"u-no-margin--bottom",onClick:v,children:e.jsx(c.Icon,{name:c.ICONS.delete})})]},t.filename):null})]})},oe="_form_1nqr5_1",re="_code_1nqr5_7",ce="_inputContainer_1nqr5_11",ue="_input_1nqr5_11",de="_inputDescription_1nqr5_20",x={form:oe,code:re,inputContainer:ce,input:ue,inputDescription:de},he=[{label:"Select",value:""},{label:"Add new Autoinstall file",value:"new"},{label:"Assign existing Autoinstall file",value:"assign-existing"},{label:"Inherit default Autoinstall file",value:"inherit"}],pe={dropdownChoice:"",filename:"",contents:"",selectedAutoinstallFile:null},me=B().shape({dropdownChoice:I().required("This field is required"),filename:I().when("dropdownChoice",{is:"new",then:t=>t.required("This field is required")}),contents:I().when("dropdownChoice",{is:"new",then:t=>t.required("This field is required")}),selectedAutoinstallFile:B().when("dropdownChoice",{is:"assign-existing",then:t=>t.required("This field is required"),otherwise:t=>t.nullable()})}),Ne=({employeeGroups:t,clearSelectedGroups:l})=>{var w;const r=b.useRef(null),u=O(),{notify:o}=K(),{closeSidePanel:d}=Y(),{updateEmployeeGroups:h,isUpdatingEmployeeGroups:C}=X(),{addAutoinstallFile:S,isAutoinstallFileAdding:y}=W(),N=t.reduce((s,{employee_count:a=0})=>s+(a??0),0),p=s=>{o.success({title:`Successfully reassigned ${s} to ${t.length===1?`${t[0].name} group`:`${t.length} groups`}.`,message:`Autoinstall file assigned to ${N} employees${t.length===1?` in ${t[0].name} group`:` across ${t.length} groups`}.`})},_=async(s,a)=>{try{const{data:i}=await S({contents:s,filename:a});await h(t.map(A=>({autoinstall_file:i,id:A.id,priority:A.priority}))),d(),p(a),l&&l()}catch(i){u(i)}},v=async s=>{try{await h(t.map(a=>({autoinstall_file:s,id:a.id,priority:a.priority}))),d(),p(s.filename),l&&l()}catch(a){u(a)}},n=z({initialValues:pe,validationSchema:me,onSubmit:async s=>{s.dropdownChoice==="new"?await _(s.contents,s.filename):s.selectedAutoinstallFile&&await v(s.selectedAutoinstallFile)}}),{autoinstallFiles:g}=P({is_default:!0},{enabled:n.values.dropdownChoice==="inherit"}),m=g.length>0?g[0]:null,E=async({target:{files:s}})=>{if(!s)return;const[a]=s;await n.setFieldValue("contents",await a.text()),!n.values.filename&&await n.setFieldValue("filename",a.name)},D=async s=>{await n.setFieldValue("contents",s)},T=()=>{var s;(s=r.current)==null||s.click()},q=n.values.dropdownChoice==="assign-existing"&&n.values.selectedAutoinstallFile||n.values.dropdownChoice==="inherit";return e.jsxs(c.Form,{className:x.form,noValidate:!0,onSubmit:n.handleSubmit,children:[e.jsx("p",{children:"This file will only be used during the initial setup of the instance. Changing this autoinstall file will not affect instances that are already registered in landscape."}),e.jsx(c.Select,{label:"Autoinstall file",options:he,error:L(n,"dropdownChoice"),required:!0,...n.getFieldProps("dropdownChoice"),onChange:async s=>{n.resetForm(),n.getFieldProps("autoinstallFile").onChange(s)}}),n.values.dropdownChoice==="assign-existing"&&e.jsx(le,{selectedItem:n.values.selectedAutoinstallFile,setSelectedItem:async s=>await n.setFieldValue("selectedAutoinstallFile",s)}),q&&e.jsx(c.CodeSnippet,{className:j({[x.code]:n.values.dropdownChoice==="assign-existing"&&n.values.selectedAutoinstallFile}),blocks:[{title:"Code preview",code:n.values.dropdownChoice==="assign-existing"?(w=n.values.selectedAutoinstallFile)==null?void 0:w.contents:m==null?void 0:m.contents,wrapLines:!0,appearance:"numbered"}]}),n.values.dropdownChoice==="new"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:x.inputContainer,children:[e.jsx(c.Input,{wrapperClassName:x.input,type:"text",label:"File name",...n.getFieldProps("filename"),error:L(n,"filename"),required:!0}),e.jsx("span",{className:x.inputDescription,children:".yaml"})]}),e.jsx("input",{ref:r,className:"u-hide",type:"file",accept:".yaml",onChange:E}),e.jsx(J,{label:"Code",value:n.values.contents,onChange:D,error:L(n,"contents"),required:!0,language:"yaml",headerContent:e.jsxs(c.Button,{className:"u-no-margin--bottom",appearance:"base",hasIcon:!0,onClick:T,type:"button",children:[e.jsx(c.Icon,{name:"upload"}),e.jsx("span",{children:"Populate from file"})]})})]}),e.jsx(Q,{submitButtonDisabled:C||y||n.values.dropdownChoice==="assign-existing"&&!n.values.selectedAutoinstallFile,submitButtonText:"Assign"})]})};export{Ne as default};
