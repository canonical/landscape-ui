import{j as e,e as n,K as b,a6 as O,y as H,B as x,N as F,ao as N,z as L,C as V,aQ as Q,aR as z,q as B,s as $,m as T,t as k,n as X,ac as h,h as Y,l as K,w as J,Q as W,J as q,a0 as Z,P as j,I as p,a1 as ee}from"./index-CIJ7mRT9.js";import{A as te}from"./AssociationBlock-BQvYUslB.js";import{S as re}from"./SidePanelFormButtons-Cffo84ct.js";import{u as M}from"./useRoles-BCAvmoVt.js";import{u as G}from"./index-JulkDs8p.js";import{U as Le,a as Ve,b as Qe}from"./index-JulkDs8p.js";import{M as ae}from"./MultiSelectField-ChJHZVah.js";import{R as se}from"./RandomizationBlock-Ce5t7BU7.js";import{T as ie}from"./TextConfirmationModal-BN58LtOB.js";import"./useGetTags-cUsnp65U.js";import"./SidePanelFormButtons.module-CcPyiogC.js";import"./PageMain-CXrwNRQQ.js";import"./constants-CECEDqqQ.js";import"./constants-yUAEV5lC.js";import"./HeaderWithSearch-DbK_8pcN.js";import"./RadioGroup-VynBS2Oo.js";const U=[{label:"Sunday",order:0,value:"su"},{label:"Monday",order:1,value:"mo"},{label:"Tuesday",order:2,value:"tu"},{label:"Wednesday",order:3,value:"we"},{label:"Thursday",order:4,value:"th"},{label:"Friday",order:5,value:"fr"},{label:"Saturday",order:6,value:"sa"}],oe=`If Landscape cannot upgrade the
associated instances by this point,
the upgrade will be canceled.`,ne="_container_x7xq2_1",le="_radioGroup_x7xq2_7",de="_timeContainer_x7xq2_13",ce="_time_x7xq2_13",ue="_timeInput_x7xq2_27",pe="_inputDescriptionAfter_x7xq2_32",me="_inputDescriptionBefore_x7xq2_37",ge="_colon_x7xq2_42",he="_tooltip_x7xq2_48",_e="_expiration_x7xq2_52",c={container:ne,radioGroup:le,timeContainer:de,time:ce,timeInput:ue,inputDescriptionAfter:pe,inputDescriptionBefore:me,colon:ge,tooltip:he,expiration:_e},fe=({formik:t})=>{const r=[t.touched.at_hour&&t.errors.at_hour||void 0,t.touched.at_minute&&t.errors.at_minute||void 0,t.touched.deliver_within&&t.errors.deliver_within||void 0];return e.jsxs("div",{className:c.container,children:[e.jsx("p",{className:"p-heading--5",children:"Schedule"}),e.jsx(ae,{variant:"condensed",label:"Days",items:U,selectedItems:U.filter(({value:l})=>t.values.on_days.includes(l)),onItemsUpdate:l=>t.setFieldValue("on_days",l.map(({value:d})=>d)),isSortedAlphabetically:!1,hasSelectedItemsFirst:!1,error:t.touched.on_days&&typeof t.errors.on_days=="string"?t.errors.on_days:void 0}),e.jsxs("div",{className:c.radioGroup,children:[e.jsx(n.RadioInput,{label:"At a specific time",...t.getFieldProps("every"),checked:t.values.every==="week",onChange:()=>t.setFieldValue("every","week")}),e.jsx(n.RadioInput,{label:"Hourly",...t.getFieldProps("every"),checked:t.values.every==="hour",onChange:()=>t.setFieldValue("every","hour")})]}),e.jsxs("div",{className:c.timeContainer,children:[e.jsxs("div",{className:c.time,children:[t.values.every==="week"&&e.jsxs(e.Fragment,{children:[e.jsx(n.Input,{type:"number",label:"Time","aria-label":"at hour",placeholder:"HH",className:c.timeInput,wrapperClassName:b({"is-error":r[0]}),...t.getFieldProps("at_hour"),"aria-errormessage":r[0]?"hour-error":void 0}),e.jsx("span",{className:c.colon,children:":"})]}),t.values.every==="hour"&&e.jsx("span",{className:c.inputDescriptionBefore,children:"at"}),e.jsx(n.Input,{type:"number",label:"At minute",labelClassName:"u-off-screen","aria-label":"at minute",className:c.timeInput,wrapperClassName:b({"is-error":r[1]}),placeholder:"MM",...t.getFieldProps("at_minute"),"aria-errormessage":r[1]?"minute-error":void 0}),t.values.every==="hour"&&e.jsx("span",{className:c.inputDescriptionAfter,children:"minute"}),e.jsx(n.Input,{type:"number",label:e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"Expires after "}),e.jsx(n.Tooltip,{message:oe,position:"top-right",tooltipClassName:c.tooltip,children:e.jsx(n.Icon,{name:"help"})})]}),wrapperClassName:b(c.expiration,{"is-error":r[2]}),className:c.timeInput,...t.getFieldProps("deliver_within"),"aria-errormessage":"expires-error"}),e.jsx("span",{className:c.inputDescriptionAfter,children:"hours"})]}),r.filter(Boolean).length>0&&e.jsxs("div",{className:b({"is-error":r.filter(Boolean).length>0}),children:[r[0]&&e.jsx("p",{className:"p-form-validation__message",id:"hour-error",children:e.jsx("span",{children:r[0]})}),r[1]&&e.jsx("p",{className:"p-form-validation__message",id:"minute-error",children:e.jsx("span",{children:r[1]})}),r[2]&&e.jsxs("p",{className:"p-form-validation__message",id:"expires-error",children:[e.jsx("strong",{children:"Error: "}),e.jsx("span",{children:r[2]})]})]})]}),e.jsx(se,{formik:t})]})},xe={add:"Add upgrade profile",edit:"Save changes"},ye={access_group:O,all_computers:!1,at_hour:"",at_minute:"",autoremove:!1,deliver_delay_window:0,deliver_within:1,every:"week",on_days:[],randomize_delivery:!1,tags:[],title:"",upgrade_type:"all"},E={add:"added",edit:"updated"},ve=t=>H().shape({...V,access_group:x(),all_computers:L(),at_hour:N().when("every",{is:"week",then:r=>r.required("Hour is required.").integer("Hour must be an integer.").min(0,"Hour must be between 0 and 23.").max(z,"Hour must be between 0 and 23.")}),at_minute:N().required("Minute is required.").integer("Minute must be an integer.").min(0,"Minute must be between 0 and 59.").max(Q,"Minute must be between 0 and 59."),deliver_within:N().integer("'Expires after' must be an integer.").min(0,"'Expires after' must be at least 0."),every:x().required("This field is required."),on_days:F().of(x()).when("every",{is:"week",then:r=>r.min(1,"At least one day must be selected.")}),tags:F().of(x()),title:x().test({name:"required",message:"This field is required.",params:{action:t},test:r=>!!r||t!=="add"}),upgrade_type:x().required("This field is required.")}),R=t=>{const r=B(),{notify:l}=$(),{sidePath:d,popSidePath:_,setPageParams:u}=T(),{createUpgradeProfileQuery:a,editUpgradeProfileQuery:g}=G(),{getAccessGroupQuery:m}=M(),{data:f}=m({},{enabled:t.action==="add"}),P=f?.data.map(({name:i,title:o})=>({label:o,value:i}))??[],{mutateAsync:y}=a,{mutateAsync:w}=g,v=()=>{u({sidePath:[],profile:""})},s=k({initialValues:ye,onSubmit:async i=>{const o={access_group:i.access_group,all_computers:i.all_computers,at_minute:i.at_minute,autoremove:i.autoremove,deliver_within:i.deliver_within,every:i.every,on_days:i.on_days,title:i.title,upgrade_type:i.upgrade_type};i.every==="week"&&(o.at_hour=i.at_hour),i.randomize_delivery&&(o.deliver_delay_window=`${i.deliver_delay_window}`),!i.all_computers&&i.tags.length&&(o.tags=i.tags);try{t.action==="edit"?await w({all_computers:o.all_computers,at_hour:o.at_hour,at_minute:o.at_minute,autoremove:o.autoremove,deliver_delay_window:o.deliver_delay_window,deliver_within:o.deliver_within,every:o.every,name:t.profile.name,on_days:o.on_days,tags:o.tags,title:o.title,upgrade_type:o.upgrade_type}):await y(o),v(),l.success({message:`Upgrade profile "${i.title}" has been ${E[t.action]} `,title:`Upgrade profile ${E[t.action]}`})}catch(S){r(S)}},validationSchema:ve(t.action)});return X.useEffect(()=>{t.action!=="edit"||!t.profile||s.setValues({access_group:t.profile.access_group,all_computers:t.profile.all_computers,at_hour:t.profile.at_hour?parseInt(t.profile.at_hour):"",at_minute:parseInt(t.profile.at_minute),autoremove:t.profile.autoremove,deliver_delay_window:parseInt(t.profile.deliver_delay_window),deliver_within:parseInt(t.profile.deliver_within),every:t.profile.every,on_days:t.profile.on_days??[],randomize_delivery:t.profile.deliver_delay_window!=="0",tags:t.profile.tags,title:t.profile.title,upgrade_type:t.profile.upgrade_type})},[t]),e.jsxs(n.Form,{onSubmit:s.handleSubmit,noValidate:!0,children:[e.jsx(n.Input,{type:"text",required:t.action==="add",label:"Title",...s.getFieldProps("title"),error:s.touched.title&&s.errors.title?s.errors.title:void 0}),e.jsx(n.Input,{type:"checkbox",label:"Only upgrade security issues",help:"Regular upgrades will not be applied",...s.getFieldProps("upgrade_type"),checked:s.values.upgrade_type==="security",onChange:async()=>s.setFieldValue("upgrade_type",s.values.upgrade_type==="all"?"security":"all")}),e.jsx(n.Input,{type:"checkbox",label:"Remove packages that are no longer needed",help:"This will affect packages installed to satisfy dependencies that are no longer required after upgrading.",...s.getFieldProps("autoremove"),checked:s.values.autoremove}),e.jsx(n.Select,{label:"Access group","aria-label":"Access group",options:P,...s.getFieldProps("access_group"),error:s.touched.access_group&&s.errors.access_group?s.errors.access_group:void 0}),e.jsx(fe,{formik:s}),e.jsx(te,{formik:s}),e.jsx(re,{submitButtonDisabled:s.isSubmitting,submitButtonText:xe[t.action],onCancel:v,hasBackButton:d.length>1,onBackButtonPress:_})]})},Ge=()=>e.jsxs(e.Fragment,{children:[e.jsx(h.Header,{children:"Add upgrade profile"}),e.jsx(h.Content,{children:e.jsx(R,{action:"add"})})]}),be=t=>{const r=Y(),{data:l,isPending:d,error:_}=K({queryKey:["upgradeProfile",t],queryFn:async({signal:a})=>r.get("GetUpgradeProfiles",{signal:a})}),u=l?.data.find(({id:a})=>a===t);return{upgradeProfile:u,upgradeProfileError:l&&!u?new Error("The upgrade profile could not be found."):_,isGettingUpgradeProfile:d}},D=()=>{const{profile:t}=T(),{isGettingUpgradeProfile:r,upgradeProfile:l,upgradeProfileError:d}=be(parseInt(t));if(d)throw d;return r?{upgradeProfile:void 0,isGettingUpgradeProfile:!0}:{upgradeProfile:l,isGettingUpgradeProfile:!1}},C=t=>U.filter(({value:r})=>t.includes(r)).sort((r,l)=>r.order-l.order).map(({label:r})=>r).join(", ").replace(/,(?= \w+$)/," and"),je=t=>{const{at_hour:r,deliver_within:l,every:d,next_run:_,on_days:u}=t,a=J(_).utc().format(`ddd, ${W} [UTC (expires after ${l}h)]`);let g="Every ";const m=parseInt(t.at_minute);if(d==="hour"&&(g+=`hour at ${m} ${q(m,"minute")}`,u&&(g+=` on ${C(u)}`)),d==="week"){if(!u||!r)return{scheduleMessage:"Every week",nextRunMessage:a};const f=parseInt(r);g+=`${C(u)} at ${f>9?f:`0${f}`}:${m>9?m:`0${m}`} UTC`}return{scheduleMessage:g,nextRunMessage:a}},Re=()=>{const t=B(),{notify:r}=$(),{pushSidePath:l,setPageParams:d}=T(),{getAccessGroupQuery:_}=M(),{removeUpgradeProfileQuery:u}=G(),{upgradeProfile:a,isGettingUpgradeProfile:g}=D(),{data:m,isPending:f}=_(),{mutateAsync:P,isPending:y}=u,{value:w,setTrue:v,setFalse:I}=Z();if(g||f)return e.jsx(h.LoadingState,{});const{scheduleMessage:s,nextRunMessage:i}=je(a),o=async()=>{try{await P({name:a.name}),d({sidePath:[],profile:""}),r.success({title:"Upgrade profile removed",message:`Upgrade profile ${a.title} has been removed`})}catch(A){t(A)}finally{I()}},S=()=>{l("edit")};return e.jsxs(e.Fragment,{children:[e.jsx(h.Header,{children:a.title}),e.jsxs(h.Content,{children:[e.jsxs("div",{className:"p-segmented-control",children:[e.jsxs(n.Button,{type:"button",hasIcon:!0,className:"p-segmented-control__button",onClick:S,"aria-label":`Edit upgrade profile ${a.title}`,children:[e.jsx(n.Icon,{name:"edit"}),e.jsx("span",{children:"Edit"})]}),e.jsxs(n.Button,{className:"has-icon p-segmented-control__button","aria-label":`Remove upgrade profile ${a.title}`,type:"button",onClick:v,children:[e.jsx(n.Icon,{name:n.ICONS.delete}),e.jsx("span",{children:"Remove"})]})]}),e.jsxs(j,{children:[e.jsx(j.Item,{children:e.jsxs(p,{children:[e.jsx(p.Item,{label:"Title",value:a.title}),e.jsx(p.Item,{label:"Name",value:a.name}),e.jsx(p.Item,{label:"Access group",value:m?.data.find(A=>A.name===a.access_group)?.title??a.access_group}),e.jsx(p.Item,{label:"Upgrade type",value:a.upgrade_type==="all"?"All":"Security"}),e.jsx(p.Item,{label:"Auto remove packages",value:a.autoremove?"On":"Off"})]})}),e.jsx(j.Item,{title:"Schedule",children:e.jsxs(p,{children:[e.jsx(p.Item,{label:"Schedule",large:!0,value:s}),e.jsx(p.Item,{label:"Next run",large:!0,value:i}),e.jsx(p.Item,{label:"Delivery delay window",large:!0,value:`${a.deliver_delay_window} ${q(Number(a.deliver_delay_window),"minute")}`})]})}),e.jsx(j.Item,{title:"Association",children:e.jsxs(e.Fragment,{children:[a.all_computers&&e.jsx("p",{children:"This profile has been associated with all instances."}),!a.all_computers&&!a.tags.length&&e.jsx("p",{children:"This profile has not yet been associated with any instances."}),!a.all_computers&&a.tags.length>0&&e.jsx(ee,{label:"Tags",value:a.tags.join(", ")||null})]})})]})]}),e.jsx(ie,{isOpen:w,title:"Remove upgrade profile",confirmButtonLabel:"Remove",confirmButtonAppearance:"negative",confirmButtonDisabled:y,confirmButtonLoading:y,onConfirm:o,close:I,confirmationText:`remove ${a.title}`,children:e.jsxs("p",{children:['This will remove "',a.title,'" upgrade profile. This action is ',e.jsx("b",{children:"irreversible"}),"."]})})]})},De=()=>{const{upgradeProfile:t,isGettingUpgradeProfile:r}=D();return r?e.jsx(h.LoadingState,{}):e.jsxs(e.Fragment,{children:[e.jsxs(h.Header,{children:['Edit "',t.title,'" profile']}),e.jsxs(h.Content,{children:[e.jsx(R,{action:"edit",profile:t}),";"]})]})};export{R as SingleUpgradeProfileForm,Ge as UpgradeProfileAddSidePanel,Re as UpgradeProfileDetailsSidePanel,De as UpgradeProfileEditSidePanel,Le as UpgradeProfileList,Ve as UpgradeProfilesEmptyState,Qe as UpgradeProfilesHeader,G as useUpgradeProfiles};
