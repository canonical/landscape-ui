import{r as n,q as l,k as z,i as K,l as Q,I as h,m as W,n as i,p as T,A as x,o as P,j as s,h as o,S as g,D as E,B as C}from"./index-B7TA2mEJ.js";import{h as a}from"./moment-C5S46NFB.js";import{P as j,b as V,c as q,C as f,d as Y,a as J,A as X,U as Z}from"./series-CBgL5ULK.js";import{S as ee}from"./SidePanelFormButtons-XYVE_s1x.js";import{u as re}from"./useDistributions-Bf8bcUIv.js";import{u as te}from"./useGPGKeys-Cvivy6p8.js";import{u as se}from"./index-BvdiRXaH.js";import{t as A}from"./tests-DFnZqbNV.js";import"./SidePanelFormButtons.module-yv6Qz3cN.js";import"./useFetchOld-CJ7nhgRY.js";import"./PageMain-FFmGKqeV.js";import"./InfoItem-BGbjg2ci.js";import"./NoData-CEdbf9On.js";import"./index-_nOAvVrS.js";import"./moment-XwcdBKy1.js";import"./TablePagination-DWlHKziY.js";import"./TablePagination.module-CgQ3jx4B.js";import"./usePageParams-BUsG_p4E.js";import"./SearchHelpPopup-DQ0iOBxi.js";import"./DistributionCard.module-BJwqEI-8.js";const oe=u=>u.replace(/\/[^\\/@]*@/,"/"),Te=({distribution:u,ctaText:D="Add mirror"})=>{const[v,p]=n.useState(l),[I,F]=n.useState([]),O=z(),{closeSidePanel:R}=K(),{getGPGKeysQuery:N}=te(),{createSeriesQuery:U,getRepoInfo:w}=se(),{getDistributionsQuery:G}=re(),{data:b}=G({include_latest_sync:!0},{enabled:!u}),_=(b==null?void 0:b.data)??[],{data:y}=N(),{mutateAsync:M}=U,S=(y==null?void 0:y.data)??[],$=_.map(({name:r})=>({label:r,value:r})),e=Q({initialValues:{type:"ubuntu",name:"",distribution:"",mirror_series:"",mirror_uri:"",gpg_key:"",pockets:[],components:[],architectures:[],include_udeb:!1,hasPockets:!1,snapshotDate:a().format(h)},validationSchema:W().shape({distribution:i().required("This field is required."),type:i().required("This field is required."),name:i().required("This field is required.").test({test:A.test,message:A.message}).test({test:(r,t)=>!!t.parent.distribution,message:"First select the distribution."}).test({params:{distribution:u,distributions:_},test:(r,t)=>t.parent.distribution?!(u?u.series.map(({name:m})=>m):_.filter(({name:m})=>m===t.parent.distribution)[0].series.map(({name:m})=>m)).includes(r):!0,message:"It must be unique within series within the distribution."}),hasPockets:T(),mirror_series:i(),mirror_gpg_key:i(),mirror_uri:i().when("hasPockets",(r,t)=>r[0]?t.nonNullable().required("This field is required."):t),snapshotDate:i().when("type",(r,t)=>r[0]==="ubuntu-snapshot"?t.required("This field is required.").test({test:d=>a(d).isBetween(a(g),a()),message:`The date must be after ${a(g).format(x)} and not in the future.`}):t),gpg_key:i().when("hasPockets",(r,t)=>r[0]?t.required("This field is required."):t),pockets:P().of(i()),components:P().of(i()).when("hasPockets",(r,t)=>r[0]?t.min(1,"Please choose at least one component."):t),architectures:P().of(i()).when("hasPockets",(r,t)=>r[0]?t.min(1,"Please choose at least one architecture."):t),include_udeb:T().required()}),onSubmit:async r=>{try{await M({name:r.name,distribution:r.distribution,mirror_series:r.mirror_series,gpg_key:r.gpg_key,include_udeb:r.include_udeb,mirror_uri:r.mirror_uri,components:r.components,pockets:r.pockets,architectures:r.architectures,mirror_gpg_key:r.mirror_gpg_key}),R()}catch(t){O(t)}}}),L=r=>{e.setFieldValue("snapshotDate",r.target.value),e.setFieldValue("mirror_uri",`${E}/${a(r.target.value).format(C)}`)};n.useEffect(()=>{u&&e.setFieldValue("distribution",u.name)},[u]),n.useEffect(()=>{var r;e.values.type==="third-party"?(e.setFieldValue("pockets",j.thirdParty),e.setFieldValue("components",V.thirdParty),e.setFieldValue("architectures",q.thirdParty)):(e.setFieldValue("pockets",j.ubuntu),e.setFieldValue("components",V.ubuntu),e.setFieldValue("architectures",q.ubuntu),e.values.type==="ubuntu"&&!((r=e.values.mirror_uri)!=null&&r.startsWith(l))&&(e.setFieldValue("mirror_uri",l),p(l)))},[e.values.type]);const B=r=>{e.setFieldValue("type",r.target.value),r.target.value==="ubuntu"?(e.setFieldValue("mirror_uri",l),p(l)):r.target.value==="third-party"?(e.setFieldValue("mirror_uri",""),p("")):r.target.value==="ubuntu-snapshot"&&(e.setFieldValue("mirror_uri",`${E}/${a(e.values.snapshotDate).format(C)}`),p(l))},H=r=>{const t=r.target.value;e.setFieldValue("mirror_series",t),!(!t||e.values.name)&&e.setFieldValue("name",e.values.type==="ubuntu-snapshot"?`${t}-snapshot-${a(e.values.snapshotDate).format(h)}`:t)};n.useEffect(()=>{if(e.values.pockets.length===0||!e.values.pockets[0]){e.setFieldValue("hasPockets",!1);return}e.setFieldValue("hasPockets",!0)},[e.values.pockets.length,e.values.pockets[0]]);const{data:k}=w({mirror_uri:oe(v)},{enabled:!!v}),c=k==null?void 0:k.data;return n.useEffect(()=>{var r;if(!c){F([]);return}c.ubuntu?(r=e.values.mirror_uri)!=null&&r.startsWith(l)&&e.setFieldValue("type","ubuntu"):e.setFieldValue("type","third-party"),F(c.repos.map(({description:t,repo:d})=>({label:c.ubuntu?t:d,value:d})))},[c]),s.jsxs(o.Form,{onSubmit:e.handleSubmit,noValidate:!0,children:[s.jsx(o.Select,{label:"Type",required:!0,options:[{label:"Ubuntu Archive",value:"ubuntu"},{label:"Ubuntu Snapshot",value:"ubuntu-snapshot"},{label:"Third party",value:"third-party"}],...e.getFieldProps("type"),onChange:B,error:e.touched.type&&e.errors.type?e.errors.type:void 0}),e.values.type!=="ubuntu-snapshot"&&s.jsx(o.Input,{type:"text",label:"Mirror URI",required:e.values.hasPockets,help:"Absolute URL or file path",...e.getFieldProps("mirror_uri"),onBlur:r=>{p(r.target.value)},error:e.touched.mirror_uri&&e.errors.mirror_uri?e.errors.mirror_uri:void 0}),e.values.type==="ubuntu-snapshot"&&s.jsx(o.Input,{type:"date",min:a(g).format(h),max:a().format(h),label:"Snapshot date",required:!0,...e.getFieldProps("snapshotDate"),onChange:L,error:e.touched.snapshotDate&&e.errors.snapshotDate?e.errors.snapshotDate:void 0,help:`Starting from approximately ${a(g).format(x)} in dd.mm.yyyy format`}),!u&&s.jsx(o.Select,{label:"Distribution",required:!0,options:[{label:"Select distribution",value:""},...$],...e.getFieldProps("distribution"),error:e.touched.distribution&&e.errors.distribution?e.errors.distribution:void 0}),s.jsxs(o.Row,{className:"u-no-padding",children:[s.jsx(o.Col,{size:6,medium:3,small:2,children:s.jsx(o.Select,{label:"Mirror series",options:[{label:"Select series",value:""},...I],...e.getFieldProps("mirror_series"),onChange:H,error:e.touched.mirror_series&&e.errors.mirror_series?e.errors.mirror_series:void 0})}),s.jsx(o.Col,{size:6,medium:3,small:2,children:s.jsx(o.Input,{type:"text",label:"Series name",required:!0,...e.getFieldProps("name"),error:e.touched.name&&e.errors.name?e.errors.name:void 0})})]}),s.jsxs(o.Row,{className:"u-no-padding",children:[e.values.type!=="ubuntu-snapshot"&&s.jsx(o.Col,{size:6,medium:3,small:2,children:s.jsx(o.Select,{label:"Mirror GPG key",options:[{label:"Select mirror GPG key",value:""},...S.filter(({has_secret:r})=>!r).map(({name:r})=>({label:r,value:r}))],...e.getFieldProps("mirror_gpg_key"),error:e.touched.mirror_gpg_key&&e.errors.mirror_gpg_key?e.errors.mirror_gpg_key:void 0,help:"If none is given, the stock Ubuntu archive one will be used."})}),s.jsx(o.Col,{size:6,medium:3,small:2,children:s.jsx(o.Select,{label:"GPG key",required:e.values.hasPockets,options:[{label:"Select GPG key",value:""},...S.filter(({has_secret:r})=>r).map(({name:r})=>({label:r,value:r}))],...e.getFieldProps("gpg_key"),error:e.touched.gpg_key&&e.errors.gpg_key?e.errors.gpg_key:void 0})})]}),["ubuntu","ubuntu-snapshot"].includes(e.values.type)&&s.jsxs(s.Fragment,{children:[s.jsx(f,{label:"Pockets",style:{marginTop:"1.5rem"},options:Y,...e.getFieldProps("pockets"),onChange:r=>{e.setFieldValue("pockets",r)},error:e.touched.pockets&&e.errors.pockets?e.errors.pockets:void 0}),s.jsx(f,{label:"Components",required:e.values.hasPockets,options:J,...e.getFieldProps("components"),onChange:r=>{e.setFieldValue("components",r)},error:e.touched.components&&e.errors.components?e.errors.components:void 0}),s.jsx(f,{label:"Architectures",required:e.values.hasPockets,options:X,...e.getFieldProps("architectures"),onChange:r=>{e.setFieldValue("architectures",r)},error:e.touched.architectures&&e.errors.architectures?e.errors.architectures:void 0})]}),e.values.type==="third-party"&&s.jsxs(s.Fragment,{children:[s.jsx(o.Input,{type:"text",label:"Pockets",placeholder:"E.g. releases, security, etc.",...e.getFieldProps("pockets"),value:e.values.pockets.join(","),onChange:r=>{e.setFieldValue("pockets",r.target.value.replace(/\s/g,"").split(","))},error:e.touched.pockets&&e.errors.pockets?e.errors.pockets:void 0,help:"List the pocket names separated by commas"}),s.jsx(o.Input,{type:"text",label:"Components",required:e.values.hasPockets,placeholder:"E.g. main, universe, etc.",...e.getFieldProps("components"),value:e.values.components.join(","),onChange:r=>{e.setFieldValue("components",r.target.value.replace(/\s/g,"").split(","))},error:e.touched.components&&e.errors.components?e.errors.components:void 0,help:"List the component names separated by commas"}),s.jsx(o.Input,{type:"text",label:"Architectures",required:e.values.hasPockets,placeholder:"E.g. amd64, riscv, etc.",...e.getFieldProps("architectures"),value:e.values.architectures.join(","),onChange:r=>{e.setFieldValue("architectures",r.target.value.replace(/\s/g,"").split(","))},error:e.touched.architectures&&e.errors.architectures?e.errors.architectures:void 0,help:"List the architectures separated by commas"})]}),s.jsx(Z,{formik:e}),s.jsx(ee,{submitButtonDisabled:e.isSubmitting,submitButtonText:D})]})};export{Te as default};
