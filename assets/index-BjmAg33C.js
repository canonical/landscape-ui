import{q as I,s as F,r as C,t as L,k as T,w as $,n as D,j as e,h as r,z as H,x as P,g as R,o as V}from"./index--oDUzHMd.js";import{u as A}from"./useAlerts-DA7T-F8J.js";import{P as q,a as Q,b as B}from"./PageMain-D9F6nigr.js";import{d as U,s as _}from"./constants-SOPPwN95.js";import"./moment-C5S46NFB.js";import{I as j}from"./InfoItem-CXks3gok.js";import{M as Y}from"./MultiSelectField-wqFYEO-b.js";import"./EditUserForm-BXhdxhn5.js";import{u as G}from"./useInstances-oyExlbj4.js";import"./useFetchOld-DPqkXure.js";import"./NoData-DCDodkUD.js";import"./index-Df_Lgyt4.js";import"./moment-0FGm-X6W.js";import"./TablePagination-Dianhg-y.js";import"./TablePagination.module-CgQ3jx4B.js";import"./usePageParams-ChjLPDBj.js";import"./SearchHelpPopup-BETNoX7w.js";import"./SidePanelFormButtons.module-yv6Qz3cN.js";const N=t=>t?"Yes":"No",J="_footer_19o6z_1",K="_multiSelect_19o6z_7",k={footer:J,multiSelect:K},E=(t,a)=>{const n=new Set(a);return t.filter(o=>!n.has(o))},M=({alert:t,availableTagOptions:a})=>{const n=I(),{notify:o}=F(),{associateAlert:m,disassociateAlert:h}=A(),d=C.useRef(null),{mutateAsync:p}=m,{mutateAsync:i}=h,g=t.all_computers?["All"]:t.tags,w=async({tags:l})=>{try{const c=E(t.tags,l),u=E(l,t.tags),S=l.includes("All"),z=t.all_computers&&!S;if(S)await p({name:t.alert_type,tags:void 0,all_computers:!0});else if(z)await Promise.all([p({name:t.alert_type,tags:l.filter(x=>x!=="All"),all_computers:!1}),i({name:t.alert_type,all_computers:!0})]);else{const x=[];u.length>0&&x.push(p({name:t.alert_type,tags:u,all_computers:!1})),c.length>0&&x.push(i({name:t.alert_type,tags:c,all_computers:!1})),await Promise.all(x)}o.success({title:"Alert tags updated",message:`You changed ${t.label}'s tags`})}catch(c){n(c)}},s=L({initialValues:{tags:g},validationSchema:T().shape({tags:$().of(D())}),onSubmit:w}),f=s.values.tags.includes("All")?a.filter(({value:l})=>l!=="All"):void 0,y=s.values.tags.includes("All")?a:a.filter(({value:l})=>s.values.tags.includes(l)),W=l=>{const c=l.some(({value:u})=>u==="All")?["All"]:l.map(({value:u})=>u);s.setValues({tags:c})};C.useEffect(()=>{var c,u;const l=(c=d.current)==null?void 0:c.querySelector(".multi-select__condensed-text");(u=l==null?void 0:l.textContent)!=null&&u.includes("All instances")&&(l.textContent="All instances")},[s.values.tags]);const v=()=>s.isSubmitting?!0:g.length===s.values.tags.length&&g.every(l=>s.values.tags.includes(l));return e.jsx(r.Form,{onSubmit:s.handleSubmit,noValidate:!0,children:e.jsx(Y,{innerRef:d,required:!0,variant:"condensed",className:k.multiSelect,items:a,selectedItems:y,disabledItems:f,onItemsUpdate:W,placeholder:"Select tags",error:s.touched.tags&&typeof s.errors.tags=="string"?s.errors.tags:void 0,dropdownFooter:e.jsxs("div",{className:k.footer,children:[e.jsx(r.Button,{type:"button",dense:!0,small:!0,className:"u-no-margin--bottom",disabled:v(),onClick:()=>s.setFieldValue("tags",g),children:"Revert"}),e.jsx(r.Button,{type:"submit",dense:!0,small:!0,appearance:"positive",className:"u-no-margin--bottom",disabled:v(),children:"Save changes"})]})})})},X="_noWrap_1ewuk_20",Z="_alertsWrapper_1ewuk_24",O="_emailColumn_1ewuk_32",ee="_nameColumn_1ewuk_36",se="_tags_1ewuk_40",b={"u-off-screen":"_u-off-screen_1ewuk_1",switch:"_switch_1ewuk_1",noWrap:X,alertsWrapper:Z,emailColumn:O,nameColumn:ee,tags:se},te=t=>{const a={};switch(t.column.id){case"label":a.role="rowheader";break;case"subscribed":a["aria-label"]="Email";break;case"tags":a["aria-label"]="Tags";break;case"description":a["aria-label"]="Description";break}return a},ae=({alerts:t,availableTagOptions:a})=>{const n=H("(min-width: 620px)"),o=I(),{unsubscribeQuery:m,subscribeQuery:h}=A(),{user:d}=P(),{mutateAsync:p}=h,{mutateAsync:i}=m,g=async s=>{const f=s.subscribed?i:p;try{await f({alert_type:s.alert_type})}catch(y){o(y)}},w=C.useMemo(()=>[{accessor:"label",className:b.nameColumn,Header:"Name"},{Header:e.jsxs("div",{className:b.noWrap,children:[e.jsx("span",{children:"Email "}),d&&e.jsx(r.Tooltip,{position:"btm-left",message:`Enabling email notifications will send alerts to ${d.email}, associated with your account`,children:e.jsx(r.Icon,{name:"help"})})]}),accessor:"subscribed",className:b.emailColumn,Cell:({row:s})=>e.jsx("div",{className:b.switch,children:e.jsx(r.Switch,{label:N(s.original.subscribed),defaultChecked:s.original.subscribed,onChange:()=>g(s.original)})})},{accessor:"tags",Header:"Enabled for",className:b.tags,Cell:({row:{original:s}})=>e.jsx(M,{alert:s,availableTagOptions:a})},{Header:"Description",accessor:"description",Cell:({row:{original:s}})=>e.jsx(e.Fragment,{children:s.description})}],[t]);return n?e.jsx(r.ModularTable,{columns:w,data:t,getCellProps:te,emptyMsg:"No data available"}):t.map((s,f)=>e.jsxs(r.Row,{className:R("u-no-padding--left u-no-padding--right",b.alertsWrapper),children:[e.jsx(r.Col,{size:2,small:2,children:e.jsx(j,{label:"Name",value:s.label})}),e.jsx(r.Col,{size:2,small:2,children:e.jsx(j,{label:"Email",value:e.jsx("div",{className:b.switch,children:e.jsx(r.Switch,{label:N(s.subscribed),defaultChecked:s.subscribed,onChange:()=>g(s)})})})}),e.jsx(r.Col,{size:2,small:2,children:e.jsx(j,{label:"Enabled for",value:e.jsx(M,{alert:s,availableTagOptions:a})})}),e.jsx(r.Col,{size:2,small:2,children:e.jsx(j,{label:"Description",value:s.description})})]},f))},le=({alerts:t,availableTagOptions:a})=>{const{user:n}=P(),o=n==null?void 0:n.accounts.find(m=>m.name===n.current_account);return e.jsx("div",{className:U.item,children:e.jsxs("div",{className:_.card,children:[e.jsx("div",{className:_.header,children:e.jsx("p",{className:_.title,children:(o==null?void 0:o.title)||"Alerts"})}),e.jsx("div",{className:_.content,children:e.jsx(ae,{alerts:t,availableTagOptions:a})})]})})},ye=()=>{const{getAlertsQuery:t}=A(),{getAllInstanceTagsQuery:a}=G(),{data:n}=a(),{data:o,isLoading:m}=t(),h=C.useMemo(()=>(o==null?void 0:o.data.filter(i=>!i.alert_type.toUpperCase().includes("LICENSE")))??[],[o]),d=(n==null?void 0:n.data.results.map(i=>({label:i,value:i,group:"Tags"})))??[],p=[{label:"All instances",value:"All"},...d];return e.jsxs(q,{children:[e.jsx(Q,{title:"Alerts"}),e.jsxs(B,{children:[m&&e.jsx(V,{}),!m&&h&&e.jsx(le,{alerts:h,availableTagOptions:p})]})]})};export{ye as default};
