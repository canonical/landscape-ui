import{e as M,l as T,r as y,j as e,g as o,o as F,h as $,k as D,p as H}from"./index-Cgvo6fQq.js";import{u as C}from"./useAlerts-Du44FwDN.js";import{P as z,a as R,b as V}from"./PageMain-CgsCzV83.js";import{d as Q,s as j}from"./DistributionCard.module-CdGw1YvC.js";import{I as A}from"./InfoItem-DRfdno9l.js";import{b as w}from"./output-BGPkZwlr.js";import{M as q}from"./MultiSelectField-lCHOq5Rx.js";import{u as B}from"./formik.esm-zcnRqfub.js";import{c as U,b as W,a as Y}from"./index.esm-CZHDkGlX.js";import{a as _,b}from"./ApiCredentialsTables.module-iPtjgig3.js";import"./InfoItem.module-BZ3tYMsb.js";import{u as G}from"./useInstances-BsLFQd9L.js";import"./useFetchOld-CDdL40Ij.js";import"./useMutation-BlYl6rGT.js";import"./useQuery-BkysfzoD.js";import"./MultiSelectField.module-D1r8qo_i.js";import"./SidePanelFormButtons.module-DyBJG5lm.js";const E=(s,t)=>{const i=new Set(t);return s.filter(r=>!i.has(r))},I=({alert:s,availableTagOptions:t})=>{const i=M(),{notify:r}=T(),{associateAlert:m,disassociateAlert:g}=C(),h=y.useRef(null),{mutateAsync:p}=m,{mutateAsync:c}=g,x=s.all_computers?["All"]:s.tags,a=async({tags:l})=>{try{const u=E(s.tags,l),d=E(l,s.tags),S=l.includes("All"),L=s.all_computers&&!S;if(S)await p({name:s.alert_type,tags:void 0,all_computers:!0});else if(L)await Promise.all([p({name:s.alert_type,tags:l.filter(f=>f!=="All"),all_computers:!1}),c({name:s.alert_type,all_computers:!0})]);else{const f=[];d.length>0&&f.push(p({name:s.alert_type,tags:d,all_computers:!1})),u.length>0&&f.push(c({name:s.alert_type,tags:u,all_computers:!1})),await Promise.all(f)}r.success({title:"Alert tags updated",message:`You changed ${s.label}'s tags`})}catch(u){i(u)}},n=B({initialValues:{tags:x},validationSchema:U().shape({tags:W().of(Y())}),onSubmit:a}),v=n.values.tags.includes("All")?t.filter(({value:l})=>l!=="All"):void 0,P=n.values.tags.includes("All")?t:t.filter(({value:l})=>n.values.tags.includes(l)),k=l=>{const u=l.some(({value:d})=>d==="All")?["All"]:l.map(({value:d})=>d);n.setValues({tags:u})};y.useEffect(()=>{var u,d;const l=(u=h.current)==null?void 0:u.querySelector(".multi-select__condensed-text");(d=l==null?void 0:l.textContent)!=null&&d.includes("All instances")&&(l.textContent="All instances")},[n.values.tags]);const N=()=>n.isSubmitting?!0:x.length===n.values.tags.length&&x.every(l=>n.values.tags.includes(l));return e.jsx(o.Form,{onSubmit:n.handleSubmit,noValidate:!0,children:e.jsx(q,{innerRef:h,required:!0,variant:"condensed",className:_.multiSelect,items:t,selectedItems:P,disabledItems:v,onItemsUpdate:k,placeholder:"Select tags",error:n.touched.tags&&typeof n.errors.tags=="string"?n.errors.tags:void 0,dropdownFooter:e.jsxs("div",{className:_.footer,children:[e.jsx(o.Button,{type:"button",dense:!0,small:!0,className:"u-no-margin--bottom",disabled:N(),onClick:()=>n.setFieldValue("tags",x),children:"Revert"}),e.jsx(o.Button,{type:"submit",dense:!0,small:!0,appearance:"positive",className:"u-no-margin--bottom",disabled:N(),children:"Save changes"})]})})})},J="Enabling email notifications will send alerts to <insert@email.com>, associated with your account",K=s=>{const t={};switch(s.column.id){case"label":t.role="rowheader";break;case"subscribed":t["aria-label"]="Email";break;case"tags":t["aria-label"]="Tags";break;case"description":t["aria-label"]="Description";break}return t},O=({alerts:s,availableTagOptions:t})=>{const i=F("(min-width: 620px)"),r=M(),{unsubscribeQuery:m,subscribeQuery:g}=C(),{mutateAsync:h}=g,{mutateAsync:p}=m,c=async a=>{const n=a.subscribed?p:h;try{await n({alert_type:a.alert_type})}catch(v){r(v)}},x=y.useMemo(()=>[{accessor:"label",className:b.nameColumn,Header:"Name"},{Header:e.jsxs("div",{className:b.noWrap,children:[e.jsx("span",{children:"Email "}),e.jsx(o.Tooltip,{position:"btm-left",message:J,children:e.jsx(o.Icon,{name:"help"})})]}),accessor:"subscribed",className:b.emailColumn,Cell:({row:a})=>e.jsx("div",{className:b.switch,children:e.jsx(o.Switch,{label:w(a.original.subscribed),defaultChecked:a.original.subscribed,onChange:()=>c(a.original)})})},{accessor:"tags",Header:"Enabled for",className:b.tags,Cell:({row:{original:a}})=>e.jsx(I,{alert:a,availableTagOptions:t})},{Header:"Description",accessor:"description",Cell:({row:{original:a}})=>e.jsx(e.Fragment,{children:a.description})}],[s]);return i?e.jsx(o.ModularTable,{columns:x,data:s,getCellProps:K,emptyMsg:"No data available"}):s.map((a,n)=>e.jsxs(o.Row,{className:$("u-no-padding--left u-no-padding--right",b.alertsWrapper),children:[e.jsx(o.Col,{size:2,small:2,children:e.jsx(A,{label:"Name",value:a.label})}),e.jsx(o.Col,{size:2,small:2,children:e.jsx(A,{label:"Email",value:e.jsx("div",{className:b.switch,children:e.jsx(o.Switch,{label:w(a.subscribed),defaultChecked:a.subscribed,onChange:()=>c(a)})})})}),e.jsx(o.Col,{size:2,small:2,children:e.jsx(A,{label:"Enabled for",value:e.jsx(I,{alert:a,availableTagOptions:t})})}),e.jsx(o.Col,{size:2,small:2,children:e.jsx(A,{label:"Description",value:a.description})})]},n))},X=({alerts:s,availableTagOptions:t})=>{const{user:i}=D(),r=i==null?void 0:i.accounts.find(m=>m.name===i.current_account);return e.jsx("div",{className:Q.item,children:e.jsxs("div",{className:j.card,children:[e.jsx("div",{className:j.header,children:e.jsx("p",{className:j.title,children:(r==null?void 0:r.title)||"Alerts"})}),e.jsx("div",{className:j.content,children:e.jsx(O,{alerts:s,availableTagOptions:t})})]})})},Z=()=>{const{getAlertsQuery:s}=C(),{getAllInstanceTagsQuery:t}=G(),{data:i}=t(),{data:r,isLoading:m}=s(),g=y.useMemo(()=>(r==null?void 0:r.data.filter(c=>!c.alert_type.toUpperCase().includes("LICENSE")))??[],[r]),h=(i==null?void 0:i.data.results.map(c=>({label:c,value:c,group:"Tags"})))??[],p=[{label:"All instances",value:"All"},...h];return e.jsxs(z,{children:[e.jsx(R,{title:"Alerts"}),e.jsxs(V,{children:[m&&e.jsx(H,{}),!m&&g&&e.jsx(X,{alerts:g,availableTagOptions:p})]})]})},xe=Z;export{xe as default};
