import{v as A,w as y,ac as v,p as d,J as T,i as c,an as n,r as j,y as P,z as E,C as R,j as a,d as o}from"./index-DYykpNVa.js";import{C as w}from"./CodeEditor-B9M2dPM_.js";import{S as I}from"./SidePanelFormButtons-Aj5ThB2m.js";import{u as _}from"./useRoles-CK1OAvut.js";import{g as l}from"./formikErrors-Bw8iTXYS.js";import{u as V,D as q,S as D}from"./ScriptFormAttachments-DAnYsFsn.js";import{u as N}from"./useFetchOld-BGD2hIpr.js";import{j as k,i as L,r as O}from"./ScriptsTabs-BrOiXEKJ.js";import"./index-Cbj0Sz5k.js";import"./SidePanelFormButtons.module-CcPyiogC.js";import"./AttachmentFile-Dr_XbZxY.js";import"./TablePagination-CIA4CRba.js";import"./TableFilterChips-DLH4XQ-H.js";import"./helpers-DblkVUdf.js";import"./constants-CXofZZ4i.js";import"./NoData-CT6SeJUX.js";import"./ResponsiveTable-C-8YbfBJ.js";import"./StaticLink-BX9qJBBO.js";import"./TruncatedCell-DQQZxgbr.js";import"./Truncated-DtD6hAHP.js";import"./useExpandableRow-CGDZ27WS.js";import"./TextConfirmationModal-DuGXYB1S.js";import"./PageParamFilter-LH49uHXA.js";import"./TableFilter-C7yTBfOe.js";import"./HeaderWithSearch-DH3OfcZg.js";import"./SingleInstanceTabs.module-DvhuGYYD.js";const B=()=>{const r=N(),u=A(),{mutateAsync:m,isPending:p}=y({mutationKey:["scripts","create"],mutationFn:async h=>r.get("CreateScript",{params:h}),onSuccess:async()=>u.invalidateQueries({queryKey:["scripts"]})});return{createScript:m,isCreatingScript:p}},G={title:"",code:"",access_group:v,attachments:{first:null,second:null,third:null,fourth:null,fifth:null},attachmentsToRemove:[]},M=()=>d().shape({title:c().required("This field is required"),access_group:c().nullable(),code:c().test({name:"required",message:"This field is required",test:r=>!!r}),attachments:d().shape({first:n().nullable(),second:n().nullable(),third:n().nullable(),fourth:n().nullable(),fifth:n().nullable()}),attachmentsToRemove:T().of(c())}),gt=()=>{const r=j.useRef(null),{closeSidePanel:u}=P(),m=E(),{getAccessGroupQuery:p}=_(),{createScript:h}=B(),{createScriptAttachment:f}=V(),{data:g}=p(),S=(g?.data??[]).map(e=>({label:e.title,value:e.name})),b=async e=>{const s=Object.values(e.attachments).filter(i=>i!==null);try{const i=await h(k(e));s.length&&await Promise.all(await L({attachments:s,createScriptAttachment:f,script_id:i.data.id})),u()}catch(i){m(i)}},t=R({initialValues:G,validationSchema:M(),onSubmit:b}),C=async({target:{files:e}})=>{const s=e?.[0];if(!s)return;const i=t.setFieldValue("code",await s.text());if(t.values.title){await i;return}await Promise.all([t.setFieldValue("title",O(s.name)),i])},x=async e=>{await t.setFieldValue("code",e)},F=()=>r.current?.click();return a.jsxs(o.Form,{onSubmit:t.handleSubmit,noValidate:!0,children:[a.jsx(o.Input,{type:"text",label:"Title",required:!0,...t.getFieldProps("title"),error:l(t,"title")}),a.jsx("input",{ref:r,className:"u-hide",type:"file",onChange:C}),a.jsx(w,{label:"Code",value:t.values.code,onChange:x,error:l(t,"code"),required:!0,defaultValue:q,headerContent:a.jsxs(o.Button,{className:"u-no-margin--bottom",appearance:"base",hasIcon:!0,onClick:F,type:"button",children:[a.jsx(o.Icon,{name:"upload"}),a.jsx("span",{children:"Populate from file"})]})}),a.jsx(o.Select,{label:"Access group",...t.getFieldProps("access_group"),options:S,error:l(t,"access_group")}),a.jsxs(a.Fragment,{children:[a.jsx("h5",{children:"List of attachments"}),a.jsx("p",{className:"u-text--muted",children:"Attachments that will be sent along with the script. You can attach up to 5 files, for a maximum of 1.00MB. Filenames must be unique. On the client, the attachments will be placed in the directory whose name is accessible through the environment variable LANDSCAPE_ATTACHMENTS. They'll be deleted once the script has been run."})]}),a.jsx(D,{attachments:t.values.attachments,attachmentsToRemove:t.values.attachmentsToRemove,getFileInputError:e=>l(t,["attachments",e]),initialAttachments:[],onFileInputChange:e=>async s=>t.setFieldValue(`attachments.${e}`,s.target.files?.[0]??null),onInitialAttachmentDelete:e=>{t.setFieldValue("attachmentsToRemove",[...t.values.attachmentsToRemove,e])}}),a.jsx(I,{submitButtonText:"Add script",submitButtonDisabled:t.isSubmitting})]})};export{gt as default};
