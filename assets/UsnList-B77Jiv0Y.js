import{i as _,j as s,X as E,p as H,q as S,h as D,P as A,d as w,v as I,k as M,aF as $,N,az as j,D as z,o as v,aw as L,aB as F}from"./index-DUPkHx4d.js";import{E as y,S as V}from"./SelectAllButton-Cccwokze.js";import{u as B}from"./useUsns-DgYz4k60.js";const q=({column:e})=>{const a={};return e.id==="title"?a.role="rowheader":e.id==="upgrades.security"&&(a["aria-label"]="Affected packages"),a},Q="_security_16o7z_1",O={security:Q},Y=({instances:e,limit:a,onLimitChange:i,usn:o,usnPackages:l})=>{const r=_.useMemo(()=>e.filter(({id:n})=>l.flatMap(({computer_ids:m})=>m).includes(n)).slice(0,a),[e,a,l]),t=_.useMemo(()=>[{accessor:"title",Header:"Name"},{accessor:"upgrades.security",className:O.security,Header:"Affected packages",Cell:({row:{original:n}})=>l.filter(({computer_ids:m})=>m.includes(n.id)).length}],[r.length]);return s.jsx(y,{columns:t,data:r,itemNames:{plural:"instances",singular:"instance"},onLimitChange:i,totalCount:r.length,title:s.jsxs("p",{className:"p-heading--4",children:["Instances affected by ",s.jsx("b",{children:o})]}),getCellProps:q})},W=({instanceTitle:e,usn:a})=>{const i=E(),o=H(),{notify:l}=S(),{removeUsnPackagesQuery:r}=B(),{setPageParams:t}=D(),{instanceId:n,childInstanceId:m}=A(),b=Number(n),{mutateAsync:g,isPending:d}=r,h=()=>{i(`/instances/${m?`${b}/${m}`:`${b}`}`),t({tab:"activities"}),l.clear()},k=async()=>{try{await g({usns:a,instanceId:b}),l.success({title:"You queued packages to be uninstalled",message:`Packages affected by "${a}" security issue will be uninstalled and are queued in Activities.`,actions:[{label:"View details",onClick:h}]})}catch(x){o(x)}};return s.jsxs(w.ConfirmationButton,{type:"button",className:"is-small is-dense has-icon",confirmationModalProps:{title:"Uninstall USN packages",children:s.jsxs("p",{children:['This will uninstall packages affected by "',a,'" security issue from the "',e,'" instance.']}),confirmButtonLabel:"Uninstall",confirmButtonAppearance:"negative",confirmButtonDisabled:d,confirmButtonLoading:d,onConfirm:k},children:[s.jsx(w.Icon,{name:"delete",className:"u-no-margin--left"}),s.jsx("span",{children:"Uninstall packages"})]},"remove")},X=({column:e})=>{const a={};return e.id==="name"?a.role="rowheader":e.id==="current_version"?a["aria-label"]="Current version":e.id==="new_version"?a["aria-label"]="New version":e.id==="summary"&&(a["aria-label"]="Details"),a},G=({instanceTitle:e,limit:a,onLimitChange:i,showRemoveButton:o,usn:l,usnPackages:r})=>{const t=_.useMemo(()=>r.slice(0,a),[a,r]),n=_.useMemo(()=>[{accessor:"name",Header:"Package"},{accessor:"current_version",Header:"Current version"},{accessor:"new_version",Header:"New version"},{accessor:"summary",Header:"Details"}],[t.length]);return s.jsx(y,{additionalCta:o&&s.jsx(W,{instanceTitle:e,usn:l}),columns:n,data:t,itemNames:{plural:"packages",singular:"package"},onLimitChange:i,title:s.jsxs("p",{className:"p-heading--4",children:["Packages affected by ",s.jsx("b",{children:l})]}),totalCount:r.length,getCellProps:X})},J=({instances:e,isRemovable:a,listType:i,usn:o})=>{const[l,r]=_.useState(5),{getAffectedPackagesQuery:t}=B(),{instanceId:n}=A(),m=Number(n),{data:b,isLoading:g}=t({usn:o,computer_ids:a?[m]:e.map(({id:h})=>h)}),d=b?.data??[];return s.jsxs(s.Fragment,{children:[g&&s.jsx(I,{}),!g&&i==="instances"&&s.jsx(Y,{instances:e,limit:l,onLimitChange:()=>r(h=>h+5),usn:o,usnPackages:d}),!g&&i==="packages"&&s.jsx(G,{instanceTitle:e[0].title,limit:l,onLimitChange:()=>r(h=>h+5),showRemoveButton:a,usn:o,usnPackages:d})]})},C={computers_count:0,cves:[],date:"",info:"",packages:[],usn:"",usn_link:""},K="_expanded_18uiz_1",U="_expandButton_18uiz_19",Z="_hidden_18uiz_28",ee="_innerTable_18uiz_32",ae="_row_18uiz_36",se="_cve_18uiz_42",te="_cveLink_18uiz_46",ne="_wrapper_18uiz_50",p={expanded:K,expandButton:U,hidden:Z,innerTable:ee,row:ae,cve:se,cveLink:te,wrapper:ne},ce=({expandedCell:e,isUsnsLoading:a,showSelectAllButton:i,usns:o})=>{const l=e?.column==="computers_count"||e?.column==="release_packages"?e.row+1:0;return[...[C].slice(i?0:1),...o.slice(0,l||o.length),...o.slice(l?l-1:o.length),...[C].slice(a?0:1)]},P=({expandedCell:e,isUsnsLoading:a,lastUsnIndex:i,showSelectAllButton:o})=>({column:l,row:{index:r}})=>{const t={};return o&&r===0||a&&r===i||e?.row===r-1&&["computers_count","release_packages"].includes(e.column)?l.id==="usn"?(t.colSpan=5,e?.row===r-1&&["computers_count","release_packages"].includes(e.column)&&(t.className=p.innerTable)):(t.className=p.hidden,t["aria-hidden"]=!0):l.id==="usn"?t.role="rowheader":l.id==="cves"?(t["aria-label"]="CVE(s)",e?.column===l.id&&e.row===r&&(t.className="expandedCell")):l.id==="date"?t["aria-label"]="Date published":l.id==="computers_count"?(t["aria-label"]="Affected instances",t.className=e?.column===l.id&&e.row===r?p.expanded:p.row):l.id==="release_packages"&&(t["aria-label"]="Affected packages",t.className=e?.column===l.id&&e.row===r?p.expanded:p.row),t},T=e=>({index:a})=>{const i={};return e?.column==="cves"&&e.row===a&&(i.className="expandedRow"),i},le=e=>a=>{a&&(e.current=[...a.querySelectorAll("tbody tr")])},ue=({instances:e,isUsnsLoading:a,onSelectedUsnsChange:i,selectedUsns:o,totalUsnCount:l,usns:r,...t})=>{const[n,m]=_.useState(null),b=_.useRef([]);M({current:n?.column==="cves"?b.current[n.row]:null},()=>{m(null)});const g=t.tableType==="expandable"&&t.showSelectAllButton,d=_.useMemo(()=>ce({expandedCell:n,isUsnsLoading:a,showSelectAllButton:g,usns:r}),[r,n,a,g]),h=c=>{i(o.includes(c)?o.filter(u=>u!==c):[...o,c])},k=(c,u)=>{m(f=>f?.column===c&&f.row===u?null:{column:c,row:f&&["computers_count","release_packages"].includes(f.column)&&f.row<u?u-1:u})},x=_.useMemo(()=>[{accessor:"checkbox",className:"checkbox-column",Header:()=>s.jsx(w.CheckboxInput,{inline:!0,label:s.jsx("span",{className:"u-off-screen",children:"Toggle all security issues"}),disabled:d.length===0||a,indeterminate:o.length>0&&o.length<r.length,checked:o.length>0&&o.length===r.length,onChange:()=>{i(o.length>0?[]:r.map(({usn:c})=>c))}}),Cell:({row:{original:c}})=>s.jsx(w.CheckboxInput,{labelClassName:"u-no-margin--bottom u-no-padding--top",label:s.jsx("span",{className:"u-off-screen",children:`Toggle ${c.usn}`}),disabled:a,name:"usn",checked:o.includes(c.usn),onChange:()=>{h(c.usn)}})},{accessor:"usn",Header:"USN",Cell:({row:{index:c,original:u}})=>c===0&&g?s.jsx(V,{count:t.totalSelectedUsnCount,itemName:{plural:"security issues",singular:"security issue"},onClick:t.onSelectAllClick,totalCount:l}):n?.row===c-1&&["computers_count","release_packages"].includes(n.column)?s.jsx(J,{isRemovable:n.column==="release_packages"&&t.tableType==="paginated",instances:e,listType:n.column==="release_packages"?"packages":"instances",usn:d[n.row].usn}):a&&c===d.length-1?s.jsx(I,{}):s.jsx("a",{href:u.usn_link,target:"_blank",rel:"nofollow noopener noreferrer",children:u.usn})},{accessor:"cves",Header:"CVE(s)",Cell:({row:{original:c,index:u}})=>c.cves.length>0?s.jsx($,{content:c.cves.map(({cve:f,cve_link:R})=>s.jsx("span",{className:p.cve,children:s.jsx("a",{href:R,target:"_blank",rel:"nofollow noopener noreferrer",className:p.cveLink,children:f})},f)),isExpanded:n?.column==="cves"&&n.row===u,onExpand:()=>{k("cves",u)}}):s.jsx(N,{})},{accessor:"date",Header:"Date published",Cell:({row:c})=>s.jsx(s.Fragment,{children:j(c.original.date).isValid()?s.jsx("span",{className:"font-monospace",children:j(c.original.date).format(z)}):s.jsx(N,{})})},{accessor:"computers_count",Header:"Affected instances",Cell:({column:c,row:{index:u,original:f}})=>s.jsx(w.Button,{type:"button",className:v("p-accordion__tab",p.expandButton),"aria-expanded":n?.column===c.id&&n.row===u,onClick:()=>{k(c.id,u)},children:f.computers_count})},{accessor:"release_packages",Header:"Affected packages",Cell:({column:c,row:{index:u}})=>s.jsx(w.Button,{type:"button",className:v("p-accordion__tab",p.expandButton),"aria-expanded":n?.column===c.id&&n.row===u,onClick:()=>{k(c.id,u)},children:`${n?.column===c.id&&n.row===u?"Hide":"Show"} packages`})}].filter(({accessor:c})=>t.tableType==="paginated"?c!=="computers_count":c!=="date"),[d,a,o.length,t.tableType,n]);return s.jsx("div",{ref:le(b),className:p.wrapper,children:t.tableType==="expandable"?s.jsx(y,{columns:x,data:d,getCellProps:P({expandedCell:n,isUsnsLoading:a,lastUsnIndex:d.length-1,showSelectAllButton:g}),getRowProps:T(n),itemCount:r.length,itemNames:{plural:"security issues",singular:"security issue"},onLimitChange:t.onNextPageFetch,totalCount:l}):s.jsxs(s.Fragment,{children:[s.jsx(L,{columns:x,data:d,getCellProps:P({expandedCell:n,isUsnsLoading:a}),getRowProps:T(n),emptyMsg:`No security issues found with the search "${t.search}"`}),s.jsx(F,{handleClearSelection:()=>{i([])},totalItems:l,currentItemCount:r.length})]})})};export{ue as U};
