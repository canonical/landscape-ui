import{d as F,i as T,k as g,G as v,q as w,p as S,s as q,H as x,t as P,y as R,B as m,aq as B,j as i,e as c}from"./index-DN_YS9_3.js";import{F as C}from"./FileInput-D0C4h8nk.js";import{S as N}from"./SidePanelFormButtons-CeIrPige.js";import{u as j}from"./useGetWslInstanceTypes-CimG2b9J.js";import"./SidePanelFormButtons.module-CcPyiogC.js";const A=()=>{const a=F(),o=T(),{isPending:r,mutateAsync:s}=g({mutationFn:async({parent_id:u,...l})=>a.post(`computers/${u}/children`,l),onSuccess:async()=>Promise.all([o.invalidateQueries({queryKey:["wsl-hosts"]}),o.invalidateQueries({queryKey:["instances"]})])});return{isCreatingWslInstance:r,createWslInstance:s}},W=[/^ubuntu$/,/^ubuntu-preview$/,/^ubuntu-[0-9]{2}\.[0-9]{2}$/],E=1,L=a=>{if(a)return new Promise((o,r)=>{const s=new FileReader;s.readAsDataURL(a),s.onload=()=>{o(s.result)},s.onerror=u=>{r(u)}})},Q=()=>{const{instanceId:a}=v(),o=w(),{closeSidePanel:r}=S(),{notify:s}=q(),{openActivityDetails:u}=x(),{isGettingWslInstanceTypes:l,wslInstanceTypes:p}=j(),{createWslInstance:y}=A(),e=P({initialValues:{instanceType:"Ubuntu",cloudInit:null,instanceName:"",rootfs:""},validationSchema:R({instanceType:m().required("This field is required"),cloudInit:B().nullable().test("file-size","File size must be less than 1MB",t=>t?t.size===void 0?!1:t.size<=E*1024*1024:!0),instanceName:m().when("instanceType",{is:"custom",then:t=>t.required("This field is required").test("not-match-reserved-patterns","Instance name cannot match 'ubuntu', 'ubuntu-preview', or 'ubuntu-<dd>.<dd>'",n=>!W.some(d=>d.test(n.toLowerCase())))}),rootfs:m().url().when("instanceType",{is:"custom",then:t=>t.required("This field is required")})}),onSubmit:async t=>{try{const n=await L(t.cloudInit),d=n?n.split(",")[1]:void 0,{data:f}=await y({parent_id:parseInt(a??""),computer_name:t.instanceType==="custom"?t.instanceName:t.instanceType,rootfs_url:t.instanceType==="custom"?t.rootfs:void 0,cloud_init:d});r(),s.success({title:`You have successfully marked ${t.instanceName} to be installed.`,message:"An activity has been queued to install it.",actions:[{label:"View details",onClick:()=>{u(f)}}]})}catch(n){o(n)}}}),b=[...p.map(({label:t,name:n})=>({label:t,value:n}))||[],{label:"Custom",value:"custom"}],h=async t=>{await e.setFieldValue("cloudInit",t[0])},I=async()=>{await e.setFieldValue("cloudInit",null)};return i.jsxs(c.Form,{onSubmit:e.handleSubmit,noValidate:!0,children:[i.jsx(c.Select,{label:"Instance type",required:!0,disabled:l,options:b,...e.getFieldProps("instanceType"),error:e.touched.instanceType&&e.errors.instanceType?e.errors.instanceType:void 0}),e.values.instanceType==="custom"&&i.jsxs(i.Fragment,{children:[i.jsx(c.Input,{label:"Instance name",type:"text",required:!0,...e.getFieldProps("instanceName"),error:e.touched.instanceName&&e.errors.instanceName?e.errors.instanceName:void 0}),i.jsx(c.Input,{label:"rootfs URL",type:"text",required:!0,...e.getFieldProps("rootfs"),error:e.touched.rootfs&&e.errors.rootfs?e.errors.rootfs:void 0})]}),i.jsx(C,{label:"cloud-init",accept:".yaml",...e.getFieldProps("cloudInit"),onFileRemove:I,onFileUpload:h,help:"You can use a cloud-init configuration YAML file under 1MB to register new WSL instances. cloud-init streamlines the setup by automating installation and configuration tasks.",error:e.touched.cloudInit&&e.errors.cloudInit?e.errors.cloudInit:void 0}),i.jsx(N,{submitButtonDisabled:e.isSubmitting,submitButtonText:"Create",submitButtonAriaLabel:"Create new WSL instance"})]})};export{Q as default};
