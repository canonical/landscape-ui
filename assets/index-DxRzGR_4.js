import{h as S,k as n,t as m,i as T,l as v,p as x,q as j,f as F,s as _,j as r,g as d}from"./index-Bwatsl1G.js";import{m as w}from"./usePageParams-gxSf1nMa.js";import{M as p}from"./MultiSelectField-B42pkRH6.js";import{S as D}from"./SidePanelFormButtons-CIamrVW7.js";import{u as $}from"./useInstances-CvI7zscF.js";import{u as A,D as P}from"./index-BElZQmuc.js";import{c as k}from"./helpers-Q9GvzaAC.js";import"./InstancesPageActions-0XsW5-wX.js";import"./SidePanelFormButtons.module-tJTvEwdD.js";import"./useFetchOld--qBGHGTA.js";import"./CodeEditor-B_BjUb0R.js";import"./useRoles-f6kdZUNk.js";import"./index-C_rp6kpZ.js";import"./TablePagination-CYwNZA2E.js";import"./TablePaginationBase-Ds3XrZnG.js";import"./StatusFilter-BlNgJH3S.js";import"./TableFilter-DyxtB4xw.js";import"./TableFilterChips-t7GEBfEp.js";import"./NoData-CcX6zdBS.js";try{let s=typeof window<"u"?window:typeof global<"u"?global:typeof globalThis<"u"?globalThis:typeof self<"u"?self:{},a=new s.Error().stack;a&&(s._sentryDebugIds=s._sentryDebugIds||{},s._sentryDebugIds[a]="198dff2c-313d-4c21-9a60-b30dc403ca88",s._sentryDebugIdIdentifier="sentry-dbid-198dff2c-313d-4c21-9a60-b30dc403ca88")}catch{}const N={deliverImmediately:!0,deliver_after:"",instanceIds:[],queryType:"tags",tags:[],username:""},O=S().shape({deliverImmediately:T().required("This field is required."),deliver_after:n().when("deliverImmediately",{is:!1,then:s=>s.required("This field is required.")}),instanceIds:m().of(v()).when("queryType",{is:"ids",then:s=>s.min(1,"At least one instance is required.")}),queryType:n().required("This field is required."),tags:m().of(n()).when("queryType",{is:"tags",then:s=>s.min(1,"At least one tag is required.")}),username:n().required("This field is required.")}),se=({script:s})=>{const a=x(),{notify:y}=j(),{closeSidePanel:f}=F(),{getAllInstanceTagsQuery:g,getInstancesQuery:I}=$(),{executeScriptQuery:b}=A(),{mutateAsync:q}=b,e=_({initialValues:N,onSubmit:async t=>{const i={query:t.queryType==="ids"?`id:${t.instanceIds.join(" OR id:")}`:`tag:${t.tags.join(" OR tag:")}`,script_id:s.id,username:t.username};t.deliverImmediately||(i.deliver_after=w(t.deliver_after).toISOString().replace(/\.\d+(?=Z$)/,""));try{await q(i),f(),y.success({message:`"${s.title}" script queued to execute successfully`,title:"Script execution queued"})}catch(h){a(h)}},validationSchema:O}),{data:o}=g(),l=(o==null?void 0:o.data.results.map(t=>({label:t,value:t})))??[],{data:u}=I(),c=(u==null?void 0:u.data.results.filter(t=>k("runScripts",t)).map(({title:t,id:i})=>({label:t,value:i})))??[];return r.jsxs(d.Form,{onSubmit:e.handleSubmit,noValidate:!0,children:[r.jsx("p",{className:"u-no-margin--bottom",children:"Select instances by:"}),r.jsxs("div",{className:"p-form--inline is-required",children:[r.jsx(d.Input,{type:"radio",label:"Tags",...e.getFieldProps("queryType"),value:"tags",checked:e.values.queryType==="tags"}),r.jsx(d.Input,{type:"radio",label:"Names",...e.getFieldProps("queryType"),value:"ids",checked:e.values.queryType==="ids"})]}),e.values.queryType==="tags"&&r.jsx(p,{variant:"condensed",label:"Tags",required:!0,...e.getFieldProps("tags"),items:l,selectedItems:l.filter(({value:t})=>e.values.tags.includes(t)),onItemsUpdate:t=>e.setFieldValue("tags",t.map(({value:i})=>i)),error:e.touched.tags&&typeof e.errors.tags=="string"?e.errors.tags:void 0}),e.values.queryType==="ids"&&r.jsx(p,{variant:"condensed",label:"Instances",required:!0,...e.getFieldProps("instanceIds"),items:c,selectedItems:c.filter(({value:t})=>e.values.instanceIds.includes(t)),onItemsUpdate:t=>e.setFieldValue("instanceIds",t.map(({value:i})=>i)),error:e.touched.instanceIds&&typeof e.errors.instanceIds=="string"?e.errors.instanceIds:void 0}),r.jsx(d.Input,{type:"text",label:"Run as user",autoComplete:"off",required:!0,...e.getFieldProps("username"),error:e.touched.username&&e.errors.username?e.errors.username:void 0}),r.jsx(P,{formik:e}),r.jsx(D,{submitButtonDisabled:e.isSubmitting,submitButtonText:"Run script"})]})};export{se as default};
