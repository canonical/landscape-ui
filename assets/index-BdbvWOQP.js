import{j as e,r as x,m as s,y as O,af as K,n as g,o as D,l as Q,J as Y,B as k,F as y,G as W,v as B,$ as I}from"./index-BEUDjxZw.js";import{A as X}from"./AssociationBlock-Cu_d7IC7.js";import{t as L,u as Z}from"./index-KUqUdhwc.js";import{S as ee}from"./SidePanelFormButtons-LYWL_FM4.js";import{u as te}from"./useInstances-D5jR07TT.js";import{g as f}from"./formikErrors-Bw8iTXYS.js";import{b as re,u as ne}from"./ScriptsTabs-CS6vFrDE.js";import"./index-Bf_KPBmd.js";import{D as se}from"./downshift.esm-BTm2D0dh.js";import"./MultiSelectField-BuDRFb7g.js";import"./HeaderWithSearch-CR9J-Bz3.js";import"./SidePanelFormButtons.module-D2P5PizG.js";import"./TruncatedCell-11w6KeP-.js";import"./useRoles-KGB_ry2J.js";import"./SingleInstanceTabs.module-Cm1BYFZQ.js";const N=({label:n,value:a})=>e.jsxs("div",{children:[e.jsx("div",{className:"p-heading--1 u-no-padding--top u-no-margin--bottom",children:a}),e.jsx("div",{className:"p-text--x-small u-text--muted",children:n})]}),ie="_example_16wh9_1",ae="_table_16wh9_6",P={example:ie,table:ae},oe=()=>{const[n,a]=x.useState(!1),i=()=>{a(!0)},d=()=>{a(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(s.Button,{type:"button",appearance:"base",className:"u-no-margin--bottom",hasIcon:!0,onClick:i,children:e.jsx(s.Icon,{name:s.ICONS.help})}),n&&e.jsxs(s.Modal,{title:"Cron job format",close:d,children:[e.jsxs("section",{children:[e.jsx("h1",{className:"p-text--small-caps",children:"Example"}),e.jsxs("div",{className:P.example,children:[e.jsx(N,{label:"Minute",value:"1"}),e.jsx(N,{label:"Hour",value:"*"}),e.jsx(N,{label:e.jsxs(e.Fragment,{children:["Day",e.jsx("br",{}),"(month)"]}),value:"2"}),e.jsx(N,{label:"Month",value:"1-3"}),e.jsx(N,{label:e.jsxs(e.Fragment,{children:["Day",e.jsx("br",{}),"(week)"]}),value:"*"})]}),e.jsx("p",{children:'"At minute 1 on day-of-month 2 in every month from January through March"'})]}),e.jsxs("section",{children:[e.jsx("h1",{className:"p-text--small-caps",children:"Accepted values"}),e.jsx(s.MainTable,{className:P.table,rows:[{columns:[{content:"* (asterisk)"},{content:"Any value"}]},{columns:[{content:", (comma)"},{content:"List separator"}]},{columns:[{content:"- (dash)"},{content:"Range"}]},{columns:[{content:"/ (slash)"},{content:"Step values"}]}]}),e.jsx(s.MainTable,{className:P.table,rows:[{columns:[{content:"Minute"},{content:"0-59"}]},{columns:[{content:"Hour"},{content:"0-23"}]},{columns:[{content:"Day of the month"},{content:"1-31"}]},{columns:[{content:"Month"},{content:"1-12 or JAN-DEC"}]},{columns:[{content:"Day of the week"},{content:"0-6 or SUN-SAT"}]}]})]})]})]})},le=({touched:n,value:a,...i})=>{const d=x.useId();let o="",h="";try{const u=L(a.toString());o=`"${u.charAt(0).toUpperCase()}${u.slice(1)}"`}catch(u){if(!(u instanceof Error))return;h=u.message}return e.jsxs(e.Fragment,{children:[e.jsx("label",{htmlFor:d,children:"* Schedule"}),e.jsx(oe,{}),e.jsx(s.Input,{id:d,type:"text",...i,help:o,value:a,error:n&&h,required:!0})]})},ce="_description_19733_1",de="_indent_19733_6",ue="_notification_19733_11",w={description:ce,indent:de,notification:ue},me="_container_1yawx_1",pe="_suggestionsContainer_1yawx_6",he="_pointer_1yawx_13",ge="_highlighted_1yawx_18",xe="_selectedContainer_1yawx_22",_e="_marginTop_1yawx_30",fe="_extraPadding_1yawx_34",je="_removeButton_1yawx_44",be="_icon_1yawx_48",p={container:me,suggestionsContainer:pe,pointer:he,highlighted:ge,selectedContainer:xe,marginTop:_e,extraPadding:fe,removeButton:je,icon:be},ye=200,ve=(n,a)=>{const i=n.toLowerCase(),d=a.toLowerCase(),o=i.indexOf(d);return o>=0?e.jsxs(e.Fragment,{children:[n.substring(0,o),e.jsx("strong",{children:n.substring(o,o+a.length)}),n.substring(o+a.length)]}):n},Ne=({script:n,setScript:a,existingScriptId:i,errorMessage:d})=>{const[o,h]=x.useState(""),[u,j]=x.useState(!1),[m,S]=x.useState(""),{script:_,isScriptLoading:r}=re(i||0,{enabled:!!i});x.useEffect(()=>{i&&(n==null?void 0:n.id)!==(_==null?void 0:_.id)&&a(_)},[_]);const v=O(),{scripts:C,isScriptsLoading:b}=ne({listenToUrlParams:!1},{search:o,script_type:"active",limit:20,offset:0},{enabled:o.length>2}),T=c=>(n==null?void 0:n.id)!==c.id,t=C.filter(T),l=()=>{a(null)},q=()=>{j(!1)},E=()=>{S(""),h("")},R=()=>{m.length>2?j(!0):j(!1)},$=c=>{S(c),c.length>2&&h(c)},U=K(()=>{try{R()}catch(c){v(c)}},ye),V=c=>{c&&(a(c),j(!1),E())},G=c=>{c.key==="Escape"?c.currentTarget.blur():U()},A=m.length<3?"Min 3. characters":C.length===0&&o&&!b?`No scripts found by "${o}"`:i?"Scripts can't be replaced after the profile has been created.":null;return e.jsxs("div",{className:g(p.container,"p-form__group p-form-validation"),children:[e.jsx("label",{className:"is-required p-form__label",htmlFor:i?"script-selected":"script-search",children:"Script"}),!i&&e.jsx(se,{onSelect:V,itemToString:()=>"",isOpen:u,children:({getInputProps:c,getItemProps:H,getMenuProps:J,highlightedIndex:z})=>e.jsxs("div",{className:"p-autocomplete",children:[e.jsx(s.SearchBox,{...c(),id:i?void 0:"script-search",placeholder:"Search for scripts",required:!0,className:"u-no-margin--bottom",shouldRefocusAfterReset:!0,externallyControlled:!0,autocomplete:"off",value:m,onChange:$,onClear:E,onBlur:q,onFocus:R,onKeyUp:G}),A?e.jsx("span",{className:"p-form-help-text",children:A}):null,d&&!u?e.jsx("div",{className:"is-error",children:e.jsx("span",{className:"p-form-validation__message",id:"script-error",children:e.jsx("span",{children:d})})}):null,u&&(t.length>0||b)?e.jsx("ul",{className:g("p-list p-card--highlighted u-no-padding u-no-margin--bottom p-autocomplete__suggestions",p.suggestionsContainer),...J(),children:b?e.jsx(D,{}):t.map((F,M)=>e.jsx("li",{className:g("p-list__item",p.pointer,{[p.highlighted]:z===M}),...H({item:F,index:M}),children:e.jsx("div",{className:"u-truncate","data-testid":"dropdownElement",children:ve(F.title,o)})},F.id))}):null]})}),r?e.jsx(D,{}):null,n&&e.jsxs("div",{id:"script-selected",className:g("p-autocomplete__result p-list__item p-card u-no-margin--bottom",p.selectedContainer,{[p.marginTop]:!i,[p.extraPadding]:i}),children:[e.jsx("span",{children:e.jsx("b",{children:n.title})}),i?null:e.jsx(s.Button,{type:"button",appearance:"base",className:g(p.removeButton,"u-no-margin--bottom u-no-margin--right"),onClick:l,children:e.jsx(s.Tooltip,{message:"Remove",children:e.jsx(s.Icon,{name:s.ICONS.delete,className:p.icon})})})]},n.id)]})},Le=({onSubmit:n,onSuccess:a,initialValues:i,disabledFields:d={},submitButtonText:o,submitting:h=!1})=>{const u=O(),{closeSidePanel:j}=Q(),{scriptProfileLimits:m,isGettingScriptProfileLimits:S}=Z(),{getInstancesQuery:_}=te(),r=Y({initialValues:i,validationSchema:k().shape({interval:y().when("trigger_type",([t],l)=>t=="recurring"?l.required("This field is required").test({test:q=>{try{return L(q),!0}catch{return!1}}}):l),script:k().when("script_id",([t],l)=>t==null?l.required("This field is required"):l),start_after:y().when("trigger_type",([t],l)=>t=="recurring"?l.required("This field is required"):l),time_limit:W().required("This field is required"),timestamp:y().when("trigger_type",([t],l)=>t=="one_time"?l.required("This field is required"):l),title:y().required("This field is required"),trigger_type:y().required("This field is required"),username:y().required("This field is required")}),onSubmit:async t=>{if(!(!t.trigger_type||t.script_id==null)){try{switch(t.trigger_type){case"event":{await n({...t,script_id:t.script_id,trigger:{trigger_type:"event",event_type:"post_enrollment"}});break}case"one_time":{if(!t.timestamp)return;await n({...t,script_id:t.script_id,trigger:{trigger_type:"one_time",timestamp:t.timestamp,last_run:"",next_run:""}});break}case"recurring":{if(!t.interval||!t.start_after)return;await n({...t,script_id:t.script_id,trigger:{trigger_type:"recurring",interval:t.interval,start_after:t.start_after,last_run:"",next_run:""}});break}}}catch(l){u(l);return}j(),a(t)}}}),{data:v,isLoading:C}=_({query:r.values.all_computers?void 0:r.values.tags.map(t=>`tag:${t}`).join(" OR ")}),[b,T]=x.useState(!1);if(x.useEffect(()=>{if(!(!v||!m)){if(!r.values.tags.length&&!r.values.all_computers){T(!1);return}T(v.data.count>=m.max_num_computers)}},[v]),S)return e.jsx(D,{});if(m)return e.jsxs(s.Form,{noValidate:!0,onSubmit:r.handleSubmit,children:[e.jsx(s.Input,{type:"text",label:"Name",required:!0,...r.getFieldProps("title"),error:f(r,"title")}),e.jsx(Ne,{script:r.values.script,existingScriptId:r.initialValues.script_id,setScript:async t=>{await r.setFieldValue("script",t),await r.setFieldValue("script_id",t==null?void 0:t.id)},errorMessage:f(r,"script")}),e.jsxs(s.Row,{className:"u-no-padding",children:[e.jsx(s.Col,{size:6,children:e.jsx(s.Input,{type:"text",label:"Run as user",required:!0,...r.getFieldProps("username"),error:f(r,"username")})}),e.jsx(s.Col,{size:6,children:e.jsx(s.Input,{type:"number",label:"Time limit (seconds)",required:!0,...r.getFieldProps("time_limit"),error:f(r,"time_limit")})})]}),e.jsx(s.CustomSelect,{label:"Trigger",required:!0,onChange:async t=>{await r.setFieldValue("trigger_type",t)},value:r.values.trigger_type,disabled:d.trigger_type,error:f(r,"trigger_type"),options:[{label:e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"u-no-padding--top u-no-margin--bottom",children:"Post enrollment"}),e.jsx("p",{className:g(w.description,"u-no-margin--bottom"),children:e.jsx("small",{children:"Run the script after a new instance is enrolled"})})]}),value:"event",text:"Post enrollment"},{label:e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"u-no-padding--top u-no-margin--bottom",children:"On a date"}),e.jsx("p",{className:g(w.description,"u-no-margin--bottom"),children:e.jsx("small",{children:"Run the script on a selected date"})})]}),value:"one_time",text:"On a date"},{label:e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"u-no-padding--top u-no-margin--bottom",children:"Recurring"}),e.jsx("p",{className:g(w.description,"u-no-margin--bottom"),children:e.jsx("small",{children:"Run the script on a recurring schedule"})})]}),value:"recurring",text:"Recurring"}],help:d.trigger_type&&"Trigger type can't be changed after the script is created."}),e.jsxs("div",{className:w.indent,children:[r.values.trigger_type=="one_time"&&e.jsx(s.Input,{type:"datetime-local",label:"Date",required:!0,min:B().utc(!0).format(I),...r.getFieldProps("timestamp"),error:f(r,"timestamp")}),r.values.trigger_type=="recurring"&&e.jsxs(e.Fragment,{children:[e.jsx(s.Input,{type:"datetime-local",label:"Start date",required:!0,min:B().utc(!0).format(I),...r.getFieldProps("start_after"),error:f(r,"start_after")}),e.jsxs(s.Notification,{severity:"caution",className:w.notification,children:["There is a minimum interval of"," ",e.jsxs("strong",{children:[m==null?void 0:m.min_interval," minutes"]})," ","between runs. Depending on the schedule, run times may be adjusted."]}),e.jsx(le,{required:!0,touched:r.touched.interval,...r.getFieldProps("interval")})]})]}),b&&e.jsxs(s.Notification,{severity:"negative",inline:!0,title:"Associated instances limit reached:",children:["You've reached the limit of"," ",e.jsxs("strong",{children:[m.max_num_computers," associated instances"]}),". Decrease the number of associated instances."]}),e.jsx(X,{formik:r}),e.jsx(ee,{submitButtonDisabled:h||b||C,submitButtonLoading:h,submitButtonText:o})]})};export{Le as default};
