import{r as f,j as a,a as H,k as R,v as $,C as E,t as v,h as k,R as M,s as P,W as B,G as D,g as w}from"./index-D53gOEt3.js";import{m as N}from"./moment-DmqamEue.js";import{E as C,S}from"./SelectAllButton-BaY48wd8.js";import{N as F}from"./NoData-DixGAiTj.js";import{T as L}from"./TablePagination-lNEL8fEQ.js";import{T as O}from"./TruncatedCell-CWIwWwWH.js";import{u as V}from"./usePageParams-DF60bjOP.js";import{u as I}from"./useUsns-DKGeZZGn.js";import{g as q,c as j,a as Q,h as _,b as T}from"./helpers-B4Ea794_.js";const W=({column:l})=>{const t={};return l.id==="title"?t.role="rowheader":l.id==="upgrades.security"&&(t["aria-label"]="Affected packages"),t},Y="_security_16o7z_1",z={security:Y},G=({instances:l,limit:t,onLimitChange:m,usn:o,usnPackages:i})=>{const n=f.useMemo(()=>l.filter(({id:e})=>i.flatMap(({computer_ids:p})=>p).includes(e)).slice(0,t),[l,t,i]),r=f.useMemo(()=>[{accessor:"title",Header:"Name"},{accessor:"upgrades.security",className:z.security,Header:"Affected packages",Cell:({row:{original:e}})=>i.filter(({computer_ids:p})=>p.includes(e.id)).length}],[n.length]);return a.jsx(C,{columns:r,data:n,itemNames:{plural:"instances",singular:"instance"},onLimitChange:m,totalCount:n.length,title:a.jsxs("p",{className:"p-heading--4",children:["Instances affected by ",a.jsx("b",{children:o})]}),getCellProps:W})},J=({instanceTitle:l,usn:t})=>{const m=H(),o=R(),{notify:i}=$(),{confirmModal:n,closeConfirmModal:r}=E(),{removeUsnPackagesQuery:e}=I(),{setPageParams:p}=V(),{instanceId:b,childInstanceId:g}=v(),u=Number(b),{mutateAsync:h}=e,y=()=>{m(`${M}instances/${g?`${u}/${g}`:`${u}`}`),p({tab:"activities"}),i.clear()},x=async()=>{try{await h({usns:t,instanceId:u}),i.success({title:"You queued packages to be uninstalled",message:`Packages affected by "${t}" security issue will be uninstalled and are queued in Activities.`,actions:[{label:"View details",onClick:y}]})}catch(c){o(c)}finally{r()}},s=()=>{n({title:"Uninstall USN packages",body:`This will uninstall packages affected by "${t}" security issue from the "${l}" instance.`,buttons:[a.jsx(k.Button,{type:"button",appearance:"negative",onClick:x,children:"Uninstall"},"remove")]})};return a.jsxs(k.Button,{type:"button",small:!0,dense:!0,hasIcon:!0,onClick:s,children:[a.jsx(k.Icon,{name:"delete",className:"u-no-margin--left"}),a.jsx("span",{children:"Uninstall packages"})]})},K=({column:l})=>{const t={};return l.id==="name"?t.role="rowheader":l.id==="current_version"?t["aria-label"]="Current version":l.id==="new_version"?t["aria-label"]="New version":l.id==="summary"&&(t["aria-label"]="Details"),t},U=({instanceTitle:l,limit:t,onLimitChange:m,showRemoveButton:o,usn:i,usnPackages:n})=>{const r=f.useMemo(()=>n.slice(0,t),[t,n]),e=f.useMemo(()=>[{accessor:"name",Header:"Package"},{accessor:"current_version",Header:"Current version"},{accessor:"new_version",Header:"New version"},{accessor:"summary",Header:"Details"}],[r.length]);return a.jsx(C,{additionalCta:o&&a.jsx(J,{instanceTitle:l,usn:i}),columns:e,data:r,itemNames:{plural:"packages",singular:"package"},onLimitChange:m,title:a.jsxs("p",{className:"p-heading--4",children:["Packages affected by ",a.jsx("b",{children:i})]}),totalCount:n.length,getCellProps:K})},X=({instances:l,isRemovable:t,listType:m,usn:o})=>{const[i,n]=f.useState(5),{getAffectedPackagesQuery:r}=I(),{instanceId:e}=v(),p=Number(e),{data:b,isLoading:g}=r({usn:o,computer_ids:t?[p]:l.map(({id:h})=>h)}),u=(b==null?void 0:b.data)??[];return a.jsxs(a.Fragment,{children:[g&&a.jsx(P,{}),!g&&m==="instances"&&a.jsx(G,{instances:l,limit:i,onLimitChange:()=>n(h=>h+5),usn:o,usnPackages:u}),!g&&m==="packages"&&a.jsx(U,{instanceTitle:l[0].title,limit:i,onLimitChange:()=>n(h=>h+5),showRemoveButton:t,usn:o,usnPackages:u})]})},re=({instances:l,isUsnsLoading:t,onSelectedUsnsChange:m,selectedUsns:o,totalUsnCount:i,usns:n,...r})=>{const[e,p]=f.useState(null),b=f.useRef([]);B({current:(e==null?void 0:e.column)==="cves"?b.current[e.row]:null},()=>p(null));const g=r.tableType==="expandable"&&r.showSelectAllButton,u=f.useMemo(()=>q({expandedCell:e,isUsnsLoading:t,showSelectAllButton:g,usns:n}),[n,e,t,g]),h=s=>{m(o.includes(s)?o.filter(c=>c!==s):[...o,s])},y=(s,c)=>{p(d=>(d==null?void 0:d.column)===s&&d.row===c?null:{column:s,row:d&&["computers_count","release_packages"].includes(d.column)&&d.row<c?c-1:c})},x=f.useMemo(()=>[{accessor:"checkbox",className:"checkbox-column",Header:()=>a.jsx(k.CheckboxInput,{inline:!0,label:a.jsx("span",{className:"u-off-screen",children:"Toggle all security issues"}),disabled:u.length===0||t,indeterminate:o.length>0&&o.length<n.length,checked:o.length>0&&o.length===n.length,onChange:()=>m(o.length>0?[]:n.map(({usn:s})=>s))}),Cell:({row:{original:s}})=>a.jsx(k.CheckboxInput,{labelClassName:"u-no-margin--bottom u-no-padding--top",label:a.jsx("span",{className:"u-off-screen",children:`Toggle ${s.usn}`}),disabled:t,name:"usn",checked:o.includes(s.usn),onChange:()=>h(s.usn)})},{accessor:"usn",Header:"USN",Cell:({row:{index:s,original:c}})=>s===0&&g?a.jsx(S,{count:r.totalSelectedUsnCount,itemName:{plural:"security issues",singular:"security issue"},onClick:r.onSelectAllClick,totalCount:i}):(e==null?void 0:e.row)===s-1&&["computers_count","release_packages"].includes(e.column)?a.jsx(X,{isRemovable:e.column==="release_packages"&&r.tableType==="paginated",instances:l,listType:e.column==="release_packages"?"packages":"instances",usn:u[e.row].usn}):t&&s===u.length-1?a.jsx(P,{}):a.jsx("a",{href:c.usn_link,target:"_blank",rel:"nofollow noopener noreferrer",children:c.usn})},{accessor:"cves",Header:"CVE(s)",Cell:({row:{original:s,index:c}})=>a.jsx(O,{content:s.cves.map(({cve:d,cve_link:A})=>a.jsx("span",{className:j.cve,children:a.jsx("a",{href:A,target:"_blank",rel:"nofollow noopener noreferrer",className:j.cveLink,children:d})},d)),isExpanded:(e==null?void 0:e.column)==="cves"&&e.row===c,onExpand:()=>y("cves",c)})},{accessor:"date",Header:"Date published",Cell:({row:s})=>a.jsx(a.Fragment,{children:N(s.original.date).isValid()?N(s.original.date).format(D):a.jsx(F,{})})},{accessor:"computers_count",Header:"Affected instances",Cell:({column:s,row:{index:c,original:d}})=>a.jsx(k.Button,{type:"button",className:w("p-accordion__tab",j.expandButton),"aria-expanded":(e==null?void 0:e.column)===s.id&&e.row===c,onClick:()=>y(s.id,c),children:d.computers_count})},{accessor:"release_packages",Header:"Affected packages",Cell:({column:s,row:{index:c}})=>a.jsx(k.Button,{type:"button",className:w("p-accordion__tab",j.expandButton),"aria-expanded":(e==null?void 0:e.column)===s.id&&e.row===c,onClick:()=>y(s.id,c),children:`${(e==null?void 0:e.column)===s.id&&e.row===c?"Hide":"Show"} packages`})}].filter(({accessor:s})=>r.tableType==="paginated"?s!=="computers_count":s!=="date"),[u,t,o.length,r.tableType,e]);return a.jsx("div",{ref:Q(b),children:r.tableType==="expandable"?a.jsx(C,{columns:x,data:u,getCellProps:_({expandedCell:e,isUsnsLoading:t,lastUsnIndex:u.length-1,showSelectAllButton:g}),getRowProps:T(e),itemCount:n.length,itemNames:{plural:"security issues",singular:"security issue"},onLimitChange:r.onNextPageFetch,totalCount:i}):a.jsxs(a.Fragment,{children:[a.jsx(k.ModularTable,{columns:x,data:u,getCellProps:_({expandedCell:e,isUsnsLoading:t}),getRowProps:T(e),emptyMsg:`No security issues found with the search "${r.search}"`}),n.length>0&&a.jsx(L,{handleClearSelection:()=>m([]),totalItems:i,currentItemCount:n.length})]})})};export{re as U};
