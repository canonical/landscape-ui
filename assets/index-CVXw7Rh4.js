import{b as I,i as R,f as _,g as q,h as k,v as b,I as L,x as h,ak as m,l as S,n as V,o as B,p as $,q as N,j as t,d as c,s as p,L as v,A as D,au as M}from"./index-CYddq1Dt.js";import{C as O}from"./CodeEditor-CMX2-5Un.js";import{S as H}from"./SidePanelFormButtons-y29iSwpX.js";import{u as K}from"./useEditScript-BzOQn6Q0.js";import{u as Q,D as Y,S as G}from"./ScriptFormAttachments-CP4BKfCm.js";import{e as U,h as z,i as J}from"./ScriptsTabs-D11am1mG.js";import"./index-B5TEWRbk.js";import"./SidePanelFormButtons.module-BuIu-Bem.js";import"./AttachmentFile-CPOI2Dg1.js";import"./constants-BvfXqWjy.js";import"./useRoles-CskDJFuI.js";import"./TextConfirmationModal-D1Pp81Mj.js";import"./HeaderWithSearch-LK3eyMPY.js";import"./SingleInstanceTabs.module-Cm1BYFZQ.js";const W=(e,o={enabled:!0})=>{const l=I(),{data:r,isPending:u}=R({queryKey:["scripts","profiles",e],queryFn:async()=>l.get(`scripts/${e}/script-profiles`),...o});return{associatedScriptProfiles:r?.data.results??[],isAssociatedScriptProfilesLoading:u}},X=()=>{const e=_(),o=q(),{mutateAsync:l,isPending:r}=k({mutationKey:["scripts","removeAttachment"],mutationFn:async u=>e.get("RemoveScriptAttachment",{params:u}),onSuccess:async()=>o.invalidateQueries({queryKey:["scripts"]})});return{removeScriptAttachment:l,isRemovingScriptAttachment:r}},Z="_modal_1lyuv_1",ee={modal:Z},te=()=>b().shape({title:h().required("This field is required"),code:h().required("This field is required"),attachments:b().shape({first:m().nullable(),second:m().nullable(),third:m().nullable(),fourth:m().nullable(),fifth:m().nullable()}),attachmentsToRemove:L().of(h())}),se=e=>({title:e.title,code:U({code:e.code,interpreter:e.interpreter}),time_limit:e.time_limit,username:e.username,attachments:{first:null,second:null,third:null,fourth:null,fifth:null},attachmentsToRemove:[]}),ae=e=>{const o=e.lastIndexOf(".");return o!==-1?e.slice(0,o):e},Se=({script:e})=>{const o=S.useRef(null),[l,r]=S.useState(!1),{closeSidePanel:u}=V(),x=B(),{notify:y}=$(),{createScriptAttachment:A}=Q(),{removeScriptAttachment:F}=X(),{editScript:j,isEditing:f}=K(),{associatedScriptProfiles:g,isAssociatedScriptProfilesLoading:C}=W(e.id,{enabled:l}),P=async s=>{const n=Object.values(s.attachments).filter(i=>i!==null);try{const i=[j(z({scriptId:e.id,values:s}))];if(s.attachmentsToRemove.length)for(const d of s.attachmentsToRemove)i.push(F({script_id:e.id,filename:d}));n.length&&i.push(...await J({attachments:n,createScriptAttachment:A,script_id:e.id})),await Promise.all(i),u(),r(!1),y.success({title:`You have successfully submitted a new version of ${e.title}`,message:"All its associated profiles will now be run using this new version."})}catch(i){r(!1),x(i)}},a=N({initialValues:se(e),validationSchema:te(),onSubmit:P}),w=async({target:{files:s}})=>{if(!s)return;const[n]=s,i=a.setFieldValue("code",await n.text());if(a.values.title){await i;return}await Promise.all([a.setFieldValue("title",ae(n.name)),i])},T=async s=>{await a.setFieldValue("code",s)},E=()=>o.current?.click();return t.jsxs(c.Form,{onSubmit:a.handleSubmit,noValidate:!0,children:[t.jsx(c.Input,{type:"text",label:"Title",required:!0,...a.getFieldProps("title"),error:p(a,"title")}),t.jsx("input",{ref:o,className:"u-hide",type:"file",onChange:w}),t.jsx(O,{label:"Code",value:a.values.code,onChange:T,error:p(a,"code"),required:!0,defaultValue:Y,headerContent:t.jsxs(c.Button,{className:"u-no-margin--bottom",appearance:"base",hasIcon:!0,onClick:E,type:"button",children:[t.jsx(c.Icon,{name:"upload"}),t.jsx("span",{children:"Populate from file"})]})}),t.jsxs(t.Fragment,{children:[t.jsx("h5",{children:"List of attachments"}),t.jsx("p",{className:"u-text--muted",children:"Attachments that will be sent along with the script. You can attach up to 5 files, for a maximum of 1.00MB. Filenames must be unique. On the client, the attachments will be placed in the directory whose name is accessible through the environment variable LANDSCAPE_ATTACHMENTS. They'll be deleted once the script has been run."})]}),t.jsx(G,{attachments:a.values.attachments,attachmentsToRemove:a.values.attachmentsToRemove,getFileInputError:s=>p(a,["attachments",s]),initialAttachments:e.attachments,onFileInputChange:s=>async n=>a.setFieldValue(`attachments.${s}`,n.target.files?.[0]??null),onInitialAttachmentDelete:async s=>a.setFieldValue("attachmentsToRemove",[...a.values.attachmentsToRemove,s]),scriptId:e.id}),t.jsx(H,{onSubmit:()=>{r(!0)},submitButtonText:"Submit new version"}),l&&t.jsx(c.ConfirmationModal,{title:`Submit new version of "${e.title}"`,confirmButtonLabel:"Submit new version",onConfirm:()=>{a.handleSubmit()},confirmButtonAppearance:"positive",confirmButtonDisabled:f,confirmButtonLoading:f,close:()=>{r(!1)},className:ee.modal,confirmButtonProps:{type:"button"},children:g.length>0?t.jsxs(t.Fragment,{children:[t.jsx("p",{children:"All future script runs will be done using the latest version of the code. Submitting these changes will affect the following profiles:"}),t.jsx(c.ModularTable,{columns:[{Header:"active profiles",accessor:"title",Cell:({row:s})=>t.jsx(v,{to:"/scripts?tab=profiles",state:{scriptProfileId:s.original.id},target:"_blank",children:s.original.title})},{Header:"associated instances",Cell:({row:s})=>{const n=g.find(d=>d.id===s.original.id),i=n?.computers.num_associated_computers;return C?t.jsx(D,{}):i?t.jsxs(v,{to:`/instances?tags=${n?.tags.join(",")}`,target:"_blank",children:[i," instance",i>1?"s":""]}):t.jsx(M,{})}}],data:e.script_profiles})]}):t.jsx("p",{children:"All future script runs will be done using the latest version of the code."})})]})};export{Se as default};
