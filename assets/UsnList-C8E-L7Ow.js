import{r as k,j as a,a as M,A as R,B as D,c as $,O as I,n as p,p as B,k as L,aq as j,D as S,N as F,o as v,an as V}from"./index-Cw5WBMVF.js";import{E as N,S as q}from"./SelectAllButton-B2fFhfw2.js";import{T as O}from"./TruncatedCell-C7F34y83.js";import{u as E}from"./useUsns-TbYd0R_s.js";const Y=({column:e})=>{const t={};return e.id==="title"?t.role="rowheader":e.id==="upgrades.security"&&(t["aria-label"]="Affected packages"),t},Q="_security_16o7z_1",z={security:Q},W=({instances:e,limit:t,onLimitChange:l,usn:i,usnPackages:o})=>{const r=k.useMemo(()=>e.filter(({id:s})=>o.flatMap(({computer_ids:f})=>f).includes(s)).slice(0,t),[e,t,o]),c=k.useMemo(()=>[{accessor:"title",Header:"Name"},{accessor:"upgrades.security",className:z.security,Header:"Affected packages",Cell:({row:{original:s}})=>o.filter(({computer_ids:f})=>f.includes(s.id)).length}],[r.length]);return a.jsx(N,{columns:c,data:r,itemNames:{plural:"instances",singular:"instance"},onLimitChange:l,totalCount:r.length,title:a.jsxs("p",{className:"p-heading--4",children:["Instances affected by ",a.jsx("b",{children:i})]}),getCellProps:Y})},G=({instanceTitle:e,usn:t})=>{const l=M(),i=R(),{notify:o}=D(),{removeUsnPackagesQuery:r}=E(),{setPageParams:c}=$(),{instanceId:s,childInstanceId:f}=I(),h=Number(s),{mutateAsync:b,isPending:m}=r,d=()=>{l(`/instances/${f?`${h}/${f}`:`${h}`}`),c({tab:"activities"}),o.clear()},w=async()=>{try{await b({usns:t,instanceId:h}),o.success({title:"You queued packages to be uninstalled",message:`Packages affected by "${t}" security issue will be uninstalled and are queued in Activities.`,actions:[{label:"View details",onClick:d}]})}catch(y){i(y)}};return a.jsxs(p.ConfirmationButton,{type:"button",className:"is-small is-dense has-icon",confirmationModalProps:{title:"Uninstall USN packages",children:a.jsxs("p",{children:['This will uninstall packages affected by "',t,'" security issue from the "',e,'" instance.']}),confirmButtonLabel:"Uninstall",confirmButtonAppearance:"negative",confirmButtonDisabled:m,confirmButtonLoading:m,onConfirm:w},children:[a.jsx(p.Icon,{name:"delete",className:"u-no-margin--left"}),a.jsx("span",{children:"Uninstall packages"})]},"remove")},J=({column:e})=>{const t={};return e.id==="name"?t.role="rowheader":e.id==="current_version"?t["aria-label"]="Current version":e.id==="new_version"?t["aria-label"]="New version":e.id==="summary"&&(t["aria-label"]="Details"),t},K=({instanceTitle:e,limit:t,onLimitChange:l,showRemoveButton:i,usn:o,usnPackages:r})=>{const c=k.useMemo(()=>r.slice(0,t),[t,r]),s=k.useMemo(()=>[{accessor:"name",Header:"Package"},{accessor:"current_version",Header:"Current version"},{accessor:"new_version",Header:"New version"},{accessor:"summary",Header:"Details"}],[c.length]);return a.jsx(N,{additionalCta:i&&a.jsx(G,{instanceTitle:e,usn:o}),columns:s,data:c,itemNames:{plural:"packages",singular:"package"},onLimitChange:l,title:a.jsxs("p",{className:"p-heading--4",children:["Packages affected by ",a.jsx("b",{children:o})]}),totalCount:r.length,getCellProps:J})},U=({instances:e,isRemovable:t,listType:l,usn:i})=>{const[o,r]=k.useState(5),{getAffectedPackagesQuery:c}=E(),{instanceId:s}=I(),f=Number(s),{data:h,isLoading:b}=c({usn:i,computer_ids:t?[f]:e.map(({id:d})=>d)}),m=(h==null?void 0:h.data)??[];return a.jsxs(a.Fragment,{children:[b&&a.jsx(B,{}),!b&&l==="instances"&&a.jsx(W,{instances:e,limit:o,onLimitChange:()=>r(d=>d+5),usn:i,usnPackages:m}),!b&&l==="packages"&&a.jsx(K,{instanceTitle:e[0].title,limit:o,onLimitChange:()=>r(d=>d+5),showRemoveButton:t,usn:i,usnPackages:m})]})},T={computers_count:0,cves:[],date:"",info:"",packages:[],usn:"",usn_link:""},X="_expanded_196be_1",Z="_expandButton_196be_19",x="_hidden_196be_28",C="_innerTable_196be_32",ee="_row_196be_36",se="_cve_196be_42",te="_cveLink_196be_46",_={expanded:X,expandButton:Z,hidden:x,innerTable:C,row:ee,cve:se,cveLink:te},ae=({expandedCell:e,isUsnsLoading:t,showSelectAllButton:l,usns:i})=>{const o=(e==null?void 0:e.column)==="computers_count"||(e==null?void 0:e.column)==="release_packages"?e.row+1:0;return[...[T].slice(l?0:1),...i.slice(0,o||i.length),...i.slice(o?o-1:i.length),...[T].slice(t?0:1)]},P=({expandedCell:e,isUsnsLoading:t,lastUsnIndex:l,showSelectAllButton:i})=>({column:o,row:{index:r}})=>{const c={};return i&&r===0||t&&r===l||(e==null?void 0:e.row)===r-1&&["computers_count","release_packages"].includes(e.column)?o.id==="usn"?(c.colSpan=5,(e==null?void 0:e.row)===r-1&&["computers_count","release_packages"].includes(e.column)&&(c.className=_.innerTable)):(c.className=_.hidden,c["aria-hidden"]=!0):o.id==="usn"?c.role="rowheader":o.id==="cves"?(c["aria-label"]="CVE(s)",(e==null?void 0:e.column)===o.id&&e.row===r&&(c.className="expandedCell")):o.id==="date"?c["aria-label"]="Date published":o.id==="computers_count"?(c["aria-label"]="Affected instances",c.className=(e==null?void 0:e.column)===o.id&&e.row===r?_.expanded:_.row):o.id==="release_packages"&&(c["aria-label"]="Affected packages",c.className=(e==null?void 0:e.column)===o.id&&e.row===r?_.expanded:_.row),c},A=e=>({index:t})=>{const l={};return(e==null?void 0:e.column)==="cves"&&e.row===t&&(l.className="expandedRow"),l},ce=e=>t=>{t&&(e.current=[...t.querySelectorAll("tbody tr")])},le=({instances:e,isUsnsLoading:t,onSelectedUsnsChange:l,selectedUsns:i,totalUsnCount:o,usns:r,...c})=>{const[s,f]=k.useState(null),h=k.useRef([]);L({current:(s==null?void 0:s.column)==="cves"?h.current[s.row]:null},()=>{f(null)});const b=c.tableType==="expandable"&&c.showSelectAllButton,m=k.useMemo(()=>ae({expandedCell:s,isUsnsLoading:t,showSelectAllButton:b,usns:r}),[r,s,t,b]),d=n=>{l(i.includes(n)?i.filter(u=>u!==n):[...i,n])},w=(n,u)=>{f(g=>(g==null?void 0:g.column)===n&&g.row===u?null:{column:n,row:g&&["computers_count","release_packages"].includes(g.column)&&g.row<u?u-1:u})},y=k.useMemo(()=>[{accessor:"checkbox",className:"checkbox-column",Header:()=>a.jsx(p.CheckboxInput,{inline:!0,label:a.jsx("span",{className:"u-off-screen",children:"Toggle all security issues"}),disabled:m.length===0||t,indeterminate:i.length>0&&i.length<r.length,checked:i.length>0&&i.length===r.length,onChange:()=>{l(i.length>0?[]:r.map(({usn:n})=>n))}}),Cell:({row:{original:n}})=>a.jsx(p.CheckboxInput,{labelClassName:"u-no-margin--bottom u-no-padding--top",label:a.jsx("span",{className:"u-off-screen",children:`Toggle ${n.usn}`}),disabled:t,name:"usn",checked:i.includes(n.usn),onChange:()=>{d(n.usn)}})},{accessor:"usn",Header:"USN",Cell:({row:{index:n,original:u}})=>n===0&&b?a.jsx(q,{count:c.totalSelectedUsnCount,itemName:{plural:"security issues",singular:"security issue"},onClick:c.onSelectAllClick,totalCount:o}):(s==null?void 0:s.row)===n-1&&["computers_count","release_packages"].includes(s.column)?a.jsx(U,{isRemovable:s.column==="release_packages"&&c.tableType==="paginated",instances:e,listType:s.column==="release_packages"?"packages":"instances",usn:m[s.row].usn}):t&&n===m.length-1?a.jsx(B,{}):a.jsx("a",{href:u.usn_link,target:"_blank",rel:"nofollow noopener noreferrer",children:u.usn})},{accessor:"cves",Header:"CVE(s)",Cell:({row:{original:n,index:u}})=>a.jsx(O,{content:n.cves.map(({cve:g,cve_link:H})=>a.jsx("span",{className:_.cve,children:a.jsx("a",{href:H,target:"_blank",rel:"nofollow noopener noreferrer",className:_.cveLink,children:g})},g)),isExpanded:(s==null?void 0:s.column)==="cves"&&s.row===u,onExpand:()=>{w("cves",u)}})},{accessor:"date",Header:"Date published",Cell:({row:n})=>a.jsx(a.Fragment,{children:j(n.original.date).isValid()?j(n.original.date).format(S):a.jsx(F,{})})},{accessor:"computers_count",Header:"Affected instances",Cell:({column:n,row:{index:u,original:g}})=>a.jsx(p.Button,{type:"button",className:v("p-accordion__tab",_.expandButton),"aria-expanded":(s==null?void 0:s.column)===n.id&&s.row===u,onClick:()=>{w(n.id,u)},children:g.computers_count})},{accessor:"release_packages",Header:"Affected packages",Cell:({column:n,row:{index:u}})=>a.jsx(p.Button,{type:"button",className:v("p-accordion__tab",_.expandButton),"aria-expanded":(s==null?void 0:s.column)===n.id&&s.row===u,onClick:()=>{w(n.id,u)},children:`${(s==null?void 0:s.column)===n.id&&s.row===u?"Hide":"Show"} packages`})}].filter(({accessor:n})=>c.tableType==="paginated"?n!=="computers_count":n!=="date"),[m,t,i.length,c.tableType,s]);return a.jsx("div",{ref:ce(h),children:c.tableType==="expandable"?a.jsx(N,{columns:y,data:m,getCellProps:P({expandedCell:s,isUsnsLoading:t,lastUsnIndex:m.length-1,showSelectAllButton:b}),getRowProps:A(s),itemCount:r.length,itemNames:{plural:"security issues",singular:"security issue"},onLimitChange:c.onNextPageFetch,totalCount:o}):a.jsxs(a.Fragment,{children:[a.jsx(p.ModularTable,{columns:y,data:m,getCellProps:P({expandedCell:s,isUsnsLoading:t}),getRowProps:A(s),emptyMsg:`No security issues found with the search "${c.search}"`}),r.length>0&&a.jsx(V,{handleClearSelection:()=>{l([])},totalItems:o,currentItemCount:r.length})]})})};export{le as U};
