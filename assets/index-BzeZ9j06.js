import{r as i,j as e,g as v,e as n,x as F,c as Y,E as se,_ as G,l as ne,d as ae}from"./index-DoU7Rqsb.js";import{a as J,u as oe}from"./useOnClickOutside-DB2oaqn7.js";import{u as k}from"./useInstances-DXIHt5sk.js";import{a as X,c as ie,d as re}from"./index.esm-DZ6m6u_n.js";import{c as le}from"./PageMain-BPmAIdVO.js";import{I as ce}from"./InfoItem-CJkV3SxW.js";import{u as de}from"./useConfirm-_4TVG935.js";import{u as ue}from"./useRoles-Bz2LFhzg.js";import{u as me}from"./useWsl-C-0o055o.js";import{u as pe}from"./formik.esm-BnMMHjVz.js";import{h as M}from"./moment-Cl4UOzQZ.js";import{m as Q}from"./moment-CCQDuzMq.js";import"./useFetchOld-BmpLm9Xc.js";import"./useMutation-BBuufY01.js";import"./useQuery-BiLCfR8g.js";const he=typeof window>"u";function fe(t={}){let{initializeWithValue:s=!0}=t;he&&(s=!1);const[r,c]=i.useState(()=>{if(s)return{width:window.innerWidth,height:window.innerHeight}}),d=()=>{c({width:window.innerWidth,height:window.innerHeight})};return J("resize",d),le(()=>{d()},[]),r}const _e="_infoContainer_1ca11_1",ge="_amount_1ca11_9",U={infoContainer:_e,amount:ge},xe=({isExpanded:t,overflowingChipsAmount:s})=>s>0&&!t&&e.jsx("div",{className:U.infoContainer,children:e.jsx("span",{className:v("u-text--muted",U.amount),children:`+${s}`})}),be=({containerRef:t,onDismiss:s,onOverflowingItemsAmountChange:r,tagData:c})=>{const d=()=>{if(!t.current)return;const o=t.current.querySelectorAll("span.p-chip");r(Array.from(o).filter(({offsetHeight:h,offsetTop:u})=>u>h).length)};return J("resize",d),i.useEffect(()=>{d()},[c.length]),c.map(o=>e.jsx(n.Chip,{value:o,onDismiss:()=>s(o)},o))},je="_container_1f6mu_1",ve="_list_1f6mu_6",Ie="_listItem_1f6mu_11",we="_search_1f6mu_17",A={container:je,list:ve,listItem:Ie,search:we},ye=({onTagClick:t,tags:s})=>s.length?e.jsxs("div",{className:A.container,children:[e.jsx("p",{className:"p-text--small-caps u-text--muted p-text--small",children:"Tags"}),e.jsx("ul",{className:v("p-list--divided u-no-margin--bottom",A.list),children:s.map(r=>e.jsx("li",{children:e.jsx("div",{className:A.listItem,children:e.jsx(n.Button,{appearance:"base",className:A.search,onClick:()=>t(r),children:r})})},r))})]}):null,Ce="_container_fqj7b_1",Se="_prompt_fqj7b_10",Ne="_saveButton_fqj7b_17",P={container:Ce,prompt:Se,saveButton:Ne},Re=({onTagAdd:t,search:s})=>e.jsx(e.Fragment,{children:s&&e.jsxs("div",{className:P.container,children:[e.jsxs("span",{className:P.prompt,children:[e.jsx("span",{children:"Search for "}),e.jsx("span",{className:"p-search-and-filter__search-query",children:s}),e.jsx("span",{children:"..."})]}),e.jsx(n.Button,{type:"button",appearance:"link",onClick:t,className:P.saveButton,children:"Add tag"})]})}),Z=X().matches(/^[a-zA-Z]/,{message:"Tag must starts with a letter",excludeEmptyString:!0}).matches(/^[a-zA-Z][a-zA-Z0-9_-]*$/,{message:"Tag can only contain letters, numbers, hyphens, and underscores",excludeEmptyString:!0}),Ee="_searchContainer_pn88d_1",Ae="_box_pn88d_5",Te="_inputContainer_pn88d_10",ke="_inputError_pn88d_15",T={searchContainer:Ee,box:Ae,inputContainer:Te,inputError:ke},De=({onTagsChange:t,tags:s,label:r,labelClassName:c,required:d})=>{var H;const[o,h]=i.useState(""),[u,f]=i.useState(""),[m,j]=i.useState(!1),[x,y]=i.useState(""),[g,I]=i.useState(!1),[D,C]=i.useState(0),{height:S}=fe(),[z,N]=i.useState({top:"100%",bottom:"auto"}),{getAllInstanceTagsQuery:L}=k(),R=i.useRef(null),p=i.useRef(null);i.useEffect(()=>{if(!p.current)return;const a=p.current.querySelector("input");a&&y(a.id)},[p.current]),i.useEffect(()=>{!g||!p.current||B()},[S,g,p.current,(H=p.current)==null?void 0:H.clientHeight]);const B=()=>{if(!p.current)return;const{top:a,height:_}=p.current.getBoundingClientRect();a+_+379<S?N({top:"100%",bottom:"auto"}):N({top:"auto",bottom:"100%"})},E=()=>{I(!1)};oe(R,E);const $=a=>{t(s.filter(_=>_!==a))},{data:w,isLoading:l}=L(),O=i.useMemo(()=>w?!o&&!s.length?w.data.results:w.data.results.filter(a=>!s.includes(a)).filter(a=>a.toLowerCase().includes(o.trim().toLowerCase())):[],[w,o,s]),q=a=>{t([...s,a])},W=()=>{if(o.trim())try{const a=Z.validateSync(o.trim())??"";q(a),h(""),f(""),j(!1)}catch(a){a instanceof Error&&(f(a.message),j(!0))}},ee=a=>{if(h(a.target.value),m)try{Z.validateSync(a.target.value),f("")}catch(_){_ instanceof Error&&f(_.message)}},te=a=>{const{key:_}=a;g?(_==="Escape"&&E(),_==="Enter"&&W()):_==="Enter"&&I(!0)};return e.jsxs("div",{children:[e.jsx("label",{className:v("p-form__label",{"is-required":d},c),htmlFor:x,children:r||"Tags"}),e.jsxs("div",{className:"p-search-and-filter",ref:R,children:[e.jsxs("div",{className:v("p-search-and-filter__search-container",T.searchContainer),"aria-expanded":g,ref:p,onClick:()=>I(!0),children:[e.jsx(be,{containerRef:p,onDismiss:$,onOverflowingItemsAmountChange:a=>C(a),tagData:s}),e.jsx("div",{className:v("p-search-and-filter__box",T.box),children:e.jsx("div",{className:T.inputContainer,children:e.jsx(n.Input,{type:"text",autoComplete:"off",value:o,onChange:ee,placeholder:"Add tags",className:"u-no-margin--bottom",onClick:()=>I(!0),onKeyUp:te,wrapperClassName:u?"is-error":"","aria-errormessage":u?`${x}-error`:void 0,"aria-invalid":!!u})})}),u&&e.jsx("div",{className:"is-error",children:e.jsxs("p",{className:v("p-form-validation__message",T.inputError),id:`${x}-error`,children:[e.jsx("strong",{children:"Error: "}),e.jsx("span",{children:u})]})}),e.jsx(xe,{isExpanded:g,overflowingChipsAmount:D})]}),g&&l&&e.jsx(F,{}),g&&!l&&e.jsxs("div",{className:"p-search-and-filter__panel",style:z,children:[e.jsx(Re,{onTagAdd:W,search:o}),e.jsx(ye,{onTagClick:q,tags:O})]})]})]})},ze={deliver_after:"",deliverImmediately:!0},Le=ie().shape({deliver_after:X().when("deliverImmediately",{is:!1,then:t=>t.required("This field is required").test({message:"Invalid date",test:s=>M(s).isValid()}).test({message:"Date must be in the future",test:s=>M(s).isAfter()})}),deliverImmediately:re()}),V={shutdown:{ctaLabel:"Shutdown",getDescription:t=>`This will shut down "${t}" instance.`,title:"Shut down instance"},reboot:{ctaLabel:"Restart",getDescription:t=>`This will restart "${t}" instance.`,title:"Restart instance"}},Be="_wrapper_30z1x_1",$e="_input_30z1x_5",K={wrapper:Be,input:$e},Oe=({action:t,instance:s,onClose:r})=>{const c=Y(),{rebootInstancesQuery:d,shutdownInstancesQuery:o}=k(),{mutateAsync:h}=d,{mutateAsync:u}=o,m=pe({initialValues:ze,onSubmit:async j=>{const x={computer_ids:[s.id],deliver_after:j.deliverImmediately?void 0:`${j.deliver_after}:00Z`};try{t==="reboot"?await h(x):await u(x)}catch(y){c(y)}finally{r()}},validationSchema:Le});return e.jsx(n.Form,{onSubmit:m.handleSubmit,noValidate:!0,children:e.jsx(n.Modal,{title:V[t].title,close:r,buttonRow:e.jsx(n.Button,{type:"submit",appearance:"negative",disabled:m.isSubmitting,children:V[t].ctaLabel}),children:e.jsxs("div",{className:K.wrapper,children:[e.jsx(n.CheckboxInput,{label:"Deliver as soon as possible",...m.getFieldProps("deliverImmediately"),checked:m.values.deliverImmediately}),e.jsx(n.Input,{type:"datetime-local",label:"Schedule time",labelClassName:"u-off-screen",className:K.input,placeholder:"Scheduled time",...m.getFieldProps("deliver_after"),disabled:m.values.deliverImmediately,error:m.touched.deliver_after&&m.errors.deliver_after?m.errors.deliver_after:void 0}),e.jsx("p",{children:V[t].getDescription(s.title)})]})})})},Pe=(t,s)=>{var r,c,d;return[{label:"Last ping time",value:t.last_ping_time&&Q(t.last_ping_time).isValid()?Q(t.last_ping_time).format(se):"---"},{label:"Hostname",value:t.hostname},{label:"instance ID",value:t.id},{label:"Serial number",value:((r=t.grouped_hardware)==null?void 0:r.system.serial)??"---"},{label:"Product identifier",value:((c=t.grouped_hardware)==null?void 0:c.system.model)??"---"},{label:"Distribution",value:t.distribution??"Unknown"},{label:"Access group",value:((d=s.find(({value:o})=>o===t.access_group))==null?void 0:d.label)||t.access_group},{label:"Annotations",value:t.annotations?Object.entries(t.annotations).map(([o,h],u,f)=>e.jsxs(e.Fragment,{children:[e.jsx("span",{children:`${o}: ${h}`}),u<f.length-1&&e.jsx("br",{})]})):"---"},{label:"Comment",value:t.comment||"---"}]},Ve="_titleRow_fznp8_1",Fe="_flexContainer_fznp8_6",qe="_italic_fznp8_11",We="_infoRow_fznp8_15",He="_tagSection_fznp8_20",Me="_tagsRow_fznp8_25",Qe="_tagsButton_fznp8_33",b={titleRow:Ve,flexContainer:Fe,italic:qe,infoRow:We,tagSection:He,tagsRow:Me,tagsButton:Qe},Ue=i.lazy(()=>G(()=>import("./index-DL-3HOK4.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12]))),Ze=i.lazy(()=>G(()=>import("./index-iQsMJvyn.js").then(t=>t.i),__vite__mapDeps([13,1,2,14,15,16,17,3,8,5,6,7,12,9,10,11,18,19,20]))),Ke=({instance:t})=>{const[s,r]=i.useState(null),[c,d]=i.useState(t.tags),o=Y(),{notify:h}=ne(),{confirmModal:u,closeConfirmModal:f}=de(),{setSidePanelContent:m}=ae(),{removeInstancesQuery:j}=k(),{getAccessGroupQuery:x}=ue(),{deleteChildInstancesQuery:y}=me(),{editInstanceQuery:g}=k(),{mutateAsync:I}=g,D=async()=>{try{await I({instanceId:t.id,tags:c}),h.success({title:"Tags updated",message:`"${t.title}" instance tags have been updated successfully`})}catch(l){o(l)}},{data:C}=x(),S=(C==null?void 0:C.data.map(({name:l,title:O})=>({label:O,value:l})))??[],{mutateAsync:z,isLoading:N}=j,L=async()=>{try{await z({computer_ids:[t.id]})}catch(l){o(l)}finally{f()}},R=()=>{u({title:`Remove ${t.title}`,body:"Removing this instance will delete all associated data and free up one license slot for another instance to be registered.",buttons:[e.jsx(n.Button,{appearance:"negative",onClick:L,children:"Remove"},"remove")]})},p=()=>{m("Edit Instance",e.jsx(i.Suspense,{fallback:e.jsx(F,{}),children:e.jsx(Ue,{instance:t})}))},B=()=>{m("Run script",e.jsx(i.Suspense,{fallback:e.jsx(F,{}),children:e.jsx(Ze,{query:`id:${t.id}`})}))},{mutateAsync:E}=y,$=async()=>{try{await E({computer_ids:[t.id]})}catch(l){o(l)}finally{f()}},w=async()=>{u({title:`Delete ${t.title}`,body:"This will remove selected WSL instance from the host and Landscape",buttons:[e.jsx(n.Button,{appearance:"negative",onClick:$,children:"Uninstall"},"delete")]})};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:b.titleRow,children:[e.jsxs("div",{className:b.flexContainer,children:[e.jsx("p",{className:"p-heading--4 u-no-padding--top u-no-margin--bottom",children:t.title}),t.is_wsl_instance&&e.jsx("p",{className:v("u-text--muted u-no-margin--bottom",b.italic),children:"WSL Instance"})]}),e.jsxs("div",{className:b.flexContainer,children:[t.is_wsl_instance&&e.jsx(n.Button,{type:"button",className:"u-no-margin--bottom u-no-margin--right",onClick:w,children:"Uninstall WSL Instance"}),e.jsx("div",{className:"p-segmented-control",children:e.jsxs("div",{className:"p-segmented-control__list",children:[e.jsxs(n.Button,{className:"p-segmented-control__button u-no-margin--bottom",type:"button",onClick:p,children:[e.jsx(n.Icon,{name:"edit"}),e.jsx("span",{children:"Edit"})]}),e.jsxs(n.Button,{className:"p-segmented-control__button u-no-margin--bottom",type:"button",onClick:B,children:[e.jsx(n.Icon,{name:"code"}),e.jsx("span",{children:"Run script"})]}),e.jsxs(n.Button,{className:"p-segmented-control__button u-no-margin--bottom",type:"button",onClick:R,disabled:N,children:[e.jsx(n.Icon,{name:"delete"}),e.jsx("span",{children:"Remove"})]}),e.jsxs(n.Button,{className:"p-segmented-control__button u-no-margin--bottom",type:"button",onClick:()=>r("reboot"),children:[e.jsx(n.Icon,{name:"restart"}),e.jsx("span",{children:"Restart"})]}),e.jsxs(n.Button,{className:"p-segmented-control__button u-no-margin--bottom",type:"button",onClick:()=>r("shutdown"),children:[e.jsx(n.Icon,{name:"power-off"}),e.jsx("span",{children:"Shutdown"})]})]})},"buttons")]})]}),e.jsx("div",{className:b.infoRow,children:e.jsx(n.Row,{className:"u-no-padding--left u-no-padding--right u-no-max-width",children:Pe(t,S).map(l=>e.jsx(n.Col,{size:4,children:e.jsx(ce,{...l})},l.label))})}),e.jsx("div",{className:b.tagSection,children:e.jsxs(n.Row,{className:b.tagsRow,children:[e.jsx(n.Col,{size:4,children:e.jsx(De,{labelClassName:"p-text--small p-text--small-caps u-text--muted",onTagsChange:l=>d(l),tags:c})}),e.jsx(n.Col,{size:2,className:b.tagsButton,children:e.jsx(n.Button,{type:"button",className:"u-no-margin--bottom",onClick:D,children:"Update"})})]})}),s&&e.jsx(Oe,{action:s,instance:t,onClose:()=>r(null)})]})},mt=Ke;export{mt as default};
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = ["assets/index-DL-3HOK4.js","assets/index-DoU7Rqsb.js","assets/index-57O3pXzM.css","assets/formik.esm-BnMMHjVz.js","assets/useInstances-DXIHt5sk.js","assets/useFetchOld-BmpLm9Xc.js","assets/useMutation-BBuufY01.js","assets/useQuery-BiLCfR8g.js","assets/index.esm-DZ6m6u_n.js","assets/SidePanelFormButtons-Mpz29jd4.js","assets/SidePanelFormButtons.module-CoxOjuX8.js","assets/SidePanelFormButtons-CR46v8uL.css","assets/useRoles-Bz2LFhzg.js","assets/index-iQsMJvyn.js","assets/index-zxO8ufmp.js","assets/useConfirm-_4TVG935.js","assets/EmptyState-CYOTcwI0.js","assets/EmptyState-BNXajmMK.css","assets/index-CRBxSwZU.css","assets/moment-Cl4UOzQZ.js","assets/index-DBZN6KOy.css"]
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
