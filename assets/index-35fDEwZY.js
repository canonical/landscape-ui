const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-BAp2SXUO.js","assets/index-DHbl-CCi.js","assets/index-tBQFzVrl.css","assets/SidePanelFormButtons-NGTDJtpv.js","assets/SidePanelFormButtons.module-D2P5PizG.js","assets/SidePanelFormButtons-JM1G8Sq6.css","assets/MultiSelectField-B3yKIE4v.js","assets/MultiSelectField-GyNA33om.css","assets/helpers-DQbx2X1u.js","assets/HeaderWithSearch-cWh3cSzk.js","assets/HeaderWithSearch-C2lwo0VI.css","assets/output-DFRNcfG-.js","assets/index-P1Vwdrdf.js"])))=>i.map(i=>d[i]);
import{c as E,r as b,i as se,f as te,g as j,h as B,K as Q,y as H,l as F,A as oe,F as ne,H as f,O as re,j as e,m as i,z as ae,n as w,o as v,_ as $,aj as ie,d as O,ab as A,N as ce,ak as ue,E as le,L as de,al as me}from"./index-DHbl-CCi.js";import{S as pe}from"./SidePanelFormButtons-NGTDJtpv.js";import{g as he,r as q,U as G,a as ge}from"./helpers-DQbx2X1u.js";import{H as be}from"./HeaderWithSearch-cWh3cSzk.js";import{g as ye}from"./output-DFRNcfG-.js";const L=5e3;function xe({data:s,sortFunctions:n}){const{sortBy:a,sort:l}=E();return b.useMemo(()=>{const d=n[a];return!a||!l||!d?s:s.toSorted((m,p)=>{const h=d(m,p);return l==="asc"?h:-h})},[s,a,l,n])}function T(){const s=se(),n=te(),a=(t,g={})=>B({queryKey:["users",{...t}],queryFn:async()=>s.get("users",{params:t}),...g}),l=j({mutationKey:["users","new"],mutationFn:async t=>s.post("users",t),onSuccess:async()=>n.invalidateQueries({queryKey:["users"]})}),d=j({mutationKey:["users","edit"],mutationFn:async t=>s.put("users",t),onSuccess:async()=>n.invalidateQueries({queryKey:["users"]})}),m=j({mutationKey:["users","remove"],mutationFn:async t=>s.delete("users",{params:t}),onSuccess:async()=>n.invalidateQueries({queryKey:["users"]})}),p=j({mutationKey:["users","lock"],mutationFn:async t=>s.post("users/lock",t),onSuccess:async()=>n.invalidateQueries({queryKey:["users"]})}),h=j({mutationKey:["users","unlock"],mutationFn:async t=>s.post("users/unlock",t),onSuccess:async()=>n.invalidateQueries({queryKey:["users"]})}),y=(t,g={})=>B({queryKey:["groups",(t==null?void 0:t.computer_id)??""],queryFn:async()=>{if(!t)throw new Error("Missing required parameters");return s.get(`computers/${t.computer_id}/groups`)},...g}),x=(t,g={})=>B({queryKey:["userGroups",(t==null?void 0:t.computer_id)??"",(t==null?void 0:t.username)??""],queryFn:async()=>{if(!t)throw new Error("Missing required parameters");return s.get(`computers/${t.computer_id}/users/${t.username}/groups`)},...g}),u=j({mutationKey:["groups","add"],mutationFn:async t=>s.post(`computers/${t.computer_id}/usergroups/update_bulk`,t),onSuccess:async()=>n.invalidateQueries({queryKey:["users"]})}),o=j({mutationKey:["groups","remove"],mutationFn:async t=>s.post(`computers/${t.computer_id}/usergroups/update_bulk`,t),onSuccess:async()=>n.invalidateQueries({queryKey:["users"]})});return{getUsersQuery:a,getGroupsQuery:y,getUserGroupsQuery:x,createUserQuery:l,removeUserQuery:m,editUserQuery:d,lockUserQuery:p,unlockUserQuery:h,addUserToGroupQuery:u,removeUserFromGroupQuery:o}}const fe="_actions_1l3g0_1",ke={actions:fe},R=()=>{const{instanceId:s}=Q(),n=H(),{closeSidePanel:a}=F(),{createUserQuery:l,getGroupsQuery:d}=T(),m=Number(s),{mutateAsync:p}=l,{data:h,isLoading:y}=d({computer_id:m}),u=((h==null?void 0:h.data.groups)??[]).map(t=>({label:t.name,value:t.name})),o=oe({initialValues:{name:"",username:"",password:"",confirmPassword:"",requirePasswordReset:!1,location:"",homePhoneNumber:"",workPhoneNumber:"",primaryGroupValue:""},validationSchema:ne().shape({name:f().required("This field is required"),username:f().required("This field is required"),password:f().required("This field is required"),confirmPassword:f().required("This field is required").oneOf([re("password"),""],"Passwords must match"),location:f(),homePhoneNumber:f(),workPhoneNumber:f(),primaryGroupValue:f().required("This field is required")}),onSubmit:async t=>{try{await p({computer_ids:[m],name:t.name,username:t.username,password:t.password,require_password_reset:t.requirePasswordReset,location:t.location,home_phone:t.homePhoneNumber,work_phone:t.workPhoneNumber,primary_groupname:t.primaryGroupValue}),a()}catch(g){n(g)}}});return e.jsxs(i.Form,{noValidate:!0,onSubmit:o.handleSubmit,name:"add-new-user",children:[e.jsx(i.Input,{type:"text",label:"Username",autoComplete:"new-username",required:!0,error:o.touched.username&&o.errors.username?o.errors.username:void 0,...o.getFieldProps("username")}),e.jsx(i.Input,{type:"text",label:"Name",required:!0,error:o.touched.name&&o.errors.name?o.errors.name:void 0,...o.getFieldProps("name")}),e.jsx(i.Input,{type:"password",label:"Passphrase",autoComplete:"new-password",required:!0,error:o.touched.password&&o.errors.password?o.errors.password:void 0,...o.getFieldProps("password")}),e.jsx(i.Input,{type:"password",label:"Confirm passphrase",autoComplete:"new-password",required:!0,error:o.touched.confirmPassword&&o.errors.confirmPassword?o.errors.confirmPassword:void 0,...o.getFieldProps("confirmPassword")}),e.jsx(i.Input,{type:"checkbox",label:"Require passphrase reset",help:"User must change password at first login",...o.getFieldProps("requirePasswordReset"),checked:o.values.requirePasswordReset}),e.jsx(i.Select,{label:"Primary Group",disabled:y,options:[{label:"Select",value:""},...u],...o.getFieldProps("primaryGroupValue"),error:o.touched.primaryGroupValue&&o.errors.primaryGroupValue?o.errors.primaryGroupValue:void 0}),e.jsx(i.Input,{type:"text",label:"Location",error:o.touched.location&&o.errors.location?o.errors.location:void 0,...o.getFieldProps("location")}),e.jsx(i.Input,{type:"text",label:"Home phone",error:o.touched.homePhoneNumber&&o.errors.homePhoneNumber?o.errors.homePhoneNumber:void 0,...o.getFieldProps("homePhoneNumber")}),e.jsx(i.Input,{type:"text",label:"Work phone",error:o.touched.workPhoneNumber&&o.errors.workPhoneNumber?o.errors.workPhoneNumber:void 0,...o.getFieldProps("workPhoneNumber")}),e.jsx(pe,{submitButtonDisabled:o.isSubmitting,submitButtonText:"Add user"})]})},je=b.lazy(async()=>$(()=>import("./index-BAp2SXUO.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11]))),_e=({selectedUsers:s,handleClearSelection:n,sidePanel:a=!1})=>{const[l,d]=b.useState(!1),{instanceId:m}=Q(),p=H(),{notify:h}=ae(),{setSidePanelContent:y,closeSidePanel:x}=F(),{removeUserQuery:u,lockUserQuery:o,unlockUserQuery:t}=T(),{mutateAsync:g,isPending:r}=u,{mutateAsync:_,isPending:k}=o,{mutateAsync:C,isPending:I}=t,S=Number(m),c=s.length===1?s[0]:void 0,{locked:D,unlocked:M}=he(s),P=async(U,K)=>{try{await U({computer_ids:[S],usernames:ge(s),delete_home:K==="removed"?l:void 0}),n&&n(),x(),h.success({message:`Successfully requested to be ${K}`})}catch(ee){p(ee)}},z=async()=>{await P(_,"locked")},Y=async()=>{await P(C,"unlocked")},W=async()=>{await P(g,"removed")},X=()=>{y("Add new user",e.jsx(R,{}))},J=U=>{y("Edit user",e.jsx(b.Suspense,{fallback:e.jsx(v,{}),children:e.jsx(je,{user:U})}))},Z=()=>{d(U=>!U)};return e.jsxs("div",{className:w("p-panel__controls u-no-padding--top",{"u-no-margin--left":a}),children:[!a&&e.jsxs(i.Button,{className:w("u-no-margin--right",{"u-no-margin--bottom":!a}),type:"button",hasIcon:!0,onClick:X,children:[e.jsx(i.Icon,{name:i.ICONS.plus}),e.jsx("span",{children:"Add user"})]}),e.jsx("div",{className:"p-segmented-control",children:e.jsxs("div",{className:"p-segmented-control__list",children:[((c==null?void 0:c.enabled)||!a)&&e.jsxs(i.ConfirmationButton,{className:w("p-segmented-control__button has-icon",{"u-no-margin--bottom":!a}),type:"button",disabled:M===0,"aria-disabled":M===0,confirmationModalProps:{title:`Lock ${c?`user ${c.username}`:`${s.length} users`}`,children:q({user:c,selectedUsers:s,userAction:G.Lock}),confirmButtonLabel:"Lock",confirmButtonAppearance:"positive",confirmButtonLoading:k,confirmButtonDisabled:k,onConfirm:z},children:[e.jsx(i.Icon,{name:"lock-locked"}),e.jsx("span",{children:"Lock"})]}),(!(c!=null&&c.enabled)||!a)&&e.jsxs(i.ConfirmationButton,{className:w("p-segmented-control__button has-icon",{"u-no-margin--bottom":!a}),type:"button",disabled:D===0,"aria-disabled":D===0,confirmationModalProps:{title:`Unlock ${c?`user ${c.username}`:`${s.length} users`}`,children:q({user:c,selectedUsers:s,userAction:G.Unlock}),confirmButtonLabel:"Unlock",confirmButtonAppearance:"positive",confirmButtonLoading:I,confirmButtonDisabled:I,onConfirm:Y},children:[e.jsx(i.Icon,{name:"lock-unlock"}),e.jsx("span",{children:"Unlock"})]}),a&&c&&e.jsxs(i.Button,{className:w("p-segmented-control__button has-icon",{"u-no-margin--bottom":!a}),type:"button",onClick:()=>{J(c)},children:[e.jsx(i.Icon,{name:"edit"}),e.jsx("span",{children:"Edit"})]}),e.jsxs(i.ConfirmationButton,{className:w("p-segmented-control__button has-icon",{"u-no-margin--bottom":!a}),type:"button",disabled:s.length===0,"aria-disabled":s.length===0,confirmationModalProps:{title:`Delete ${c?c.username:"users"}`,children:e.jsxs("div",{children:[e.jsx("p",{className:"u-no-margin--bottom",children:c?`This will delete user ${c.username}. You can delete this user's home folders at the same time.`:"This will delete selected users. You can delete their home folders as well."}),e.jsx(i.Input,{label:"Delete the home folders as well",type:"checkbox",checked:l,onChange:Z})]}),confirmButtonLabel:"Delete",confirmButtonAppearance:"negative",confirmButtonLoading:r,confirmButtonDisabled:r,onConfirm:W},children:[e.jsx(i.Icon,{name:i.ICONS.delete}),e.jsx("span",{children:"Delete"})]})]})})]})},we=(s,n)=>s.filter(a=>n.includes(a.uid)),Se=({selected:s,handleClearSelection:n,users:a})=>e.jsxs(e.Fragment,{children:[e.jsx(be,{actions:e.jsx("div",{className:ke.actions,children:e.jsx(_e,{handleClearSelection:n,selectedUsers:we(a,s)})})}),e.jsx(ie,{filtersToDisplay:["search"]})]}),N={username:"username",status:"status",name:"name",uid:"uid"},Ue={username:(s,n)=>s.username.localeCompare(n.username),status:(s,n)=>Number(s.enabled)-Number(n.enabled),name:(s,n)=>(s.name||"").localeCompare(n.name||""),uid:(s,n)=>s.uid-n.uid},Ne="_status_xcrdk_1",Ce="_statusCell_xcrdk_7",V={status:Ne,statusCell:Ce},Ie=b.lazy(async()=>$(()=>import("./index-BAp2SXUO.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11]))),ve=b.lazy(async()=>$(()=>import("./index-P1Vwdrdf.js"),__vite__mapDeps([12,1,2,3,4,5,8,9,10,11]))),Fe=({users:s,selected:n,setSelected:a})=>{const{setPageParams:l,sortBy:d,sort:m}=E(),{setSidePanelContent:p}=F();O("sortBy",Object.values(N)),O("sort",["asc","desc"]);const h=r=>{p("Edit user",e.jsx(b.Suspense,{fallback:e.jsx(v,{}),children:e.jsx(Ie,{user:r})}))},y=r=>{p("User details",e.jsx(b.Suspense,{fallback:e.jsx(v,{}),children:e.jsx(ve,{user:r})}))},x=()=>{a(n.length!==0?[]:s.map(({uid:r})=>r))},u=r=>{n.includes(r)?a(n.filter(_=>_!==r)):a([...n,r])},o=b.useMemo(()=>[{className:"checkbox-column",content:e.jsx(i.CheckboxInput,{label:e.jsx("span",{className:"u-off-screen",children:"Toggle all"}),labelClassName:"u-no-margin--bottom u-no-padding--top",onChange:x,checked:s.length>0&&n.length===s.length,indeterminate:n.length>0&&n.length<s.length,disabled:s.length===0})},{sortKey:N.username,content:"username"},{content:"status",sortKey:N.status},{content:"uid",sortKey:N.uid},{content:"full name",sortKey:N.name},{content:A.Header,className:A.className}],[s,n]),t=b.useMemo(()=>s.map(r=>({columns:[{accessor:"checkbox",className:"checkbox-column",content:e.jsx(i.CheckboxInput,{inline:!0,label:e.jsxs("span",{className:"u-off-screen",children:["Select user ",r.username]}),disabled:s.length===0,checked:n.includes(r.uid),onChange:()=>{u(r.uid)}})},{content:e.jsx(i.Button,{type:"button",appearance:"link",className:"u-no-margin--bottom u-no-padding--top",onClick:()=>{y(r)},"aria-label":`Show details of user ${r.username}`,children:r.username}),role:"rowheader"},{className:V.statusCell,content:e.jsx("div",{className:V.status,children:r.enabled?e.jsxs(e.Fragment,{children:[e.jsx(i.Icon,{name:"lock-unlock"}),e.jsx("span",{children:"Unlocked"})]}):e.jsxs(e.Fragment,{children:[e.jsx(i.Icon,{name:"lock-locked-active"}),e.jsx("span",{children:"Locked"})]})})},{content:r.uid},{content:r.name||e.jsx(ce,{})},{className:A.className,content:e.jsx(ue,{toggleAriaLabel:`"${r.name}" user actions`,actions:[{icon:"edit",label:"Edit","aria-label":`Edit "${r.name}" user`,onClick:()=>{h(r)}}]})}]})),[s,n]),g=r=>{if(a([]),!r){l({sort:null,sortBy:""});return}l({sort:r===d&&m==="asc"?"desc":"asc",sortBy:r})};return e.jsx(i.MainTable,{headers:o,rows:t,onUpdateSort:g,defaultSort:d,defaultSortDirection:ye(m),sortable:!0,emptyStateMsg:"No users available"})},Pe=(s,n)=>s?n.filter(({username:a,name:l})=>{const d=l==null?void 0:l.toUpperCase().includes(s.toUpperCase()),m=a.toUpperCase().includes(s.toUpperCase());return d||m}):n,Be="_link_1wvsk_1",Ae={link:Be},Le=()=>{const[s,n]=b.useState([]),{instanceId:a,childInstanceId:l}=Q(),{search:d,currentPage:m,pageSize:p}=E(),{setSidePanelContent:h}=F(),{getUsersQuery:y}=T(),x=Number(l??a),{data:u,isLoading:o}=y({computer_id:x,limit:L}),t=(u==null?void 0:u.data.results)??[],g=xe({data:t,sortFunctions:Ue}),r=Pe(d,g),_=(S,c)=>r.slice(c,c+S),k=b.useMemo(()=>_(p,(m-1)*p),[d,r,m,p]),C=()=>{n([])},I=()=>{h("Add new user",e.jsx(R,{}))};return e.jsxs(e.Fragment,{children:[!d&&o&&e.jsx(v,{}),!o&&!d&&(!u||u.data.results.length===0)&&e.jsx(le,{title:"No users found",body:"Add new users by clicking the button below",icon:"connected",cta:[e.jsx(i.Button,{type:"button",appearance:"positive",onClick:I,children:"Add user"},"empty-state-add-new-user")]}),(d||!o&&k.length>0)&&e.jsxs(e.Fragment,{children:[e.jsx(Se,{selected:s,handleClearSelection:C,users:k}),(u==null?void 0:u.data.count)&&u.data.count>L&&e.jsx(i.Notification,{severity:"caution",title:`Fetched ${L} out of ${u==null?void 0:u.data.count} users`,children:e.jsxs("span",{children:["The number of requested users is too high. Please"," ",e.jsx(de,{to:"https://support-portal.canonical.com/",className:Ae.link,children:"contact our support team."})]})}),e.jsx(Fe,{selected:s,setSelected:S=>n(S),users:k})]}),e.jsx(me,{handleClearSelection:C,totalItems:r.length,currentItemCount:k.length})]})},Me=Object.freeze(Object.defineProperty({__proto__:null,default:Le},Symbol.toStringTag,{value:"Module"}));export{_e as U,Me as i,T as u};
