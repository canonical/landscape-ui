import{j as e,h as I,k as C,e as V,f as D,g as l,a as le,R as K,r as j,L as re,o as H,l as ie,Y as oe}from"./index-aXCRV7My.js";import"./TablePagination.module-DLVph1Z1.js";import{T as ce}from"./TablePagination-Mp40oyQV.js";import{a as L}from"./useUsns-BaijwXLr.js";import{I as A}from"./InfoItem-DOu0Ntg_.js";import{u as de}from"./useConfirm-DtGSn1sv.js";import{u as ue}from"./formik.esm-Bnzr9ZOe.js";import{h as G}from"./moment-Cl4UOzQZ.js";import{S as Z}from"./SidePanelFormButtons-BktUqi6c.js";import{c as me,a as Y,f as he,d as Q}from"./index.esm-eR-gPxEp.js";import{u as pe,D as ge}from"./downshift.esm-lR-VHygj.js";import{u as J}from"./usePageParams-D5yIoF_H.js";import"./useFetchOld-Dx05gkab.js";import"./useMutation-DTawIE4_.js";import"./useQuery-BbzlNKqA.js";import"./InfoItem.module-BZ3tYMsb.js";import"./SidePanelFormButtons.module-DyBJG5lm.js";const be="_bold_c3q8d_1",ve="_radioGroup_c3q8d_5",xe="_marginTop_c3q8d_10",P={bold:be,radioGroup:ve,marginTop:xe},_e={deliver_after:"",deliver_delay_window:0,deliver_immediately:!0,randomize_delivery:!1,version:""},je={remove:"Remove",upgrade:"Upgrade",downgrade:"Downgrade"},fe="_bold_nffzr_1",F={bold:fe},ye=({packageCount:a,securityUpgradePackageCount:s,totalUpgradePackageCount:n})=>{const o=n-s,t=a-n;return e.jsxs("div",{children:[e.jsx("span",{children:"You selected "}),e.jsx("span",{className:F.bold,children:a}),e.jsx("span",{children:" packages. This will:"}),e.jsxs("ul",{className:I({"u-no-margin--bottom":t>0}),children:[s>0&&e.jsxs("li",{children:[e.jsx("span",{children:"apply "}),e.jsx("span",{className:F.bold,children:s}),e.jsx("span",{children:s===1?" security upgrade":" security upgrades"})]}),o>0&&e.jsxs("li",{children:[e.jsx("span",{children:"apply "}),e.jsx("span",{className:F.bold,children:o}),e.jsx("span",{children:o===1?" regular upgrade":" regular upgrades"})]})]}),t>0&&e.jsxs("p",{children:[e.jsx("span",{children:"No upgrades for "}),e.jsx("span",{className:F.bold,children:t}),e.jsx("span",{children:t===1?" package needed.":" packages needed."})]})]})},X=({action:a,packages:s})=>{const{instanceId:n}=C(),o=V(),{closeSidePanel:t}=D(),{downgradePackageVersionQuery:c,getDowngradePackageVersionsQuery:v,removePackagesQuery:b,upgradePackagesQuery:x}=L(),g=Number(n),{data:p}=v({instanceId:g,packageName:s[0].name},{enabled:a==="downgrade"}),h=p&&p.data.results.length>0?p.data.results.map(({version:m})=>({label:m,value:m})):[];h.unshift({label:"Select version",value:""});const d=s.filter(({status:m,available_version:w})=>m==="security"||m==="installed"&&w).map(({name:m})=>m),_=s.filter(({status:m})=>m==="security").length,{mutateAsync:f}=c,{mutateAsync:N}=b,{mutateAsync:S}=x,k=me({deliver_after:Y().test({test:m=>m?G(m).isValid():!0,message:"You have to enter a valid date and time"}),deliver_delay_window:he().min(0,"Delivery delay must be greater than or equal to 0"),deliver_immediately:Q(),randomize_delivery:Q(),version:Y().test({name:"required",message:"This field is required",params:{action:a},test:m=>a!=="downgrade"||!!m})}),r=ue({initialValues:_e,validationSchema:k,onSubmit:async m=>{const w={query:`id:${g}`,deliver_after:m.deliver_immediately?void 0:`${m.deliver_after}:00Z`,deliver_delay_window:m.randomize_delivery?m.deliver_delay_window:void 0};try{a==="remove"?await N({...w,packages:s.filter(y=>y.current_version).map(({name:y})=>y)}):a==="upgrade"?await S({...w,packages:d}):a==="downgrade"&&await f({instanceId:g,package_name:s[0].name,package_version:m.version}),t()}catch(y){o(y)}}});return e.jsxs(l.Form,{onSubmit:r.handleSubmit,noValidate:!0,children:[a==="downgrade"&&e.jsxs(l.Row,{className:"u-no-padding--left u-no-padding--right",children:[e.jsx(l.Col,{size:6,children:e.jsx(A,{label:"Current version",value:s[0].current_version})}),e.jsx(l.Col,{size:6,children:h.length>1?e.jsx(l.Select,{label:"New version",className:"",labelClassName:"p-text--small u-text--muted u-no-margin--bottom p-text--small-caps",...r.getFieldProps("version"),options:h}):e.jsx("p",{children:"No downgrade versions"})})]}),a==="upgrade"&&(s.length!==d.length||_>0)&&e.jsx(ye,{packageCount:s.length,securityUpgradePackageCount:_,totalUpgradePackageCount:d.length}),["remove","upgrade"].includes(a)&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:P.bold,children:"Delivery time"}),e.jsxs("div",{className:P.radioGroup,children:[e.jsx(l.Input,{type:"radio",label:"As soon as possible",name:"deliver_immediately",checked:r.values.deliver_immediately,onChange:()=>{r.setFieldValue("deliver_immediately",!0)}}),e.jsx(l.Input,{type:"radio",label:"Scheduled",name:"deliver_immediately",checked:!r.values.deliver_immediately,onChange:()=>{r.setFieldValue("deliver_immediately",!1),r.setFieldValue("deliver_after",G().toISOString().slice(0,16))}})]}),!r.values.deliver_immediately&&e.jsx(l.Input,{type:"datetime-local",label:"Deliver after",labelClassName:"u-off-screen",...r.getFieldProps("deliver_after"),error:r.touched.deliver_after&&r.errors.deliver_after?r.errors.deliver_after:void 0}),e.jsx("span",{className:I(P.bold,P.marginTop),children:"Randomise delivery over a time window"}),e.jsxs("div",{className:P.radioGroup,children:[e.jsx(l.Input,{type:"radio",label:"No",name:"randomize_delivery",checked:!r.values.randomize_delivery,onChange:async()=>{await r.setFieldValue("randomize_delivery",!1),await r.setFieldValue("deliver_delay_window",0)}}),e.jsx(l.Input,{type:"radio",label:"Yes",name:"randomize_delivery",checked:r.values.randomize_delivery,onChange:()=>r.setFieldValue("randomize_delivery",!0)})]}),r.values.randomize_delivery&&e.jsx(l.Input,{type:"number",inputMode:"numeric",min:0,label:"Delivery delay window",labelClassName:"u-off-screen",help:"Time in minutes",...r.getFieldProps("deliver_delay_window"),error:r.touched.deliver_delay_window&&r.errors.deliver_delay_window?r.errors.deliver_delay_window:void 0})]}),(["remove","upgrade"].includes(a)||h.length>1)&&e.jsx(Z,{submitButtonDisabled:r.isSubmitting,submitButtonText:je[a],submitButtonAppearance:a==="remove"?"negative":"positive"})]})},Ce=({singlePackage:a})=>{const{instanceId:s}=C(),n=V(),{setSidePanelContent:o}=D(),{confirmModal:t,closeConfirmModal:c}=de(),{installPackagesQuery:v}=L(),{mutateAsync:b,isLoading:x}=v,g=d=>{o(`${{remove:"Uninstall",upgrade:"Upgrade",downgrade:"Downgrade"}[d]} ${a.name}`,e.jsx(X,{action:d,packages:[a]}))},p=async()=>{try{await b({packages:[a.name],query:`id:${s}`})}catch(d){n(d)}finally{c()}},h=()=>{t({title:"Install package",body:`Are you sure you want to install "${a.name}" package?`,buttons:[e.jsx(l.Button,{appearance:"positive",disabled:x,onClick:p,children:"Install"},"install")]})};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-segmented-control",children:[a.current_version&&e.jsxs(l.Button,{type:"button",className:"p-segmented-control__button has-icon",onClick:()=>{g("remove")},children:[e.jsx("i",{className:"p-icon--delete"}),e.jsx("span",{children:"Uninstall"})]}),a.available_version&&e.jsxs(l.Button,{type:"button",className:"p-segmented-control__button has-icon",onClick:()=>{g("upgrade")},children:[e.jsx("i",{className:"p-icon--change-version"}),e.jsx("span",{children:"Upgrade"})]}),a.current_version&&e.jsxs(l.Button,{type:"button",className:"p-segmented-control__button has-icon",onClick:()=>{g("downgrade")},children:[e.jsx("i",{className:"p-icon--begin-downloading"}),e.jsx("span",{children:"Downgrade"})]}),a.available_version&&!a.current_version&&e.jsxs(l.Button,{type:"button",className:"p-segmented-control__button has-icon",onClick:h,children:[e.jsx("i",{className:"p-icon--plus"}),e.jsx("span",{children:"Install"})]})]},"buttons"),e.jsx("div",{children:e.jsx(A,{label:"Package name",value:a.name})}),e.jsx("div",{children:e.jsx(A,{label:"Summary",value:a.summary})}),e.jsxs(l.Row,{className:"u-no-padding--left u-no-padding--right",children:[e.jsx(l.Col,{size:6,children:e.jsx(A,{label:"Current version",value:a.current_version})}),a.available_version&&e.jsx(l.Col,{size:6,children:e.jsx(A,{label:"Upgeradable to",value:a.available_version})})]})]})},Ne=({onDismiss:a})=>{const s=le(),{instanceId:n,childInstanceId:o}=C();return e.jsxs(l.Notification,{severity:"caution",onDismiss:a,children:[e.jsx("strong",{children:"Some upgrades require Ubuntu Pro: "}),e.jsxs("span",{children:["Your current Ubuntu package upgrades are limited. To unlock full upgrades, please upgrade to Ubuntu Pro."," "]}),e.jsx(l.Button,{type:"button",appearance:"link",onClick:()=>{s(`${K}instances/${o?`${n}/${o}`:n}`,{state:{tab:"ubuntu-pro"}})},children:"Learn more"})]})},Se={available_version:null,current_version:null,name:"loading",status:"available",summary:""},we="_checkbox_p36ti_1",Ie="_details_p36ti_5",ke="_tooltipLink_p36ti_9",$e="_hidden_p36ti_13",q={checkbox:we,details:Ie,tooltipLink:ke,hidden:$e},z=a=>!!a.available_version&&!!a.current_version&&a.available_version.includes("ubuntu-pro"),W=a=>{const s={label:"Unknown",icon:""};return a.status==="available"?(s.label="Available",s.icon="status-queued-small"):a.status==="held"?(s.label="Held",s.icon="status-in-progress-small"):a.status==="security"?(s.label="Security upgrade",s.icon="status-failed-small"):a.status==="installed"&&(a.available_version?(s.label="Regular upgrade",s.icon="status-waiting-small"):(s.label="Installed",s.icon="status-succeeded-small")),s},Pe=({column:a,row:s})=>{const n={};return s.original.name==="loading"?a.id==="name"?n.colSpan=5:(n.className=q.hidden,n["aria-hidden"]=!0):a.id==="checkbox"?n["aria-label"]=`Toggle ${s.original.name} package`:a.id==="name"?n.role="rowheader":a.id==="status"?n["aria-label"]="Status":a.id==="current_version"?n["aria-label"]="Current version":a.id==="available_version"?n["aria-label"]="Available version":a.id==="summary"&&(n["aria-label"]="Details"),n},Te=({emptyMsg:a,onPackagesSelect:s,packages:n,packagesLoading:o,selectedPackages:t,selectAll:c})=>{const[v,b]=j.useState(!1),[x,g]=j.useState(!1),{instanceId:p,childInstanceId:h}=C(),{setSidePanelContent:d}=D(),_=j.useMemo(()=>o?[Se]:n,[n,o]),f=i=>{s(t.some(({name:r})=>r===i.name)?t.filter(({name:r})=>r!==i.name):[...t,i])},N=()=>{s(t.length>0?[]:n.filter(i=>!z(i)))};j.useEffect(()=>{!c||v||!n.length||(N(),b(!0))},[c,n]);const S=i=>{d("Package details",e.jsx(Ce,{singlePackage:i}))},k=j.useMemo(()=>[{accessor:"checkbox",className:q.checkbox,Header:e.jsx(l.CheckboxInput,{inline:!0,label:e.jsx("span",{className:"u-off-screen",children:"Toggle all"}),checked:t.length===n.length&&n.length>0,indeterminate:t.length<n.length&&t.length>0,disabled:n.length===0,onChange:N}),Cell:({row:i})=>z(i.original)?e.jsx(l.Tooltip,{message:e.jsxs("div",{children:[e.jsx("p",{className:"u-no-padding--top",children:"Ubuntu Pro is required"}),e.jsx(re,{to:`${K}instances/${h?`${p}/${h}`:`${p}`}`,state:{tab:"ubuntu-pro"},className:q.tooltipLink,children:"learn more"})]}),children:e.jsx(l.CheckboxInput,{inline:!0,disabled:!0,label:e.jsx("span",{className:"u-off-screen",children:`Toggle ${i.original.name}`}),checked:t.some(({name:r})=>r===i.original.name),onChange:()=>{f(i.original)}})}):e.jsx(l.CheckboxInput,{inline:!0,label:e.jsx("span",{className:"u-off-screen",children:`Toggle ${i.original.name}`}),checked:t.some(({name:r})=>r===i.original.name),onChange:()=>{f(i.original)}})},{accessor:"name",Header:"Name",Cell:({row:i})=>i.original.name==="loading"?e.jsx(H,{}):e.jsx(l.Button,{type:"button",appearance:"link",className:"u-no-margin--bottom u-no-padding--top u-align-text--left",onClick:()=>{S(i.original)},children:i.original.name})},{accessor:"status",Header:"Status",Cell:({row:{original:i}})=>W(i).label,getCellIcon:({row:{original:i}})=>W(i).icon},{accessor:"current_version",Header:"Current version"},{accessor:"summary",className:q.details,Header:"Details",Cell:({row:{original:i}})=>i.available_version?e.jsxs(e.Fragment,{children:[e.jsx("span",{children:i.summary}),e.jsx("br",{}),e.jsx("span",{children:`available version: ${i.available_version}`})]}):i.summary}],[n,t.length]);return e.jsxs(e.Fragment,{children:[!x&&n.some(z)&&e.jsx(Ne,{onDismiss:()=>g(!0)}),e.jsx(l.ModularTable,{columns:k,data:_,getCellProps:Pe,emptyMsg:a})]})},Ae="_container_1qwn6_1",De="_searchContainer_1qwn6_6",Le="_selectContainer_1qwn6_10",Be="_cta_1qwn6_15",U={container:Ae,searchContainer:De,selectContainer:Le,cta:Be},Fe="_container_1d6qb_1",Ue="_suggestionsContainer_1d6qb_5",qe="_pointer_1d6qb_12",Ve="_highlighted_1d6qb_17",ze="_selectedContainer_1d6qb_21",T={container:Fe,suggestionsContainer:Ue,pointer:qe,highlighted:Ve,selectedContainer:ze},Ee=200,He=(a,s)=>{const n=a.toLowerCase(),o=s.toLowerCase(),t=n.indexOf(o);return t>=0?e.jsxs(e.Fragment,{children:[a.substring(0,t),e.jsx("strong",{children:a.substring(t,t+s.length)}),a.substring(t+s.length)]}):a},Oe=({selectedItems:a,setSelectedItems:s})=>{var M;const[n,o]=j.useState(""),[t,c]=j.useState(!1),[v,b]=j.useState(""),{instanceId:x}=C(),g=V(),{getInstancePackagesQuery:p}=L(),h=Number(x),{data:d,isFetching:_}=p({instance_id:h,available:!0,installed:!1,upgrade:!1,held:!1,limit:50,search:n},{enabled:n.length>2}),f=((M=d==null?void 0:d.data)==null?void 0:M.results)??[],N=u=>!a.map($=>$.name).includes(u.name),S=f.filter(N),k=u=>{s(a.filter($=>$.name!==u))},i=()=>{c(!1)},r=()=>{b(""),o("")},m=()=>{v.length>2?c(!0):c(!1)},w=u=>{b(u),u.length>2&&o(u)},y=pe(()=>{try{m()}catch(u){g(u)}},Ee),ee=u=>{s([...a,u]),r()},ae=u=>{u&&(ee(u),c(!1))},ne=u=>{u.key==="Escape"?u.currentTarget.blur():y()},O=!t&&v.length<3?"Min 3. characters":f.length===0&&n&&!_?`No packages found by "${n}"`:null;return e.jsxs("div",{className:T.container,children:[e.jsx(ge,{onSelect:ae,itemToString:()=>"",isOpen:t,children:({getInputProps:u,getItemProps:$,getMenuProps:se,highlightedIndex:te})=>e.jsxs("div",{className:"p-autocomplete",children:[e.jsx(l.SearchBox,{...u(),placeholder:"Search for available packages",className:"u-no-margin--bottom",shouldRefocusAfterReset:!0,externallyControlled:!0,autocomplete:"off",value:v,onChange:w,onClear:r,onBlur:i,onFocus:m,onKeyUp:ne}),O?e.jsx("span",{className:"p-form-help-text",children:O}):null,t&&(S.length>0||_)?e.jsx("ul",{className:I("p-list p-card--highlighted u-no-padding u-no-margin--bottom p-autocomplete__suggestions",T.suggestionsContainer),...se(),children:_?e.jsx(H,{}):S.map((B,R)=>e.jsxs("li",{className:I("p-list__item",T.pointer,{[T.highlighted]:te===R}),...$({item:B,index:R}),children:[e.jsx("div",{className:"u-truncate","data-testid":"dropdownElement",children:He(B.name,n)}),e.jsx("div",{children:e.jsx("small",{className:"u-text-muted",children:B.current_version})})]},B.name))}):null]})}),e.jsx("ul",{className:"p-list p-autocomplete__result-list u-no-margin--bottom",children:a.length?a.map(u=>e.jsxs("li",{className:I("p-autocomplete__result p-list__item p-card u-no-margin--bottom",T.selectedContainer),children:[e.jsxs("div",{children:[e.jsx("div",{children:u.name}),e.jsx("span",{children:e.jsx("small",{className:"u-text--muted p-text--small",children:u.current_version})})]}),e.jsx(l.Button,{appearance:"link",className:"u-no-margin--bottom u-no-padding--top",onClick:()=>k(u.name),children:e.jsx("i",{className:"p-icon--delete"})})]},u.name)):null})]})},Me=()=>{const[a,s]=j.useState([]),{instanceId:n}=C(),o=V(),{notify:t}=ie(),{installPackagesQuery:c}=L(),{closeSidePanel:v}=D(),{mutateAsync:b,isLoading:x}=c,g=async()=>{try{await b({packages:a.map(({name:p})=>p),query:`id:${n}`}),v(),t.success({message:`You queued ${a.length===1?`package ${a[0].name}`:`${a.length} packages`} to be installed.`})}catch(p){o(p)}};return e.jsxs(e.Fragment,{children:[e.jsx(Oe,{selectedItems:a,setSelectedItems:p=>s(p)}),e.jsx(Z,{submitButtonDisabled:x||a.length===0,submitButtonText:"Install packages",submitButtonAppearance:"positive",onSubmit:g})]})},Re="_container_1nwlw_1",Ge="_noWrap_1nwlw_5",E={container:Re,noWrap:Ge},Ye=({selectedPackages:a})=>{const{setSidePanelContent:s}=D(),n=t=>{const c=a.length===1?a[0].name:`${a.length} selected packages`;s(t==="remove"?`Remove ${c}`:`Upgrade ${c}`,e.jsx(X,{action:t,packages:a}))},o=()=>{s("Install packages",e.jsx(Me,{}))};return e.jsxs("div",{className:E.container,children:[e.jsxs(l.Button,{type:"button",onClick:o,hasIcon:!0,className:E.noWrap,children:[e.jsx("i",{className:"p-icon--plus"}),e.jsx("span",{children:"Install"})]}),e.jsxs("div",{className:I("p-segmented-control is-small",E.noWrap),children:[e.jsxs(l.Button,{type:"button",className:"p-segmented-control__button has-icon",disabled:a.length===0||a.every(t=>!t.current_version),onClick:()=>n("remove"),children:[e.jsx("i",{className:"p-icon--delete"}),e.jsx("span",{children:"Uninstall"})]}),e.jsxs(l.Button,{type:"button",className:"p-segmented-control__button has-icon",disabled:a.length===0||a.every(t=>!t.available_version),onClick:()=>n("upgrade"),children:[e.jsx("i",{className:"p-icon--change-version"}),e.jsx("span",{children:"Upgrade"})]})]},"buttons")]})},Qe=[{label:"All",value:""},{label:"Installed",value:"installed"},{label:"Upgrades",value:"upgrade"},{label:"Security upgrades",value:"security"},{label:"Held",value:"held"}],We=({handleClearSelection:a,selectedPackages:s})=>{const{search:n,setPageParams:o,status:t}=J(),[c,v]=j.useState(n),b=()=>{o({search:c}),a()},x=()=>{o({search:""})},g=h=>{o({status:h})},p=h=>{h.preventDefault(),b()};return e.jsxs("div",{className:U.container,children:[e.jsx("div",{className:U.searchContainer,children:e.jsx(l.Form,{onSubmit:p,noValidate:!0,children:e.jsx(l.SearchBox,{shouldRefocusAfterReset:!0,externallyControlled:!0,autocomplete:"off",value:c,onChange:h=>v(h),onSearch:b,onClear:x})})}),e.jsx(l.Select,{label:"Status",wrapperClassName:U.selectContainer,options:Qe,value:t,onChange:h=>g(h.target.value)}),e.jsx("div",{className:U.cta,children:e.jsx(Ye,{selectedPackages:s})})]})},Ke=(a,s)=>{let n;return a===""?n="No packages found":a==="upgrade"?n="No available upgrades found":a==="security"?n="No available security upgrades found":a==="installed"?n="No installed packages found":n="No held packages found",s?`${n} with the search "${s}"`:n},Ze=()=>{const[a,s]=j.useState([]),{instanceId:n,childInstanceId:o}=C(),{status:t,search:c,currentPage:v,pageSize:b}=J(),{getInstancePackagesQuery:x}=L(),{state:g}=oe(),p=Number(o??n),h=()=>{s([])},{data:d,isLoading:_}=x({instance_id:p,search:c,limit:b,offset:(v-1)*b,available:!1,installed:t==="installed"||!t||void 0,upgrade:t==="upgrade"||void 0,held:t==="held"||void 0,security:t==="security"||void 0});return e.jsxs(e.Fragment,{children:[!c&&!t&&v===1&&b===20&&_&&e.jsx(H,{}),(c||t||v!==1||b!==20||!_)&&e.jsxs(e.Fragment,{children:[e.jsx(We,{selectedPackages:a,handleClearSelection:h}),e.jsx(Te,{packages:(d==null?void 0:d.data.results)??[],packagesLoading:_,selectedPackages:a,onPackagesSelect:f=>{s(f)},emptyMsg:Ke(t,c),selectAll:(g==null?void 0:g.selectAll)??!1})]}),e.jsx(ce,{handleClearSelection:h,totalItems:d==null?void 0:d.data.count,currentItemCount:d==null?void 0:d.data.results.length})]})},ba=Ze;export{ba as default};
