import{r as b,j as a,a as B,y as H,z as E,c as M,H as P,m as k,o as T,ao as R,a7 as C,D,N as $,n as N,ah as L}from"./index-AQFe3UL3.js";import{E as w,S}from"./SelectAllButton-CoSC_Sy9.js";import{T as F}from"./TruncatedCell-D16uLRBX.js";import{u as I}from"./usePackages-KKK5Nym7.js";import{g as V,c as j,a as O,h as _,b as v}from"./helpers-BonKpxw0.js";const q=({column:c})=>{const s={};return c.id==="title"?s.role="rowheader":c.id==="upgrades.security"&&(s["aria-label"]="Affected packages"),s},z="_security_16o7z_1",Q={security:z},Y=({instances:c,limit:s,onLimitChange:m,usn:l,usnPackages:i})=>{const n=b.useMemo(()=>c.filter(({id:e})=>i.flatMap(({computer_ids:g})=>g).includes(e)).slice(0,s),[c,s,i]),o=b.useMemo(()=>[{accessor:"title",Header:"Name"},{accessor:"upgrades.security",className:Q.security,Header:"Affected packages",Cell:({row:{original:e}})=>i.filter(({computer_ids:g})=>g.includes(e.id)).length}],[n.length]);return a.jsx(w,{columns:o,data:n,itemNames:{plural:"instances",singular:"instance"},onLimitChange:m,totalCount:n.length,title:a.jsxs("p",{className:"p-heading--4",children:["Instances affected by ",a.jsx("b",{children:l})]}),getCellProps:q})},W=({instanceTitle:c,usn:s})=>{const m=B(),l=H(),{notify:i}=E(),{removeUsnPackagesQuery:n}=I(),{setPageParams:o}=M(),{instanceId:e,childInstanceId:g}=P(),h=Number(e),{mutateAsync:p,isPending:u}=n,f=()=>{m(`/instances/${g?`${h}/${g}`:`${h}`}`),o({tab:"activities"}),i.clear()},y=async()=>{try{await p({usns:s,instanceId:h}),i.success({title:"You queued packages to be uninstalled",message:`Packages affected by "${s}" security issue will be uninstalled and are queued in Activities.`,actions:[{label:"View details",onClick:f}]})}catch(x){l(x)}};return a.jsxs(k.ConfirmationButton,{type:"button",className:"is-small is-dense has-icon",confirmationModalProps:{title:"Uninstall USN packages",children:a.jsxs("p",{children:['This will uninstall packages affected by "',s,'" security issue from the "',c,'" instance.']}),confirmButtonLabel:"Uninstall",confirmButtonAppearance:"negative",confirmButtonDisabled:u,confirmButtonLoading:u,onConfirm:y},children:[a.jsx(k.Icon,{name:"delete",className:"u-no-margin--left"}),a.jsx("span",{children:"Uninstall packages"})]},"remove")},G=({column:c})=>{const s={};return c.id==="name"?s.role="rowheader":c.id==="current_version"?s["aria-label"]="Current version":c.id==="new_version"?s["aria-label"]="New version":c.id==="summary"&&(s["aria-label"]="Details"),s},J=({instanceTitle:c,limit:s,onLimitChange:m,showRemoveButton:l,usn:i,usnPackages:n})=>{const o=b.useMemo(()=>n.slice(0,s),[s,n]),e=b.useMemo(()=>[{accessor:"name",Header:"Package"},{accessor:"current_version",Header:"Current version"},{accessor:"new_version",Header:"New version"},{accessor:"summary",Header:"Details"}],[o.length]);return a.jsx(w,{additionalCta:l&&a.jsx(W,{instanceTitle:c,usn:i}),columns:e,data:o,itemNames:{plural:"packages",singular:"package"},onLimitChange:m,title:a.jsxs("p",{className:"p-heading--4",children:["Packages affected by ",a.jsx("b",{children:i})]}),totalCount:n.length,getCellProps:G})},K=({instances:c,isRemovable:s,listType:m,usn:l})=>{const[i,n]=b.useState(5),{getAffectedPackagesQuery:o}=I(),{instanceId:e}=P(),g=Number(e),{data:h,isLoading:p}=o({usn:l,computer_ids:s?[g]:c.map(({id:f})=>f)}),u=(h==null?void 0:h.data)??[];return a.jsxs(a.Fragment,{children:[p&&a.jsx(T,{}),!p&&m==="instances"&&a.jsx(Y,{instances:c,limit:i,onLimitChange:()=>n(f=>f+5),usn:l,usnPackages:u}),!p&&m==="packages"&&a.jsx(J,{instanceTitle:c[0].title,limit:i,onLimitChange:()=>n(f=>f+5),showRemoveButton:s,usn:l,usnPackages:u})]})},se=({instances:c,isUsnsLoading:s,onSelectedUsnsChange:m,selectedUsns:l,totalUsnCount:i,usns:n,...o})=>{const[e,g]=b.useState(null),h=b.useRef([]);R({current:(e==null?void 0:e.column)==="cves"?h.current[e.row]:null},()=>{g(null)});const p=o.tableType==="expandable"&&o.showSelectAllButton,u=b.useMemo(()=>V({expandedCell:e,isUsnsLoading:s,showSelectAllButton:p,usns:n}),[n,e,s,p]),f=t=>{m(l.includes(t)?l.filter(r=>r!==t):[...l,t])},y=(t,r)=>{g(d=>(d==null?void 0:d.column)===t&&d.row===r?null:{column:t,row:d&&["computers_count","release_packages"].includes(d.column)&&d.row<r?r-1:r})},x=b.useMemo(()=>[{accessor:"checkbox",className:"checkbox-column",Header:()=>a.jsx(k.CheckboxInput,{inline:!0,label:a.jsx("span",{className:"u-off-screen",children:"Toggle all security issues"}),disabled:u.length===0||s,indeterminate:l.length>0&&l.length<n.length,checked:l.length>0&&l.length===n.length,onChange:()=>{m(l.length>0?[]:n.map(({usn:t})=>t))}}),Cell:({row:{original:t}})=>a.jsx(k.CheckboxInput,{labelClassName:"u-no-margin--bottom u-no-padding--top",label:a.jsx("span",{className:"u-off-screen",children:`Toggle ${t.usn}`}),disabled:s,name:"usn",checked:l.includes(t.usn),onChange:()=>{f(t.usn)}})},{accessor:"usn",Header:"USN",Cell:({row:{index:t,original:r}})=>t===0&&p?a.jsx(S,{count:o.totalSelectedUsnCount,itemName:{plural:"security issues",singular:"security issue"},onClick:o.onSelectAllClick,totalCount:i}):(e==null?void 0:e.row)===t-1&&["computers_count","release_packages"].includes(e.column)?a.jsx(K,{isRemovable:e.column==="release_packages"&&o.tableType==="paginated",instances:c,listType:e.column==="release_packages"?"packages":"instances",usn:u[e.row].usn}):s&&t===u.length-1?a.jsx(T,{}):a.jsx("a",{href:r.usn_link,target:"_blank",rel:"nofollow noopener noreferrer",children:r.usn})},{accessor:"cves",Header:"CVE(s)",Cell:({row:{original:t,index:r}})=>a.jsx(F,{content:t.cves.map(({cve:d,cve_link:A})=>a.jsx("span",{className:j.cve,children:a.jsx("a",{href:A,target:"_blank",rel:"nofollow noopener noreferrer",className:j.cveLink,children:d})},d)),isExpanded:(e==null?void 0:e.column)==="cves"&&e.row===r,onExpand:()=>{y("cves",r)}})},{accessor:"date",Header:"Date published",Cell:({row:t})=>a.jsx(a.Fragment,{children:C(t.original.date).isValid()?C(t.original.date).format(D):a.jsx($,{})})},{accessor:"computers_count",Header:"Affected instances",Cell:({column:t,row:{index:r,original:d}})=>a.jsx(k.Button,{type:"button",className:N("p-accordion__tab",j.expandButton),"aria-expanded":(e==null?void 0:e.column)===t.id&&e.row===r,onClick:()=>{y(t.id,r)},children:d.computers_count})},{accessor:"release_packages",Header:"Affected packages",Cell:({column:t,row:{index:r}})=>a.jsx(k.Button,{type:"button",className:N("p-accordion__tab",j.expandButton),"aria-expanded":(e==null?void 0:e.column)===t.id&&e.row===r,onClick:()=>{y(t.id,r)},children:`${(e==null?void 0:e.column)===t.id&&e.row===r?"Hide":"Show"} packages`})}].filter(({accessor:t})=>o.tableType==="paginated"?t!=="computers_count":t!=="date"),[u,s,l.length,o.tableType,e]);return a.jsx("div",{ref:O(h),children:o.tableType==="expandable"?a.jsx(w,{columns:x,data:u,getCellProps:v({expandedCell:e,isUsnsLoading:s,lastUsnIndex:u.length-1,showSelectAllButton:p}),getRowProps:_(e),itemCount:n.length,itemNames:{plural:"security issues",singular:"security issue"},onLimitChange:o.onNextPageFetch,totalCount:i}):a.jsxs(a.Fragment,{children:[a.jsx(k.ModularTable,{columns:x,data:u,getCellProps:v({expandedCell:e,isUsnsLoading:s}),getRowProps:_(e),emptyMsg:`No security issues found with the search "${o.search}"`}),n.length>0&&a.jsx(L,{handleClearSelection:()=>{m([])},totalItems:i,currentItemCount:n.length})]})})};export{se as U};
