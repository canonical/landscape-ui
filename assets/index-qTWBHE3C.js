import{C as x,G as n,K as p,F as T,H as j,v as u,y as _,z as F,l as C,A as $,j as s,m as a,a8 as y}from"./index-Df03TKU2.js";import{M as g}from"./MultiSelectField-BOVRUYvL.js";import{S as N}from"./SidePanelFormButtons-DUBJux5O.js";import{b as A}from"./helpers-Cdcl1GaF.js";import{u as P}from"./useInstances-Dgq1eX0o.js";import"./InstancesPageActions-BBbkH47_.js";import{g as f}from"./formikErrors-Bw8iTXYS.js";import{u as k,D as O}from"./DeliveryBlock-D51chQxc.js";import"./SidePanelFormButtons.module-D2P5PizG.js";const V={deliver_after:"",deliverImmediately:!0,instanceIds:[],queryType:"tags",tags:[],username:"root",time_limit:300},R=x().shape({access_group:n(),deliverImmediately:T().required("This field is required."),deliver_after:n().when("deliverImmediately",{is:!1,then:i=>i.required("This field is required").test({test:o=>u(o).isValid()&&u(o).isAfter(u()),message:"You have to enter a valid date and time in the future"})}),instanceIds:p().of(j()).when("queryType",{is:"ids",then:i=>i.min(1,"At least one instance is required.")}),queryType:n().required("This field is required."),tags:p().of(n()).when("queryType",{is:"tags",then:i=>i.min(1,"At least one tag is required.")}),username:n().required("This field is required.")}),w="_instanceSelectionContainer_16uxl_1",D={instanceSelectionContainer:w},Y=({script:i})=>{const o=_(),{notify:h}=F(),{closeSidePanel:I}=C(),{getAllInstanceTagsQuery:S,getInstancesQuery:q}=P(),{runScript:v}=k(),e=$({initialValues:V,onSubmit:async t=>{const r={query:t.queryType==="ids"?`id:${t.instanceIds.join(" OR id:")}`:`tag:${t.tags.join(" OR tag:")}`,script_id:i.id,username:t.username,time_limit:Number(t.time_limit),deliver_after:t.deliverImmediately?void 0:y(t.deliver_after).toISOString().replace(/\.\d+(?=Z$)/,"")};t.deliverImmediately||(r.deliver_after=y(t.deliver_after).toISOString().replace(/\.\d+(?=Z$)/,""));try{await v(r),I(),h.success({message:`"${i.title}" script queued to execute successfully`,title:"Script execution queued"})}catch(b){o(b)}},validationSchema:R}),{data:l}=S(),c=(l==null?void 0:l.data.results.map(t=>({label:t,value:t})))??[],{data:d}=q({query:`access-group-recursive:${i.access_group}`}),m=(d==null?void 0:d.data.results.filter(t=>A("runScripts",t)).map(({title:t,id:r})=>({label:t,value:r})))??[];return s.jsxs(a.Form,{onSubmit:e.handleSubmit,noValidate:!0,children:[s.jsx("p",{className:"u-no-margin--bottom",children:"Select instances by:"}),s.jsx("div",{className:"is-required",children:s.jsxs("div",{children:[s.jsx(a.Input,{type:"radio",label:"Tags",...e.getFieldProps("queryType"),value:"tags",checked:e.values.queryType==="tags"}),s.jsx(a.Input,{type:"radio",label:"Instance names",...e.getFieldProps("queryType"),value:"ids",checked:e.values.queryType==="ids"}),s.jsxs("div",{className:D.instanceSelectionContainer,children:[e.values.queryType==="tags"&&s.jsx(g,{placeholder:"Select tags",variant:"condensed",label:"Tags",labelClassName:"u-off-screen",required:!0,...e.getFieldProps("tags"),items:c,selectedItems:c.filter(({value:t})=>e.values.tags.includes(t)),onItemsUpdate:async t=>e.setFieldValue("tags",t.map(({value:r})=>r)),error:e.touched.tags&&typeof e.errors.tags=="string"?e.errors.tags:void 0}),e.values.queryType==="ids"&&s.jsx(g,{placeholder:"Select instances",variant:"condensed",label:"Instances",labelClassName:"u-off-screen",required:!0,...e.getFieldProps("instanceIds"),items:m,selectedItems:m.filter(({value:t})=>e.values.instanceIds.includes(t)),onItemsUpdate:async t=>e.setFieldValue("instanceIds",t.map(({value:r})=>r)),error:e.touched.instanceIds&&typeof e.errors.instanceIds=="string"?e.errors.instanceIds:void 0})]})]})}),s.jsxs(a.Row,{className:"u-no-padding--left u-no-padding--right",children:[s.jsx(a.Col,{size:6,children:s.jsx(a.Input,{type:"text",label:"Run as user",autoComplete:"off",required:!0,...e.getFieldProps("username"),error:f(e,"username")})}),s.jsx(a.Col,{size:6,children:s.jsx(a.Input,{type:"text",label:"Time limit (seconds)",autoComplete:"off",required:!0,...e.getFieldProps("time_limit"),error:f(e,"time_limit")})})]}),s.jsx(O,{formik:e}),s.jsx(N,{submitButtonDisabled:e.isSubmitting,submitButtonText:"Run script"})]})};export{Y as default};
