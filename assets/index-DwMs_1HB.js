import{p as I,o as j,f as D,q as N,s as S,j as i,g as n,I as u}from"./index-DBcAWqbv.js";import{u as k}from"./index-CiLfP7PD.js";import{h as T}from"./usePageParams-D5pJSJ3O.js";import{u as A}from"./index-COg_eFvU.js";import{K as C}from"./constants-AfaZFE5d.js";import"./TablePagination-whkkZrpm.js";import"./TablePaginationBase-Dr1jFaWe.js";import"./StatusFilter-C_Pj8bGk.js";import"./TableFilter-BTR0ILya.js";import"./TableFilterChips-Cyuq7biN.js";import"./useFetchOld-gBQ8Xnh7.js";import"./NoData-CRBDtP9O.js";import"./PageMain-BWaAqMm_.js";import"./usePackages-BYrf59R8.js";import"./useInstances-CVYfdxOU.js";import"./helpers-BBDAsFwS.js";try{let t=typeof window<"u"?window:typeof global<"u"?global:typeof globalThis<"u"?globalThis:typeof self<"u"?self:{},r=new t.Error().stack;r&&(t._sentryDebugIds=t._sentryDebugIds||{},t._sentryDebugIds[r]="b25486e2-113c-408a-866a-8b25a0f998a4",t._sentryDebugIdIdentifier="sentry-dbid-b25486e2-113c-408a-866a-8b25a0f998a4")}catch{}const E="The kernel will be downgraded and the instance will restart afterwards to apply the change.",R="The kernel will be downgraded. You'll need to restart the instance to apply this change.",F="Downgrading the kernel will expose your system to known security vulnerabilities AND reduce your Livepatch coverage.",B="_radioGroup_1y5w7_1",O="_marginTop_1y5w7_6",P="_infoItem_1y5w7_11",l={radioGroup:B,marginTop:O,infoItem:P},ee=({currentKernelVersion:t,downgradeKernelVersions:r,instanceName:m})=>{const p=I(),{instanceId:_}=j(),{closeSidePanel:d}=D(),{notify:y}=N(),{downgradeKernelQuery:f}=A(),{openActivityDetails:g}=k(),{mutateAsync:v,isPending:s}=f,h=[{label:"Select",value:""},...r.map(a=>({label:a.version_rounded,value:a.id.toString()}))],w={deliver_immediately:!0,randomize_delivery:!1,deliver_delay_window:0,deliver_after:"",new_kernel_version_id:r.length===1?r[0].id.toString():"",reboot_after:!1},e=S({initialValues:w,validationSchema:C,onSubmit:async a=>{try{const{data:o}=await v({id:Number(_),kernel_package_id:Number(a.new_kernel_version_id),reboot_after:a.reboot_after});d();const x=a.reboot_after?E:R;y.success({title:`You queued kernel downgrade for instance "${m}"`,message:x,actions:[{label:"View details",onClick:()=>g(o)}]})}catch(o){p(o)}}}),c=async a=>{const o=a.currentTarget.value==="true";await e.setFieldValue("deliver_immediately",o),o||await e.setFieldValue("deliver_after",T().toISOString().slice(0,16))},b=async()=>{await e.setFieldValue("reboot_after",!0),e.handleSubmit()};return i.jsxs(n.Form,{onSubmit:e.handleSubmit,children:[i.jsx(n.Notification,{severity:"caution",title:"Security warning",children:i.jsx("span",{children:F})}),i.jsxs(n.Row,{className:"u-no-padding--left u-no-padding--right",children:[i.jsx(n.Col,{size:6,children:i.jsx(u,{label:"current version",value:t})}),i.jsx(n.Col,{size:6,children:i.jsx(u,{label:"kernel version",className:l.infoItem,value:r.length===1?i.jsx("span",{children:r[0].version_rounded}):i.jsx(n.Select,{options:h,...e.getFieldProps("new_kernel_version_id")})})})]}),i.jsx("strong",{className:l.marginTop,children:"Delivery time"}),i.jsxs("div",{className:l.radioGroup,children:[i.jsx(n.Input,{type:"radio",label:"As soon as possible",name:"deliver_immediately",value:"true",onChange:c,checked:e.values.deliver_immediately}),i.jsx(n.Input,{type:"radio",label:"Scheduled",name:"deliver_immediately",value:"false",onChange:c,checked:!e.values.deliver_immediately})]}),!e.values.deliver_immediately&&i.jsx(n.Input,{type:"datetime-local",label:"Deliver after",labelClassName:"u-off-screen",...e.getFieldProps("deliver_after"),error:e.touched.deliver_after&&e.errors.deliver_after?e.errors.deliver_after:void 0}),i.jsx("strong",{className:l.marginTop,children:"Randomise delivery over a time window"}),i.jsxs("div",{className:l.radioGroup,children:[i.jsx(n.Input,{type:"radio",label:"No",...e.getFieldProps("randomize_delivery"),onChange:async()=>{await e.setFieldValue("randomize_delivery",!1),await e.setFieldValue("deliver_delay_window",0)},checked:!e.values.randomize_delivery}),i.jsx(n.Input,{type:"radio",label:"Yes",...e.getFieldProps("randomize_delivery"),onChange:async()=>await e.setFieldValue("randomize_delivery",!0),checked:e.values.randomize_delivery})]}),e.values.randomize_delivery&&i.jsx(n.Input,{type:"number",inputMode:"numeric",min:0,label:"Delivery delay window",labelClassName:"u-off-screen",help:"Time in minutes",...e.getFieldProps("deliver_delay_window"),error:e.touched.deliver_delay_window&&e.errors.deliver_delay_window?e.errors.deliver_delay_window:void 0}),i.jsxs("div",{className:"form-buttons",children:[i.jsx(n.Button,{type:"button",appearance:"base",onClick:d,children:"Cancel"}),i.jsx(n.ConfirmationButton,{type:"button",confirmationModalProps:{title:"Downgrading kernel and restarting instance",children:i.jsx("p",{children:"Are you sure? This action will downgrade the kernel and restart the instance."}),confirmButtonLabel:"Downgrade and Restart",confirmButtonAppearance:"negative",confirmButtonLoading:s,confirmButtonDisabled:s,onConfirm:b},children:"Downgrade and Restart"}),i.jsx(n.ConfirmationButton,{type:"button",appearance:"negative",confirmationModalProps:{title:"Downgrading kernel",children:i.jsx("p",{children:"Are you sure? This action will downgrade the kernel."}),confirmButtonLabel:"Downgrade",confirmButtonAppearance:"negative",confirmButtonLoading:s,confirmButtonDisabled:s,onConfirm:()=>e.handleSubmit()},children:"Downgrade kernel"})]})]})};export{ee as default};
