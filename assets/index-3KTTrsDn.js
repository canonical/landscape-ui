import{r as u,j as i,e as P,d as N,G as y}from"./index-CNSDWj8Q.js";import{S as A,E as S}from"./SelectAllButton-DqKWLeLb.js";import{a as I}from"./useUsns-dCIdMk13.js";import"./ExpandableTableFooter-DEy5-E1E.js";import"./constants-CDnVvJTb.js";import"./InstancesPageActions-DL7_pmR1.js";import"./index-D-YBZSy_.js";import"./NoData-6ZK9sV5u.js";import"./TablePagination-CFXNvqsZ.js";import"./TableFilterChips-06YfpJdc.js";import"./useFetchOld-BAAs34Op.js";import"./PageParamFilter-ChSwlZqZ.js";import"./TableFilter-2AKF5NjJ.js";import"./formikErrors-Bw8iTXYS.js";import"./ResponsiveTable-BXalKviy.js";import"./ListTitle-BUruUKn1.js";import"./StaticLink-BEYCGcPv.js";import"./TruncatedCell-BMum6DLZ.js";import"./Truncated-Dtg97i8C.js";import"./useExpandableRow-B4jhRgod.js";import"./index-CySvbr4l.js";import"./TextConfirmationModal-q88mH05g.js";import"./InfoGrid-3w5mqARw.js";import"./InfoItem-Bt7JBIPo.js";const B="_hidden_vofak_1",E={hidden:B},H=({lastPackageIndex:e,loading:t,showToggle:r})=>({column:o,row:{index:l}})=>{const n={};return(r&&l===0||t&&l===e)&&(o.id==="checkbox"?n.colSpan=5:(n.className=E.hidden,n["aria-hidden"]=!0)),n},M=(e,t,r)=>[...e.slice(t?-1:e.length),...e,...e.slice(r?-1:e.length)],v=(e,t)=>{const r=new Set(e),o=t.filter(({id:l})=>!r.has(l)).length;return o===0?"unchecked":o===t.length?"checked":"indeterminate"},D=({excludedPackages:e,instance:t,onExcludedPackagesChange:r,onLimitChange:o,packages:l,packagesCount:n,packagesLoading:p})=>{const d=e.find(({id:s})=>s===t.id)?.exclude_packages??[],g=u.useMemo(()=>{const s=new Set(l.map(({id:a})=>a));return d.length>0&&d.some(a=>!s.has(a))},[d.length,l]),h=u.useMemo(()=>M(l,g,p),[l,g,p]),x=()=>{const s=l.map(({id:a})=>a);r(e.map(({id:a,exclude_packages:m})=>a!==t.id?{id:a,exclude_packages:m}:{id:a,exclude_packages:m.length<s.length?s:[]}))},j=s=>{r(e.map(({id:a,exclude_packages:m})=>a!==t.id?{id:a,exclude_packages:m}:{id:a,exclude_packages:m.includes(s)?m.filter(_=>_!==s):[...m,s]}))},C=v(d,l),k=u.useMemo(()=>[{accessor:"checkbox",className:"checkbox-column",Header:i.jsx(N.CheckboxInput,{inline:!0,label:i.jsx("span",{className:"u-off-screen",children:"Toggle all packages"}),disabled:h.length===0,checked:C==="checked",indeterminate:C==="indeterminate",onChange:x}),Cell:({row:{index:s,original:a}})=>p&&s===h.length-1?i.jsx(P,{}):s===0&&g?i.jsx(A,{count:n-d.length,itemName:{plural:"packages",singular:"package"},onClick:()=>{r(e.map(({id:m,exclude_packages:_})=>({id:m,exclude_packages:m!==t.id?_:[]})))},totalCount:n}):i.jsx(N.CheckboxInput,{inline:!0,label:i.jsxs("span",{className:"u-off-screen",children:["Toggle ",a.name," package"]}),checked:!d.includes(a.id),onChange:()=>{j(a.id)}})},{accessor:"name",Header:"Name"},{accessor:"current_version",Header:"Current version"},{accessor:"available_version",Header:"New version"},{accessor:"summary",Header:"Details"}],[h.length,p,d.length]);return p&&!l.length?i.jsx(P,{}):i.jsx(S,{columns:k,data:h,itemCount:l.length,itemNames:{plural:"packages",singular:"package"},onLimitChange:o,totalCount:n,title:i.jsxs("p",{className:"p-heading--4",children:["Packages affected on ",i.jsx("b",{children:t.title})]}),getCellProps:H({lastPackageIndex:h.length-1,loading:p,showToggle:g})})},R="_nameColumn_1ojym_7",L="_expanded_1ojym_11",$="_expandButton_1ojym_29",G="_hidden_1ojym_38",O="_innerTable_1ojym_42",Q="_row_1ojym_46",b={nameColumn:R,expanded:L,expandButton:$,hidden:G,innerTable:O,row:Q},q=e=>({column:t,row:{index:r}})=>{const o={};return e>-1&&e===r-1?t.id==="title"?(o.colSpan=2,e>-1&&e===r-1&&(o.className=b.innerTable)):(o.className=b.hidden,o["aria-hidden"]=!0):t.id==="title"?o.role="rowheader":t.id==="upgrades"&&(o["aria-label"]="Affected packages",o.className=e===r?b.expanded:b.row),o},pe=({excludedPackages:e,instances:t,onExcludedPackagesChange:r})=>{const[o,l]=u.useState(5),[n,p]=u.useState(-1),[d,g]=u.useState([]),[h,x]=u.useState(0),j=u.useRef(0),C=u.useRef(-1),{getInstancePackagesQuery:k}=I(),{data:s,isLoading:a}=k({instance_id:t[n]?.id,limit:5,offset:h,upgrade:!0},{enabled:n>-1});u.useEffect(()=>{s&&(j.current=s.data.count,h!==C.current?(C.current=h,g(c=>[...c,...s.data.results])):(C.current=h,g(c=>[...c.slice(0,-1*s.data.results.length),...s.data.results])))},[s]);const m=c=>{x(0),g([]),p(f=>f===c?-1:f>-1&&f<c?c-1:c)},_=u.useMemo(()=>n>-1?[...t.slice(0,n+1),...t.slice(n,o)]:t.slice(0,o),[t,o,n]),w=u.useMemo(()=>[{accessor:"title",className:b.nameColumn,Header:"Name",Cell:({row:{index:c,original:f}})=>n===-1||c!==n+1?f.title:i.jsx(D,{excludedPackages:e,instance:f,onExcludedPackagesChange:r,onLimitChange:()=>{x(T=>T+5)},packages:d,packagesCount:j.current,packagesLoading:a})},{accessor:"upgrades",Header:"Affected packages",Cell:({row:{index:c,original:f}})=>i.jsx(N.Button,{type:"button",className:y("p-accordion__tab",b.expandButton),"aria-expanded":n===c,onClick:()=>{m(c)},children:null})}],[e,n,a,d,_.length]);return i.jsx(S,{columns:w,data:_,getCellProps:q(n),itemNames:{plural:"instances",singular:"instance"},onLimitChange:()=>{l(c=>c+5)},totalCount:t.length})};export{pe as default};
