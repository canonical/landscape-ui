const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-DnxCIu9O.js","assets/index-CNSDWj8Q.js","assets/index-CoB-_C5O.css","assets/useRoles-DYJzr0u4.js","assets/useFetchOld-BAAs34Op.js","assets/SidePanelFormButtons-DIizKTix.js","assets/SidePanelFormButtons.module-CcPyiogC.js","assets/SidePanelFormButtons-DP4HE5AU.css","assets/formikErrors-Bw8iTXYS.js","assets/PageMain-C8MVZwda.js","assets/PageMain-C_v2-kHh.css","assets/constants-CDnVvJTb.js","assets/TruncatedCell-BMum6DLZ.js","assets/Truncated-Dtg97i8C.js","assets/Truncated-uqJp6ujM.css","assets/TruncatedCell-DraJKZqh.css","assets/ResponsiveTable-BXalKviy.js","assets/ResponsiveTable-DsN8RVSX.css"])))=>i.map(i=>d[i]);
import{r as p,j as o,d as v,y as k,z as M,x as j,B,k as $,H as y,h as C,U as V,a4 as Q,w as H,e as A,p as z,E as U,_ as I}from"./index-CNSDWj8Q.js";import{P as Y,a as q,b as J}from"./PageMain-C8MVZwda.js";import{u as w}from"./useRoles-DYJzr0u4.js";import{L as K}from"./constants-CDnVvJTb.js";import{T as _}from"./TruncatedCell-BMum6DLZ.js";import{S as W}from"./SidePanelFormButtons-DIizKTix.js";import{R as X}from"./ResponsiveTable-BXalKviy.js";const E=s=>s.reduce((e,{global:r,name:a,title:l})=>{if(a==="RemoveComputerFromAccessGroup")return e;const n=/view/i.test(a)?"view":"manage",i=a==="AddComputerToAccessGroup"?"access group":l.replace(/(view|manage) /i,"").replace(/computer/i,"instance"),c=e.find(({label:d})=>d===i)||{global:r,label:i,values:{manage:"",view:""}};return c.values[n]=a,[...e.filter(({label:d})=>d!==i),c]},[]),Z=s=>{const e={maxDepth:0,options:s.filter(r=>r.parent==="").map(({name:r,title:a})=>({children:[],depth:0,label:a,parents:[],value:r}))};for(;e.maxDepth>=0;){const r=e.options.filter(({depth:l})=>l===e.maxDepth);e.maxDepth++;const a=s.filter(({parent:l})=>r.some(({value:n})=>n===l));if(a.length===0)break;for(const{name:l,parent:n,title:i}of a){const c=r.find(({value:t})=>t===n);if(!c)continue;const d=[n,...c.parents];e.options.push({children:[],depth:e.maxDepth,label:i,parents:d,value:l});for(const t of d)e.options.filter(({value:u})=>u===t)[0].children.push(l)}}return e.options},T=(s,e,r)=>r.filter(a=>a.depth===e).filter(({value:a})=>s.includes(a))[0].value,ee=s=>s.sort((e,r)=>{if(e.children.includes(r.value))return-1;if(r.children.includes(e.value))return 1;for(let a=0;a<Math.min(e.depth,r.depth);a++){const l=T(e.parents,a,s),n=T(r.parents,a,s);if(l!==n)return l.localeCompare(n)}return e.value.localeCompare(r.value)}),se=(s,e)=>{const r=Math.max(...e.map(({depth:l})=>l)),a=s;if(s.length>0)for(let l=0;l<r;l++){const n=e.filter(({depth:i})=>i===l).filter(({value:i})=>s.includes(i));for(const i of n)if(i.children.every(c=>s.includes(c))){const c=s.filter(d=>!i.children.includes(d));s.splice(0,s.length,...c)}}return a},ne="_container_1huj5_1",ae="_checkboxColumn_1huj5_7",R={container:ne,checkboxColumn:ae},S=({description:s,onPermissionChange:e,options:r,permissions:a,title:l})=>{const n=p.useMemo(()=>r.sort((t,u)=>t.values.view===""&&u.values.view!==""?-1:t.values.view!==""&&u.values.view===""?1:t.label.localeCompare(u.label)),[r]),i=t=>t.values.view===""||a.includes(r.filter(({label:u})=>u===t.label)[0]?.values.manage),c=(t,u)=>{a.includes(t.values[u])?e(a.filter(m=>m!==t.values[u])):e(u==="view"?[...a,t.values.view]:t.values.view!==""&&!a.includes(t.values.view)?[...a,t.values.manage,t.values.view]:[...a,t.values.manage])},d=p.useMemo(()=>[{accessor:"label",Header:"Property",Cell:({row:t})=>t.original.label.replace(/^\w/,u=>u.toUpperCase())},{accessor:"view",className:R.checkboxColumn,Header:"View",Cell:({row:t})=>o.jsx(v.CheckboxInput,{inline:!0,label:o.jsx("span",{className:"u-off-screen",children:`View ${t.original.label}`}),name:"permissions",value:t.original.values.view,disabled:i(t.original),checked:t.original.values.view===""||a.includes(t.original.values.view),onChange:()=>{c(t.original,"view")}})},{accessor:"manage",className:R.checkboxColumn,Header:"Manage",Cell:({row:t})=>o.jsx(v.CheckboxInput,{inline:!0,label:o.jsx("span",{className:"u-off-screen",children:`Manage ${t.original.label}`}),name:"permissions",value:t.original.values.manage,disabled:t.original.values.manage==="",checked:a.includes(t.original.values.manage),onChange:()=>{c(t.original,"manage")}})}],[n,a.length]);return o.jsxs("div",{className:R.container,children:[o.jsx("p",{className:"p-heading--5 u-no-margin--bottom",children:l}),o.jsx("p",{className:"p-text--small u-text--muted",children:s}),o.jsx(v.ModularTable,{columns:d,data:n,getHeaderProps:()=>({className:"u-text--muted"})})]})},te=1.5,oe=({accessGroupOptions:s,accessGroups:e,onAccessGroupChange:r})=>{const a=(n,i)=>{if(e.includes(n.value)||e.some(c=>n.children.includes(c)))r(e.filter(c=>![n.value,...n.children,...n.parents].includes(c)));else{const c=[...e,n.value,...n.children];for(let d=n.depth-1;d>=0;d--){const t=i.filter(({depth:u})=>u===d).find(({value:u})=>n.parents.includes(u));if(t&&t.children.every(u=>c.includes(u)))c.push(t.value);else break}r(c)}},l=n=>n.some(i=>e.includes(i))&&n.some(i=>!e.includes(i));return o.jsxs(o.Fragment,{children:[o.jsx("p",{className:"p-heading--5 u-no-margin--bottom",children:"Access Groups"}),s.map((n,i,c)=>o.jsx("div",{style:{marginLeft:`${te*n.depth}rem`},children:o.jsx(v.CheckboxInput,{label:n.label,labelClassName:"u-no-margin",name:"access_groups",checked:e.includes(n.value),indeterminate:l(n.children),onChange:()=>{a(n,c)}},n.value)},n.value))]})},re=(s,e,r,a)=>{const l=s.permissions.filter(m=>a.find(({global:x,values:h})=>x&&(h.manage===m||h.view===m))),n=s.permissions.filter(m=>!l.includes(m)),i=n.filter(m=>!e.permissions.includes(m));i.includes("AddComputerToAccessGroup")&&i.push("RemoveComputerFromAccessGroup"),l.length>0&&i.push(...l);const c=e.permissions.filter(m=>!n.includes(m));c.includes("AddComputerToAccessGroup")&&c.push("RemoveComputerFromAccessGroup");const d=se(s.accessGroups,r),t=d.filter(m=>!e.access_groups.includes(m)),u=e.access_groups.filter(m=>!d.includes(m));return{accessGroupsToAdd:t,accessGroupsToRemove:u,permissionsToAdd:i,permissionsToRemove:c}},ie=(s,e,r,a,l)=>{const{addAccessGroups:n,addPermissions:i,removeAccessGroups:c,removePermissions:d}=l,t={},{accessGroupsToAdd:u,accessGroupsToRemove:m,permissionsToAdd:x,permissionsToRemove:h}=re(s,e,r,a);return u.length>0&&(t.addAccessGroupsPromise=n({name:e.name,access_groups:u})),m.length>0&&(t.removeAccessGroupsPromise=c({name:e.name,access_groups:m})),h.length>0&&(t.removePermissionsPromise=d({name:e.name,permissions:h})),x.length>0&&(t.addPermissionsPromise=i({name:e.name,permissions:x})),t},le=(s,e,r)=>{const a=[...s.access_groups,...s.access_groups.flatMap(i=>e.find(({value:c})=>c===i)?.children||[])],l=s.global_permissions?[...s.permissions,...s.global_permissions]:s.permissions,n=[...new Set([...l,...r.filter(({values:i})=>l.includes(i.manage)).map(({values:i})=>i.view)])];return{accessGroups:a,permissions:n}},ce={accessGroups:[],permissions:[]},ue=$().shape({accessGroups:y().of(C()),permissions:y().of(C())}),de=({role:s})=>{const e=k(),{notify:r}=M(),{closeSidePanel:a}=j(),{addPermissionsToRoleQuery:l,addAccessGroupsToRoleQuery:n,getAccessGroupQuery:i,getPermissionsQuery:c,removeAccessGroupsFromRoleQuery:d,removePermissionsFromRoleQuery:t}=w(),{data:u}=c(),m=u?E(u.data):[],{data:x}=i(),h=x?ee(Z(x.data)):[],{mutateAsync:N}=l,{mutateAsync:D}=n,{mutateAsync:F}=d,{mutateAsync:L}=t,f=B({initialValues:ce,validationSchema:ue,onSubmit:async g=>{const b=ie(g,s,h,m,{addAccessGroups:D,addPermissions:N,removeAccessGroups:F,removePermissions:L});if(!Object.values(b).some(Boolean)){a();return}try{b.addPermissionsPromise&&b.removePermissionsPromise?(await Promise.all(Object.entries(b).filter(([P,O])=>P!=="addPermissionsPromise"&&O).map(([,P])=>P)),await b.addPermissionsPromise):await Promise.all(Object.values(b).filter(Boolean)),a(),r.success({title:"Role changes have been saved",message:`You modified the role '${s.name}'`})}catch(P){e(P)}}});return p.useEffect(()=>{f.setValues(le(s,h,m))},[s,h.length]),o.jsxs(v.Form,{onSubmit:f.handleSubmit,noValidate:!0,children:[o.jsx(S,{description:"These permissions are for managing the account as a whole. They are not limited to the specified access groups, but instead apply globally.",onPermissionChange:g=>f.setFieldValue("permissions",g),options:m.filter(({global:g})=>g),permissions:f.values.permissions,title:"Global permissions"}),o.jsx(S,{description:"These permissions only apply to selected access groups.",onPermissionChange:g=>f.setFieldValue("permissions",g),options:m.filter(({global:g})=>!g),permissions:f.values.permissions,title:"Permissions"}),o.jsx(oe,{accessGroupOptions:h,accessGroups:f.values.accessGroups,onAccessGroupChange:g=>{f.setFieldValue("accessGroups",g)}}),o.jsx(W,{submitButtonDisabled:f.isSubmitting,submitButtonText:"Save changes"})]})},me=({role:s})=>{const e=k(),{setSidePanelContent:r}=j(),{removeRoleQuery:a}=w(),{value:l,setTrue:n,setFalse:i}=V(),{mutateAsync:c,isPending:d}=a,t=async()=>{try{await c({name:s.name})}catch(m){e(m)}finally{i()}},u=()=>{r(`Edit "${s.name}" role`,o.jsx(p.Suspense,{fallback:o.jsx(A,{}),children:o.jsx(de,{role:s})}))};return o.jsxs(o.Fragment,{children:[o.jsx(Q,{toggleAriaLabel:`${s.name} role actions`,actions:[{icon:"edit",label:"Edit","aria-label":`Edit "${s.group}" role`,onClick:u}],destructiveActions:[{icon:"delete",label:"Remove","aria-label":`Remove "${s.group}" role`,onClick:n}]}),l&&o.jsx(v.ConfirmationModal,{close:i,title:`Remove '${s.name}' role`,confirmButtonLabel:"Remove",confirmButtonAppearance:"negative",confirmButtonDisabled:d,confirmButtonLoading:d,onConfirm:t,children:o.jsxs("p",{children:[o.jsx("span",{children:`This will remove '${s.name}' role.`}),s.persons.length>0&&o.jsxs(o.Fragment,{children:[o.jsx("br",{}),o.jsx("strong",{children:`This will affect ${s.persons.length} ${H(s.persons.length,"administrator")}.`})]})]})})]})},G=(s,e,r)=>{const a=s.global_permissions?[...s.permissions,...s.global_permissions]:s.permissions,l=[...new Set(a.filter(n=>r==="manage"?!/(view|remove)/i.test(n):!/(remove)/i.test(n)&&!e.find(({values:i})=>i.manage===n&&!i.view)).map(n=>e.find(({values:i})=>r==="manage"?i.manage===n:i.view===n||i.manage===n)?.label??""))];return l.length===0?"":l.length!==e.filter(({values:n})=>!!n[r]).length?l.map((n,i)=>i>0?n:n.replace(/^\w/,c=>c.toUpperCase())).join(", "):"All properties"},pe=s=>({column:e,row:{index:r}})=>{const a={};return s&&s.rowIndex===r&&s.columnId===e.id&&(a.className="expandedCell"),e.id==="name"?a.role="rowheader":e.id==="persons"?a["aria-label"]="Administrators":e.id==="view"?a["aria-label"]="View permissions":e.id==="manage"?a["aria-label"]="Manage permissions":e.id==="actions"&&(a["aria-label"]="Actions"),a},ge=s=>({index:e})=>{const r={};return s===e&&(r.className="expandedRow"),r},he=s=>e=>{e&&(s.current=[...e.querySelectorAll("tbody tr")])},fe="_administrators_18216_1",ve={administrators:fe},xe=({roleList:s})=>{const[e,r]=p.useState(null),a=p.useRef([]);z({current:e?a.current[e.rowIndex]:null},()=>{r(null)});const{getPermissionsQuery:l}=w(),{data:n}=l(),i=n?E(n.data):[],c=p.useMemo(()=>s,[s]),d=p.useMemo(()=>[{accessor:"name",Header:"Name"},{accessor:"persons",Header:"Administrators",className:ve.administrators,Cell:({row:t})=>t.original.persons.length},{accessor:"view",Header:"View",Cell:({row:{original:t,index:u}})=>o.jsx(_,{content:G(t,i,"view"),isExpanded:!!e&&e.rowIndex===u&&e.columnId==="view",onExpand:()=>{r({rowIndex:u,columnId:"view"})}})},{accessor:"manage",Header:"Manage",Cell:({row:{original:t,index:u}})=>o.jsx(_,{content:G(t,i,"manage"),isExpanded:e?.rowIndex===u&&e.columnId==="manage",onExpand:()=>{r({rowIndex:u,columnId:"manage"})}})},{...K,Cell:({row:t})=>t.original.name=="GlobalAdmin"?null:o.jsx(me,{role:t.original})}],[c,n,e]);return o.jsx("div",{ref:he(a),children:o.jsx(X,{columns:d,data:c,getCellProps:pe(e),getRowProps:ge(e?.rowIndex)})})},be=p.lazy(()=>I(()=>import("./index-DnxCIu9O.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17]))),Pe=()=>{const{setSidePanelContent:s}=j(),{getRolesQuery:e}=w(),{data:r,isLoading:a}=e();return o.jsxs(o.Fragment,{children:[a&&o.jsx(A,{}),!a&&(!r||!r.data.length)&&o.jsx(U,{title:"No roles found",body:o.jsxs(o.Fragment,{children:[o.jsx("p",{className:"u-no-margin--bottom",children:"You havenâ€™t added any roles yet."}),o.jsx("a",{href:"https://ubuntu.com/landscape/docs/administrators",target:"_blank",rel:"nofollow noopener noreferrer",children:"How to manage administrators in Landscape"})]}),cta:[o.jsx(v.Button,{type:"button",appearance:"positive",onClick:()=>{s("Add role",o.jsx(p.Suspense,{fallback:o.jsx(A,{}),children:o.jsx(be,{})}))},children:"Add role"},"add")]}),!a&&r&&r.data.length>0&&o.jsx(xe,{roleList:r.data})]})},Ae=p.lazy(()=>I(()=>import("./index-DnxCIu9O.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17]))),je=()=>{const{setSidePanelContent:s}=j(),e=()=>{s("Add Role",o.jsx(p.Suspense,{fallback:o.jsx(A,{}),children:o.jsx(Ae,{})}))};return o.jsxs(Y,{children:[o.jsx(q,{title:"Roles",actions:[o.jsx(v.Button,{type:"button",onClick:e,appearance:"positive",children:"Add role"},"add-role")]}),o.jsx(J,{children:o.jsx(Pe,{})})]})},ke=Object.freeze(Object.defineProperty({__proto__:null,default:je},Symbol.toStringTag,{value:"Module"}));export{oe as A,S as P,E as a,ee as b,Z as c,se as g,ke as i};
