import{e as P,l as L,r as y,j as e,g as r,o as T,k,h as D,p as H}from"./index-DiCHGiBf.js";import{u as N}from"./useAlerts-ztfhx6uc.js";import{P as z,a as R,b as V}from"./PageMain-SbAEQCyE.js";import{d as Q,s as j}from"./DistributionCard.module-CdGw1YvC.js";import{I as A}from"./InfoItem-BkJhF0SK.js";import{b as _}from"./output-BGPkZwlr.js";import{M as q}from"./MultiSelectField-Df_4RBPj.js";import{u as B}from"./formik.esm-Bu_XSuDa.js";import{c as U,b as W,a as Y}from"./index.esm-D13Ro0EO.js";import{a as E,b as g}from"./ApiCredentialsTables.module-eWLDdo1B.js";import"./InfoItem.module-BZ3tYMsb.js";import{u as G}from"./useInstances-Oo1w_jyO.js";import"./useFetchOld-Bq-hhBK7.js";import"./useMutation-GmxqXKvs.js";import"./useQuery-CpQuVpeO.js";import"./MultiSelectField.module-D1r8qo_i.js";import"./SidePanelFormButtons.module-DyBJG5lm.js";const M=(t,a)=>{const n=new Set(a);return t.filter(i=>!n.has(i))},I=({alert:t,availableTagOptions:a})=>{const n=P(),{notify:i}=L(),{associateAlert:d,disassociateAlert:h}=N(),m=y.useRef(null),{mutateAsync:p}=d,{mutateAsync:o}=h,b=t.all_computers?["All"]:t.tags,v=async({tags:l})=>{try{const c=M(t.tags,l),u=M(l,t.tags),w=l.includes("All"),$=t.all_computers&&!w;if(w)await p({name:t.alert_type,tags:void 0,all_computers:!0});else if($)await Promise.all([p({name:t.alert_type,tags:l.filter(f=>f!=="All"),all_computers:!1}),o({name:t.alert_type,all_computers:!0})]);else{const f=[];u.length>0&&f.push(p({name:t.alert_type,tags:u,all_computers:!1})),c.length>0&&f.push(o({name:t.alert_type,tags:c,all_computers:!1})),await Promise.all(f)}i.success({title:"Alert tags updated",message:`You changed ${t.label}'s tags`})}catch(c){n(c)}},s=B({initialValues:{tags:b},validationSchema:U().shape({tags:W().of(Y())}),onSubmit:v}),x=s.values.tags.includes("All")?a.filter(({value:l})=>l!=="All"):void 0,C=s.values.tags.includes("All")?a:a.filter(({value:l})=>s.values.tags.includes(l)),F=l=>{const c=l.some(({value:u})=>u==="All")?["All"]:l.map(({value:u})=>u);s.setValues({tags:c})};y.useEffect(()=>{var c,u;const l=(c=m.current)==null?void 0:c.querySelector(".multi-select__condensed-text");(u=l==null?void 0:l.textContent)!=null&&u.includes("All instances")&&(l.textContent="All instances")},[s.values.tags]);const S=()=>s.isSubmitting?!0:b.length===s.values.tags.length&&b.every(l=>s.values.tags.includes(l));return e.jsx(r.Form,{onSubmit:s.handleSubmit,noValidate:!0,children:e.jsx(q,{innerRef:m,required:!0,variant:"condensed",className:E.multiSelect,items:a,selectedItems:C,disabledItems:x,onItemsUpdate:F,placeholder:"Select tags",error:s.touched.tags&&typeof s.errors.tags=="string"?s.errors.tags:void 0,dropdownFooter:e.jsxs("div",{className:E.footer,children:[e.jsx(r.Button,{type:"button",dense:!0,small:!0,className:"u-no-margin--bottom",disabled:S(),onClick:()=>s.setFieldValue("tags",b),children:"Revert"}),e.jsx(r.Button,{type:"submit",dense:!0,small:!0,appearance:"positive",className:"u-no-margin--bottom",disabled:S(),children:"Save changes"})]})})})},J=t=>{const a={};switch(t.column.id){case"label":a.role="rowheader";break;case"subscribed":a["aria-label"]="Email";break;case"tags":a["aria-label"]="Tags";break;case"description":a["aria-label"]="Description";break}return a},K=({alerts:t,availableTagOptions:a})=>{const n=T("(min-width: 620px)"),i=P(),{unsubscribeQuery:d,subscribeQuery:h}=N(),{user:m}=k(),{mutateAsync:p}=h,{mutateAsync:o}=d,b=async s=>{const x=s.subscribed?o:p;try{await x({alert_type:s.alert_type})}catch(C){i(C)}},v=y.useMemo(()=>[{accessor:"label",className:g.nameColumn,Header:"Name"},{Header:e.jsxs("div",{className:g.noWrap,children:[e.jsx("span",{children:"Email "}),m&&e.jsx(r.Tooltip,{position:"btm-left",message:`Enabling email notifications will send alerts to ${m.email}, associated with your account`,children:e.jsx(r.Icon,{name:"help"})})]}),accessor:"subscribed",className:g.emailColumn,Cell:({row:s})=>e.jsx("div",{className:g.switch,children:e.jsx(r.Switch,{label:_(s.original.subscribed),defaultChecked:s.original.subscribed,onChange:()=>b(s.original)})})},{accessor:"tags",Header:"Enabled for",className:g.tags,Cell:({row:{original:s}})=>e.jsx(I,{alert:s,availableTagOptions:a})},{Header:"Description",accessor:"description",Cell:({row:{original:s}})=>e.jsx(e.Fragment,{children:s.description})}],[t]);return n?e.jsx(r.ModularTable,{columns:v,data:t,getCellProps:J,emptyMsg:"No data available"}):t.map((s,x)=>e.jsxs(r.Row,{className:D("u-no-padding--left u-no-padding--right",g.alertsWrapper),children:[e.jsx(r.Col,{size:2,small:2,children:e.jsx(A,{label:"Name",value:s.label})}),e.jsx(r.Col,{size:2,small:2,children:e.jsx(A,{label:"Email",value:e.jsx("div",{className:g.switch,children:e.jsx(r.Switch,{label:_(s.subscribed),defaultChecked:s.subscribed,onChange:()=>b(s)})})})}),e.jsx(r.Col,{size:2,small:2,children:e.jsx(A,{label:"Enabled for",value:e.jsx(I,{alert:s,availableTagOptions:a})})}),e.jsx(r.Col,{size:2,small:2,children:e.jsx(A,{label:"Description",value:s.description})})]},x))},X=({alerts:t,availableTagOptions:a})=>{const{user:n}=k(),i=n==null?void 0:n.accounts.find(d=>d.name===n.current_account);return e.jsx("div",{className:Q.item,children:e.jsxs("div",{className:j.card,children:[e.jsx("div",{className:j.header,children:e.jsx("p",{className:j.title,children:(i==null?void 0:i.title)||"Alerts"})}),e.jsx("div",{className:j.content,children:e.jsx(K,{alerts:t,availableTagOptions:a})})]})})},Z=()=>{const{getAlertsQuery:t}=N(),{getAllInstanceTagsQuery:a}=G(),{data:n}=a(),{data:i,isLoading:d}=t(),h=y.useMemo(()=>(i==null?void 0:i.data.filter(o=>!o.alert_type.toUpperCase().includes("LICENSE")))??[],[i]),m=(n==null?void 0:n.data.results.map(o=>({label:o,value:o,group:"Tags"})))??[],p=[{label:"All instances",value:"All"},...m];return e.jsxs(z,{children:[e.jsx(R,{title:"Alerts"}),e.jsxs(V,{children:[d&&e.jsx(H,{}),!d&&h&&e.jsx(X,{alerts:h,availableTagOptions:p})]})]})},he=Z;export{he as default};
