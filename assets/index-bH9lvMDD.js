import{B as k,C as $,o as E,r as d,H as N,j as t,d as u,q,y as D}from"./index-DdDZs9iJ.js";import{S as H}from"./SidePanelFormButtons-BSX-z9y0.js";import{u as O,T as R}from"./TagsAddConfirmationModal-DeGuJRDp.js";import{u as W}from"./useInstances-xzL-A-Ng.js";import"./SidePanelFormButtons.module-BuIu-Bem.js";const J=({selected:e})=>{const g=k(),{notify:p}=$(),{closeSidePanel:y}=E(),{addTagsToInstancesQuery:C,getAllInstanceTagsQuery:x}=W(),[n,r]=d.useState([]),{isFetchingProfileChanges:T,profileChangesCount:b,refetchProfileChanges:j}=O({instance_ids:e.map(s=>s.id),tags:n,limit:10},{enabled:!1}),{value:v,setFalse:w,setTrue:S}=N(),[l,L]=d.useState(""),{mutateAsync:B,isPending:m}=C,{data:c,isLoading:P}=x(),f=async()=>{var s;try{await B({query:e.map(({id:a})=>`id:${a}`).join(" OR "),tags:n}),y(),p.success({title:"Tags assigned",message:`Tags successfully assigned to ${D(e.length,`"${((s=e[0])==null?void 0:s.title)??""}" instance`,`${e.length} instances`)}`})}catch(a){g(a)}},A=async()=>{const s=await j();if(!s.isSuccess){g(s.error);return}s.data.data.count?S():await f()},o=(c==null?void 0:c.data.results.filter(s=>s.toLowerCase().includes(l.toLowerCase())))??[],M=()=>{o.every(s=>n.includes(s))?r([]):r(o)},F=d.useMemo(()=>[{accessor:"value",Header:t.jsxs(t.Fragment,{children:[t.jsx(u.CheckboxInput,{inline:!0,label:null,disabled:o.every(s=>e.every(a=>a.tags.includes(s))),checked:o.every(s=>n.includes(s)||e.every(a=>a.tags.includes(s))),indeterminate:o.some(s=>e.some(a=>!a.tags.includes(s)))&&o.some(s=>e.some(a=>a.tags.includes(s))),onChange:M}),"Name"]}),Cell:({row:{original:{value:s},index:a}})=>{const I=()=>{if(n.includes(s)){r(n.toSpliced(n.findIndex(i=>i==s),1));return}e.every(i=>i.tags.includes(s))||r([...n,s])};return t.jsx(u.CheckboxInput,{inline:!0,label:s,disabled:e.every(i=>i.tags.includes(s)),name:`tag-${a}`,checked:n.includes(s)||e.every(i=>i.tags.includes(s)),indeterminate:!n.includes(s)&&e.some(i=>i.tags.includes(s))&&e.some(i=>!i.tags.includes(s)),onChange:I})}}],[n,o]);if(P)return t.jsx(q,{});const h=o.map(s=>({value:s}));return t.jsxs(t.Fragment,{children:[t.jsx("p",{children:"Adding tags will associate the instance with the profiles that tag is linked to. This may change configurations on your instance."}),t.jsx(u.SearchBox,{value:l,onChange:s=>{L(s)}}),t.jsx(u.ModularTable,{emptyMsg:"No tags found",columns:F,data:[...h.filter(({value:s})=>s.toLowerCase().startsWith(l.toLowerCase())),...h.filter(({value:s})=>!s.toLowerCase().startsWith(l.toLowerCase()))]}),t.jsx(H,{onSubmit:A,submitButtonDisabled:!n.length,submitButtonLoading:m||T,submitButtonText:"Assign"}),v&&t.jsx(R,{instances:e,tags:n,onConfirm:f,confirmButtonLoading:m,close:w,profileChangesCount:b})]})};export{J as default};
