import{e as v,f as A,g as T,F as f,M as j,H as c,a9 as r,r as P,l as w,y as I,A as E,j as a,m as o,B as l}from"./index-oHELamW6.js";import{C as R}from"./CodeEditor-B3FMDmtk.js";import{S as V}from"./SidePanelFormButtons-CoDSai3y.js";import{u as _}from"./useRoles-D_--rcor.js";import{u as q,D,S as k}from"./ScriptFormAttachments-DNwCGvJU.js";import{j as B,i as N,r as L}from"./ScriptsTabs-C46F09dW.js";import"./index-BY2iVtCr.js";import"./SidePanelFormButtons.module-D2P5PizG.js";import"./AttachmentFile-C5ot_9D-.js";import"./TruncatedCell-DnlSOVwt.js";import"./HeaderWithSearch-BB_CpSjU.js";import"./SingleInstanceTabs.module-Cm1BYFZQ.js";const M=()=>{const i=v(),u=A(),{mutateAsync:m,isPending:h}=T({mutationKey:["scripts","create"],mutationFn:async p=>i.get("CreateScript",{params:p}),onSuccess:async()=>u.invalidateQueries({queryKey:["scripts"]})});return{createScript:m,isCreatingScript:h}},O={title:"",code:"",access_group:"",attachments:{first:null,second:null,third:null,fourth:null,fifth:null},attachmentsToRemove:[]},$=()=>f().shape({title:c().required("This field is required"),access_group:c().nullable(),code:c().test({name:"required",message:"This field is required",test:i=>!!i}),attachments:f().shape({first:r().nullable(),second:r().nullable(),third:r().nullable(),fourth:r().nullable(),fifth:r().nullable()}),attachmentsToRemove:j().of(c())}),ae=()=>{const i=P.useRef(null),{closeSidePanel:u}=w(),m=I(),{getAccessGroupQuery:h}=_(),{createScript:p}=M(),{createScriptAttachment:g}=q(),{data:d}=h(),b=((d==null?void 0:d.data)??[]).map(e=>({label:e.title,value:e.name})),S=[{label:"Select access group",value:""},...b],x=async e=>{const n=Object.values(e.attachments).filter(s=>s!==null);try{const s=await p(B(e));n.length&&await Promise.all(await N({attachments:n,createScriptAttachment:g,script_id:s.data.id})),u()}catch(s){m(s)}},t=E({initialValues:O,validationSchema:$(),onSubmit:x}),C=async({target:{files:e}})=>{if(!e)return;const[n]=e,s=t.setFieldValue("code",await n.text());if(t.values.title){await s;return}await Promise.all([t.setFieldValue("title",L(n.name)),s])},F=async e=>{await t.setFieldValue("code",e)},y=()=>{var e;return(e=i.current)==null?void 0:e.click()};return a.jsxs(o.Form,{onSubmit:t.handleSubmit,noValidate:!0,children:[a.jsx(o.Input,{type:"text",label:"Title",required:!0,...t.getFieldProps("title"),error:l(t,"title")}),a.jsx("input",{ref:i,className:"u-hide",type:"file",onChange:C}),a.jsx(R,{label:"Code",value:t.values.code,onChange:F,error:l(t,"code"),required:!0,defaultValue:D,headerContent:a.jsxs(o.Button,{className:"u-no-margin--bottom",appearance:"base",hasIcon:!0,onClick:y,type:"button",children:[a.jsx(o.Icon,{name:"upload"}),a.jsx("span",{children:"Populate from file"})]})}),a.jsx(o.Select,{label:"Access group",...t.getFieldProps("access_group"),options:S,error:l(t,"access_group")}),a.jsxs(a.Fragment,{children:[a.jsx("h5",{children:"List of attachments"}),a.jsx("p",{className:"u-text--muted",children:"Attachments that will be sent along with the script. You can attach up to 5 files, for a maximum of 1.00MB. Filenames must be unique. On the client, the attachments will be placed in the directory whose name is accessible through the environment variable LANDSCAPE_ATTACHMENTS. They'll be deleted once the script has been run."})]}),a.jsx(k,{attachments:t.values.attachments,attachmentsToRemove:t.values.attachmentsToRemove,getFileInputError:e=>l(t,["attachments",e]),initialAttachments:[],onFileInputChange:e=>async n=>{var s;return t.setFieldValue(`attachments.${e}`,((s=n.target.files)==null?void 0:s[0])??null)},onInitialAttachmentDelete:e=>{t.setFieldValue("attachmentsToRemove",[...t.values.attachmentsToRemove,e])}}),a.jsx(V,{submitButtonText:"Create script",submitButtonDisabled:t.isSubmitting})]})};export{ae as default};
