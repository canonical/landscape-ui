import{r as h,j as i,d as j,q as y,p as U}from"./index-D0u57Pxb.js";import{a as F}from"./useUsns-BIle7D_N.js";import{S as k,E as R}from"./SelectAllButton-C7hMBDrE.js";import"./ResponsiveButtons-DvOauLaL.js";import"./ExpandableTableFooter-Chpi2972.js";const x=(e,t)=>{const r=new Set(t.computers.map(n=>n.id));return e.some(({exclude_packages:n,id:s})=>r.has(s)&&!n.includes(t.id))},N=(e,t,r)=>{const n=new Set(t.computers.map(({id:s})=>s));return e.map(({id:s,exclude_packages:a})=>{if(!n.has(s))return{id:s,exclude_packages:a};const u=a.filter(o=>o!==t.id);return{id:s,exclude_packages:r?[...u,t.id]:u}})},q=(e,t)=>N(e,t,x(e,t)),E=e=>({column:t,row:r})=>{const n={};return e&&r.index===0?t.id==="checkbox"?n.colSpan=4:(n.style=n.style||{},n.style.display="none",n["aria-hidden"]=!0):t.id==="checkbox"?n["aria-label"]=`Toggle ${r.original.name} instance`:t.id==="title"?n.role="rowheader":t.id==="current_version"?n["aria-label"]="Current version":t.id==="available_version"&&(n["aria-label"]="New version"),n},z=(e,t,r)=>!e.find(({id:n})=>n===t)?.exclude_packages.includes(r),L=(e,t,r)=>e.map(({id:n,exclude_packages:s})=>n!==t?{id:n,exclude_packages:s}:{id:n,exclude_packages:s.includes(r)?s.filter(a=>a!==a):[...s,r]}),D=({excludePackages:e,instances:t,limit:r,pkg:n})=>{const s=new Set(n.computers.map(({id:l})=>l)),a=t.filter(({id:l})=>s.has(l)).slice(0,r),u=new Set(e.filter(({exclude_packages:l})=>l.includes(n.id)).map(({id:l})=>l)),o=a.filter(({id:l})=>!u.has(l)).length;return o===0?"unchecked":o===a.length?"checked":"indeterminate"},Q=(e,t)=>{const r=new Set(t.computers.map(({id:n})=>n));return e.filter(({exclude_packages:n,id:s})=>r.has(s)&&!n.includes(t.id)).length},$=(e,t)=>N(e,t,!1),O=({currentPackage:e,excludedPackages:t,limit:r,onExcludedPackagesChange:n,onLimitChange:s,selectedInstances:a})=>{const u=new Set(e.computers.map(({id:d})=>d)),o=t.filter(({exclude_packages:d})=>d.includes(e.id)),l=h.useMemo(()=>{const d=new Set(a.slice(0,r).map(({id:m})=>m));return o.some(({id:m})=>!d.has(m))},[o.length,a.length,r]),_=h.useMemo(()=>[...a.slice(0,l?1:0),...a.filter(({id:d})=>u.has(d)).slice(0,r)],[u,r,a,l]),g=()=>{n(q(t,e))},b=d=>{n(L(t,d,e.id))},p=()=>{n($(t,e))},C=D({excludePackages:t,instances:a,limit:r,pkg:e}),S=h.useMemo(()=>[{accessor:"checkbox",className:"checkbox-column",Header:i.jsx(j.CheckboxInput,{inline:!0,label:i.jsx("span",{className:"u-off-screen",children:"Toggle all instances"}),checked:C==="checked",indeterminate:C==="indeterminate",onChange:g}),Cell:({row:{index:d,original:m}})=>l&&d===0?i.jsx(k,{count:Q(t,e),itemName:{plural:"instances",singular:"instance"},onClick:p,totalCount:u.size}):i.jsx(j.CheckboxInput,{inline:!0,label:i.jsxs("span",{className:"u-off-screen",children:["Toggle ",m.title," instance"]}),checked:z(t,m.id,e.id),onChange:()=>b(m.id)})},{accessor:"title",Header:"Name"},{accessor:"current_version",Header:"Current version",Cell:({row:{original:d}})=>i.jsx(i.Fragment,{children:e.computers.find(({id:m})=>m===d.id)?.current_version})},{accessor:"available_version",Header:"New version",Cell:({row:{original:d}})=>i.jsx(i.Fragment,{children:e.computers.find(({id:m})=>m===d.id)?.available_version})}],[e,t,_]);return i.jsx(R,{columns:S,data:_,getCellProps:E(l),itemNames:{plural:"instances",singular:"instance"},onLimitChange:s,totalCount:u.size,title:i.jsxs("p",{className:"p-heading--4",children:["Instances affected by ",i.jsx("b",{children:e.name})]})})},v={name:"",computers:[],summary:"",id:-1},V="_nameColumn_guorc_1",G="_expanded_guorc_5",K="_expandButton_guorc_23",P="_hidden_guorc_32",Y="_innerTable_guorc_36",J="_row_guorc_40",w={nameColumn:V,expanded:G,expandButton:K,hidden:P,innerTable:Y,row:J},W=({expandedRow:e,isPackagesLoading:t,lastPackageIndex:r,showSelectAllButton:n})=>({column:s,row:{index:a,original:u}})=>{const o={};return n&&a===0||t&&a===r||e>-1&&e===a-1?s.id==="name"?(o.colSpan=3,e>-1&&e===a-1&&(o.className=w.innerTable)):(o.className=w.hidden,o["aria-hidden"]=!0):s.id==="checkbox"?o["aria-label"]=`Toggle ${u.name} package`:s.id==="name"?o.role="rowheader":s.id==="version"?o["aria-label"]="Current version":s.id==="new_version"?o["aria-label"]="New version":s.id==="computers.upgrades"&&(o["aria-label"]="Affected instances",o.className=e===a?w.expanded:w.row),o},X=(e,t)=>t.some(r=>x(e,r)),Z=(e,t)=>t.length>0&&t.every(({computers:r,id:n})=>e.filter(({id:s})=>r.some(a=>a.id===s)).every(({exclude_packages:s})=>!s.includes(n))),ee=(e,t,r)=>t.reduce((n,s)=>N(n,s,r),e),te=({expandedRow:e,isPackagesLoading:t,packages:r,showSelectAllButton:n})=>{const s=e>-1?e+1:0;return[...[v].slice(n?0:1),...r.slice(0,s||r.length),...r.slice(s?s-1:r.length),...[v].slice(t?0:1)]},A=(e,t)=>{const r=new Set(t.computers.map(({id:n})=>n));return e.every(({exclude_packages:n,id:s})=>!r.has(s)||!n.includes(t.id))},ne=({excludedPackages:e,hasNoMoreItems:t,instances:r,isPackagesLoading:n,onExcludedPackagesChange:s,onTableLimitChange:a,packages:u,totalPackageCount:o})=>{const[l,_]=h.useState(-1),[g,b]=h.useState(5),p=new Set(e.flatMap(({exclude_packages:c})=>c)),C=h.useMemo(()=>{const c=new Set(u.map(({id:f})=>f));for(const f of p)if(!c.has(f))return!0;return!1},[u.length,p]),S=h.useMemo(()=>te({expandedRow:l,isPackagesLoading:n,packages:u,showSelectAllButton:C}),[u,l,n,C]),d=X(e,u),m=()=>{s(ee(e,u,d))},M=c=>{s(q(e,c))},B=c=>{b(5),_(f=>f===c?-1:c>f&&f!==-1?c-1:c)},T=Z(e,u),H=h.useMemo(()=>[{accessor:"checkbox",className:"checkbox-column",Header:i.jsx(j.CheckboxInput,{inline:!0,label:i.jsx("span",{className:"u-off-screen",children:"Toggle all packages"}),disabled:S.length===0,checked:T,indeterminate:!T&&d,onChange:m}),Cell:({row:{original:c}})=>i.jsx(j.CheckboxInput,{inline:!0,label:i.jsxs("span",{className:"u-off-screen",children:["Toggle ",c.name," package"]}),checked:A(e,c),indeterminate:!A(e,c)&&x(e,c),onChange:()=>{M(c)}})},{accessor:"name",className:w.nameColumn,Header:"Package name",Cell:({row:{index:c,original:f}})=>C&&c===0?i.jsx(k,{count:o-p.size,itemName:{plural:"packages",singular:"package"},onClick:()=>{s(e.map(({id:I})=>({id:I,exclude_packages:[]})))},totalCount:o}):l!==-1&&l===c-1?i.jsx(O,{currentPackage:f,excludedPackages:e,limit:g,onExcludedPackagesChange:s,onLimitChange:()=>{b(I=>I+5)},selectedInstances:r}):n&&c===S.length-1?i.jsx(y,{}):f.name},{accessor:"computers.upgrades",Header:"Affected instances",Cell:({row:{index:c,original:f}})=>i.jsx(j.Button,{type:"button",className:U("p-accordion__tab",w.expandButton),"aria-expanded":l===c,onClick:()=>{B(c)},children:new Set(f.computers.map(({id:I})=>I)).size})}],[S,r,e,l,n,g]);return i.jsx(R,{columns:H,data:S,itemCount:u.length,hasNoMoreItems:t,getCellProps:W({expandedRow:l,isPackagesLoading:n,lastPackageIndex:S.length-1,showSelectAllButton:C}),itemNames:{plural:"packages",singular:"package"},onLimitChange:a,totalCount:o})},ce=({excludedPackages:e,instances:t,onExcludedPackagesChange:r})=>{const[n,s]=h.useState([]),[a,u]=h.useState(0),o=h.useRef(0),l=h.useRef(-1),{getPackagesQuery:_}=F(),{data:g,isLoading:b}=_({query:`id:${t.map(({id:p})=>p).join(" OR id:")}`,upgrade:!0,limit:5,offset:a});return h.useEffect(()=>{!g||a===l.current||(o.current=g.data.count,l.current=a,s(p=>[...p,...g.data.results]))},[g]),b&&!n.length?i.jsx(y,{}):i.jsx(ne,{excludedPackages:e,hasNoMoreItems:g?.data.next===null,instances:t,isPackagesLoading:b,onExcludedPackagesChange:r,onTableLimitChange:()=>u(p=>p+5),packages:n,totalPackageCount:o.current})};export{ce as default};
