import{r as n,i as l,e as K,f as Q,I as h,w as T,j as s,g as o,x as g,D as x,y as E}from"./index-Bwv21umG.js";import{u as W}from"./formik.esm-1BnXfl6u.js";import{h as i}from"./moment-Cl4UOzQZ.js";import{c as Y,a,d as C,b as k}from"./index.esm-BNxcffbw.js";import{P as j,b as V,c as q,C as P,d as J,a as X,A as Z,U as ee}from"./series-C0ZkCcVV.js";import{S as re}from"./SidePanelFormButtons-CYk-y39P.js";import{u as te}from"./useDistributions-CGeBMjrn.js";import{u as se}from"./useGPGKeys-CU7PDPqO.js";import{u as oe}from"./index-BWaaMR55.js";import{t as A}from"./tests-DFnZqbNV.js";import"./SidePanelFormButtons.module-DyBJG5lm.js";import"./useFetchOld-CLIuhBjP.js";import"./useMutation-J8RvGgz_.js";import"./useQuery-Dt9EUPCN.js";import"./PageMain-e3QUHu3w.js";import"./InfoItem-BANgRWDI.js";import"./InfoItem.module-BZ3tYMsb.js";import"./index-Dy05G2j8.js";import"./useConfirm-C8SdOzvQ.js";import"./useInstances-zDlqbUFb.js";import"./moment-Cws0WeZv.js";import"./TablePagination.module-DLVph1Z1.js";import"./TablePagination-B0poA3Ik.js";import"./usePageParams-DNXnArI_.js";import"./EmptyState-BVaENBo3.js";import"./SearchHelpPopup-CFFPaTtC.js";import"./DistributionCard.module-CdGw1YvC.js";const ie=u=>u.replace(/\/[^\\/@]*@/,"/"),ae=({distribution:u,ctaText:D="Add mirror"})=>{const[v,p]=n.useState(l),[I,F]=n.useState([]),O=K(),{closeSidePanel:N}=Q(),{getGPGKeysQuery:R}=se(),{createSeriesQuery:U,getRepoInfo:w}=oe(),{getDistributionsQuery:G}=te(),{data:b}=G({},{enabled:!u}),_=(b==null?void 0:b.data)??[],{data:y}=R(),{mutateAsync:M,isLoading:$}=U,S=(y==null?void 0:y.data)??[],L=_.map(({name:r})=>({label:r,value:r})),e=W({initialValues:{type:"ubuntu",name:"",distribution:"",mirror_series:"",mirror_uri:"",gpg_key:"",pockets:[],components:[],architectures:[],include_udeb:!1,hasPockets:!1,snapshotDate:i().format(h)},validationSchema:Y().shape({distribution:a().required("This field is required."),type:a().required("This field is required."),name:a().required("This field is required.").test({test:A.test,message:A.message}).test({test:(r,t)=>!!t.parent.distribution,message:"First select the distribution."}).test({params:{distribution:u,distributions:_},test:(r,t)=>t.parent.distribution?!(u?u.series.map(({name:m})=>m):_.filter(({name:m})=>m===t.parent.distribution)[0].series.map(({name:m})=>m)).includes(r):!0,message:"It must be unique within series within the distribution."}),hasPockets:C(),mirror_series:a(),mirror_gpg_key:a(),mirror_uri:a().when("hasPockets",(r,t)=>r[0]?t.nonNullable().required("This field is required."):t),snapshotDate:a().when("type",(r,t)=>r[0]==="ubuntu-snapshot"?t.required("This field is required.").test({test:d=>i(d).isBetween(i(g),i()),message:`The date must be after ${i(g).format(T)} and not in the future.`}):t),gpg_key:a().when("hasPockets",(r,t)=>r[0]?t.required("This field is required."):t),pockets:k().of(a()),components:k().of(a()).when("hasPockets",(r,t)=>r[0]?t.min(1,"Please choose at least one component."):t),architectures:k().of(a()).when("hasPockets",(r,t)=>r[0]?t.min(1,"Please choose at least one architecture."):t),include_udeb:C().required()}),onSubmit:async r=>{try{await M({name:r.name,distribution:r.distribution,mirror_series:r.mirror_series,gpg_key:r.gpg_key,include_udeb:r.include_udeb,mirror_uri:r.mirror_uri,components:r.components,pockets:r.pockets,architectures:r.architectures,mirror_gpg_key:r.mirror_gpg_key}),N()}catch(t){O(t)}}}),B=r=>{e.setFieldValue("snapshotDate",r.target.value),e.setFieldValue("mirror_uri",`${x}/${i(r.target.value).format(E)}`)};n.useEffect(()=>{u&&e.setFieldValue("distribution",u.name)},[u]),n.useEffect(()=>{var r;e.values.type==="third-party"?(e.setFieldValue("pockets",j.thirdParty),e.setFieldValue("components",V.thirdParty),e.setFieldValue("architectures",q.thirdParty)):(e.setFieldValue("pockets",j.ubuntu),e.setFieldValue("components",V.ubuntu),e.setFieldValue("architectures",q.ubuntu),e.values.type==="ubuntu"&&!((r=e.values.mirror_uri)!=null&&r.startsWith(l))&&(e.setFieldValue("mirror_uri",l),p(l)))},[e.values.type]);const H=r=>{e.setFieldValue("type",r.target.value),r.target.value==="ubuntu"?(e.setFieldValue("mirror_uri",l),p(l)):r.target.value==="third-party"?(e.setFieldValue("mirror_uri",""),p("")):r.target.value==="ubuntu-snapshot"&&(e.setFieldValue("mirror_uri",`${x}/${i(e.values.snapshotDate).format(E)}`),p(l))},z=r=>{const t=r.target.value;e.setFieldValue("mirror_series",t),!(!t||e.values.name)&&e.setFieldValue("name",e.values.type==="ubuntu-snapshot"?`${t}-snapshot-${i(e.values.snapshotDate).format(h)}`:t)};n.useEffect(()=>{if(e.values.pockets.length===0||!e.values.pockets[0]){e.setFieldValue("hasPockets",!1);return}e.setFieldValue("hasPockets",!0)},[e.values.pockets.length,e.values.pockets[0]]);const{data:f}=w({mirror_uri:ie(v)},{enabled:!!v}),c=f==null?void 0:f.data;return n.useEffect(()=>{var r;if(!c){F([]);return}c.ubuntu?(r=e.values.mirror_uri)!=null&&r.startsWith(l)&&e.setFieldValue("type","ubuntu"):e.setFieldValue("type","third-party"),F(c.repos.map(({description:t,repo:d})=>({label:c.ubuntu?t:d,value:d})))},[c]),s.jsxs(o.Form,{onSubmit:e.handleSubmit,noValidate:!0,children:[s.jsx(o.Select,{label:"Type",required:!0,options:[{label:"Ubuntu Archive",value:"ubuntu"},{label:"Ubuntu Snapshot",value:"ubuntu-snapshot"},{label:"Third party",value:"third-party"}],...e.getFieldProps("type"),onChange:H,error:e.touched.type&&e.errors.type?e.errors.type:void 0}),e.values.type!=="ubuntu-snapshot"&&s.jsx(o.Input,{type:"text",label:"Mirror URI",required:e.values.hasPockets,help:"Absolute URL or file path",...e.getFieldProps("mirror_uri"),onBlur:r=>{p(r.target.value)},error:e.touched.mirror_uri&&e.errors.mirror_uri?e.errors.mirror_uri:void 0}),e.values.type==="ubuntu-snapshot"&&s.jsx(o.Input,{type:"date",min:i(g).format(h),max:i().format(h),label:"Snapshot date",required:!0,...e.getFieldProps("snapshotDate"),onChange:B,error:e.touched.snapshotDate&&e.errors.snapshotDate?e.errors.snapshotDate:void 0,help:`Starting from ${i(g).format(T)} in dd.mm.yyyy format`}),!u&&s.jsx(o.Select,{label:"Distribution",required:!0,options:[{label:"Select distribution",value:""},...L],...e.getFieldProps("distribution"),error:e.touched.distribution&&e.errors.distribution?e.errors.distribution:void 0}),s.jsxs(o.Row,{className:"u-no-padding",children:[s.jsx(o.Col,{size:6,medium:3,small:2,children:s.jsx(o.Select,{label:"Mirror series",options:[{label:"Select series",value:""},...I],...e.getFieldProps("mirror_series"),onChange:z,error:e.touched.mirror_series&&e.errors.mirror_series?e.errors.mirror_series:void 0})}),s.jsx(o.Col,{size:6,medium:3,small:2,children:s.jsx(o.Input,{type:"text",label:"Series name",required:!0,...e.getFieldProps("name"),error:e.touched.name&&e.errors.name?e.errors.name:void 0})})]}),s.jsxs(o.Row,{className:"u-no-padding",children:[e.values.type!=="ubuntu-snapshot"&&s.jsx(o.Col,{size:6,medium:3,small:2,children:s.jsx(o.Select,{label:"Mirror GPG key",options:[{label:"Select mirror GPG key",value:""},...S.filter(({has_secret:r})=>!r).map(({name:r})=>({label:r,value:r}))],...e.getFieldProps("mirror_gpg_key"),error:e.touched.mirror_gpg_key&&e.errors.mirror_gpg_key?e.errors.mirror_gpg_key:void 0,help:"If none is given, the stock Ubuntu archive one will be used."})}),s.jsx(o.Col,{size:6,medium:3,small:2,children:s.jsx(o.Select,{label:"GPG key",required:e.values.hasPockets,options:[{label:"Select GPG key",value:""},...S.filter(({has_secret:r})=>r).map(({name:r})=>({label:r,value:r}))],...e.getFieldProps("gpg_key"),error:e.touched.gpg_key&&e.errors.gpg_key?e.errors.gpg_key:void 0})})]}),["ubuntu","ubuntu-snapshot"].includes(e.values.type)&&s.jsxs(s.Fragment,{children:[s.jsx(P,{label:"Pockets",style:{marginTop:"1.5rem"},options:J,...e.getFieldProps("pockets"),onChange:r=>{e.setFieldValue("pockets",r)},error:e.touched.pockets&&e.errors.pockets?e.errors.pockets:void 0}),s.jsx(P,{label:"Components",required:e.values.hasPockets,options:X,...e.getFieldProps("components"),onChange:r=>{e.setFieldValue("components",r)},error:e.touched.components&&e.errors.components?e.errors.components:void 0}),s.jsx(P,{label:"Architectures",required:e.values.hasPockets,options:Z,...e.getFieldProps("architectures"),onChange:r=>{e.setFieldValue("architectures",r)},error:e.touched.architectures&&e.errors.architectures?e.errors.architectures:void 0})]}),e.values.type==="third-party"&&s.jsxs(s.Fragment,{children:[s.jsx(o.Input,{type:"text",label:"Pockets",placeholder:"E.g. releases, security, etc.",...e.getFieldProps("pockets"),value:e.values.pockets.join(","),onChange:r=>{e.setFieldValue("pockets",r.target.value.replace(/\s/g,"").split(","))},error:e.touched.pockets&&e.errors.pockets?e.errors.pockets:void 0,help:"List the pocket names separated by commas"}),s.jsx(o.Input,{type:"text",label:"Components",required:e.values.hasPockets,placeholder:"E.g. main, universe, etc.",...e.getFieldProps("components"),value:e.values.components.join(","),onChange:r=>{e.setFieldValue("components",r.target.value.replace(/\s/g,"").split(","))},error:e.touched.components&&e.errors.components?e.errors.components:void 0,help:"List the component names separated by commas"}),s.jsx(o.Input,{type:"text",label:"Architectures",required:e.values.hasPockets,placeholder:"E.g. amd64, riscv, etc.",...e.getFieldProps("architectures"),value:e.values.architectures.join(","),onChange:r=>{e.setFieldValue("architectures",r.target.value.replace(/\s/g,"").split(","))},error:e.touched.architectures&&e.errors.architectures?e.errors.architectures:void 0,help:"List the architectures separated by commas"})]}),s.jsx(ee,{formik:e}),s.jsx(re,{submitButtonDisabled:$,submitButtonText:D})]})},Ie=ae;export{Ie as default};
