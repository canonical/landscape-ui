import{r as g,aB as G,l as V,j as t,d as i,T as B,H as M,o as d,W as T,K as L,av as O,z as D,B as k,y as U,C as z,i as W,aJ as v,F as m,aK as x}from"./index-BniO5lih.js";import{M as _}from"./MultiSelectField-CyRN2UEo.js";import{S as H}from"./SidePanelFormButtons-bG-J2X_B.js";import{u as q}from"./useGetInstances-CYwqcOV3.js";import{u as Z}from"./useGetTags-CPW6gZD2.js";import{u as K}from"./useRunScript-D_kGy3aT.js";import{D as J}from"./DeliveryBlock-DRG9B7L0.js";import"./SidePanelFormButtons.module-CcPyiogC.js";import"./RadioGroup-RQ17m8oI.js";const Q="_pagination_svwl5_1",X={pagination:Q},Y=({instances:a})=>{const[r,p]=g.useState(G),[o,h]=g.useState(V),y=g.useMemo(()=>[{Header:"Instance",Cell:({row:{original:c}})=>c.title}],[]),e=(r-1)*o,l=a.slice(e,e+o);return t.jsxs(t.Fragment,{children:[t.jsx(i.ModularTable,{columns:y,data:l}),t.jsx(B,{className:X.pagination,currentItemCount:l.length,currentPage:r,pageSize:o,paginate:p,setPageSize:h,totalItems:a.length})]})},ee={deliver_after:"",deliver_immediately:!0,instanceIds:[],queryType:"tags",tags:[],username:"root",time_limit:300},se=M().shape({...L,access_group:d(),instanceIds:T().of(O()).when("queryType",{is:"ids",then:a=>a.min(1,"At least one instance is required.")}),queryType:d().required("This field is required."),tags:T().of(d()).when("queryType",{is:"tags",then:a=>a.min(1,"At least one tag is required.")}),username:d().required("This field is required.")}),te="_instanceSelectionContainer_f2qf2_1",ae="_radioGroup_f2qf2_9",F={instanceSelectionContainer:te,radioGroup:ae},pe=({script:a})=>{const r=D(),{notify:p}=k(),{closeSidePanel:o}=U(),{runScript:h}=K(),e=z({initialValues:ee,onSubmit:async s=>{const n={query:s.queryType==="ids"?`id:${s.instanceIds.join(" OR id:")}`:`tag:${s.tags.join(" OR tag:")}`,script_id:a.id,username:s.username,time_limit:Number(s.time_limit),deliver_after:s.deliver_immediately?void 0:x(s.deliver_after).toISOString().replace(/\.\d+(?=Z$)/,"")};s.deliver_immediately||(n.deliver_after=x(s.deliver_after).toISOString().replace(/\.\d+(?=Z$)/,""));try{await h(n),o(),p.success({message:`"${a.title}" script queued to execute successfully`,title:"Script execution queued"})}catch(A){r(A)}},validateOnMount:!0,validationSchema:se}),[l,c]=g.useState(!1),{tags:j,isGettingTags:C}=Z(),{instances:$,isGettingInstances:P}=q({query:`access-group-recursive:${a.access_group}`}),{instances:E,isGettingInstances:S,instancesError:f}=q({query:`access-group-recursive:${a.access_group} ${e.values.tags.map(s=>`tag:${s}`).join(" OR ")}`},void 0,{enabled:!!e.values.tags.length});if(C||P)return t.jsx(W,{});f&&r(f);const R=()=>{c(!1)},N=()=>{c(!0)},I=j.map(s=>({label:s,value:s}))??[],u=($.filter(s=>v(s).scripts)??[]).map(({title:s,id:n})=>({label:s,value:n})),w=E.filter(s=>v(s).scripts)??[],b=()=>{e.values.queryType=="tags"?N():e.handleSubmit()};return t.jsxs(t.Fragment,{children:[t.jsxs(i.Form,{onSubmit:b,noValidate:!0,children:[t.jsx("p",{className:"u-no-margin--bottom",children:"Select instances by:"}),t.jsx("div",{className:"is-required",children:t.jsxs("div",{children:[t.jsxs("div",{className:F.radioGroup,children:[t.jsx(i.Input,{type:"radio",label:"Tags",...e.getFieldProps("queryType"),onChange:async s=>{e.getFieldProps("queryType").onChange(s),await Promise.all([e.setFieldValue("tags",[]),e.setFieldTouched("tags",!1),e.setFieldValue("instanceIds",[]),e.setFieldTouched("instanceIds",!1)])},value:"tags",checked:e.values.queryType==="tags"}),t.jsx(i.Input,{type:"radio",label:"Instance names",...e.getFieldProps("queryType"),value:"ids",checked:e.values.queryType==="ids",disabled:!u.length,help:!u.length&&"There are no available instances in this script's access group."})]}),t.jsxs("div",{className:F.instanceSelectionContainer,children:[e.values.queryType==="tags"&&t.jsx(_,{placeholder:"Select tags",variant:"condensed",label:"Tags",labelClassName:"u-off-screen",required:!0,...e.getFieldProps("tags"),items:I,selectedItems:I.filter(({value:s})=>e.values.tags.includes(s)),onItemsUpdate:async s=>{e.setFieldValue("tags",s.map(({value:n})=>n)),e.setFieldTouched("tags",!0,!1)},error:m(e,"tags")}),e.values.queryType==="ids"&&t.jsx(_,{placeholder:"Select instances",variant:"condensed",label:"Instances",labelClassName:"u-off-screen",required:!0,...e.getFieldProps("instanceIds"),items:u,selectedItems:u.filter(({value:s})=>e.values.instanceIds.includes(s)),onItemsUpdate:async s=>{e.setFieldValue("instanceIds",s.map(({value:n})=>n)),e.setFieldTouched("instanceIds",!0,!1)},error:m(e,"instanceIds")})]})]})}),t.jsxs(i.Row,{className:"u-no-padding--left u-no-padding--right",children:[t.jsx(i.Col,{size:6,children:t.jsx(i.Input,{type:"text",label:"Run as user",autoComplete:"off",required:!0,...e.getFieldProps("username"),error:m(e,"username")})}),t.jsx(i.Col,{size:6,children:t.jsx(i.Input,{type:"text",label:"Time limit (seconds)",autoComplete:"off",required:!0,...e.getFieldProps("time_limit"),error:m(e,"time_limit")})})]}),t.jsx(J,{formik:e}),t.jsx(H,{submitButtonDisabled:e.isSubmitting||!e.isValid,submitButtonText:"Run script",onSubmit:b})]}),l&&t.jsxs(i.ConfirmationModal,{title:`Run ${a.title} script on ${e.values.tags.length>1?`${e.values.tags.length} tags`:`${e.values.tags[0]} tag`}`,confirmButtonLabel:"Run script",onConfirm:()=>{e.handleSubmit()},confirmButtonDisabled:e.isSubmitting||!!f||S,confirmButtonLoading:S,close:R,confirmButtonAppearance:"positive",children:[t.jsxs("p",{children:["This script will run on the following instances, which are associated with the selected"," ",e.values.tags.length==1?"tag":"tags","."]}),t.jsx(Y,{instances:w})]})]})};export{pe as default};
