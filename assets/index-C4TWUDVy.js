import{j as e,r as A,B as O,am as H,d as c,p as b,q as K,x as k,D as $,M as B,P as T,C as Y,o as z,F as J,G as q,y as V}from"./index-W6vPPLJL.js";import{C as Q}from"./CodeEditor-4xlU4EX1.js";import{S as W}from"./SidePanelFormButtons-m4F_GuJu.js";import{u as X}from"./useAddAutoinstallFile-CCZ7rkUk.js";import{b as P}from"./EmployeeGroupIdentityIssuerList-DIwWn67C.js";import{u as Z}from"./useUpdateEmployeeGroups-CvQDfmGU.js";import{D as G}from"./downshift.esm-B2lnDmUO.js";import"./index-DIg8oi2_.js";import"./SidePanelFormButtons.module-BuIu-Bem.js";import"./HeaderWithSearch-DvpCwkwh.js";import"./SidePanelTablePagination-SHTK27t-.js";const ee=200,te=(t,l)=>{const r=t.toLowerCase(),d=l.toLowerCase(),o=r.indexOf(d);return o>=0?e.jsxs(e.Fragment,{children:[t.substring(0,o),e.jsx("strong",{children:t.substring(o,o+l.length)}),t.substring(o+l.length)]}):t},ne="_container_cafe2_1",se="_suggestionsContainer_cafe2_5",ie="_pointer_cafe2_12",ae="_highlighted_cafe2_17",le="_selectedContainer_cafe2_21",f={container:ne,suggestionsContainer:se,pointer:ie,highlighted:ae,selectedContainer:le},oe=({selectedItem:t,setSelectedItem:l})=>{const[r,d]=A.useState(""),[o,u]=A.useState(!1),[h,C]=A.useState(""),j=O(),{autoinstallFiles:S,autoinstallFilesCount:y,isFetching:p}=P({limit:20,offset:0,with_groups:!1,search:r},{enabled:!!r}),_=S.filter(i=>t?.id!==i.id),N=()=>{l(null)},n=()=>{u(!1)},g=()=>{C(""),d("")},w=()=>{h.length>2?u(!0):u(!1)},v=i=>{C(i),i.length>2&&d(i)},E=H(()=>{try{w()}catch(i){j(i)}},ee),I=i=>{l(i),g()},D=i=>{i&&(I(i),u(!1))},s=i=>{i.key==="Escape"?i.currentTarget.blur():E()},m=!o&&h.length<3?"Min 3. characters":y===0&&r&&!p?`No autoinstall files found by "${r}"`:null;return e.jsxs("div",{className:f.container,children:[e.jsx(G,{onSelect:D,itemToString:()=>"",isOpen:o,children:({getInputProps:i,getItemProps:U,getMenuProps:R,highlightedIndex:M})=>e.jsxs("div",{className:"p-autocomplete",children:[e.jsx(c.SearchBox,{...i(),placeholder:"Search for available autoinstall files",className:"u-no-margin--bottom",shouldRefocusAfterReset:!0,externallyControlled:!0,autocomplete:"off",value:h,onChange:v,onClear:g,onBlur:n,onFocus:w,onKeyUp:s}),m?e.jsx("span",{className:"p-form-help-text",children:m}):null,o&&(_.length>0||p)?e.jsx("ul",{className:b("p-list p-card--highlighted u-no-padding u-no-margin--bottom p-autocomplete__suggestions",f.suggestionsContainer),...R(),children:p?e.jsx(K,{}):_.map((F,L)=>e.jsxs("li",{className:b("p-list__item",f.pointer,{[f.highlighted]:M===L}),...U({item:F,index:L}),children:[e.jsx("div",{className:"u-truncate","data-testid":"dropdownElement",children:te(F.filename,r)}),e.jsx("div",{children:e.jsxs("small",{className:"u-text-muted",children:["Last edited:"," ",k(F.last_modified_at).format($)]})})]},F.filename))}):null]})}),e.jsx("ul",{className:"p-list p-autocomplete__result-list u-no-margin--bottom",children:t?e.jsxs("li",{className:b("p-autocomplete__result p-list__item p-card u-no-margin--bottom",f.selectedContainer),children:[e.jsxs("div",{children:[e.jsx("div",{children:t.filename}),e.jsxs("small",{className:"u-text-muted p-text--small",children:["Last edited:"," ",k(t.last_modified_at).format($)]})]}),e.jsx(c.Button,{type:"button",appearance:"link",className:"u-no-margin--bottom",onClick:N,children:e.jsx(c.Icon,{name:c.ICONS.delete})})]},t.filename):null})]})},re="_form_1nqr5_1",ce="_code_1nqr5_7",de="_inputContainer_1nqr5_11",ue="_input_1nqr5_11",he="_inputDescription_1nqr5_20",x={form:re,code:ce,inputContainer:de,input:ue,inputDescription:he},pe=[{label:"Select",value:""},{label:"Add new autoinstall file",value:"new"},{label:"Assign existing autoinstall file",value:"assign-existing"},{label:"Inherit default autoinstall file",value:"inherit"}],me={dropdownChoice:"",filename:"",contents:"",selectedAutoinstallFile:null},ge=B().shape({dropdownChoice:T().required("This field is required"),filename:T().when("dropdownChoice",{is:"new",then:t=>t.required("This field is required")}),contents:T().when("dropdownChoice",{is:"new",then:t=>t.required("This field is required")}),selectedAutoinstallFile:B().when("dropdownChoice",{is:"assign-existing",then:t=>t.required("This field is required"),otherwise:t=>t.nullable()})}),Ne=({employeeGroups:t,clearSelectedGroups:l})=>{const r=A.useRef(null),d=O(),{notify:o}=Y(),{closeSidePanel:u}=z(),{updateEmployeeGroups:h,isUpdatingEmployeeGroups:C}=Z(),{addAutoinstallFile:j,isAutoinstallFileAdding:S}=X(),y=t.reduce((s,{employee_count:a=0})=>s+(a??0),0),p=s=>{o.success({title:`Successfully reassigned ${s} to ${V(t.length,`${t[0]?.name??"1"} group`,`${t.length} groups`)}.`,message:`Autoinstall file assigned to ${y} employees${V(t.length,` in ${t[0]?.name??"1"} group`,` across ${t.length} groups`)}.`})},_=async(s,a)=>{try{const{data:m}=await j({contents:s,filename:a});await h(t.map(i=>({autoinstall_file:m,id:i.id,priority:i.priority}))),u(),p(a),l&&l()}catch(m){d(m)}},N=async s=>{try{await h(t.map(a=>({autoinstall_file:s,id:a.id,priority:a.priority}))),u(),p(s.filename),l&&l()}catch(a){d(a)}},n=J({initialValues:me,validationSchema:ge,onSubmit:async s=>{s.dropdownChoice==="new"?await _(s.contents,s.filename):s.selectedAutoinstallFile&&await N(s.selectedAutoinstallFile)}}),{autoinstallFiles:g}=P({is_default:!0},{enabled:n.values.dropdownChoice==="inherit"}),w=g.length>0?g[0]:null,v=async({target:{files:s}})=>{if(!s)return;const[a]=s;await n.setFieldValue("contents",await a.text()),!n.values.filename&&await n.setFieldValue("filename",a.name)},E=async s=>{await n.setFieldValue("contents",s)},I=()=>{r.current?.click()},D=n.values.dropdownChoice==="assign-existing"&&n.values.selectedAutoinstallFile||n.values.dropdownChoice==="inherit";return e.jsxs(c.Form,{className:x.form,noValidate:!0,onSubmit:n.handleSubmit,children:[e.jsx("p",{children:"This file will only be used during the initial setup of the instance. Changing this autoinstall file will not affect instances that are already registered in landscape."}),e.jsx(c.Select,{label:"Autoinstall file",options:pe,error:q(n,"dropdownChoice"),required:!0,...n.getFieldProps("dropdownChoice"),onChange:async s=>{n.resetForm(),n.getFieldProps("autoinstallFile").onChange(s)}}),n.values.dropdownChoice==="assign-existing"&&e.jsx(oe,{selectedItem:n.values.selectedAutoinstallFile,setSelectedItem:async s=>await n.setFieldValue("selectedAutoinstallFile",s)}),D&&e.jsx(c.CodeSnippet,{className:b({[x.code]:n.values.dropdownChoice==="assign-existing"&&n.values.selectedAutoinstallFile}),blocks:[{title:"Code preview",code:n.values.dropdownChoice==="assign-existing"?n.values.selectedAutoinstallFile?.contents:w?.contents,wrapLines:!0,appearance:"numbered"}]}),n.values.dropdownChoice==="new"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:x.inputContainer,children:[e.jsx(c.Input,{wrapperClassName:x.input,type:"text",label:"File name",...n.getFieldProps("filename"),error:q(n,"filename"),required:!0}),e.jsx("span",{className:x.inputDescription,children:".yaml"})]}),e.jsx("input",{ref:r,className:"u-hide",type:"file",accept:".yaml",onChange:v}),e.jsx(Q,{label:"Code",value:n.values.contents,onChange:E,error:q(n,"contents"),required:!0,language:"yaml",headerContent:e.jsxs(c.Button,{className:"u-no-margin--bottom",appearance:"base",hasIcon:!0,onClick:I,type:"button",children:[e.jsx(c.Icon,{name:"upload"}),e.jsx("span",{children:"Populate from file"})]})})]}),e.jsx(W,{submitButtonDisabled:C||S||n.values.dropdownChoice==="assign-existing"&&!n.values.selectedAutoinstallFile,submitButtonText:"Assign"})]})};export{Ne as default};
