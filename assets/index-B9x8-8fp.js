import{j as e,h as $,k as V,e as q,l as D,f as E,g as d}from"./index-DXs1haZl.js";import{u as G}from"./formik.esm-CwYJvJSO.js";import{h as B}from"./moment-Cl4UOzQZ.js";import{S as L}from"./SidePanelFormButtons-Dtg_vQ52.js";import{I as U}from"./InfoItem-BQPTGwVs.js";import{u as Y}from"./index-BU3-Vm4G.js";import{a as O,I as j}from"./useUsns-B3b7Nlk8.js";import{m as w}from"./moment-BF0UQeMK.js";import{c as Q,a as I,f as R,d as N}from"./index.esm-FGh7VWBq.js";import"./SidePanelFormButtons.module-DyBJG5lm.js";import"./InfoItem.module-BZ3tYMsb.js";import"./TablePagination.module-DLVph1Z1.js";import"./TablePagination-DZ07rvb4.js";import"./usePageParams-BJqFm8Ol.js";import"./EmptyState-BYL1pVz2.js";import"./SearchHelpPopup-CCs3NejY.js";import"./useFetchOld-DWTVWZGf.js";import"./useMutation-CoMMCR6r.js";import"./useQuery-DPA9mHwu.js";import"./useConfirm-C9Ai5vPv.js";import"./NoData-BmTO_w1O.js";const K="_bold_nffzr_1",h={bold:K},M=({packageCount:r,securityUpgradePackageCount:a,totalUpgradePackageCount:l})=>{const t=l-a,n=r-l;return e.jsxs("div",{children:[e.jsx("span",{children:"You selected "}),e.jsx("span",{className:h.bold,children:r}),e.jsx("span",{children:" packages. This will:"}),e.jsxs("ul",{className:$({"u-no-margin--bottom":n>0}),children:[a>0&&e.jsxs("li",{children:[e.jsx("span",{children:"apply "}),e.jsx("span",{className:h.bold,children:a}),e.jsx("span",{children:a===1?" security upgrade":" security upgrades"})]}),t>0&&e.jsxs("li",{children:[e.jsx("span",{children:"apply "}),e.jsx("span",{className:h.bold,children:t}),e.jsx("span",{children:t===1?" regular upgrade":" regular upgrades"})]})]}),n>0&&e.jsxs("p",{children:[e.jsx("span",{children:"No upgrades for "}),e.jsx("span",{className:h.bold,children:n}),e.jsx("span",{children:n===1?" package needed.":" packages needed."})]})]})},Z={deliver_after:"",deliver_delay_window:0,deliver_immediately:!0,randomize_delivery:!1,version:""},H=r=>Q({deliver_after:I().when("deliver_immediately",{is:!1,then:a=>a.required("This field is required").test({test:l=>w(l).isValid()&&w(l).isAfter(w()),message:"You have to enter a valid date and time in the future"})}),deliver_delay_window:R().when("randomize_delivery",{is:!0,then:a=>a.min(0,"Delivery delay must be greater than or equal to 0")}),deliver_immediately:N(),randomize_delivery:N(),version:I().test({name:"required",message:"This field is required",params:{action:r},test:a=>r!=="downgrade"||!!a})}),J=(r,a)=>{const l=r.length>1?"selected packages":`${r[0].name} Package`;return`This will ${a==="hold"?"disable":"enable"} upgrades for the ${l}. It will ${a==="hold"?"not ":""}be eligible to upgrade to the latest available version.`},W=(r,a,l)=>{const t=a.length>1?`${a.length} packages`:`${a[0].name} Package`,n={downgrade:"downgrade",hold:"held",remove:"uninstall",unhold:"unheld",upgrade:"upgrade"},v={downgrade:`be downgraded to ${l} version`,hold:"disable its upgrades",remove:"be uninstalled",unhold:"enable its upgrades",upgrade:"be upgraded"},_=`You queued ${t} to ${r!=="remove"?"be ":""}${n[r]}.`,y=`${t} ${a.length>1?"are":"is"} queued in Activities and will ${v[r]}.`;return{title:_,message:y}},X="_bold_c3q8d_1",ee="_radioGroup_c3q8d_5",ae="_marginTop_c3q8d_10",m={bold:X,radioGroup:ee,marginTop:ae},re=({action:r,packages:a})=>{const{instanceId:l,childInstanceId:t}=V(),n=q(),{notify:v}=D(),{openActivityDetails:_}=Y(),{closeSidePanel:y}=E(),{downgradePackageVersionQuery:A,getDowngradePackageVersionsQuery:k,upgradePackagesQuery:P,packagesActionQuery:S}=O(),c=Number(t??l),{data:b}=k({instanceId:c,packageName:a[0].name},{enabled:r==="downgrade"}),u=(b==null?void 0:b.data.results.map(({version:i})=>({label:i,value:i})))??[];u.unshift({label:"Select version",value:""});const f=a.filter(({status:i,available_version:p})=>i==="security"||i==="installed"&&p).map(({name:i})=>i),x=a.filter(({status:i})=>i==="security").length,{mutateAsync:F}=A,{mutateAsync:T}=P,{mutateAsync:z}=S,C=async i=>{const p={deliver_after:i.deliver_immediately?void 0:`${i.deliver_after}:00Z`,deliver_delay_window:i.randomize_delivery?i.deliver_delay_window:void 0};let g;r==="upgrade"?g=T({...p,packages:f,query:`id:${c}`}):r==="downgrade"?g=F({instanceId:c,package_name:a[0].name,package_version:i.version}):g=z({...p,action:r,computer_ids:[c],package_ids:a.map(({id:o})=>o)});try{const{data:o}=await g;y(),v.success({...W(r,a,i.version),actions:[{label:"Details",onClick:()=>_(o)}]})}catch(o){n(o)}},s=G({initialValues:Z,validationSchema:H(r),onSubmit:C});return e.jsxs(d.Form,{onSubmit:s.handleSubmit,noValidate:!0,children:[r==="downgrade"&&e.jsxs(d.Row,{className:"u-no-padding--left u-no-padding--right",children:[e.jsx(d.Col,{size:6,children:e.jsx(U,{label:"Current version",value:a[0].current_version})}),e.jsx(d.Col,{size:6,children:u.length>1?e.jsx(d.Select,{label:"New version",className:"",labelClassName:"p-text--small u-text--muted u-no-margin--bottom p-text--small-caps",...s.getFieldProps("version"),options:u}):e.jsx("p",{children:"No downgrade versions"})})]}),r==="upgrade"&&(a.length!==f.length||x>0)&&e.jsx(M,{packageCount:a.length,securityUpgradePackageCount:x,totalUpgradePackageCount:f.length}),(r==="hold"||r==="unhold")&&e.jsx("p",{children:J(a,r)}),["remove","upgrade","hold","unhold"].includes(r)&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:m.bold,children:"Delivery time"}),e.jsxs("div",{className:m.radioGroup,children:[e.jsx(d.Input,{type:"radio",label:"As soon as possible",name:"deliver_immediately",checked:s.values.deliver_immediately,onChange:()=>{s.setFieldValue("deliver_immediately",!0)}}),e.jsx(d.Input,{type:"radio",label:"Scheduled",name:"deliver_immediately",checked:!s.values.deliver_immediately,onChange:()=>{s.setFieldValue("deliver_immediately",!1),s.setFieldValue("deliver_after",B().utc(!0).add(1,"minute").toISOString().slice(0,16))}})]}),!s.values.deliver_immediately&&e.jsx(d.Input,{type:"datetime-local",label:"Deliver after",labelClassName:"u-off-screen",...s.getFieldProps("deliver_after"),error:s.touched.deliver_after&&s.errors.deliver_after?s.errors.deliver_after:void 0}),e.jsx("span",{className:$(m.bold,m.marginTop),children:"Randomise delivery over a time window"}),e.jsxs("div",{className:m.radioGroup,children:[e.jsx(d.Input,{type:"radio",label:"No",name:"randomize_delivery",checked:!s.values.randomize_delivery,onChange:async()=>{await s.setFieldValue("randomize_delivery",!1),await s.setFieldValue("deliver_delay_window",0)}}),e.jsx(d.Input,{type:"radio",label:"Yes",name:"randomize_delivery",checked:s.values.randomize_delivery,onChange:()=>s.setFieldValue("randomize_delivery",!0)})]}),s.values.randomize_delivery&&e.jsx(d.Input,{type:"number",inputMode:"numeric",min:0,label:"Delivery delay window",labelClassName:"u-off-screen",help:"Time in minutes",...s.getFieldProps("deliver_delay_window"),error:s.touched.deliver_delay_window&&s.errors.deliver_delay_window?s.errors.deliver_delay_window:void 0})]}),(r!=="downgrade"||u.length>1)&&e.jsx(L,{submitButtonDisabled:s.isSubmitting,submitButtonText:j[r].label,submitButtonAppearance:j[r].appearance})]})},Ie=re;export{Ie as default};
