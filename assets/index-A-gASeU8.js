import{b as _,e as x,f as S,G as q,Q as P,H as R,au as w,J as c,p as A,n as j,q as E,s as C,aa as N,j as o,d as a,t as n}from"./index-CAxb-9CO.js";import{A as L}from"./AssociationBlock-Dw3g1JSJ.js";import{C as O}from"./CodeEditor-C-LSciuC.js";import{F as W}from"./FileInput-7r8yHwI0.js";import{S as B}from"./SidePanelFormButtons-THQX_GYS.js";import{u as U}from"./useGetWslInstanceTypes-RmCGn60O.js";import"./WslInstancesEmptyState-DGs1I9Tg.js";import{u as k}from"./useRoles-CwlY2G8P.js";import{M as v,R as G,C as V,F as D}from"./constants-CGmSpzVx.js";import"./MultiSelectField-DhnvON4Z.js";import"./useGetTags-Byfqctx7.js";import"./index-DfA4GLZO.js";import"./SidePanelFormButtons.module-BuIu-Bem.js";import"./GroupFilter-YE-Y99w2.js";import"./HeaderWithSearch-D9EWFI6l.js";import"./TruncatedCell-D7I1Byj1.js";import"./useExpandableRow-Dk4aTLgf.js";const M=()=>{const t=_(),s=x(),{isPending:r,mutateAsync:l}=S({mutationFn:async d=>t.post("child-instance-profiles",d),onSuccess:async()=>s.invalidateQueries({queryKey:["wslProfiles"]})});return{isAddingWslProfile:r,addWslProfile:l}},$=()=>q().shape({title:c().required("This field is required"),access_group:c().required("This field is required"),description:c().required("This field is required"),instanceType:c().required("This field is required"),rootfsImage:c().when("instanceType",{is:"custom",then:t=>t.required("This field is required"),otherwise:t=>t.notRequired()}),customImageName:c().when("instanceType",{is:"custom",then:t=>t.required("This field is required").test("not-match-reserved-patterns","Instance name cannot match 'ubuntu', 'ubuntu-preview', or 'ubuntu-<dd>.<dd>'",s=>!G.some(r=>r.test(s.toLowerCase()))),otherwise:t=>t.notRequired()}),cloudInitType:c(),cloudInit:w().nullable().when("cloudInitType",{is:t=>t==="file"||t==="text",then:t=>t.required("This field is required").test("file-size","File size must be less than 1MB",s=>(typeof s=="string"&&(s=p(s)),s?s.size===void 0?!1:s.size<=v*1024*1024:!0)),otherwise:t=>t.notRequired()}),all_computers:R(),tags:P().of(c())}),p=t=>{const s=new Blob([t],{type:"application/x-yaml"});return new File([s],"myFile.yaml",{type:"application/x-yaml"})},Q=t=>{if(t)return new Promise((s,r)=>{const l=new FileReader;l.readAsDataURL(t),l.onload=()=>{s(l.result)},l.onerror=d=>{r(d)}})},z=async t=>{if(t===null)return;let s;typeof t=="string"?s=p(t):s=t;const r=await Q(s);return r?r.split(",")[1]:void 0},H="_block_tz139_1",X={block:H},ge=()=>{const t=A(),{closeSidePanel:s}=j(),{notify:r}=E(),{getAccessGroupQuery:l}=k(),{addWslProfile:d}=M(),{data:m}=l(),{isGettingWslInstanceTypes:f,wslInstanceTypes:g}=U(),y=g.map(({label:i,name:u})=>({label:i,value:u}))||[],I=[{label:"Select",value:""},...y,{label:"From URL",value:"custom"}],h=m?.data.map(({name:i,title:u})=>({label:u,value:i}))??[],e=C({initialValues:{title:"",access_group:N,description:"",instanceType:"",customImageName:"",rootfsImage:"",cloudInitType:"",cloudInit:null,all_computers:!1,tags:[]},onSubmit:async i=>{try{const u=await z(i.cloudInit),F=(await d({title:i.title,access_group:i.access_group,description:i.description,image_name:i.instanceType==="custom"?i.customImageName:i.instanceType,image_source:i.rootfsImage,cloud_init_contents:u,all_computers:i.all_computers,tags:i.tags})).data.computers.constrained.length;s(),r.success({title:`Profile "${i.title}" added successfully`,message:`It has been associated with ${F} instances`})}catch(u){t(u)}},validationSchema:$()}),b=async i=>{await e.setFieldValue("cloudInit",i[0])},T=async()=>{await e.setFieldValue("cloudInit",null)};return o.jsxs(a.Form,{onSubmit:e.handleSubmit,noValidate:!0,children:[o.jsx(a.Input,{type:"text",label:"Title",required:!0,...e.getFieldProps("title"),error:n(e,"title")}),o.jsx(a.Input,{type:"text",label:"Description",required:!0,...e.getFieldProps("description"),error:n(e,"description")}),o.jsx(a.Select,{label:"Access group","aria-label":"Access group",required:!0,options:h,...e.getFieldProps("access_group"),error:n(e,"access_group")}),o.jsxs("div",{className:X.block,children:[(e.values.instanceType!==""||e.values.cloudInitType!=="")&&o.jsx(a.Notification,{severity:"caution",title:"Warning",children:o.jsx("span",{children:"Once the profile is added, you cannot modify the rootfs image or cloud-init file."})}),o.jsx(a.Select,{label:"Rootfs image",disabled:f,"aria-label":"Rootfs image",options:I,required:!0,...e.getFieldProps("instanceType"),error:n(e,"instanceType")}),e.values.instanceType==="custom"&&o.jsxs(o.Fragment,{children:[o.jsx(a.Input,{label:"Image name",type:"text",required:!0,...e.getFieldProps("customImageName"),error:n(e,"customImageName")}),o.jsx(a.Input,{type:"text",label:"Rootfs image URL",required:!0,...e.getFieldProps("rootfsImage"),error:n(e,"rootfsImage"),help:"The file path must be reachable by the affected WSL instances."})]}),o.jsx(a.Select,{label:"Cloud-init","aria-label":"Cloud-init",options:V,...e.getFieldProps("cloudInitType"),error:n(e,"cloudInitType")}),e.values.cloudInitType==="file"&&o.jsx(W,{label:"Upload cloud-init",labelClassName:"u-off-screen",accept:".yaml",...e.getFieldProps("cloudInit"),onFileRemove:T,onFileUpload:b,help:D,error:n(e,"cloudInit")}),e.values.cloudInitType==="text"&&o.jsx(O,{label:"Cloud-init configuration",onChange:i=>{e.setFieldValue("cloudInit",i??"")},value:e.values.cloudInit??"",language:"yaml",defaultValue:"# paste cloud-init config here",error:n(e,"cloudInit")})]}),o.jsx(L,{formik:e}),o.jsx(B,{submitButtonText:"Add WSL profile",submitButtonAriaLabel:"Add a new WSL profile",submitButtonDisabled:e.isSubmitting})]})};export{ge as default};
