import{p as B,n as w,J as y,i as l,o as n,a6 as I,r as _,z as H,y as Q,C as J,j as r,d as a,aJ as P}from"./index-DYykpNVa.js";import{C as F}from"./CheckboxGroup-l-EdbZUI.js";import{S as W}from"./SidePanelFormButtons-Aj5ThB2m.js";import{U as Y}from"./UdebCheckboxInput-SBQoIbWu.js";import{u as X}from"./useGPGKeys-DzOwP1o9.js";import{g as o}from"./formikErrors-Bw8iTXYS.js";import{M as x,S as b,I as v,e as d,a as Z,u as ee,h as te,C as re,A as se,i as S,P as k,g as E,D as C,j as V}from"./constants-DA4Q1L0X.js";import{t as j}from"./tests-DFnZqbNV.js";import"./SidePanelFormButtons.module-CcPyiogC.js";import"./useFetchOld-BGD2hIpr.js";import"./constants-CXofZZ4i.js";import"./NoData-CT6SeJUX.js";import"./index-C2TKYmcI.js";import"./ResponsiveTable-C-8YbfBJ.js";import"./TablePagination-CIA4CRba.js";import"./TableFilterChips-DLH4XQ-H.js";import"./PageParamFilter-LH49uHXA.js";import"./TableFilter-C7yTBfOe.js";const ae=u=>u.replace(/\/[^\\/@]*@/,"/"),ie=u=>u?{...v,distribution:u.name}:v,oe=(u,m)=>B().shape({distribution:l().required("This field is required."),type:l().required("This field is required."),name:l().required("This field is required.").test({test:j.test,message:j.message}).test({test:(i,s)=>!!s.parent.distribution,message:"First select the distribution."}).test({params:{distribution:m,distributions:u},test:(i,s)=>s.parent.distribution?!(m?m.series.map(({name:c})=>c):u.find(({name:c})=>c===s.parent.distribution)?.series.map(({name:c})=>c))?.includes(i):!0,message:"It must be unique within series within the distribution."}),hasPockets:w(),mirror_series:l(),mirror_gpg_key:l(),mirror_uri:l().when("hasPockets",([i],s)=>i?s.nonNullable().required("This field is required."):s),snapshotDate:l().when("type",([i],s)=>i==="ubuntu-snapshot"?s.required("This field is required.").test({test:g=>n(g).isBetween(n(b),n()),message:`The date must be after ${n(b).format(I)} and not in the future.`}):s),gpg_key:l().when("hasPockets",([i],s)=>i?s.required("This field is required."):s),pockets:y().of(l()),components:y().of(l()).when("hasPockets",([i],s)=>i?s.min(x,"Please choose at least one component."):s),architectures:y().of(l()).when("hasPockets",([i],s)=>i?s.min(x,"Please choose at least one architecture."):s),include_udeb:w().required()}),we=({distribution:u,ctaText:m="Add mirror"})=>{const[i,s]=_.useState(d),[g,c]=_.useState([]),A=H(),{closeSidePanel:q}=Q(),{getGPGKeysQuery:D}=X(),{createSeriesQuery:O,getRepoInfo:R}=Z(),{getDistributionsQuery:N}=ee(),{data:U}=N({include_latest_sync:!0},{enabled:!u}),f=U?.data??[],{data:M}=D(),{mutateAsync:L}=O,T=M?.data??[],G=f.map(({name:t})=>({label:t,value:t})),e=J({initialValues:ie(u),validationSchema:oe(f,u),onSubmit:async t=>{try{await L({name:t.name,distribution:t.distribution,mirror_series:t.mirror_series,gpg_key:t.gpg_key,include_udeb:t.include_udeb,mirror_uri:t.mirror_uri,components:t.components,pockets:t.pockets,architectures:t.architectures,mirror_gpg_key:t.mirror_gpg_key}),q()}catch(p){A(p)}}}),$=async t=>{await e.setFieldValue("snapshotDate",t.target.value),await e.setFieldValue("mirror_uri",`${C}/${n(t.target.value).format(V)}`)},K=async t=>{await e.setFieldValue("type",t.target.value),t.target.value==="ubuntu"?(await e.setFieldValue("mirror_uri",d),await e.setFieldValue("pockets",S.ubuntu),await e.setFieldValue("hasPockets",!0),await e.setFieldValue("components",k.ubuntu),await e.setFieldValue("architectures",E.ubuntu),e.values.mirror_uri?.startsWith(d)||await e.setFieldValue("mirror_uri",d),s(d)):t.target.value==="third-party"?(await e.setFieldValue("mirror_uri",""),await e.setFieldValue("pockets",S.thirdParty),await e.setFieldValue("hasPockets",!0),await e.setFieldValue("components",k.thirdParty),await e.setFieldValue("architectures",E.thirdParty),s("")):t.target.value==="ubuntu-snapshot"&&(await e.setFieldValue("mirror_uri",`${C}/${n(e.values.snapshotDate).format(V)}`),await e.setFieldValue("pockets",S.ubuntu),await e.setFieldValue("hasPockets",!0),await e.setFieldValue("components",k.ubuntu),s(d))},z=async t=>{const{value:p}=t.target;await e.setFieldValue("mirror_series",p),!(!p||e.values.name)&&await e.setFieldValue("name",e.values.type==="ubuntu-snapshot"?`${p}-snapshot-${n(e.values.snapshotDate).format(P)}`:p)},{data:{data:h}={data:void 0}}=R({mirror_uri:ae(i)},{enabled:!!i});return _.useEffect(()=>{if(!h){c([]);return}h.ubuntu?e.values.mirror_uri?.startsWith(d)&&e.setFieldValue("type","ubuntu"):e.setFieldValue("type","third-party"),c(h.repos.map(({description:t,repo:p})=>({label:h.ubuntu?t:p,value:p})))},[h]),r.jsxs(a.Form,{onSubmit:e.handleSubmit,noValidate:!0,children:[r.jsx(a.Select,{label:"Type",required:!0,options:[{label:"Ubuntu Archive",value:"ubuntu"},{label:"Ubuntu Snapshot",value:"ubuntu-snapshot"},{label:"Third party",value:"third-party"}],...e.getFieldProps("type"),onChange:K,error:o(e,"type")}),e.values.type!=="ubuntu-snapshot"?r.jsx(a.Input,{type:"text",label:"Mirror URI",required:e.values.hasPockets,help:"Absolute URL or file path",...e.getFieldProps("mirror_uri"),onBlur:t=>{s(t.target.value)},error:o(e,"mirror_uri")}):r.jsx(a.Input,{type:"date",min:n(b).format(P),max:n().format(P),label:"Snapshot date",required:!0,...e.getFieldProps("snapshotDate"),onChange:$,error:o(e,"snapshotDate"),help:`Starting from approximately ${n(b).format(I)} in dd.mm.yyyy format`}),!u&&r.jsx(a.Select,{label:"Distribution",required:!0,options:[{label:"Select distribution",value:""},...G],...e.getFieldProps("distribution"),error:o(e,"distribution")}),r.jsxs(a.Row,{className:"u-no-padding",children:[r.jsx(a.Col,{size:6,medium:3,small:2,children:r.jsx(a.Select,{label:"Mirror series",options:[{label:"Select series",value:""},...g],...e.getFieldProps("mirror_series"),onChange:z,error:o(e,"mirror_series")})}),r.jsx(a.Col,{size:6,medium:3,small:2,children:r.jsx(a.Input,{type:"text",label:"Series name",required:!0,...e.getFieldProps("name"),error:o(e,"name")})})]}),r.jsxs(a.Row,{className:"u-no-padding",children:[e.values.type!=="ubuntu-snapshot"&&r.jsx(a.Col,{size:6,medium:3,small:2,children:r.jsx(a.Select,{label:"Mirror GPG key",options:[{label:"Select mirror GPG key",value:""},...T.filter(({has_secret:t})=>!t).map(({name:t})=>({label:t,value:t}))],...e.getFieldProps("mirror_gpg_key"),error:o(e,"mirror_gpg_key"),help:"If none is given, the stock Ubuntu archive one will be used."})}),r.jsx(a.Col,{size:6,medium:3,small:2,children:r.jsx(a.Select,{label:"GPG key",required:e.values.hasPockets,options:[{label:"Select GPG key",value:""},...T.filter(({has_secret:t})=>t).map(({name:t})=>({label:t,value:t}))],...e.getFieldProps("gpg_key"),error:o(e,"gpg_key")})})]}),e.values.type!=="third-party"?r.jsxs(r.Fragment,{children:[r.jsx(F,{label:"Pockets",style:{marginTop:"1.5rem"},options:te,...e.getFieldProps("pockets"),onChange:async t=>{await e.setFieldValue("pockets",t),await e.setFieldValue("hasPockets",!!t.length)},error:o(e,"pockets")}),r.jsx(F,{label:"Components",required:e.values.hasPockets,options:re,...e.getFieldProps("components"),onChange:async t=>{await e.setFieldValue("components",t)},error:o(e,"components")}),r.jsx(F,{label:"Architectures",required:e.values.hasPockets,options:se,...e.getFieldProps("architectures"),onChange:async t=>{await e.setFieldValue("architectures",t)},error:o(e,"architectures")})]}):r.jsxs(r.Fragment,{children:[r.jsx(a.Input,{type:"text",label:"Pockets",placeholder:"E.g. releases, security, etc.",...e.getFieldProps("pockets"),value:e.values.pockets.join(","),onChange:async t=>{await e.setFieldValue("pockets",t.target.value.replace(/\s/g,"").split(",")),await e.setFieldValue("hasPockets",!!t.target.value)},error:o(e,"pockets"),help:"List the pocket names separated by commas."}),r.jsx(a.Input,{type:"text",label:"Components",required:e.values.hasPockets,placeholder:"E.g. main, universe, etc.",...e.getFieldProps("components"),value:e.values.components.join(","),onChange:async t=>{await e.setFieldValue("components",t.target.value.replace(/\s/g,"").split(","))},error:o(e,"components"),help:"List the component names separated by commas."}),r.jsx(a.Input,{type:"text",label:"Architectures",required:e.values.hasPockets,placeholder:"E.g. amd64, riscv, etc.",...e.getFieldProps("architectures"),value:e.values.architectures.join(","),onChange:async t=>{await e.setFieldValue("architectures",t.target.value.replace(/\s/g,"").split(","))},error:o(e,"architectures"),help:"List the architectures separated by commas."})]}),r.jsx(Y,{formik:e}),r.jsx(W,{submitButtonDisabled:e.isSubmitting,submitButtonText:m})]})};export{we as default};
