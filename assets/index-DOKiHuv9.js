import{k as j,v as N,i as S,w as k,l as I,j as e,h as n}from"./index-BUcGDZCR.js";import{I as c}from"./InfoItem-B6O5SMzW.js";import{u as D}from"./index-C9q_OYqp.js";import{h as T}from"./moment-C5S46NFB.js";import{u as A}from"./index-CczdCbTK.js";import{K as C}from"./constants-DvL8lIN9.js";import"./moment-DJqi0OYL.js";import"./TablePagination-Bn2d3RK2.js";import"./TablePagination.module-CgQ3jx4B.js";import"./usePageParams-Dua6EmZm.js";import"./SearchHelpPopup-CD9PPZhB.js";import"./useFetchOld-wQl16_NT.js";import"./NoData-B_fTZp8V.js";import"./PageMain-CCULNlPm.js";import"./useUsns-Daw1RsIa.js";import"./useInstances-Bltxtwe4.js";const E="The kernel will be downgraded and the instance will restart afterwards to apply the change.",R="The kernel will be downgraded. You'll need to restart the instance to apply this change.",F="Downgrading the kernel will expose your system to known security vulnerabilities AND reduce your Livepatch coverage.",B="_radioGroup_1y5w7_1",O="_marginTop_1y5w7_6",P="_infoItem_1y5w7_11",o={radioGroup:B,marginTop:O,infoItem:P},ee=({currentKernelVersion:m,downgradeKernelVersions:a,instanceName:u})=>{const p=j(),{instanceId:_}=N(),{closeSidePanel:s}=S(),{notify:v}=k(),{downgradeKernelQuery:y}=A(),{openActivityDetails:h}=D(),{mutateAsync:g,isPending:l}=y,f=[{label:"Select",value:""},...a.map(r=>({label:r.version_rounded,value:r.id.toString()}))],w={deliver_immediately:!0,randomize_delivery:!1,deliver_delay_window:0,deliver_after:"",new_kernel_version_id:a.length===1?a[0].id.toString():"",reboot_after:!1},i=I({initialValues:w,validationSchema:C,onSubmit:async r=>{try{const{data:t}=await g({id:Number(_),kernel_package_id:Number(r.new_kernel_version_id),reboot_after:r.reboot_after});s();const x=r.reboot_after?E:R;v.success({title:`You queued kernel downgrade for instance "${u}"`,message:x,actions:[{label:"View details",onClick:()=>h(t)}]})}catch(t){p(t)}}}),d=async r=>{const t=r.currentTarget.value==="true";await i.setFieldValue("deliver_immediately",t),t||await i.setFieldValue("deliver_after",T().toISOString().slice(0,16))},b=async()=>{await i.setFieldValue("reboot_after",!0),i.handleSubmit()};return e.jsxs(n.Form,{onSubmit:i.handleSubmit,children:[e.jsx(n.Notification,{severity:"caution",title:"Security warning",children:e.jsx("span",{children:F})}),e.jsxs(n.Row,{className:"u-no-padding--left u-no-padding--right",children:[e.jsx(n.Col,{size:6,children:e.jsx(c,{label:"current version",value:m})}),e.jsx(n.Col,{size:6,children:e.jsx(c,{label:"kernel version",className:o.infoItem,value:a.length===1?e.jsx("span",{children:a[0].version_rounded}):e.jsx(n.Select,{options:f,...i.getFieldProps("new_kernel_version_id")})})})]}),e.jsx("strong",{className:o.marginTop,children:"Delivery time"}),e.jsxs("div",{className:o.radioGroup,children:[e.jsx(n.Input,{type:"radio",label:"As soon as possible",name:"deliver_immediately",value:"true",onChange:d,checked:i.values.deliver_immediately}),e.jsx(n.Input,{type:"radio",label:"Scheduled",name:"deliver_immediately",value:"false",onChange:d,checked:!i.values.deliver_immediately})]}),!i.values.deliver_immediately&&e.jsx(n.Input,{type:"datetime-local",label:"Deliver after",labelClassName:"u-off-screen",...i.getFieldProps("deliver_after"),error:i.touched.deliver_after&&i.errors.deliver_after}),e.jsx("strong",{className:o.marginTop,children:"Randomise delivery over a time window"}),e.jsxs("div",{className:o.radioGroup,children:[e.jsx(n.Input,{type:"radio",label:"No",...i.getFieldProps("randomize_delivery"),onChange:async()=>{await i.setFieldValue("randomize_delivery",!1),await i.setFieldValue("deliver_delay_window",0)},checked:!i.values.randomize_delivery}),e.jsx(n.Input,{type:"radio",label:"Yes",...i.getFieldProps("randomize_delivery"),onChange:async()=>await i.setFieldValue("randomize_delivery",!0),checked:i.values.randomize_delivery})]}),i.values.randomize_delivery&&e.jsx(n.Input,{type:"number",inputMode:"numeric",min:0,label:"Delivery delay window",labelClassName:"u-off-screen",help:"Time in minutes",...i.getFieldProps("deliver_delay_window"),error:i.touched.deliver_delay_window&&i.errors.deliver_delay_window?i.errors.deliver_delay_window:void 0}),e.jsxs("div",{className:"form-buttons",children:[e.jsx(n.Button,{type:"button",appearance:"base",onClick:s,children:"Cancel"}),e.jsx(n.ConfirmationButton,{type:"button",confirmationModalProps:{title:"Downgrading kernel and restarting instance",children:e.jsx("p",{children:"Are you sure? This action will downgrade the kernel and restart the instance."}),confirmButtonLabel:"Downgrade and Restart",confirmButtonAppearance:"negative",confirmButtonLoading:l,confirmButtonDisabled:l,onConfirm:b},children:"Downgrade and Restart"}),e.jsx(n.ConfirmationButton,{type:"button",appearance:"negative",confirmationModalProps:{title:"Downgrading kernel",children:e.jsx("p",{children:"Are you sure? This action will downgrade the kernel."}),confirmButtonLabel:"Downgrade",confirmButtonAppearance:"negative",confirmButtonLoading:l,confirmButtonDisabled:l,onConfirm:()=>i.handleSubmit()},children:"Downgrade kernel"})]})]})};export{ee as default};
