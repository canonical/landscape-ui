import{j as e,g,a as $,e as M,l as A,k as D,r,p as L,R as O,w as F,h as B}from"./index-iyHIejiU.js";import{m as I}from"./moment-BsuiqsAu.js";import{T as V}from"./TruncatedCell-Df_l_kHH.js";import{E as q}from"./ExpandableTableFooter-BhsMgChO.js";import{u as Y}from"./useConfirm-_8nON0sp.js";import{u as G}from"./useUsns-D0ozbLuD.js";import{u as W}from"./usePageParams-DfebddJS.js";import{U as z,g as J,c as j,a as K,h as R,b as S}from"./helpers-BfuBH7Ij.js";import{u as Q}from"./useOnClickOutside-ChepXlBh.js";const _=({additionalCta:d,columns:c,data:s,limit:o,onLimitChange:y,itemNames:t,totalCount:m,getCellProps:l,getRowProps:p,title:u})=>e.jsxs(e.Fragment,{children:[u&&e.jsx("p",{className:"p-heading--5",children:u}),e.jsx(g.ModularTable,{columns:c,data:s,className:"u-no-margin--bottom",getCellProps:l,getRowProps:p}),e.jsx(q,{additionalCta:d,itemNames:t,limit:o,onLimitChange:y,totalCount:m})]}),E=({limit:d,onLimitChange:c,usn:s,...o})=>{const y=$(),t=M(),{notify:m}=A(),{confirmModal:l,closeConfirmModal:p}=Y(),{getAffectedPackagesQuery:u,removeUsnPackagesQuery:k}=G(),{setPageParams:C}=W(),{instanceId:b,childInstanceId:i}=D(),h=Number(b),{mutateAsync:T}=k,a=()=>{y(`${O}instances/${i?`${h}/${i}`:`${h}`}`),C({tab:"activities"}),m.clear()},n=async()=>{try{await T({usns:s,instanceId:h}),m.success({title:"You queued packages to be uninstalled",message:`Packages affected by "${s}" security issue will be uninstalled and are queued in Activities.`,actions:[{label:"View details",onClick:()=>a()}]})}catch(U){t(U)}finally{p()}},f=U=>{l({title:"Uninstall USN packages",body:`This will uninstall packages affected by "${s}" security issue from the "${U}" instance.`,buttons:[e.jsx(g.Button,{type:"button",appearance:"negative",onClick:()=>n(),children:"Uninstall"},"remove")]})},v=o.isRemovable?[e.jsxs(g.Button,{type:"button",small:!0,dense:!0,hasIcon:!0,onClick:()=>f(o.instanceTitle),children:[e.jsx(g.Icon,{name:"delete",className:"u-no-margin--left"}),e.jsx("span",{children:"Uninstall packages"})]},"remove")]:void 0,{data:x,isLoading:w}=u({usn:s,computer_ids:o.isRemovable?[h]:o.instanceIds}),N=r.useMemo(()=>(x==null?void 0:x.data.slice(0,d))||[],[x,d]),H=r.useMemo(()=>[{accessor:"name",Header:"Package"},{accessor:"current_version",Header:"Current version"},{accessor:"new_version",Header:"New version"},{accessor:"summary",Header:"Details"}],[N.length]);return w?e.jsx(L,{}):e.jsx(_,{additionalCta:v,columns:H,data:N,itemNames:{plural:"packages",singular:"package"},limit:d,onLimitChange:c,totalCount:(x==null?void 0:x.data.length)??0})},ie=({isUsnsLoading:d,usns:c,...s})=>{const[o,y]=r.useState(5),[t,m]=r.useState(""),[l,p]=r.useState(-1),[u,k]=r.useState(5),C=r.useRef([]);Q({current:l!==-1?C.current[l]:null},()=>p(-1));const b=r.useMemo(()=>d?[z]:J(c,t,s.tableType,o),[c,t,d,o,s.tableType]),i=s.tableType==="paginated"?s.selectedUsns:[],h=a=>{if(s.tableType==="expandable")return;const n=i.filter(f=>f.usn!==a.usn);s.onSelectedUsnsChange(i.length!==n.length?n:[...n,a])},T=r.useMemo(()=>[{accessor:"checkbox",className:j.checkboxColumn,Header:()=>s.tableType==="paginated"&&e.jsx(g.CheckboxInput,{inline:!0,label:e.jsx("span",{className:"u-off-screen",children:"Toggle all security issues"}),disabled:b.length===0||b[0].usn==="loading",indeterminate:i.length>0&&i.length<c.length,checked:i.length>0&&i.length===c.length,onChange:()=>s.onSelectedUsnsChange(i.length>0?[]:c)}),Cell:({row:a})=>s.tableType==="paginated"&&e.jsx(g.CheckboxInput,{labelClassName:"u-no-margin--bottom u-no-padding--top",label:e.jsx("span",{className:"u-off-screen",children:`Toggle ${a.original.usn}`}),name:"usn",checked:i.some(({usn:n})=>n===a.original.usn),onChange:()=>h(a.original)})},{accessor:"usn",Header:"USN",Cell:({row:a})=>a.original.usn==="expandedUsn"?s.tableType==="expandable"?e.jsx(E,{isRemovable:!1,instanceIds:s.instanceIds,limit:u,onLimitChange:()=>k(n=>n+5),usn:t}):e.jsx(E,{isRemovable:!0,instanceTitle:s.instanceTitle,limit:u,onLimitChange:()=>k(n=>n+5),usn:t}):a.original.usn==="loading"?e.jsx(L,{}):e.jsx("a",{href:a.original.usn_link,target:"_blank",rel:"nofollow noopener noreferrer",children:a.original.usn})},{accessor:"cves",Header:"CVE(s)",Cell:({row:{original:a,index:n}})=>e.jsx(V,{content:a.cves.map(({cve:f,cve_link:v})=>e.jsx("span",{className:j.cve,children:e.jsx("a",{href:v,target:"_blank",rel:"nofollow noopener noreferrer",className:j.cveLink,children:f})},f)),isExpanded:l===n,onExpand:()=>{m(""),p(t?n-1:n)}})},{accessor:"date",Header:"Date published",Cell:({row:a})=>e.jsx(e.Fragment,{children:I(a.original.date).isValid()?I(a.original.date).format(F):"---"})},{accessor:"release_packages",Header:"Affected packages",Cell:({row:a})=>e.jsx(e.Fragment,{children:e.jsx(g.Button,{type:"button",className:B("p-accordion__tab",j.expandButton),"aria-expanded":a.original.usn===t,onClick:()=>{p(-1),m(n=>n===a.original.usn?"":a.original.usn),k(5)},children:`${a.original.usn===t?"Hide":"Show"} packages`})})}].filter(({accessor:a})=>s.tableType==="paginated"||a!=="checkbox"),[b,u,i.length,s.tableType,l]);return e.jsx("div",{ref:K(C),children:s.tableType==="expandable"?e.jsx(_,{columns:T,data:b,getCellProps:R(s.tableType,l,t),getRowProps:S(l),itemNames:{plural:"security issues",singular:"security issue"},limit:o,onLimitChange:()=>y(a=>a+5),title:"Security issues",totalCount:c.length}):e.jsx(g.ModularTable,{columns:T,data:b,getCellProps:R(s.tableType,l,t),getRowProps:S(l),emptyMsg:`No security issues found with the search "${s.search}"`})})};export{_ as E,ie as U};
