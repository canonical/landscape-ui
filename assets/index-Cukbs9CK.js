import{c as K,f as W,d as f,e as T,q as Q,s as D,r as A,t as L,i as $,v as H,l as z,j as e,h as i,G as R,b as q,n as V,I as _,o as U}from"./index-P3tcVer_.js";import{P as B,a as G,b as Y}from"./PageMain-CufgbnAh.js";import{d as J,s as j}from"./constants-CiwdWty_.js";import"./usePageParams-CZXld3eS.js";import{b as F}from"./output-DFRNcfG-.js";import{u as O}from"./useFetchOld-BGcQOp2P.js";import{M as X}from"./MultiSelectField-BmwwnNbV.js";import{u as Z}from"./useInstances-Dt0ImR3b.js";import"./NoData-DfvYDVkG.js";import"./index-C4mrLuM2.js";import"./TablePagination-9PvQlVgk.js";import"./TablePaginationBase-DrquMGK2.js";import"./StatusFilter-BjWN4DdL.js";import"./TableFilter-DTXx6h3i.js";import"./TableFilterChips-HMcdOmXT.js";function S(){const t=K(),a=W(),l=O(),r=()=>T({queryKey:["alert"],queryFn:async()=>a.get("alerts")}),o=f({mutationKey:["alert","subscribe"],mutationFn:async c=>l.get("SubscribeToAlert",{params:c}),onSuccess:async()=>t.invalidateQueries({queryKey:["alert"]})}),b=f({mutationKey:["alert","unsubscribe"],mutationFn:async c=>l.get("UnsubscribeFromAlert",{params:c}),onSuccess:async()=>t.invalidateQueries({queryKey:["alert"]})}),u=f({mutationKey:["alert","associate"],mutationFn:async c=>l.get("AssociateAlert",{params:c}),onSuccess:async()=>t.invalidateQueries({queryKey:["alert"]})}),m=f({mutationKey:["alert","disassociate"],mutationFn:async c=>l.get("DisassociateAlert",{params:c}),onSuccess:async()=>t.invalidateQueries({queryKey:["alert"]})});return{getAlertsQuery:r,subscribeQuery:o,unsubscribeQuery:b,associateAlert:u,disassociateAlert:m}}const ee="_footer_122x2_1",se="_multiSelect_122x2_7",M={footer:ee,multiSelect:se},E=(t,a)=>{const l=new Set(a);return t.filter(r=>!l.has(r))},I=({alert:t,availableTagOptions:a})=>{const l=Q(),{notify:r}=D(),{associateAlert:o,disassociateAlert:b}=S(),u=A.useRef(null),{mutateAsync:m}=o,{mutateAsync:c}=b,g=t.all_computers?["All"]:t.tags,C=async({tags:n})=>{try{const d=E(t.tags,n),p=E(n,t.tags),w=n.includes("All"),k=t.all_computers&&!w;if(w)await m({name:t.alert_type,tags:void 0,all_computers:!0});else if(k)await Promise.all([m({name:t.alert_type,tags:n.filter(x=>x!=="All"),all_computers:!1}),c({name:t.alert_type,all_computers:!0})]);else{const x=[];p.length>0&&x.push(m({name:t.alert_type,tags:p,all_computers:!1})),d.length>0&&x.push(c({name:t.alert_type,tags:d,all_computers:!1})),await Promise.all(x)}r.success({title:"Alert tags updated",message:`You changed ${t.label}'s tags`})}catch(d){l(d)}},s=L({initialValues:{tags:g},validationSchema:$().shape({tags:H().of(z())}),onSubmit:C}),y=s.values.tags.includes("All")?a.filter(({value:n})=>n!=="All"):void 0,v=s.values.tags.includes("All")?a:a.filter(({value:n})=>s.values.tags.includes(n)),P=n=>{const d=n.some(({value:p})=>p==="All")?["All"]:n.map(({value:p})=>p);s.setValues({tags:d})};A.useEffect(()=>{var d,p;const n=(d=u.current)==null?void 0:d.querySelector(".multi-select__condensed-text");(p=n==null?void 0:n.textContent)!=null&&p.includes("All instances")&&(n.textContent="All instances")},[s.values.tags]);const N=()=>s.isSubmitting?!0:g.length===s.values.tags.length&&g.every(n=>s.values.tags.includes(n));return e.jsx(i.Form,{onSubmit:s.handleSubmit,noValidate:!0,children:e.jsx(X,{innerRef:u,required:!0,variant:"condensed",className:M.multiSelect,items:a,selectedItems:v,disabledItems:y,onItemsUpdate:P,placeholder:"Select tags",error:s.touched.tags&&typeof s.errors.tags=="string"?s.errors.tags:void 0,dropdownFooter:e.jsxs("div",{className:M.footer,children:[e.jsx(i.Button,{type:"button",dense:!0,small:!0,className:"u-no-margin--bottom",disabled:N(),onClick:()=>s.setFieldValue("tags",g),children:"Revert"}),e.jsx(i.Button,{type:"submit",dense:!0,small:!0,appearance:"positive",className:"u-no-margin--bottom",disabled:N(),children:"Save changes"})]})})})},te="_noWrap_6cam7_19",ae="_alertsWrapper_6cam7_23",le="_emailColumn_6cam7_31",ne="_nameColumn_6cam7_35",ce="_tags_6cam7_39",h={switch:"_switch_6cam7_1",noWrap:te,alertsWrapper:ae,emailColumn:le,nameColumn:ne,tags:ce},re=t=>{const a={};switch(t.column.id){case"label":a.role="rowheader";break;case"subscribed":a["aria-label"]="Email";break;case"tags":a["aria-label"]="Tags";break;case"description":a["aria-label"]="Description";break}return a},ie=({alerts:t,availableTagOptions:a})=>{const l=R("(min-width: 620px)"),r=Q(),{unsubscribeQuery:o,subscribeQuery:b}=S(),{user:u}=q(),{mutateAsync:m}=b,{mutateAsync:c}=o,g=async s=>{const y=s.subscribed?c:m;try{await y({alert_type:s.alert_type})}catch(v){r(v)}},C=A.useMemo(()=>[{accessor:"label",className:h.nameColumn,Header:"Name"},{Header:e.jsxs("div",{className:h.noWrap,children:[e.jsx("span",{children:"Email "}),u&&e.jsx(i.Tooltip,{position:"btm-left",message:`Enabling email notifications will send alerts to ${u.email}, associated with your account`,children:e.jsx(i.Icon,{name:"help"})})]}),accessor:"subscribed",className:h.emailColumn,Cell:({row:s})=>e.jsx("div",{className:h.switch,children:e.jsx(i.Switch,{label:F(s.original.subscribed),defaultChecked:s.original.subscribed,onChange:()=>g(s.original)})})},{accessor:"tags",Header:"Enabled for",className:h.tags,Cell:({row:{original:s}})=>e.jsx(I,{alert:s,availableTagOptions:a})},{Header:"Description",accessor:"description",Cell:({row:{original:s}})=>e.jsx(e.Fragment,{children:s.description})}],[t]);return l?e.jsx(i.ModularTable,{columns:C,data:t,getCellProps:re,emptyMsg:"No data available"}):t.map((s,y)=>e.jsxs(i.Row,{className:V("u-no-padding--left u-no-padding--right",h.alertsWrapper),children:[e.jsx(i.Col,{size:2,small:2,children:e.jsx(_,{label:"Name",value:s.label})}),e.jsx(i.Col,{size:2,small:2,children:e.jsx(_,{label:"Email",value:e.jsx("div",{className:h.switch,children:e.jsx(i.Switch,{label:F(s.subscribed),defaultChecked:s.subscribed,onChange:()=>g(s)})})})}),e.jsx(i.Col,{size:2,small:2,children:e.jsx(_,{label:"Enabled for",value:e.jsx(I,{alert:s,availableTagOptions:a})})}),e.jsx(i.Col,{size:2,small:2,children:e.jsx(_,{label:"Description",value:s.description})})]},y))},oe=({alerts:t,availableTagOptions:a})=>{const{user:l}=q(),r=l==null?void 0:l.accounts.find(o=>o.name===l.current_account);return e.jsx("div",{className:J.item,children:e.jsxs("div",{className:j.card,children:[e.jsx("div",{className:j.header,children:e.jsx("p",{className:j.title,children:(r==null?void 0:r.title)||"Alerts"})}),e.jsx("div",{className:j.content,children:e.jsx(ie,{alerts:t,availableTagOptions:a})})]})})},Se=()=>{const{getAlertsQuery:t}=S(),{getAllInstanceTagsQuery:a}=Z(),{data:l}=a(),{data:r,isLoading:o}=t(),b=A.useMemo(()=>(r==null?void 0:r.data.filter(c=>!c.alert_type.toUpperCase().includes("LICENSE")))??[],[r]),u=(l==null?void 0:l.data.results.map(c=>({label:c,value:c,group:"Tags"})))??[],m=[{label:"All instances",value:"All"},...u];return e.jsxs(B,{children:[e.jsx(G,{title:"Alerts"}),e.jsxs(Y,{children:[o&&e.jsx(U,{}),!o&&b&&e.jsx(oe,{alerts:b,availableTagOptions:m})]})]})};export{Se as default};
