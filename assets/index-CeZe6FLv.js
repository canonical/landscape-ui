import{m as I,f as _,s as q,t as B,v as L,H as b,W as V,o as h,ax as m,r as S,y as k,z as N,B as $,C as D,j as t,d as c,F as p,L as v,R as x,i as O,N as M}from"./index-BniO5lih.js";import{C as H}from"./CodeEditor-14PL8VtM.js";import{S as K}from"./SidePanelFormButtons-bG-J2X_B.js";import{u as Q}from"./useEditScript-CeNVotZa.js";import{u as U,D as Y,S as z}from"./ScriptFormAttachments-BJJlhCLH.js";import{e as G,h as W,i as J}from"./ScriptsTabs-C_Aee3hv.js";import"./index-CCM0AgEZ.js";import"./SidePanelFormButtons.module-CcPyiogC.js";import"./AttachmentFile-DJD7utgK.js";import"./constants-HWGNn3R9.js";import"./useRoles-DRKlPdx8.js";import"./HeaderWithSearch-S6PnmELF.js";import"./SingleInstanceTabs.module-Cm1BYFZQ.js";const X=(e,o={enabled:!0})=>{const l=I(),{data:r,isPending:u}=_({queryKey:["scripts","profiles",e],queryFn:async()=>l.get(`scripts/${e}/script-profiles`),...o});return{associatedScriptProfiles:r?.data.results??[],isAssociatedScriptProfilesLoading:u}},Z=()=>{const e=q(),o=B(),{mutateAsync:l,isPending:r}=L({mutationKey:["scripts","removeAttachment"],mutationFn:async u=>e.get("RemoveScriptAttachment",{params:u}),onSuccess:async()=>o.invalidateQueries({queryKey:["scripts"]})});return{removeScriptAttachment:l,isRemovingScriptAttachment:r}},ee="_modal_1lyuv_1",te={modal:ee},se=()=>b().shape({title:h().required("This field is required"),code:h().required("This field is required"),attachments:b().shape({first:m().nullable(),second:m().nullable(),third:m().nullable(),fourth:m().nullable(),fifth:m().nullable()}),attachmentsToRemove:V().of(h())}),ae=e=>({title:e.title,code:G({code:e.code,interpreter:e.interpreter}),time_limit:e.time_limit,username:e.username,attachments:{first:null,second:null,third:null,fourth:null,fifth:null},attachmentsToRemove:[]}),ie=e=>{const o=e.lastIndexOf(".");return o!==-1?e.slice(0,o):e},Se=({script:e})=>{const o=S.useRef(null),[l,r]=S.useState(!1),{closeSidePanel:u}=k(),y=N(),{notify:A}=$(),{createScriptAttachment:F}=U(),{removeScriptAttachment:j}=Z(),{editScript:C,isEditing:f}=Q(),{associatedScriptProfiles:g,isAssociatedScriptProfilesLoading:P}=X(e.id,{enabled:l}),w=async s=>{const n=Object.values(s.attachments).filter(i=>i!==null);try{const i=[C(W({scriptId:e.id,values:s}))];if(s.attachmentsToRemove.length)for(const d of s.attachmentsToRemove)i.push(j({script_id:e.id,filename:d}));n.length&&i.push(...await J({attachments:n,createScriptAttachment:F,script_id:e.id})),await Promise.all(i),u(),r(!1),A.success({title:`You have successfully submitted a new version of ${e.title}`,message:"All its associated profiles will now be run using this new version."})}catch(i){r(!1),y(i)}},a=D({initialValues:ae(e),validationSchema:se(),onSubmit:w}),T=async({target:{files:s}})=>{if(!s)return;const[n]=s,i=a.setFieldValue("code",await n.text());if(a.values.title){await i;return}await Promise.all([a.setFieldValue("title",ie(n.name)),i])},R=async s=>{await a.setFieldValue("code",s)},E=()=>o.current?.click();return t.jsxs(c.Form,{onSubmit:a.handleSubmit,noValidate:!0,children:[t.jsx(c.Input,{type:"text",label:"Title",required:!0,...a.getFieldProps("title"),error:p(a,"title")}),t.jsx("input",{ref:o,className:"u-hide",type:"file",onChange:T}),t.jsx(H,{label:"Code",value:a.values.code,onChange:R,error:p(a,"code"),required:!0,defaultValue:Y,headerContent:t.jsxs(c.Button,{className:"u-no-margin--bottom",appearance:"base",hasIcon:!0,onClick:E,type:"button",children:[t.jsx(c.Icon,{name:"upload"}),t.jsx("span",{children:"Populate from file"})]})}),t.jsxs(t.Fragment,{children:[t.jsx("h5",{children:"List of attachments"}),t.jsx("p",{className:"u-text--muted",children:"Attachments that will be sent along with the script. You can attach up to 5 files, for a maximum of 1.00MB. Filenames must be unique. On the client, the attachments will be placed in the directory whose name is accessible through the environment variable LANDSCAPE_ATTACHMENTS. They'll be deleted once the script has been run."})]}),t.jsx(z,{attachments:a.values.attachments,attachmentsToRemove:a.values.attachmentsToRemove,getFileInputError:s=>p(a,["attachments",s]),initialAttachments:e.attachments,onFileInputChange:s=>async n=>a.setFieldValue(`attachments.${s}`,n.target.files?.[0]??null),onInitialAttachmentDelete:async s=>a.setFieldValue("attachmentsToRemove",[...a.values.attachmentsToRemove,s]),scriptId:e.id}),t.jsx(K,{onSubmit:()=>{r(!0)},submitButtonText:"Submit new version"}),l&&t.jsx(c.ConfirmationModal,{title:`Submit new version of "${e.title}"`,confirmButtonLabel:"Submit new version",onConfirm:()=>{a.handleSubmit()},confirmButtonAppearance:"positive",confirmButtonDisabled:f,confirmButtonLoading:f,close:()=>{r(!1)},className:te.modal,confirmButtonProps:{type:"button"},children:g.length>0?t.jsxs(t.Fragment,{children:[t.jsx("p",{children:"All future script runs will be done using the latest version of the code. Submitting these changes will affect the following profiles:"}),t.jsx(c.ModularTable,{columns:[{Header:"active profiles",accessor:"title",Cell:({row:s})=>t.jsx(v,{to:x.scripts.root({tab:"profiles"}),state:{scriptProfileId:s.original.id},target:"_blank",children:s.original.title})},{Header:"associated instances",Cell:({row:s})=>{const n=g.find(d=>d.id===s.original.id),i=n?.computers.num_associated_computers;return P?t.jsx(O,{}):i?t.jsxs(v,{to:x.instances.root({tags:n?.tags}),target:"_blank",children:[i," instance",i>1?"s":""]}):t.jsx(M,{})}}],data:e.script_profiles})]}):t.jsx("p",{children:"All future script runs will be done using the latest version of the code."})})]})};export{Se as default};
