import{r as m,j as e,d as a,I as N,ac as R,p as D,i as f,J as _,n as I,z as v,y as E,C as T,al as z}from"./index-DYykpNVa.js";import{S as w}from"./SidePanelFormButtons-Aj5ThB2m.js";import{g as b}from"./formikErrors-Bw8iTXYS.js";import{A as O}from"./AssociationBlock-Bs5is6Zl.js";import{u as B}from"./RepositoryProfileListActions-CM1kmXwp.js";import{u as L}from"./useRoles-CK1OAvut.js";import{u as V}from"./constants-DA4Q1L0X.js";import{u as $}from"./useAPTSources-B02isbP0.js";import"./SidePanelFormButtons.module-CcPyiogC.js";import"./MultiSelectField-85mhFA5_.js";import"./useGetTags-BbkSXw8M.js";import"./TextConfirmationModal-DuGXYB1S.js";import"./useFetchOld-BGD2hIpr.js";import"./constants-CXofZZ4i.js";import"./NoData-CT6SeJUX.js";import"./index-C2TKYmcI.js";import"./ResponsiveTable-C-8YbfBJ.js";import"./TablePagination-CIA4CRba.js";import"./TableFilterChips-DLH4XQ-H.js";import"./PageParamFilter-LH49uHXA.js";import"./TableFilter-C7yTBfOe.js";const y=({label:t,onSearchChange:s})=>{const[l,i]=m.useState(""),[r,o]=m.useState(null),c=m.useRef(null);return m.useEffect(()=>{c.current&&o(c.current.querySelector("input"))},[c.current]),e.jsxs("div",{className:"p-search-box",ref:c,children:[e.jsx("label",{className:"u-off-screen",htmlFor:r?.id,children:t}),e.jsx(a.Input,{type:"search",autoComplete:"off",className:"p-search-box__input",name:"search",placeholder:"Search",value:l,onChange:n=>{i(n.target.value)},onKeyDown:n=>{n.key==="Enter"&&(n.preventDefault(),s(l))}}),l&&e.jsx(a.Button,{type:"reset",className:"p-search-box__reset",onClick:()=>{s(""),i(""),r?.focus()},"aria-label":"Reset search",children:e.jsx(a.Icon,{name:a.ICONS.close})}),e.jsx(a.Button,{type:"button",className:"p-search-box__button",onClick:()=>{s(l)},"aria-label":t,children:e.jsx(a.Icon,{name:a.ICONS.search})})]})},G=(t,s)=>s?t.filter(({name:l,line:i})=>l.match(s)||i.match(s)):t,Q=({aptSources:t,formik:s})=>{const[l,i]=m.useState(""),r=G(t,l);return e.jsxs(e.Fragment,{children:[e.jsx(y,{label:"Search for APT sources",onSearchChange:o=>{i(o)}}),e.jsxs("fieldset",{className:N("checkbox-group",{"is-error":b(s,"apt_sources")}),children:[e.jsxs(a.Row,{className:"u-no-padding--left u-no-padding--right",children:[e.jsx(a.Col,{small:1,medium:2,size:4,children:e.jsx("p",{className:"p-heading--5 p-text--small p-text--small-caps",children:"Name"})}),e.jsx(a.Col,{small:3,medium:4,size:8,children:e.jsx("p",{className:"p-heading--5 p-text--small p-text--small-caps",children:"Line"})})]}),r.length===0&&e.jsx("p",{children:`No APT sources found with the search: "${l}".`}),r.length>0&&e.jsx("ul",{className:"p-list--divided u-no-margin--bottom",children:r.map(({id:o,line:c,name:n})=>e.jsx("li",{className:"p-list__item",children:e.jsxs(a.Row,{className:"u-no-padding--left u-no-padding--right",children:[e.jsx(a.Col,{small:1,medium:2,size:4,children:e.jsx(a.CheckboxInput,{label:n,...s.getFieldProps("apt_sources"),checked:s.values.apt_sources.includes(o),onChange:()=>s.setFieldValue("apt_sources",s.values.apt_sources.includes(o)?s.values.apt_sources.filter(h=>h!==o):[...s.values.apt_sources,o])})}),e.jsx(a.Col,{small:3,medium:4,size:8,children:e.jsx("p",{className:"u-no-margin--bottom u-truncate",title:c,children:c})})]})},n))})]})]})},q=({accessGroups:t,formik:s,isTitleRequired:l=!1,isAccessGroupDisabled:i=!1})=>{const r=t.map(({name:o,title:c})=>({label:c,value:o}));return e.jsxs(e.Fragment,{children:[e.jsx(a.Input,{type:"text",label:"Title",required:l,autoComplete:"off",error:b(s,"title"),...s.getFieldProps("title")}),e.jsx(a.Input,{type:"text",label:"Description",autoComplete:"off",error:b(s,"description"),...s.getFieldProps("description")}),e.jsx(a.Select,{label:"Access group",options:r,disabled:i,error:b(s,"access_group"),...s.getFieldProps("access_group")}),e.jsx(O,{formik:s})]})},U=t=>t.filter(({series:s})=>s.length&&s.some(({pockets:l})=>l.length)).map(({name:s,series:l})=>({distributionName:s,series:l.filter(({pockets:i})=>i.length).map(({name:i,pockets:r})=>({seriesName:i,pockets:r.map(({name:o,id:c})=>({pocketName:o,value:c}))}))})),J=(t,s)=>{const l=U(t),i=[];for(const{distributionName:r,series:o}of l)if(r.match(s))i.push({distributionName:r,series:o});else{const c=[];for(const{seriesName:n,pockets:h}of o)if(n.match(s))c.push({seriesName:n,pockets:h});else{const g=[];for(const{pocketName:u,value:x}of h)u.match(s)&&g.push({pocketName:u,value:x});g.length&&c.push({seriesName:n,pockets:g})}c.length&&i.push({distributionName:r,series:c})}return i},K="_label_ogejm_1",S={label:K},M=({distributions:t,formik:s})=>{const[l,i]=m.useState(""),r=J(t,l);return e.jsxs(e.Fragment,{children:[e.jsx(y,{label:"Search for pockets",onSearchChange:o=>{i(o)}}),e.jsxs("fieldset",{className:N("checkbox-group",{"is-error":b(s,"pockets")}),children:[e.jsxs(a.Row,{className:"u-no-padding--left u-no-padding--right",children:[e.jsx(a.Col,{small:1,medium:2,size:3,children:e.jsx("p",{className:"p-heading--5 p-text--small p-text--small-caps",children:"Distribution"})}),e.jsx(a.Col,{small:1,medium:2,size:4,children:e.jsx("p",{className:"p-heading--5 p-text--small p-text--small-caps",children:"Series"})}),e.jsx(a.Col,{small:2,medium:2,size:5,children:e.jsx("p",{className:"p-heading--5 p-text--small p-text--small-caps",children:"Pocket"})})]}),r.length===0&&e.jsx("p",{children:`No pockets found with the search: "${l}".`}),r.length>0&&e.jsx("ul",{className:"p-list--divided u-no-margin--bottom",children:r.map(({distributionName:o,series:c})=>e.jsx("li",{className:"p-list__item",children:e.jsxs(a.Row,{className:"u-no-padding--left u-no-padding--right",children:[e.jsx(a.Col,{small:1,medium:2,size:3,children:e.jsx("p",{className:N("u-no-margin--bottom",S.label),children:o})}),e.jsx(a.Col,{small:3,medium:4,size:9,children:e.jsx("ul",{className:"p-list--divided u-no-padding--top u-no-margin--left",children:c.map(({seriesName:n,pockets:h})=>e.jsx("li",{className:"p-list__item",children:e.jsxs(a.Row,{className:"u-no-padding--left u-no-padding--right",children:[e.jsx(a.Col,{small:1,medium:2,size:4,children:e.jsx("p",{className:"u-no-margin--bottom",children:n})}),e.jsx(a.Col,{small:2,medium:2,size:5,children:e.jsx("ul",{className:"p-list--divided u-no-padding--top u-no-margin--left",children:h.map(({pocketName:g,value:u})=>e.jsx("li",{className:"p-list__item",children:e.jsx(a.CheckboxInput,{label:g,labelClassName:S.label,...s.getFieldProps("pockets"),checked:s.values.pockets.includes(u),onChange:()=>s.setFieldValue("pockets",s.values.pockets.includes(u)?s.values.pockets.filter(x=>x!==u):[...s.values.pockets,u])})},u))})})]})},n))})})]})},o))})]}),e.jsx("p",{className:"p-form-help-text",children:`${s.values.pockets.length} selected`})]})},H=({currentTab:t,onCurrentTabChange:s})=>e.jsx(a.Tabs,{links:[{label:"Details",role:"tab",active:t===0,onClick:()=>{s(0)}},{label:"Pockets",role:"tab",active:t===1,onClick:()=>{s(1)}},{label:"APT sources",role:"tab",active:t===2,onClick:()=>{s(2)}}]}),W={access_group:R,all_computers:!1,apt_sources:[],description:"",pockets:[],tags:[],title:""},P={add:{ariaLabel:"Add a new repository profile",label:"Add repository profile"},edit:{ariaLabel:"Edit repository profile",label:"Save changes"}},X=t=>D().shape({access_group:f(),all_computers:I(),apt_sources:_().of(f()),description:f(),pockets:_().of(f()),tags:_().of(f()),title:f().test({message:"This field is required.",params:{action:t},test:s=>t!=="add"||!!s})}),_e=t=>{const[s,l]=m.useState(0),i=v(),{closeSidePanel:r}=E(),{getDistributionsQuery:o}=V(),{getAccessGroupQuery:c}=L(),{getAPTSourcesQuery:n}=$(),{createRepositoryProfileQuery:h,editRepositoryProfileQuery:g}=B(),{data:u}=o(),{data:x}=n(),{data:C}=c({},{enabled:t.action==="add"}),{mutateAsync:A}=h,{mutateAsync:F}=g,d=T({initialValues:W,onSubmit:async p=>{const j={all_computers:p.all_computers,apt_sources:p.apt_sources,description:p.description,pockets:p.pockets,title:p.title};p.all_computers||(j.tags=p.tags);try{t.action==="add"?await A({access_group:p.access_group,...j}):await F({name:t.profile.name,...j}),r()}catch(k){i(k)}},validationSchema:X(t.action)});return m.useEffect(()=>{t.action!=="add"||!d.errors||!d.submitCount||l(0)},[d.submitCount,d.errors,t.action]),m.useEffect(()=>{t.action==="edit"&&d.setValues({access_group:t.profile.access_group,all_computers:t.profile.all_computers,apt_sources:t.profile.apt_sources,description:t.profile.description,pockets:t.profile.pockets.map(({id:p})=>p),tags:t.profile.tags,title:t.profile.title})},[t]),e.jsxs(a.Form,{onSubmit:d.handleSubmit,noValidate:!0,children:[e.jsx(H,{currentTab:s,onCurrentTabChange:p=>{l(p)}}),e.jsxs(z,{children:[s===0&&e.jsx(q,{accessGroups:C?.data??[],isTitleRequired:t.action==="add",isAccessGroupDisabled:t.action==="edit",formik:d}),s===1&&e.jsxs(e.Fragment,{children:[!u?.data.length&&e.jsx("p",{children:"No distributions found."}),u&&u.data.length>0&&e.jsx(M,{distributions:u.data,formik:d})]}),s===2&&e.jsxs(e.Fragment,{children:[!x?.data.length&&e.jsx("p",{children:"No APT sources found."}),x&&x.data.length>0&&e.jsx(Q,{aptSources:x.data,formik:d})]})]}),e.jsx(w,{submitButtonDisabled:d.isSubmitting,submitButtonText:P[t.action].label,submitButtonAriaLabel:P[t.action].ariaLabel})]})};export{_e as default};
