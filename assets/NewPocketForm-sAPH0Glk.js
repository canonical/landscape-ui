import{j as t,h as m,e as G,f as I,r as w,i as N,g as a}from"./index-Ck927htQ.js";import{u as A}from"./formik.esm-BeHAEGbw.js";import{c as V,a as i,b as y,d as T}from"./index.esm-DVEO1SHz.js";import{b as q,c as C,C as E,a as O,A as R,U}from"./series-CPTl2Pc6.js";import{F as L,a as M}from"./debug-BTWnsWuc.js";import{M as $}from"./MultiSelectField-CCom-1t5.js";import{S as D}from"./SidePanelFormButtons-Bz2-NFyW.js";import{u as B}from"./useGPGKeys-JziqMpnS.js";import{a as K}from"./index-DIhtMKCe.js";import{t as S}from"./tests-DFnZqbNV.js";import"./MultiSelectField.module-D1r8qo_i.js";import"./SidePanelFormButtons.module-DyBJG5lm.js";import"./useFetchOld-Bw_PvLnb.js";import"./useMutation-qHwpl5BJ.js";import"./useQuery-CVfp-Q20.js";import"./PageMain-DtaUhLig.js";import"./useDistributions-CSuSd2jJ.js";import"./InfoItem-CG9Eh7-D.js";import"./InfoItem.module-BZ3tYMsb.js";import"./moment-Cl4UOzQZ.js";import"./index-B8LwkN-N.js";import"./useConfirm-BNcLyHnT.js";import"./useInstances-DzQUvDTS.js";import"./moment-IrVVnzQI.js";import"./TablePagination.module-DLVph1Z1.js";import"./TablePagination-D0UxaJGH.js";import"./usePageParams-Cezobf9b.js";import"./EmptyState-BoClkKZD.js";import"./SearchHelpPopup-C_Px2zYH.js";import"./DistributionCard.module-CdGw1YvC.js";const Q=({groupedOptions:o,group:u,option:_,onChange:f,error:d,emptyOption:p,name:g,label:h="",id:k,onBlur:x,className:P,labelClassName:l,wrapperClassName:F,hidden:n,disabled:j,required:e})=>{const b=k??g.replace(/[_\s]/g,"-").replace(/([a-z])(?=[A-Z])/,"$1-").replace(/([A-Z])(?=[a-z])/,"-$1").toLowerCase();return t.jsxs("div",{className:m("p-form-validation",F,{"is-error":!!d}),children:[h&&t.jsx("label",{className:m("p-form__label",l,{"is-required":e}),htmlFor:b,children:h}),t.jsxs("div",{className:"p-form__control u-clearfix",children:[t.jsx("div",{className:"p-form-validation__select-wrapper",children:t.jsxs("select",{id:b,value:_===""?"":`${u}/${_}`,name:g,className:m("p-form-validation__input",P),onChange:r=>{f(r.target[r.target.selectedIndex].dataset.value??"",r.target[r.target.selectedIndex].dataset.group??"")},onBlur:x,disabled:j,hidden:n,"aria-invalid":!!d,"aria-errormessage":d?"pull-pocket-validation-message":void 0,children:[p&&p.enabled&&t.jsx("option",{value:"","data-group":"","data-value":"",children:p.label??""}),o.map(({optGroup:r,options:s})=>t.jsx("optgroup",{label:r,children:s.map(({value:c,label:v})=>t.jsx("option",{value:`${r}/${c}`,"data-group":r,"data-value":c,children:v},c))},r))]})}),!!d&&t.jsxs("p",{className:"p-form-validation__message",id:"pull-pocket-validation-message",children:[t.jsx("strong",{children:"Error:"})," ",d]})]})]})},z=[{label:"Mirror",value:"mirror"},{label:"Pull",value:"pull"},{label:"Upload",value:"upload"}],H=[{label:"Select filter type",value:""},{label:"Allow list",value:"whitelist"},{label:"Disallow list",value:"blacklist"}],Z={type:"ubuntu",series:"",distribution:"",name:"",architectures:[],components:[],gpg_key:"",include_udeb:!1,filter_type:"",mode:"mirror",pull_pocket:"",pull_series:"",mirror_uri:"",upload_allow_unsigned:!1,mirror_suite:"",mirror_gpg_key:"",filter_packages:[],upload_gpg_keys:[]},J=o=>{switch(o.mode){case"mirror":return{mode:o.mode,distribution:o.distribution,series:o.series,name:o.name,architectures:o.architectures,components:o.components,gpg_key:o.gpg_key,include_udeb:o.include_udeb,mirror_uri:o.mirror_uri,mirror_suite:o.mirror_suite,mirror_gpg_key:o.mirror_gpg_key};case"upload":return{mode:o.mode,distribution:o.distribution,series:o.series,name:o.name,architectures:o.architectures,components:o.components,gpg_key:o.gpg_key,include_udeb:o.include_udeb,upload_allow_unsigned:o.upload_allow_unsigned};case"pull":return{mode:o.mode,distribution:o.distribution,series:o.series,name:o.name,architectures:o.architectures,components:o.components,gpg_key:o.gpg_key,include_udeb:o.include_udeb,pull_series:o.pull_series,pull_pocket:o.pull_pocket,filter_type:o.filter_type!==""?o.filter_type:void 0,filter_packages:o.filter_packages};default:return M(o.mode,"pocket mode")}},Te=({distribution:o,series:u})=>{const _=G(),{closeSidePanel:f}=I(),{createPocketQuery:d,addUploaderGPGKeysToPocketQuery:p}=K(),{getGPGKeysQuery:g}=B(),{mutateAsync:h,isLoading:k}=d,{mutateAsync:x,isLoading:P}=p,{data:l}=g(),F=((l==null?void 0:l.data)??[]).filter(({has_secret:r})=>r).map(r=>({label:r.name,value:r.name})),n=((l==null?void 0:l.data)??[]).filter(({has_secret:r})=>!r).map(r=>({label:r.name,value:r.name})),j=V().shape({type:i().required("This field is required."),name:i().required("This field is required").test({test:S.test,message:S.message}).test({params:{series:u},test:r=>!u.pockets.map(({name:s})=>s).includes(r),message:"It must be unique within series."}),distribution:i().required("This field is required"),series:i().required("This field is required"),components:y().defined().of(i().defined()).min(1,"Please choose at least one component").test({name:"flat-mirror-sub-directory",message:"A single component must be passed",test:(r,s)=>{const{mode:c,mirror_suite:v}=s.parent;return c==="mirror"&&/\/$/.test(v)?r.length===1:!0}}).required("This field is required"),architectures:y().defined().of(i().defined()).min(1,"Please choose at least one architecture"),mode:i().required("This field is required"),gpg_key:i().required("This field is required"),include_udeb:T().required("This field is required"),mirror_uri:i().when("mode",{is:"mirror",then:r=>r.required("This field is required")}),mirror_suite:i(),mirror_gpg_key:i(),pull_pocket:i().when("mode",{is:"pull",then:r=>r.required("This field is required")}),pull_series:i(),filter_type:i(),filter_packages:y().of(i().defined()),upload_allow_unsigned:T(),upload_gpg_keys:y().of(i().defined())}),e=A({validationSchema:j,initialValues:Z,onSubmit:async r=>{try{await h(J(r)),r.mode==="upload"&&!r.upload_allow_unsigned&&r.upload_gpg_keys.length&&await x({name:r.name,series:r.series,distribution:r.distribution,gpg_keys:r.upload_gpg_keys}),f()}catch(s){_(s)}}});w.useEffect(()=>{e.setFieldValue("distribution",o.name),e.setFieldValue("series",u.name)},[]),w.useEffect(()=>{e.values.type==="ubuntu"?(e.setFieldValue("components",q.ubuntu),e.setFieldValue("architectures",C.ubuntu),e.values.mode==="mirror"&&e.setFieldValue("mirror_uri",N)):(e.setFieldValue("components",q.thirdParty),e.setFieldValue("architectures",C.thirdParty),e.values.mode==="mirror"&&e.setFieldValue("mirror_uri",""))},[e.values.type,e.values.mode]);const b=o.series.map(r=>({options:r.pockets.map(({name:s})=>({label:s,value:s})),optGroup:r.name}));return t.jsxs(a.Form,{onSubmit:e.handleSubmit,noValidate:!0,children:[t.jsx(a.Select,{label:"Type",required:!0,options:[{label:"Ubuntu",value:"ubuntu"},{label:"Third party",value:"third-party"}],...e.getFieldProps("type"),error:e.touched.type&&e.errors.type?e.errors.type:void 0}),t.jsx(a.Select,{label:"Mode",required:!0,options:[...z],...e.getFieldProps("mode"),error:e.touched.mode&&e.errors.mode?e.errors.mode:void 0}),e.values.mode==="mirror"&&t.jsx(a.Input,{type:"text",label:"Mirror URI",required:!0,...e.getFieldProps("mirror_uri"),error:e.touched.mirror_uri&&e.errors.mirror_uri?e.errors.mirror_uri:void 0}),t.jsxs("div",{className:m({row:e.values.mode==="pull","u-no-padding--left":e.values.mode==="pull","u-no-padding--right":e.values.mode==="pull"}),children:[t.jsx(a.Input,{type:"text",label:"Name",required:!0,wrapperClassName:m({"col-6":e.values.mode==="pull"}),style:{display:"block !important"},...e.getFieldProps("name"),error:e.touched.name&&e.errors.name?e.errors.name:void 0}),e.values.mode=="pull"&&t.jsx(Q,{label:"Pull from",required:!0,name:"pull_pocket",wrapperClassName:"col-6",groupedOptions:b,option:e.values.pull_pocket,group:e.values.pull_series,emptyOption:{enabled:!0,label:"Select pull pocket"},onChange:async(r,s)=>{await e.setFieldValue("pull_pocket",r),await e.setFieldValue("pull_series",s)},onBlur:e.handleBlur,error:e.touched.pull_pocket&&e.errors.pull_pocket?e.errors.pull_pocket:void 0})]}),t.jsx(a.Select,{label:"GPG Key",required:!0,options:[{label:"Select GPG key",value:""},...F],...e.getFieldProps("gpg_key"),error:e.touched.gpg_key&&e.errors.gpg_key?e.errors.gpg_key:void 0}),e.values.mode==="mirror"&&t.jsxs(t.Fragment,{children:[t.jsx(a.Input,{type:"text",label:t.jsx(L,{label:"Mirror suite",description:t.jsxs(t.Fragment,{children:[t.jsx("span",{children:"The specific sub-directory under dists/ that should be mirrored. If the suite name ends with a ‘/’, the remote repository is flat (no dists/ structure, see "}),t.jsx("a",{href:"http://wiki.debian.org/RepositoryFormat#Flat_Repository_Format",target:"_blank",rel:"nofollow noopener noreferrer",children:"wiki.debian.org/RepositoryFormat#Flat_Repository_Format"}),t.jsx("span",{children:"); in this case a single value must be passed for the ‘components’ parameter. Packages from the remote repository will be mirrored in the specified component. This parameter is optional and defaults to the same name as local series and pocket."})]})}),...e.getFieldProps("mirror_suite"),error:e.touched.mirror_suite&&e.errors.mirror_suite?e.errors.mirror_suite:void 0}),t.jsx(a.Select,{label:"Mirror GPG key",options:[{label:"Select GPG key",value:""},...n],...e.getFieldProps("mirror_gpg_key"),error:e.touched.mirror_gpg_key&&e.errors.mirror_gpg_key?e.errors.mirror_gpg_key:void 0,help:"If none is given, the stock Ubuntu archive one will be used."})]}),e.values.mode==="pull"&&t.jsxs(t.Fragment,{children:[t.jsx(a.Select,{label:"Filter type",options:H,...e.getFieldProps("filter_type"),error:e.touched.filter_type&&e.errors.filter_type?e.errors.filter_type:void 0}),e.values.filter_type!==""&&t.jsx(a.Textarea,{label:"Filter packages",rows:3,help:"List packages to filter separated by commas",...e.getFieldProps("filter_packages"),onChange:r=>{e.setFieldValue("filter_packages",r.target.value.replace(/\s/g,"").split(","))},value:e.values.filter_packages.join(","),error:e.touched.filter_packages&&e.errors.filter_packages?e.errors.filter_packages:void 0})]}),e.values.mode==="upload"&&t.jsxs(t.Fragment,{children:[t.jsx(a.CheckboxInput,{label:"Allow uploaded packages to be unsigned",...e.getFieldProps("upload_allow_unsigned"),checked:e.values.upload_allow_unsigned}),t.jsx($,{variant:"condensed",label:"Uploader GPG keys",disabled:e.values.upload_allow_unsigned,items:n,selectedItems:n.filter(({value:r})=>e.values.upload_gpg_keys.includes(r)),onItemsUpdate:r=>{e.setFieldValue("upload_gpg_keys",r.map(({value:s})=>s))},error:e.touched.upload_gpg_keys&&(Array.isArray(e.errors.upload_gpg_keys)?e.errors.upload_gpg_keys[0]:e.errors.upload_gpg_keys)||void 0})]}),e.values.type==="ubuntu"&&t.jsxs(t.Fragment,{children:[t.jsx(E,{label:"Components",required:!0,options:O,...e.getFieldProps("components"),onChange:r=>{e.setFieldValue("components",r)},error:e.touched.components&&e.errors.components?e.errors.components:void 0}),t.jsx(E,{label:"Architectures",required:!0,options:R,...e.getFieldProps("architectures"),onChange:r=>{e.setFieldValue("architectures",r)},error:e.touched.architectures&&e.errors.architectures?e.errors.architectures:void 0})]}),e.values.type==="third-party"&&t.jsxs(t.Fragment,{children:[t.jsx(a.Input,{type:"text",label:"Components",required:!0,...e.getFieldProps("components"),value:e.values.components.join(","),onChange:r=>{e.setFieldValue("components",r.target.value.replace(/\s/g,"").split(","))},error:e.touched.components&&e.errors.components?e.errors.components:void 0}),t.jsx(a.Input,{type:"text",label:"Architectures",required:!0,...e.getFieldProps("architectures"),value:e.values.architectures.join(","),onChange:r=>{e.setFieldValue("architectures",r.target.value.replace(/\s/g,"").split(","))},error:e.touched.architectures&&e.errors.architectures?e.errors.architectures:void 0})]}),t.jsx(U,{formik:e}),t.jsx(D,{submitButtonDisabled:k||P,submitButtonText:"Add",submitButtonAriaLabel:"Add pocket"})]})};export{Te as default};
