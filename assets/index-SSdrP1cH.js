import{i as J,q as K,k as P,n as l,m as W,G as m,w as X,t as Z,r as g,j as s,d as r}from"./index-CSSscRtK.js";import{u as ee,c as u}from"./index-BWcCuRdL.js";import{C as te}from"./CodeEditor-BKtBG8oA.js";import{u as ie}from"./useRoles-d-hhyBKL.js";import{S as ae}from"./SidePanelFormButtons-0L6kGGLA.js";import"./useFetchOld-Bg7OzTFV.js";import"./moment-C5S46NFB.js";import"./SidePanelFormButtons.module-yv6Qz3cN.js";const se={add:"Add script",copy:"Copy script",edit:"Save changes"},re={title:"",code:"",access_group:"",time_limit:300,username:"",attachments:{first:null,second:null,third:null,fourth:null,fifth:null},attachmentsToRemove:[]},be=i=>{var S,_,y,x,F,j,A,C,T,w;const{closeSidePanel:B}=J(),N=K(),{getAccessGroupQuery:q}=ie(),{createScriptQuery:E,editScriptQuery:R,copyScriptQuery:$,getScriptCodeQuery:v,createScriptAttachmentQuery:Q,removeScriptAttachmentQuery:L}=ee(),{mutateAsync:O}=E,{mutateAsync:h}=R,{mutateAsync:k}=$,{mutateAsync:D}=Q,{mutateAsync:M}=L,G=P().shape({title:l().required("This field is required"),time_limit:W().required("This field is required"),code:l().test({name:"required",message:"This field is required",test:t=>i.action==="copy"||i.action==="edit"||!!t}),username:l(),access_group:l(),attachments:P().shape({first:m().nullable(),second:m().nullable(),third:m().nullable(),fourth:m().nullable(),fifth:m().nullable()}),attachmentsToRemove:X().of(l())}),f=async(t,a)=>{const c=[],o=[],I=[];for(const n of a)n&&(o.push(n.arrayBuffer()),I.push(n.name));const V=await Promise.all(o);for(let n=0;n<V.length;n++)c.push(D({script_id:t,file:`${I[n]}$$${u.Buffer.from(V[n]).toString("base64")}`}));await Promise.all(c)},e=Z({initialValues:re,validationSchema:G,onSubmit:async t=>{try{if(i.action==="add"){const a=await O({title:t.title,time_limit:t.time_limit,code:u.Buffer.from(t.code).toString("base64"),username:t.username,access_group:t.access_group});await f(a.data.id,Object.values(t.attachments))}else if(i.action==="edit"){const a=[],c=Object.values(t.attachments).filter(o=>o);for(const o of t.attachmentsToRemove)a.push(M({script_id:i.script.id,filename:o}));a.length?(await Promise.all([...a,h({script_id:i.script.id,title:t.title,time_limit:t.time_limit,code:u.Buffer.from(t.code).toString("base64"),username:t.username})]),c.length&&await f(i.script.id,c)):c.length?await Promise.all([h({script_id:i.script.id,title:t.title,time_limit:t.time_limit,code:u.Buffer.from(t.code).toString("base64"),username:t.username}),f(i.script.id,Object.values(t.attachments))]):await h({script_id:i.script.id,title:t.title,time_limit:t.time_limit,code:u.Buffer.from(t.code).toString("base64"),username:t.username})}else i.action==="copy"&&await k({script_id:i.script.id,destination_title:t.title,access_group:t.access_group});H()}catch(a){N(a)}}}),H=()=>{e.resetForm(),B()};g.useEffect(()=>{i.action!=="add"&&(i.action==="copy"?e.setFieldValue("access_group",i.script.access_group):i.action==="edit"&&(e.setFieldValue("title",i.script.title),e.setFieldValue("time_limit",i.script.time_limit),e.setFieldValue("username",i.script.username),e.setFieldValue("access_group",i.script.access_group)))},[i.action]);const{data:b,isFetching:p}=v({script_id:i.action==="edit"?i.script.id:0},{enabled:i.action==="edit"});g.useEffect(()=>{p||e.setFieldValue("code",(b==null?void 0:b.data)??"")},[p]);const{data:d}=q(),U=g.useMemo(()=>((d==null?void 0:d.data)??[]).map(({name:t,title:a})=>({label:a,value:t})),[d]),Y=[s.jsx(r.Input,{type:"file",label:"First attachment",labelClassName:"u-off-screen",onChange:t=>{var a;e.setFieldValue("attachments.first",((a=t.target.files)==null?void 0:a[0])??null)},error:((S=e.touched.attachments)==null?void 0:S.first)&&((_=e.errors.attachments)==null?void 0:_.first)},"first"),s.jsx(r.Input,{type:"file",label:"Second attachment",labelClassName:"u-off-screen",onChange:t=>{var a;e.setFieldValue("attachments.second",((a=t.target.files)==null?void 0:a[0])??null)},error:((y=e.touched.attachments)==null?void 0:y.second)&&((x=e.errors.attachments)==null?void 0:x.second)},"second"),s.jsx(r.Input,{type:"file",label:"Third attachment",labelClassName:"u-off-screen",onChange:t=>{var a;e.setFieldValue("attachments.third",((a=t.target.files)==null?void 0:a[0])??null)},error:((F=e.touched.attachments)==null?void 0:F.third)&&((j=e.errors.attachments)==null?void 0:j.third)},"third"),s.jsx(r.Input,{type:"file",label:"Fourth attachment",labelClassName:"u-off-screen",onChange:t=>{var a;e.setFieldValue("attachments.fourth",((a=t.target.files)==null?void 0:a[0])??null)},error:((A=e.touched.attachments)==null?void 0:A.fourth)&&((C=e.errors.attachments)==null?void 0:C.fourth)},"fourth"),s.jsx(r.Input,{type:"file",label:"Fifth attachment",labelClassName:"u-off-screen",onChange:t=>{var a;e.setFieldValue("attachments.fifth",((a=t.target.files)==null?void 0:a[0])??null)},error:((T=e.touched.attachments)==null?void 0:T.fifth)&&((w=e.errors.attachments)==null?void 0:w.fifth)},"fifth")],z=()=>{const t=Y;if(i.action==="edit"){const a=i.script.attachments.filter(c=>!e.values.attachmentsToRemove.includes(c)).reverse();for(const c of a)t.unshift(s.jsxs("div",{children:[s.jsx("span",{children:c}),s.jsx(r.Button,{type:"button",hasIcon:!0,appearance:"base",className:"u-no-margin--bottom u-no-padding--left","aria-label":`Remove ${c} attachment`,onClick:()=>{e.setFieldValue("attachmentsToRemove",[...e.values.attachmentsToRemove,c])},children:s.jsx(r.Tooltip,{message:"Remove",position:"top-center",children:s.jsx(r.Icon,{name:r.ICONS.delete})})})]},c))}return t.slice(0,5)};return s.jsxs(r.Form,{onSubmit:e.handleSubmit,noValidate:!0,children:[s.jsx(r.Input,{type:"text",label:"Title",required:!0,...e.getFieldProps("title"),error:e.touched.title&&e.errors.title?e.errors.title:void 0}),(i.action==="add"||i.action==="edit")&&s.jsxs(s.Fragment,{children:[s.jsx(r.Input,{type:"number",label:"Time limit (seconds)",required:!0,...e.getFieldProps("time_limit"),error:e.touched.time_limit&&e.errors.time_limit?e.errors.time_limit:void 0}),s.jsx(te,{label:"Code",required:!0,onChange:t=>{e.setFieldValue("code",t??"")},value:e.values.code,error:e.touched.code&&e.errors.code?e.errors.code:void 0}),s.jsx(r.Input,{type:"text",label:"Run as user",...e.getFieldProps("username"),error:e.touched.username&&e.errors.username?e.errors.username:void 0})]}),s.jsx(r.Select,{label:"Access group",options:[{label:"Select access group",value:""},...U],...e.getFieldProps("access_group"),error:e.touched.access_group&&e.errors.access_group?e.errors.access_group:void 0}),(i.action==="add"||i.action==="edit")&&s.jsxs(s.Fragment,{children:[s.jsx("h5",{children:"List of attachments"}),s.jsx("p",{className:"u-text--muted",children:"Attachments that will be sent along with the script. You can attach up to 5 files, for a maximum of 1.00MB. Filenames must be unique. On the client, the attachments will be placed in the directory whose name is accessible through the environment variable LANDSCAPE_ATTACHMENTS. They'll be deleted once the script has been run."})]}),(i.action==="add"||i.action==="edit")&&z(),s.jsx(ae,{submitButtonDisabled:e.isSubmitting,submitButtonText:se[i.action]})]})};export{be as default};
