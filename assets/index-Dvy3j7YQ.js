import{m as v,p as b,n as a,o as c,s as T,k as x,w as j,i as F,l as $,j as t,h as n}from"./index-B9SYUVLW.js";import{m as A}from"./moment-dBlfoK5t.js";import{M as m}from"./MultiSelectField-8551Ugj_.js";import{S as P}from"./SidePanelFormButtons-BoZ1OVm_.js";import{u as _}from"./useInstances-WnKEN3sh.js";import{u as k,D as N}from"./index-W0eUvAQY.js";import"./SidePanelFormButtons.module-yv6Qz3cN.js";import"./useFetchOld-CRdEVo4H.js";import"./CodeEditor-XIJrhujo.js";import"./useRoles-BSfsI1mU.js";import"./moment-C5S46NFB.js";const O={deliverImmediately:!0,deliver_after:"",instanceIds:[],queryType:"tags",tags:[],username:""},V=v().shape({deliverImmediately:b().required("This field is required."),deliver_after:a().when("deliverImmediately",{is:!1,then:r=>r.required("This field is required.")}),instanceIds:c().of(T()).when("queryType",{is:"ids",then:r=>r.min(1,"At least one instance is required.")}),queryType:a().required("This field is required."),tags:c().of(a()).when("queryType",{is:"tags",then:r=>r.min(1,"At least one tag is required.")}),username:a().required("This field is required.")}),z=({script:r})=>{const p=x(),{notify:y}=j(),{closeSidePanel:g}=F(),{getAllInstanceTagsQuery:f,getInstancesQuery:q}=_(),{executeScriptQuery:I}=k(),{mutateAsync:h}=I,e=$({initialValues:O,onSubmit:async s=>{const i={query:s.queryType==="ids"?`id:${s.instanceIds.join(" OR id:")}`:`tag:${s.tags.join(" OR tag:")}`,script_id:r.id,username:s.username};s.deliverImmediately||(i.deliver_after=A(s.deliver_after).toISOString().replace(/\.\d+(?=Z$)/,""));try{await h(i),g(),y.success({message:`"${r.title}" script queued to execute successfully`,title:"Script execution queued"})}catch(S){p(S)}},validationSchema:V}),{data:o}=f(),d=(o==null?void 0:o.data.results.map(s=>({label:s,value:s})))??[],{data:u}=q(),l=(u==null?void 0:u.data.results.map(({title:s,id:i})=>({label:s,value:i})))??[];return t.jsxs(n.Form,{onSubmit:e.handleSubmit,noValidate:!0,children:[t.jsx("p",{className:"u-no-margin--bottom",children:"Select instances by:"}),t.jsxs("div",{className:"p-form--inline is-required",children:[t.jsx(n.Input,{type:"radio",label:"Tags",...e.getFieldProps("queryType"),value:"tags",checked:e.values.queryType==="tags"}),t.jsx(n.Input,{type:"radio",label:"Names",...e.getFieldProps("queryType"),value:"ids",checked:e.values.queryType==="ids"})]}),e.values.queryType==="tags"&&t.jsx(m,{variant:"condensed",label:"Tags",required:!0,...e.getFieldProps("tags"),items:d,selectedItems:d.filter(({value:s})=>e.values.tags.includes(s)),onItemsUpdate:s=>e.setFieldValue("tags",s.map(({value:i})=>i)),error:e.touched.tags&&typeof e.errors.tags=="string"?e.errors.tags:void 0}),e.values.queryType==="ids"&&t.jsx(m,{variant:"condensed",label:"Instances",required:!0,...e.getFieldProps("instanceIds"),items:l,selectedItems:l.filter(({value:s})=>e.values.instanceIds.includes(s)),onItemsUpdate:s=>e.setFieldValue("instanceIds",s.map(({value:i})=>i)),error:e.touched.instanceIds&&typeof e.errors.instanceIds=="string"?e.errors.instanceIds:void 0}),t.jsx(n.Input,{type:"text",label:"Run as user",autoComplete:"off",required:!0,...e.getFieldProps("username"),error:e.touched.username&&e.errors.username?e.errors.username:void 0}),t.jsx(N,{formik:e}),t.jsx(P,{submitButtonDisabled:e.isSubmitting,submitButtonText:"Run script"})]})};export{z as default};
