import{d as T,k as _,l as A,B as G,f as m,s as M,t as E,v as B,a3 as w,w as N,j as a,a as Q,e as o,x as g}from"./index-CmSMPezD.js";import{M as V}from"./MultiSelectField-B3pDsC9j.js";import{S as k}from"./SidePanelFormButtons-CjUuXzzk.js";import{u as q,T as D}from"./TagsAddConfirmationModal-z_TWllRV.js";import{u as L}from"./useGetTags-DJiNc4pX.js";import{u as O}from"./useRoles-BTw0Yb4r.js";import"./SidePanelFormButtons.module-CcPyiogC.js";import"./ModalTablePagination-B4EN9Q-h.js";const R=()=>{const t=T(),n=_(),{isPending:l,mutateAsync:c}=A({mutationFn:async({instanceId:u,...d})=>t.put(`computers/${u}`,d),onSuccess:async()=>Promise.all([n.invalidateQueries({queryKey:["instances"]}),n.invalidateQueries({queryKey:["instanceTags"]})])});return{editInstance:c,isEditingInstance:l}},$=G().shape({access_group:m(),comment:m(),title:m()}),K="_chips_1xjs2_1",H={chips:K},se=({instance:t})=>{const{closeSidePanel:n}=M(),l=E(),{notify:c}=B(),{getAccessGroupQuery:u}=O(),{data:d,isPending:f}=u(),{tags:h,isGettingTags:b}=L(),{editInstance:x}=R(),{value:y,setTrue:S,setFalse:F}=w(),s=N({initialValues:{title:t.title,comment:t.comment,access_group:t.access_group,tags:t.tags},onSubmit:async e=>{try{await x({instanceId:t.id,...e}),n(),c.success({title:"Instance updated",message:`Instance "${t.title}" updated successfully`})}catch(i){l(i)}},validationSchema:$}),r=s.values.tags.filter(e=>!t.tags.includes(e)),{isFetchingProfileChanges:v,profileChangesCount:j,refetchProfileChanges:P}=q({instance_ids:[t.id],tags:r,limit:10},{enabled:!1}),C=async()=>{if(r.length){const e=await P();e.isSuccess?e.data.data.count?S():s.handleSubmit():l(e.error)}else s.handleSubmit()};if(f||b)return a.jsx(Q,{});const I=d?.data.map(({name:e,title:i})=>({label:i,value:e}))??[],p=h.map(e=>({label:e,value:e}))??[];return a.jsxs(a.Fragment,{children:[a.jsxs(o.Form,{onSubmit:e=>{e.preventDefault(),C()},className:"l-form",noValidate:!0,children:[a.jsx(o.Input,{label:"Title","aria-label":"Title",type:"text",required:!0,disabled:t.is_wsl_instance,...s.getFieldProps("title"),error:g(s,"title")}),a.jsx(o.Select,{label:"Access group",options:I,...s.getFieldProps("access_group"),error:g(s,"access_group")}),a.jsx(V,{label:"Tags",placeholder:"Search and add tags",...s.getFieldProps("tags"),items:p,selectedItems:p.filter(({value:e})=>s.values.tags.includes(e)),onItemsUpdate:async e=>s.setFieldValue("tags",e.map(({value:i})=>i))}),a.jsx("div",{className:H.chips,children:s.values.tags.map(e=>a.jsx(o.Chip,{className:"u-no-margin--bottom u-no-margin--right",value:e,onDismiss:async()=>s.setFieldValue("tags",s.values.tags.filter(i=>i!==e))},e))}),a.jsx(o.Textarea,{label:"Comment",rows:3,...s.getFieldProps("comment"),error:g(s,"comment")}),a.jsx(k,{submitButtonLoading:s.isSubmitting||r&&v,submitButtonText:"Save changes"})]}),y&&a.jsx(D,{instances:[t],tags:r,onConfirm:()=>{s.handleSubmit()},confirmButtonLoading:s.isSubmitting,close:F,profileChangesCount:j})]})};export{se as default};
