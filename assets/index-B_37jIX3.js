import{m as B,e as w,f as L,l as P,j as e,g as i,r as j,L as A,R as M}from"./index-DjN6NDkk.js";import{u as F}from"./useConfirm-DfWcK83z.js";import{u as v}from"./useWsl-DqT0M-mr.js";import{u as W}from"./formik.esm-DFe7W_K3.js";import{c as E,a as T,g as R}from"./index.esm-DhV5muB4.js";import{S as q}from"./SidePanelFormButtons-DcwlKwEy.js";import"./moment-Cl4UOzQZ.js";import"./InfoItem.module-BZ3tYMsb.js";import{useActivities as U}from"./index-BR9CYidm.js";import{F as Q}from"./FileInput-v0ivhN5C.js";import{E as V}from"./EmptyState-DDT28izc.js";import"./useFetchOld-D4uGCnIe.js";import"./useMutation-CPZ6Lp07.js";import"./useQuery-CsSPQ_-7.js";import"./SidePanelFormButtons.module-DyBJG5lm.js";import"./InfoItem-B24rOkZr.js";import"./useInstances-Bd32Lqj6.js";import"./moment-B5xCd7tk.js";import"./TablePagination.module-DLVph1Z1.js";import"./TablePagination-BvT4Pax9.js";import"./usePageParams-WA20WKVO.js";import"./SearchHelpPopup-Bk2D-Z31.js";const p={instanceType:{slug:"instanceType",label:"Instance type",type:"select",options:[{label:"Custom",value:"custom"}]},cloudInit:{slug:"cloudInit",label:"Cloud-init",type:"file"},instanceName:{slug:"instanceName",label:"Instance name",type:"text"},rootfs:{slug:"rootfs",label:"Rootfs URL",type:"text"}},Y=[/^ubuntu$/,/^ubuntu-preview$/,/^ubuntu-[0-9]{2}\.[0-9]{2}$/],H=1,O=o=>{if(o)return new Promise((a,d)=>{const l=new FileReader;l.readAsDataURL(o),l.onload=()=>a(l.result),l.onerror=u=>d(u)})},D=()=>{const{instanceId:o}=B(),a=w(),{closeSidePanel:d}=L(),{notify:l}=P(),{createChildInstanceQuery:u,getWslInstanceNamesQuery:h}=v(),{openActivityDetails:b}=U(),{data:m,isLoading:f}=h(),{mutateAsync:y}=u,s=W({initialValues:{instanceType:"Ubuntu",cloudInit:null,instanceName:"",rootfs:""},validationSchema:E({instanceType:T().required("This field is required"),cloudInit:R().nullable().test("file-size","File size must be less than 1MB",n=>n?n.size===void 0?!1:n.size<=H*1024*1024:!0).test("file-type","File type must be YAML",n=>n?n.type==="application/x-yaml"||n.type==="application/yaml":!0),instanceName:T().when("instanceType",{is:"custom",then:n=>n.required("This field is required").test("not-match-reserved-patterns","Instance name cannot match 'ubuntu', 'ubuntu-preview', or 'ubuntu-<dd>.<dd>'",c=>!Y.some(C=>C.test(c.toLowerCase())))}),rootfs:T().url().when("instanceType",{is:"custom",then:n=>n.required("This field is required")})}),onSubmit:async n=>{try{const c=await O(n.cloudInit),C=c?c.split(",")[1]:void 0,{data:S}=await y({parent_id:parseInt(o??""),computer_name:n.instanceType==="custom"?n.instanceName:n.instanceType,rootfs_url:n.instanceType==="custom"?n.rootfs:void 0,cloud_init:C});d(),l.success({message:"You queued a new WSL instance to be installed",actions:[{label:"View details",onClick:()=>b(S)}]})}catch(c){a(c)}}}),g=(m==null?void 0:m.data.map(({label:n,name:c})=>({label:n,value:c})))||[],x=async n=>{await s.setFieldValue("cloudInit",n[0])},I=async()=>{await s.setFieldValue("cloudInit",null)};return e.jsxs(i.Form,{onSubmit:s.handleSubmit,noValidate:!0,children:[e.jsx(i.Select,{label:p.instanceType.label,required:!0,disabled:f,options:[...g,...p.instanceType.options],...s.getFieldProps("instanceType"),error:s.touched.instanceType&&s.errors.instanceType?s.errors.instanceType:void 0}),s.values.instanceType==="custom"&&e.jsxs(e.Fragment,{children:[e.jsx(i.Input,{label:p.instanceName.label,type:p.instanceName.type,required:!0,...s.getFieldProps("instanceName"),error:s.touched.instanceName&&s.errors.instanceName?s.errors.instanceName:void 0}),e.jsx(i.Input,{label:p.rootfs.label,type:p.rootfs.type,required:!0,...s.getFieldProps("rootfs"),error:s.touched.rootfs&&s.errors.rootfs?s.errors.rootfs:void 0})]}),e.jsx(Q,{label:p.cloudInit.label,accept:".yaml",...s.getFieldProps("cloudInit"),onFileRemove:I,onFileUpload:x,help:"You can use a cloud-init configuration YAML file under 1MB to register new WSL instances. Cloud-init streamlines the setup by automating installation and configuration tasks.",error:s.touched.cloudInit&&s.errors.cloudInit?s.errors.cloudInit:void 0}),e.jsx(q,{submitButtonDisabled:s.isSubmitting,submitButtonText:"Install",submitButtonAriaLabel:"Install new WSL instance"})]})},z="_container_13w3p_1",X="_searchContainer_13w3p_6",Z="_cta_13w3p_10",N={container:z,searchContainer:X,cta:Z},G=({resetQuery:o,selectedInstances:a,setQuery:d})=>{const[l,u]=j.useState(""),h=w(),{setSidePanelContent:b}=L(),{confirmModal:m,closeConfirmModal:f}=F(),{deleteChildInstancesQuery:y}=v(),{mutateAsync:s}=y,g=async()=>{try{await s({computer_ids:a.map(({id:n})=>n)})}catch(n){h(n)}finally{f()}},x=()=>{m({title:`Delete ${a.length===1?a[0].title:"selected instances"}`,body:`This will remove selected WSL ${a.length===1?"instance":"instances"} from the host and Landscape`,buttons:[e.jsx(i.Button,{appearance:"negative",onClick:g,children:"Uninstall"},"uninstall")]})},I=n=>{n.preventDefault(),d(l)};return e.jsxs("div",{className:N.container,children:[e.jsx("div",{className:N.searchContainer,children:e.jsx(i.Form,{onSubmit:I,noValidate:!0,children:e.jsx(i.SearchBox,{onChange:n=>u(n),value:l,onSearch:()=>d(l),autocomplete:"off",onClear:()=>{o(),u("")}})})}),e.jsxs("div",{className:N.cta,children:[e.jsx(i.Button,{type:"button",onClick:()=>{b("Install new WSL instance",e.jsx(D,{}))},children:e.jsx("span",{children:"Install new instance"})}),e.jsx(i.Button,{type:"button",onClick:x,disabled:a.length===0,children:e.jsx("span",{children:"Uninstall"})})]})]})},J="_title_6t0ne_1",K="_actions_6t0ne_5",k={title:J,actions:K},ee=({instance:o})=>{const[a,d]=j.useState([]),[l,u]=j.useState(""),h=w(),{confirmModal:b,closeConfirmModal:m}=F(),{setDefaultChildInstanceQuery:f,deleteChildInstancesQuery:y}=v(),s=j.useMemo(()=>l?o.children.filter(({title:t,hostname:r})=>t.toLowerCase().includes(l.toLowerCase())||r.toLowerCase().includes(l.toLowerCase())):o.children,[o,l]),{mutateAsync:g}=f,{mutateAsync:x}=y,I=async t=>{try{await g({child_id:t,parent_id:o.id})}catch(r){h(r)}finally{m()}},n=t=>{b({title:"Set default instance",body:`Are you sure you want to set ${t.title} as default instance?`,buttons:[e.jsx(i.Button,{appearance:"positive",onClick:()=>I(t.id),children:"Set default"},"set-default")]})},c=async t=>{try{await x({computer_ids:[t]})}catch(r){h(r)}finally{m()}},C=t=>{b({title:`Delete ${t.title}`,body:"This will remove the WSL instance from the host and Landscape",buttons:[e.jsx(i.Button,{appearance:"negative",onClick:()=>c(t.id),children:"Delete"},"delete")]})},S=t=>{d(r=>r.some(({id:_})=>_===t.id)?r.filter(({id:_})=>_!==t.id):[...r,t])},$=j.useMemo(()=>[{accessor:"title",Header:e.jsxs(e.Fragment,{children:[e.jsx(i.CheckboxInput,{inline:!0,label:e.jsx("span",{className:"u-off-screen",children:"Toggle all instances"}),checked:s.length>0&&a.length===s.length,indeterminate:a.length>0&&a.length<s.length,onChange:()=>{d(a.length>0?[]:s)}}),e.jsx("span",{children:"Title"})]}),Cell:({row:t})=>e.jsxs("div",{className:k.title,children:[e.jsx(i.CheckboxInput,{label:e.jsx("span",{className:"u-off-screen",children:`Toggle ${t.original.title} instance`}),labelClassName:"u-no-margin--bottom u-no-padding--top",checked:a.some(({id:r})=>r===t.original.id),onChange:()=>S(t.original)}),e.jsx(A,{to:`${M}instances/${o.id}/${t.original.id}`,children:t.original.title})]})},{accessor:"distribution",Header:"OS",Cell:({row:{original:t}})=>t.distribution?`UbuntuÂ ${t.distribution}`:"Unknown"},{accessor:"default",Header:"Default",Cell:({row:t})=>e.jsx("span",{children:t.original.title===o.default_child?"Yes":"No"})},{accessor:"actions",className:k.actions,Cell:({row:t})=>e.jsxs("div",{className:"divided-blocks",children:[e.jsx("div",{className:"divided-blocks__item",children:e.jsxs(i.Button,{small:!0,hasIcon:!0,type:"button",appearance:"base",className:"u-no-margin--bottom u-no-padding--left p-tooltip--btm-right","aria-label":`Set ${t.original.title} as default instance`,onClick:()=>n(t.original),children:[e.jsx("span",{className:"p-tooltip__message",children:"Set default instance"}),e.jsx("i",{className:"p-icon--pin u-no-margin--left"})]})}),e.jsx("div",{className:"divided-blocks__item",children:e.jsxs(i.Button,{small:!0,hasIcon:!0,type:"button",appearance:"base",className:"u-no-margin--bottom u-no-padding--left p-tooltip--btm-right","aria-label":`Delete ${t.original.title} instance`,onClick:()=>C(t.original),children:[e.jsx("span",{className:"p-tooltip__message",children:"Delete instance"}),e.jsx("i",{className:"p-icon--delete u-no-margin--left"})]})})]})}],[s,a]);return e.jsxs(e.Fragment,{children:[e.jsx(G,{resetQuery:()=>{u("")},selectedInstances:a,setQuery:t=>{u(t)}}),e.jsx(i.ModularTable,{columns:$,data:s})]})},te=({instance:o})=>{const{setSidePanelContent:a}=L();return o.children.length===0?e.jsx(V,{title:"No WSL Instances found",body:e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"This computer does not have any WSL instances installed. You can install a new instance by clicking the button below."}),e.jsxs(i.Link,{href:"https://ubuntu.com/desktop/wsl",target:"_blank",rel:"nofollow noopener noreferrer",children:["Learn more about Ubuntu WSL",e.jsx("i",{className:"p-icon--external-link"})]})]}),cta:[e.jsx(i.Button,{appearance:"positive",type:"button",onClick:()=>{a("Install new WSL instance",e.jsx(D,{}))},children:e.jsx("span",{children:"Install new WSL instance"})},"install-new-instance-button")]}):e.jsx(ee,{instance:o})},_e=te;export{_e as default};
