import{j as t,g as m,k as I,i as N,m as G,n as s,o as b,p as v,l as A,r as w,q as V,h as l}from"./index-DAhtk5GF.js";import{b as q,c as T,C as S,a as O,A as R,U}from"./series-2fAyX2LJ.js";import{F as M,a as $}from"./debug-RRfd3zZ5.js";import{M as D}from"./MultiSelectField-D2ND50KY.js";import{S as L}from"./SidePanelFormButtons-DHKPo5cU.js";import{u as B}from"./useGPGKeys-oDKjHGAO.js";import{a as K}from"./index-uMKBxOI3.js";import{t as C}from"./tests-DFnZqbNV.js";import"./SidePanelFormButtons.module-yv6Qz3cN.js";import"./useFetchOld-qJWyCQUA.js";import"./PageMain-CTkfHz5C.js";import"./useDistributions-ome62Xw1.js";import"./InfoItem-bAnFh9RK.js";import"./moment-C5S46NFB.js";import"./NoData-BEjJr0I4.js";import"./index-BIyCktfX.js";import"./moment-CZ07QsxO.js";import"./TablePagination-BTUlmTvF.js";import"./TablePagination.module-CgQ3jx4B.js";import"./usePageParams-DPJbXdif.js";import"./SearchHelpPopup-CoSoBYpj.js";import"./DistributionCard.module-BJwqEI-8.js";const Q=({groupedOptions:o,group:p,option:_,onChange:y,error:u,emptyOption:n,name:g,label:h="",id:f,onBlur:d,className:k,labelClassName:c,wrapperClassName:x,hidden:e,disabled:F,required:r})=>{const i=f??g.replace(/[_\s]/g,"-").replace(/([a-z])(?=[A-Z])/,"$1-").replace(/([A-Z])(?=[a-z])/,"-$1").toLowerCase();return t.jsxs("div",{className:m("p-form-validation",x,{"is-error":!!u}),children:[h&&t.jsx("label",{className:m("p-form__label",c,{"is-required":r}),htmlFor:i,children:h}),t.jsxs("div",{className:"p-form__control u-clearfix",children:[t.jsx("div",{className:"p-form-validation__select-wrapper",children:t.jsxs("select",{id:i,value:_===""?"":`${p}/${_}`,name:g,className:m("p-form-validation__input",k),onChange:a=>{y(a.target[a.target.selectedIndex].dataset.value??"",a.target[a.target.selectedIndex].dataset.group??"")},onBlur:d,disabled:F,hidden:e,"aria-invalid":!!u,"aria-errormessage":u?"pull-pocket-validation-message":void 0,children:[n&&n.enabled&&t.jsx("option",{value:"","data-group":"","data-value":"",children:n.label??""}),o.map(({optGroup:a,options:P})=>t.jsx("optgroup",{label:a,children:P.map(({value:j,label:E})=>t.jsx("option",{value:`${a}/${j}`,"data-group":a,"data-value":j,children:E},j))},a))]})}),!!u&&t.jsxs("p",{className:"p-form-validation__message",id:"pull-pocket-validation-message",children:[t.jsx("strong",{children:"Error:"})," ",u]})]})]})},z=[{label:"Mirror",value:"mirror"},{label:"Pull",value:"pull"},{label:"Upload",value:"upload"}],H=[{label:"Select filter type",value:""},{label:"Allow list",value:"whitelist"},{label:"Disallow list",value:"blacklist"}],Z={type:"ubuntu",series:"",distribution:"",name:"",architectures:[],components:[],gpg_key:"",include_udeb:!1,filter_type:"",mode:"mirror",pull_pocket:"",pull_series:"",mirror_uri:"",upload_allow_unsigned:!1,mirror_suite:"",mirror_gpg_key:"",filter_packages:[],upload_gpg_keys:[]},J=o=>{switch(o.mode){case"mirror":return{mode:o.mode,distribution:o.distribution,series:o.series,name:o.name,architectures:o.architectures,components:o.components,gpg_key:o.gpg_key,include_udeb:o.include_udeb,mirror_uri:o.mirror_uri,mirror_suite:o.mirror_suite,mirror_gpg_key:o.mirror_gpg_key};case"upload":return{mode:o.mode,distribution:o.distribution,series:o.series,name:o.name,architectures:o.architectures,components:o.components,gpg_key:o.gpg_key,include_udeb:o.include_udeb,upload_allow_unsigned:o.upload_allow_unsigned};case"pull":return{mode:o.mode,distribution:o.distribution,series:o.series,name:o.name,architectures:o.architectures,components:o.components,gpg_key:o.gpg_key,include_udeb:o.include_udeb,pull_series:o.pull_series,pull_pocket:o.pull_pocket,filter_type:o.filter_type!==""?o.filter_type:void 0,filter_packages:o.filter_packages};default:return $(o.mode,"pocket mode")}},fe=({distribution:o,series:p})=>{const _=I(),{closeSidePanel:y}=N(),{createPocketQuery:u,addUploaderGPGKeysToPocketQuery:n}=K(),{getGPGKeysQuery:g}=B(),{mutateAsync:h}=u,{mutateAsync:f}=n,{data:d}=g(),k=((d==null?void 0:d.data)??[]).filter(({has_secret:r})=>r).map(r=>({label:r.name,value:r.name})),c=((d==null?void 0:d.data)??[]).filter(({has_secret:r})=>!r).map(r=>({label:r.name,value:r.name})),x=G().shape({type:s().required("This field is required."),name:s().required("This field is required").test({test:C.test,message:C.message}).test({params:{series:p},test:r=>!p.pockets.map(({name:i})=>i).includes(r),message:"It must be unique within series."}),distribution:s().required("This field is required"),series:s().required("This field is required"),components:b().defined().of(s().defined()).min(1,"Please choose at least one component").test({name:"flat-mirror-sub-directory",message:"A single component must be passed",test:(r,i)=>{const{mode:a,mirror_suite:P}=i.parent;return a==="mirror"&&/\/$/.test(P)?r.length===1:!0}}).required("This field is required"),architectures:b().defined().of(s().defined()).min(1,"Please choose at least one architecture"),mode:s().required("This field is required"),gpg_key:s().required("This field is required"),include_udeb:v().required("This field is required"),mirror_uri:s().when("mode",{is:"mirror",then:r=>r.required("This field is required")}),mirror_suite:s(),mirror_gpg_key:s(),pull_pocket:s().when("mode",{is:"pull",then:r=>r.required("This field is required")}),pull_series:s(),filter_type:s(),filter_packages:b().of(s().defined()),upload_allow_unsigned:v(),upload_gpg_keys:b().of(s().defined())}),e=A({validationSchema:x,initialValues:Z,onSubmit:async r=>{try{await h(J(r)),r.mode==="upload"&&!r.upload_allow_unsigned&&r.upload_gpg_keys.length&&await f({name:r.name,series:r.series,distribution:r.distribution,gpg_keys:r.upload_gpg_keys}),y()}catch(i){_(i)}}});w.useEffect(()=>{e.setFieldValue("distribution",o.name),e.setFieldValue("series",p.name)},[]),w.useEffect(()=>{e.values.type==="ubuntu"?(e.setFieldValue("components",q.ubuntu),e.setFieldValue("architectures",T.ubuntu),e.values.mode==="mirror"&&e.setFieldValue("mirror_uri",V)):(e.setFieldValue("components",q.thirdParty),e.setFieldValue("architectures",T.thirdParty),e.values.mode==="mirror"&&e.setFieldValue("mirror_uri",""))},[e.values.type,e.values.mode]);const F=o.series.map(r=>({options:r.pockets.map(({name:i})=>({label:i,value:i})),optGroup:r.name}));return t.jsxs(l.Form,{onSubmit:e.handleSubmit,noValidate:!0,children:[t.jsx(l.Select,{label:"Type",required:!0,options:[{label:"Ubuntu",value:"ubuntu"},{label:"Third party",value:"third-party"}],...e.getFieldProps("type"),error:e.touched.type&&e.errors.type?e.errors.type:void 0}),t.jsx(l.Select,{label:"Mode",required:!0,options:[...z],...e.getFieldProps("mode"),error:e.touched.mode&&e.errors.mode?e.errors.mode:void 0}),e.values.mode==="mirror"&&t.jsx(l.Input,{type:"text",label:"Mirror URI",required:!0,...e.getFieldProps("mirror_uri"),error:e.touched.mirror_uri&&e.errors.mirror_uri?e.errors.mirror_uri:void 0}),t.jsxs("div",{className:m({row:e.values.mode==="pull","u-no-padding--left":e.values.mode==="pull","u-no-padding--right":e.values.mode==="pull"}),children:[t.jsx(l.Input,{type:"text",label:"Name",required:!0,wrapperClassName:m({"col-6":e.values.mode==="pull"}),style:{display:"block !important"},...e.getFieldProps("name"),error:e.touched.name&&e.errors.name?e.errors.name:void 0}),e.values.mode=="pull"&&t.jsx(Q,{label:"Pull from",required:!0,name:"pull_pocket",wrapperClassName:"col-6",groupedOptions:F,option:e.values.pull_pocket,group:e.values.pull_series,emptyOption:{enabled:!0,label:"Select pull pocket"},onChange:async(r,i)=>{await e.setFieldValue("pull_pocket",r),await e.setFieldValue("pull_series",i)},onBlur:e.handleBlur,error:e.touched.pull_pocket&&e.errors.pull_pocket?e.errors.pull_pocket:void 0})]}),t.jsx(l.Select,{label:"GPG Key",required:!0,options:[{label:"Select GPG key",value:""},...k],...e.getFieldProps("gpg_key"),error:e.touched.gpg_key&&e.errors.gpg_key?e.errors.gpg_key:void 0}),e.values.mode==="mirror"&&t.jsxs(t.Fragment,{children:[t.jsx(l.Input,{type:"text",label:t.jsx(M,{label:"Mirror suite",description:t.jsxs(t.Fragment,{children:[t.jsx("span",{children:"The specific sub-directory under dists/ that should be mirrored. If the suite name ends with a ‘/’, the remote repository is flat (no dists/ structure, see "}),t.jsx("a",{href:"http://wiki.debian.org/RepositoryFormat#Flat_Repository_Format",target:"_blank",rel:"nofollow noopener noreferrer",children:"wiki.debian.org/RepositoryFormat#Flat_Repository_Format"}),t.jsx("span",{children:"); in this case a single value must be passed for the ‘components’ parameter. Packages from the remote repository will be mirrored in the specified component. This parameter is optional and defaults to the same name as local series and pocket."})]})}),...e.getFieldProps("mirror_suite"),error:e.touched.mirror_suite&&e.errors.mirror_suite?e.errors.mirror_suite:void 0}),t.jsx(l.Select,{label:"Mirror GPG key",options:[{label:"Select GPG key",value:""},...c],...e.getFieldProps("mirror_gpg_key"),error:e.touched.mirror_gpg_key&&e.errors.mirror_gpg_key?e.errors.mirror_gpg_key:void 0,help:"If none is given, the stock Ubuntu archive one will be used."})]}),e.values.mode==="pull"&&t.jsxs(t.Fragment,{children:[t.jsx(l.Select,{label:"Filter type",options:H,...e.getFieldProps("filter_type"),error:e.touched.filter_type&&e.errors.filter_type?e.errors.filter_type:void 0}),e.values.filter_type!==""&&t.jsx(l.Textarea,{label:"Filter packages",rows:3,help:"List packages to filter separated by commas",...e.getFieldProps("filter_packages"),onChange:r=>{e.setFieldValue("filter_packages",r.target.value.replace(/\s/g,"").split(","))},value:e.values.filter_packages.join(","),error:e.touched.filter_packages&&e.errors.filter_packages?e.errors.filter_packages:void 0})]}),e.values.mode==="upload"&&t.jsxs(t.Fragment,{children:[t.jsx(l.CheckboxInput,{label:"Allow uploaded packages to be unsigned",...e.getFieldProps("upload_allow_unsigned"),checked:e.values.upload_allow_unsigned}),t.jsx(D,{variant:"condensed",label:"Uploader GPG keys",disabled:e.values.upload_allow_unsigned,items:c,selectedItems:c.filter(({value:r})=>e.values.upload_gpg_keys.includes(r)),onItemsUpdate:r=>{e.setFieldValue("upload_gpg_keys",r.map(({value:i})=>i))},error:e.touched.upload_gpg_keys&&(Array.isArray(e.errors.upload_gpg_keys)?e.errors.upload_gpg_keys[0]:e.errors.upload_gpg_keys)||void 0})]}),e.values.type==="ubuntu"&&t.jsxs(t.Fragment,{children:[t.jsx(S,{label:"Components",required:!0,options:O,...e.getFieldProps("components"),onChange:r=>{e.setFieldValue("components",r)},error:e.touched.components&&e.errors.components?e.errors.components:void 0}),t.jsx(S,{label:"Architectures",required:!0,options:R,...e.getFieldProps("architectures"),onChange:r=>{e.setFieldValue("architectures",r)},error:e.touched.architectures&&e.errors.architectures?e.errors.architectures:void 0})]}),e.values.type==="third-party"&&t.jsxs(t.Fragment,{children:[t.jsx(l.Input,{type:"text",label:"Components",required:!0,...e.getFieldProps("components"),value:e.values.components.join(","),onChange:r=>{e.setFieldValue("components",r.target.value.replace(/\s/g,"").split(","))},error:e.touched.components&&e.errors.components?e.errors.components:void 0}),t.jsx(l.Input,{type:"text",label:"Architectures",required:!0,...e.getFieldProps("architectures"),value:e.values.architectures.join(","),onChange:r=>{e.setFieldValue("architectures",r.target.value.replace(/\s/g,"").split(","))},error:e.touched.architectures&&e.errors.architectures?e.errors.architectures:void 0})]}),t.jsx(U,{formik:e}),t.jsx(L,{submitButtonDisabled:e.isSubmitting,submitButtonText:"Add pocket",submitButtonAriaLabel:"Add pocket"})]})};export{fe as default};
