import{h as A,t as V,k as p,l as $,G as g,j as i,g as c,f as q,p as B,s as N,r as y}from"./index-BRihK9aF.js";import{C as O}from"./CodeEditor-BtIntlon.js";import{c as j,u as k}from"./index-CnVPiIn9.js";import{u as Q}from"./useRoles-BaBAheRf.js";import{S as L}from"./SidePanelFormButtons-BFlViY8c.js";import{g as D}from"./formikErrors-BUNw6La4.js";import"./useFetchOld-CpP6IFJx.js";import"./usePageParams-iyOWMaH2.js";import"./SidePanelFormButtons.module-C5v714vX.js";const M={add:"Add script",copy:"Copy script",edit:"Save changes"},G={title:"",code:"",access_group:"",time_limit:300,username:"",attachments:{first:null,second:null,third:null,fourth:null,fifth:null},attachmentsToRemove:[]},J=e=>A().shape({title:p().required("This field is required"),time_limit:$().required("This field is required"),code:p().test({name:"required",message:"This field is required",test:a=>e==="copy"||e==="edit"||!!a}),username:p(),access_group:p(),attachments:A().shape({first:g().nullable(),second:g().nullable(),third:g().nullable(),fourth:g().nullable(),fifth:g().nullable()}),attachmentsToRemove:V().of(p())}),T=e=>{const a=JSON.parse(JSON.stringify(e).replace(/\\r/g,""));return j.Buffer.from(a).toString("base64")},H=e=>({access_group:e.access_group,code:T(e.code),time_limit:e.time_limit,title:e.title,username:e.username}),U=({props:e,values:a})=>({access_group:a.access_group,destination_title:a.title,script_id:e.script.id}),Y=({props:e,values:a})=>({code:T(a.code),script_id:e.script.id,time_limit:a.time_limit,title:a.title,username:a.username}),F=async({attachments:e,createScriptAttachment:a,script_id:h})=>{const u=[],d=[];for(const n of e)u.push(n.arrayBuffer()),d.push(n.name);return(await Promise.all(u)).map((n,f)=>a({file:`${d[f]}$$${j.Buffer.from(n).toString("base64")}`,script_id:h}))},z=({attachments:e,attachmentsToRemove:a,getFileInputError:h,initialAttachments:u,onFileInputChange:d,onInitialAttachmentDelete:b})=>i.jsx(i.Fragment,{children:Object.keys(e).map((n,f)=>{const l=n,m=u[f];return!m||a.includes(m)?i.jsx(c.Input,{type:"file",label:`${l} attachment`,labelClassName:"u-off-screen",onChange:d(l),error:h(l)},l):i.jsxs("div",{style:{marginBottom:"1rem"},children:[i.jsx("span",{children:m}),i.jsx(c.Button,{type:"button",hasIcon:!0,appearance:"base",className:"u-no-margin--bottom","aria-label":`Remove ${m} attachment`,onClick:()=>{b(m)},children:i.jsx(c.Tooltip,{message:"Remove",position:"top-center",children:i.jsx(c.Icon,{name:c.ICONS.delete})})})]},l)})}),re=e=>{const{closeSidePanel:a}=q(),h=B(),{getAccessGroupQuery:u}=Q(),{createScriptQuery:d,editScriptQuery:b,copyScriptQuery:n,getScriptCodeQuery:f,createScriptAttachmentQuery:l,removeScriptAttachmentQuery:m}=k(),{mutateAsync:C}=d,{mutateAsync:P}=b,{mutateAsync:R}=n,{mutateAsync:x}=l,{mutateAsync:E}=m,w=async s=>{const o=Object.values(s.attachments).filter(r=>r!==null);try{if(e.action==="add"){const r=await C(H(s));o.length>0&&await Promise.all(await F({attachments:o,createScriptAttachment:x,script_id:r.data.id}))}else if(e.action==="edit"){const r=[P(Y({props:e,values:s}))];if(s.attachmentsToRemove.length>0){for(const v of s.attachmentsToRemove)r.push(E({script_id:e.script.id,filename:v}));await Promise.all(r.splice(0))}o.length>0&&r.push(...await F({attachments:o,createScriptAttachment:x,script_id:e.script.id})),await Promise.all(r)}else e.action==="copy"&&await R(U({props:e,values:s}));a()}catch(r){h(r)}},t=N({initialValues:G,validationSchema:J(e.action),onSubmit:w});y.useEffect(()=>{e.action!=="add"&&(e.action==="copy"?t.setFieldValue("access_group",e.script.access_group):e.action==="edit"&&(t.setFieldValue("title",e.script.title),t.setFieldValue("time_limit",e.script.time_limit),t.setFieldValue("username",e.script.username),t.setFieldValue("access_group",e.script.access_group)))},[e.action]);const{data:_}=f({script_id:e.action==="edit"?e.script.id:0},{enabled:e.action==="edit"});y.useEffect(()=>{_&&t.setFieldValue("code",_.data)},[_]);const{data:S}=u(),I=y.useMemo(()=>((S==null?void 0:S.data)??[]).map(({name:s,title:o})=>({label:o,value:s})),[S]);return i.jsxs(c.Form,{onSubmit:t.handleSubmit,noValidate:!0,children:[i.jsx(c.Input,{type:"text",label:"Title",required:!0,...t.getFieldProps("title"),error:t.touched.title&&t.errors.title?t.errors.title:void 0}),(e.action==="add"||e.action==="edit")&&i.jsxs(i.Fragment,{children:[i.jsx(c.Input,{type:"number",label:"Time limit (seconds)",required:!0,...t.getFieldProps("time_limit"),error:t.touched.time_limit&&t.errors.time_limit?t.errors.time_limit:void 0}),i.jsx(O,{label:"Code",required:!0,onChange:s=>{t.setFieldValue("code",s??"")},value:t.values.code,error:t.touched.code&&t.errors.code?t.errors.code:void 0}),i.jsx(c.Input,{type:"text",label:"Run as user",...t.getFieldProps("username"),error:t.touched.username&&t.errors.username?t.errors.username:void 0})]}),i.jsx(c.Select,{label:"Access group",options:[{label:"Select access group",value:""},...I],...t.getFieldProps("access_group"),error:t.touched.access_group&&t.errors.access_group?t.errors.access_group:void 0}),(e.action==="add"||e.action==="edit")&&i.jsxs(i.Fragment,{children:[i.jsx("h5",{children:"List of attachments"}),i.jsx("p",{className:"u-text--muted",children:"Attachments that will be sent along with the script. You can attach up to 5 files, for a maximum of 1.00MB. Filenames must be unique. On the client, the attachments will be placed in the directory whose name is accessible through the environment variable LANDSCAPE_ATTACHMENTS. They'll be deleted once the script has been run."})]}),(e.action==="add"||e.action==="edit")&&i.jsx(z,{attachments:t.values.attachments,attachmentsToRemove:t.values.attachmentsToRemove,getFileInputError:s=>D(t,["attachments",s]),initialAttachments:e.action==="edit"?e.script.attachments:[],onFileInputChange:s=>o=>{var r;t.setFieldValue(`attachments.${s}`,((r=o.target.files)==null?void 0:r[0])??null)},onInitialAttachmentDelete:s=>{t.setFieldValue("attachmentsToRemove",[...t.values.attachmentsToRemove,s])}}),i.jsx(L,{submitButtonDisabled:t.isSubmitting,submitButtonText:M[e.action]})]})};export{re as default};
