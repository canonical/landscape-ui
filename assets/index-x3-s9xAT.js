import{i as P,d as R,h as T,k as f,l as W,q,s as D,n as A,t as L,y as $,N as H,B as z,j as e,e as o,a3 as B,c as k,aB as V,K as U,a1 as _,a as Y}from"./index-DN_YS9_3.js";import{P as G,a as J,b as O}from"./PageMain-DBf2pLlC.js";import{d as X,s as j}from"./constants-DxK6q0h1.js";import{M as Z}from"./MultiSelectField-BBnvEm8T.js";import{u as ee}from"./useGetTags-DarKgUFs.js";import"./constants-DtLZBNBu.js";const F=t=>t?"Yes":"No";function S(){const t=P(),a=R(),n=T(),c=()=>W({queryKey:["alert"],queryFn:async()=>a.get("alerts")}),u=f({mutationKey:["alert","subscribe"],mutationFn:async i=>n.get("SubscribeToAlert",{params:i}),onSuccess:async()=>t.invalidateQueries({queryKey:["alert"]})}),m=f({mutationKey:["alert","unsubscribe"],mutationFn:async i=>n.get("UnsubscribeFromAlert",{params:i}),onSuccess:async()=>t.invalidateQueries({queryKey:["alert"]})}),d=f({mutationKey:["alert","associate"],mutationFn:async i=>n.get("AssociateAlert",{params:i}),onSuccess:async()=>t.invalidateQueries({queryKey:["alert"]})}),r=f({mutationKey:["alert","disassociate"],mutationFn:async i=>n.get("DisassociateAlert",{params:i}),onSuccess:async()=>t.invalidateQueries({queryKey:["alert"]})});return{getAlertsQuery:c,subscribeQuery:u,unsubscribeQuery:m,associateAlert:d,disassociateAlert:r}}const se="_footer_1qn3u_1",te="_multiSelect_1qn3u_7",Q={footer:se,multiSelect:te},E=(t,a)=>{const n=new Set(a);return t.filter(c=>!n.has(c))},M=({alert:t,availableTagOptions:a})=>{const n=q(),{notify:c}=D(),{associateAlert:u,disassociateAlert:m}=S(),d=A.useRef(null),{mutateAsync:r}=u,{mutateAsync:i}=m,g=t.all_computers?["All"]:t.tags,C=async({tags:l})=>{try{const p=E(t.tags,l),h=E(l,t.tags),w=l.includes("All"),K=t.all_computers&&!w;if(w)await r({name:t.alert_type,tags:void 0,all_computers:!0});else if(K)await Promise.all([r({name:t.alert_type,tags:l.filter(x=>x!=="All"),all_computers:!1}),i({name:t.alert_type,all_computers:!0})]);else{const x=[];h.length>0&&x.push(r({name:t.alert_type,tags:h,all_computers:!1})),p.length>0&&x.push(i({name:t.alert_type,tags:p,all_computers:!1})),await Promise.all(x)}c.success({title:"Alert tags updated",message:`You changed ${t.label}'s tags`})}catch(p){n(p)}},s=L({initialValues:{tags:g},validationSchema:$().shape({tags:H().of(z())}),onSubmit:C}),y=s.values.tags.includes("All")?a.filter(({value:l})=>l!=="All"):void 0,v=s.values.tags.includes("All")?a:a.filter(({value:l})=>s.values.tags.includes(l)),I=l=>{const p=l.some(({value:h})=>h==="All")?["All"]:l.map(({value:h})=>h);s.setValues({tags:p})};A.useEffect(()=>{const l=d.current?.querySelector(".multi-select__condensed-text");l&&l.textContent.includes("All instances")&&(l.textContent="All instances")},[s.values.tags]);const N=()=>s.isSubmitting?!0:g.length===s.values.tags.length&&g.every(l=>s.values.tags.includes(l));return e.jsx(o.Form,{onSubmit:s.handleSubmit,noValidate:!0,children:e.jsx(Z,{innerRef:d,required:!0,variant:"condensed",className:Q.multiSelect,items:a,selectedItems:v,disabledItems:y,onItemsUpdate:I,placeholder:"Select tags",error:s.touched.tags&&typeof s.errors.tags=="string"?s.errors.tags:void 0,dropdownFooter:e.jsxs("div",{className:Q.footer,children:[e.jsx(o.Button,{type:"button",dense:!0,small:!0,className:"u-no-margin--bottom",disabled:N(),onClick:()=>s.setFieldValue("tags",g),children:"Revert"}),e.jsx(o.Button,{type:"button",dense:!0,small:!0,appearance:"positive",className:"u-no-margin--bottom",disabled:N(),onClick:()=>s.submitForm(),children:"Save changes"})]})})})},ae="_noWrap_1ld5g_19",le="_alertsWrapper_1ld5g_23",ne="_emailColumn_1ld5g_31",ce="_nameColumn_1ld5g_35",re="_tags_1ld5g_39",b={switch:"_switch_1ld5g_1",noWrap:ae,alertsWrapper:le,emailColumn:ne,nameColumn:ce,tags:re},ie=t=>{const a={};switch(t.column.id){case"label":a.role="rowheader";break;case"subscribed":a["aria-label"]="Email";break;case"tags":a["aria-label"]="Tags";break;case"description":a["aria-label"]="Description";break}return a},oe=({alerts:t,availableTagOptions:a})=>{const n=B("(min-width: 620px)"),c=q(),{unsubscribeQuery:u,subscribeQuery:m}=S(),{user:d}=k(),{mutateAsync:r}=m,{mutateAsync:i}=u,g=async s=>{const y=s.subscribed?i:r;try{await y({alert_type:s.alert_type})}catch(v){c(v)}},C=A.useMemo(()=>[{accessor:"label",className:b.nameColumn,Header:"Name"},{Header:e.jsxs("div",{className:b.noWrap,children:[e.jsx("span",{children:"Email "}),d&&e.jsx(o.Tooltip,{position:"btm-left",message:`Enabling email notifications will send alerts to ${d.email}, associated with your account`,children:e.jsx(o.Icon,{name:"help"})})]}),accessor:"subscribed",className:b.emailColumn,Cell:({row:s})=>e.jsx("div",{className:b.switch,children:e.jsx(o.Switch,{label:F(s.original.subscribed),defaultChecked:s.original.subscribed,onChange:()=>g(s.original)})})},{accessor:"tags",Header:"Enabled for",className:b.tags,Cell:({row:{original:s}})=>e.jsx(M,{alert:s,availableTagOptions:a})},{Header:"Description",accessor:"description",Cell:({row:{original:s}})=>e.jsx(e.Fragment,{children:s.description})}],[t]);return n?e.jsx(V,{columns:C,data:t,getCellProps:ie,emptyMsg:"No data available"}):t.map((s,y)=>e.jsxs(o.Row,{className:U("u-no-padding--left u-no-padding--right",b.alertsWrapper),children:[e.jsx(o.Col,{size:2,small:2,children:e.jsx(_,{label:"Name",value:s.label})}),e.jsx(o.Col,{size:2,small:2,children:e.jsx(_,{label:"Email",value:e.jsx("div",{className:b.switch,children:e.jsx(o.Switch,{label:F(s.subscribed),defaultChecked:s.subscribed,onChange:()=>g(s)})})})}),e.jsx(o.Col,{size:2,small:2,children:e.jsx(_,{label:"Enabled for",value:e.jsx(M,{alert:s,availableTagOptions:a})})}),e.jsx(o.Col,{size:2,small:2,children:e.jsx(_,{label:"Description",value:s.description})})]},y))},ue=({alerts:t,availableTagOptions:a})=>{const{user:n}=k(),c=n?.accounts.find(u=>u.name===n.current_account);return e.jsx("div",{className:X.item,children:e.jsxs("div",{className:j.card,children:[e.jsx("div",{className:j.header,children:e.jsx("p",{className:j.title,children:c?.title||"Alerts"})}),e.jsx("div",{className:j.content,children:e.jsx(oe,{alerts:t,availableTagOptions:a})})]})})},ye=()=>{const{getAlertsQuery:t}=S(),{tags:a}=ee(),{data:n,isLoading:c}=t(),u=A.useMemo(()=>n?.data.filter(r=>!r.alert_type.toUpperCase().includes("LICENSE"))??[],[n]),m=a.map(r=>({label:r,value:r,group:"Tags"}))??[],d=[{label:"All instances",value:"All"},...m];return e.jsxs(G,{children:[e.jsx(J,{title:"Alerts"}),e.jsxs(O,{children:[c&&e.jsx(Y,{}),!c&&u&&e.jsx(ue,{alerts:u,availableTagOptions:d})]})]})};export{ye as default};
