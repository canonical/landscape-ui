import{f as Q,v as K,w as Z,p as U,i as T,j as e,I as f,aF as W,r as i,d as g,aG as J,q as X,e as R,y as Y,z as ee,B as te,g as se,C as ne}from"./index-DYykpNVa.js";import{S as re}from"./SidePanelFormButtons-Aj5ThB2m.js";import"./InstancesPageActions-nbDXpXLr.js";import"./index-Cbj0Sz5k.js";import{g as A}from"./formikErrors-Bw8iTXYS.js";import{u as ae,T as oe}from"./TagsAddConfirmationModal-BaByvYt8.js";import{u as ie}from"./useRoles-CK1OAvut.js";import{u as ce}from"./useGetTags-BbkSXw8M.js";import"./SidePanelFormButtons.module-CcPyiogC.js";import"./index-C2TKYmcI.js";import"./NoData-CT6SeJUX.js";import"./ResponsiveTable-C-8YbfBJ.js";import"./TablePagination-CIA4CRba.js";import"./TableFilterChips-DLH4XQ-H.js";import"./useFetchOld-BGD2hIpr.js";import"./PageParamFilter-LH49uHXA.js";import"./TableFilter-C7yTBfOe.js";import"./ListTitle-anvzyHx6.js";import"./StaticLink-BX9qJBBO.js";import"./TruncatedCell-DQQZxgbr.js";import"./Truncated-DtD6hAHP.js";import"./useExpandableRow-CGDZ27WS.js";import"./TextConfirmationModal-DuGXYB1S.js";import"./InfoGrid-CVtcW3Y8.js";import"./InfoItem-DMBAN7ig.js";import"./ModalTablePagination-C4fLxOQV.js";const le=()=>{const t=Q(),n=K(),{isPending:c,mutateAsync:p}=Z({mutationFn:async({instanceId:h,...a})=>t.put(`computers/${h}`,a),onSuccess:async()=>Promise.all([n.invalidateQueries({queryKey:["instances"]}),n.invalidateQueries({queryKey:["instanceTags"]})])});return{editInstance:p,isEditingInstance:c}},ue=U().shape({access_group:T(),comment:T(),title:T()}),me="_infoContainer_1ca11_1",de="_amount_1ca11_9",G={infoContainer:me,amount:de},pe=({isExpanded:t,overflowingChipsAmount:n})=>n>0&&!t&&e.jsx("div",{className:G.infoContainer,children:e.jsx("span",{className:f("u-text--muted",G.amount),children:`+${n}`})}),he=({containerRef:t,onDismiss:n,onOverflowingItemsAmountChange:c,tagData:p})=>{const h=()=>{if(!t.current)return;const a=t.current.querySelectorAll("span.p-chip");c(Array.from(a).filter(({offsetHeight:x,offsetTop:m})=>m>x).length)};return W("resize",h),i.useEffect(()=>{h()},[p.length]),p.map(a=>e.jsx(g.Chip,{value:a,onDismiss:()=>{n(a)}},a))},ge="_container_14trj_1",fe="_list_14trj_6",xe="_listItem_14trj_11",_e="_search_14trj_17",b={container:ge,list:fe,listItem:xe,search:_e},je=({onTagClick:t,tags:n})=>n.length?e.jsxs("div",{className:b.container,children:[e.jsx("p",{className:"p-text--small-caps u-text--muted p-text--small",children:"Tags"}),e.jsx("ul",{className:f("p-list--divided u-no-margin--bottom",b.list),children:n.map(c=>e.jsx("li",{children:e.jsx("div",{className:b.listItem,children:e.jsx(g.Button,{type:"button",appearance:"base",className:b.search,onClick:()=>{t(c)},children:c})})},c))})]}):null,Ce="_container_fqj7b_1",ye="_prompt_fqj7b_10",ve="_saveButton_fqj7b_17",F={container:Ce,prompt:ye,saveButton:ve},Se=({onTagAdd:t,search:n})=>e.jsx(e.Fragment,{children:n&&e.jsxs("div",{className:F.container,children:[e.jsxs("span",{className:F.prompt,children:[e.jsx("span",{children:"Search for "}),e.jsx("span",{className:"p-search-and-filter__search-query",children:n}),e.jsx("span",{children:"..."})]}),e.jsx(g.Button,{type:"button",appearance:"link",onClick:t,className:F.saveButton,children:"Add tag"})]})}),O=T().matches(/^[a-zA-Z]/,{message:"Tag must starts with a letter",excludeEmptyString:!0}).matches(/^[a-zA-Z][a-zA-Z0-9_-]*$/,{message:"Tag can only contain letters, numbers, hyphens, and underscores",excludeEmptyString:!0}),be="_root_31ymm_1",Te="_searchContainer_31ymm_5",Ie="_box_31ymm_13",Ee="_inputContainer_31ymm_18",Ne="_inputError_31ymm_23",we="_input_31ymm_18",y={root:be,searchContainer:Te,box:Ie,inputContainer:Ee,inputError:Ne,input:we},Ae=({onTagsChange:t,tags:n,label:c,labelClassName:p,required:h})=>{const[a,x]=i.useState(""),[m,_]=i.useState(""),[I,S]=i.useState(!1),[r,j]=i.useState(""),[d,C]=i.useState(!1),[E,N]=i.useState(0),{height:o}=J(),[v,B]=i.useState({top:"100%",bottom:"auto"}),{tags:w,isGettingTags:P}=ce(),k=i.useRef(null),l=i.useRef(null);i.useEffect(()=>{if(!l.current)return;const s=l.current.querySelector("input");s&&j(s.id)},[l.current]);const L=()=>{if(!l.current)return;const{top:s,height:u}=l.current.getBoundingClientRect();s+u+379<o?B({top:"100%",bottom:"auto"}):B({top:"auto",bottom:"100%"})};i.useEffect(()=>{!d||!l.current||L()},[o,d,l.current,l.current?.clientHeight]);const q=()=>{C(!1)};X(k,q);const M=s=>{t(n.filter(u=>u!==s))},z=i.useMemo(()=>!a&&!n.length?w:w.filter(s=>!n.includes(s)).filter(s=>s.toLowerCase().includes(a.trim().toLowerCase())),[w,a,n]),$=s=>{t([...n,s])},D=()=>{if(a.trim())try{const s=O.validateSync(a.trim())??"";$(s),x(""),_(""),S(!1)}catch(s){s instanceof Error&&(_(s.message),S(!0))}},V=s=>{if(x(s.target.value),I)try{O.validateSync(s.target.value),_("")}catch(u){u instanceof Error&&_(u.message)}},H=s=>{const{key:u}=s;d?(u==="Escape"&&q(),u==="Enter"&&D()):u==="Enter"&&C(!0)};return e.jsxs("div",{className:y.root,children:[e.jsx("label",{className:f("p-form__label",{"is-required":h},p),htmlFor:r,children:c||"Tags"}),e.jsxs("div",{className:"p-search-and-filter",ref:k,children:[e.jsxs("div",{className:f("p-search-and-filter__search-container",y.searchContainer),"aria-expanded":d,ref:l,onClick:()=>{C(!0)},children:[e.jsx(he,{containerRef:l,onDismiss:M,onOverflowingItemsAmountChange:s=>{N(s)},tagData:n}),e.jsx("div",{className:f("p-search-and-filter__box",y.box),children:e.jsx("div",{className:y.inputContainer,children:e.jsx(g.Input,{type:"text",autoComplete:"off",value:a,onChange:V,placeholder:"Add tags",className:f("u-no-margin--bottom",y.input),onClick:()=>{C(!0)},onKeyUp:H,wrapperClassName:m?"is-error":"","aria-errormessage":m?`${r}-error`:void 0,"aria-invalid":!!m})})}),m&&e.jsx("div",{className:"is-error",children:e.jsxs("p",{className:f("p-form-validation__message",y.inputError),id:`${r}-error`,children:[e.jsx("strong",{children:"Error: "}),e.jsx("span",{children:m})]})}),e.jsx(pe,{isExpanded:d,overflowingChipsAmount:E})]}),d&&P&&e.jsx(R,{}),d&&!P&&e.jsxs("div",{className:"p-search-and-filter__panel",style:v,children:[e.jsx(Se,{onTagAdd:D,search:a}),e.jsx(je,{onTagClick:$,tags:z})]})]})]})},rt=({instance:t})=>{const{closeSidePanel:n}=Y(),c=ee(),{notify:p}=te(),{getAccessGroupQuery:h}=ie(),{data:a,isPending:x}=h(),{editInstance:m}=le(),{value:_,setTrue:I,setFalse:S}=se(),r=ne({initialValues:{title:t.title,comment:t.comment,access_group:t.access_group,tags:t.tags},onSubmit:async o=>{try{await m({instanceId:t.id,...o}),n(),p.success({title:"Instance updated",message:`Instance "${t.title}" updated successfully`})}catch(v){c(v)}},validationSchema:ue}),j=r.values.tags.filter(o=>!t.tags.includes(o)),{isFetchingProfileChanges:d,refetchProfileChanges:C}=ae({instance_ids:[t.id],tags:j,limit:10},{enabled:!1}),E=async()=>{if(j.length){const o=await C();o.isSuccess?o.data.data.count?I():r.handleSubmit():c(o.error)}else r.handleSubmit()};if(x)return e.jsx(R,{});const N=a?.data.map(({name:o,title:v})=>({label:v,value:o}))??[];return e.jsxs(e.Fragment,{children:[e.jsxs(g.Form,{onSubmit:o=>{o.preventDefault(),E()},className:"l-form",noValidate:!0,children:[e.jsx(g.Input,{label:"Title","aria-label":"Title",type:"text",required:!0,disabled:t.is_wsl_instance,...r.getFieldProps("title"),error:A(r,"title")}),e.jsx(g.Select,{label:"Access group",options:N,...r.getFieldProps("access_group"),error:A(r,"access_group")}),e.jsx(Ae,{onTagsChange:async o=>r.setFieldValue("tags",o),tags:r.values.tags}),e.jsx(g.Textarea,{label:"Comment",rows:3,...r.getFieldProps("comment"),error:A(r,"comment")}),e.jsx(re,{submitButtonLoading:r.isSubmitting||j&&d,submitButtonText:"Save changes"})]}),_&&e.jsx(oe,{instances:[t],tags:j,onConfirm:()=>{r.handleSubmit()},confirmButtonLoading:r.isSubmitting,close:S})]})};export{rt as default};
