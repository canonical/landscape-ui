import{r as f,j as s,g as y,e as n,c as F,l as j,d as S}from"./index-USfFY6y3.js";import{u as v}from"./formik.esm-C4aerYG-.js";import{b as T,u as h,I,V as N,d as C,P as V,e as A}from"./index-3xn2jA3L.js";import{P as E}from"./PackageProfileConstraintsBlock-C3UN5uVC.js";import{u as O}from"./useInstances-DuIRAs83.js";import{u as w}from"./useRoles-NASJ59Wm.js";import{A as B}from"./AssociationBlock-j-Uu_2zy.js";import{S as $}from"./SidePanelFormButtons-eq1cIORy.js";const q=({error:e,help:l,label:i,onBlur:c,onFileRemove:m,onFileUpload:u,value:r,...d})=>{const[g,t]=f.useState(null),a=async o=>{const p=o.target.files;!p||!p.length||(await u([...p]),g&&c&&c(g))};return r?s.jsxs("div",{className:y("p-form__group p-form-validation",{"is-error":e}),children:[i&&s.jsx("label",{className:"p-form-validation__label",children:i}),l&&s.jsx("p",{className:"p-form-help-text",children:l}),s.jsx("span",{children:r.name}),s.jsxs(n.Button,{type:"button",appearance:"base",hasIcon:!0,onClick:m,className:"u-no-padding--left","aria-errormessage":`${r.name}-error-message`,children:[s.jsx("span",{className:"u-off-screen",children:"Remove"}),s.jsx(n.Icon,{name:"delete"})]}),e&&s.jsxs("p",{className:"p-form-validation__message",id:`${r.name}-error-message`,children:[s.jsx("strong",{children:"Error: "}),s.jsx("span",{children:e})]})]}):s.jsx(n.Input,{...d,type:"file",error:e,help:l,label:i,multiple:!1,onBlur:o=>t(o),onChange:a})},D=[{label:"Select constraints type",value:""},{label:"From an instance's packages",value:"instance"},{label:"From a CSV file",value:"material"},{label:"Enter manually",value:"manual"}],L=({formik:e})=>{const{getInstancesQuery:l}=O(),{data:i}=l(),c=(i==null?void 0:i.data.results.map(({id:r,title:d})=>({label:d,value:`${r}`})))??[];c.unshift({label:"Select instance",value:""});const m=async r=>{await e.setFieldValue("csvFile",r[0]);const d=await r[0].text();await e.setFieldValue("material",d)},u=async()=>{await e.setFieldValue("csvFile",null),await e.setFieldValue("material",""),await e.setFieldValue("isCsvFileParsed",!1)};return s.jsxs("div",{className:T.container,children:[s.jsx(n.Select,{label:"Package constraints",required:!0,options:D,...e.getFieldProps("constraintsType"),error:e.touched.constraintsType&&e.errors.constraintsType?e.errors.constraintsType:void 0}),e.values.constraintsType==="instance"&&s.jsx(n.Select,{label:"Instance",required:e.values.constraintsType==="instance",options:c,...e.getFieldProps("source_computer_id"),error:e.touched.source_computer_id&&e.errors.source_computer_id?e.errors.source_computer_id:void 0}),e.values.constraintsType==="material"&&s.jsx(q,{label:"Upload constraints",accept:".csv",...e.getFieldProps("csvFile"),onFileRemove:u,onFileUpload:m,help:'File should be formatted as either a package profile CSV file or the output of running "dpkg --get-selections" on a computer with desired packages installed.',error:e.touched.csvFile&&e.errors.csvFile||e.touched.material&&e.errors.material||void 0}),e.values.constraintsType==="manual"&&s.jsx(E,{formik:e})]})},_=()=>{const e=F(),{notify:l}=j(),{closeSidePanel:i}=S(),{getAccessGroupQuery:c}=w(),{createPackageProfileQuery:m}=h(),{data:u}=c(),r=(u==null?void 0:u.data.map(({name:a,title:o})=>({label:o,value:a})))??[];r.unshift({label:"Select access group",value:""});const{mutateAsync:d}=m,t=v({initialValues:I,onSubmit:async a=>{const o={access_group:a.access_group,description:a.description,title:a.title};a.all_computers?o.all_computers=!0:a.tags.length>0&&(o.tags=a.tags),a.constraintsType==="material"?o.material=a.material:a.constraintsType==="instance"?o.source_computer_id=a.source_computer_id:o.constraints=a.constraints.map(({constraint:p,package:x,rule:P,version:b})=>({constraint:p,package:x,rule:P,version:b}));try{await d(o),i(),l.success({message:`Profile "${a.title}" added successfully`,title:"Profile added"})}catch(p){e(p)}},validationSchema:N});return s.jsx(n.Form,{onSubmit:t.handleSubmit,noValidate:!0,children:s.jsxs("div",{className:C.container,children:[s.jsx(n.Input,{type:"text",label:"Name",required:!0,...t.getFieldProps("title"),error:t.touched.title&&t.errors.title?t.errors.title:void 0}),s.jsx(n.Input,{type:"text",label:"Description",required:!0,autoComplete:"off",...t.getFieldProps("description"),error:t.touched.description&&t.errors.description?t.errors.description:void 0}),s.jsx(n.Select,{label:"Access group",...t.getFieldProps("access_group"),options:r,error:t.touched.access_group&&t.errors.access_group?t.errors.access_group:void 0}),s.jsx(B,{formik:t}),s.jsx(L,{formik:t}),s.jsx($,{submitButtonDisabled:t.isSubmitting,submitButtonText:"Add package profile"})]})})},k=Object.freeze(Object.defineProperty({__proto__:null,default:_},Symbol.toStringTag,{value:"Module"})),J=Object.freeze(Object.defineProperty({__proto__:null,PackageProfileCreateForm:_,PackageProfileList:V,PackageProfilesEmptyState:A,usePackageProfiles:h},Symbol.toStringTag,{value:"Module"}));export{J as a,k as i};
