import{j as e,K as N,J as c,y as D,B as V,F as C,C as T,G as z,q as B,s as E,H as F,p as q,t as Q,e as o,a1 as R}from"./index-DN_YS9_3.js";import{S as L}from"./SidePanelFormButtons-CeIrPige.js";import{a as U,I as y}from"./useUsns-MNVK8XvW.js";import{D as G}from"./DeliveryBlock-fWTri6_7.js";import{R as K}from"./RandomizationBlock-CTaHgaHO.js";import"./SidePanelFormButtons.module-CcPyiogC.js";import"./constants-DtLZBNBu.js";import"./RadioGroup-BfuWEXDz.js";const O=({packageCount:s,securityUpgradePackageCount:a,totalUpgradePackageCount:r})=>{const t=r-a,i=s-r;return e.jsxs("div",{children:[e.jsx("span",{children:"You selected "}),e.jsx("span",{children:e.jsx("b",{children:s})}),e.jsx("span",{children:" packages. This will:"}),e.jsxs("ul",{className:N({"u-no-margin--bottom":i>0}),children:[a>0&&e.jsxs("li",{children:[e.jsx("span",{children:"apply "}),e.jsx("span",{children:e.jsx("b",{children:a})}),e.jsxs("span",{children:["security ",c(a,"upgrade")]})]}),t>0&&e.jsxs("li",{children:[e.jsx("span",{children:"apply "}),e.jsx("span",{children:e.jsx("b",{children:t})}),e.jsxs("span",{children:["regular ",c(t,"upgrade")]})]})]}),i>0&&e.jsxs("p",{children:[e.jsx("span",{children:"No upgrades for "}),e.jsx("span",{children:e.jsx("b",{children:i})}),e.jsxs("span",{children:[c(i,"package")," needed."]})]})]})},Y={deliver_after:"",deliver_delay_window:0,deliver_immediately:!0,randomize_delivery:!1,version:""},H=s=>D({...T,...C,version:V().test({name:"required",message:"This field is required",params:{action:s},test:a=>s!=="downgrade"||!!a})}),J=(s,a)=>{const r=c(s.length,`${s[0]?.name??""} Package`,"selected packages");return`This will ${a==="hold"?"disable":"enable"} upgrades for the ${r}. It will ${a==="hold"?"not ":""}be eligible to upgrade to the latest available version.`},Z=(s,a,r)=>{const t=c(a.length,`${a[0]?.name??""} Package`,"selected packages"),i={downgrade:"downgrade",hold:"held",remove:"uninstall",unhold:"unheld",upgrade:"upgrade"},h={downgrade:`be downgraded to ${r} version`,hold:"disable its upgrades",remove:"be uninstalled",unhold:"enable its upgrades",upgrade:"be upgraded"},x=`You queued ${t} to ${s!=="remove"?"be ":""}${i[s]}.`,b=`${t} ${a.length>1?"are":"is"} queued in Activities and will ${h[s]}.`;return{title:x,message:b}},te=({action:s,packages:a})=>{const{instanceId:r,childInstanceId:t}=z(),i=B(),{notify:h}=E(),{openActivityDetails:x}=F(),{closeSidePanel:b}=q(),{downgradePackageVersionQuery:w,getDowngradePackageVersionsQuery:f,upgradePackagesQuery:_,packagesActionQuery:P}=U(),u=Number(t??r),{data:S}=f({instanceId:u,packageName:a[0].name},{enabled:s==="downgrade"}),m=S?.data.results.map(({version:n})=>({label:n,value:n}))??[];m.unshift({label:"Select version",value:""});const j=a.filter(({status:n,available_version:g})=>n==="security"||n==="installed"&&g).map(({name:n})=>n),v=a.filter(({status:n})=>n==="security").length,{mutateAsync:A}=w,{mutateAsync:I}=_,{mutateAsync:k}=P,$=async n=>{const g={deliver_after:n.deliver_immediately?void 0:`${n.deliver_after}:00Z`,deliver_delay_window:n.randomize_delivery?n.deliver_delay_window:void 0};let p;s==="upgrade"?p=I({...g,packages:j,query:`id:${u}`}):s==="downgrade"?p=A({instanceId:u,package_name:a[0].name,package_version:n.version}):p=k({...g,action:s,computer_ids:[u],package_ids:a.map(({id:d})=>d)});try{const{data:d}=await p;b(),h.success({...Z(s,a,n.version),actions:[{label:"Details",onClick:()=>{x(d)}}]})}catch(d){i(d)}},l=Q({initialValues:Y,validationSchema:H(s),onSubmit:$});return e.jsxs(o.Form,{onSubmit:l.handleSubmit,noValidate:!0,children:[s==="downgrade"&&e.jsxs(o.Row,{className:"u-no-padding--left u-no-padding--right",children:[e.jsx(o.Col,{size:6,children:e.jsx(R,{label:"Current version",value:a[0].current_version})}),e.jsx(o.Col,{size:6,children:m.length>1?e.jsx(o.Select,{label:"New version",className:"",labelClassName:"p-text--small u-text--muted u-no-margin--bottom p-text--small-caps",...l.getFieldProps("version"),options:m}):e.jsx("p",{children:"No downgrade versions"})})]}),s==="upgrade"&&(a.length!==j.length||v>0)&&e.jsx(O,{packageCount:a.length,securityUpgradePackageCount:v,totalUpgradePackageCount:j.length}),(s==="hold"||s==="unhold")&&e.jsx("p",{children:J(a,s)}),["remove","upgrade","hold","unhold"].includes(s)&&e.jsxs(e.Fragment,{children:[e.jsx(G,{formik:l}),e.jsx(K,{formik:l})]}),(s!=="downgrade"||m.length>1)&&e.jsx(L,{submitButtonDisabled:l.isSubmitting,submitButtonText:y[s].label,submitButtonAppearance:y[s].appearance})]})};export{te as default};
