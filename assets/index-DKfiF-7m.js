import{j as s,x as m,r as l,L as x,R as h,c as b,l as j,d as f,e as L}from"./index-DoU7Rqsb.js";import{u as U,a as y}from"./useUsns-C6eYjhu8.js";import{S as $}from"./SidePanelFormButtons-Mpz29jd4.js";import{U as S,E as k}from"./UsnList-D21fcfmU.js";import"./useFetchOld-BmpLm9Xc.js";import"./useMutation-BBuufY01.js";import"./useQuery-BiLCfR8g.js";import"./SidePanelFormButtons.module-CoxOjuX8.js";import"./moment-CCQDuzMq.js";import"./TruncatedCell-CLe1On0p.js";import"./ExpandableTableFooter-D39Aba2o.js";import"./useConfirm-_4TVG935.js";import"./usePageParams-D-S-g6d_.js";import"./useOnClickOutside-DB2oaqn7.js";import"./PageMain-BPmAIdVO.js";const C=({instanceIds:e})=>{const{getUsnsQuery:n}=U(),{data:r,isLoading:i}=n({computer_ids:e,show_packages:!1},{enabled:e.length>0});return s.jsxs(s.Fragment,{children:[i&&s.jsx(m,{}),!i&&(!r||r.data.results.length===0)&&null,!i&&r&&r.data.results.length>0&&s.jsx(S,{tableType:"expandable",instanceIds:e,isUsnsLoading:i,usns:r.data.results})]})},q=({instances:e})=>{const[n,r]=l.useState(5),i=l.useMemo(()=>e.slice(0,n),[e,n]),d=l.useMemo(()=>[{accessor:"title",Header:"Instance",Cell:({row:t})=>s.jsx(x,{className:"u-no-margin--bottom u-no-padding--top",to:{pathname:`${h}instances/${t.original.parent?`${t.original.parent.id}/${t.original.id}`:t.original.id}`,search:"?tab=packages&filter=upgrade"},state:{selectAll:!0},children:t.original.title})},{accessor:"security_upgrades",Header:"Security upgrades",Cell:({row:t})=>{var a;return s.jsx(s.Fragment,{children:(a=t.original.upgrades)==null?void 0:a.security})}},{accessor:"upgrades",Header:"Regular upgrades",Cell:({row:t})=>{var a;return s.jsx(s.Fragment,{children:(a=t.original.upgrades)==null?void 0:a.regular})}}],[e.length]);return s.jsx(k,{columns:d,data:i,limit:n,onLimitChange:()=>r(t=>t+5),itemNames:{plural:"instances",singular:"instance"},title:"Affected instances",totalCount:e.length})},A=({selectedInstances:e})=>{const n=b(),{notify:r}=j(),{closeSidePanel:i}=f(),{getPackagesQuery:d,upgradePackagesQuery:t}=y(),{data:a}=d({query:`id:${e.map(({id:o})=>o).join(" OR id:")}`,upgrade:!0}),{mutateAsync:p,isLoading:g}=t,c=async o=>{o.preventDefault();try{await p({query:`id:${e.map(({id:u})=>u).join(" OR id:")}`,packages:((a==null?void 0:a.data.results)??[]).map(({name:u})=>u)}),i(),r.success({title:`You queued ${a==null?void 0:a.data.count} packages to be upgraded`,message:`${a==null?void 0:a.data.count} packages on ${e.length} instances will be upgraded and are queued in Activities`})}catch(u){n(u)}};return s.jsxs(L.Form,{onSubmit:c,children:[s.jsx(C,{instanceIds:e.map(({id:o})=>o)}),s.jsx(q,{instances:e}),s.jsx($,{submitButtonDisabled:g,submitButtonText:"Request all upgrades"})]})},G=A;export{G as default};
