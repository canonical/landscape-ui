import{j as r,e as l,g as p,c as S,l as F,d as D,r as A}from"./index-7rbqZGOC.js";import{u as T}from"./formik.esm-CYdaNCDR.js";import{A as E}from"./AssociationBlock-6LBfpdNV.js";import{S as C}from"./SidePanelFormButtons-CjpyfPYH.js";import{c as s,u as w,U as q,a as U,b as z}from"./index-CwSOXVB9.js";import{M as O}from"./MultiSelectField-DYLovPBJ.js";import{D as _}from"./constants-dW6629jA.js";import{u as M}from"./useRoles-Mlgq2EBh.js";import{c as V,a as d,d as g,f as m,b as y}from"./index.esm-Dndhfijq.js";const $=`If Landscape cannot upgrade the
associated instances by this point,
the upgrade will be cancelled.`,B=({formik:e})=>{const a=[e.touched.at_hour&&e.errors.at_hour||void 0,e.touched.at_minute&&e.errors.at_minute||void 0,e.touched.deliver_within&&e.errors.deliver_within||void 0];return r.jsxs("div",{className:s.container,children:[r.jsx("p",{className:"p-heading--5",children:"Schedule"}),r.jsx(O,{variant:"condensed",label:"Days",items:_,selectedItems:_.filter(({value:n})=>e.values.on_days.includes(n)),onItemsUpdate:n=>e.setFieldValue("on_days",n.map(({value:u})=>u)),error:e.touched.on_days&&typeof e.errors.on_days=="string"?e.errors.on_days:void 0}),r.jsxs("div",{className:s.radioGroup,children:[r.jsx(l.RadioInput,{label:"At a specific time",...e.getFieldProps("every"),checked:e.values.every==="week",onChange:()=>e.setFieldValue("every","week")}),r.jsx(l.RadioInput,{label:"Hourly",...e.getFieldProps("every"),checked:e.values.every==="hour",onChange:()=>e.setFieldValue("every","hour")})]}),r.jsxs("div",{className:s.timeContainer,children:[r.jsxs("div",{className:s.time,children:[e.values.every==="week"&&r.jsxs(r.Fragment,{children:[r.jsx(l.Input,{type:"number",label:"Time","aria-label":"at hour",placeholder:"HH",className:s.timeInput,wrapperClassName:p({"is-error":a[0]}),...e.getFieldProps("at_hour"),"aria-errormessage":a[0]?"hour-error":void 0}),r.jsx("span",{className:s.colon,children:":"})]}),e.values.every==="hour"&&r.jsx("span",{className:s.inputDescriptionBefore,children:"at"}),r.jsx(l.Input,{type:"number",label:"At minute",labelClassName:"u-off-screen","aria-label":"at minute",className:s.timeInput,wrapperClassName:p({"is-error":a[1]}),placeholder:"MM",...e.getFieldProps("at_minute"),"aria-errormessage":a[1]?"minute-error":void 0}),e.values.every==="hour"&&r.jsx("span",{className:s.inputDescriptionAfter,children:"minute"}),r.jsx(l.Input,{type:"number",label:r.jsxs(r.Fragment,{children:[r.jsx("span",{children:"Expires after "}),r.jsx(l.Tooltip,{message:$,position:"top-right",tooltipClassName:s.tooltip,children:r.jsx(l.Icon,{name:"help"})})]}),wrapperClassName:p(s.expiration,{"is-error":a[2]}),className:s.timeInput,...e.getFieldProps("deliver_within"),"aria-errormessage":"expires-error"}),r.jsx("span",{className:s.inputDescriptionAfter,children:"hours"})]}),a.filter(Boolean).length>0&&r.jsxs("div",{className:p({"is-error":a.filter(Boolean).length>0}),children:[a[0]&&r.jsxs("p",{className:"p-form-validation__message",id:"hour-error",children:[r.jsx("strong",{children:"Error: "}),r.jsx("span",{children:a[0]})]}),a[1]&&r.jsxs("p",{className:"p-form-validation__message",id:"minute-error",children:[r.jsx("strong",{children:"Error: "}),r.jsx("span",{children:a[1]})]}),a[2]&&r.jsxs("p",{className:"p-form-validation__message",id:"expires-error",children:[r.jsx("strong",{children:"Error: "}),r.jsx("span",{children:a[2]})]})]})]}),r.jsx("p",{children:"Randomise delivery over a time window"}),r.jsxs("div",{className:s.radioGroup,children:[r.jsx(l.RadioInput,{label:"No",...e.getFieldProps("randomizeDelivery"),checked:!e.values.randomizeDelivery,onChange:async()=>{await e.setFieldValue("randomizeDelivery",!1),await e.setFieldValue("deliver_delay_window","")}}),r.jsx(l.RadioInput,{label:"Yes",...e.getFieldProps("randomizeDelivery"),checked:e.values.randomizeDelivery,onChange:()=>e.setFieldValue("randomizeDelivery",!0)})]}),e.values.randomizeDelivery&&r.jsxs("div",{className:s.windowInputContainer,children:[r.jsx(l.Input,{type:"number",inputMode:"numeric",min:0,label:"Deliver delay window",labelClassName:"u-off-screen",className:s.windowInput,...e.getFieldProps("deliver_delay_window"),error:e.touched.deliver_delay_window&&e.errors.deliver_delay_window?e.errors.deliver_delay_window:void 0}),r.jsx("span",{className:s.windowInputDescription,children:"minutes"})]})]})},R={add:"Add upgrade profile",edit:"Save changes"},H={access_group:"",all_computers:!1,at_hour:"",at_minute:"",autoremove:!1,deliver_delay_window:"",deliver_within:1,every:"week",on_days:[],randomizeDelivery:!1,tags:[],title:"",upgrade_type:"all"},v={add:"added",edit:"updated"},L=e=>V().shape({access_group:d(),all_computers:g(),at_hour:m().when("every",{is:"week",then:a=>a.required("Hour is required.").integer("Hour must be an integer.").min(0,"Hour must be between 0 and 23.").max(23,"Hour must be between 0 and 23.")}),at_minute:m().required("Minute is required.").integer("Minute must be an integer.").min(0,"Minute must be between 0 and 59.").max(59,"Minute must be between 0 and 59."),deliver_delay_window:m().when("randomizeDelivery",{is:!0,then:a=>a.required("This field is required.").integer("This field must be an integer.").max(43200,"Deliver delay window in minutes must be a number less than or equal to 30 days (43200 minutes)").test((n,{createError:u,parent:c})=>n<parseInt(c.deliver_within)*60||u({message:`Deliver delay window of '${n}' minutes should be shorter than the 'deliver within' expiration time of ${c.deliver_within} ${c.deliver_within==="1"?"hour":"hours"}.`})).min(0,"Deliver delay window must be at least 0.")}),deliver_within:m().integer("'Expires after' must be an integer.").min(0,"'Expires after' must be at least 0."),every:d().required("This field is required."),on_days:y().of(d()).when("every",{is:"week",then:a=>a.min(1,"At least one day must be selected.")}),randomizeDelivery:g(),tags:y().of(d()),title:d().test({name:"required",message:"This field is required.",params:{action:e},test:a=>!!a||e!=="add"}),upgrade_type:d().required("This field is required.")}),b=e=>{const a=S(),{notify:n}=F(),{closeSidePanel:u}=D(),{createUpgradeProfileQuery:c,editUpgradeProfileQuery:x}=w(),{getAccessGroupQuery:f}=M(),{data:h}=f({},{enabled:e.action==="add"}),j=(h==null?void 0:h.data.map(({name:i,title:o})=>({label:o,value:i})))??[],{mutateAsync:I}=c,{mutateAsync:N}=x,t=T({initialValues:H,onSubmit:async i=>{const o={access_group:i.access_group,all_computers:i.all_computers,at_minute:i.at_minute,autoremove:i.autoremove,deliver_within:i.deliver_within,every:i.every,on_days:i.on_days,title:i.title,upgrade_type:i.upgrade_type};i.every==="week"&&(o.at_hour=i.at_hour),i.randomizeDelivery&&(o.deliver_delay_window=i.deliver_delay_window),!i.all_computers&&i.tags.length&&(o.tags=i.tags);try{e.action==="edit"?await N({name:e.profile.name,...o}):await I(o),u(),n.success({message:`Upgrade profile "${i.title}" has been ${v[e.action]} `,title:`Upgrade profile ${v[e.action]}`})}catch(P){a(P)}},validationSchema:L(e.action)});return A.useEffect(()=>{e.action!=="edit"||!e.profile||t.setValues({access_group:e.profile.access_group,all_computers:e.profile.all_computers,at_hour:e.profile.at_hour?parseInt(e.profile.at_hour):"",at_minute:parseInt(e.profile.at_minute),autoremove:e.profile.autoremove,deliver_delay_window:parseInt(e.profile.deliver_delay_window),deliver_within:parseInt(e.profile.deliver_within),every:e.profile.every,on_days:e.profile.on_days??[],randomizeDelivery:e.profile.deliver_delay_window!=="0",tags:e.profile.tags,title:e.profile.title,upgrade_type:e.profile.upgrade_type})},[e]),r.jsxs(l.Form,{onSubmit:t.handleSubmit,noValidate:!0,children:[r.jsx(l.Input,{type:"text",required:e.action==="add",label:"Name","aria-label":"Name",...t.getFieldProps("title"),error:t.touched.title&&t.errors.title?t.errors.title:void 0}),r.jsx(l.Input,{type:"checkbox",label:"Only upgrade security issues",help:"Regular upgrades will not be applied",...t.getFieldProps("upgrade_type"),checked:t.values.upgrade_type==="security",onChange:()=>t.setFieldValue("upgrade_type",t.values.upgrade_type==="all"?"security":"all")}),r.jsx(l.Input,{type:"checkbox",label:"Remove packages that are no longer needed",help:"This will affect packages installed to satisfy dependencies that are no longer required after upgrading",...t.getFieldProps("autoremove"),checked:t.values.autoremove}),r.jsx(l.Select,{label:"Access group","aria-label":"Access group",options:j,...t.getFieldProps("access_group"),error:t.touched.access_group&&t.errors.access_group?t.errors.access_group:void 0}),r.jsx(B,{formik:t}),r.jsx(E,{formik:t}),r.jsx(C,{submitButtonDisabled:t.isSubmitting,submitButtonText:R[e.action]})]})},re=Object.freeze(Object.defineProperty({__proto__:null,default:b},Symbol.toStringTag,{value:"Module"})),ae=Object.freeze(Object.defineProperty({__proto__:null,SingleUpgradeProfileForm:b,UpgradeProfileList:q,UpgradeProfilesEmptyState:U,UpgradeProfilesHeader:z,useUpgradeProfiles:w},Symbol.toStringTag,{value:"Module"}));export{ae as a,re as i};
