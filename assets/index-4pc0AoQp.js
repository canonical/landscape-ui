import{j as e,r as x,m as n,y as O,af as K,n as g,o as A,l as Q,J as Y,B,F as v,G as W,v as N,$ as I}from"./index-BLUNVNi0.js";import{A as X}from"./AssociationBlock-CvEbPGq-.js";import{t as L,u as Z}from"./index-SBzvEdcG.js";import{S as ee}from"./SidePanelFormButtons-CCa0SzC-.js";import{u as te}from"./useInstances-BN7IV0n6.js";import{g as j}from"./formikErrors-Bw8iTXYS.js";import{b as re,u as se}from"./ScriptsTabs-Bt_YU9c3.js";import"./index-C6dMcHjK.js";import{D as ne}from"./downshift.esm-WhCqDnza.js";import"./MultiSelectField-Czxb_-Ht.js";import"./HeaderWithSearch-CuoLt-7V.js";import"./SidePanelFormButtons.module-D2P5PizG.js";import"./TruncatedCell-Dck5yj2C.js";import"./useRoles-Dugd59w6.js";import"./SingleInstanceTabs.module-Cm1BYFZQ.js";const w=({label:s,value:a})=>e.jsxs("div",{children:[e.jsx("div",{className:"p-heading--1 u-no-padding--top u-no-margin--bottom",children:a}),e.jsx("div",{className:"p-text--x-small u-text--muted",children:s})]}),ie="_example_16wh9_1",ae="_table_16wh9_6",D={example:ie,table:ae},oe=()=>{const[s,a]=x.useState(!1),i=()=>{a(!0)},d=()=>{a(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(n.Button,{type:"button",appearance:"base",className:"u-no-margin--bottom",hasIcon:!0,onClick:i,children:e.jsx(n.Icon,{name:n.ICONS.help})}),s&&e.jsxs(n.Modal,{title:"Cron job format",close:d,children:[e.jsxs("section",{children:[e.jsx("h1",{className:"p-text--small-caps",children:"Example"}),e.jsxs("div",{className:D.example,children:[e.jsx(w,{label:"Minute",value:"1"}),e.jsx(w,{label:"Hour",value:"*"}),e.jsx(w,{label:e.jsxs(e.Fragment,{children:["Day",e.jsx("br",{}),"(month)"]}),value:"2"}),e.jsx(w,{label:"Month",value:"1-3"}),e.jsx(w,{label:e.jsxs(e.Fragment,{children:["Day",e.jsx("br",{}),"(week)"]}),value:"*"})]}),e.jsx("p",{children:'"At minute 1 on day-of-month 2 in every month from January through March"'})]}),e.jsxs("section",{children:[e.jsx("h1",{className:"p-text--small-caps",children:"Accepted values"}),e.jsx(n.MainTable,{className:D.table,rows:[{columns:[{content:"* (asterisk)"},{content:"Any value"}]},{columns:[{content:", (comma)"},{content:"List separator"}]},{columns:[{content:"- (dash)"},{content:"Range"}]},{columns:[{content:"/ (slash)"},{content:"Step values"}]}]}),e.jsx(n.MainTable,{className:D.table,rows:[{columns:[{content:"Minute"},{content:"0-59"}]},{columns:[{content:"Hour"},{content:"0-23"}]},{columns:[{content:"Day of the month"},{content:"1-31"}]},{columns:[{content:"Month"},{content:"1-12 or JAN-DEC"}]},{columns:[{content:"Day of the week"},{content:"0-6 or SUN-SAT"}]}]})]})]})]})},le=({touched:s,value:a,...i})=>{const d=x.useId();let o="",h="";try{const u=L(a.toString());o=`"${u.charAt(0).toUpperCase()}${u.slice(1)}"`}catch(u){if(!(u instanceof Error))return;h=u.message}return e.jsxs(e.Fragment,{children:[e.jsx("label",{htmlFor:d,children:"* Schedule"}),e.jsx(oe,{}),e.jsx(n.Input,{id:d,type:"text",...i,help:o,value:a,error:s&&h,required:!0})]})},ce="_description_19733_1",de="_indent_19733_6",ue="_notification_19733_11",T={description:ce,indent:de,notification:ue},me="_container_1yawx_1",pe="_suggestionsContainer_1yawx_6",he="_pointer_1yawx_13",ge="_highlighted_1yawx_18",xe="_selectedContainer_1yawx_22",_e="_marginTop_1yawx_30",fe="_extraPadding_1yawx_34",je="_removeButton_1yawx_44",be="_icon_1yawx_48",p={container:me,suggestionsContainer:pe,pointer:he,highlighted:ge,selectedContainer:xe,marginTop:_e,extraPadding:fe,removeButton:je,icon:be},ye=200,ve=(s,a)=>{const i=s.toLowerCase(),d=a.toLowerCase(),o=i.indexOf(d);return o>=0?e.jsxs(e.Fragment,{children:[s.substring(0,o),e.jsx("strong",{children:s.substring(o,o+a.length)}),s.substring(o+a.length)]}):s},Ne=({script:s,setScript:a,existingScriptId:i,errorMessage:d})=>{const[o,h]=x.useState(""),[u,b]=x.useState(!1),[m,C]=x.useState(""),{script:_,isScriptLoading:r}=re(i||0,{enabled:!!i});x.useEffect(()=>{i&&(s==null?void 0:s.id)!==(_==null?void 0:_.id)&&a(_)},[_]);const S=O(),{scripts:q,isScriptsLoading:y}=se({listenToUrlParams:!1},{search:o,script_type:"active",limit:20,offset:0},{enabled:o.length>2}),F=c=>(s==null?void 0:s.id)!==c.id,t=q.filter(F),l=()=>{a(null)},f=()=>{b(!1)},E=()=>{C(""),h("")},R=()=>{m.length>2?b(!0):b(!1)},$=c=>{C(c),c.length>2&&h(c)},U=K(()=>{try{R()}catch(c){S(c)}},ye),V=c=>{c&&(a(c),b(!1),E())},G=c=>{c.key==="Escape"?c.currentTarget.blur():U()},M=m.length<3?"Min 3. characters":q.length===0&&o&&!y?`No scripts found by "${o}"`:i?"Scripts can't be replaced after the profile has been created.":null;return e.jsxs("div",{className:g(p.container,"p-form__group p-form-validation"),children:[e.jsx("label",{className:"is-required p-form__label",htmlFor:i?"script-selected":"script-search",children:"Script"}),!i&&e.jsx(ne,{onSelect:V,itemToString:()=>"",isOpen:u,children:({getInputProps:c,getItemProps:H,getMenuProps:J,highlightedIndex:z})=>e.jsxs("div",{className:"p-autocomplete",children:[e.jsx(n.SearchBox,{...c(),id:i?void 0:"script-search",placeholder:"Search for scripts",required:!0,className:"u-no-margin--bottom",shouldRefocusAfterReset:!0,externallyControlled:!0,autocomplete:"off",value:m,onChange:$,onClear:E,onBlur:f,onFocus:R,onKeyUp:G}),M?e.jsx("span",{className:"p-form-help-text",children:M}):null,d&&!u?e.jsx("div",{className:"is-error",children:e.jsx("span",{className:"p-form-validation__message",id:"script-error",children:e.jsx("span",{children:d})})}):null,u&&(t.length>0||y)?e.jsx("ul",{className:g("p-list p-card--highlighted u-no-padding u-no-margin--bottom p-autocomplete__suggestions",p.suggestionsContainer),...J(),children:y?e.jsx(A,{}):t.map((P,k)=>e.jsx("li",{className:g("p-list__item",p.pointer,{[p.highlighted]:z===k}),...H({item:P,index:k}),children:e.jsx("div",{className:"u-truncate","data-testid":"dropdownElement",children:ve(P.title,o)})},P.id))}):null]})}),r?e.jsx(A,{}):null,s&&e.jsxs("div",{id:"script-selected",className:g("p-autocomplete__result p-list__item p-card u-no-margin--bottom",p.selectedContainer,{[p.marginTop]:!i,[p.extraPadding]:i}),children:[e.jsx("span",{children:e.jsx("b",{children:s.title})}),i?null:e.jsx(n.Button,{type:"button",appearance:"base",className:g(p.removeButton,"u-no-margin--bottom u-no-margin--right"),onClick:l,children:e.jsx(n.Tooltip,{message:"Remove",children:e.jsx(n.Icon,{name:n.ICONS.delete,className:p.icon})})})]},s.id)]})},Le=({onSubmit:s,onSuccess:a,initialValues:i,disabledFields:d={},submitButtonText:o,submitting:h=!1})=>{const u=O(),{closeSidePanel:b}=Q(),{scriptProfileLimits:m,isGettingScriptProfileLimits:C}=Z(),{getInstancesQuery:_}=te(),r=Y({initialValues:i,validationSchema:B().shape({interval:v().when("trigger_type",([t],l)=>t=="recurring"?l.required("This field is required").test({test:f=>{try{return L(f),!0}catch{return!1}}}):l),script:B().when("script_id",([t],l)=>t==null?l.required("This field is required"):l),start_after:v().when("trigger_type",([t],l)=>t=="recurring"?l.required("This field is required").test({test:f=>N(f).utc(!0).isSameOrAfter(N()),message:"The start date must not be in the past."}):l),time_limit:W().required("This field is required"),timestamp:v().when("trigger_type",([t],l)=>t=="one_time"?l.required("This field is required").test({test:f=>N(f).utc(!0).isSameOrAfter(N()),message:"The date must not be in the past."}):l),title:v().required("This field is required"),trigger_type:v().required("This field is required"),username:v().required("This field is required")}),onSubmit:async t=>{if(!(!t.trigger_type||t.script_id==null)){try{switch(t.trigger_type){case"event":{await s({...t,script_id:t.script_id,trigger:{trigger_type:"event",event_type:"post_enrollment"}});break}case"one_time":{if(!t.timestamp)return;await s({...t,script_id:t.script_id,trigger:{trigger_type:"one_time",timestamp:t.timestamp,last_run:"",next_run:""}});break}case"recurring":{if(!t.interval||!t.start_after)return;await s({...t,script_id:t.script_id,trigger:{trigger_type:"recurring",interval:t.interval,start_after:t.start_after,last_run:"",next_run:""}});break}}}catch(l){u(l);return}b(),a(t)}}}),{data:S,isLoading:q}=_({query:r.values.all_computers?void 0:r.values.tags.map(t=>`tag:${t}`).join(" OR ")}),[y,F]=x.useState(!1);if(x.useEffect(()=>{if(!(!S||!m)){if(!r.values.tags.length&&!r.values.all_computers){F(!1);return}F(S.data.count>=m.max_num_computers)}},[S]),C)return e.jsx(A,{});if(m)return e.jsxs(n.Form,{noValidate:!0,onSubmit:r.handleSubmit,children:[e.jsx(n.Input,{type:"text",label:"Name",required:!0,...r.getFieldProps("title"),error:j(r,"title")}),e.jsx(Ne,{script:r.values.script,existingScriptId:r.initialValues.script_id,setScript:async t=>{await r.setFieldValue("script",t),await r.setFieldValue("script_id",t==null?void 0:t.id)},errorMessage:j(r,"script")}),e.jsxs(n.Row,{className:"u-no-padding",children:[e.jsx(n.Col,{size:6,children:e.jsx(n.Input,{type:"text",label:"Run as user",required:!0,...r.getFieldProps("username"),error:j(r,"username")})}),e.jsx(n.Col,{size:6,children:e.jsx(n.Input,{type:"number",label:"Time limit (seconds)",required:!0,...r.getFieldProps("time_limit"),error:j(r,"time_limit")})})]}),e.jsx(n.CustomSelect,{label:"Trigger",required:!0,onChange:async t=>{await r.setFieldValue("trigger_type",t)},value:r.values.trigger_type,disabled:d.trigger_type,error:j(r,"trigger_type"),options:[{label:e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"u-no-padding--top u-no-margin--bottom",children:"Post enrollment"}),e.jsx("p",{className:g(T.description,"u-no-margin--bottom"),children:e.jsx("small",{children:"Run the script after a new instance is enrolled"})})]}),value:"event",text:"Post enrollment"},{label:e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"u-no-padding--top u-no-margin--bottom",children:"On a date"}),e.jsx("p",{className:g(T.description,"u-no-margin--bottom"),children:e.jsx("small",{children:"Run the script on a selected date"})})]}),value:"one_time",text:"On a date"},{label:e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"u-no-padding--top u-no-margin--bottom",children:"Recurring"}),e.jsx("p",{className:g(T.description,"u-no-margin--bottom"),children:e.jsx("small",{children:"Run the script on a recurring schedule"})})]}),value:"recurring",text:"Recurring"}],help:d.trigger_type&&"Trigger type can't be changed after the script is created."}),e.jsxs("div",{className:T.indent,children:[r.values.trigger_type=="one_time"&&e.jsx(n.Input,{type:"datetime-local",label:"Date",required:!0,min:N().utc(!0).format(I),...r.getFieldProps("timestamp"),error:j(r,"timestamp")}),r.values.trigger_type=="recurring"&&e.jsxs(e.Fragment,{children:[e.jsx(n.Input,{type:"datetime-local",label:"Start date",required:!0,min:N().utc(!0).format(I),...r.getFieldProps("start_after"),error:j(r,"start_after")}),e.jsxs(n.Notification,{severity:"caution",className:T.notification,children:["There is a minimum interval of"," ",e.jsxs("strong",{children:[m==null?void 0:m.min_interval," minutes"]})," ","between runs. Depending on the schedule, run times may be adjusted."]}),e.jsx(le,{required:!0,touched:r.touched.interval,...r.getFieldProps("interval")})]})]}),y&&e.jsxs(n.Notification,{severity:"negative",inline:!0,title:"Associated instances limit reached:",children:["You've reached the limit of"," ",e.jsxs("strong",{children:[m.max_num_computers," associated instances"]}),". Decrease the number of associated instances."]}),e.jsx(X,{formik:r}),e.jsx(ee,{submitButtonDisabled:h||y||q,submitButtonLoading:h,submitButtonText:o})]})};export{Le as default};
