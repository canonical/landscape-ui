import{r as d,j as u,g as S,k as T,h as A}from"./index-BMhnQnvO.js";import{S as B,E as I}from"./SelectAllButton-D_BMBSCB.js";import{a as E}from"./useUsns-Dw6dj2_v.js";import"./ExpandableTableFooter-9RPwl5aD.js";import"./useFetchOld-Cff5y19B.js";import"./useMutation-Diy-BhWO.js";import"./useQuery-Dxk6aJEc.js";const H="_hidden_vofak_1",z={hidden:H},M=({lastPackageIndex:e,loading:t,showToggle:r})=>({column:s,row:{index:o}})=>{const n={};return(r&&o===0||t&&o===e)&&(s.id==="checkbox"?n.colSpan=5:(n.className=z.hidden,n["aria-hidden"]=!0)),n},v=(e,t,r)=>[...e.slice(t?-1:e.length),...e,...e.slice(r?-1:e.length)],D=(e,t)=>{const r=new Set(e),s=t.filter(({id:o})=>!r.has(o)).length;return s===0?"unchecked":s===t.length?"checked":"indeterminate"},R=({excludedPackages:e,instance:t,onExcludedPackagesChange:r,onLimitChange:s,packages:o,packagesCount:n,packagesLoading:p})=>{var g;const m=((g=e.find(({id:l})=>l===t.id))==null?void 0:g.exclude_packages)??[],b=d.useMemo(()=>{const l=new Set(o.map(({id:a})=>a));return m.length>0&&m.some(a=>!l.has(a))},[m.length,o]),h=d.useMemo(()=>v(o,b,p),[o,b,p]),j=()=>{const l=o.map(({id:a})=>a);r(e.map(({id:a,exclude_packages:i})=>a!==t.id?{id:a,exclude_packages:i}:{id:a,exclude_packages:i.length<l.length?l:[]}))},k=l=>{r(e.map(({id:a,exclude_packages:i})=>a!==t.id?{id:a,exclude_packages:i}:{id:a,exclude_packages:i.includes(l)?i.filter(x=>x!==l):[...i,l]}))},C=D(m,o),P=d.useMemo(()=>[{accessor:"checkbox",className:"checkbox-column",Header:u.jsx(S.CheckboxInput,{inline:!0,label:u.jsx("span",{className:"u-off-screen",children:"Toggle all packages"}),disabled:h.length===0,checked:C==="checked",indeterminate:C==="indeterminate",onChange:j}),Cell:({row:{index:l,original:a}})=>p&&l===h.length-1?u.jsx(T,{}):l===0&&b?u.jsx(B,{count:n-m.length,itemName:{plural:"packages",singular:"package"},onClick:()=>r(e.map(({id:i,exclude_packages:x})=>({id:i,exclude_packages:i!==t.id?x:[]}))),totalCount:n}):u.jsx(S.CheckboxInput,{inline:!0,label:u.jsxs("span",{className:"u-off-screen",children:["Toggle ",a.name," package"]}),checked:!m.includes(a.id),onChange:()=>k(a.id)})},{accessor:"name",Header:"Name"},{accessor:"current_version",Header:"Current version"},{accessor:"available_version",Header:"New version"},{accessor:"summary",Header:"Details"}],[h.length,p,m.length]);return p&&!o.length?u.jsx(T,{}):u.jsx(I,{columns:P,data:h,itemCount:o.length,itemNames:{plural:"packages",singular:"package"},onLimitChange:s,totalCount:n,title:u.jsxs("p",{className:"p-heading--4",children:["Packages affected on ",u.jsx("b",{children:t.title})]}),getCellProps:M({lastPackageIndex:h.length-1,loading:p,showToggle:b})})},$="_nameColumn_3zjyb_1",L="_expanded_3zjyb_5",O="_expandButton_3zjyb_23",Q="_hidden_3zjyb_31",q="_innerTable_3zjyb_35",F="_row_3zjyb_39",_={nameColumn:$,expanded:L,expandButton:O,hidden:Q,innerTable:q,row:F},G=e=>({column:t,row:{index:r}})=>{const s={};return e>-1&&e===r-1?t.id==="title"?(s.colSpan=2,e>-1&&e===r-1&&(s.className=_.innerTable)):(s.className=_.hidden,s["aria-hidden"]=!0):t.id==="title"?s.role="rowheader":t.id==="upgrades"&&(s["aria-label"]="Affected packages",s.className=e===r?_.expanded:_.row),s},J=({excludedPackages:e,instances:t,onExcludedPackagesChange:r})=>{var w;const[s,o]=d.useState(5),[n,p]=d.useState(-1),[m,b]=d.useState([]),[h,j]=d.useState(0),k=d.useRef(0),C=d.useRef(-1),{getInstancePackagesQuery:P}=E(),{data:g,isLoading:l}=P({instance_id:(w=t[n])==null?void 0:w.id,limit:5,offset:h,upgrade:!0},{enabled:n>-1});d.useEffect(()=>{g&&(k.current=g.data.count,h!==C.current?(C.current=h,b(c=>[...c,...g.data.results])):(C.current=h,b(c=>[...c.slice(0,-1*g.data.results.length),...g.data.results])))},[g]);const a=c=>{j(0),b([]),p(f=>f===c?-1:f>-1&&f<c?c-1:c)},i=d.useMemo(()=>n>-1?[...t.slice(0,n+1),...t.slice(n,s)]:t.slice(0,s),[t,s,n]),x=d.useMemo(()=>[{accessor:"title",className:_.nameColumn,Header:"Name",Cell:({row:{index:c,original:f}})=>n===-1||c!==n+1?f.title:u.jsx(R,{excludedPackages:e,instance:f,onExcludedPackagesChange:r,onLimitChange:()=>j(N=>N+5),packages:m,packagesCount:k.current,packagesLoading:l})},{accessor:"upgrades",Header:"Affected packages",Cell:({row:{index:c,original:f}})=>{var N,y;return u.jsx(S.Button,{type:"button",className:A("p-accordion__tab",_.expandButton),"aria-expanded":n===c,onClick:()=>a(c),children:((N=f.upgrades)==null?void 0:N.regular)??((y=f.upgrades)==null?void 0:y.security)??0})}}],[e,n,l,m,i.length]);return u.jsx(I,{columns:x,data:i,getCellProps:G(n),itemNames:{plural:"instances",singular:"instance"},onLimitChange:()=>o(c=>c+5),totalCount:t.length})},ee=J;export{ee as default};
