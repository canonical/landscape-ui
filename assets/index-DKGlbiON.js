import{e as Y,r as I,j as a,g as i}from"./index-Ck927htQ.js";import{u as J,C as K,d as w}from"./index-Cjc96b3q.js";import{u as W}from"./formik.esm-BeHAEGbw.js";import{c as F,a as o,g as c,d as C,f as A}from"./index.esm-DVEO1SHz.js";import{S as X}from"./SidePanelFormButtons-Bz2-NFyW.js";import{u as Z}from"./useRoles-GopnYtq3.js";import{h as ee}from"./moment-Cl4UOzQZ.js";const te="_bold_23wb5_1",re="_radioGroup_23wb5_5",q={bold:te,radioGroup:re},ae={access_group:"",attachments:{first:null,second:null,third:null,fourth:null,fifth:null},code:"",deliverImmediately:!0,deliver_after:"",saveScript:!0,script_id:0,time_limit:300,title:"",type:"new",username:""},se=F().shape({access_group:o().when("type",{is:"new",then:s=>s.required()}),attachments:F().shape({first:c().nullable(),second:c().nullable(),third:c().nullable(),fourth:c().nullable(),fifth:c().nullable()}),code:o().when("type",{is:"new",then:s=>s.required()}),deliverImmediately:C().required(),deliver_after:o().when("deliverImmediately",{is:!1,then:s=>s.required()}),saveScript:C().when("type",{is:"new",then:s=>s.required()}),script_id:A().when("type",{is:"existing",then:s=>s.min(1,"Script is required")}),time_limit:A().when("type",{is:"new",then:s=>s.required()}),title:o().when("type",{is:"new",then:s=>s.required()}),type:o().required(),username:o().required()}),N=({query:s})=>{var h,f,b,y,g,v,_,S,x,j;const T=Y(),{getAccessGroupQuery:P}=Z(),{createScriptAttachmentQuery:V,createScriptQuery:$,executeScriptQuery:O,getScriptsQuery:E,removeScriptQuery:B}=J(),{mutateAsync:k}=V,{mutateAsync:D}=$,{mutateAsync:m}=O,{mutateAsync:M}=B,G=async t=>{if(t.type==="existing")return m({deliver_after:t.deliverImmediately?t.deliver_after:void 0,query:s,script_id:t.script_id,username:t.username});const{data:r}=await D({title:t.title,time_limit:t.time_limit,code:w.Buffer.from(t.code).toString("base64"),access_group:t.access_group,username:t.username}),n=Object.values(t.attachments).filter(Boolean);if(n.length>0){const z=await Promise.all(n.map(d=>d.arrayBuffer())),H=n.map(({name:d},U)=>k({script_id:r.id,file:`${d}$$${w.Buffer.from(z[U]).toString("base64")}`}));await Promise.all(H)}await m({deliver_after:t.deliverImmediately?t.deliver_after:void 0,query:s,script_id:r.id,username:t.username}),t.saveScript||await M({script_id:r.id})},e=W({initialValues:ae,validationSchema:se,onSubmit:async t=>{try{await G(t)}catch(r){T(r)}}}),{data:l}=E(),L=I.useMemo(()=>((l==null?void 0:l.data.results)??[]).map(({id:t,title:r})=>({label:r,value:`${t}`})),[l]),Q=t=>{var r;e.setFieldValue("script_id",parseInt(t.target.value)),e.values.username||e.setFieldValue("username",((r=l==null?void 0:l.data.results.find(({id:n})=>`${n}`===t.target.value))==null?void 0:r.username)??"")},{data:u}=P(),R=I.useMemo(()=>((u==null?void 0:u.data)??[]).map(({name:t,title:r})=>({label:r,value:t})),[u]),p=t=>{const r=t.currentTarget.value==="true";e.setFieldValue("deliverImmediately",r),r||e.setFieldValue("deliver_after",ee().toISOString().slice(0,16))};return a.jsxs(i.Form,{onSubmit:e.handleSubmit,noValidate:!0,children:[a.jsx(i.Select,{label:"Type",labelClassName:"u-off-screen",required:!0,options:[{label:"New script",value:"new"},{label:"Existing script",value:"existing"}],...e.getFieldProps("type"),error:e.touched.type&&e.errors.type?e.errors.type:void 0}),e.values.type==="existing"&&a.jsx(i.Select,{label:"Script",required:!0,options:[{label:"Select script",value:0},...L],...e.getFieldProps("script_id"),onChange:Q,error:e.touched.script_id&&e.errors.script_id?e.errors.script_id:void 0}),e.values.type==="new"&&a.jsxs(a.Fragment,{children:[a.jsx(i.Input,{label:"Title",type:"text",required:!0,...e.getFieldProps("title"),error:e.touched.title&&e.errors.title?e.errors.title:void 0}),a.jsx(i.Input,{label:"Time limit",type:"number",required:!0,...e.getFieldProps("time_limit"),error:e.touched.time_limit&&e.errors.time_limit?e.errors.time_limit:void 0}),a.jsx(K,{label:"Code",required:!0,onChange:t=>{e.setFieldValue("code",t??"")},value:e.values.code,error:e.touched.code&&e.errors.code?e.errors.code:void 0}),a.jsx(i.Select,{label:"Access group",required:!0,options:[{label:"Select access group",value:""},...R],...e.getFieldProps("access_group"),error:e.touched.access_group&&e.errors.access_group?e.errors.access_group:void 0})]}),a.jsx(i.Input,{label:"Run as user",type:"text",required:!0,...e.getFieldProps("username"),error:e.touched.username&&e.errors.username?e.errors.username:void 0}),e.values.type==="new"&&a.jsxs(a.Fragment,{children:[a.jsx(i.CheckboxInput,{label:"Save script",...e.getFieldProps("saveScript"),checked:e.values.saveScript}),a.jsx("h5",{children:"List of attachments"}),a.jsx("p",{className:"u-text--muted",children:"Attachments that will be sent along with the script. You can attach up to 5 files, for a maximum of 1.00MB. Filenames must be unique. On the client, the attachments will be placed in the directory whose name is accessible through the environment variable LANDSCAPE_ATTACHMENTS. They'll be deleted once the script has been run."}),a.jsx(i.Input,{label:"First attachment",labelClassName:"u-off-screen",type:"file",onChange:t=>{var r;e.setFieldValue("attachments.first",((r=t.target.files)==null?void 0:r[0])??null)},error:((h=e.touched.attachments)==null?void 0:h.first)&&((f=e.errors.attachments)==null?void 0:f.first)}),a.jsx(i.Input,{label:"Second attachment",labelClassName:"u-off-screen",type:"file",onChange:t=>{var r;e.setFieldValue("attachments.second",((r=t.target.files)==null?void 0:r[0])??null)},error:((b=e.touched.attachments)==null?void 0:b.second)&&((y=e.errors.attachments)==null?void 0:y.second)}),a.jsx(i.Input,{label:"Third attachment",labelClassName:"u-off-screen",type:"file",onChange:t=>{var r;e.setFieldValue("attachments.third",((r=t.target.files)==null?void 0:r[0])??null)},error:((g=e.touched.attachments)==null?void 0:g.third)&&((v=e.errors.attachments)==null?void 0:v.third)}),a.jsx(i.Input,{label:"Fourth attachment",labelClassName:"u-off-screen",type:"file",onChange:t=>{var r;e.setFieldValue("attachments.fourth",((r=t.target.files)==null?void 0:r[0])??null)},error:((_=e.touched.attachments)==null?void 0:_.fourth)&&((S=e.errors.attachments)==null?void 0:S.fourth)}),a.jsx(i.Input,{label:"Fifth attachment",labelClassName:"u-off-screen",type:"file",onChange:t=>{var r;e.setFieldValue("attachments.fifth",((r=t.target.files)==null?void 0:r[0])??null)},error:((x=e.touched.attachments)==null?void 0:x.fifth)&&((j=e.errors.attachments)==null?void 0:j.fifth)})]}),a.jsx("span",{className:q.bold,children:"Delivery time"}),a.jsxs("div",{className:q.radioGroup,children:[a.jsx(i.Input,{type:"radio",label:"As soon as possible",name:"deliverImmediately",value:"true",onChange:p,checked:e.values.deliverImmediately}),a.jsx(i.Input,{type:"radio",label:"Scheduled",name:"deliverImmediately",value:"false",onChange:p,checked:!e.values.deliverImmediately})]}),!e.values.deliverImmediately&&a.jsx(i.Input,{label:"Deliver after",type:"datetime-local",labelClassName:"u-off-screen",...e.getFieldProps("deliver_after"),error:e.touched.deliver_after&&e.errors.deliver_after?e.errors.deliver_after:void 0}),a.jsx(X,{submitButtonDisabled:e.isSubmitting,submitButtonText:"Run script"})]})},me=Object.freeze(Object.defineProperty({__proto__:null,default:N},Symbol.toStringTag,{value:"Module"})),pe=Object.freeze(Object.defineProperty({__proto__:null,default:N},Symbol.toStringTag,{value:"Module"}));export{me as R,pe as i};
