import{r as f,j as c,g as T,n as k,m as H}from"./index-xYBbIcB9.js";import{a as U}from"./usePackages-DDBwKMX4.js";import"./usePageParams-BPqOE3H2.js";import{S as M,E as R}from"./SelectAllButton-mUq2XMyJ.js";import"./useFetchOld-BU5n9LWB.js";import"./ExpandableTableFooter-CKv6Dm1Z.js";try{let e=typeof window<"u"?window:typeof global<"u"?global:typeof globalThis<"u"?globalThis:typeof self<"u"?self:{},t=new e.Error().stack;t&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[t]="da6eeaef-d2d8-455e-8cb9-696a27610cb2",e._sentryDebugIdIdentifier="sentry-dbid-da6eeaef-d2d8-455e-8cb9-696a27610cb2")}catch{}const x=(e,t)=>{const a=new Set(t.computers.map(n=>n.id));return e.some(({exclude_packages:n,id:s})=>a.has(s)&&!n.includes(t.id))},y=(e,t,a)=>{const n=new Set(t.computers.map(({id:s})=>s));return e.map(({id:s,exclude_packages:r})=>{if(!n.has(s))return{id:s,exclude_packages:r};const d=r.filter(o=>o!==t.id);return{id:s,exclude_packages:a?[...d,t.id]:d}})},q=(e,t)=>y(e,t,x(e,t)),E=e=>({column:t,row:a})=>{const n={};return e&&a.index===0?t.id==="checkbox"?n.colSpan=4:(n.style=n.style||{},n.style.display="none",n["aria-hidden"]=!0):t.id==="checkbox"?n["aria-label"]=`Toggle ${a.original.name} instance`:t.id==="title"?n.role="rowheader":t.id==="current_version"?n["aria-label"]="Current version":t.id==="available_version"&&(n["aria-label"]="New version"),n},F=(e,t,a)=>{var n;return!((n=e.find(({id:s})=>s===t))!=null&&n.exclude_packages.includes(a))},z=(e,t,a)=>e.map(({id:n,exclude_packages:s})=>n!==t?{id:n,exclude_packages:s}:{id:n,exclude_packages:s.includes(a)?s.filter(r=>r!==r):[...s,a]}),L=({excludePackages:e,instances:t,limit:a,pkg:n})=>{const s=new Set(n.computers.map(({id:l})=>l)),r=t.filter(({id:l})=>s.has(l)).slice(0,a),d=new Set(e.filter(({exclude_packages:l})=>l.includes(n.id)).map(({id:l})=>l)),o=r.filter(({id:l})=>!d.has(l)).length;return o===0?"unchecked":o===r.length?"checked":"indeterminate"},$=(e,t)=>{const a=new Set(t.computers.map(({id:n})=>n));return e.filter(({exclude_packages:n,id:s})=>a.has(s)&&!n.includes(t.id)).length},O=(e,t)=>y(e,t,!1),V=({currentPackage:e,excludedPackages:t,limit:a,onExcludedPackagesChange:n,onLimitChange:s,selectedInstances:r})=>{const d=new Set(e.computers.map(({id:u})=>u)),o=t.filter(({exclude_packages:u})=>u.includes(e.id)),l=f.useMemo(()=>{const u=new Set(r.slice(0,a).map(({id:m})=>m));return o.some(({id:m})=>!u.has(m))},[o.length,r.length,a]),w=f.useMemo(()=>[...r.slice(0,l?1:0),...r.filter(({id:u})=>d.has(u)).slice(0,a)],[d,a,r,l]),h=()=>{n(q(t,e))},g=u=>{n(z(t,u,e.id))},b=()=>{n(O(t,e))},C=L({excludePackages:t,instances:r,limit:a,pkg:e}),S=f.useMemo(()=>[{accessor:"checkbox",className:"checkbox-column",Header:c.jsx(T.CheckboxInput,{inline:!0,label:c.jsx("span",{className:"u-off-screen",children:"Toggle all instances"}),checked:C==="checked",indeterminate:C==="indeterminate",onChange:h}),Cell:({row:{index:u,original:m}})=>l&&u===0?c.jsx(M,{count:$(t,e),itemName:{plural:"instances",singular:"instance"},onClick:b,totalCount:d.size}):c.jsx(T.CheckboxInput,{inline:!0,label:c.jsxs("span",{className:"u-off-screen",children:["Toggle ",m.title," instance"]}),checked:F(t,m.id,e.id),onChange:()=>g(m.id)})},{accessor:"title",Header:"Name"},{accessor:"current_version",Header:"Current version",Cell:({row:{original:u}})=>{var m;return c.jsx(c.Fragment,{children:(m=e.computers.find(({id:_})=>_===u.id))==null?void 0:m.current_version})}},{accessor:"available_version",Header:"New version",Cell:({row:{original:u}})=>{var m;return c.jsx(c.Fragment,{children:(m=e.computers.find(({id:_})=>_===u.id))==null?void 0:m.available_version})}}],[e,t,w]);return c.jsx(R,{columns:S,data:w,getCellProps:E(l),itemNames:{plural:"instances",singular:"instance"},onLimitChange:s,totalCount:d.size,title:c.jsxs("p",{className:"p-heading--4",children:["Instances affected by ",c.jsx("b",{children:e.name})]})})},v={name:"",computers:[],summary:"",id:-1},G="_nameColumn_16mb2_1",K="_expanded_16mb2_5",Q="_expandButton_16mb2_23",Y="_hidden_16mb2_32",J="_innerTable_16mb2_36",W="_row_16mb2_40",I={nameColumn:G,expanded:K,expandButton:Q,hidden:Y,innerTable:J,row:W},X=({expandedRow:e,isPackagesLoading:t,lastPackageIndex:a,showSelectAllButton:n})=>({column:s,row:{index:r,original:d}})=>{const o={};return n&&r===0||t&&r===a||e>-1&&e===r-1?s.id==="name"?(o.colSpan=3,e>-1&&e===r-1&&(o.className=I.innerTable)):(o.className=I.hidden,o["aria-hidden"]=!0):s.id==="checkbox"?o["aria-label"]=`Toggle ${d.name} package`:s.id==="name"?o.role="rowheader":s.id==="version"?o["aria-label"]="Current version":s.id==="new_version"?o["aria-label"]="New version":s.id==="computers.upgrades"&&(o["aria-label"]="Affected instances",o.className=e===r?I.expanded:I.row),o},Z=(e,t)=>t.some(a=>x(e,a)),P=(e,t)=>t.length>0&&t.every(({computers:a,id:n})=>e.filter(({id:s})=>a.some(r=>r.id===s)).every(({exclude_packages:s})=>!s.includes(n))),ee=(e,t,a)=>t.reduce((n,s)=>y(n,s,a),e),te=({expandedRow:e,isPackagesLoading:t,packages:a,showSelectAllButton:n})=>{const s=e>-1?e+1:0;return[...[v].slice(n?0:1),...a.slice(0,s||a.length),...a.slice(s?s-1:a.length),...[v].slice(t?0:1)]},A=(e,t)=>{const a=new Set(t.computers.map(({id:n})=>n));return e.every(({exclude_packages:n,id:s})=>!a.has(s)||!n.includes(t.id))},ne=({excludedPackages:e,hasNoMoreItems:t,instances:a,isPackagesLoading:n,onExcludedPackagesChange:s,onTableLimitChange:r,packages:d,totalPackageCount:o})=>{const[l,w]=f.useState(-1),[h,g]=f.useState(5),b=new Set(e.flatMap(({exclude_packages:i})=>i)),C=f.useMemo(()=>{const i=new Set(d.map(({id:p})=>p));for(const p of b)if(!i.has(p))return!0;return!1},[d.length,b]),S=f.useMemo(()=>te({expandedRow:l,isPackagesLoading:n,packages:d,showSelectAllButton:C}),[d,l,n,C]),u=Z(e,d),m=()=>{s(ee(e,d,u))},_=i=>{s(q(e,i))},B=i=>{g(5),w(p=>p===i?-1:i>p&&p!==-1?i-1:i)},N=P(e,d),D=f.useMemo(()=>[{accessor:"checkbox",className:"checkbox-column",Header:c.jsx(T.CheckboxInput,{inline:!0,label:c.jsx("span",{className:"u-off-screen",children:"Toggle all packages"}),disabled:S.length===0,checked:N,indeterminate:!N&&u,onChange:m}),Cell:({row:{original:i}})=>c.jsx(T.CheckboxInput,{inline:!0,label:c.jsxs("span",{className:"u-off-screen",children:["Toggle ",i.name," package"]}),checked:A(e,i),indeterminate:!A(e,i)&&x(e,i),onChange:()=>_(i)})},{accessor:"name",className:I.nameColumn,Header:"Package name",Cell:({row:{index:i,original:p}})=>C&&i===0?c.jsx(M,{count:o-b.size,itemName:{plural:"packages",singular:"package"},onClick:()=>s(e.map(({id:j})=>({id:j,exclude_packages:[]}))),totalCount:o}):l!==-1&&l===i-1?c.jsx(V,{currentPackage:p,excludedPackages:e,limit:h,onExcludedPackagesChange:s,onLimitChange:()=>g(j=>j+5),selectedInstances:a}):n&&i===S.length-1?c.jsx(k,{}):p.name},{accessor:"computers.upgrades",Header:"Affected instances",Cell:({row:{index:i,original:p}})=>c.jsx(T.Button,{type:"button",className:H("p-accordion__tab",I.expandButton),"aria-expanded":l===i,onClick:()=>B(i),children:new Set(p.computers.map(({id:j})=>j)).size})}],[S,a,e,l,n,h]);return c.jsx(R,{columns:D,data:S,itemCount:d.length,hasNoMoreItems:t,getCellProps:X({expandedRow:l,isPackagesLoading:n,lastPackageIndex:S.length-1,showSelectAllButton:C}),itemNames:{plural:"packages",singular:"package"},onLimitChange:r,totalCount:o})},ce=({excludedPackages:e,instances:t,onExcludedPackagesChange:a})=>{const[n,s]=f.useState([]),[r,d]=f.useState(0),o=f.useRef(0),l=f.useRef(-1),{getPackagesQuery:w}=U(),{data:h,isLoading:g}=w({query:`id:${t.map(({id:b})=>b).join(" OR id:")}`,upgrade:!0,limit:5,offset:r});return f.useEffect(()=>{!h||r===l.current||(o.current=h.data.count,l.current=r,s(b=>[...b,...h.data.results]))},[h]),g&&!n.length?c.jsx(k,{}):c.jsx(ne,{excludedPackages:e,hasNoMoreItems:(h==null?void 0:h.data.next)===null,instances:t,isPackagesLoading:g,onExcludedPackagesChange:a,onTableLimitChange:()=>d(b=>b+5),packages:n,totalPackageCount:o.current})};export{ce as default};
