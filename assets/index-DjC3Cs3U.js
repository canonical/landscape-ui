import{f as H,c as q,a3 as K,aG as Q,j as e,G as w,d,q as f,t as W,v as U,z as V,y as J,x as F,r as p,e as _,D as X,p as Y,aH as ee}from"./index-CNSDWj8Q.js";import{P as se,a as te,b as ae}from"./PageMain-C8MVZwda.js";import{u as ne}from"./useGetInstances-rIFBd_bT.js";import{w as oe,E as re,x as z,y as k,F as S,z as ce,G as ie,J as le}from"./InstancesPageActions-DL7_pmR1.js";import"./index-CySvbr4l.js";import{u as ue}from"./useSelection-BsZpRomB.js";import{a as de}from"./TablePagination-CFXNvqsZ.js";import{P as A}from"./PageParamFilter-ChSwlZqZ.js";import{u as y,T as pe}from"./TableFilterChips-06YfpJdc.js";import{T as C}from"./TableFilter-2AKF5NjJ.js";import{S as he}from"./index-D-YBZSy_.js";import{u as D}from"./useFetchOld-BAAs34Op.js";import{S as me}from"./SidePanelTablePagination-CaBsUOYn.js";import{L as xe}from"./constants-CDnVvJTb.js";import{T as ge}from"./TruncatedCell-BMum6DLZ.js";import{u as fe}from"./useExpandableRow-B4jhRgod.js";import{u as Se}from"./useGetTags-B_HL7bdb.js";import{u as ve}from"./useRoles-DYJzr0u4.js";import{u as je}from"./useInstanceSearchHelpTerms-Djw2vq_i.js";import"./ListTitle-BUruUKn1.js";import"./NoData-6ZK9sV5u.js";import"./ResponsiveTable-BXalKviy.js";import"./StaticLink-BEYCGcPv.js";import"./TextConfirmationModal-q88mH05g.js";import"./InfoGrid-3w5mqARw.js";import"./InfoItem-Bt7JBIPo.js";import"./Truncated-Dtg97i8C.js";import"./formikErrors-Bw8iTXYS.js";const _e=()=>{const s=H(),{data:t,isPending:a}=q({queryKey:["availabilityZones"],queryFn:async()=>s.get("computers/availability-zones")});return{availabilityZones:t?.data.values??[],isGettingAvailabilityZones:a}},ye="_menuContainer_5qitl_1",Ce="_wrapper_5qitl_6",L={menuContainer:ye,wrapper:Ce},be=({filters:s,collapseFrom:t="md",className:a,menuPosition:o="right",isCollapsed:r=!1,menuLabel:c=e.jsxs(e.Fragment,{children:[e.jsx(d.Icon,{name:"filter"}),e.jsx("span",{children:"Filters"})]})})=>{const n=K(`(min-width: ${Q[t]}px)`);return e.jsx("div",{className:w(L.wrapper,a),children:n&&!r?s.map((i,l)=>e.jsx("span",{children:i},l)):e.jsx(d.ContextualMenu,{position:o,hasToggleIcon:!0,toggleLabel:c,toggleClassName:"u-no-margin--bottom",children:e.jsx("div",{className:L.menuContainer,children:s.map((i,l)=>i.type.name?e.jsx(oe,{el:i},l):i)})})})},Ie="_label_1i8qt_1",Pe={label:Ie},we=({options:s,label:t,inline:a=!1})=>{const{disabledColumns:o,setPageParams:r}=f(),c=n=>s.filter(({value:i})=>!n.includes(i)).map(({value:i})=>i);return y("disabledColumns",s.filter(n=>n.canBeHidden).map(n=>n.value)),e.jsx(C,{type:"multiple",showSelectedItemCount:!0,label:e.jsxs(e.Fragment,{children:[e.jsx(d.Icon,{name:"settings"}),e.jsx("span",{className:Pe.label,children:t})]}),onItemsSelect:n=>{r({disabledColumns:c(n)})},options:s,disabledOptions:s.filter(({canBeHidden:n})=>!n),selectedItems:c(o),inline:a})},G=(s,t={})=>{const a=D(),{data:o,isLoading:r}=q({queryKey:["savedSearches",s],queryFn:async()=>a.get("GetSavedSearches",{params:s}),...t});return{savedSearches:o?.data??[],isLoadingSavedSearches:r}},Ne=()=>{const s=D(),t=W(),{mutateAsync:a,isPending:o}=U({mutationKey:["savedSearches","remove"],mutationFn:async r=>s.get("RemoveSavedSearch",{params:r}),onSuccess:async()=>t.invalidateQueries({queryKey:["savedSearches"]})});return{removeSavedSearch:a,isRemovingSavedSearch:o}},Be=({savedSearch:s,onSavedSearchRemove:t})=>{const{removeSavedSearch:a,isRemovingSavedSearch:o}=Ne(),{notify:r}=V(),c=J(),n=async i=>{try{await a({name:i}),t&&t(),r.success({message:`Saved search ${i} successfully removed`,title:"Saved search removed"})}catch(l){c(l)}};return e.jsx(d.ConfirmationButton,{className:"has-icon u-no-margin--bottom u-no-padding--bottom u-no-padding--top",type:"button",appearance:"base","aria-label":`Remove ${s.title} saved search`,confirmationModalProps:{title:"Remove saved search",children:e.jsxs("p",{children:['This will remove the saved search "',s.title,'".']}),confirmButtonLabel:"Remove",confirmButtonAppearance:"negative",confirmButtonDisabled:o,confirmButtonLoading:o,onConfirm:()=>n(s.name)},children:e.jsx(d.Icon,{name:d.ICONS.delete})})},Te="_actions_1yd1y_1",Ee={actions:Te},M=({savedSearch:s,onSavedSearchRemove:t,onBackButtonPress:a})=>e.jsxs("div",{className:Ee.actions,children:[e.jsx(re,{savedSearch:s,onBackButtonPress:a}),e.jsx(Be,{savedSearch:s,onSavedSearchRemove:t})]}),Re=s=>t=>{const a={};return t.column.id==="search"&&t.row.index===s&&(a.className="expandedCell"),a},Fe=s=>t=>{const a={};return t.index===s&&(a.className="expandedRow"),a},ze=({savedSearches:s})=>{const{setSidePanelContent:t}=F(),{expandedRowIndex:a,getTableRowsRef:o,handleExpand:r}=fe(),c=p.useCallback(()=>{t("Manage saved searches",e.jsx(p.Suspense,{fallback:e.jsx(_,{}),children:e.jsx(O,{})}),z)},[t]),n=p.useMemo(()=>[{accessor:"title",Header:"Title"},{accessor:"search",Header:"Search Query",Cell:({row:{original:i,index:l}})=>e.jsx(ge,{content:i.search,isExpanded:l===a,onExpand:()=>{r(l)}})},{...xe,Cell:({row:i})=>e.jsx(M,{savedSearch:i.original,onBackButtonPress:c})}],[a,r,c]);return e.jsx("div",{ref:o,children:e.jsx(d.ModularTable,{columns:n,data:s,emptyMsg:"No saved searches found.",getCellProps:Re(a),getRowProps:Fe(a)})})},O=()=>{const[s,t]=p.useState(1),[a,o]=p.useState(X),{savedSearches:r,isLoadingSavedSearches:c}=G(),{setSidePanelContent:n}=F(),i=p.useMemo(()=>{const l=(s-1)*a,u=l+a;return r.slice(l,u)},[r,s,a]);return c?e.jsx(_,{}):e.jsxs("div",{children:[e.jsx(k,{onBackButtonPress:()=>{n("Manage saved searches",e.jsx(p.Suspense,{fallback:e.jsx(_,{}),children:e.jsx(O,{})}),z)}}),e.jsx(ze,{savedSearches:i}),e.jsx(me,{currentPage:s,totalItems:r.length,pageSize:a,paginate:l=>{t(l)},setPageSize:l=>{o(l)}})]})},Oe="_container_fh6zz_1",Le="_header_fh6zz_6",$e="_list_fh6zz_12",qe="_listItem_fh6zz_17",ke="_actions_fh6zz_25",Ae="_search_fh6zz_33",De="_row_fh6zz_45",Ge="_truncated_fh6zz_53",g={container:Oe,header:Le,list:$e,listItem:qe,actions:ke,search:Ae,row:De,truncated:Ge},Me=({onSavedSearchClick:s,savedSearches:t,onManageSearches:a,onSavedSearchRemove:o})=>{const{setSidePanelContent:r}=F();if(!t.length)return null;const c=()=>{a(),r("Manage saved searches",e.jsx(p.Suspense,{fallback:e.jsx(_,{}),children:e.jsx(O,{})}),z)};return e.jsxs("div",{className:g.container,children:[e.jsxs("div",{className:g.header,children:[e.jsx("p",{className:"p-text--small-caps u-text--muted p-text--small",children:"Saved searches"}),e.jsx(d.Button,{type:"button",appearance:"secondary",className:"is-small",onClick:c,children:"Manage"})]}),e.jsx("ul",{className:w("p-list--divided u-no-margin--bottom",g.list),children:t.map(n=>e.jsx("li",{children:e.jsxs("div",{className:g.listItem,children:[e.jsx(d.Button,{type:"button",appearance:"base",className:g.search,onClick:()=>{s(n)},children:e.jsxs(d.Row,{className:g.row,children:[e.jsx(d.Col,{size:4,children:e.jsx(d.Tooltip,{message:n.title,positionElementClassName:g.truncated,children:e.jsx("span",{children:n.title})})}),e.jsx(d.Col,{size:8,children:e.jsx(d.Tooltip,{message:n.search,positionElementClassName:g.truncated,children:e.jsx("span",{children:n.search})})})]})}),e.jsx("div",{className:g.actions,children:e.jsx(M,{savedSearch:n,onSavedSearchRemove:o})})]})},n.name))})]})},Ze="_infoContainer_qggov_1",He="_helpButtonContainer_qggov_9",Ke="_helpButton_qggov_9",B={infoContainer:Ze,helpButtonContainer:He,helpButton:Ke},Qe=({onHelpButtonClick:s})=>e.jsx("div",{className:B.infoContainer,children:e.jsx("div",{className:B.helpButtonContainer,children:e.jsx(d.Button,{type:"button",appearance:"base",hasIcon:!0,"aria-label":"Search help",className:B.helpButton,onClick:t=>{t.stopPropagation(),s()},children:e.jsx(d.Icon,{name:d.ICONS.help})})})}),We="_container_fqj7b_1",Ue="_prompt_fqj7b_10",Ve="_saveButton_fqj7b_17",T={container:We,prompt:Ue,saveButton:Ve},Je=({onSearchSave:s,search:t})=>e.jsx(e.Fragment,{children:t&&e.jsxs("div",{className:T.container,children:[e.jsxs("span",{className:T.prompt,children:[e.jsx("span",{children:"Search for "}),e.jsx("span",{className:"p-search-and-filter__search-query",children:t}),e.jsx("span",{children:"..."})]}),e.jsx(k,{buttonLabel:"Save search",appearance:"link",className:T.saveButton,afterCreate:s,search:t})]})}),Xe="_searchContainer_pk8ic_1",Ye="_form_pk8ic_8",es="_searchBoxContainer_pk8ic_13",ss="_input_pk8ic_17",P={searchContainer:Xe,form:Ye,searchBoxContainer:es,input:ss},$=({inputText:s,savedSearches:t,search:a})=>{if(!t)return[];let o=t;if(a){const r=a.split(",").filter(Boolean);o=o.filter(({name:c})=>r.every(n=>n!==`search:${c}`))}if(s){const r=s.trim().toLowerCase();o=o.filter(({name:c,search:n})=>c.toLowerCase().includes(r)||n.toLowerCase().includes(r))}return o},ts=({onHelpButtonClick:s})=>{const{query:t,setPageParams:a}=f(),[o,r]=p.useState(""),[c,n]=p.useState(!1),{savedSearches:i,isLoadingSavedSearches:l}=G(),u=p.useRef(null),v=p.useRef(null);Y(u,h=>{const x=document.querySelector(".p-modal");x&&x.contains(h.target)||n(!1)});const b=p.useMemo(()=>$({inputText:o,savedSearches:i,search:t}),[i,o,t]),j=()=>{if(!o)return;const x=$({inputText:"",savedSearches:i,search:t}).some(({name:Z})=>Z.toLowerCase()===o.trim().toLowerCase())?"search:":"";a({query:t?`${t},${x}${o}`:`${x}${o}`}),r("")},I=h=>{a({query:t?`${t},search:${h.name}`:`search:${h.name}`})},m=h=>{const{key:x}=h;c?(x==="Escape"&&n(!1),x==="Enter"&&j()):x==="Enter"&&n(!0)};return e.jsxs("div",{className:"p-search-and-filter",ref:u,children:[e.jsxs("div",{className:w("p-search-and-filter__search-container",P.searchContainer),"aria-expanded":c,ref:v,onClick:()=>{n(!0)},children:[e.jsx(d.Form,{onSubmit:h=>{h.preventDefault(),j()},className:w("p-search-and-filter__box",P.form),children:e.jsx("div",{className:P.searchBoxContainer,children:e.jsx(d.SearchBox,{externallyControlled:!0,shouldRefocusAfterReset:!0,autocomplete:"off",className:P.input,value:o,onChange:h=>{r(h)},onClear:()=>{r("")},onSearch:j,onClick:()=>{n(!0)},onKeyUp:m})})}),e.jsx(Qe,{onHelpButtonClick:s})]}),c&&l&&e.jsx(_,{}),c&&!l&&e.jsxs("div",{className:"p-search-and-filter__panel",children:[e.jsx(Je,{onSearchSave:()=>{r("")},search:o.trim()}),e.jsx(Me,{onSavedSearchClick:I,onManageSearches:()=>{n(!1)},onSavedSearchRemove:()=>{n(!0)},savedSearches:b})]})]})},as=({options:s,label:t,inline:a=!1})=>{const{accessGroups:o,setPageParams:r}=f();return y("accessGroups",s.map(c=>c.value)),e.jsx(C,{type:"multiple",label:t,hasToggleIcon:!0,hasBadge:!0,options:s,onItemsSelect:c=>{r({accessGroups:c})},selectedItems:o,inline:a})},ns=({options:s,label:t,inline:a=!1})=>{const[o,r]=p.useState(""),{availabilityZones:c,setPageParams:n}=f(),i=s.length>9&&o?s.filter(({value:u})=>u!=="none"&&u.includes(o)):s;y("availabilityZones",i.map(u=>u.value));const l=u=>{u[u.length-1]==="none"?n({availabilityZones:["none"]}):n({availabilityZones:u[0]!=="none"?u:u.filter(v=>v!=="none")})};return e.jsx(C,{type:"multiple",label:t,hasToggleIcon:!0,hasBadge:!0,onSearch:s.length>9?u=>{r(u)}:void 0,options:i,onItemsSelect:l,selectedItems:c,inline:a})},os=({options:s,label:t,inline:a=!1})=>e.jsx(A,{pageParamKey:"contractExpiryDays",label:t,options:s,inline:a}),rs=({options:s,label:t,inline:a=!1})=>{const{os:o,setPageParams:r}=f();return y("os",s.map(c=>c.value)),e.jsx(C,{type:"single",hasBadge:!0,label:t,hasToggleIcon:!0,options:s,onItemSelect:c=>{r({os:c})},selectedItem:o,inline:a})},cs=({options:s,label:t,inline:a=!1})=>{const[o,r]=p.useState(""),{tags:c,setPageParams:n}=f(),i=s.filter(({value:l})=>l.includes(o));return y("tags",i.map(l=>l.value)),e.jsx(C,{type:"multiple",label:t,hasToggleIcon:!0,hasBadge:!0,options:i,onItemsSelect:l=>{n({tags:l})},onSearch:l=>{r(l)},selectedItems:c,inline:a})},is=({label:s,options:t,inline:a=!1})=>{const{wsl:o,setPageParams:r}=f();return y("wsl",["parent","child"]),e.jsx(C,{type:"multiple",label:s,hasToggleIcon:!0,hasBadge:!0,options:t,onItemsSelect:c=>{r({wsl:c})},selectedItems:o,inline:a})},ls="_top_1jvbb_1",us="_searchContainer_1jvbb_12",ds="_divider_1jvbb_21",E={top:ls,searchContainer:us,divider:ds},ps=({columnFilterOptions:s})=>{const t=je(),[a,o]=p.useState(!1),{getAccessGroupQuery:r}=ve(),{tags:c}=Se(),n=c.map(m=>({label:m,value:m}))??[],{availabilityZones:i}=_e(),l=i.reduce((m,h)=>(m.push({label:h,value:h}),m),[{label:"Without zones",value:"none",group:"1"}]),{data:u}=r(),v=u?.data.map(({name:m,title:h})=>({value:m,label:h}))??[],N=S.status.options,b=S.os.options,j=S.wsl.options,I=S.contractExpiryDays.options;return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:E.top,children:[e.jsx("div",{className:E.searchContainer,children:e.jsx(ts,{onHelpButtonClick:()=>{o(!0)}})}),e.jsx(be,{isCollapsed:!0,filters:[e.jsx(A,{pageParamKey:"status",label:"Status",options:N},"status"),e.jsx(rs,{label:"OS",options:b},"os"),e.jsx(ns,{label:"Availability zones",options:l},"availability-zone"),e.jsx(as,{label:"Access groups",options:v},"access-group"),e.jsx(cs,{label:"Tags",options:n},"tag"),e.jsx(is,{label:"WSL",options:j},"wsl"),e.jsx(os,{label:"Contract expiry",options:I},"contract-expiry"),e.jsx("span",{className:E.divider},"divider-2"),e.jsx(we,{label:"Columns",options:s},"column")]})]}),e.jsx(pe,{filtersToDisplay:["accessGroups","os","availabilityZones","status","tags","query","wsl","contractExpiryDays"],accessGroupOptions:v,availabilityZonesOptions:l,osOptions:b,statusOptions:N,tagOptions:n,wslOptions:j,contractExpiryOptions:I}),e.jsx(he,{open:a,data:t,onClose:()=>{o(!1)}}),e.jsx(ce,{})]})},hs=p.memo(function({instanceCount:t,instances:a,isGettingInstances:o,selectedInstances:r,setSelectedInstances:c}){const[n,i]=p.useState([]),l=p.useCallback(()=>{c([])},[]);return e.jsxs(e.Fragment,{children:[e.jsx(ps,{columnFilterOptions:n}),o?e.jsx(_,{}):e.jsx(ie,{instances:a,selectedInstances:r,setColumnFilterOptions:i,setSelectedInstances:c}),e.jsx(de,{totalItems:t,handleClearSelection:l,currentItemCount:a.length})]})}),R=(s,t)=>s.type==="select"?s.options.find(a=>a.value===t)?.query??"":"",ms=({accessGroups:s,availabilityZones:t,contractExpiryDays:a,os:o,query:r,status:c,tags:n})=>{const i=[];return o&&i.push(R(S.os,o)),c&&i.push(R(S.status,c)),a&&i.push(R(S.contractExpiryDays,a)),r&&i.push(...r.split(",")),n.length&&i.push(`tag:${n.join(" OR tag:")}`),s.length&&i.push(`access-group:${s.join(" OR access-group:")}`),t.length&&i.push(t.includes("none")?"availability-zone:null":`availability-zone:${t.join(" OR availability-zone:")}`),i.join(" ")},Ms=()=>{const{currentPage:s,pageSize:t,wsl:a,...o}=f(),{instances:r,instancesCount:c,isGettingInstances:n,isErrorInstances:i}=ne({query:ms(o),archived_only:o.status==="archived",with_alerts:!0,with_upgrades:ee,limit:t,offset:(s-1)*t,wsl_children:a.includes("child"),wsl_parents:a.includes("parent")}),{selectedItems:l,setSelectedItems:u}=ue(r,n||i);return e.jsxs(se,{children:[e.jsx(te,{title:"Instances",actions:[e.jsx(le,{isGettingInstances:n,selectedInstances:l},"actions")],sticky:!0}),e.jsx(ae,{children:e.jsx(hs,{instanceCount:c,instances:r,isGettingInstances:n,selectedInstances:l,setSelectedInstances:u})})]})};export{Ms as default};
