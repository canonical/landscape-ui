import{c as v,r as x,j as e,n as P,m as p,L as K,N,v as k,D as H,d as w,T as B,e as Z,f as W,g as L,h as Y,y as M,z as Q,A as J,C as X,G as ee,ap as se,o as G,al as te,ah as ne,aH as ae,aI as re,ai as ie}from"./index-2fzpjuii.js";import{P as oe,a as ce,b as le}from"./PageMain-B0lz2oOC.js";import{h as de,a as A,c as q,g as E,b as D,d as he,e as ue}from"./helpers-oW3ktBhe.js";import{G as pe}from"./GroupFilter-xG-bW-Xn.js";import{u as U}from"./useInstances-DeMDoX3c.js";import{u as me}from"./useRoles-Dwt5A3Uj.js";import{F as I,P as xe,I as ge}from"./InstancesPageActions-O3tu5ZlC.js";import"./helpers-arjbKCLn.js";const je=({instances:s,selectedInstances:t,setColumnFilterOptions:i,setSelectedInstances:n})=>{const{disabledColumns:o,groupBy:c,...r}=v(),d=Object.values(r).some(a=>{if(typeof a=="string")return a.length>0;if(Array.isArray(a))return a.length>0}),u=()=>{n(t.length!==0?[]:s)},l=x.useMemo(()=>c==="parent"?s.map(a=>({...a,subRows:a.children.map(h=>({...h,parent:a,children:[]}))})):s,[s,c]),g=x.useMemo(()=>[{accessor:"title",canBeHidden:!1,optionLabel:"Instance name",Header:e.jsxs(e.Fragment,{children:[e.jsx(p.CheckboxInput,{label:e.jsx("span",{className:"u-off-screen",children:"Toggle all instances"}),inline:!0,onChange:u,disabled:s.length===0,checked:t.length===s.length&&s.length!==0,indeterminate:t.length!==0&&t.length<s.length}),e.jsx("span",{id:"column-1-label",children:"Name"})]}),Cell:({row:a})=>e.jsxs("div",{className:P(q.rowHeader,{[q.nested]:a.depth>0}),children:[e.jsx(p.CheckboxInput,{label:e.jsx("span",{className:"u-off-screen",children:a.original.title}),labelClassName:"u-no-margin--bottom u-no-padding--top",checked:A({groupBy:c,instance:a.original,selectedInstances:t})==="checked",indeterminate:A({groupBy:c,instance:a.original,selectedInstances:t})==="indeterminate",onChange:()=>{de({groupBy:c,instance:a.original,selectedInstances:t,setSelectedInstances:n})}}),e.jsx(K,{to:a.original.parent?`/instances/${a.original.parent.id}/${a.original.id}`:`/instances/${a.original.id}`,children:a.original.title})]})},{accessor:"status",canBeHidden:!0,optionLabel:"Status",Header:"Status",Cell:({row:{original:a}})=>{const{label:h}=E(a);return h},getCellIcon:({row:{original:a}})=>{const{icon:h}=E(a);return h}},{accessor:"upgrades",canBeHidden:!0,optionLabel:"Upgrades",Header:"Upgrades",Cell:({row:{original:a}})=>{const{label:h}=D(a);return h},getCellIcon:({row:{original:a}})=>{const{icon:h}=D(a);return h}},{accessor:"os",canBeHidden:!0,optionLabel:"OS",Header:"OS",Cell:({row:{original:a}})=>{var h;return e.jsx(e.Fragment,{children:((h=a.distribution_info)==null?void 0:h.description)??e.jsx(N,{})})}},{accessor:"availability_zone",canBeHidden:!0,optionLabel:"Availability zone",Header:"Availability zone",Cell:({row:{original:a}})=>{var h;return e.jsx(e.Fragment,{children:((h=a.cloud_init)==null?void 0:h.availability_zone)??e.jsx(N,{})})}},{accessor:"ubuntu_pro",canBeHidden:!0,optionLabel:"Ubuntu pro",Header:"Ubuntu pro",Cell:({row:a})=>e.jsx(e.Fragment,{children:a.original.ubuntu_pro_info&&k(a.original.ubuntu_pro_info.expires).isValid()?`Exp. ${k(a.original.ubuntu_pro_info.expires).format(H)}`:e.jsx(N,{})})},{accessor:"last_ping",canBeHidden:!0,optionLabel:"Last ping",Header:"Last ping time",Cell:({row:a})=>e.jsx(e.Fragment,{children:k(a.original.last_ping_time).isValid()?k(a.original.last_ping_time).format(H):e.jsx(N,{})})}],[t.length,s,c]);x.useEffect(()=>{i(he(g))},[]);const m=x.useMemo(()=>g.filter(({accessor:a})=>typeof a=="string"&&!o.includes(a)),[o.length,g]);return e.jsx(p.ModularTable,{emptyMsg:d?"No instances found according to your search parameters.":"No instances found",columns:m,data:l,getHeaderProps:ue})},fe="_label_1i8qt_1",Se={label:fe},ve=({options:s})=>{const{disabledColumns:t,setPageParams:i}=v(),n=o=>s.filter(({value:c})=>!o.includes(c)).map(({value:c})=>c);return w("disabledColumns",s.filter(o=>o.canBeHidden).map(o=>o.value)),e.jsx(B,{multiple:!0,showSelectedItemCount:!0,label:e.jsxs(e.Fragment,{children:[e.jsx(p.Icon,{name:"settings"}),e.jsx("span",{className:Se.label,children:"Columns"})]}),onItemsSelect:o=>i({disabledColumns:n(o)}),options:s,disabledOptions:s.filter(({canBeHidden:o})=>!o),selectedItems:n(t)})},T=()=>{const s=Z(),t=W(),i=(r={},d={})=>Y({queryKey:["savedSearches",r],queryFn:async()=>s.get("GetSavedSearches",{params:r}),...d}),n=L({mutationFn:async r=>s.get("CreateSavedSearch",{params:r}),onSuccess:async()=>t.invalidateQueries({queryKey:["savedSearches"]})}),o=L({mutationFn:async r=>s.get("EditSavedSearch",{params:r}),onSuccess:async()=>t.invalidateQueries({queryKey:["savedSearches"]})}),c=L({mutationFn:async r=>s.get("RemoveSavedSearch",{params:r}),onSuccess:async()=>t.invalidateQueries({queryKey:["savedSearches"]})});return{getSavedSearchesQuery:i,createSavedSearchQuery:n,editSavedSearchQuery:o,removeSavedSearchQuery:c}},ye="_container_5hvuq_1",be="_list_5hvuq_6",_e="_listItem_5hvuq_11",Ce="_search_5hvuq_17",Ie="_row_5hvuq_25",we="_truncated_5hvuq_33",y={container:ye,list:be,listItem:_e,search:Ce,row:Ie,truncated:we},Be=({onSavedSearchClick:s,onSavedSearchRemove:t,savedSearches:i})=>{if(!i.length)return null;const n=M(),{notify:o}=Q(),{removeSavedSearchQuery:c}=T(),{mutateAsync:r,isPending:d}=c,u=async l=>{try{await r({name:l}),t(),o.success({message:`Saved search ${l} successfully removed`,title:"Saved search removed"})}catch(g){n(g)}};return e.jsxs("div",{className:y.container,children:[e.jsx("p",{className:"p-text--small-caps u-text--muted p-text--small",children:"Saved searches"}),e.jsx("ul",{className:P("p-list--divided u-no-margin--bottom",y.list),children:i.map(l=>e.jsx("li",{children:e.jsxs("div",{className:y.listItem,children:[e.jsx(p.Button,{type:"button",appearance:"base",className:y.search,onClick:()=>s(l),children:e.jsxs(p.Row,{className:y.row,children:[e.jsx(p.Col,{size:4,children:e.jsx(p.Tooltip,{message:l.name,positionElementClassName:y.truncated,children:e.jsx("span",{children:l.name})})}),e.jsx(p.Col,{size:8,children:e.jsx(p.Tooltip,{message:l.search,positionElementClassName:y.truncated,children:e.jsx("span",{children:l.search})})})]})}),e.jsx(p.ConfirmationButton,{className:"has-icon u-no-margin--bottom u-no-padding--bottom u-no-padding--top",type:"button",appearance:"base",confirmationModalProps:{title:"Remove saved search",children:e.jsxs("p",{children:['This will remove the saved search "',l.name,'".']}),confirmButtonLabel:"Remove",confirmButtonAppearance:"negative",confirmButtonDisabled:d,confirmButtonLoading:d,onConfirm:()=>u(l.name)},children:e.jsx(p.Icon,{name:"delete"})})]})},l.name))})]})},Ne="_infoContainer_zti77_1",ke="_helpButtonContainer_zti77_9",Fe="_helpButton_zti77_9",O={infoContainer:Ne,helpButtonContainer:ke,helpButton:Fe},Pe=({onHelpButtonClick:s})=>e.jsx("div",{className:O.infoContainer,children:e.jsx("div",{className:O.helpButtonContainer,children:e.jsx(p.Button,{type:"button",appearance:"base",hasIcon:!0,className:O.helpButton,onClick:t=>{t.stopPropagation(),s()},children:e.jsx(p.Icon,{name:p.ICONS.help})})})}),Le=({onClose:s,onSearchSave:t,search:i})=>{const n=M(),{notify:o}=Q(),{createSavedSearchQuery:c}=T(),{mutateAsync:r}=c,u=J({initialValues:{name:""},onSubmit:async({name:l})=>{try{await r({search:i,name:l,title:l}),o.success({message:`Saved search ${l} successfully added`,title:"Saved search added"}),t(),s()}catch(g){n(g)}},validationSchema:X({name:ee().required("This field is required").test({message:"Name must consist of only lowercase alphanumeric characters and hyphens",test:l=>/^[a-z0-9][-a-z0-9]*$/.test(l)})})});return e.jsxs(p.Form,{onSubmit:u.handleSubmit,noValidate:!0,children:[e.jsx(p.Input,{type:"text",autoComplete:"off",autoFocus:!0,label:"Search name",...u.getFieldProps("name"),error:u.touched.name&&u.errors.name?u.errors.name:void 0}),e.jsxs("div",{className:"form-buttons",children:[e.jsx(p.Button,{type:"button",disabled:u.isSubmitting,onClick:s,children:"Cancel"}),e.jsx(p.Button,{type:"submit",disabled:u.isSubmitting,appearance:"positive","aria-label":`Saved search as ${u.values.name}`,children:"Save search"})]})]})},Oe="_container_fqj7b_1",$e="_prompt_fqj7b_10",Te="_saveButton_fqj7b_17",$={container:Oe,prompt:$e,saveButton:Te},He=({onSearchSave:s,search:t})=>{const[i,n]=x.useState(!1);return e.jsxs(e.Fragment,{children:[t&&i&&e.jsx(Le,{onClose:()=>n(!1),onSearchSave:s,search:t}),t&&!i&&e.jsxs("div",{className:$.container,children:[e.jsxs("span",{className:$.prompt,children:[e.jsx("span",{children:"Search for "}),e.jsx("span",{className:"p-search-and-filter__search-query",children:t}),e.jsx("span",{children:"..."})]}),e.jsx(p.Button,{type:"button",appearance:"link",onClick:()=>n(!0),className:$.saveButton,children:"Save search"})]})]})},Ae="_searchContainer_t00ki_1",qe="_form_t00ki_8",Ee="_searchBoxContainer_t00ki_13",De="_input_t00ki_17",F={searchContainer:Ae,form:qe,searchBoxContainer:Ee,input:De},z=({inputText:s,savedSearches:t,search:i})=>{if(!t)return[];let n=t;if(i){const o=i.split(",").filter(Boolean);n=n.filter(({name:c})=>o.every(r=>r!==`search:${c}`))}return s&&(n=n.filter(({name:o,search:c})=>o.toLowerCase()!==s.trim().toLowerCase()&&c.toLowerCase()!==s.trim().toLowerCase())),n},ze=({onHelpButtonClick:s})=>{const{query:t,setPageParams:i}=v(),[n,o]=x.useState(""),[c,r]=x.useState(!1),{getSavedSearchesQuery:d}=T(),u=x.useRef(null),l=x.useRef(null);se(u,j=>{const S=document.querySelector(".p-modal");S&&S.contains(j.target)||r(!1)});const{data:m,isLoading:a}=d(),h=x.useMemo(()=>z({inputText:n,savedSearches:m==null?void 0:m.data,search:t}),[m,n,t]),b=()=>{if(!n)return;const S=z({inputText:"",savedSearches:m==null?void 0:m.data,search:t}).some(({name:V})=>V.toLowerCase()===n.trim().toLowerCase())?"search:":"";i({query:t?`${t},${S}${n}`:`${S}${n}`}),o("")},f=j=>{i({query:t?`${t},search:${j.name}`:`search:${j.name}`})},_=j=>{const{key:S}=j;c?(S==="Escape"&&r(!1),S==="Enter"&&b()):S==="Enter"&&r(!0)};return e.jsxs("div",{className:"p-search-and-filter",ref:u,children:[e.jsxs("div",{className:P("p-search-and-filter__search-container",F.searchContainer),"aria-expanded":c,ref:l,onClick:()=>r(!0),children:[e.jsx(p.Form,{onSubmit:j=>{j.preventDefault(),b()},className:P("p-search-and-filter__box",F.form),children:e.jsx("div",{className:F.searchBoxContainer,children:e.jsx(p.SearchBox,{externallyControlled:!0,shouldRefocusAfterReset:!0,autocomplete:"off",className:F.input,value:n,onChange:j=>o(j),onClear:()=>o(""),onSearch:b,onClick:()=>r(!0),onKeyUp:_})})}),e.jsx(Pe,{onHelpButtonClick:s})]}),c&&a&&e.jsx(G,{}),c&&!a&&e.jsxs("div",{className:"p-search-and-filter__panel",children:[e.jsx(He,{onSearchSave:()=>o(""),search:n.trim()}),e.jsx(Be,{onSavedSearchClick:f,onSavedSearchRemove:()=>r(!0),savedSearches:h})]})]})},Re=({options:s})=>{const{accessGroups:t,setPageParams:i}=v();return w("accessGroups",s.map(n=>n.value)),e.jsx(B,{multiple:!0,label:"Access group",hasToggleIcon:!0,hasBadge:!0,options:s,onItemsSelect:n=>i({accessGroups:n}),selectedItems:t})},Me=({options:s})=>{const[t,i]=x.useState(""),{availabilityZones:n,setPageParams:o}=v(),c=s.length>9&&t?s.filter(({value:d})=>d!=="none"&&d.includes(t)):s;w("availabilityZones",c.map(d=>d.value));const r=d=>{d[d.length-1]==="none"?o({availabilityZones:["none"]}):o({availabilityZones:d[0]!=="none"?d:d.filter(u=>u!=="none")})};return e.jsx(B,{multiple:!0,label:"Availability zone",hasToggleIcon:!0,hasBadge:!0,onSearch:s.length>9?d=>i(d):void 0,options:c,onItemsSelect:r,selectedItems:n})},Qe=({options:s})=>{const{os:t,setPageParams:i}=v();return w("os",s.map(n=>n.value)),e.jsx(B,{multiple:!1,hasBadge:!0,label:"OS",hasToggleIcon:!0,options:s,onItemSelect:n=>i({os:n}),selectedItem:t})},Ge=({options:s})=>{const[t,i]=x.useState(""),{tags:n,setPageParams:o}=v(),c=s.filter(({value:r})=>r.includes(t));return w("tags",c.map(r=>r.value)),e.jsx(B,{multiple:!0,label:"Tag",hasToggleIcon:!0,hasBadge:!0,options:c,onItemsSelect:r=>o({tags:r}),onSearch:r=>i(r),selectedItems:n})},Ue=[{term:"<keyword>",description:e.jsxs("span",{children:["Instances with the title or hostname ",e.jsx("code",{children:"<keyword>"})]})},{term:"distribution:<keyword>",description:e.jsxs("span",{children:["Instances with the installed distribution named"," ",e.jsx("code",{children:"<keyword>"})]})},{term:"needs:reboot",description:"Instances needing a reboot"},{term:"alert:<type>",description:e.jsxs(e.Fragment,{children:[e.jsxs("span",{children:["Instances with outstanding alerts of the specified"," ",e.jsx("code",{children:"<type>"})]}),e.jsx("br",{}),e.jsxs("span",{children:[e.jsx("code",{children:"<type>"})," can be ",e.jsx("code",{children:"package-upgrades"}),","," ",e.jsx("code",{children:"security-upgrades"}),",",e.jsx("code",{children:"package-profiles"}),","," ",e.jsx("code",{children:"package-reporter"}),", ",e.jsx("code",{children:"esm-disabled"}),","," ",e.jsx("code",{children:"computer-offline"}),",",e.jsx("code",{children:"computer-reboot"}),","," ",e.jsx("code",{children:"computer-duplicates"}),", ",e.jsx("code",{children:"unapproved-activities"}),"."]})]})},{term:"ip:<address>",description:e.jsxs(e.Fragment,{children:[e.jsxs("span",{children:["Instances with IP addresses like ",e.jsx("code",{children:"<address>"})]}),e.jsx("br",{}),e.jsxs("span",{children:[e.jsx("code",{children:"<address>"})," can be a fragment or partial IP address representing a subnet such as 91.185.94 to match any instances in the subnet."]})]})},{term:"mac:<address>",description:e.jsxs("span",{children:["Instances with the MAC address ",e.jsx("code",{children:"<address>"})]})},{term:"id:<instance_id>",description:e.jsxs("span",{children:["Instance with the id ",e.jsx("code",{children:"<instance_id>"})]})},{term:"access-group:<name>",description:e.jsxs("span",{children:["Instances associated with the ",e.jsx("code",{children:"<name>"})," access group"]})},{term:"search:<name>",description:e.jsxs("span",{children:["Instances meeting the terms of the ",e.jsx("code",{children:"<name>"})," saved search"]})},{term:"upgrade-profile:<name>",description:e.jsxs("span",{children:["Instances associated with the ",e.jsx("code",{children:"<name>"})," upgrade profile"]})},{term:"removal-profile:<name>",description:e.jsxs("span",{children:["Instances associated with the ",e.jsx("code",{children:"<name>"})," removal profile"]})},{term:"tag:<keyword>",description:e.jsxs("span",{children:["Instances associated with the ",e.jsx("code",{children:"<keyword>"})," tag"]})},{term:"hostname:<keyword>",description:e.jsxs("span",{children:["Instance with the hostname ",e.jsx("code",{children:"<keyword>"})]})},{term:"title:<keyword>",description:e.jsxs("span",{children:["Instance with the title ",e.jsx("code",{children:"<keyword>"})]})},{term:"license-id:<license_id>",description:e.jsxs("span",{children:["Search for instances licensed to the specified"," ",e.jsx("code",{children:"<license_id>"})]})},{term:"needs:license OR license-id:none",description:"Search for instances that do not have a Landscape license, and, as a result, are not managed"},{term:"annotation:<key>",description:e.jsxs("span",{children:["Search for instances which define the specified annotation key. Optionally specify ",e.jsx("code",{children:"annotation:<key>:<string>"})," ","which will only return instances whose key matches and value also contains the ",e.jsx("code",{children:"<string>"})," specified"]})},{term:"security-profiles:<security-profile-id>:<pass|fail|in-progress>",description:e.jsxs("span",{children:["Search for the security profiles with a specified id. Optionally specify"," ",e.jsx("code",{children:"security-profiles:<security-profiles-id>:<pass|fail|in-progress>"})," ","which will only return security profiles whose id matches, and value also contains ",e.jsx("code",{children:"pass"}),", ",e.jsx("code",{children:"fail"}),","," ",e.jsx("code",{children:"in-progress"})," as specified"]})}],Ve="_top_unlra_1",Ke="_searchContainer_unlra_13",Ze="_filters_unlra_17",We="_divider_unlra_22",C={top:Ve,searchContainer:Ke,filters:Ze,divider:We},Ye=({columnFilterOptions:s})=>{const[t,i]=x.useState(!1),{getAccessGroupQuery:n}=me(),{getAllInstanceTagsQuery:o,getAvailabilityZonesQuery:c}=U(),{data:r}=o(),d=(r==null?void 0:r.data.results.map(f=>({label:f,value:f})))??[],{data:u}=c(),l=((u==null?void 0:u.data.values)??[]).reduce((f,_)=>(f.push({label:_,value:_}),f),[{label:"Without zones",value:"none",group:"1"}]),{data:g}=n(),m=(g==null?void 0:g.data.map(({name:f,title:_})=>({value:f,label:_})))??[],a=I.groupBy.options,h=I.status.options,b=I.os.options;return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:C.top,children:[e.jsx("div",{className:C.searchContainer,children:e.jsx(ze,{onHelpButtonClick:()=>{i(!0)}})}),e.jsxs("div",{className:C.filters,children:[e.jsx(pe,{options:a}),e.jsx("span",{className:C.divider}),e.jsx(te,{options:h}),e.jsx(Qe,{options:b}),e.jsx(Me,{options:l}),e.jsx(Re,{options:m}),e.jsx(Ge,{options:d}),e.jsx("span",{className:C.divider}),e.jsx(ve,{options:s})]})]}),e.jsx(ne,{filtersToDisplay:["accessGroups","os","availabilityZones","status","tags","query"],accessGroupOptions:m,availabilityZonesOptions:l,osOptions:b,statusOptions:h,tagOptions:d}),e.jsx(ae,{open:t,data:Ue,onClose:()=>{i(!1)}}),e.jsx(xe,{})]})},R=(s,t)=>{var i;return s.type==="select"?((i=s.options.find(n=>n.value===t))==null?void 0:i.query)??"":""},Je=({accessGroups:s,availabilityZones:t,os:i,query:n,status:o,tags:c})=>{const r=[];return i&&r.push(R(I.os,i)),o&&r.push(R(I.status,o)),n&&r.push(...n.split(",")),c.length&&r.push(`tag:${c.join(" OR tag:")}`),s.length&&r.push(`access-group:${s.join(" OR access-group:")}`),t.length&&r.push(t.includes("none")?"availability-zone:null":`availability-zone:${t.join(" OR availability-zone:")}`),r.join(" ")},Xe=({selectedInstances:s,setSelectedInstances:t})=>{const[i,n]=x.useState([]),{currentPage:o,pageSize:c,groupBy:r,...d}=v(),{getInstancesQuery:u}=U(),{data:l,isLoading:g}=u({query:Je(d),root_only:r==="parent",archived_only:d.status==="archived",with_alerts:!0,with_upgrades:re,limit:c,offset:(o-1)*c}),m=(l==null?void 0:l.data.results)??[],a=()=>{t([])};return e.jsxs(e.Fragment,{children:[e.jsx(Ye,{columnFilterOptions:i}),g?e.jsx(G,{}):e.jsx(je,{instances:m,selectedInstances:s,setColumnFilterOptions:h=>{n(h)},setSelectedInstances:h=>{t(h)}}),e.jsx(ie,{totalItems:l==null?void 0:l.data.count,handleClearSelection:a,currentItemCount:m.length})]})},es="_header_116wp_1",ss={header:es},ds=()=>{const[s,t]=x.useState([]);return e.jsxs(oe,{children:[e.jsx(ce,{title:"Instances",className:ss.header,actions:[e.jsx(ge,{selected:s},"actions")]}),e.jsx(le,{children:e.jsx(Xe,{selectedInstances:s,setSelectedInstances:i=>{t(i)}})})]})};export{ds as default};
