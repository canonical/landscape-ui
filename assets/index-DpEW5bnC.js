import{m as $,e as v,f as D,l as B,j as e,g as i,r as j,L as P,R as A}from"./index-Cgvo6fQq.js";import{u as L}from"./useConfirm-CH1qaKO5.js";import{u as w}from"./useWsl-C2fV9s_m.js";import{u as M}from"./formik.esm-zcnRqfub.js";import{c as R,a as T,g as q}from"./index.esm-CZHDkGlX.js";import{S as E}from"./SidePanelFormButtons-BVcav9Rr.js";import"./moment-Cl4UOzQZ.js";import"./InfoItem.module-BZ3tYMsb.js";import{useActivities as U}from"./index-ITcH_2C3.js";import{F as W}from"./FileInput-L2w8Ps6S.js";import"./useFetchOld-CDdL40Ij.js";import"./useMutation-BlYl6rGT.js";import"./useQuery-BkysfzoD.js";import"./SidePanelFormButtons.module-DyBJG5lm.js";import"./InfoItem-DRfdno9l.js";import"./useInstances-BsLFQd9L.js";import"./moment-Ca7bd7oO.js";import"./TablePagination.module-DLVph1Z1.js";import"./TablePagination-BHogtBAM.js";import"./usePageParams-C_58JMDS.js";import"./EmptyState-BsWnPxd1.js";import"./SearchHelpPopup-D-YR3LvB.js";const p={instanceType:{slug:"instanceType",label:"Instance type",type:"select",options:[{label:"Custom",value:"custom"}]},cloudInit:{slug:"cloudInit",label:"Cloud-init",type:"file"},instanceName:{slug:"instanceName",label:"Instance name",type:"text"},rootfs:{slug:"rootfs",label:"Rootfs URL",type:"text"}},Q=[/^ubuntu$/,/^ubuntu-preview$/,/^ubuntu-[0-9]{2}\.[0-9]{2}$/],V=1,H=l=>{if(l)return new Promise((a,d)=>{const o=new FileReader;o.readAsDataURL(l),o.onload=()=>a(o.result),o.onerror=u=>d(u)})},O=()=>{const{instanceId:l}=$(),a=v(),{closeSidePanel:d}=D(),{notify:o}=B(),{createChildInstanceQuery:u,getWslInstanceNamesQuery:h}=w(),{openActivityDetails:f}=U(),{data:m,isLoading:b}=h(),{mutateAsync:y}=u,s=M({initialValues:{instanceType:"Ubuntu",cloudInit:null,instanceName:"",rootfs:""},validationSchema:R({instanceType:T().required("This field is required"),cloudInit:q().nullable().test("file-size","File size must be less than 1MB",n=>n?n.size===void 0?!1:n.size<=V*1024*1024:!0).test("file-type","File type must be YAML",n=>n?n.type==="application/x-yaml"||n.type==="application/yaml":!0),instanceName:T().when("instanceType",{is:"custom",then:n=>n.required("This field is required").test("not-match-reserved-patterns","Instance name cannot match 'ubuntu', 'ubuntu-preview', or 'ubuntu-<dd>.<dd>'",c=>!Q.some(I=>I.test(c.toLowerCase())))}),rootfs:T().url().when("instanceType",{is:"custom",then:n=>n.required("This field is required")})}),onSubmit:async n=>{try{const c=await H(n.cloudInit),I=c?c.split(",")[1]:void 0,{data:_}=await y({parent_id:parseInt(l??""),computer_name:n.instanceType==="custom"?n.instanceName:n.instanceType,rootfs_url:n.instanceType==="custom"?n.rootfs:void 0,cloud_init:I});d(),o.success({message:"You queued a new WSL instance to be installed",actions:[{label:"View details",onClick:()=>f(_)}]})}catch(c){a(c)}}}),g=(m==null?void 0:m.data.map(({label:n,name:c})=>({label:n,value:c})))||[],x=async n=>{await s.setFieldValue("cloudInit",n[0])},C=async()=>{await s.setFieldValue("cloudInit",null)};return e.jsxs(i.Form,{onSubmit:s.handleSubmit,noValidate:!0,children:[e.jsx(i.Select,{label:p.instanceType.label,required:!0,disabled:b,options:[...g,...p.instanceType.options],...s.getFieldProps("instanceType"),error:s.touched.instanceType&&s.errors.instanceType?s.errors.instanceType:void 0}),s.values.instanceType==="custom"&&e.jsxs(e.Fragment,{children:[e.jsx(i.Input,{label:p.instanceName.label,type:p.instanceName.type,required:!0,...s.getFieldProps("instanceName"),error:s.touched.instanceName&&s.errors.instanceName?s.errors.instanceName:void 0}),e.jsx(i.Input,{label:p.rootfs.label,type:p.rootfs.type,required:!0,...s.getFieldProps("rootfs"),error:s.touched.rootfs&&s.errors.rootfs?s.errors.rootfs:void 0})]}),e.jsx(W,{label:p.cloudInit.label,accept:".yaml",...s.getFieldProps("cloudInit"),onFileRemove:C,onFileUpload:x,help:"You can use a cloud-init configuration YAML file under 1MB to register new WSL instances. Cloud-init streamlines the setup by automating installation and configuration tasks.",error:s.touched.cloudInit&&s.errors.cloudInit?s.errors.cloudInit:void 0}),e.jsx(E,{submitButtonDisabled:s.isSubmitting,submitButtonText:"Install",submitButtonAriaLabel:"Install new WSL instance"})]})},Y="_container_13w3p_1",z="_searchContainer_13w3p_6",X="_cta_13w3p_10",N={container:Y,searchContainer:z,cta:X},Z=({resetQuery:l,selectedInstances:a,setQuery:d})=>{const[o,u]=j.useState(""),h=v(),{setSidePanelContent:f}=D(),{confirmModal:m,closeConfirmModal:b}=L(),{deleteChildInstancesQuery:y}=w(),{mutateAsync:s}=y,g=async()=>{try{await s({computer_ids:a.map(({id:n})=>n)})}catch(n){h(n)}finally{b()}},x=()=>{m({title:`Delete ${a.length===1?a[0].title:"selected instances"}`,body:`This will remove selected WSL ${a.length===1?"instance":"instances"} from the host and Landscape`,buttons:[e.jsx(i.Button,{appearance:"negative",onClick:g,children:"Uninstall"},"uninstall")]})},C=n=>{n.preventDefault(),d(o)};return e.jsxs("div",{className:N.container,children:[e.jsx("div",{className:N.searchContainer,children:e.jsx(i.Form,{onSubmit:C,noValidate:!0,children:e.jsx(i.SearchBox,{onChange:n=>u(n),value:o,onSearch:()=>d(o),autocomplete:"off",onClear:()=>{l(),u("")}})})}),e.jsxs("div",{className:N.cta,children:[e.jsx(i.Button,{type:"button",onClick:()=>{f("Install new WSL instance",e.jsx(O,{}))},children:e.jsx("span",{children:"Install new instance"})}),e.jsx(i.Button,{type:"button",onClick:x,disabled:a.length===0,children:e.jsx("span",{children:"Uninstall"})})]})]})},G="_title_6t0ne_1",J="_actions_6t0ne_5",F={title:G,actions:J},K=({instance:l})=>{const[a,d]=j.useState([]),[o,u]=j.useState(""),h=v(),{confirmModal:f,closeConfirmModal:m}=L(),{setDefaultChildInstanceQuery:b,deleteChildInstancesQuery:y}=w(),s=j.useMemo(()=>o?l.children.filter(({title:t,hostname:r})=>t.toLowerCase().includes(o.toLowerCase())||r.toLowerCase().includes(o.toLowerCase())):l.children,[l,o]),{mutateAsync:g}=b,{mutateAsync:x}=y,C=async t=>{try{await g({child_id:t,parent_id:l.id})}catch(r){h(r)}finally{m()}},n=t=>{f({title:"Set default instance",body:`Are you sure you want to set ${t.title} as default instance?`,buttons:[e.jsx(i.Button,{appearance:"positive",onClick:()=>C(t.id),children:"Set default"},"set-default")]})},c=async t=>{try{await x({computer_ids:[t]})}catch(r){h(r)}finally{m()}},I=t=>{f({title:`Delete ${t.title}`,body:"This will remove the WSL instance from the host and Landscape",buttons:[e.jsx(i.Button,{appearance:"negative",onClick:()=>c(t.id),children:"Delete"},"delete")]})},_=t=>{d(r=>r.some(({id:S})=>S===t.id)?r.filter(({id:S})=>S!==t.id):[...r,t])},k=j.useMemo(()=>[{accessor:"title",Header:e.jsxs(e.Fragment,{children:[e.jsx(i.CheckboxInput,{inline:!0,label:e.jsx("span",{className:"u-off-screen",children:"Toggle all instances"}),checked:s.length>0&&a.length===s.length,indeterminate:a.length>0&&a.length<s.length,onChange:()=>{d(a.length>0?[]:s)}}),e.jsx("span",{children:"Title"})]}),Cell:({row:t})=>e.jsxs("div",{className:F.title,children:[e.jsx(i.CheckboxInput,{label:e.jsx("span",{className:"u-off-screen",children:`Toggle ${t.original.title} instance`}),labelClassName:"u-no-margin--bottom u-no-padding--top",checked:a.some(({id:r})=>r===t.original.id),onChange:()=>_(t.original)}),e.jsx(P,{to:`${A}instances/${l.id}/${t.original.id}`,children:t.original.title})]})},{accessor:"distribution",Header:"OS",Cell:({row:{original:t}})=>t.distribution?`UbuntuÂ ${t.distribution}`:"Unknown"},{accessor:"default",Header:"Default",Cell:({row:t})=>e.jsx("span",{children:t.original.title===l.default_child?"Yes":"No"})},{accessor:"actions",className:F.actions,Cell:({row:t})=>e.jsxs("div",{className:"divided-blocks",children:[e.jsx("div",{className:"divided-blocks__item",children:e.jsxs(i.Button,{small:!0,hasIcon:!0,type:"button",appearance:"base",className:"u-no-margin--bottom u-no-padding--left p-tooltip--btm-right","aria-label":`Set ${t.original.title} as default instance`,onClick:()=>n(t.original),children:[e.jsx("span",{className:"p-tooltip__message",children:"Set default instance"}),e.jsx("i",{className:"p-icon--pin u-no-margin--left"})]})}),e.jsx("div",{className:"divided-blocks__item",children:e.jsxs(i.Button,{small:!0,hasIcon:!0,type:"button",appearance:"base",className:"u-no-margin--bottom u-no-padding--left p-tooltip--btm-right","aria-label":`Delete ${t.original.title} instance`,onClick:()=>I(t.original),children:[e.jsx("span",{className:"p-tooltip__message",children:"Delete instance"}),e.jsx("i",{className:"p-icon--delete u-no-margin--left"})]})})]})}],[s,a]);return e.jsxs(e.Fragment,{children:[e.jsx(Z,{resetQuery:()=>{u("")},selectedInstances:a,setQuery:t=>{u(t)}}),e.jsx(i.ModularTable,{columns:k,data:s})]})},je=K;export{je as default};
