import{d as L,i as E,k as q,l as Y,a6 as X,y as M,N as G,z as O,aq as Z,B as b,q as B,m as C,s as U,t as $,j as e,ac as x,e as l,v as m,a0 as A,P as w,I as p,a4 as J,aE as ee,n as F,au as te,D as se,S as ae,aF as ie,w as ne,Q as le,ax as oe,K as re,a as ce,aB as ue}from"./index-DN_YS9_3.js";import{W as de,a as pe,b as me,c as ge}from"./index-CUUuJuR1.js";import{d as It,e as Pt,f as jt,g as _t,u as St,h as Tt}from"./index-CUUuJuR1.js";import{d as D}from"./WslInstancesEmptyState-B37Gz9Hz.js";import{e as wt,u as Ct}from"./WslInstancesEmptyState-B37Gz9Hz.js";import{A as V}from"./AssociationBlock-DvXfU5Qp.js";import{C as he}from"./CodeEditor-BRWEaTqr.js";import{F as fe}from"./FileInput-D0C4h8nk.js";import{R as be}from"./RadioGroup-BfuWEXDz.js";import{S as Q}from"./SidePanelFormButtons-CeIrPige.js";import{u as H}from"./useGetWslInstanceTypes-CimG2b9J.js";import{u as R}from"./useRoles-DoFQPeH6.js";import"./index-CGto-yop.js";import{S as xe}from"./SidePanelTableFilterChips-BnEj6EUy.js";import{L as ye}from"./constants-DtLZBNBu.js";import{u as Ie}from"./useGetInstances-v-w49HK6.js";import{u as Pe}from"./useSelection-ClH7pU3D.js";import"./PageMain-DBf2pLlC.js";import"./useGetWslLimits-CEr-tnBu.js";import"./HeaderWithSearch-DzjwmQR6.js";import"./constants--49SNmXJ.js";import"./TextConfirmationModal-CyrSbwDv.js";import"./GroupFilter-7D7i2dRX.js";import"./MultiSelectField-BBnvEm8T.js";import"./useGetTags-DarKgUFs.js";import"./SidePanelFormButtons.module-CcPyiogC.js";const je=()=>{const t=L(),a=E(),{isPending:s,mutateAsync:o}=q({mutationFn:async u=>t.post("child-instance-profiles",u),onSuccess:async()=>a.invalidateQueries({queryKey:["wslProfiles"]})});return{isAddingWslProfile:s,addWslProfile:o}},_e=()=>{const t=L(),a=E(),{isPending:s,mutateAsync:o}=q({mutationFn:async({name:u,...h})=>t.patch(`child-instance-profiles/${u}`,h),onSuccess:async()=>a.invalidateQueries({queryKey:["wslProfiles"]})});return{editWslProfile:o,isEditingWslProfile:s}},Se=({profile_name:t},a={})=>{const s=L(),{data:o,isPending:u,error:h}=Y({queryKey:["wslProfile",t],queryFn:async({signal:y})=>s.get(`child-instance-profiles/${t}`,{signal:y}),...a});return{wslProfile:o?.data,wslProfileError:h,isGettingWslProfile:u}},Te=1,z=[{label:"Select",value:""},{label:"From a file",value:"file"},{label:"Plain text",value:"text"}],Fe="You can use a cloud-init configuration YAML file under 1MB to register new WSL instances. cloud-init streamlines the setup by automating installation and configuration tasks.",we=[/^ubuntu$/,/^ubuntu-preview$/,/^ubuntu-[0-9]{2}\.[0-9]{2}$/],Ce={title:"",access_group:X,description:"",instanceType:"",customImageName:"",rootfsImage:"",cloudInitType:"",cloudInit:null,all_computers:!1,tags:[],only_landscape_created:!1},K=t=>{const a=new Blob([t],{type:"application/x-yaml"});return new File([a],"myFile.yaml",{type:"application/x-yaml"})},ve=()=>M().shape({title:b().required("This field is required"),access_group:b().required("This field is required"),description:b().required("This field is required"),instanceType:b().required("This field is required"),rootfsImage:b().when("instanceType",{is:"custom",then:t=>t.required("This field is required"),otherwise:t=>t.notRequired()}),customImageName:b().when("instanceType",{is:"custom",then:t=>t.required("This field is required").test("not-match-reserved-patterns","Instance name cannot match 'ubuntu', 'ubuntu-preview', or 'ubuntu-<dd>.<dd>'",a=>!we.some(s=>s.test(a.toLowerCase()))),otherwise:t=>t.notRequired()}),cloudInitType:b(),cloudInit:Z().nullable().when("cloudInitType",{is:t=>t==="file"||t==="text",then:t=>t.required("This field is required").test("file-size","File size must be less than 1MB",a=>(typeof a=="string"&&(a=K(a)),a?a.size===void 0?!1:a.size<=Te*1024*1024:!0)),otherwise:t=>t.notRequired()}),all_computers:O(),tags:G().of(b())}),We=t=>{if(t)return new Promise((a,s)=>{const o=new FileReader;o.readAsDataURL(t),o.onload=()=>{a(o.result)},o.onerror=u=>{s(u)}})},Le=async t=>{if(t===null)return;let a;typeof t=="string"?a=K(t):a=t;const s=await We(a);return s?s.split(",")[1]:void 0},Ae="_block_tz139_1",Re={block:Ae},gt=()=>{const t=B(),{setPageParams:a}=C(),{notify:s}=U(),{getAccessGroupQuery:o}=R(),{addWslProfile:u}=je(),{data:h}=o(),{isGettingWslInstanceTypes:y,wslInstanceTypes:I}=H(),P=I.map(({label:n,name:d})=>({label:n,value:d}))||[],j=[{label:"Select",value:""},...P,{label:"From URL",value:"custom"}],g=h?.data.map(({name:n,title:d})=>({label:d,value:n}))??[],_=()=>{a({sidePath:[]})},i=$({initialValues:Ce,onSubmit:async n=>{try{const d=await Le(n.cloudInit),c=(await u({title:n.title,access_group:n.access_group,description:n.description,image_name:n.instanceType==="custom"?n.customImageName:n.instanceType,image_source:n.rootfsImage,cloud_init_contents:d,all_computers:n.all_computers,only_landscape_created:n.only_landscape_created,tags:n.tags})).data.computers.constrained.length;_(),s.success({title:`Profile "${n.title}" added successfully`,message:`It has been associated with ${c} instances`})}catch(d){t(d)}},validationSchema:ve()}),T=async n=>{await i.setFieldValue("cloudInit",n[0])},r=async()=>{await i.setFieldValue("cloudInit",null)};return e.jsxs(e.Fragment,{children:[e.jsx(x.Header,{children:"Add WSL profile"}),e.jsx(x.Content,{children:e.jsxs(l.Form,{onSubmit:i.handleSubmit,noValidate:!0,children:[e.jsx(l.Input,{type:"text",label:"Title",required:!0,...i.getFieldProps("title"),error:m(i,"title")}),e.jsx(l.Input,{type:"text",label:"Description",required:!0,...i.getFieldProps("description"),error:m(i,"description")}),e.jsx(l.Select,{label:"Access group","aria-label":"Access group",required:!0,options:g,...i.getFieldProps("access_group"),error:m(i,"access_group")}),e.jsxs("div",{className:Re.block,children:[(i.values.instanceType!==""||i.values.cloudInitType!=="")&&e.jsx(l.Notification,{severity:"caution",title:"Warning",children:e.jsx("span",{children:"Once the profile is added, you cannot modify the rootfs image or cloud-init file."})}),e.jsx(l.Select,{label:"rootfs image",disabled:y,"aria-label":"rootfs image",options:j,required:!0,...i.getFieldProps("instanceType"),error:m(i,"instanceType")}),i.values.instanceType==="custom"&&e.jsxs(e.Fragment,{children:[e.jsx(l.Input,{label:"Image name",type:"text",required:!0,...i.getFieldProps("customImageName"),error:m(i,"customImageName")}),e.jsx(l.Input,{type:"text",label:"rootfs image URL",required:!0,...i.getFieldProps("rootfsImage"),error:m(i,"rootfsImage"),help:"The file path must be reachable by the affected WSL instances."})]}),e.jsx(l.Select,{label:"cloud-init","aria-label":"cloud-init",options:z,...i.getFieldProps("cloudInitType"),onChange:async n=>{i.getFieldProps("cloudInitType").onChange(n),await i.setFieldValue("cloudInit",null)},error:m(i,"cloudInitType")}),i.values.cloudInitType==="file"&&e.jsx(fe,{label:"Upload cloud-init",labelClassName:"u-off-screen",accept:".yaml",...i.getFieldProps("cloudInit"),value:i.values.cloudInit instanceof File?i.values.cloudInit:null,onFileRemove:r,onFileUpload:T,help:Fe,error:m(i,"cloudInit")}),i.values.cloudInitType==="text"&&e.jsx(he,{label:"cloud-init configuration",onChange:n=>{i.setFieldValue("cloudInit",n??"")},value:typeof i.values.cloudInit=="string"?i.values.cloudInit:"",language:"yaml",defaultValue:"# paste cloud-init config here",error:m(i,"cloudInit")})]}),e.jsx(be,{label:"Compliance settings",formik:i,field:"only_landscape_created",inputs:[{key:"ignore",value:!1,label:"Ignore WSL child instances that have not been created by Landscape"},{key:"uninstall",value:!0,label:"Uninstall WSL child instances that have not been created by Landscape"}]}),e.jsx(V,{formik:i}),e.jsx(Q,{submitButtonText:"Add WSL profile",submitButtonAriaLabel:"Add a new WSL profile",submitButtonDisabled:i.isSubmitting,onCancel:_})]})})]})},N=()=>{const{profile:t}=C(),{wslProfile:a,isGettingWslProfile:s,wslProfileError:o}=Se({profile_name:t});if(o)throw o;return s?{wslProfile:void 0,isGettingWslProfile:!0}:{wslProfile:a,isGettingWslProfile:!1}},ht=()=>{const{pushSidePath:t}=C(),{getAccessGroupQuery:a}=R(),{wslProfile:s,isGettingWslProfile:o}=N(),{data:u,isPending:h}=a(),{value:y,setTrue:I,setFalse:P}=A();if(o||h)return e.jsx(x.LoadingState,{});const j=()=>{t("edit")};return e.jsxs(e.Fragment,{children:[e.jsx(x.Header,{children:s.title}),e.jsxs(x.Content,{children:[e.jsx("div",{className:"p-segmented-control",children:e.jsxs("div",{className:"p-segmented-control__list",children:[e.jsxs(l.Button,{type:"button",hasIcon:!0,className:"p-segmented-control__button",onClick:j,children:[e.jsx(l.Icon,{name:"edit"}),e.jsx("span",{children:"Edit"})]}),e.jsxs(l.Button,{type:"button",hasIcon:!0,className:"p-segmented-control__button","aria-label":`Remove ${s.title} profile`,onClick:I,children:[e.jsx(l.Icon,{name:l.ICONS.delete}),e.jsx("span",{children:"Remove"})]})]})}),e.jsxs(w,{children:[e.jsx(w.Item,{children:e.jsxs(p,{children:[e.jsx(p.Item,{label:"Title",value:s.title}),e.jsx(p.Item,{label:"Name",value:s.name}),e.jsx(p.Item,{label:"Access group",value:u?.data.find(g=>g.name===s.access_group)?.title??s.access_group}),e.jsx(p.Item,{label:"Description",large:!0,value:s.description})]})}),e.jsx(w.Item,{children:e.jsxs(p,{children:[e.jsx(p.Item,{label:"rootfs image name",large:!0,value:s.image_name}),s.image_source!==null&&e.jsx(p.Item,{label:"rootfs image source",large:!0,value:s.image_source,type:"truncated"}),e.jsx(p.Item,{label:"cloud-init",large:!0,value:s.cloud_init_contents||null}),e.jsx(p.Item,{label:"Compliance settings",large:!0,value:s.only_landscape_created?"Uninstall WSL child instances that have not been created by Landscape":"Ignore WSL child instances that have not been created by Landscape"})]})}),e.jsxs(w.Item,{title:"Association",children:[s.all_computers&&e.jsx("p",{children:"This profile has been associated with all instances."}),!s.all_computers&&!s.tags.length&&e.jsx("p",{children:"This profile has not yet been associated with any instances."}),(s.all_computers||!!s.tags.length)&&e.jsxs(p,{children:[!s.all_computers&&e.jsx(p.Item,{label:"Tags",large:!0,value:s.tags.join(", ")||null,type:"truncated"}),e.jsx(p.Item,{label:"Associated parents",large:!0,value:e.jsx(de,{wslProfile:s})}),e.jsx(p.Item,{label:"Not compliant",value:e.jsx(pe,{wslProfile:s,onClick:()=>{t("noncompliant")}})}),e.jsx(p.Item,{label:"Compliant",value:e.jsx(me,{wslProfile:s})})]})]})]})]}),e.jsx(ge,{isOpen:y,close:P,wslProfile:s})]})},Ne=()=>M().shape({title:b().required("This field is required"),description:b().required("This field is required"),access_group:b().required("This field is required"),all_computers:O(),tags:G().of(b())}),ke="_block_tz139_1",Ee={block:ke},qe=({profile:t})=>{const{getAccessGroupQuery:a}=R(),s=B(),{sidePath:o,popSidePath:u,setPageParams:h}=C(),{notify:y}=U(),{editWslProfile:I}=_e(),{wslInstanceTypes:P}=H(),j=P.map(({label:n,name:d})=>({label:n,value:d}))||[],g=[{label:"Select",value:""},...j,{label:"From URL",value:"custom"}],{data:_}=a(),f=_?.data.map(({name:n,title:d})=>({label:d,value:n}))??[],i=()=>{h({sidePath:[],profile:""})},T=async n=>{try{await I({name:t.name,title:n.title,access_group:n.access_group,description:n.description,all_computers:n.all_computers,tags:n.tags}),i(),y.success({title:"WSL profile updated",message:`WSL profile "${t.title}" updated successfully`})}catch(d){s(d)}},r=$({initialValues:{title:t.title,access_group:t.access_group,description:t.description,instanceType:t.image_source?"custom":t.image_name,customImageName:t.image_source?t.image_name:"",rootfsImage:t.image_source||"",all_computers:t.all_computers,tags:t.tags},onSubmit:T,validationSchema:Ne()});return e.jsxs(l.Form,{onSubmit:r.handleSubmit,noValidate:!0,children:[e.jsx(l.Notification,{severity:"caution",title:"Editing unavailable",children:e.jsx("span",{children:"You cannot edit rootfs image, cloud-init file, or compliance settings. To modify these fields, create a new profile."})}),e.jsx(l.Input,{type:"text",label:"Title",required:!0,...r.getFieldProps("title"),error:m(r,"title")}),e.jsx(l.Input,{type:"text",label:"Description",required:!0,...r.getFieldProps("description"),error:m(r,"description")}),e.jsx(l.Select,{label:"Access group","aria-label":"Access group",options:f,required:!0,...r.getFieldProps("access_group"),error:m(r,"access_group")}),e.jsxs("div",{className:Ee.block,children:[e.jsx(l.Select,{disabled:!0,label:"rootfs image","aria-label":"rootfs image",options:g,...r.getFieldProps("instanceType"),error:m(r,"instanceType")}),r.values.instanceType==="custom"&&e.jsxs(e.Fragment,{children:[e.jsx(l.Input,{disabled:!0,label:"Image name",type:"text",required:!0,...r.getFieldProps("customImageName"),error:m(r,"customImageName")}),e.jsx(l.Input,{disabled:!0,type:"text",label:"rootfs image URL",required:!0,...r.getFieldProps("rootfsImage"),error:m(r,"rootfsImage"),help:"The file path must be reachable by the affected WSL instances."})]}),e.jsx(l.Select,{label:"cloud-init","aria-label":"cloud-init",options:z,disabled:!0}),e.jsx(l.Select,{label:"Compliance settings",options:[{label:"Ignore WSL child instances that have not been created by Landscape",value:"ignore"},{label:"Uninstall WSL child instances that have not been created by Landscape",value:"uninstall"}],disabled:!0,value:t.only_landscape_created?"uninstall":"ignore"})]}),e.jsx(V,{formik:r}),e.jsx(Q,{submitButtonText:"Save changes",submitButtonDisabled:r.isSubmitting,onCancel:i,hasBackButton:o.length>1,onBackButtonPress:u})]})},ft=()=>{const{wslProfile:t,isGettingWslProfile:a}=N();return a?e.jsx(x.LoadingState,{}):e.jsxs(e.Fragment,{children:[e.jsxs(x.Header,{children:['Edit "',t.title,'" profile']}),e.jsx(x.Content,{children:e.jsx(qe,{profile:t})})]})},Me="_header_513lp_1",Ge="_search_513lp_8",k={header:Me,search:Ge},Oe=({instance:t})=>{const{value:a,setTrue:s,setFalse:o}=A();return e.jsxs(e.Fragment,{children:[e.jsx(J,{destructiveActions:[{icon:"security-tick",label:"Make compliant",onClick:s}],toggleAriaLabel:`${t.title} actions`}),e.jsx(D,{close:o,instances:[t],isOpen:a})]})},Be=t=>({column:a,row:{index:s}})=>a.id==="profiles"&&t===s?{className:"expandedCell"}:{},Ue=t=>({index:a})=>t===a?{className:"expandedRow"}:{},$e=({wslProfile:t})=>{const{expandedRowIndex:a,getTableRowsRef:s,handleExpand:o}=ee(),[u,h]=F.useState(""),[y]=F.useState(te),[I]=F.useState(se),[P,j]=F.useState(""),{instances:g,isGettingInstances:_}=Ie({query:[P,`profile:wsl:${t.id}:noncompliant`].filter(Boolean).join(" "),limit:I,offset:(y-1)*I,with_wsl_profiles:!0}),{selectedItems:f,setSelectedItems:i}=Pe(g,_),{value:T,setTrue:r,setFalse:n}=A(),d=F.useMemo(()=>[{accessor:"title",Header:e.jsxs(e.Fragment,{children:[e.jsx(l.CheckboxInput,{label:e.jsx("span",{className:"u-off-screen",children:"Toggle all instances"}),inline:!0,disabled:!g.length,indeterminate:!!f.length&&f.length<g.length,checked:!!g.length&&f.length===g.length,onChange:({currentTarget:{checked:c}})=>{i(c?g:[])}}),"Instance name"]}),Cell:({row:{original:c}})=>e.jsxs(e.Fragment,{children:[e.jsx(l.CheckboxInput,{inline:!0,label:e.jsxs("span",{className:"u-off-screen",children:["Select ",c.title]}),checked:f.includes(c),onChange:({currentTarget:{checked:S}})=>{i(S?[...f,c]:f.filter(W=>W!==c))}}),e.jsx(ae,{to:`/instances/${c.id}`,children:c.title})]})},{Header:"OS",Cell:({row:{original:c}})=>c.distribution_info?.description},{accessor:"profiles",Header:"WSL profiles",Cell:({row:{original:c,index:S}})=>e.jsx(ie,{content:c.wsl_profiles?.map(W=>W.title).join(", "),isExpanded:S===a,onExpand:()=>{o(S)}})},{Header:"Last ping",Cell:({row:{original:c}})=>{const S=ne(c.last_ping_time);return S.isValid()?e.jsx("span",{className:"font-monospace",children:S.format(le)}):e.jsx(oe,{})}},{...ye,Cell:({row:{original:c}})=>e.jsx(Oe,{instance:c})}],[g,f,a]),v=()=>{h(""),j("")};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:k.header,children:[e.jsx(l.SearchBox,{className:re("u-no-margin--bottom",k.search),externallyControlled:!0,value:u,onChange:h,onClear:v,onSearch:j,autoComplete:"off"}),e.jsxs(l.Button,{type:"button",className:"u-no-margin",hasIcon:!0,onClick:r,disabled:!f.length,children:[e.jsx(l.Icon,{name:"security-tick"}),e.jsx("span",{children:"Make compliant"})]})]}),e.jsx(xe,{filters:[{label:"Search",item:P||void 0,clear:v}]}),_?e.jsx(ce,{}):e.jsx("div",{ref:s,children:e.jsx(ue,{columns:d,data:g,emptyMsg:"No Windows instances found according to your search parameters.",getCellProps:Be(a),getRowProps:Ue(a)})}),e.jsx(D,{close:n,instances:f,isOpen:T})]})},bt=()=>{const{wslProfile:t,isGettingWslProfile:a}=N();return a?e.jsx(x.LoadingState,{}):e.jsxs(e.Fragment,{children:[e.jsxs(x.Header,{children:["Instances not compliant with ",t.title]}),e.jsx(x.Content,{children:e.jsx($e,{wslProfile:t})})]})};export{It as WslProfileAddButton,gt as WslProfileAddSidePanel,ht as WslProfileDetailsSidePanel,ft as WslProfileEditSidePanel,bt as WslProfileNonCompliantInstancesSidePanel,Pt as WslProfilesEmptyState,jt as WslProfilesHeader,_t as WslProfilesList,je as useAddWslProfile,St as useDeleteWslProfile,_e as useEditWslProfile,Se as useGetWslProfile,Tt as useGetWslProfiles,wt as useMakeWindowsInstancesCompliant,Ct as useReapplyWslProfile};
