import{j as n,d as b,a as E,b as L,i as A,r as p,t as S,R as D,m as H,f as M}from"./index-CQs3wXys.js";import{m as j}from"./moment-DDUBUQL9.js";import{T as $}from"./TruncatedCell-BU0EwnPI.js";import{E as B}from"./ExpandableTableFooter-CeuFA5zV.js";import{u as O}from"./useConfirm-9PPCxKmU.js";import{u as F}from"./useUsns-PbelDNjT.js";import{u as V}from"./useOnClickOutside-CMkwII5b.js";const I=({additionalCta:s,columns:l,data:e,limit:t,onLimitChange:d,itemNames:c,totalCount:i,getCellProps:r,getRowProps:f,title:x})=>n.jsxs(n.Fragment,{children:[x&&n.jsx("p",{className:"p-heading--5",children:x}),n.jsx(b.ModularTable,{columns:l,data:e,className:"u-no-margin--bottom",getCellProps:r,getRowProps:f}),n.jsx(B,{additionalCta:s,itemNames:c,limit:t,onLimitChange:d,totalCount:i})]}),N=({limit:s,onLimitChange:l,usn:e,...t})=>{const d=E(),c=L(),{notify:i}=A(),{confirmModal:r,closeConfirmModal:f}=O(),{getAffectedPackagesQuery:x,removeUsnPackagesQuery:_}=F(),{mutateAsync:k}=_,h=g=>{d(`${D}instances/${g.parent?`${g.parent.id}/${g.id}`:g.id}`,{state:{tab:"activities"}}),i.clear()},u=async g=>{try{await k({usns:e,instanceId:g.id}),i.success({title:"You queued packages to be uninstalled",message:`Packages affected by "${e}" security issue will be uninstalled and are queued in Activities.`,actions:[{label:"View details",onClick:()=>h(g)}]})}catch(w){c(w)}finally{f()}},v=g=>{r({title:"Uninstall USN packages",body:`This will uninstall packages affected by "${e}" security issue from the "${g.title}" instance.`,buttons:[n.jsx(b.Button,{type:"button",appearance:"negative",onClick:()=>u(g),children:"Uninstall"},"remove")]})},C=t.isRemovable?[n.jsxs(b.Button,{type:"button",small:!0,dense:!0,hasIcon:!0,onClick:()=>v(t.instance),children:[n.jsx(b.Icon,{name:"delete",className:"u-no-margin--left"}),n.jsx("span",{children:"Uninstall packages"})]},"remove")]:void 0,{data:a,isLoading:o}=x({usn:e,computer_ids:t.isRemovable?[t.instance.id]:t.instanceIds}),y=p.useMemo(()=>(a==null?void 0:a.data.slice(0,s))||[],[a,s]),T=p.useMemo(()=>[{accessor:"name",Header:"Package"},{accessor:"current_version",Header:"Current version"},{accessor:"new_version",Header:"New version"},{accessor:"summary",Header:"Details"}],[y.length]);return o?n.jsx(S,{}):n.jsx(I,{additionalCta:C,columns:T,data:y,itemNames:{plural:"packages",singular:"package"},limit:s,onLimitChange:l,totalCount:(a==null?void 0:a.data.length)??0})},q={computers_count:0,cves:[],date:"",info:"",packages:[],usn:"loading",usn_link:""},Y={computers_count:0,cves:[],date:"",info:"",packages:[],usn:"expandedUsn",usn_link:""},G="_checkboxColumn_1yn78_1",W="_expanded_1yn78_5",X="_expandButton_1yn78_23",z="_hidden_1yn78_31",J="_innerTable_1yn78_35",K="_expandedRow_1yn78_39",Q="_expandedCell_1yn78_44",Z="_cve_1yn78_49",P="_cveLink_1yn78_53",m={checkboxColumn:G,expanded:W,expandButton:X,hidden:z,innerTable:J,expandedRow:K,expandedCell:Q,cve:Z,cveLink:P},ee=(s,l,e,t)=>{if(l==="")return e==="expandable"?s.slice(0,t):s;const d=s.findIndex(({usn:c})=>c===l)+1;return[...s.slice(0,d),Y,...s.slice(d,e==="expandable"?t:s.length)]},U=(s,l,e)=>({column:t,row:{original:{usn:d},index:c}})=>{const i={};return d===e?t.id==="release_packages"&&(i.className=m.expanded):["expandedUsn","loading"].includes(d)?t.id==="usn"?(i.colSpan=s==="expandable"?4:5,d==="expandedUsn"&&(i.className=m.innerTable)):(i.className=m.hidden,i["aria-hidden"]=!0):t.id==="usn"?i.role="rowheader":t.id==="cves"?(i["aria-label"]="CVE(s)",l===c&&(i.className=m.expandedCell)):t.id==="date"?i["aria-label"]="Date published":t.id==="release_packages"&&(i["aria-label"]="Affected packages"),i},R=s=>({index:l})=>{const e={};return s===l&&(e.className=m.expandedRow),e},ae=s=>l=>{l&&(s.current=[...l.querySelectorAll("tbody tr")])},de=({isUsnsLoading:s,usns:l,...e})=>{const[t,d]=p.useState(5),[c,i]=p.useState(""),[r,f]=p.useState(-1),[x,_]=p.useState(5),k=p.useRef([]);V({current:r!==-1?k.current[r]:null},()=>f(-1));const h=p.useMemo(()=>s?[q]:ee(l,c,e.tableType,t),[l,c,s,t,e.tableType]),u=e.tableType==="paginated"?e.selectedUsns:[],v=a=>{if(e.tableType==="expandable")return;const o=u.filter(y=>y.usn!==a.usn);e.onSelectedUsnsChange(u.length!==o.length?o:[...o,a])},C=p.useMemo(()=>[{accessor:"checkbox",className:m.checkboxColumn,Header:()=>e.tableType==="paginated"&&n.jsx(b.CheckboxInput,{inline:!0,label:n.jsx("span",{className:"u-off-screen",children:"Toggle all security issues"}),disabled:h.length===0||h[0].usn==="loading",indeterminate:u.length>0&&u.length<l.length,checked:u.length>0&&u.length===l.length,onChange:()=>e.onSelectedUsnsChange(u.length>0?[]:l)}),Cell:({row:a})=>e.tableType==="paginated"&&n.jsx(b.CheckboxInput,{labelClassName:"u-no-margin--bottom u-no-padding--top",label:n.jsx("span",{className:"u-off-screen",children:`Toggle ${a.original.usn}`}),name:"usn",checked:u.some(({usn:o})=>o===a.original.usn),onChange:()=>v(a.original)})},{accessor:"usn",Header:"USN",Cell:({row:a})=>a.original.usn==="expandedUsn"?e.tableType==="expandable"?n.jsx(N,{isRemovable:!1,instanceIds:e.instanceIds,limit:x,onLimitChange:()=>_(o=>o+5),usn:c}):n.jsx(N,{isRemovable:!0,instance:e.instance,limit:x,onLimitChange:()=>_(o=>o+5),usn:c}):a.original.usn==="loading"?n.jsx(S,{}):n.jsx("a",{href:a.original.usn_link,target:"_blank",rel:"nofollow noopener noreferrer",children:a.original.usn})},{accessor:"cves",Header:"CVE(s)",Cell:({row:{original:a,index:o}})=>n.jsx($,{content:a.cves.map(({cve:y,cve_link:T})=>n.jsx("span",{className:m.cve,children:n.jsx("a",{href:T,target:"_blank",rel:"nofollow noopener noreferrer",className:m.cveLink,children:y})},y)),isExpanded:r===o,onExpand:()=>{i(""),f(c?o-1:o)}})},{accessor:"date",Header:"Date published",Cell:({row:a})=>n.jsx(n.Fragment,{children:j(a.original.date).isValid()?j(a.original.date).format(H):"---"})},{accessor:"release_packages",Header:"Affected packages",Cell:({row:a})=>n.jsx(n.Fragment,{children:n.jsx(b.Button,{type:"button",className:M("p-accordion__tab",m.expandButton),"aria-expanded":a.original.usn===c,onClick:()=>{f(-1),i(o=>o===a.original.usn?"":a.original.usn),_(5)},children:`${a.original.usn===c?"Hide":"Show"} packages`})})}].filter(({accessor:a})=>e.tableType==="paginated"||a!=="checkbox"),[h,x,u.length,e.tableType,r]);return n.jsx("div",{ref:ae(k),children:e.tableType==="expandable"?n.jsx(I,{columns:C,data:h,getCellProps:U(e.tableType,r,c),getRowProps:R(r),itemNames:{plural:"security issues",singular:"security issue"},limit:t,onLimitChange:()=>d(a=>a+5),title:"Security issues",totalCount:l.length}):n.jsx(b.ModularTable,{columns:C,data:h,getCellProps:U(e.tableType,r,c),getRowProps:R(r),emptyMsg:`No security issues found with the search "${e.search}"`})})};export{I as E,de as U};
