import{j as e,h as N,l as z,e as V,m as q,f as D,g as l}from"./index-DY0yKsFY.js";import{u as E}from"./formik.esm-CtTAjn9c.js";import{h as G}from"./moment-C5S46NFB.js";import{S as B}from"./SidePanelFormButtons-BMN115EL.js";import{I as L}from"./InfoItem-DDG2wBCh.js";import{u as U}from"./index-CklHLT3W.js";import{a as Y,I as w}from"./useUsns-DAouukXe.js";import{m as x}from"./moment-YMnkye4G.js";import{c as O,a as j,f as Q,d as I}from"./index.esm-BFRrLlkL.js";import"./SidePanelFormButtons.module-DyBJG5lm.js";import"./TablePagination-CGyTcLL9.js";import"./TablePagination.module-DLVph1Z1.js";import"./usePageParams-DET2YUzV.js";import"./EmptyState-Cp7kPxIV.js";import"./SearchHelpPopup-CohKroHA.js";import"./useFetchOld-CZMB78f6.js";import"./useMutation-cdyoRliz.js";import"./PageMain-CBWka__a.js";import"./useConfirm-BmebmGkS.js";import"./NoData-DYJt2MpI.js";const R=({packageCount:i,securityUpgradePackageCount:r,totalUpgradePackageCount:d})=>{const n=d-r,t=i-d;return e.jsxs("div",{children:[e.jsx("span",{children:"You selected "}),e.jsx("span",{children:e.jsx("b",{children:i})}),e.jsx("span",{children:" packages. This will:"}),e.jsxs("ul",{className:N({"u-no-margin--bottom":t>0}),children:[r>0&&e.jsxs("li",{children:[e.jsx("span",{children:"apply "}),e.jsx("span",{children:e.jsx("b",{children:r})}),e.jsx("span",{children:r===1?" security upgrade":" security upgrades"})]}),n>0&&e.jsxs("li",{children:[e.jsx("span",{children:"apply "}),e.jsx("span",{children:e.jsx("b",{children:n})}),e.jsx("span",{children:n===1?" regular upgrade":" regular upgrades"})]})]}),t>0&&e.jsxs("p",{children:[e.jsx("span",{children:"No upgrades for "}),e.jsx("span",{children:e.jsx("b",{children:t})}),e.jsx("span",{children:t===1?" package needed.":" packages needed."})]})]})},K={deliver_after:"",deliver_delay_window:0,deliver_immediately:!0,randomize_delivery:!1,version:""},M=i=>O({deliver_after:j().when("deliver_immediately",{is:!1,then:r=>r.required("This field is required").test({test:d=>x(d).isValid()&&x(d).isAfter(x()),message:"You have to enter a valid date and time in the future"})}),deliver_delay_window:Q().when("randomize_delivery",{is:!0,then:r=>r.min(0,"Delivery delay must be greater than or equal to 0")}),deliver_immediately:I(),randomize_delivery:I(),version:j().test({name:"required",message:"This field is required",params:{action:i},test:r=>i!=="downgrade"||!!r})}),Z=(i,r)=>{const d=i.length>1?"selected packages":`${i[0].name} Package`;return`This will ${r==="hold"?"disable":"enable"} upgrades for the ${d}. It will ${r==="hold"?"not ":""}be eligible to upgrade to the latest available version.`},H=(i,r,d)=>{const n=r.length>1?`${r.length} packages`:`${r[0].name} Package`,t={downgrade:"downgrade",hold:"held",remove:"uninstall",unhold:"unheld",upgrade:"upgrade"},h={downgrade:`be downgraded to ${d} version`,hold:"disable its upgrades",remove:"be uninstalled",unhold:"enable its upgrades",upgrade:"be upgraded"},v=`You queued ${n} to ${i!=="remove"?"be ":""}${t[i]}.`,_=`${n} ${r.length>1?"are":"is"} queued in Activities and will ${h[i]}.`;return{title:v,message:_}},J="_bold_c3q8d_1",W="_radioGroup_c3q8d_5",X="_marginTop_c3q8d_10",m={bold:J,radioGroup:W,marginTop:X},ee=({action:i,packages:r})=>{const{instanceId:d,childInstanceId:n}=z(),t=V(),{notify:h}=q(),{openActivityDetails:v}=U(),{closeSidePanel:_}=D(),{downgradePackageVersionQuery:A,getDowngradePackageVersionsQuery:P,upgradePackagesQuery:S,packagesActionQuery:$}=Y(),c=Number(n??d),{data:y}=P({instanceId:c,packageName:r[0].name},{enabled:i==="downgrade"}),u=(y==null?void 0:y.data.results.map(({version:s})=>({label:s,value:s})))??[];u.unshift({label:"Select version",value:""});const b=r.filter(({status:s,available_version:p})=>s==="security"||s==="installed"&&p).map(({name:s})=>s),f=r.filter(({status:s})=>s==="security").length,{mutateAsync:k}=A,{mutateAsync:F}=S,{mutateAsync:T}=$,C=async s=>{const p={deliver_after:s.deliver_immediately?void 0:`${s.deliver_after}:00Z`,deliver_delay_window:s.randomize_delivery?s.deliver_delay_window:void 0};let g;i==="upgrade"?g=F({...p,packages:b,query:`id:${c}`}):i==="downgrade"?g=k({instanceId:c,package_name:r[0].name,package_version:s.version}):g=T({...p,action:i,computer_ids:[c],package_ids:r.map(({id:o})=>o)});try{const{data:o}=await g;_(),h.success({...H(i,r,s.version),actions:[{label:"Details",onClick:()=>v(o)}]})}catch(o){t(o)}},a=E({initialValues:K,validationSchema:M(i),onSubmit:C});return e.jsxs(l.Form,{onSubmit:a.handleSubmit,noValidate:!0,children:[i==="downgrade"&&e.jsxs(l.Row,{className:"u-no-padding--left u-no-padding--right",children:[e.jsx(l.Col,{size:6,children:e.jsx(L,{label:"Current version",value:r[0].current_version})}),e.jsx(l.Col,{size:6,children:u.length>1?e.jsx(l.Select,{label:"New version",className:"",labelClassName:"p-text--small u-text--muted u-no-margin--bottom p-text--small-caps",...a.getFieldProps("version"),options:u}):e.jsx("p",{children:"No downgrade versions"})})]}),i==="upgrade"&&(r.length!==b.length||f>0)&&e.jsx(R,{packageCount:r.length,securityUpgradePackageCount:f,totalUpgradePackageCount:b.length}),(i==="hold"||i==="unhold")&&e.jsx("p",{children:Z(r,i)}),["remove","upgrade","hold","unhold"].includes(i)&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:m.bold,children:"Delivery time"}),e.jsxs("div",{className:m.radioGroup,children:[e.jsx(l.Input,{type:"radio",label:"As soon as possible",name:"deliver_immediately",checked:a.values.deliver_immediately,onChange:()=>{a.setFieldValue("deliver_immediately",!0)}}),e.jsx(l.Input,{type:"radio",label:"Scheduled",name:"deliver_immediately",checked:!a.values.deliver_immediately,onChange:()=>{a.setFieldValue("deliver_immediately",!1),a.setFieldValue("deliver_after",G().utc(!0).add(1,"minute").toISOString().slice(0,16))}})]}),!a.values.deliver_immediately&&e.jsx(l.Input,{type:"datetime-local",label:"Deliver after",labelClassName:"u-off-screen",...a.getFieldProps("deliver_after"),error:a.touched.deliver_after&&a.errors.deliver_after?a.errors.deliver_after:void 0}),e.jsx("span",{className:N(m.bold,m.marginTop),children:"Randomise delivery over a time window"}),e.jsxs("div",{className:m.radioGroup,children:[e.jsx(l.Input,{type:"radio",label:"No",name:"randomize_delivery",checked:!a.values.randomize_delivery,onChange:async()=>{await a.setFieldValue("randomize_delivery",!1),await a.setFieldValue("deliver_delay_window",0)}}),e.jsx(l.Input,{type:"radio",label:"Yes",name:"randomize_delivery",checked:a.values.randomize_delivery,onChange:()=>a.setFieldValue("randomize_delivery",!0)})]}),a.values.randomize_delivery&&e.jsx(l.Input,{type:"number",inputMode:"numeric",min:0,label:"Delivery delay window",labelClassName:"u-off-screen",help:"Time in minutes",...a.getFieldProps("deliver_delay_window"),error:a.touched.deliver_delay_window&&a.errors.deliver_delay_window?a.errors.deliver_delay_window:void 0})]}),(i!=="downgrade"||u.length>1)&&e.jsx(B,{submitButtonDisabled:a.isSubmitting,submitButtonText:w[i].label,submitButtonAppearance:w[i].appearance})]})},fe=ee;export{fe as default};
