import{m as D,p as d,t as I,n as u,k as N,v as T,i as A,w as C,l as E,j as e,h as t}from"./index-yURGZBtd.js";import{I as _}from"./InfoItem-y9tkNqjm.js";import{u as F}from"./index-C1RN2Syp.js";import{h as p}from"./moment-C5S46NFB.js";import{u as R}from"./index-CHvSvWDf.js";import"./moment-BIKFofTM.js";import"./TablePagination-0_F6kes3.js";import"./TablePagination.module-CgQ3jx4B.js";import"./usePageParams-BFF1VH6Z.js";import"./SearchHelpPopup-BY_Mwczx.js";import"./useFetchOld-B9cJ707T.js";import"./NoData-B7MnZqi2.js";const B=D().shape({deliver_immediately:d(),randomize_delivery:d(),deliver_delay_window:I().min(0,"Delivery delay must be greater than or equal to 0"),deliver_after:u().test({test:l=>l?p(l).isValid():!0,message:"You have to enter a valid date and time"}),new_kernel_version_id:u().required("You have to select a kernel"),reboot_after:d()}),O="The kernel will be downgraded and the instance will restart afterwards to apply the change.",P="The kernel will be downgraded. You'll need to restart the instance to apply this change.",z="Downgrading the kernel will expose your system to known security vulnerabilities AND reduce your Livepatch coverage.",G="_radioGroup_1y5w7_1",L="_marginTop_1y5w7_6",M="_infoItem_1y5w7_11",o={radioGroup:G,marginTop:L,infoItem:M},ee=({currentKernelVersion:l,downgradeKernelVersions:n,instanceName:v})=>{const y=N(),{instanceId:h}=T(),{closeSidePanel:c}=A(),{notify:g}=C(),{downgradeKernelQuery:f}=R(),{openActivityDetails:w}=F(),{mutateAsync:b,isPending:s}=f,x=[{label:"Select",value:""},...n.map(a=>({label:a.version_rounded,value:a.id.toString()}))],j={deliver_immediately:!0,randomize_delivery:!1,deliver_delay_window:0,deliver_after:"",new_kernel_version_id:n.length===1?n[0].id.toString():"",reboot_after:!1},i=E({initialValues:j,validationSchema:B,onSubmit:async a=>{try{const{data:r}=await b({id:Number(h),kernel_package_id:Number(a.new_kernel_version_id),reboot_after:a.reboot_after});c();const S=a.reboot_after?O:P;g.success({title:`You queued kernel downgrade for instance "${v}"`,message:S,actions:[{label:"View details",onClick:()=>w(r)}]})}catch(r){y(r)}}}),m=async a=>{const r=a.currentTarget.value==="true";await i.setFieldValue("deliver_immediately",r),r||await i.setFieldValue("deliver_after",p().toISOString().slice(0,16))},k=async()=>{await i.setFieldValue("reboot_after",!0),i.handleSubmit()};return e.jsxs(t.Form,{onSubmit:i.handleSubmit,children:[e.jsx(t.Notification,{severity:"caution",title:"Security warning",children:e.jsx("span",{children:z})}),e.jsxs(t.Row,{className:"u-no-padding--left u-no-padding--right",children:[e.jsx(t.Col,{size:6,children:e.jsx(_,{label:"current version",value:l})}),e.jsx(t.Col,{size:6,children:e.jsx(_,{label:"kernel version",className:o.infoItem,value:n.length===1?e.jsx("span",{children:n[0].version_rounded}):e.jsx(t.Select,{options:x,...i.getFieldProps("new_kernel_version_id")})})})]}),e.jsx("strong",{className:o.marginTop,children:"Delivery time"}),e.jsxs("div",{className:o.radioGroup,children:[e.jsx(t.Input,{type:"radio",label:"As soon as possible",name:"deliver_immediately",value:"true",onChange:m,checked:i.values.deliver_immediately}),e.jsx(t.Input,{type:"radio",label:"Scheduled",name:"deliver_immediately",value:"false",onChange:m,checked:!i.values.deliver_immediately})]}),!i.values.deliver_immediately&&e.jsx(t.Input,{type:"datetime-local",label:"Deliver after",labelClassName:"u-off-screen",...i.getFieldProps("deliver_after"),error:i.touched.deliver_after&&i.errors.deliver_after}),e.jsx("strong",{className:o.marginTop,children:"Randomise delivery over a time window"}),e.jsxs("div",{className:o.radioGroup,children:[e.jsx(t.Input,{type:"radio",label:"No",...i.getFieldProps("randomize_delivery"),onChange:async()=>{await i.setFieldValue("randomize_delivery",!1),await i.setFieldValue("deliver_delay_window",0)},checked:!i.values.randomize_delivery}),e.jsx(t.Input,{type:"radio",label:"Yes",...i.getFieldProps("randomize_delivery"),onChange:async()=>await i.setFieldValue("randomize_delivery",!0),checked:i.values.randomize_delivery})]}),i.values.randomize_delivery&&e.jsx(t.Input,{type:"number",inputMode:"numeric",min:0,label:"Delivery delay window",labelClassName:"u-off-screen",help:"Time in minutes",...i.getFieldProps("deliver_delay_window"),error:i.touched.deliver_delay_window&&i.errors.deliver_delay_window?i.errors.deliver_delay_window:void 0}),e.jsxs("div",{className:"form-buttons",children:[e.jsx(t.Button,{type:"button",appearance:"base",onClick:c,children:"Cancel"}),e.jsx(t.ConfirmationButton,{type:"button",confirmationModalProps:{title:"Downgrading kernel and restarting instance",children:e.jsx("p",{children:"Are you sure? This action will downgrade the kernel and restart the instance."}),confirmButtonLabel:"Downgrade and Restart",confirmButtonAppearance:"negative",confirmButtonLoading:s,confirmButtonDisabled:s,onConfirm:k},children:"Downgrade and Restart"}),e.jsx(t.ConfirmationButton,{type:"button",appearance:"negative",confirmationModalProps:{title:"Downgrading kernel",children:e.jsx("p",{children:"Are you sure? This action will downgrade the kernel."}),confirmButtonLabel:"Downgrade",confirmButtonAppearance:"negative",confirmButtonLoading:s,confirmButtonDisabled:s,onConfirm:()=>i.handleSubmit()},children:"Downgrade kernel"})]})]})};export{ee as default};
