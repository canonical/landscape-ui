import{j as e,p as P,y as u,K as V,O as I,M as N,P as D,au as j,Q as q,B as E,C as G,a2 as B,m as L,F as O,d as n,I as Q,x as U}from"./index-DHd_VY7f.js";import{S as Y}from"./SidePanelFormButtons-CzXdW2Nh.js";import{a as K,I as A}from"./useUsns-CB2aGNN9.js";import"./SidePanelFormButtons.module-BuIu-Bem.js";import"./ResponsiveButtons-BgYaenLx.js";const M=({packageCount:a,securityUpgradePackageCount:s,totalUpgradePackageCount:l})=>{const d=l-s,t=a-l;return e.jsxs("div",{children:[e.jsx("span",{children:"You selected "}),e.jsx("span",{children:e.jsx("b",{children:a})}),e.jsx("span",{children:" packages. This will:"}),e.jsxs("ul",{className:P({"u-no-margin--bottom":t>0}),children:[s>0&&e.jsxs("li",{children:[e.jsx("span",{children:"apply "}),e.jsx("span",{children:e.jsx("b",{children:s})}),e.jsxs("span",{children:["security ",u(s,"upgrade")]})]}),d>0&&e.jsxs("li",{children:[e.jsx("span",{children:"apply "}),e.jsx("span",{children:e.jsx("b",{children:d})}),e.jsxs("span",{children:["regular ",u(d,"upgrade")]})]})]}),t>0&&e.jsxs("p",{children:[e.jsx("span",{children:"No upgrades for "}),e.jsx("span",{children:e.jsx("b",{children:t})}),e.jsxs("span",{children:[u(t,"package")," needed."]})]})]})},R={deliver_after:"",deliver_delay_window:0,deliver_immediately:!0,randomize_delivery:!1,version:""},Z=a=>V({deliver_after:I().when("deliver_immediately",{is:!1,then:s=>s.required("This field is required").test({test:l=>j(l).isValid()&&j(l).isAfter(j()),message:"You have to enter a valid date and time in the future"})}),deliver_delay_window:D().when("randomize_delivery",{is:!0,then:s=>s.min(0,"Delivery delay must be greater than or equal to 0")}),deliver_immediately:N(),randomize_delivery:N(),version:I().test({name:"required",message:"This field is required",params:{action:a},test:s=>a!=="downgrade"||!!s})}),H=(a,s)=>{var d;const l=u(a.length,`${((d=a[0])==null?void 0:d.name)??""} Package`,"selected packages");return`This will ${s==="hold"?"disable":"enable"} upgrades for the ${l}. It will ${s==="hold"?"not ":""}be eligible to upgrade to the latest available version.`},J=(a,s,l)=>{var m;const d=u(s.length,`${((m=s[0])==null?void 0:m.name)??""} Package`,"selected packages"),t={downgrade:"downgrade",hold:"held",remove:"uninstall",unhold:"unheld",upgrade:"upgrade"},_={downgrade:`be downgraded to ${l} version`,hold:"disable its upgrades",remove:"be uninstalled",unhold:"enable its upgrades",upgrade:"be upgraded"},y=`You queued ${d} to ${a!=="remove"?"be ":""}${t[a]}.`,b=`${d} ${s.length>1?"are":"is"} queued in Activities and will ${_[a]}.`;return{title:y,message:b}},W="_bold_1hrl2_1",X="_radioGroup_1hrl2_5",ee="_marginTop_1hrl2_10",c={bold:W,radioGroup:X,marginTop:ee},de=({action:a,packages:s})=>{const{instanceId:l,childInstanceId:d}=q(),t=E(),{notify:_}=G(),{openActivityDetails:y}=B(),{closeSidePanel:b}=L(),{downgradePackageVersionQuery:m,getDowngradePackageVersionsQuery:S,upgradePackagesQuery:k,packagesActionQuery:$}=K(),p=Number(d??l),{data:x}=S({instanceId:p,packageName:s[0].name},{enabled:a==="downgrade"}),h=(x==null?void 0:x.data.results.map(({version:r})=>({label:r,value:r})))??[];h.unshift({label:"Select version",value:""});const w=s.filter(({status:r,available_version:g})=>r==="security"||r==="installed"&&g).map(({name:r})=>r),f=s.filter(({status:r})=>r==="security").length,{mutateAsync:C}=m,{mutateAsync:F}=k,{mutateAsync:T}=$,z=async r=>{const g={deliver_after:r.deliver_immediately?void 0:`${r.deliver_after}:00Z`,deliver_delay_window:r.randomize_delivery?r.deliver_delay_window:void 0};let v;a==="upgrade"?v=F({...g,packages:w,query:`id:${p}`}):a==="downgrade"?v=C({instanceId:p,package_name:s[0].name,package_version:r.version}):v=T({...g,action:a,computer_ids:[p],package_ids:s.map(({id:o})=>o)});try{const{data:o}=await v;b(),_.success({...J(a,s,r.version),actions:[{label:"Details",onClick:()=>y(o)}]})}catch(o){t(o)}},i=O({initialValues:R,validationSchema:Z(a),onSubmit:z});return e.jsxs(n.Form,{onSubmit:i.handleSubmit,noValidate:!0,children:[a==="downgrade"&&e.jsxs(n.Row,{className:"u-no-padding--left u-no-padding--right",children:[e.jsx(n.Col,{size:6,children:e.jsx(Q,{label:"Current version",value:s[0].current_version})}),e.jsx(n.Col,{size:6,children:h.length>1?e.jsx(n.Select,{label:"New version",className:"",labelClassName:"p-text--small u-text--muted u-no-margin--bottom p-text--small-caps",...i.getFieldProps("version"),options:h}):e.jsx("p",{children:"No downgrade versions"})})]}),a==="upgrade"&&(s.length!==w.length||f>0)&&e.jsx(M,{packageCount:s.length,securityUpgradePackageCount:f,totalUpgradePackageCount:w.length}),(a==="hold"||a==="unhold")&&e.jsx("p",{children:H(s,a)}),["remove","upgrade","hold","unhold"].includes(a)&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:c.bold,children:"Delivery time"}),e.jsxs("div",{className:c.radioGroup,children:[e.jsx(n.Input,{type:"radio",label:"As soon as possible",name:"deliver_immediately",checked:i.values.deliver_immediately,onChange:()=>{i.setFieldValue("deliver_immediately",!0)}}),e.jsx(n.Input,{type:"radio",label:"Scheduled",name:"deliver_immediately",checked:!i.values.deliver_immediately,onChange:()=>{i.setFieldValue("deliver_immediately",!1),i.setFieldValue("deliver_after",U().utc(!0).add(1,"minute").toISOString().slice(0,16))}})]}),!i.values.deliver_immediately&&e.jsx(n.Input,{type:"datetime-local",label:"Deliver after",labelClassName:"u-off-screen",...i.getFieldProps("deliver_after"),error:i.touched.deliver_after&&i.errors.deliver_after?i.errors.deliver_after:void 0}),e.jsx("span",{className:P(c.bold,c.marginTop),children:"Randomise delivery over a time window"}),e.jsxs("div",{className:c.radioGroup,children:[e.jsx(n.Input,{type:"radio",label:"No",name:"randomize_delivery",checked:!i.values.randomize_delivery,onChange:async()=>{await i.setFieldValue("randomize_delivery",!1),await i.setFieldValue("deliver_delay_window",0)}}),e.jsx(n.Input,{type:"radio",label:"Yes",name:"randomize_delivery",checked:i.values.randomize_delivery,onChange:()=>i.setFieldValue("randomize_delivery",!0)})]}),i.values.randomize_delivery&&e.jsx(n.Input,{type:"number",inputMode:"numeric",min:0,label:"Delivery delay window",labelClassName:"u-off-screen",help:"Time in minutes",...i.getFieldProps("deliver_delay_window"),error:i.touched.deliver_delay_window&&i.errors.deliver_delay_window?i.errors.deliver_delay_window:void 0})]}),(a!=="downgrade"||h.length>1)&&e.jsx(Y,{submitButtonDisabled:i.isSubmitting,submitButtonText:A[a].label,submitButtonAppearance:A[a].appearance})]})};export{de as default};
