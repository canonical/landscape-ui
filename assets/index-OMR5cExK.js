import{j as e,g as w,m as C,c as V,d as A,e as r,a as le,R as K,r as j,L as re,x as H,l as ie,W as oe}from"./index-USfFY6y3.js";import"./TablePagination.module-DLVph1Z1.js";import{T as ce}from"./TablePagination-unVj4olB.js";import{a as D}from"./useUsns-BzmxRksB.js";import{I as T}from"./InfoItem-C4QiPsl7.js";import{u as de}from"./useConfirm-CBkoo4y2.js";import{u as ue}from"./formik.esm-C4aerYG-.js";import{h as G}from"./moment-Cl4UOzQZ.js";import{S as Z}from"./SidePanelFormButtons-eq1cIORy.js";import{c as me,a as Q,f as he,d as W}from"./index.esm-D9RDGm6v.js";import{u as pe,D as ge}from"./downshift.esm--5KSNz8N.js";import{u as J}from"./usePageParams-C993n8qJ.js";import"./useFetchOld-B0QImQ4i.js";import"./useMutation-DY_6kw1u.js";import"./useQuery-BXclWMSX.js";import"./SidePanelFormButtons.module-CoxOjuX8.js";const be="_bold_c3q8d_1",ve="_radioGroup_c3q8d_5",xe="_marginTop_c3q8d_10",$={bold:be,radioGroup:ve,marginTop:xe},_e={deliver_after:"",deliver_delay_window:0,deliver_immediately:!0,randomize_delivery:!1,version:""},je={remove:"Remove",upgrade:"Upgrade",downgrade:"Downgrade"},fe="_bold_nffzr_1",F={bold:fe},ye=({packageCount:a,securityUpgradePackageCount:s,totalUpgradePackageCount:n})=>{const l=n-s,t=a-n;return e.jsxs("div",{children:[e.jsx("span",{children:"You selected "}),e.jsx("span",{className:F.bold,children:a}),e.jsx("span",{children:" packages. This will:"}),e.jsxs("ul",{className:w({"u-no-margin--bottom":t>0}),children:[s>0&&e.jsxs("li",{children:[e.jsx("span",{children:"apply "}),e.jsx("span",{className:F.bold,children:s}),e.jsx("span",{children:s===1?" security upgrade":" security upgrades"})]}),l>0&&e.jsxs("li",{children:[e.jsx("span",{children:"apply "}),e.jsx("span",{className:F.bold,children:l}),e.jsx("span",{children:l===1?" regular upgrade":" regular upgrades"})]})]}),t>0&&e.jsxs("p",{children:[e.jsx("span",{children:"No upgrades for "}),e.jsx("span",{className:F.bold,children:t}),e.jsx("span",{children:t===1?" package needed.":" packages needed."})]})]})},X=({action:a,packages:s})=>{const{instanceId:n}=C(),l=V(),{closeSidePanel:t}=A(),{downgradePackageVersionQuery:u,getDowngradePackageVersionsQuery:p,removePackagesQuery:v,upgradePackagesQuery:x}=D(),b=Number(n),{data:h}=p({instanceId:b,packageName:s[0].name},{enabled:a==="downgrade"}),c=h&&h.data.results.length>0?h.data.results.map(({version:m})=>({label:m,value:m})):[];c.unshift({label:"Select version",value:""});const g=s.filter(({status:m})=>["upgrade","security"].includes(m)).map(({name:m})=>m),_=s.filter(({status:m})=>m==="security").length,{mutateAsync:f}=u,{mutateAsync:N}=v,{mutateAsync:S}=x,I=me({deliver_after:Q().test({test:m=>m?G(m).isValid():!0,message:"You have to enter a valid date and time"}),deliver_delay_window:he().min(0,"Delivery delay must be greater than or equal to 0"),deliver_immediately:W(),randomize_delivery:W(),version:Q().test({name:"required",message:"This field is required",params:{action:a},test:m=>a!=="downgrade"||!!m})}),i=ue({initialValues:_e,validationSchema:I,onSubmit:async m=>{const L={query:`id:${b}`,deliver_after:m.deliver_immediately?void 0:`${m.deliver_after}:00Z`,deliver_delay_window:m.randomize_delivery?m.deliver_delay_window:void 0};try{a==="remove"?await N({...L,packages:s.filter(y=>y.current_version).map(({name:y})=>y)}):a==="upgrade"?await S({...L,packages:g}):a==="downgrade"&&await f({instanceId:b,package_name:s[0].name,package_version:m.version}),t()}catch(y){l(y)}}});return e.jsxs(r.Form,{onSubmit:i.handleSubmit,noValidate:!0,children:[a==="downgrade"&&e.jsxs(r.Row,{className:"u-no-padding--left u-no-padding--right",children:[e.jsx(r.Col,{size:6,children:e.jsx(T,{label:"Current version",value:s[0].current_version})}),e.jsx(r.Col,{size:6,children:c.length>1?e.jsx(r.Select,{label:"New version",className:"",labelClassName:"p-text--small u-text--muted u-no-margin--bottom p-text--small-caps",...i.getFieldProps("version"),options:c}):e.jsx("p",{children:"No downgrade versions"})})]}),a==="upgrade"&&(s.length!==g.length||_>0)&&e.jsx(ye,{packageCount:s.length,securityUpgradePackageCount:_,totalUpgradePackageCount:g.length}),["remove","upgrade"].includes(a)&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:$.bold,children:"Delivery time"}),e.jsxs("div",{className:$.radioGroup,children:[e.jsx(r.Input,{type:"radio",label:"As soon as possible",name:"deliver_immediately",checked:i.values.deliver_immediately,onChange:()=>{i.setFieldValue("deliver_immediately",!0)}}),e.jsx(r.Input,{type:"radio",label:"Scheduled",name:"deliver_immediately",checked:!i.values.deliver_immediately,onChange:()=>{i.setFieldValue("deliver_immediately",!1),i.setFieldValue("deliver_after",G().toISOString().slice(0,16))}})]}),!i.values.deliver_immediately&&e.jsx(r.Input,{type:"datetime-local",label:"Deliver after",labelClassName:"u-off-screen",...i.getFieldProps("deliver_after"),error:i.touched.deliver_after&&i.errors.deliver_after?i.errors.deliver_after:void 0}),e.jsx("span",{className:w($.bold,$.marginTop),children:"Randomise delivery over a time window"}),e.jsxs("div",{className:$.radioGroup,children:[e.jsx(r.Input,{type:"radio",label:"No",name:"randomize_delivery",checked:!i.values.randomize_delivery,onChange:async()=>{await i.setFieldValue("randomize_delivery",!1),await i.setFieldValue("deliver_delay_window",0)}}),e.jsx(r.Input,{type:"radio",label:"Yes",name:"randomize_delivery",checked:i.values.randomize_delivery,onChange:()=>i.setFieldValue("randomize_delivery",!0)})]}),i.values.randomize_delivery&&e.jsx(r.Input,{type:"number",inputMode:"numeric",min:0,label:"Delivery delay window",labelClassName:"u-off-screen",help:"Time in minutes",...i.getFieldProps("deliver_delay_window"),error:i.touched.deliver_delay_window&&i.errors.deliver_delay_window?i.errors.deliver_delay_window:void 0})]}),(["remove","upgrade"].includes(a)||c.length>1)&&e.jsx(Z,{submitButtonDisabled:i.isSubmitting,submitButtonText:je[a],submitButtonAppearance:a==="remove"?"negative":"positive"})]})},Ce=({singlePackage:a})=>{const{instanceId:s}=C(),n=V(),{setSidePanelContent:l}=A(),{confirmModal:t,closeConfirmModal:u}=de(),{installPackagesQuery:p}=D(),{mutateAsync:v,isLoading:x}=p,b=g=>{l(`${{remove:"Uninstall",upgrade:"Upgrade",downgrade:"Downgrade"}[g]} ${a.name}`,e.jsx(X,{action:g,packages:[a]}))},h=async()=>{try{await v({packages:[a.name],query:`id:${s}`})}catch(g){n(g)}finally{u()}},c=()=>{t({title:"Install package",body:`Are you sure you want to install "${a.name}" package?`,buttons:[e.jsx(r.Button,{appearance:"positive",disabled:x,onClick:h,children:"Install"},"install")]})};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-segmented-control",children:[a.current_version&&e.jsxs(r.Button,{type:"button",className:"p-segmented-control__button has-icon",onClick:()=>{b("remove")},children:[e.jsx("i",{className:"p-icon--delete"}),e.jsx("span",{children:"Uninstall"})]}),a.available_version&&e.jsxs(r.Button,{type:"button",className:"p-segmented-control__button has-icon",onClick:()=>{b("upgrade")},children:[e.jsx("i",{className:"p-icon--change-version"}),e.jsx("span",{children:"Upgrade"})]}),a.current_version&&e.jsxs(r.Button,{type:"button",className:"p-segmented-control__button has-icon",onClick:()=>{b("downgrade")},children:[e.jsx("i",{className:"p-icon--begin-downloading"}),e.jsx("span",{children:"Downgrade"})]}),a.available_version&&!a.current_version&&e.jsxs(r.Button,{type:"button",className:"p-segmented-control__button has-icon",onClick:c,children:[e.jsx("i",{className:"p-icon--plus"}),e.jsx("span",{children:"Install"})]})]},"buttons"),e.jsx("div",{children:e.jsx(T,{label:"Package name",value:a.name})}),e.jsx("div",{children:e.jsx(T,{label:"Summary",value:a.summary})}),e.jsxs(r.Row,{className:"u-no-padding--left u-no-padding--right",children:[e.jsx(r.Col,{size:6,children:e.jsx(T,{label:"Current version",value:a.current_version})}),a.available_version&&e.jsx(r.Col,{size:6,children:e.jsx(T,{label:"Upgeradable to",value:a.available_version})})]})]})},Ne=({onDismiss:a})=>{const s=le(),{instanceId:n,childInstanceId:l}=C();return e.jsxs(r.Notification,{severity:"caution",onDismiss:a,children:[e.jsx("strong",{children:"Some upgrades require Ubuntu Pro: "}),e.jsxs("span",{children:["Your current Ubuntu package upgrades are limited. To unlock full upgrades, please upgrade to Ubuntu Pro."," "]}),e.jsx(r.Button,{type:"button",appearance:"link",onClick:()=>{s(`${K}instances/${l?`${n}/${l}`:n}`,{state:{tab:"ubuntu-pro"}})},children:"Learn more"})]})},Se={available_version:null,current_version:null,name:"loading",status:"available",summary:""},we="_checkbox_p36ti_1",Ie="_details_p36ti_5",ke="_tooltipLink_p36ti_9",$e="_hidden_p36ti_13",q={checkbox:we,details:Ie,tooltipLink:ke,hidden:$e},z=a=>!!a.available_version&&!!a.current_version&&a.available_version.includes("ubuntu-pro"),Y=a=>{const s={label:"Unknown",icon:""};return a.status==="available"?(s.label="Available",s.icon="status-queued-small"):a.status==="held"?(s.label="Held",s.icon="status-in-progress-small"):a.status==="security"?(s.label="Security upgrade",s.icon="status-failed-small"):a.status==="upgrade"?(s.label="Regular upgrade",s.icon="status-waiting-small"):a.status==="installed"&&(s.label="Installed",s.icon="status-succeeded-small"),s},Pe=({column:a,row:s})=>{const n={};return s.original.name==="loading"?a.id==="name"?n.colSpan=5:(n.className=q.hidden,n["aria-hidden"]=!0):a.id==="checkbox"?n["aria-label"]=`Toggle ${s.original.name} package`:a.id==="name"?n.role="rowheader":a.id==="status"?n["aria-label"]="Status":a.id==="current_version"?n["aria-label"]="Current version":a.id==="available_version"?n["aria-label"]="Available version":a.id==="summary"&&(n["aria-label"]="Details"),n},Te=({emptyMsg:a,onPackagesSelect:s,packages:n,packagesLoading:l,selectedPackages:t,selectAll:u})=>{const[p,v]=j.useState(!1),[x,b]=j.useState(!1),{instanceId:h,childInstanceId:c}=C(),{setSidePanelContent:g}=A(),_=j.useMemo(()=>l?[Se]:n,[n,l]),f=o=>{s(t.some(({name:i})=>i===o.name)?t.filter(({name:i})=>i!==o.name):[...t,o])},N=()=>{s(t.length>0?[]:n.filter(o=>!z(o)))};j.useEffect(()=>{!u||p||!n.length||(N(),v(!0))},[u,n]);const S=o=>{g("Package details",e.jsx(Ce,{singlePackage:o}))},I=j.useMemo(()=>[{accessor:"checkbox",className:q.checkbox,Header:e.jsx(r.CheckboxInput,{inline:!0,label:e.jsx("span",{className:"u-off-screen",children:"Toggle all"}),checked:t.length===n.length&&n.length>0,indeterminate:t.length<n.length&&t.length>0,disabled:n.length===0,onChange:N}),Cell:({row:o})=>z(o.original)?e.jsx(r.Tooltip,{message:e.jsxs("div",{children:[e.jsx("p",{className:"u-no-padding--top",children:"Ubuntu Pro is required"}),e.jsx(re,{to:`${K}instances/${c?`${h}/${c}`:`${h}`}`,state:{tab:"ubuntu-pro"},className:q.tooltipLink,children:"learn more"})]}),children:e.jsx(r.CheckboxInput,{inline:!0,disabled:!0,label:e.jsx("span",{className:"u-off-screen",children:`Toggle ${o.original.name}`}),checked:t.some(({name:i})=>i===o.original.name),onChange:()=>{f(o.original)}})}):e.jsx(r.CheckboxInput,{inline:!0,label:e.jsx("span",{className:"u-off-screen",children:`Toggle ${o.original.name}`}),checked:t.some(({name:i})=>i===o.original.name),onChange:()=>{f(o.original)}})},{accessor:"name",Header:"Name",Cell:({row:o})=>o.original.name==="loading"?e.jsx(H,{}):e.jsx(r.Button,{type:"button",appearance:"link",className:"u-no-margin--bottom u-no-padding--top u-align-text--left",onClick:()=>{S(o.original)},children:o.original.name})},{accessor:"status",Header:"Status",Cell:({row:{original:o}})=>Y(o).label,getCellIcon:({row:{original:o}})=>Y(o).icon},{accessor:"current_version",Header:"Current version"},{accessor:"summary",className:q.details,Header:"Details",Cell:({row:{original:o}})=>o.available_version?e.jsxs(e.Fragment,{children:[e.jsx("span",{children:o.summary}),e.jsx("br",{}),e.jsx("span",{children:`available version: ${o.available_version}`})]}):o.summary}],[n,t.length]);return e.jsxs(e.Fragment,{children:[!x&&n.some(z)&&e.jsx(Ne,{onDismiss:()=>b(!0)}),e.jsx(r.ModularTable,{columns:I,data:_,getCellProps:Pe,emptyMsg:a})]})},Ae="_container_1qwn6_1",De="_searchContainer_1qwn6_6",Le="_selectContainer_1qwn6_10",Be="_cta_1qwn6_15",U={container:Ae,searchContainer:De,selectContainer:Le,cta:Be},Fe="_container_1d6qb_1",Ue="_suggestionsContainer_1d6qb_5",qe="_pointer_1d6qb_12",Ve="_highlighted_1d6qb_17",ze="_selectedContainer_1d6qb_21",P={container:Fe,suggestionsContainer:Ue,pointer:qe,highlighted:Ve,selectedContainer:ze},Ee=200,He=(a,s)=>{const n=a.toLowerCase(),l=s.toLowerCase(),t=n.indexOf(l);return t>=0?e.jsxs(e.Fragment,{children:[a.substring(0,t),e.jsx("strong",{children:a.substring(t,t+s.length)}),a.substring(t+s.length)]}):a},Oe=({selectedItems:a,setSelectedItems:s})=>{var M;const[n,l]=j.useState(""),[t,u]=j.useState(!1),[p,v]=j.useState(""),{instanceId:x}=C(),b=V(),{getInstancePackagesQuery:h}=D(),c=Number(x),{data:g,isFetching:_}=h({instance_id:c,available:!0,installed:!1,upgrade:!1,held:!1,limit:50,search:n},{enabled:n.length>2}),f=((M=g==null?void 0:g.data)==null?void 0:M.results)??[],N=d=>!a.map(k=>k.name).includes(d.name),S=f.filter(N),I=d=>{s(a.filter(k=>k.name!==d))},o=()=>{u(!1)},i=()=>{v(""),l("")},m=()=>{p.length>2?u(!0):u(!1)},L=d=>{v(d),d.length>2&&l(d)},y=pe(()=>{try{m()}catch(d){b(d)}},Ee),ee=d=>{s([...a,d]),i()},ae=d=>{d&&(ee(d),u(!1))},ne=d=>{d.key==="Escape"?d.currentTarget.blur():y()},O=!t&&p.length<3?"Min 3. characters":f.length===0&&n&&!_?`No packages found by "${n}"`:null;return e.jsxs("div",{className:P.container,children:[e.jsx(ge,{onSelect:ae,itemToString:()=>"",isOpen:t,children:({getInputProps:d,getItemProps:k,getMenuProps:se,highlightedIndex:te})=>e.jsxs("div",{className:"p-autocomplete",children:[e.jsx(r.SearchBox,{...d(),placeholder:"Search for available packages",className:"u-no-margin--bottom",shouldRefocusAfterReset:!0,externallyControlled:!0,autocomplete:"off",value:p,onChange:L,onClear:i,onBlur:o,onFocus:m,onKeyUp:ne}),O?e.jsx("span",{className:"p-form-help-text",children:O}):null,t&&(S.length>0||_)?e.jsx("ul",{className:w("p-list p-card--highlighted u-no-padding u-no-margin--bottom p-autocomplete__suggestions",P.suggestionsContainer),...se(),children:_?e.jsx(H,{}):S.map((B,R)=>e.jsxs("li",{className:w("p-list__item",P.pointer,{[P.highlighted]:te===R}),...k({item:B,index:R}),children:[e.jsx("div",{className:"u-truncate","data-testid":"dropdownElement",children:He(B.name,n)}),e.jsx("div",{children:e.jsx("small",{className:"u-text-muted",children:B.current_version})})]},B.name))}):null]})}),e.jsx("ul",{className:"p-list p-autocomplete__result-list u-no-margin--bottom",children:a.length?a.map(d=>e.jsxs("li",{className:w("p-autocomplete__result p-list__item p-card u-no-margin--bottom",P.selectedContainer),children:[e.jsxs("div",{children:[e.jsx("div",{children:d.name}),e.jsx("span",{children:e.jsx("small",{className:"u-text--muted p-text--small",children:d.current_version})})]}),e.jsx(r.Button,{appearance:"link",className:"u-no-margin--bottom u-no-padding--top",onClick:()=>I(d.name),children:e.jsx("i",{className:"p-icon--delete"})})]},d.name)):null})]})},Me=()=>{const[a,s]=j.useState([]),{instanceId:n}=C(),l=V(),{notify:t}=ie(),{installPackagesQuery:u}=D(),{closeSidePanel:p}=A(),{mutateAsync:v,isLoading:x}=u,b=async()=>{try{await v({packages:a.map(({name:h})=>h),query:`id:${n}`}),p(),t.success({message:`You queued ${a.length===1?`package ${a[0].name}`:`${a.length} packages`} to be installed.`})}catch(h){l(h)}};return e.jsxs(e.Fragment,{children:[e.jsx(Oe,{selectedItems:a,setSelectedItems:h=>s(h)}),e.jsx(Z,{submitButtonDisabled:x||a.length===0,submitButtonText:"Install packages",submitButtonAppearance:"positive",onSubmit:b})]})},Re="_container_1nwlw_1",Ge="_noWrap_1nwlw_5",E={container:Re,noWrap:Ge},Qe=({selectedPackages:a})=>{const{setSidePanelContent:s}=A(),n=t=>{const u=a.length===1?a[0].name:`${a.length} selected packages`;s(t==="remove"?`Remove ${u}`:`Upgrade ${u}`,e.jsx(X,{action:t,packages:a}))},l=()=>{s("Install packages",e.jsx(Me,{}))};return e.jsxs("div",{className:E.container,children:[e.jsxs(r.Button,{type:"button",onClick:l,hasIcon:!0,className:E.noWrap,children:[e.jsx("i",{className:"p-icon--plus"}),e.jsx("span",{children:"Install"})]}),e.jsxs("div",{className:w("p-segmented-control is-small",E.noWrap),children:[e.jsxs(r.Button,{type:"button",className:"p-segmented-control__button has-icon",disabled:a.length===0||a.every(t=>!t.current_version),onClick:()=>n("remove"),children:[e.jsx("i",{className:"p-icon--delete"}),e.jsx("span",{children:"Uninstall"})]}),e.jsxs(r.Button,{type:"button",className:"p-segmented-control__button has-icon",disabled:a.length===0||a.every(t=>!t.available_version),onClick:()=>n("upgrade"),children:[e.jsx("i",{className:"p-icon--change-version"}),e.jsx("span",{children:"Upgrade"})]})]},"buttons")]})},We=[{label:"All",value:""},{label:"Installed",value:"installed"},{label:"Upgrades",value:"upgrade"},{label:"Security upgrades",value:"security"},{label:"Held",value:"held"}],Ye=({handleClearSelection:a,selectedPackages:s})=>{const{search:n,setPageParams:l,status:t}=J(),[u,p]=j.useState(n),v=()=>{l({search:u}),a()},x=()=>{l({search:""})},b=c=>{l({status:c})},h=c=>{c.preventDefault(),v()};return e.jsxs("div",{className:U.container,children:[e.jsx("div",{className:U.searchContainer,children:e.jsx(r.Form,{onSubmit:h,noValidate:!0,children:e.jsx(r.SearchBox,{shouldRefocusAfterReset:!0,externallyControlled:!0,autocomplete:"off",value:u,onChange:c=>p(c),onSearch:v,onClear:x})})}),e.jsx(r.Select,{label:"Status",wrapperClassName:U.selectContainer,options:We,value:t,onChange:c=>b(c.target.value)}),e.jsx("div",{className:U.cta,children:e.jsx(Qe,{selectedPackages:s})})]})},Ke=(a,s)=>{let n;return a===""?n="No packages found":a==="upgrade"?n="No available upgrades found":a==="security"?n="No available security upgrades found":a==="installed"?n="No installed packages found":n="No held packages found",s?`${n} with the search "${s}"`:n},Ze=()=>{const[a,s]=j.useState([]),{instanceId:n}=C(),{status:l,search:t,currentPage:u,pageSize:p}=J(),{getInstancePackagesQuery:v}=D(),{state:x}=oe(),b=Number(n),h=()=>{s([])},{data:c,isLoading:g}=v({instance_id:b,search:t,limit:p,offset:(u-1)*p,available:!1,installed:l==="installed"||!l||void 0,upgrade:l==="upgrade"||void 0,held:l==="held"||void 0,security:l==="security"||void 0});return e.jsxs(e.Fragment,{children:[!t&&!l&&u===1&&p===20&&g&&e.jsx(H,{}),(t||l||u!==1||p!==20||!g)&&e.jsxs(e.Fragment,{children:[e.jsx(Ye,{selectedPackages:a,handleClearSelection:h}),e.jsx(Te,{packages:(c==null?void 0:c.data.results)??[],packagesLoading:g,selectedPackages:a,onPackagesSelect:_=>{s(_)},emptyMsg:Ke(l,t),selectAll:(x==null?void 0:x.selectAll)??!1})]}),e.jsx(ce,{handleClearSelection:h,totalItems:c==null?void 0:c.data.count,currentItemCount:c==null?void 0:c.data.results.length})]})},ga=Ze;export{ga as default};
