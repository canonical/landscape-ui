import{r as b,j as a,a as D,p as B,q as E,o as T,g as y,n as v,U as H,D as M,m as C}from"./index-CYp7KpWP.js";import{u as R,m as _}from"./usePageParams-Cdul7EKX.js";import{E as j,S as $}from"./SelectAllButton-Btumr0yu.js";import{N as L}from"./NoData-B_JqPCKo.js";import{T as S}from"./TablePagination-DfImDJ_0.js";import{T as F}from"./TruncatedCell-GZzarDCI.js";import{u as P}from"./usePackages-BZ_12klQ.js";import{g as V,c as x,a as q,h as N,b as I}from"./helpers-Dmo1dFrn.js";try{let n=typeof window<"u"?window:typeof global<"u"?global:typeof globalThis<"u"?globalThis:typeof self<"u"?self:{},s=new n.Error().stack;s&&(n._sentryDebugIds=n._sentryDebugIds||{},n._sentryDebugIds[s]="bbaf790c-38e8-4542-a8bc-81b5256ad177",n._sentryDebugIdIdentifier="sentry-dbid-bbaf790c-38e8-4542-a8bc-81b5256ad177")}catch{}const O=({column:n})=>{const s={};return n.id==="title"?s.role="rowheader":n.id==="upgrades.security"&&(s["aria-label"]="Affected packages"),s},Q="_security_16o7z_1",Y={security:Q},z=({instances:n,limit:s,onLimitChange:d,usn:l,usnPackages:i})=>{const c=b.useMemo(()=>n.filter(({id:e})=>i.flatMap(({computer_ids:g})=>g).includes(e)).slice(0,s),[n,s,i]),o=b.useMemo(()=>[{accessor:"title",Header:"Name"},{accessor:"upgrades.security",className:Y.security,Header:"Affected packages",Cell:({row:{original:e}})=>i.filter(({computer_ids:g})=>g.includes(e.id)).length}],[c.length]);return a.jsx(j,{columns:o,data:c,itemNames:{plural:"instances",singular:"instance"},onLimitChange:d,totalCount:c.length,title:a.jsxs("p",{className:"p-heading--4",children:["Instances affected by ",a.jsx("b",{children:l})]}),getCellProps:O})},W=({instanceTitle:n,usn:s})=>{const d=D(),l=B(),{notify:i}=E(),{removeUsnPackagesQuery:c}=P(),{setPageParams:o}=R(),{instanceId:e,childInstanceId:g}=T(),f=Number(e),{mutateAsync:p,isPending:u}=c,h=()=>{d(`/instances/${g?`${f}/${g}`:`${f}`}`),o({tab:"activities"}),i.clear()},k=async()=>{try{await p({usns:s,instanceId:f}),i.success({title:"You queued packages to be uninstalled",message:`Packages affected by "${s}" security issue will be uninstalled and are queued in Activities.`,actions:[{label:"View details",onClick:h}]})}catch(w){l(w)}};return a.jsxs(y.ConfirmationButton,{type:"button",className:"is-small is-dense has-icon",confirmationModalProps:{title:"Uninstall USN packages",children:a.jsxs("p",{children:['This will uninstall packages affected by "',s,'" security issue from the "',n,'" instance.']}),confirmButtonLabel:"Uninstall",confirmButtonAppearance:"negative",confirmButtonDisabled:u,confirmButtonLoading:u,onConfirm:k},children:[a.jsx(y.Icon,{name:"delete",className:"u-no-margin--left"}),a.jsx("span",{children:"Uninstall packages"})]},"remove")},G=({column:n})=>{const s={};return n.id==="name"?s.role="rowheader":n.id==="current_version"?s["aria-label"]="Current version":n.id==="new_version"?s["aria-label"]="New version":n.id==="summary"&&(s["aria-label"]="Details"),s},J=({instanceTitle:n,limit:s,onLimitChange:d,showRemoveButton:l,usn:i,usnPackages:c})=>{const o=b.useMemo(()=>c.slice(0,s),[s,c]),e=b.useMemo(()=>[{accessor:"name",Header:"Package"},{accessor:"current_version",Header:"Current version"},{accessor:"new_version",Header:"New version"},{accessor:"summary",Header:"Details"}],[o.length]);return a.jsx(j,{additionalCta:l&&a.jsx(W,{instanceTitle:n,usn:i}),columns:e,data:o,itemNames:{plural:"packages",singular:"package"},onLimitChange:d,title:a.jsxs("p",{className:"p-heading--4",children:["Packages affected by ",a.jsx("b",{children:i})]}),totalCount:c.length,getCellProps:G})},K=({instances:n,isRemovable:s,listType:d,usn:l})=>{const[i,c]=b.useState(5),{getAffectedPackagesQuery:o}=P(),{instanceId:e}=T(),g=Number(e),{data:f,isLoading:p}=o({usn:l,computer_ids:s?[g]:n.map(({id:h})=>h)}),u=(f==null?void 0:f.data)??[];return a.jsxs(a.Fragment,{children:[p&&a.jsx(v,{}),!p&&d==="instances"&&a.jsx(z,{instances:n,limit:i,onLimitChange:()=>c(h=>h+5),usn:l,usnPackages:u}),!p&&d==="packages"&&a.jsx(J,{instanceTitle:n[0].title,limit:i,onLimitChange:()=>c(h=>h+5),showRemoveButton:s,usn:l,usnPackages:u})]})},ce=({instances:n,isUsnsLoading:s,onSelectedUsnsChange:d,selectedUsns:l,totalUsnCount:i,usns:c,...o})=>{const[e,g]=b.useState(null),f=b.useRef([]);H({current:(e==null?void 0:e.column)==="cves"?f.current[e.row]:null},()=>g(null));const p=o.tableType==="expandable"&&o.showSelectAllButton,u=b.useMemo(()=>V({expandedCell:e,isUsnsLoading:s,showSelectAllButton:p,usns:c}),[c,e,s,p]),h=t=>{d(l.includes(t)?l.filter(r=>r!==t):[...l,t])},k=(t,r)=>{g(m=>(m==null?void 0:m.column)===t&&m.row===r?null:{column:t,row:m&&["computers_count","release_packages"].includes(m.column)&&m.row<r?r-1:r})},w=b.useMemo(()=>[{accessor:"checkbox",className:"checkbox-column",Header:()=>a.jsx(y.CheckboxInput,{inline:!0,label:a.jsx("span",{className:"u-off-screen",children:"Toggle all security issues"}),disabled:u.length===0||s,indeterminate:l.length>0&&l.length<c.length,checked:l.length>0&&l.length===c.length,onChange:()=>d(l.length>0?[]:c.map(({usn:t})=>t))}),Cell:({row:{original:t}})=>a.jsx(y.CheckboxInput,{labelClassName:"u-no-margin--bottom u-no-padding--top",label:a.jsx("span",{className:"u-off-screen",children:`Toggle ${t.usn}`}),disabled:s,name:"usn",checked:l.includes(t.usn),onChange:()=>h(t.usn)})},{accessor:"usn",Header:"USN",Cell:({row:{index:t,original:r}})=>t===0&&p?a.jsx($,{count:o.totalSelectedUsnCount,itemName:{plural:"security issues",singular:"security issue"},onClick:o.onSelectAllClick,totalCount:i}):(e==null?void 0:e.row)===t-1&&["computers_count","release_packages"].includes(e.column)?a.jsx(K,{isRemovable:e.column==="release_packages"&&o.tableType==="paginated",instances:n,listType:e.column==="release_packages"?"packages":"instances",usn:u[e.row].usn}):s&&t===u.length-1?a.jsx(v,{}):a.jsx("a",{href:r.usn_link,target:"_blank",rel:"nofollow noopener noreferrer",children:r.usn})},{accessor:"cves",Header:"CVE(s)",Cell:({row:{original:t,index:r}})=>a.jsx(F,{content:t.cves.map(({cve:m,cve_link:A})=>a.jsx("span",{className:x.cve,children:a.jsx("a",{href:A,target:"_blank",rel:"nofollow noopener noreferrer",className:x.cveLink,children:m})},m)),isExpanded:(e==null?void 0:e.column)==="cves"&&e.row===r,onExpand:()=>k("cves",r)})},{accessor:"date",Header:"Date published",Cell:({row:t})=>a.jsx(a.Fragment,{children:_(t.original.date).isValid()?_(t.original.date).format(M):a.jsx(L,{})})},{accessor:"computers_count",Header:"Affected instances",Cell:({column:t,row:{index:r,original:m}})=>a.jsx(y.Button,{type:"button",className:C("p-accordion__tab",x.expandButton),"aria-expanded":(e==null?void 0:e.column)===t.id&&e.row===r,onClick:()=>k(t.id,r),children:m.computers_count})},{accessor:"release_packages",Header:"Affected packages",Cell:({column:t,row:{index:r}})=>a.jsx(y.Button,{type:"button",className:C("p-accordion__tab",x.expandButton),"aria-expanded":(e==null?void 0:e.column)===t.id&&e.row===r,onClick:()=>k(t.id,r),children:`${(e==null?void 0:e.column)===t.id&&e.row===r?"Hide":"Show"} packages`})}].filter(({accessor:t})=>o.tableType==="paginated"?t!=="computers_count":t!=="date"),[u,s,l.length,o.tableType,e]);return a.jsx("div",{ref:q(f),children:o.tableType==="expandable"?a.jsx(j,{columns:w,data:u,getCellProps:I({expandedCell:e,isUsnsLoading:s,lastUsnIndex:u.length-1,showSelectAllButton:p}),getRowProps:N(e),itemCount:c.length,itemNames:{plural:"security issues",singular:"security issue"},onLimitChange:o.onNextPageFetch,totalCount:i}):a.jsxs(a.Fragment,{children:[a.jsx(y.ModularTable,{columns:w,data:u,getCellProps:I({expandedCell:e,isUsnsLoading:s}),getRowProps:N(e),emptyMsg:`No security issues found with the search "${o.search}"`}),c.length>0&&a.jsx(S,{handleClearSelection:()=>d([]),totalItems:i,currentItemCount:c.length})]})})};export{ce as U};
