import{y as j,z as x,l as O,A as _,C,r as E,j as G,m as V,K as h,G as b}from"./index-2fzpjuii.js";import{u as Q}from"./useRoles-Dwt5A3Uj.js";import{g as w,a as B,b as I,c as k}from"./index-AvIQXUKg.js";import{P as v,A as $}from"./AccessGroupBlock-CJLIDBS3.js";import{S as D}from"./SidePanelFormButtons-DAl7F5tV.js";import"./PageMain-B0lz2oOC.js";import"./TruncatedCell-CgdNfcLB.js";import"./SidePanelFormButtons.module-D2P5PizG.js";const L=(e,o,d,u)=>{const t=e.permissions.filter(s=>u.find(({global:f,values:c})=>f&&(c.manage===s||c.view===s))),p=e.permissions.filter(s=>!t.includes(s)),i=p.filter(s=>!o.permissions.includes(s));i.includes("AddComputerToAccessGroup")&&i.push("RemoveComputerFromAccessGroup"),t.length>0&&i.push(...t);const n=o.permissions.filter(s=>!p.includes(s));n.includes("AddComputerToAccessGroup")&&n.push("RemoveComputerFromAccessGroup");const l=w(e.accessGroups,d),a=l.filter(s=>!o.access_groups.includes(s)),g=o.access_groups.filter(s=>!l.includes(s));return{accessGroupsToAdd:a,accessGroupsToRemove:g,permissionsToAdd:i,permissionsToRemove:n}},N=(e,o,d,u,t)=>{const{addAccessGroups:p,addPermissions:i,removeAccessGroups:n,removePermissions:l}=t,a={},{accessGroupsToAdd:g,accessGroupsToRemove:s,permissionsToAdd:f,permissionsToRemove:c}=L(e,o,d,u);return g.length>0&&(a.addAccessGroupsPromise=p({name:o.name,access_groups:g})),s.length>0&&(a.removeAccessGroupsPromise=n({name:o.name,access_groups:s})),c.length>0&&(a.removePermissionsPromise=l({name:o.name,permissions:c})),f.length>0&&(a.addPermissionsPromise=i({name:o.name,permissions:f})),a},M=(e,o,d)=>{const u=[...e.access_groups,...e.access_groups.flatMap(i=>{var n;return((n=o.find(({value:l})=>l===i))==null?void 0:n.children)||[]})],t=e.global_permissions?[...e.permissions,...e.global_permissions]:e.permissions,p=[...new Set([...t,...d.filter(({values:i})=>t.includes(i.manage)).map(({values:i})=>i.view)])];return{accessGroups:u,permissions:p}},z={accessGroups:[],permissions:[]},H=C().shape({accessGroups:h().of(b()),permissions:h().of(b())}),es=({role:e})=>{const o=j(),{notify:d}=x(),{closeSidePanel:u}=O(),{addPermissionsToRoleQuery:t,addAccessGroupsToRoleQuery:p,getAccessGroupQuery:i,getPermissionsQuery:n,removeAccessGroupsFromRoleQuery:l,removePermissionsFromRoleQuery:a}=Q(),{data:g}=n(),s=g?B(g.data):[],{data:f}=i(),c=f?I(k(f.data)):[],{mutateAsync:y}=t,{mutateAsync:T}=p,{mutateAsync:R}=l,{mutateAsync:S}=a,m=_({initialValues:z,validationSchema:H,onSubmit:async r=>{const P=N(r,e,c,s,{addAccessGroups:T,addPermissions:y,removeAccessGroups:R,removePermissions:S});if(!Object.values(P).some(Boolean))return u();try{P.addPermissionsPromise&&P.removePermissionsPromise?(await Promise.all(Object.entries(P).filter(([A,F])=>A!=="addPermissionsPromise"&&F).map(([,A])=>A)),await P.addPermissionsPromise):await Promise.all(Object.values(P).filter(Boolean)),u(),d.success({title:"Role changes have been saved",message:`You modified the role '${e.name}'`})}catch(A){o(A)}}});return E.useEffect(()=>{m.setValues(M(e,c,s))},[e,c.length]),G.jsxs(V.Form,{onSubmit:m.handleSubmit,noValidate:!0,children:[G.jsx(v,{description:"These permissions are for managing the account as a whole. They are not limited to the specified access groups, but instead apply globally.",onPermissionChange:r=>m.setFieldValue("permissions",r),options:s.filter(({global:r})=>r),permissions:m.values.permissions,title:"Global permissions"}),G.jsx(v,{description:"These permissions only apply to selected access groups.",onPermissionChange:r=>m.setFieldValue("permissions",r),options:s.filter(({global:r})=>!r),permissions:m.values.permissions,title:"Permissions"}),G.jsx($,{accessGroupOptions:c,accessGroups:m.values.accessGroups,onAccessGroupChange:r=>{m.setFieldValue("accessGroups",r)}}),G.jsx(D,{submitButtonDisabled:m.isSubmitting,submitButtonText:"Save changes"})]})};export{es as default};
