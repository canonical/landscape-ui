import{r as w,j as e,P as E,z as S,B as H,G as A,d as b,R as M,e as I,q as D,N as L,I as j}from"./index-Dfc97QGW.js";import{E as x,S as F}from"./SelectAllButton-7i8VoFdt.js";import{N}from"./NoData-DMN9LLPq.js";import{R as $}from"./ResponsiveTable-ViIMTRR6.js";import{a as V}from"./TablePagination-B0v8QAQr.js";import{T as q}from"./TruncatedCell-Cf7_euhM.js";import{m as v}from"./index-S_kjB96R.js";import{u as R}from"./useUsns-DqfdHX4t.js";const O=({column:s})=>{const a={};return s.id==="title"?a.role="rowheader":s.id==="upgrades.security"&&(a["aria-label"]="Affected packages"),a},Q="_security_16o7z_1",Y={security:Q},z=({instances:s,limit:a,onLimitChange:u,usn:o,usnPackages:c})=>{const r=w.useMemo(()=>s.filter(({id:n})=>c.flatMap(({computer_ids:m})=>m).includes(n)).slice(0,a),[s,a,c]),t=w.useMemo(()=>[{accessor:"title",Header:"Name"},{accessor:"upgrades.security",className:Y.security,Header:"Affected packages",Cell:({row:{original:n}})=>c.filter(({computer_ids:m})=>m.includes(n.id)).length}],[r.length]);return e.jsx(x,{columns:t,data:r,itemNames:{plural:"instances",singular:"instance"},onLimitChange:u,totalCount:r.length,title:e.jsxs("p",{className:"p-heading--4",children:["Instances affected by ",e.jsx("b",{children:o})]}),getCellProps:O})},G=({instanceTitle:s,usn:a})=>{const u=E(),o=S(),{notify:c}=H(),{removeUsnPackagesQuery:r}=R(),{instanceId:t,childInstanceId:n}=A(),m=Number(t),{mutateAsync:_,isPending:p}=r,d=()=>{u(M.instances.details.fromParams({instanceId:m,childInstanceId:n},{tab:"activities"})),c.clear()},h=async()=>{try{await _({usns:a,instanceId:m}),c.success({title:"You queued packages to be uninstalled",message:`Packages affected by "${a}" security issue will be uninstalled and are queued in Activities.`,actions:[{label:"View details",onClick:d}]})}catch(k){o(k)}};return e.jsxs(b.ConfirmationButton,{type:"button",className:"is-small is-dense has-icon",confirmationModalProps:{title:"Uninstall USN packages",children:e.jsxs("p",{children:['This will uninstall packages affected by "',a,'" security issue from the "',s,'" instance.']}),confirmButtonLabel:"Uninstall",confirmButtonAppearance:"negative",confirmButtonDisabled:p,confirmButtonLoading:p,onConfirm:h},children:[e.jsx(b.Icon,{name:"delete",className:"u-no-margin--left"}),e.jsx("span",{children:"Uninstall packages"})]},"remove")},U=({column:s})=>{const a={};return s.id==="name"?a.role="rowheader":s.id==="current_version"?a["aria-label"]="Current version":s.id==="new_version"?a["aria-label"]="New version":s.id==="summary"&&(a["aria-label"]="Details"),a},W=({instanceTitle:s,limit:a,onLimitChange:u,showRemoveButton:o,usn:c,usnPackages:r})=>{const t=w.useMemo(()=>r.slice(0,a),[a,r]),n=w.useMemo(()=>[{accessor:"name",Header:"Package"},{accessor:"current_version",Header:"Current version"},{accessor:"new_version",Header:"New version"},{accessor:"summary",Header:"Details"}],[t.length]);return e.jsx(x,{additionalCta:o&&e.jsx(G,{instanceTitle:s,usn:c}),columns:n,data:t,itemNames:{plural:"packages",singular:"package"},onLimitChange:u,title:e.jsxs("p",{className:"p-heading--4",children:["Packages affected by ",e.jsx("b",{children:c})]}),totalCount:r.length,getCellProps:U})},J=({instances:s,isRemovable:a,listType:u,usn:o})=>{const[c,r]=w.useState(5),{getAffectedPackagesQuery:t}=R(),{instanceId:n}=A(),m=Number(n),{data:_,isLoading:p}=t({usn:o,computer_ids:a?[m]:s.map(({id:h})=>h)}),d=_?.data??[];return e.jsxs(e.Fragment,{children:[p&&e.jsx(I,{}),!p&&u==="instances"&&e.jsx(z,{instances:s,limit:c,onLimitChange:()=>{r(h=>h+5)},usn:o,usnPackages:d}),!p&&u==="packages"&&e.jsx(W,{instanceTitle:s[0].title,limit:c,onLimitChange:()=>{r(h=>h+5)},showRemoveButton:a,usn:o,usnPackages:d})]})},C={computers_count:0,cves:[],date:"",info:"",packages:[],usn:"",usn_link:""},K="_expanded_1odtw_7",X="_expandButton_1odtw_25",Z="_hidden_1odtw_34",ee="_innerTable_1odtw_38",se="_row_1odtw_45",ae="_cve_1odtw_51",te="_cveLink_1odtw_55",ne="_wrapper_1odtw_59",f={expanded:K,expandButton:X,hidden:Z,innerTable:ee,row:se,cve:ae,cveLink:te,wrapper:ne},ce=({expandedCell:s,isUsnsLoading:a,showSelectAllButton:u,usns:o})=>{const c=s?.column==="computers_count"||s?.column==="release_packages"?s.row+1:0;return[...[C].slice(u?0:1),...o.slice(0,c||o.length),...o.slice(c?c-1:o.length),...[C].slice(a?0:1)]},T=({expandedCell:s,isUsnsLoading:a,lastUsnIndex:u,showSelectAllButton:o})=>(({column:c,row:{index:r}})=>{const t={};return o&&r===0||a&&r===u||s?.row===r-1&&["computers_count","release_packages"].includes(s.column)?c.id==="usn"?(t.colSpan=4,s?.row===r-1&&["computers_count","release_packages"].includes(s.column)&&(t.className=f.innerTable)):(t.className=f.hidden,t["aria-hidden"]=!0):c.id==="usn"?t.role="rowheader":c.id==="cves"?(t["aria-label"]="CVE(s)",s?.column===c.id&&s.row===r&&(t.className="expandedCell")):c.id==="date"?t["aria-label"]="Date published":c.id==="computers_count"?(t["aria-label"]="Affected instances",t.className=s?.column===c.id&&s.row===r?f.expanded:f.row):c.id==="release_packages"&&(t["aria-label"]="Affected packages",t.className=s?.column===c.id&&s.row===r?f.expanded:f.row),t}),P=s=>({index:a})=>{const u={};return s?.column==="cves"&&s.row===a&&(u.className="expandedRow"),u},re=s=>a=>{a&&(s.current=[...a.querySelectorAll("tbody tr")])},fe=({instances:s,isUsnsLoading:a,onSelectedUsnsChange:u,selectedUsns:o,totalUsnCount:c,usns:r,...t})=>{const[n,m]=w.useState(null),_=w.useRef([]);D({current:n?.column==="cves"?_.current[n.row]:null},()=>{m(null)});const p=t.tableType==="expandable"&&t.showSelectAllButton,d=w.useMemo(()=>ce({expandedCell:n,isUsnsLoading:a,showSelectAllButton:p,usns:r}),[r,n,a,p]),h=l=>{u(o.includes(l)?o.filter(i=>i!==l):[...o,l])},k=(l,i)=>{m(g=>g&&g.column===l&&g.row===i?null:{column:l,row:g&&["computers_count","release_packages"].includes(g.column)&&g.row<i?i-1:i})},y=w.useMemo(()=>[{accessor:"usn",Header:e.jsxs(e.Fragment,{children:[e.jsx(b.CheckboxInput,{inline:!0,label:e.jsx("span",{className:"u-off-screen",children:"Toggle all security issues"}),disabled:d.length===0||a,indeterminate:o.length>0&&o.length<r.length,checked:o.length>0&&o.length===r.length,onChange:()=>{u(o.length>0?[]:r.map(({usn:l})=>l))}}),"USN"]}),Cell:({row:{index:l,original:i}})=>l===0&&p?e.jsx(F,{count:t.totalSelectedUsnCount,itemName:{plural:"security issues",singular:"security issue"},onClick:t.onSelectAllClick,totalCount:c}):n?.row===l-1&&["computers_count","release_packages"].includes(n.column)?e.jsx(J,{isRemovable:n.column==="release_packages"&&t.tableType==="paginated",instances:s,listType:n.column==="release_packages"?"packages":"instances",usn:d[n.row].usn}):a&&l===d.length-1?e.jsx(I,{}):e.jsxs(e.Fragment,{children:[e.jsx(b.CheckboxInput,{inline:!0,labelClassName:"u-no-margin--bottom u-no-padding--top",label:e.jsx("span",{className:"u-off-screen",children:`Toggle ${i.usn}`}),disabled:a,name:"usn",checked:o.includes(i.usn),onChange:()=>{h(i.usn)}}),e.jsx("a",{href:i.usn_link,target:"_blank",rel:"nofollow noopener noreferrer",children:i.usn})]})},{accessor:"cves",Header:"CVE(s)",Cell:({row:{original:l,index:i}})=>l.cves.length>0?e.jsx(q,{content:l.cves.map(({cve:g,cve_link:B})=>e.jsx("span",{className:f.cve,children:e.jsx("a",{href:B,target:"_blank",rel:"nofollow noopener noreferrer",className:f.cveLink,children:g})},g)),isExpanded:n?.column==="cves"&&n.row===i,onExpand:()=>{k("cves",i)}}):e.jsx(N,{})},{accessor:"date",Header:"Date published",Cell:({row:l})=>e.jsx(e.Fragment,{children:v(l.original.date).isValid()?e.jsx("span",{className:"font-monospace",children:v(l.original.date).format(L)}):e.jsx(N,{})})},{accessor:"computers_count",Header:"Affected instances",Cell:({column:l,row:{index:i,original:g}})=>e.jsx(b.Button,{type:"button",className:j("p-accordion__tab",f.expandButton),"aria-expanded":n?.column===l.id&&n.row===i,onClick:()=>{k(l.id,i)},children:g.computers_count})},{accessor:"release_packages",Header:"Affected packages",Cell:({column:l,row:{index:i}})=>e.jsx(b.Button,{type:"button",className:j("p-accordion__tab",f.expandButton),"aria-expanded":n?.column===l.id&&n.row===i,onClick:()=>{k(l.id,i)},children:`${n?.column===l.id&&n.row===i?"Hide":"Show"} packages`})}].filter(({accessor:l})=>t.tableType==="paginated"?l!=="computers_count":l!=="date"),[d,a,o.length,t.tableType,n]);return t.tableType==="expandable"?e.jsx("div",{ref:re(_),className:f.wrapper,children:e.jsx(x,{columns:y,data:d,getCellProps:T({expandedCell:n,isUsnsLoading:a,lastUsnIndex:d.length-1,showSelectAllButton:p}),getRowProps:P(n),itemCount:r.length,itemNames:{plural:"security issues",singular:"security issue"},onLimitChange:t.onNextPageFetch,totalCount:c})}):e.jsxs(e.Fragment,{children:[e.jsx($,{columns:y,data:d,getCellProps:T({expandedCell:n,isUsnsLoading:a}),getRowProps:P(n),emptyMsg:`No security issues found with the search "${t.search}"`}),e.jsx(V,{handleClearSelection:()=>{u([])},totalItems:c,currentItemCount:r.length})]})};export{fe as U};
