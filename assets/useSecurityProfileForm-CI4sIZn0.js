import{r as N,a6 as I,j as t,m as i,n as P,S as c,s as b,aA as R,v,D as M,I as A,u as $,aB as B,$ as Y,y as z,l as U,A as H,C as V,G as x,H as S}from"./index-2fzpjuii.js";import{A as W}from"./AssociationBlock-DSKjNBq_.js";import{u as G}from"./useInstances-DeMDoX3c.js";import{F as K}from"./FileInput-CWPijyCU.js";import{F as Q}from"./Flow-MheHi3pN.js";import{u as J}from"./useOrgSettings-CsTACyMU.js";import{u as Z}from"./useRoles-Dwt5A3Uj.js";import{g as m}from"./formikErrors-Bw8iTXYS.js";import{I as X,R as E}from"./RadioGroup-J9y92R_h.js";import{M as T}from"./MultiSelectField-zcRsQbOM.js";const w=[{label:"Sundays",value:"SU"},{label:"Mondays",value:"MO"},{label:"Tuesdays",value:"TU"},{label:"Wednesdays",value:"WE"},{label:"Thursdays",value:"TH"},{label:"Fridays",value:"FR"},{label:"Saturdays",value:"SA"}],D=[{label:"January",value:1},{label:"February",value:2},{label:"March",value:3},{label:"April",value:4},{label:"May",value:5},{label:"June",value:6},{label:"July",value:7},{label:"August",value:8},{label:"September",value:9},{label:"October",value:10},{label:"November",value:11},{label:"December",value:12}];function k(e){const{getInstancesQuery:s}=G(),{data:r,isLoading:d}=s({query:e.values.all_computers?void 0:e.values.tags.map(n=>`tag:${n}`).join(" OR "),limit:1}),[o,h]=N.useState(!1);return N.useEffect(()=>{if(r){if(!e.values.tags.length&&!e.values.all_computers){h(!1);return}h(r.data.count>I)}},[r]),{isLoading:d,isValid:!o,description:"Associate the security profile. Apply it to all instances or limit it to specific instances using a tag.",content:t.jsxs(t.Fragment,{children:[o&&t.jsxs(i.Notification,{severity:"negative",inline:!0,title:"Associated instances limit reached:",children:["You've reached the limit of"," ",t.jsxs("strong",{children:[I," associated instances"]}),". Decrease the number of associated instances."]}),t.jsx(W,{formik:e})]}),submitButtonText:"Next"}}const ee="_description_18qzl_1",te="_link_18qzl_6",q={description:ee,link:te},p=({className:e,description:s,label:r,link:d})=>t.jsxs(t.Fragment,{children:[t.jsx("p",{className:P("u-no-margin--bottom",e),children:r}),t.jsxs("small",{className:q.description,children:[s,d&&t.jsx("a",{className:q.link,href:d,target:"_blank",rel:"noreferrer",onClick:o=>{o.stopPropagation()},children:"learn more"})]})]});function ae(e,s){const r=async o=>{await e.setFieldValue("tailoring_file",o[0])},d=async()=>{await e.setFieldValue("tailoring_file",null)};return{isValid:!e.errors.benchmark&&!e.errors.mode,description:"Select a security profile benchmark, choose the profile mode, and optionally upload a tailoring file to customize the security profile.",content:t.jsxs(t.Fragment,{children:[!s&&t.jsx(i.Notification,{severity:"caution",title:"Changes restricted:",inline:!0,children:"After profile creation, the security profile benchmark and mode cannot be changed. Please review before proceeding."}),t.jsx(i.CustomSelect,{label:"Base profile",disabled:s,options:[{label:t.jsx(p,{className:"u-no-padding--top",label:c.cis_level1_workstation,description:"Center for Internet Security",link:"https://ubuntu.com/security/cis"}),value:"cis_level1_workstation",text:c.cis_level1_workstation},{label:t.jsx(p,{className:"u-no-padding--top",label:c.cis_level1_server,description:"Center for Internet Security",link:"https://ubuntu.com/security/cis"}),value:"cis_level1_server",text:c.cis_level1_server},{label:t.jsx(p,{className:"u-no-padding--top",label:c.cis_level2_workstation,description:"Center for Internet Security",link:"https://ubuntu.com/security/cis"}),value:"cis_level2_workstation",text:c.cis_level2_workstation},{label:t.jsx(p,{className:"u-no-padding--top",label:c.cis_level2_server,description:"Center for Internet Security",link:"https://ubuntu.com/security/cis"}),value:"cis_level2_server",text:c.cis_level2_server},{label:t.jsx(p,{className:"u-no-padding--top",label:c.disa_stig,description:"Defense Information System Agency (DISA) for the U.S. Department of Defense (DoD)",link:"https://ubuntu.com/security/disa-stig"}),value:"disa_stig",text:c.disa_stig}],value:e.values.benchmark??"",onChange:async o=>e.setFieldValue("benchmark",o),required:!0,searchable:"never"}),t.jsx(i.CustomSelect,{label:"Mode",disabled:s,options:[{label:t.jsx(p,{className:"u-no-padding--top",label:b.audit,description:"Generates an audit without applying any fixes or remediation."}),value:"audit",text:b.audit},{label:t.jsx(p,{className:"u-no-padding--top",label:b["audit-fix"],description:"Applies fixes and generates an audit after remediation."}),value:"audit-fix",text:b["audit-fix"]},{label:t.jsx(p,{className:"u-no-padding--top",label:b["audit-fix-restart"],description:`Applies fixes, requires a machine restart, and generates an
                  audit after remediation.`}),value:"audit-fix-restart",text:b["audit-fix-restart"]}],value:e.values.mode??"",onChange:async o=>e.setFieldValue("mode",o),required:!0}),t.jsx(K,{label:"Upload tailoring file",disabled:s,accept:".xml",...e.getFieldProps("tailoring_file"),help:t.jsxs(t.Fragment,{children:["Customize your security profile by adjusting or disabling rules to fit your system while staying compliant.",t.jsx("br",{}),"Max file size: 5mb. Supported format: .xml."]}),onFileRemove:d,onFileUpload:r})]}),submitButtonText:"Next"}}function se(e){return{isValid:!0,description:`This will ${R([e.values.mode!="audit"?"apply fixes":null,e.values.mode=="audit-fix-restart"?"restart instances":null,"generate an audit"].filter(s=>s!=null))} on the selected next run date.`,content:t.jsx(Q,{cards:[{header:"Next run date",description:t.jsxs(t.Fragment,{children:["Security profile's next run date arrives",t.jsx("br",{}),v(e.values.start_date).format(`${M}`)]}),iconName:"revisions"},e.values.mode!="audit"?{header:"Apply fixes",description:"Security profile will attempt to apply remediations before the next audit, helping maintain instances' compliance with the security profile.",iconName:"open-terminal"}:null,e.values.mode=="audit-fix-restart"?{header:"Restart instances",description:"To complete the fixes, instances must be restarted.",iconName:"restart",children:t.jsxs(t.Fragment,{children:[t.jsx(i.Row,{className:"u-no-padding",children:t.jsx(A,{label:"Delivery time",value:e.values.delivery_time=="asap"?"As soon as possible":`Delayed by ${e.values.restart_deliver_delay} hour${e.values.restart_deliver_delay==1?"":"s"}`})}),t.jsx(i.Row,{className:"u-no-padding",children:t.jsx(A,{label:"Randomize delivery over a time window",value:e.values.randomize_delivery=="yes"?`Yes, over ${e.values.restart_deliver_delay_window} minute${e.values.restart_deliver_delay_window==1?"":"s"}`:"No"})})]})}:null,{header:"Generate an audit",description:"Security profile will generate an audit for all instances associated, aggregated in the audit view to show pass/fail results and allow detailed inspection.",iconName:"file-blank"}].filter(s=>s!=null)}),submitButtonText:"Add"}}function re(e){const{isSelfHosted:s}=$(),{getOrganisationPreferences:r}=J(),{getAccessGroupQuery:d}=Z(),{data:o,isLoading:h}=d(),{data:n,isLoading:j}=r();return{isLoading:h||j,isValid:!e.errors.title,description:"Choose a descriptive profile name and the right access group for your security profile.",content:t.jsxs(t.Fragment,{children:[t.jsx(i.Input,{type:"text",label:"Profile name",...e.getFieldProps("title"),error:m(e,"title"),required:!0}),t.jsx(i.Select,{label:"Access group",options:o==null?void 0:o.data.map(g=>({label:g.title,value:g.name})),...e.getFieldProps("access_group"),error:m(e,"access_group"),required:!0,disabled:h}),s&&t.jsx(i.Input,{type:"text",label:"Audit retention",required:!0,disabled:!0,value:(n==null?void 0:n.data.audit_retention_period)==-1?"Infinite":`${n==null?void 0:n.data.audit_retention_period} day${(n==null?void 0:n.data.audit_retention_period)==1?"":"s"}`,help:"You can change this limit in the Landscape server configuration file."})]}),submitButtonText:"Next"}}const ie=({formik:{values:e,...s}})=>{switch(e.unit_of_time){case"WEEKLY":return t.jsx(T,{variant:"condensed",label:"On",items:[...w],selectedItems:w.filter(({value:r})=>e.days.includes(r)),onItemsUpdate:async r=>s.setFieldValue("days",r.map(({value:d})=>d)),scrollOverflow:!0,required:!0});case"MONTHLY":return!!e.start_date&&t.jsx(i.Select,{label:"On",options:B(new Date(e.start_date)),...s.getFieldProps("day_of_month_type"),required:!0});case"YEARLY":return t.jsx(T,{variant:"condensed",label:"On",items:[...D],selectedItems:D.filter(({value:r})=>e.months.includes(r)),onItemsUpdate:async r=>s.setFieldValue("months",r.map(({value:d})=>d)),scrollOverflow:!0,required:!0})}},ne=({formik:e})=>{const s=v().format(Y);switch(e.values.start_type){case"on-a-date":return t.jsx(i.Input,{type:"datetime-local",label:"Date",min:s,...e.getFieldProps("start_date"),error:m(e,"start_date"),required:!0});case"recurring":return t.jsxs(t.Fragment,{children:[t.jsx(i.Input,{type:"datetime-local",label:"Start date",min:s,...e.getFieldProps("start_date"),error:m(e,"start_date"),required:!0}),t.jsxs(i.Row,{className:"u-no-padding",children:[t.jsx(i.Col,{size:6,children:t.jsx(i.Input,{...e.getFieldProps("every"),type:"number",label:"Repeat every",min:1,error:m(e,"every"),required:!0})}),t.jsx(i.Col,{size:6,children:t.jsx(i.Select,{label:"Repeat every",options:[{label:"Day",value:"DAILY"},{label:"Week",value:"WEEKLY"},{label:"Month",value:"MONTHLY"},{label:"Year",value:"YEARLY"}].map(r=>e.values.every==1?r:{...r,label:`${r.label}s`}),...e.getFieldProps("unit_of_time"),required:!0})})]}),t.jsx(ie,{formik:e}),t.jsx(i.Select,{label:"Ends",options:[{label:"Never",value:"never"},{label:"On a date",value:"on-a-date"}],...e.getFieldProps("end_type"),required:!0}),e.values.end_type=="on-a-date"&&t.jsx(i.Input,{type:"datetime-local",label:"End date",min:e.values.start_date,...e.getFieldProps("end_date"),error:m(e,"end_date"),required:!0})]})}},le=({formik:e})=>t.jsxs(t.Fragment,{children:[t.jsx(i.Select,{label:"Schedule",options:[{label:"Select",value:"",hidden:!0},{label:"On a date",value:"on-a-date"},{label:"Recurring",value:"recurring"}],...e.getFieldProps("start_type"),required:!0}),t.jsx(X,{children:t.jsx(ne,{formik:e})})]}),oe="_inputContainer_1k4iz_1",de="_input_1k4iz_1",ue="_inputDescription_1k4iz_10",_={inputContainer:oe,input:de,inputDescription:ue};function ce(e){return{isValid:!e.errors.start_type&&!e.errors.start_date&&!e.errors.every&&!e.errors.end_date&&!e.errors.restart_deliver_delay_window&&!e.errors.restart_deliver_delay,description:"Add a schedule for the security profile. Select a specific date or a recurring schedule for continuous audit generation.",content:t.jsxs(t.Fragment,{children:[t.jsx(le,{formik:e}),e.values.mode=="audit-fix-restart"&&t.jsxs(t.Fragment,{children:[t.jsx(p,{label:"Restart schedule",description:"You can choose when to perform the required restart."}),t.jsx(E,{field:"delivery_time",formik:e,label:"Delivery time",inputs:[{label:"As soon as possible",key:"asap"},{label:"Delayed",key:"delayed",expansion:t.jsxs("div",{className:_.inputContainer,children:[t.jsx(i.Input,{type:"number",required:!0,className:_.input,wrapperClassName:_.inputWrapper,...e.getFieldProps("restart_deliver_delay"),error:m(e,"restart_deliver_delay")}),t.jsx("span",{className:_.inputDescription,children:"hours"})]})}]}),t.jsx(E,{field:"randomize_delivery",formik:e,label:"Randomize delivery over a time window",inputs:[{label:"No",key:"no"},{label:"Yes",key:"yes",expansion:t.jsxs("div",{className:_.inputContainer,children:[t.jsx(i.Input,{type:"number",required:!0,className:_.input,wrapperClassName:_.inputWrapper,...e.getFieldProps("restart_deliver_delay_window"),error:m(e,"restart_deliver_delay_window")}),t.jsx("span",{className:_.inputDescription,children:"minutes"})]})}]})]})]}),submitButtonText:"Next"}}const Se=({initialValues:e,mutate:s,benchmarkStepDisabled:r,onSuccess:d=()=>{}})=>{const o=z(),{closeSidePanel:h}=U(),n=H({initialValues:e,validateOnMount:!0,validationSchema:V().shape({benchmark:x().required("This field is required."),end_date:x().when(["start_date","start_type","end_type"],([a,l,u],y)=>l=="recurring"&&u=="on-a-date"?y.required("This field is required.").test({test:f=>v(f).isAfter(v(a)),message:"The end date must be after the start date."}):y),every:S().when("start_type",([a],l)=>a=="recurring"?l.required("This field is required.").positive("Enter a positive number.").integer("Enter an integer."):l),mode:x().required("This field is required."),restart_deliver_delay_window:S().when(["mode","randomize_delivery"],([a,l],u)=>a=="audit-fix-restart"&&l=="yes"?u.required("This field is required.").positive("Enter a positive number.").integer("Enter an integer."):u),restart_deliver_delay:S().when(["mode","delivery_time"],([a,l],u)=>a=="audit-fix-restart"&&l=="delayed"?u.required("This field is required.").positive("Enter a positive number.").integer("Enter an integer."):u),start_date:x().required("This field is required."),title:x().required("This field is required.")}),onSubmit:async a=>{var u;if(!a.benchmark||!a.mode)return;const l=[];if(a.start_type=="recurring"){switch(l.push(`FREQ=${a.unit_of_time}`,`INTERVAL=${a.every}`),a.unit_of_time){case"WEEKLY":{l.push(`BYDAY=${a.days.join(",")}`);break}case"MONTHLY":{const y=new Date(a.start_date),f=y.getDate();switch(a.day_of_month_type){case"day-of-month":{l.push(`BYMONTHDAY=${f}`);break}case"day-of-week":{const F=Math.ceil(f/7);l.push(`BYDAY=${F>4?-1:F}${w[y.getDay()].value}`);break}}break}case"YEARLY":{l.push(`BYMONTH=${a.months.join(",")}`);break}}a.end_type=="on-a-date"&&l.push(`UNTIL=${v(a.end_date).format("YYYYMMDDTHHmmss")}Z`)}else l.push("FREQ=WEEKLY","COUNT=1");try{await s({access_group:a.access_group=="global"?void 0:a.access_group,all_computers:a.all_computers||void 0,benchmark:a.benchmark,mode:a.mode,restart_deliver_delay_window:a.mode=="audit-fix-restart"?a.restart_deliver_delay_window:void 0,restart_deliver_delay:a.mode=="audit-fix-restart"?a.restart_deliver_delay:void 0,schedule:l.join(";"),start_date:`${v(a.start_date).format(Y)}Z`,tags:a.all_computers?void 0:a.tags,tailoring_file:await((u=a.tailoring_file)==null?void 0:u.text()),title:a.title})}catch(y){o(y);return}h(),d(a)}}),j=re(n),g=ae(n,r),L=ce(n),O=k(n),C=se(n);return{formik:n,steps:[j,g,L,O,C]}};export{Se as u};
