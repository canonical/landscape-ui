import{f as y,g as C,j as e,T as I,d as h,h as H,i as K,k,l as M,B as R,C as A,p as P,F as V,K as Z,O as W,r as u,n as z,q as D,ab as U,ai as X,av as J,aq as Y,aV as ee,ax as se,aW as te}from"./index-DHd_VY7f.js";import{P as ne,a as ae,b as re}from"./PageMain-BAmsXrSh.js";import{F as b,P as oe,I as ce,a as ie}from"./InstancesPageActions-CNY9ZUKM.js";import{u as G}from"./useInstances-CQSvXsWp.js";import{u as le}from"./useSelection-BMS1QTUX.js";import{G as de}from"./GroupFilter-BPO03q4h.js";import{u as he}from"./useRoles-DeiF58Ke.js";import"./ResponsiveButtons-BgYaenLx.js";const ue="_label_1i8qt_1",pe={label:ue},me=({options:t,label:n,inline:o=!1})=>{const{disabledColumns:a,setPageParams:c}=y(),r=s=>t.filter(({value:d})=>!s.includes(d)).map(({value:d})=>d);return C("disabledColumns",t.filter(s=>s.canBeHidden).map(s=>s.value)),e.jsx(I,{type:"multiple",showSelectedItemCount:!0,label:e.jsxs(e.Fragment,{children:[e.jsx(h.Icon,{name:"settings"}),e.jsx("span",{className:pe.label,children:n})]}),onItemsSelect:s=>{c({disabledColumns:r(s)})},options:t,disabledOptions:t.filter(({canBeHidden:s})=>!s),selectedItems:r(a),inline:o})},O=()=>{const t=H(),n=K(),o=(s={},d={})=>M({queryKey:["savedSearches",s],queryFn:async()=>t.get("GetSavedSearches",{params:s}),...d}),a=k({mutationFn:async s=>t.get("CreateSavedSearch",{params:s}),onSuccess:async()=>n.invalidateQueries({queryKey:["savedSearches"]})}),c=k({mutationFn:async s=>t.get("EditSavedSearch",{params:s}),onSuccess:async()=>n.invalidateQueries({queryKey:["savedSearches"]})}),r=k({mutationFn:async s=>t.get("RemoveSavedSearch",{params:s}),onSuccess:async()=>n.invalidateQueries({queryKey:["savedSearches"]})});return{getSavedSearchesQuery:o,createSavedSearchQuery:a,editSavedSearchQuery:c,removeSavedSearchQuery:r}},xe="_container_m2ugq_1",fe="_list_m2ugq_6",je="_listItem_m2ugq_11",ge="_search_m2ugq_17",ye="_row_m2ugq_25",ve="_truncated_m2ugq_33",g={container:xe,list:fe,listItem:je,search:ge,row:ye,truncated:ve},Se=({onSavedSearchClick:t,onSavedSearchRemove:n,savedSearches:o})=>{if(!o.length)return null;const a=R(),{notify:c}=A(),{removeSavedSearchQuery:r}=O(),{mutateAsync:s,isPending:d}=r,l=async i=>{try{await s({name:i}),n(),c.success({message:`Saved search ${i} successfully removed`,title:"Saved search removed"})}catch(m){a(m)}};return e.jsxs("div",{className:g.container,children:[e.jsx("p",{className:"p-text--small-caps u-text--muted p-text--small",children:"Saved searches"}),e.jsx("ul",{className:P("p-list--divided u-no-margin--bottom",g.list),children:o.map(i=>e.jsx("li",{children:e.jsxs("div",{className:g.listItem,children:[e.jsx(h.Button,{type:"button",appearance:"base",className:g.search,onClick:()=>t(i),children:e.jsxs(h.Row,{className:g.row,children:[e.jsx(h.Col,{size:4,children:e.jsx(h.Tooltip,{message:i.name,positionElementClassName:g.truncated,children:e.jsx("span",{children:i.name})})}),e.jsx(h.Col,{size:8,children:e.jsx(h.Tooltip,{message:i.search,positionElementClassName:g.truncated,children:e.jsx("span",{children:i.search})})})]})}),e.jsx(h.ConfirmationButton,{className:"has-icon u-no-margin--bottom u-no-padding--bottom u-no-padding--top",type:"button",appearance:"base",confirmationModalProps:{title:"Remove saved search",children:e.jsxs("p",{children:['This will remove the saved search "',i.name,'".']}),confirmButtonLabel:"Remove",confirmButtonAppearance:"negative",confirmButtonDisabled:d,confirmButtonLoading:d,onConfirm:()=>l(i.name)},children:e.jsx(h.Icon,{name:"delete"})})]})},i.name))})]})},_e="_infoContainer_zti77_1",be="_helpButtonContainer_zti77_9",Ce="_helpButton_zti77_9",q={infoContainer:_e,helpButtonContainer:be,helpButton:Ce},Ie=({onHelpButtonClick:t})=>e.jsx("div",{className:q.infoContainer,children:e.jsx("div",{className:q.helpButtonContainer,children:e.jsx(h.Button,{type:"button",appearance:"base",hasIcon:!0,className:q.helpButton,onClick:n=>{n.stopPropagation(),t()},children:e.jsx(h.Icon,{name:h.ICONS.help})})})}),we=({onClose:t,onSearchSave:n,search:o})=>{const a=R(),{notify:c}=A(),{createSavedSearchQuery:r}=O(),{mutateAsync:s}=r,l=V({initialValues:{name:""},onSubmit:async({name:i})=>{try{await s({search:o,name:i,title:i}),c.success({message:`Saved search ${i} successfully added`,title:"Saved search added"}),n(),t()}catch(m){a(m)}},validationSchema:Z({name:W().required("This field is required").test({message:"Name must consist of only lowercase alphanumeric characters and hyphens",test:i=>/^[a-z0-9][-a-z0-9]*$/.test(i)})})});return e.jsxs(h.Form,{onSubmit:l.handleSubmit,noValidate:!0,children:[e.jsx(h.Input,{type:"text",autoComplete:"off",autoFocus:!0,label:"Search name",...l.getFieldProps("name"),error:l.touched.name&&l.errors.name?l.errors.name:void 0}),e.jsxs("div",{className:"form-buttons",children:[e.jsx(h.Button,{type:"button",disabled:l.isSubmitting,onClick:t,children:"Cancel"}),e.jsx(h.Button,{type:"submit",disabled:l.isSubmitting,appearance:"positive","aria-label":`Saved search as ${l.values.name}`,children:"Save search"})]})]})},Ne="_container_fqj7b_1",Be="_prompt_fqj7b_10",Fe="_saveButton_fqj7b_17",$={container:Ne,prompt:Be,saveButton:Fe},Pe=({onSearchSave:t,search:n})=>{const[o,a]=u.useState(!1);return e.jsxs(e.Fragment,{children:[n&&o&&e.jsx(we,{onClose:()=>a(!1),onSearchSave:t,search:n}),n&&!o&&e.jsxs("div",{className:$.container,children:[e.jsxs("span",{className:$.prompt,children:[e.jsx("span",{children:"Search for "}),e.jsx("span",{className:"p-search-and-filter__search-query",children:n}),e.jsx("span",{children:"..."})]}),e.jsx(h.Button,{type:"button",appearance:"link",onClick:()=>a(!0),className:$.saveButton,children:"Save search"})]})]})},ke="_searchContainer_1r3qy_1",qe="_form_1r3qy_11",$e="_searchBoxContainer_1r3qy_16",Oe="_input_1r3qy_20",B={searchContainer:ke,form:qe,searchBoxContainer:$e,input:Oe},T=({inputText:t,savedSearches:n,search:o})=>{if(!n)return[];let a=n;if(o){const c=o.split(",").filter(Boolean);a=a.filter(({name:r})=>c.every(s=>s!==`search:${r}`))}return t&&(a=a.filter(({name:c,search:r})=>c.toLowerCase()!==t.trim().toLowerCase()&&r.toLowerCase()!==t.trim().toLowerCase())),a},Te=({onHelpButtonClick:t})=>{const{query:n,setPageParams:o}=y(),[a,c]=u.useState(""),[r,s]=u.useState(!1),{getSavedSearchesQuery:d}=O(),l=u.useRef(null),i=u.useRef(null);z(l,p=>{const j=document.querySelector(".p-modal");j&&j.contains(p.target)||s(!1)});const{data:x,isLoading:w}=d(),N=u.useMemo(()=>T({inputText:a,savedSearches:x==null?void 0:x.data,search:n}),[x,a,n]),v=()=>{if(!a)return;const j=T({inputText:"",savedSearches:x==null?void 0:x.data,search:n}).some(({name:Q})=>Q.toLowerCase()===a.trim().toLowerCase())?"search:":"";o({query:n?`${n},${j}${a}`:`${j}${a}`}),c("")},f=p=>{o({query:n?`${n},search:${p.name}`:`search:${p.name}`})},S=p=>{const{key:j}=p;r?(j==="Escape"&&s(!1),j==="Enter"&&v()):j==="Enter"&&s(!0)};return e.jsxs("div",{className:"p-search-and-filter",ref:l,children:[e.jsxs("div",{className:P("p-search-and-filter__search-container",B.searchContainer),"aria-expanded":r,ref:i,onClick:()=>{s(!0)},children:[e.jsx(h.Form,{onSubmit:p=>{p.preventDefault(),v()},className:P("p-search-and-filter__box",B.form),children:e.jsx("div",{className:B.searchBoxContainer,children:e.jsx(h.SearchBox,{externallyControlled:!0,shouldRefocusAfterReset:!0,autocomplete:"off",className:B.input,value:a,onChange:p=>{c(p)},onClear:()=>{c("")},onSearch:v,onClick:()=>{s(!0)},onKeyUp:S})})}),e.jsx(Ie,{onHelpButtonClick:t})]}),r&&w&&e.jsx(D,{}),r&&!w&&e.jsxs("div",{className:"p-search-and-filter__panel",children:[e.jsx(Pe,{onSearchSave:()=>{c("")},search:a.trim()}),e.jsx(Se,{onSavedSearchClick:f,onSavedSearchRemove:()=>{s(!0)},savedSearches:N})]})]})},Ee=({options:t,label:n,inline:o=!1})=>{const{accessGroups:a,setPageParams:c}=y();return C("accessGroups",t.map(r=>r.value)),e.jsx(I,{type:"multiple",label:n,hasToggleIcon:!0,hasBadge:!0,options:t,onItemsSelect:r=>{c({accessGroups:r})},selectedItems:a,inline:o})},Le=({options:t,label:n,inline:o=!1})=>{const[a,c]=u.useState(""),{availabilityZones:r,setPageParams:s}=y(),d=t.length>9&&a?t.filter(({value:i})=>i!=="none"&&i.includes(a)):t;C("availabilityZones",d.map(i=>i.value));const l=i=>{i[i.length-1]==="none"?s({availabilityZones:["none"]}):s({availabilityZones:i[0]!=="none"?i:i.filter(m=>m!=="none")})};return e.jsx(I,{type:"multiple",label:n,hasToggleIcon:!0,hasBadge:!0,onSearch:t.length>9?i=>{c(i)}:void 0,options:d,onItemsSelect:l,selectedItems:r,inline:o})},Re=({options:t,label:n,inline:o=!1})=>{const{os:a,setPageParams:c}=y();return C("os",t.map(r=>r.value)),e.jsx(I,{type:"single",hasBadge:!0,label:n,hasToggleIcon:!0,options:t,onItemSelect:r=>{c({os:r})},selectedItem:a,inline:o})},Ae=({options:t,label:n,inline:o=!1})=>{const[a,c]=u.useState(""),{tags:r,setPageParams:s}=y(),d=t.filter(({value:l})=>l.includes(a));return C("tags",d.map(l=>l.value)),e.jsx(I,{type:"multiple",label:n,hasToggleIcon:!0,hasBadge:!0,options:d,onItemsSelect:l=>{s({tags:l})},onSearch:l=>{c(l)},selectedItems:r,inline:o})},ze=[{term:"<keyword>",description:e.jsxs("span",{children:["Instances with the title or hostname ",e.jsx("code",{children:"<keyword>"})]})},{term:"distribution:<keyword>",description:e.jsxs("span",{children:["Instances with the installed distribution named"," ",e.jsx("code",{children:"<keyword>"})]})},{term:"needs:reboot",description:"Instances needing a reboot"},{term:"alert:<type>",description:e.jsxs(e.Fragment,{children:[e.jsxs("span",{children:["Instances with outstanding alerts of the specified"," ",e.jsx("code",{children:"<type>"})]}),e.jsx("br",{}),e.jsxs("span",{children:[e.jsx("code",{children:"<type>"})," can be ",e.jsx("code",{children:"package-upgrades"}),","," ",e.jsx("code",{children:"security-upgrades"}),",",e.jsx("code",{children:"package-profiles"}),","," ",e.jsx("code",{children:"package-reporter"}),", ",e.jsx("code",{children:"esm-disabled"}),","," ",e.jsx("code",{children:"computer-offline"}),",",e.jsx("code",{children:"computer-reboot"}),","," ",e.jsx("code",{children:"computer-duplicates"}),", ",e.jsx("code",{children:"unapproved-activities"}),"."]})]})},{term:"ip:<address>",description:e.jsxs(e.Fragment,{children:[e.jsxs("span",{children:["Instances with IP addresses like ",e.jsx("code",{children:"<address>"})]}),e.jsx("br",{}),e.jsxs("span",{children:[e.jsx("code",{children:"<address>"})," can be a fragment or partial IP address representing a subnet such as 91.185.94 to match any instances in the subnet."]})]})},{term:"mac:<address>",description:e.jsxs("span",{children:["Instances with the MAC address ",e.jsx("code",{children:"<address>"})]})},{term:"id:<instance_id>",description:e.jsxs("span",{children:["Instance with the id ",e.jsx("code",{children:"<instance_id>"})]})},{term:"access-group:<name>",description:e.jsxs("span",{children:["Instances associated with the ",e.jsx("code",{children:"<name>"})," access group"]})},{term:"search:<name>",description:e.jsxs("span",{children:["Instances meeting the terms of the ",e.jsx("code",{children:"<name>"})," saved search"]})},{term:"upgrade-profile:<name>",description:e.jsxs("span",{children:["Instances associated with the ",e.jsx("code",{children:"<name>"})," upgrade profile"]})},{term:"removal-profile:<name>",description:e.jsxs("span",{children:["Instances associated with the ",e.jsx("code",{children:"<name>"})," removal profile"]})},{term:"tag:<keyword>",description:e.jsxs("span",{children:["Instances associated with the ",e.jsx("code",{children:"<keyword>"})," tag"]})},{term:"hostname:<keyword>",description:e.jsxs("span",{children:["Instance with the hostname ",e.jsx("code",{children:"<keyword>"})]})},{term:"title:<keyword>",description:e.jsxs("span",{children:["Instance with the title ",e.jsx("code",{children:"<keyword>"})]})},{term:"license-id:<license_id>",description:e.jsxs("span",{children:["Search for instances licensed to the specified"," ",e.jsx("code",{children:"<license_id>"})]})},{term:"needs:license OR license-id:none",description:"Search for instances that do not have a Landscape license, and, as a result, are not managed"},{term:"annotation:<key>",description:e.jsxs("span",{children:["Search for instances which define the specified annotation key. Optionally specify ",e.jsx("code",{children:"annotation:<key>:<string>"})," ","which will only return instances whose key matches and value also contains the ",e.jsx("code",{children:"<string>"})," specified"]})},{term:"security-profiles:<security-profile-id>:<pass|fail|in-progress>",description:e.jsxs("span",{children:["Search for the security profiles with a specified id. Optionally specify"," ",e.jsx("code",{children:"security-profiles:<security-profiles-id>:<pass|fail|in-progress>"})," ","which will only return security profiles whose id matches, and value also contains ",e.jsx("code",{children:"pass"}),", ",e.jsx("code",{children:"fail"}),","," ",e.jsx("code",{children:"in-progress"})," as specified"]})}],De="_top_1d4ve_1",Ge="_searchContainer_1d4ve_13",Qe="_divider_1d4ve_22",F={top:De,searchContainer:Ge,divider:Qe},He="_menuContainer_xrtuf_1",Ke="_wrapper_xrtuf_6",E={menuContainer:He,wrapper:Ke},Me="_root_1fm3p_1",Ve="_label_1fm3p_5",Ze="_text_1fm3p_16",We="_icon_1fm3p_20",Ue="_content_1fm3p_24",_={root:Me,label:Ve,text:Ze,icon:We,content:Ue},Xe=({el:t})=>{const[n,o]=u.useState(!1),a=u.useRef(null);z(a,()=>{n&&o(!1)});const c=u.cloneElement(t,{inline:!0});return e.jsxs("div",{ref:a,className:_.root,children:[e.jsxs(h.Button,{type:"button",appearance:"base",className:_.label,onClick:()=>{o(r=>!r)},children:[e.jsx(h.Icon,{name:"chevron-down",className:_.icon}),e.jsx("span",{className:_.text,children:t.props.label})]}),n&&e.jsx("div",{className:`p-contextual-menu__dropdown ${_.content}`,children:c})]})},Je=({filters:t,collapseFrom:n="md",menuLabel:o="Filters",className:a,menuPosition:c="right"})=>{const r=U(`(min-width: ${X[n]}px)`);return e.jsx("div",{className:P(E.wrapper,a),children:r?t.map((s,d)=>e.jsx("span",{children:s},d)):e.jsx(h.ContextualMenu,{position:c,hasToggleIcon:!0,toggleLabel:o,toggleClassName:"u-no-margin--bottom",children:e.jsx("div",{className:E.menuContainer,children:t.map((s,d)=>s.type.name?e.jsx(Xe,{el:s},d):s)})})})},Ye=({columnFilterOptions:t})=>{const[n,o]=u.useState(!1),{getAccessGroupQuery:a}=he(),{getAllInstanceTagsQuery:c,getAvailabilityZonesQuery:r}=G(),{data:s}=c(),d=(s==null?void 0:s.data.results.map(f=>({label:f,value:f})))??[],{data:l}=r(),i=((l==null?void 0:l.data.values)??[]).reduce((f,S)=>(f.push({label:S,value:S}),f),[{label:"Without zones",value:"none",group:"1"}]),{data:m}=a(),x=(m==null?void 0:m.data.map(({name:f,title:S})=>({value:f,label:S})))??[],w=b.groupBy.options,N=b.status.options,v=b.os.options;return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:F.top,children:[e.jsx("div",{className:F.searchContainer,children:e.jsx(Te,{onHelpButtonClick:()=>{o(!0)}})}),e.jsx(Je,{collapseFrom:"xxl",filters:[e.jsx(de,{label:"Group by",options:w},"group"),e.jsx("span",{className:F.divider},"divider-1"),e.jsx(J,{label:"Status",options:N},"status"),e.jsx(Re,{label:"OS",options:v},"os"),e.jsx(Le,{label:"Availability zones",options:i},"availability-zone"),e.jsx(Ee,{label:"Access groups",options:x},"access-group"),e.jsx(Ae,{label:"Tags",options:d},"tag"),e.jsx("span",{className:F.divider},"divider-2"),e.jsx(me,{label:"Columns",options:t},"column")]})]}),e.jsx(Y,{filtersToDisplay:["accessGroups","os","availabilityZones","status","tags","query"],accessGroupOptions:x,availabilityZonesOptions:i,osOptions:v,statusOptions:N,tagOptions:d}),e.jsx(ee,{open:n,data:ze,onClose:()=>{o(!1)}}),e.jsx(oe,{})]})},es=u.memo(function({instanceCount:n,instances:o,isGettingInstances:a,selectedInstances:c,setSelectedInstances:r}){const[s,d]=u.useState([]),l=u.useCallback(()=>{r([])},[]);return e.jsxs(e.Fragment,{children:[e.jsx(Ye,{columnFilterOptions:s}),a?e.jsx(D,{}):e.jsx(ce,{instances:o,selectedInstances:c,setColumnFilterOptions:d,setSelectedInstances:r}),e.jsx(se,{totalItems:n,handleClearSelection:l,currentItemCount:o.length})]})}),L=(t,n)=>{var o;return t.type==="select"?((o=t.options.find(a=>a.value===n))==null?void 0:o.query)??"":""},ss=({accessGroups:t,availabilityZones:n,os:o,query:a,status:c,tags:r})=>{const s=[];return o&&s.push(L(b.os,o)),c&&s.push(L(b.status,c)),a&&s.push(...a.split(",")),r.length&&s.push(`tag:${r.join(" OR tag:")}`),t.length&&s.push(`access-group:${t.join(" OR access-group:")}`),n.length&&s.push(n.includes("none")?"availability-zone:null":`availability-zone:${n.join(" OR availability-zone:")}`),s.join(" ")},ds=()=>{const{currentPage:t,pageSize:n,groupBy:o,...a}=y(),{getInstancesQuery:c}=G(),{data:r,isLoading:s}=c({query:ss(a),root_only:o==="parent",archived_only:a.status==="archived",with_alerts:!0,with_upgrades:te,limit:n,offset:(t-1)*n}),d=(r==null?void 0:r.data.results)??[],{selectedItems:l,setSelectedItems:i}=le(d,s);return e.jsxs(ne,{children:[e.jsx(ae,{title:"Instances",actions:[e.jsx(ie,{isGettingInstances:s,selectedInstances:l},"actions")],sticky:!0}),e.jsx(re,{children:e.jsx(es,{instanceCount:r==null?void 0:r.data.count,instances:d,isGettingInstances:s,selectedInstances:l,setSelectedInstances:i})})]})};export{ds as default};
