import{r as g,au as R,av as B,j as s,n as i,l as G,H as D,K as o,P as j,J as k,M as U,w as v,A as z,B as H,m as Z,C as J,p as K,F as m,ar as F}from"./index-BM6AgdsO.js";import{M as C}from"./MultiSelectField-Bx1OOl5_.js";import{S as Y}from"./SidePanelFormButtons-BvpKbFHZ.js";import{d as $}from"./helpers-CFrh65te.js";import{u as Q}from"./useInstances-CNKapm3e.js";import"./InstancesPageActions-CAh_t6gQ.js";import{u as W,D as X}from"./DeliveryBlock-ewvt9oS1.js";import"./SidePanelFormButtons.module-D2P5PizG.js";const ee="_pagination_gtxm7_1",te="_table_gtxm7_6",P={pagination:ee,table:te},se=({instances:a})=>{const[n,p]=g.useState(R),[l,h]=g.useState(B),c=g.useMemo(()=>[{Header:"Instance",Cell:({row:{original:e}})=>e.title}],[]),u=(n-1)*l,f=a.slice(u,u+l);return s.jsxs(s.Fragment,{children:[s.jsx(i.ModularTable,{columns:c,data:f,className:P.table}),s.jsx(G,{className:P.pagination,currentItemCount:f.length,currentPage:n,pageSize:l,paginate:p,setPageSize:h,totalItems:a.length})]})},ae={deliver_after:"",deliverImmediately:!0,instanceIds:[],queryType:"tags",tags:[],username:"root",time_limit:300},ie=D().shape({access_group:o(),deliverImmediately:k().required("This field is required."),deliver_after:o().when("deliverImmediately",{is:!1,then:a=>a.required("This field is required").test({test:n=>v(n).isValid()&&v(n).isAfter(v()),message:"You have to enter a valid date and time in the future"})}),instanceIds:j().of(U()).when("queryType",{is:"ids",then:a=>a.min(1,"At least one instance is required.")}),queryType:o().required("This field is required."),tags:j().of(o()).when("queryType",{is:"tags",then:a=>a.min(1,"At least one tag is required.")}),username:o().required("This field is required.")}),ne="_instanceSelectionContainer_10uv9_1",re="_radioGroup_10uv9_9",w={instanceSelectionContainer:ne,radioGroup:re},fe=({script:a})=>{const n=z(),{notify:p}=H(),{closeSidePanel:l}=Z(),{getAllInstanceTagsQuery:h,getInstancesQuery:c}=Q(),{runScript:u}=W(),e=J({initialValues:ae,onSubmit:async t=>{const r={query:t.queryType==="ids"?`id:${t.instanceIds.join(" OR id:")}`:`tag:${t.tags.join(" OR tag:")}`,script_id:a.id,username:t.username,time_limit:Number(t.time_limit),deliver_after:t.deliverImmediately?void 0:F(t.deliver_after).toISOString().replace(/\.\d+(?=Z$)/,"")};t.deliverImmediately||(r.deliver_after=F(t.deliver_after).toISOString().replace(/\.\d+(?=Z$)/,""));try{await u(r),l(),p.success({message:`"${a.title}" script queued to execute successfully`,title:"Script execution queued"})}catch(O){n(O)}},validateOnMount:!0,validationSchema:ie}),[A,x]=g.useState(!1),{data:y,isLoading:N}=h(),{data:I,isLoading:E}=c({query:`access-group-recursive:${a.access_group}`}),{data:S,isLoading:T,error:b}=c({query:`access-group-recursive:${a.access_group} ${e.values.tags.map(t=>`tag:${t}`).join(" OR ")}`},{enabled:!!e.values.tags.length});if(N||E)return s.jsx(K,{});b&&n(b);const L=()=>{x(!1)},M=()=>{x(!0)},q=(y==null?void 0:y.data.results.map(t=>({label:t,value:t})))??[],d=((I==null?void 0:I.data.results.filter(t=>$("runScripts",t)))??[]).map(({title:t,id:r})=>({label:t,value:r})),V=(S==null?void 0:S.data.results.filter(t=>$("runScripts",t)))??[],_=()=>{e.values.queryType=="tags"?M():e.handleSubmit()};return s.jsxs(s.Fragment,{children:[s.jsxs(i.Form,{onSubmit:_,noValidate:!0,children:[s.jsx("p",{className:"u-no-margin--bottom",children:"Select instances by:"}),s.jsx("div",{className:"is-required",children:s.jsxs("div",{children:[s.jsxs("div",{className:w.radioGroup,children:[s.jsx(i.Input,{type:"radio",label:"Tags",...e.getFieldProps("queryType"),onChange:async t=>{e.getFieldProps("queryType").onChange(t),await Promise.all([e.setFieldValue("tags",[]),e.setFieldTouched("tags",!1),e.setFieldValue("instanceIds",[]),e.setFieldTouched("instanceIds",!1)])},value:"tags",checked:e.values.queryType==="tags"}),s.jsx(i.Input,{type:"radio",label:"Instance names",...e.getFieldProps("queryType"),value:"ids",checked:e.values.queryType==="ids",disabled:!d.length,help:!d.length&&"There are no available instances in this script's access group."})]}),s.jsxs("div",{className:w.instanceSelectionContainer,children:[e.values.queryType==="tags"&&s.jsx(C,{placeholder:"Select tags",variant:"condensed",label:"Tags",labelClassName:"u-off-screen",required:!0,...e.getFieldProps("tags"),items:q,selectedItems:q.filter(({value:t})=>e.values.tags.includes(t)),onItemsUpdate:async t=>{e.setFieldValue("tags",t.map(({value:r})=>r)),e.setFieldTouched("tags",!0,!1)},error:m(e,"tags"),scrollOverflow:!0}),e.values.queryType==="ids"&&s.jsx(C,{placeholder:"Select instances",variant:"condensed",label:"Instances",labelClassName:"u-off-screen",required:!0,...e.getFieldProps("instanceIds"),items:d,selectedItems:d.filter(({value:t})=>e.values.instanceIds.includes(t)),onItemsUpdate:async t=>{e.setFieldValue("instanceIds",t.map(({value:r})=>r)),e.setFieldTouched("instanceIds",!0,!1)},error:m(e,"instanceIds"),scrollOverflow:!0})]})]})}),s.jsxs(i.Row,{className:"u-no-padding--left u-no-padding--right",children:[s.jsx(i.Col,{size:6,children:s.jsx(i.Input,{type:"text",label:"Run as user",autoComplete:"off",required:!0,...e.getFieldProps("username"),error:m(e,"username")})}),s.jsx(i.Col,{size:6,children:s.jsx(i.Input,{type:"text",label:"Time limit (seconds)",autoComplete:"off",required:!0,...e.getFieldProps("time_limit"),error:m(e,"time_limit")})})]}),s.jsx(X,{formik:e}),s.jsx(Y,{submitButtonDisabled:e.isSubmitting||!e.isValid,submitButtonText:"Run script",onSubmit:_})]}),A&&s.jsxs(i.ConfirmationModal,{title:`Run ${a.title} script on ${e.values.tags.length>1?`${e.values.tags.length} tags`:`${e.values.tags[0]} tag`}`,confirmButtonLabel:"Run script",onConfirm:()=>{e.handleSubmit()},confirmButtonDisabled:e.isSubmitting||!!b||T,confirmButtonLoading:T,close:L,confirmButtonAppearance:"positive",children:[s.jsxs("p",{children:["This script will run on the following instances, which are associated with the selected"," ",e.values.tags.length==1?"tag":"tags","."]}),s.jsx(se,{instances:V})]})]})};export{fe as default};
