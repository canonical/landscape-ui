import{h as z,i as V,t as P,k as n,U as q,r as f,p as K,f as Q,s as W,j as t,g as a,$ as k}from"./index-DPLJ1_NT.js";import{C as F,U as Y}from"./UdebCheckboxInput-DU4d0mwY.js";import{S as J}from"./SidePanelFormButtons-Ce3-qe12.js";import{u as X}from"./useGPGKeys-DzRA6YM-.js";import{h as l}from"./usePageParams-1-ThHq1P.js";import{S as g,I as E,f as d,c as Z,u as ee,h as re,C as te,A as se,i as S,P as T,g as C,D as j,j as I}from"./constants-CD15ho_A.js";import{t as A}from"./tests-DFnZqbNV.js";import"./SidePanelFormButtons.module-C5v714vX.js";import"./useFetchOld-Bn8tkaGx.js";import"./NoData-CmPjlMEU.js";import"./index-ClUQlPux.js";import"./TablePagination-BsgAbE2P.js";import"./TablePaginationBase--jZwlkTu.js";import"./StatusFilter-DiMI82Zm.js";import"./TableFilter-syE9Wql0.js";import"./TableFilterChips-DoE1vNRM.js";const ae=o=>o.replace(/\/[^\\/@]*@/,"/"),ie=o=>o?{...E,distribution:o.name}:E,oe=(o,p)=>z().shape({distribution:n().required("This field is required."),type:n().required("This field is required."),name:n().required("This field is required.").test({test:A.test,message:A.message}).test({test:(i,s)=>!!s.parent.distribution,message:"First select the distribution."}).test({params:{distribution:p,distributions:o},test:(i,s)=>s.parent.distribution?!(p?p.series.map(({name:c})=>c):o.filter(({name:c})=>c===s.parent.distribution)[0].series.map(({name:c})=>c)).includes(i):!0,message:"It must be unique within series within the distribution."}),hasPockets:V(),mirror_series:n(),mirror_gpg_key:n(),mirror_uri:n().when("hasPockets",(i,s)=>i[0]?s.nonNullable().required("This field is required."):s),snapshotDate:n().when("type",(i,s)=>i[0]==="ubuntu-snapshot"?s.required("This field is required.").test({test:h=>l(h).isBetween(l(g),l()),message:`The date must be after ${l(g).format(q)} and not in the future.`}):s),gpg_key:n().when("hasPockets",(i,s)=>i[0]?s.required("This field is required."):s),pockets:P().of(n()),components:P().of(n()).when("hasPockets",(i,s)=>i[0]?s.min(1,"Please choose at least one component."):s),architectures:P().of(n()).when("hasPockets",(i,s)=>i[0]?s.min(1,"Please choose at least one architecture."):s),include_udeb:V().required()}),Se=({distribution:o,ctaText:p="Add mirror"})=>{const[i,s]=f.useState(d),[h,c]=f.useState([]),D=K(),{closeSidePanel:O}=Q(),{getGPGKeysQuery:N}=X(),{createSeriesQuery:R,getRepoInfo:U}=Z(),{getDistributionsQuery:G}=ee(),{data:b}=G({include_latest_sync:!0},{enabled:!o}),w=(b==null?void 0:b.data)??[],{data:y}=N(),{mutateAsync:L}=R,v=(y==null?void 0:y.data)??[],M=w.map(({name:r})=>({label:r,value:r})),e=W({initialValues:ie(o),validationSchema:oe(w,o),onSubmit:async r=>{try{await L({name:r.name,distribution:r.distribution,mirror_series:r.mirror_series,gpg_key:r.gpg_key,include_udeb:r.include_udeb,mirror_uri:r.mirror_uri,components:r.components,pockets:r.pockets,architectures:r.architectures,mirror_gpg_key:r.mirror_gpg_key}),O()}catch(u){D(u)}}}),$=async r=>{await e.setFieldValue("snapshotDate",r.target.value),await e.setFieldValue("mirror_uri",`${j}/${l(r.target.value).format(I)}`)},B=async r=>{var u;await e.setFieldValue("type",r.target.value),r.target.value==="ubuntu"?(await e.setFieldValue("mirror_uri",d),await e.setFieldValue("pockets",S.ubuntu),await e.setFieldValue("hasPockets",!0),await e.setFieldValue("components",T.ubuntu),await e.setFieldValue("architectures",C.ubuntu),r.target.value==="ubuntu"&&!((u=e.values.mirror_uri)!=null&&u.startsWith(d))&&await e.setFieldValue("mirror_uri",d),s(d)):r.target.value==="third-party"?(await e.setFieldValue("mirror_uri",""),await e.setFieldValue("pockets",S.thirdParty),await e.setFieldValue("hasPockets",!0),await e.setFieldValue("components",T.thirdParty),await e.setFieldValue("architectures",C.thirdParty),s("")):r.target.value==="ubuntu-snapshot"&&(await e.setFieldValue("mirror_uri",`${j}/${l(e.values.snapshotDate).format(I)}`),await e.setFieldValue("pockets",S.ubuntu),await e.setFieldValue("hasPockets",!0),await e.setFieldValue("components",T.ubuntu),s(d))},H=async r=>{const u=r.target.value;await e.setFieldValue("mirror_series",u),!(!u||e.values.name)&&await e.setFieldValue("name",e.values.type==="ubuntu-snapshot"?`${u}-snapshot-${l(e.values.snapshotDate).format(k)}`:u)},{data:_}=U({mirror_uri:ae(i)},{enabled:!!i}),m=_==null?void 0:_.data;return f.useEffect(()=>{var r;if(!m){c([]);return}m.ubuntu?(r=e.values.mirror_uri)!=null&&r.startsWith(d)&&e.setFieldValue("type","ubuntu"):e.setFieldValue("type","third-party"),c(m.repos.map(({description:u,repo:x})=>({label:m.ubuntu?u:x,value:x})))},[m]),t.jsxs(a.Form,{onSubmit:e.handleSubmit,noValidate:!0,children:[t.jsx(a.Select,{label:"Type",required:!0,options:[{label:"Ubuntu Archive",value:"ubuntu"},{label:"Ubuntu Snapshot",value:"ubuntu-snapshot"},{label:"Third party",value:"third-party"}],...e.getFieldProps("type"),onChange:B,error:e.touched.type&&e.errors.type?e.errors.type:void 0}),e.values.type!=="ubuntu-snapshot"&&t.jsx(a.Input,{type:"text",label:"Mirror URI",required:e.values.hasPockets,help:"Absolute URL or file path",...e.getFieldProps("mirror_uri"),onBlur:r=>{s(r.target.value)},error:e.touched.mirror_uri&&e.errors.mirror_uri?e.errors.mirror_uri:void 0}),e.values.type==="ubuntu-snapshot"&&t.jsx(a.Input,{type:"date",min:l(g).format(k),max:l().format(k),label:"Snapshot date",required:!0,...e.getFieldProps("snapshotDate"),onChange:$,error:e.touched.snapshotDate&&e.errors.snapshotDate?e.errors.snapshotDate:void 0,help:`Starting from approximately ${l(g).format(q)} in dd.mm.yyyy format`}),!o&&t.jsx(a.Select,{label:"Distribution",required:!0,options:[{label:"Select distribution",value:""},...M],...e.getFieldProps("distribution"),error:e.touched.distribution&&e.errors.distribution?e.errors.distribution:void 0}),t.jsxs(a.Row,{className:"u-no-padding",children:[t.jsx(a.Col,{size:6,medium:3,small:2,children:t.jsx(a.Select,{label:"Mirror series",options:[{label:"Select series",value:""},...h],...e.getFieldProps("mirror_series"),onChange:H,error:e.touched.mirror_series&&e.errors.mirror_series?e.errors.mirror_series:void 0})}),t.jsx(a.Col,{size:6,medium:3,small:2,children:t.jsx(a.Input,{type:"text",label:"Series name",required:!0,...e.getFieldProps("name"),error:e.touched.name&&e.errors.name?e.errors.name:void 0})})]}),t.jsxs(a.Row,{className:"u-no-padding",children:[e.values.type!=="ubuntu-snapshot"&&t.jsx(a.Col,{size:6,medium:3,small:2,children:t.jsx(a.Select,{label:"Mirror GPG key",options:[{label:"Select mirror GPG key",value:""},...v.filter(({has_secret:r})=>!r).map(({name:r})=>({label:r,value:r}))],...e.getFieldProps("mirror_gpg_key"),error:e.touched.mirror_gpg_key&&e.errors.mirror_gpg_key?e.errors.mirror_gpg_key:void 0,help:"If none is given, the stock Ubuntu archive one will be used."})}),t.jsx(a.Col,{size:6,medium:3,small:2,children:t.jsx(a.Select,{label:"GPG key",required:e.values.hasPockets,options:[{label:"Select GPG key",value:""},...v.filter(({has_secret:r})=>r).map(({name:r})=>({label:r,value:r}))],...e.getFieldProps("gpg_key"),error:e.touched.gpg_key&&e.errors.gpg_key?e.errors.gpg_key:void 0})})]}),["ubuntu","ubuntu-snapshot"].includes(e.values.type)&&t.jsxs(t.Fragment,{children:[t.jsx(F,{label:"Pockets",style:{marginTop:"1.5rem"},options:re,...e.getFieldProps("pockets"),onChange:async r=>{await e.setFieldValue("pockets",r),await e.setFieldValue("hasPockets",!!r.length)},error:e.touched.pockets&&e.errors.pockets?e.errors.pockets:void 0}),t.jsx(F,{label:"Components",required:e.values.hasPockets,options:te,...e.getFieldProps("components"),onChange:async r=>{await e.setFieldValue("components",r)},error:e.touched.components&&e.errors.components?e.errors.components:void 0}),t.jsx(F,{label:"Architectures",required:e.values.hasPockets,options:se,...e.getFieldProps("architectures"),onChange:async r=>{await e.setFieldValue("architectures",r)},error:e.touched.architectures&&e.errors.architectures?e.errors.architectures:void 0})]}),e.values.type==="third-party"&&t.jsxs(t.Fragment,{children:[t.jsx(a.Input,{type:"text",label:"Pockets",placeholder:"E.g. releases, security, etc.",...e.getFieldProps("pockets"),value:e.values.pockets.join(","),onChange:async r=>{await e.setFieldValue("pockets",r.target.value.replace(/\s/g,"").split(",")),await e.setFieldValue("hasPockets",!!r.target.value)},error:e.touched.pockets&&e.errors.pockets?e.errors.pockets:void 0,help:"List the pocket names separated by commas"}),t.jsx(a.Input,{type:"text",label:"Components",required:e.values.hasPockets,placeholder:"E.g. main, universe, etc.",...e.getFieldProps("components"),value:e.values.components.join(","),onChange:async r=>{await e.setFieldValue("components",r.target.value.replace(/\s/g,"").split(","))},error:e.touched.components&&e.errors.components?e.errors.components:void 0,help:"List the component names separated by commas"}),t.jsx(a.Input,{type:"text",label:"Architectures",required:e.values.hasPockets,placeholder:"E.g. amd64, riscv, etc.",...e.getFieldProps("architectures"),value:e.values.architectures.join(","),onChange:async r=>{await e.setFieldValue("architectures",r.target.value.replace(/\s/g,"").split(","))},error:e.touched.architectures&&e.errors.architectures?e.errors.architectures:void 0,help:"List the architectures separated by commas"})]}),t.jsx(Y,{formik:e}),t.jsx(J,{submitButtonDisabled:e.isSubmitting,submitButtonText:p})]})};export{Se as default};
