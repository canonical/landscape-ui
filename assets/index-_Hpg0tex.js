import{b as P,e as R,f as A,G as w,Q as L,H as j,au as C,J as c,a9 as E,p as N,n as O,q as W,s as B,j as o,d as n,t as r}from"./index-CMVCy8Ns.js";import{A as U}from"./AssociationBlock-B8Rj3FVM.js";import{C as D}from"./CodeEditor-C1BrRE34.js";import{F as V}from"./FileInput-DKlVPME5.js";import{S as $}from"./SidePanelFormButtons-CAD6cLjp.js";import{u as k}from"./useGetWslInstanceTypes-DGL1F-lr.js";import"./WslInstancesEmptyState-DWBe0kTM.js";import{u as v}from"./useRoles-BLa_9bwp.js";import{M as G,R as M,C as Q,F as z}from"./constants-CGmSpzVx.js";import"./MultiSelectField-BkhgxhXh.js";import"./useGetTags-B-1SZ4oQ.js";import"./index-BW1OyqdW.js";import"./SidePanelFormButtons.module-BuIu-Bem.js";import"./GroupFilter-Bf8xgyFY.js";import"./HeaderWithSearch-C1uzDDUY.js";import"./useExpandableRow-Bm0Hhyuo.js";const H=()=>{const e=P(),i=R(),{isPending:a,mutateAsync:l}=A({mutationFn:async d=>e.post("child-instance-profiles",d),onSuccess:async()=>i.invalidateQueries({queryKey:["wslProfiles"]})});return{isAddingWslProfile:a,addWslProfile:l}},m={add:{notificationAction:"added",ariaLabel:"Add a new WSL profile",buttonLabel:"Add WSL profile"},duplicate:{notificationAction:"duplicated",ariaLabel:"Duplicate WSL profile",buttonLabel:"Duplicate"}},X=()=>w().shape({title:c().required("This field is required"),access_group:c().required("This field is required"),description:c().required("This field is required"),instanceType:c().required("This field is required"),rootfsImage:c().when("instanceType",{is:"custom",then:e=>e.required("This field is required"),otherwise:e=>e.notRequired()}),customImageName:c().when("instanceType",{is:"custom",then:e=>e.required("This field is required").test("not-match-reserved-patterns","Instance name cannot match 'ubuntu', 'ubuntu-preview', or 'ubuntu-<dd>.<dd>'",i=>!M.some(a=>a.test(i.toLowerCase()))),otherwise:e=>e.notRequired()}),cloudInitType:c(),cloudInit:C().nullable().when("cloudInitType",{is:e=>e==="file"||e==="text",then:e=>e.required("This field is required").test("file-size","File size must be less than 1MB",i=>(typeof i=="string"&&(i=p(i)),i?i.size===void 0?!1:i.size<=G*1024*1024:!0)),otherwise:e=>e.notRequired()}),all_computers:j(),tags:L().of(c())}),J=e=>e.action==="add"?{title:"",access_group:E,description:"",instanceType:"",customImageName:"",rootfsImage:"",cloudInitType:"",cloudInit:null,all_computers:!1,tags:[]}:{title:`${e.profile.title} (copy)`,access_group:e.profile.access_group,all_computers:e.profile.all_computers,cloudInit:null,cloudInitType:"",description:e.profile.description,tags:e.profile.tags,customImageName:e.profile.image_source?e.profile.image_name:"",instanceType:e.profile.image_source?"custom":e.profile.image_name,rootfsImage:e.profile.image_source||""},p=e=>{const i=new Blob([e],{type:"application/x-yaml"});return new File([i],"myFile.yaml",{type:"application/x-yaml"})},K=e=>{if(e)return new Promise((i,a)=>{const l=new FileReader;l.readAsDataURL(e),l.onload=()=>{i(l.result)},l.onerror=d=>{a(d)}})},Z=async e=>{if(e===null)return;let i;typeof e=="string"?i=p(e):i=e;const a=await K(i);return a?a.split(",")[1]:void 0},Y="_block_tz139_1",ee={block:Y},be=e=>{const i=N(),{closeSidePanel:a}=O(),{notify:l}=W(),{getAccessGroupQuery:d}=v(),{addWslProfile:f}=H(),{data:g}=d(),{isGettingWslInstanceTypes:y,wslInstanceTypes:I}=k(),b=I.map(({label:s,name:u})=>({label:s,value:u}))||[],h=[{label:"Select",value:""},...b,{label:"From URL",value:"custom"}],T=g?.data.map(({name:s,title:u})=>({label:u,value:s}))??[],_=async s=>{try{const u=await Z(s.cloudInit),S=(await f({title:s.title,access_group:s.access_group,description:s.description,image_name:s.instanceType==="custom"?s.customImageName:s.instanceType,image_source:s.rootfsImage,cloud_init_contents:u,all_computers:s.all_computers,tags:s.tags})).data.computers.constrained.length;a();const q=e.action==="add"?s.title:e.profile.title;l.success({title:`Profile "${q}" ${m[e.action].notificationAction} successfully`,message:`It has been associated with ${S} instances`})}catch(u){i(u)}},t=B({initialValues:J(e),onSubmit:_,validationSchema:X()}),F=async s=>{await t.setFieldValue("cloudInit",s[0])},x=async()=>{await t.setFieldValue("cloudInit",null)};return o.jsxs(n.Form,{onSubmit:t.handleSubmit,noValidate:!0,children:[o.jsx(n.Input,{type:"text",label:"Title",required:!0,...t.getFieldProps("title"),error:r(t,"title")}),o.jsx(n.Input,{type:"text",label:"Description",required:!0,...t.getFieldProps("description"),error:r(t,"description")}),o.jsx(n.Select,{label:"Access group","aria-label":"Access group",required:!0,options:T,...t.getFieldProps("access_group"),error:r(t,"access_group")}),o.jsxs("div",{className:ee.block,children:[(t.values.instanceType!==""||t.values.cloudInitType!=="")&&o.jsx(n.Notification,{severity:"caution",title:"Warning",children:o.jsx("span",{children:"Once the profile is added, you cannot modify the rootfs image or cloud-init file."})}),o.jsx(n.Select,{label:"Rootfs image",disabled:y,"aria-label":"Rootfs image",options:h,required:!0,...t.getFieldProps("instanceType"),error:r(t,"instanceType")}),t.values.instanceType==="custom"&&o.jsxs(o.Fragment,{children:[o.jsx(n.Input,{label:"Image name",type:"text",required:!0,...t.getFieldProps("customImageName"),error:r(t,"customImageName")}),o.jsx(n.Input,{type:"text",label:"Rootfs image URL",required:!0,...t.getFieldProps("rootfsImage"),error:r(t,"rootfsImage"),help:"The file path must be reachable by the affected WSL instances."})]}),o.jsx(n.Select,{label:"Cloud-init","aria-label":"Cloud-init",options:Q,...t.getFieldProps("cloudInitType"),error:r(t,"cloudInitType")}),t.values.cloudInitType==="file"&&o.jsx(V,{label:"Upload cloud-init",labelClassName:"u-off-screen",accept:".yaml",...t.getFieldProps("cloudInit"),onFileRemove:x,onFileUpload:F,help:z,error:r(t,"cloudInit")}),t.values.cloudInitType==="text"&&o.jsx(D,{label:"Cloud-init configuration",onChange:s=>{t.setFieldValue("cloudInit",s??"")},value:t.values.cloudInit??"",language:"yaml",defaultValue:"# paste cloud-init config here",error:r(t,"cloudInit")})]}),o.jsx(U,{formik:t}),o.jsx($,{submitButtonText:m[e.action].buttonLabel,submitButtonAriaLabel:m[e.action].ariaLabel,submitButtonDisabled:t.isSubmitting})]})};export{be as default};
