import{o as j,H as S,n as N,p as k,$ as D,q as I,j as i,d as a,K as d,z as T}from"./index-B0Zx-d4a.js";import{K as A}from"./constants-BKc4RML9.js";import{u as C}from"./index-DRQHsAli.js";import"./PageMain-CsA-pIun.js";import"./useGetInstance-CzhqgRmD.js";import"./useUsns-DkBLdcOJ.js";import"./constants-T53-DHYK.js";import"./SingleInstanceTabs.module-Cm1BYFZQ.js";const E="The kernel will be downgraded and the instance will restart afterwards to apply the change.",F="The kernel will be downgraded. You'll need to restart the instance to apply this change.",R="Downgrading the kernel will expose your system to known security vulnerabilities AND reduce your Livepatch coverage.",B="_radioGroup_1yu2c_1",O="_marginTop_1yu2c_6",l={radioGroup:B,marginTop:O},H=({currentKernelVersion:u,downgradeKernelVersions:t,instanceName:m})=>{const _=j(),{instanceId:v}=S(),{closeSidePanel:s}=N(),{notify:p}=k(),{downgradeKernelQuery:y}=C(),{openActivityDetails:g}=D(),{mutateAsync:h,isPending:o}=y,w=[{label:"Select",value:""},...t.map(r=>({label:r.version_rounded,value:r.id.toString()}))],f={deliver_immediately:!0,randomize_delivery:!1,deliver_delay_window:0,deliver_after:"",new_kernel_version_id:t.length===1?t[0].id.toString():"",reboot_after:!1},e=I({initialValues:f,validationSchema:A,onSubmit:async r=>{try{const{data:n}=await h({id:Number(v),kernel_package_id:Number(r.new_kernel_version_id),reboot_after:r.reboot_after,deliver_after:r.deliver_immediately?void 0:r.deliver_after,deliver_delay_window:r.randomize_delivery?r.deliver_delay_window:void 0});s();const x=r.reboot_after?E:F;p.success({title:`You queued kernel downgrade for instance "${m}"`,message:x,actions:[{label:"View details",onClick:()=>{g(n)}}]})}catch(n){_(n)}}}),c=async r=>{const n=r.currentTarget.value==="true";await e.setFieldValue("deliver_immediately",n),n||await e.setFieldValue("deliver_after",T().toISOString().slice(0,16))},b=async()=>{await e.setFieldValue("reboot_after",!0),e.handleSubmit()};return i.jsxs(a.Form,{onSubmit:e.handleSubmit,children:[i.jsx(a.Notification,{severity:"caution",title:"Security warning",children:i.jsx("span",{children:R})}),i.jsxs(d,{spaced:!0,children:[i.jsx(d.Item,{label:"Current version",value:u}),i.jsx(d.Item,{label:"Kernel version",value:t.length===1?i.jsx("span",{children:t[0].version_rounded}):i.jsx(a.Select,{options:w,...e.getFieldProps("new_kernel_version_id")})})]}),i.jsx("strong",{className:l.marginTop,children:"Delivery time"}),i.jsxs("div",{className:l.radioGroup,children:[i.jsx(a.Input,{type:"radio",label:"As soon as possible",name:"deliver_immediately",value:"true",onChange:c,checked:e.values.deliver_immediately}),i.jsx(a.Input,{type:"radio",label:"Scheduled",name:"deliver_immediately",value:"false",onChange:c,checked:!e.values.deliver_immediately})]}),!e.values.deliver_immediately&&i.jsx(a.Input,{type:"datetime-local",label:"Deliver after",labelClassName:"u-off-screen",...e.getFieldProps("deliver_after"),error:e.touched.deliver_after&&e.errors.deliver_after?e.errors.deliver_after:void 0}),i.jsx("strong",{className:l.marginTop,children:"Randomise delivery over a time window"}),i.jsxs("div",{className:l.radioGroup,children:[i.jsx(a.Input,{type:"radio",label:"No",...e.getFieldProps("randomize_delivery"),onChange:async()=>{await e.setFieldValue("randomize_delivery",!1),await e.setFieldValue("deliver_delay_window",0)},checked:!e.values.randomize_delivery}),i.jsx(a.Input,{type:"radio",label:"Yes",...e.getFieldProps("randomize_delivery"),onChange:async()=>await e.setFieldValue("randomize_delivery",!0),checked:e.values.randomize_delivery})]}),e.values.randomize_delivery&&i.jsx(a.Input,{type:"number",inputMode:"numeric",min:0,label:"Delivery delay window",labelClassName:"u-off-screen",help:"Time in minutes",...e.getFieldProps("deliver_delay_window"),error:e.touched.deliver_delay_window&&e.errors.deliver_delay_window?e.errors.deliver_delay_window:void 0}),i.jsxs("div",{className:"form-buttons",children:[i.jsx(a.Button,{type:"button",appearance:"base",onClick:s,children:"Cancel"}),i.jsx(a.ConfirmationButton,{type:"button",confirmationModalProps:{title:"Downgrading kernel and restarting instance",children:i.jsx("p",{children:"Are you sure? This action will downgrade the kernel and restart the instance."}),confirmButtonLabel:"Downgrade and Restart",confirmButtonAppearance:"negative",confirmButtonLoading:o,confirmButtonDisabled:o,onConfirm:b},children:"Downgrade and Restart"}),i.jsx(a.ConfirmationButton,{type:"button",appearance:"negative",confirmationModalProps:{title:"Downgrading kernel",children:i.jsx("p",{children:"Are you sure? This action will downgrade the kernel."}),confirmButtonLabel:"Downgrade",confirmButtonAppearance:"negative",confirmButtonLoading:o,confirmButtonDisabled:o,onConfirm:()=>{e.handleSubmit()}},children:"Downgrade kernel"})]})]})};export{H as default};
