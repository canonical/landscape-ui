import{j as t,p as m,r as l,L as x,R as h,e as b,l as f,f as j,g as L}from"./index-Cgvo6fQq.js";import{u as U,a as y}from"./useUsns-DMX7wpnB.js";import{S as $}from"./SidePanelFormButtons-BVcav9Rr.js";import{U as S,E as k}from"./UsnList-CgCCIsmm.js";import"./helpers-BfuBH7Ij.js";import"./useFetchOld-CDdL40Ij.js";import"./useMutation-BlYl6rGT.js";import"./useQuery-BkysfzoD.js";import"./SidePanelFormButtons.module-DyBJG5lm.js";import"./moment-Ca7bd7oO.js";import"./TruncatedCell-Cgvmf07L.js";import"./ExpandableTableFooter-Dj7HdtRq.js";import"./ExpandableTableFooter.module-C3W6TVe_.js";import"./useConfirm-CH1qaKO5.js";import"./usePageParams-C_58JMDS.js";import"./useOnClickOutside-C8-jCCi3.js";const C=({instanceIds:e})=>{const{getUsnsQuery:n}=U(),{data:r,isLoading:i}=n({computer_ids:e,show_packages:!1},{enabled:e.length>0});return t.jsxs(t.Fragment,{children:[i&&t.jsx(m,{}),!i&&(!r||r.data.results.length===0)&&null,!i&&r&&r.data.results.length>0&&t.jsx(S,{tableType:"expandable",instanceIds:e,isUsnsLoading:i,usns:r.data.results})]})},q=({instances:e})=>{const[n,r]=l.useState(5),i=l.useMemo(()=>e.slice(0,n),[e,n]),d=l.useMemo(()=>[{accessor:"title",Header:"Instance",Cell:({row:s})=>t.jsx(x,{className:"u-no-margin--bottom u-no-padding--top",to:{pathname:`${h}instances/${s.original.parent?`${s.original.parent.id}/${s.original.id}`:s.original.id}`,search:"?tab=packages&filter=upgrade"},state:{selectAll:!0},children:s.original.title})},{accessor:"security_upgrades",Header:"Security upgrades",Cell:({row:s})=>{var a;return t.jsx(t.Fragment,{children:(a=s.original.upgrades)==null?void 0:a.security})}},{accessor:"upgrades",Header:"Regular upgrades",Cell:({row:s})=>{var a;return t.jsx(t.Fragment,{children:(a=s.original.upgrades)==null?void 0:a.regular})}}],[e.length]);return t.jsx(k,{columns:d,data:i,limit:n,onLimitChange:()=>r(s=>s+5),itemNames:{plural:"instances",singular:"instance"},title:"Affected instances",totalCount:e.length})},A=({selectedInstances:e})=>{const n=b(),{notify:r}=f(),{closeSidePanel:i}=j(),{getPackagesQuery:d,upgradePackagesQuery:s}=y(),{data:a}=d({query:`id:${e.map(({id:o})=>o).join(" OR id:")}`,upgrade:!0}),{mutateAsync:p,isLoading:g}=s,c=async o=>{o.preventDefault();try{await p({query:`id:${e.map(({id:u})=>u).join(" OR id:")}`,packages:((a==null?void 0:a.data.results)??[]).map(({name:u})=>u)}),i(),r.success({title:`You queued ${a==null?void 0:a.data.count} packages to be upgraded`,message:`${a==null?void 0:a.data.count} packages on ${e.length} instances will be upgraded and are queued in Activities`})}catch(u){n(u)}};return t.jsxs(L.Form,{onSubmit:c,children:[t.jsx(C,{instanceIds:e.map(({id:o})=>o)}),t.jsx(q,{instances:e}),t.jsx($,{submitButtonDisabled:g,submitButtonText:"Request all upgrades"})]})},J=A;export{J as default};
