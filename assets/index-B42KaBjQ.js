const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-F4IiGvSD.js","assets/index-DgVvgk8h.js","assets/index-Dkc_mJ0y.css","assets/SidePanelFormButtons-CqY3VqYF.js","assets/SidePanelFormButtons.module-D2P5PizG.js","assets/SidePanelFormButtons-JM1G8Sq6.css","assets/MultiSelectField-CVob7neQ.js","assets/MultiSelectField-GyNA33om.css","assets/helpers-Be9Zs7rV.js","assets/ResponsiveButtons-B0er81Vg.js","assets/ResponsiveButtons-C56n2q_V.css","assets/HeaderWithSearch-BBY8vib7.js","assets/HeaderWithSearch-C2lwo0VI.css","assets/index-0dnzw1Wq.js"])))=>i.map(i=>d[i]);
import{c as G,r as h,i as re,f as ae,g as f,h as P,P as B,A as H,k as N,C as ce,J as ue,M as x,R as ie,j as e,n as r,B as le,o as L,p as I,a0 as Q,ao as de,ah as M,N as me,ap as pe,aq as he,E as ge,L as ye,av as be}from"./index-DgVvgk8h.js";import{S as xe}from"./SidePanelFormButtons-CqY3VqYF.js";import{g as ke,r as q,U as O,a as fe}from"./helpers-Be9Zs7rV.js";import{R as je}from"./ResponsiveButtons-B0er81Vg.js";import{H as we}from"./HeaderWithSearch-BBY8vib7.js";const A=5e3;function Ue({data:s,sortFunctions:n}){const{sortBy:c,sort:i}=G();return h.useMemo(()=>{const l=n[c];return!c||!i||!l?s:s.toSorted((m,g)=>{const p=l(m,g);return i==="asc"?p:-p})},[s,c,i,n])}function $(){const s=re(),n=ae(),c=(t,y={})=>P({queryKey:["users",{...t}],queryFn:async()=>s.get("users",{params:t}),...y}),i=f({mutationKey:["users","new"],mutationFn:async t=>s.post("users",t),onSuccess:async()=>n.invalidateQueries({queryKey:["users"]})}),l=f({mutationKey:["users","edit"],mutationFn:async t=>s.put("users",t),onSuccess:async()=>n.invalidateQueries({queryKey:["users"]})}),m=f({mutationKey:["users","remove"],mutationFn:async t=>s.delete("users",{params:t}),onSuccess:async()=>n.invalidateQueries({queryKey:["users"]})}),g=f({mutationKey:["users","lock"],mutationFn:async t=>s.post("users/lock",t),onSuccess:async()=>n.invalidateQueries({queryKey:["users"]})}),p=f({mutationKey:["users","unlock"],mutationFn:async t=>s.post("users/unlock",t),onSuccess:async()=>n.invalidateQueries({queryKey:["users"]})}),b=(t,y={})=>P({queryKey:["groups",(t==null?void 0:t.computer_id)??""],queryFn:async()=>{if(!t)throw new Error("Missing required parameters");return s.get(`computers/${t.computer_id}/groups`)},...y}),a=(t,y={})=>P({queryKey:["userGroups",(t==null?void 0:t.computer_id)??"",(t==null?void 0:t.username)??""],queryFn:async()=>{if(!t)throw new Error("Missing required parameters");return s.get(`computers/${t.computer_id}/users/${t.username}/groups`)},...y}),u=f({mutationKey:["groups","add"],mutationFn:async t=>s.post(`computers/${t.computer_id}/usergroups/update_bulk`,t),onSuccess:async()=>n.invalidateQueries({queryKey:["users"]})}),o=f({mutationKey:["groups","remove"],mutationFn:async t=>s.post(`computers/${t.computer_id}/usergroups/update_bulk`,t),onSuccess:async()=>n.invalidateQueries({queryKey:["users"]})});return{getUsersQuery:c,getGroupsQuery:b,getUserGroupsQuery:a,createUserQuery:i,removeUserQuery:m,editUserQuery:l,lockUserQuery:g,unlockUserQuery:p,addUserToGroupQuery:u,removeUserFromGroupQuery:o}}const _e="_actions_1l3g0_1",Ce={actions:_e},R=()=>{const{instanceId:s}=B(),n=H(),{closeSidePanel:c}=N(),{createUserQuery:i,getGroupsQuery:l}=$(),m=Number(s),{mutateAsync:g}=i,{data:p,isLoading:b}=l({computer_id:m}),u=((p==null?void 0:p.data.groups)??[]).map(t=>({label:t.name,value:t.name})),o=ce({initialValues:{name:"",username:"",password:"",confirmPassword:"",requirePasswordReset:!1,location:"",homePhoneNumber:"",workPhoneNumber:"",primaryGroupValue:""},validationSchema:ue().shape({name:x().required("This field is required"),username:x().required("This field is required"),password:x().required("This field is required"),confirmPassword:x().required("This field is required").oneOf([ie("password"),""],"Passwords must match"),location:x(),homePhoneNumber:x(),workPhoneNumber:x(),primaryGroupValue:x().required("This field is required")}),onSubmit:async t=>{try{await g({computer_ids:[m],name:t.name,username:t.username,password:t.password,require_password_reset:t.requirePasswordReset,location:t.location,home_phone:t.homePhoneNumber,work_phone:t.workPhoneNumber,primary_groupname:t.primaryGroupValue}),c()}catch(y){n(y)}}});return e.jsxs(r.Form,{noValidate:!0,onSubmit:o.handleSubmit,name:"add-new-user",children:[e.jsx(r.Input,{type:"text",label:"Username",autoComplete:"new-username",required:!0,error:o.touched.username&&o.errors.username?o.errors.username:void 0,...o.getFieldProps("username")}),e.jsx(r.Input,{type:"text",label:"Name",required:!0,error:o.touched.name&&o.errors.name?o.errors.name:void 0,...o.getFieldProps("name")}),e.jsx(r.Input,{type:"password",label:"Passphrase",autoComplete:"new-password",required:!0,error:o.touched.password&&o.errors.password?o.errors.password:void 0,...o.getFieldProps("password")}),e.jsx(r.Input,{type:"password",label:"Confirm passphrase",autoComplete:"new-password",required:!0,error:o.touched.confirmPassword&&o.errors.confirmPassword?o.errors.confirmPassword:void 0,...o.getFieldProps("confirmPassword")}),e.jsx(r.Input,{type:"checkbox",label:"Require passphrase reset",help:"User must change password at first login.",...o.getFieldProps("requirePasswordReset"),checked:o.values.requirePasswordReset}),e.jsx(r.Select,{label:"Primary Group",disabled:b,options:[{label:"Select",value:""},...u],...o.getFieldProps("primaryGroupValue"),error:o.touched.primaryGroupValue&&o.errors.primaryGroupValue?o.errors.primaryGroupValue:void 0}),e.jsx(r.Input,{type:"text",label:"Location",error:o.touched.location&&o.errors.location?o.errors.location:void 0,...o.getFieldProps("location")}),e.jsx(r.Input,{type:"text",label:"Home phone",error:o.touched.homePhoneNumber&&o.errors.homePhoneNumber?o.errors.homePhoneNumber:void 0,...o.getFieldProps("homePhoneNumber")}),e.jsx(r.Input,{type:"text",label:"Work phone",error:o.touched.workPhoneNumber&&o.errors.workPhoneNumber?o.errors.workPhoneNumber:void 0,...o.getFieldProps("workPhoneNumber")}),e.jsx(xe,{submitButtonDisabled:o.isSubmitting,submitButtonText:"Add user"})]})},Se=h.lazy(async()=>Q(()=>import("./index-F4IiGvSD.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12]))),Ie=({selectedUsers:s,handleClearSelection:n,sidePanel:c=!1})=>{const[i,l]=h.useState(!1),{instanceId:m}=B(),g=H(),{notify:p}=le(),{setSidePanelContent:b,closeSidePanel:a}=N(),{removeUserQuery:u,lockUserQuery:o,unlockUserQuery:t}=$(),[y,j]=h.useState(!1),[v,k]=h.useState(!1),[C,S]=h.useState(!1),{mutateAsync:w,isPending:U}=u,{mutateAsync:V,isPending:E}=o,{mutateAsync:z,isPending:D}=t,W=Number(m),d=s.length===1?s[0]:void 0,{locked:Y,unlocked:J}=ke(s),F=async(_,T)=>{try{await _({computer_ids:[W],usernames:fe(s),delete_home:T==="removed"?i:void 0}),n&&n(),a(),p.success({message:`Successfully requested to be ${T}`})}catch(ne){g(ne)}},X=async()=>{await F(V,"locked")},Z=async()=>{await F(z,"unlocked")},ee=async()=>{await F(w,"removed")},se=()=>{b("Add new user",e.jsx(R,{}))},te=_=>{b("Edit user",e.jsx(h.Suspense,{fallback:e.jsx(I,{}),children:e.jsx(Se,{user:_})}))},oe=()=>{l(_=>!_)};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:L("p-panel__controls u-no-padding--top",{"u-no-margin--left":c}),children:[!c&&e.jsxs(r.Button,{className:L("u-no-margin--right",{"u-no-margin--bottom":!c}),type:"button",hasIcon:!0,onClick:se,children:[e.jsx(r.Icon,{name:r.ICONS.plus}),e.jsx("span",{children:"Add user"})]}),e.jsx(je,{collapseFrom:c?void 0:"lg",buttons:[((d==null?void 0:d.enabled)||!c)&&e.jsxs(r.Button,{hasIcon:!0,type:"button",disabled:J===0,onClick:()=>{j(!0)},children:[e.jsx(r.Icon,{name:"lock-locked"}),e.jsx("span",{children:"Lock"})]},"lock"),(!(d!=null&&d.enabled)||!c)&&e.jsxs(r.Button,{hasIcon:!0,type:"button",disabled:Y===0,onClick:()=>{k(!0)},children:[e.jsx(r.Icon,{name:"lock-unlock"}),e.jsx("span",{children:"Unlock"})]},"unlock"),c&&d&&e.jsxs(r.Button,{className:L("p-segmented-control__button has-icon",{"u-no-margin--bottom":!c}),type:"button",onClick:()=>{te(d)},children:[e.jsx(r.Icon,{name:"edit"}),e.jsx("span",{children:"Edit"})]},"edit"),e.jsxs(r.Button,{hasIcon:!0,type:"button",disabled:s.length===0,onClick:()=>{S(!0)},children:[e.jsx(r.Icon,{name:r.ICONS.delete}),e.jsx("span",{children:"Delete"})]},"delete")]})]}),y&&e.jsx(r.ConfirmationModal,{title:`Lock ${d?`user ${d.username}`:`${s.length} users`}`,close:()=>{j(!1)},confirmButtonLabel:"Lock",confirmButtonAppearance:"positive",confirmButtonLoading:E,confirmButtonDisabled:E,onConfirm:X,children:q({user:d,selectedUsers:s,userAction:O.Lock})}),v&&e.jsx(r.ConfirmationModal,{title:`Unlock ${d?`user ${d.username}`:`${s.length} users`}`,close:()=>{k(!1)},confirmButtonLabel:"Unlock",confirmButtonAppearance:"positive",confirmButtonLoading:D,confirmButtonDisabled:D,onConfirm:Z,children:q({user:d,selectedUsers:s,userAction:O.Unlock})}),C&&e.jsx(r.ConfirmationModal,{title:`Delete ${d?d.username:"users"}`,close:()=>{S(!1)},confirmButtonLabel:"Delete",confirmButtonAppearance:"negative",confirmButtonLoading:U,confirmButtonDisabled:U,onConfirm:ee,children:e.jsxs("div",{children:[e.jsx("p",{className:"u-no-margin--bottom",children:d?`This will delete user ${d.username}. You can delete this user's home folders at the same time.`:"This will delete selected users. You can delete their home folders as well."}),e.jsx(r.Input,{label:"Delete the home folders as well",type:"checkbox",checked:i,onChange:oe})]})})]})},Ne=(s,n)=>s.filter(c=>n.includes(c.uid)),ve=({selected:s,handleClearSelection:n,users:c})=>e.jsxs(e.Fragment,{children:[e.jsx(we,{actions:e.jsx("div",{className:Ce.actions,children:e.jsx(Ie,{handleClearSelection:n,selectedUsers:Ne(c,s)})})}),e.jsx(de,{filtersToDisplay:["search"]})]}),Fe={username:(s,n)=>s.username.localeCompare(n.username),status:(s,n)=>Number(s.enabled)-Number(n.enabled),name:(s,n)=>(s.name||"").localeCompare(n.name||""),uid:(s,n)=>s.uid-n.uid},Pe="_status_xcrdk_1",Le="_statusCell_xcrdk_7",K={status:Pe,statusCell:Le},Ae=h.lazy(async()=>Q(()=>import("./index-F4IiGvSD.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12]))),Be=h.lazy(async()=>Q(()=>import("./index-0dnzw1Wq.js"),__vite__mapDeps([13,1,2,3,4,5,8,9,10,11,12]))),Qe=({users:s,selected:n,setSelected:c})=>{const{setSidePanelContent:i}=N(),l=a=>{i("Edit user",e.jsx(h.Suspense,{fallback:e.jsx(I,{}),children:e.jsx(Ae,{user:a})}))},m=a=>{i("User details",e.jsx(h.Suspense,{fallback:e.jsx(I,{}),children:e.jsx(Be,{user:a})}))},g=()=>{c(n.length!==0?[]:s.map(({uid:a})=>a))},p=a=>{n.includes(a)?c(n.filter(u=>u!==a)):c([...n,a])},b=h.useMemo(()=>[{accessor:"checkbox",className:"checkbox-column",Header:e.jsx(r.CheckboxInput,{label:e.jsx("span",{className:"u-off-screen",children:"Toggle all"}),labelClassName:"u-no-margin--bottom u-no-padding--top",onChange:g,checked:s.length>0&&n.length===s.length,indeterminate:n.length>0&&n.length<s.length,disabled:s.length===0}),Cell:({row:{original:a}})=>e.jsx(r.CheckboxInput,{inline:!0,label:e.jsxs("span",{className:"u-off-screen",children:["Select user ",a.username]}),disabled:s.length===0,checked:n.includes(a.uid),onChange:()=>{p(a.uid)}})},{Header:"username",role:"rowheader",Cell:({row:{original:a}})=>e.jsx(r.Button,{type:"button",appearance:"link",className:"u-no-margin--bottom u-no-padding--top",onClick:()=>{m(a)},"aria-label":`Show details of user ${a.username}`,children:a.username})},{Header:"status",className:K.statusCell,Cell:({row:{original:a}})=>e.jsx("div",{className:K.status,children:a.enabled?e.jsxs(e.Fragment,{children:[e.jsx(r.Icon,{name:"lock-unlock"}),e.jsx("span",{children:"Unlocked"})]}):e.jsxs(e.Fragment,{children:[e.jsx(r.Icon,{name:"lock-locked-active"}),e.jsx("span",{children:"Locked"})]})})},{Header:"UID",accessor:"uid"},{Header:"Full name",Cell:({row:{original:a}})=>a.name||e.jsx(me,{})},{Header:M.Header,className:M.className,Cell:({row:{original:a}})=>e.jsx(pe,{toggleAriaLabel:`"${a.name}" user actions`,actions:[{icon:"edit",label:"Edit","aria-label":`Edit "${a.name}" user`,onClick:()=>{l(a)}}]})}],[s,n]);return e.jsx(he,{columns:b,data:s,emptyMsg:"No users available"})},$e=(s,n)=>s?n.filter(({username:c,name:i})=>{const l=i==null?void 0:i.toUpperCase().includes(s.toUpperCase()),m=c.toUpperCase().includes(s.toUpperCase());return l||m}):n,Ee="_link_1wvsk_1",De={link:Ee},Te=()=>{const[s,n]=h.useState([]),{instanceId:c,childInstanceId:i}=B(),{search:l,currentPage:m,pageSize:g}=G(),{setSidePanelContent:p}=N(),{getUsersQuery:b}=$(),a=Number(i??c),{data:u,isLoading:o}=b({computer_id:a,limit:A}),t=(u==null?void 0:u.data.results)??[],y=Ue({data:t,sortFunctions:Fe}),j=$e(l,y),v=(w,U)=>j.slice(U,U+w),k=h.useMemo(()=>v(g,(m-1)*g),[l,j,m,g]),C=()=>{n([])},S=()=>{p("Add new user",e.jsx(R,{}))};return e.jsxs(e.Fragment,{children:[!l&&o&&e.jsx(I,{}),!o&&!l&&(!u||u.data.results.length===0)&&e.jsx(ge,{title:"No users found",body:"Add new users by clicking the button below.",icon:"connected",cta:[e.jsx(r.Button,{type:"button",appearance:"positive",onClick:S,children:"Add user"},"empty-state-add-new-user")]}),(l||!o&&k.length>0)&&e.jsxs(e.Fragment,{children:[e.jsx(ve,{selected:s,handleClearSelection:C,users:k}),(u==null?void 0:u.data.count)&&u.data.count>A&&e.jsx(r.Notification,{severity:"caution",title:`Fetched ${A} out of ${u==null?void 0:u.data.count} users`,children:e.jsxs("span",{children:["The number of requested users is too high. Please"," ",e.jsx(ye,{to:"https://support-portal.canonical.com/",className:De.link,children:"contact our support team."})]})}),e.jsx(Qe,{selected:s,setSelected:w=>{n(w)},users:k})]}),e.jsx(be,{handleClearSelection:C,totalItems:j.length,currentItemCount:k.length})]})},He=Object.freeze(Object.defineProperty({__proto__:null,default:Te},Symbol.toStringTag,{value:"Module"}));export{Ie as U,He as i,$ as u};
