import{r as w,j as t,a as D,A as M,B as $,c as L,P as B,n as d,p as E,l as S,aA as F,N,as as v,D as V,o as P,aq as q,av as O}from"./index-B1w7_YBY.js";import{E as j,S as Y}from"./SelectAllButton-CpXH2ZuP.js";import{u as R}from"./useUsns-DpdOVpYA.js";const Q=({column:e})=>{const a={};return e.id==="title"?a.role="rowheader":e.id==="upgrades.security"&&(a["aria-label"]="Affected packages"),a},x="_security_16o7z_1",z={security:x},W=({instances:e,limit:a,onLimitChange:l,usn:i,usnPackages:r})=>{const o=w.useMemo(()=>e.filter(({id:s})=>r.flatMap(({computer_ids:f})=>f).includes(s)).slice(0,a),[e,a,r]),c=w.useMemo(()=>[{accessor:"title",Header:"Name"},{accessor:"upgrades.security",className:z.security,Header:"Affected packages",Cell:({row:{original:s}})=>r.filter(({computer_ids:f})=>f.includes(s.id)).length}],[o.length]);return t.jsx(j,{columns:c,data:o,itemNames:{plural:"instances",singular:"instance"},onLimitChange:l,totalCount:o.length,title:t.jsxs("p",{className:"p-heading--4",children:["Instances affected by ",t.jsx("b",{children:i})]}),getCellProps:Q})},G=({instanceTitle:e,usn:a})=>{const l=D(),i=M(),{notify:r}=$(),{removeUsnPackagesQuery:o}=R(),{setPageParams:c}=L(),{instanceId:s,childInstanceId:f}=B(),_=Number(s),{mutateAsync:p,isPending:m}=o,b=()=>{l(`/instances/${f?`${_}/${f}`:`${_}`}`),c({tab:"activities"}),r.clear()},k=async()=>{try{await p({usns:a,instanceId:_}),r.success({title:"You queued packages to be uninstalled",message:`Packages affected by "${a}" security issue will be uninstalled and are queued in Activities.`,actions:[{label:"View details",onClick:b}]})}catch(y){i(y)}};return t.jsxs(d.ConfirmationButton,{type:"button",className:"is-small is-dense has-icon",confirmationModalProps:{title:"Uninstall USN packages",children:t.jsxs("p",{children:['This will uninstall packages affected by "',a,'" security issue from the "',e,'" instance.']}),confirmButtonLabel:"Uninstall",confirmButtonAppearance:"negative",confirmButtonDisabled:m,confirmButtonLoading:m,onConfirm:k},children:[t.jsx(d.Icon,{name:"delete",className:"u-no-margin--left"}),t.jsx("span",{children:"Uninstall packages"})]},"remove")},J=({column:e})=>{const a={};return e.id==="name"?a.role="rowheader":e.id==="current_version"?a["aria-label"]="Current version":e.id==="new_version"?a["aria-label"]="New version":e.id==="summary"&&(a["aria-label"]="Details"),a},K=({instanceTitle:e,limit:a,onLimitChange:l,showRemoveButton:i,usn:r,usnPackages:o})=>{const c=w.useMemo(()=>o.slice(0,a),[a,o]),s=w.useMemo(()=>[{accessor:"name",Header:"Package"},{accessor:"current_version",Header:"Current version"},{accessor:"new_version",Header:"New version"},{accessor:"summary",Header:"Details"}],[c.length]);return t.jsx(j,{additionalCta:i&&t.jsx(G,{instanceTitle:e,usn:r}),columns:s,data:c,itemNames:{plural:"packages",singular:"package"},onLimitChange:l,title:t.jsxs("p",{className:"p-heading--4",children:["Packages affected by ",t.jsx("b",{children:r})]}),totalCount:o.length,getCellProps:J})},U=({instances:e,isRemovable:a,listType:l,usn:i})=>{const[r,o]=w.useState(5),{getAffectedPackagesQuery:c}=R(),{instanceId:s}=B(),f=Number(s),{data:_,isLoading:p}=c({usn:i,computer_ids:a?[f]:e.map(({id:b})=>b)}),m=(_==null?void 0:_.data)??[];return t.jsxs(t.Fragment,{children:[p&&t.jsx(E,{}),!p&&l==="instances"&&t.jsx(W,{instances:e,limit:r,onLimitChange:()=>o(b=>b+5),usn:i,usnPackages:m}),!p&&l==="packages"&&t.jsx(K,{instanceTitle:e[0].title,limit:r,onLimitChange:()=>o(b=>b+5),showRemoveButton:a,usn:i,usnPackages:m})]})},T={computers_count:0,cves:[],date:"",info:"",packages:[],usn:"",usn_link:""},X="_expanded_5yjr4_1",Z="_expandButton_5yjr4_19",C="_hidden_5yjr4_28",ee="_innerTable_5yjr4_32",se="_row_5yjr4_36",ae="_cve_5yjr4_42",te="_cveLink_5yjr4_46",ce="_wrapper_5yjr4_50",h={expanded:X,expandButton:Z,hidden:C,innerTable:ee,row:se,cve:ae,cveLink:te,wrapper:ce},ne=({expandedCell:e,isUsnsLoading:a,showSelectAllButton:l,usns:i})=>{const r=(e==null?void 0:e.column)==="computers_count"||(e==null?void 0:e.column)==="release_packages"?e.row+1:0;return[...[T].slice(l?0:1),...i.slice(0,r||i.length),...i.slice(r?r-1:i.length),...[T].slice(a?0:1)]},A=({expandedCell:e,isUsnsLoading:a,lastUsnIndex:l,showSelectAllButton:i})=>({column:r,row:{index:o}})=>{const c={};return i&&o===0||a&&o===l||(e==null?void 0:e.row)===o-1&&["computers_count","release_packages"].includes(e.column)?r.id==="usn"?(c.colSpan=5,(e==null?void 0:e.row)===o-1&&["computers_count","release_packages"].includes(e.column)&&(c.className=h.innerTable)):(c.className=h.hidden,c["aria-hidden"]=!0):r.id==="usn"?c.role="rowheader":r.id==="cves"?(c["aria-label"]="CVE(s)",(e==null?void 0:e.column)===r.id&&e.row===o&&(c.className="expandedCell")):r.id==="date"?c["aria-label"]="Date published":r.id==="computers_count"?(c["aria-label"]="Affected instances",c.className=(e==null?void 0:e.column)===r.id&&e.row===o?h.expanded:h.row):r.id==="release_packages"&&(c["aria-label"]="Affected packages",c.className=(e==null?void 0:e.column)===r.id&&e.row===o?h.expanded:h.row),c},I=e=>({index:a})=>{const l={};return(e==null?void 0:e.column)==="cves"&&e.row===a&&(l.className="expandedRow"),l},re=e=>a=>{a&&(e.current=[...a.querySelectorAll("tbody tr")])},ue=({instances:e,isUsnsLoading:a,onSelectedUsnsChange:l,selectedUsns:i,totalUsnCount:r,usns:o,...c})=>{const[s,f]=w.useState(null),_=w.useRef([]);S({current:(s==null?void 0:s.column)==="cves"?_.current[s.row]:null},()=>{f(null)});const p=c.tableType==="expandable"&&c.showSelectAllButton,m=w.useMemo(()=>ne({expandedCell:s,isUsnsLoading:a,showSelectAllButton:p,usns:o}),[o,s,a,p]),b=n=>{l(i.includes(n)?i.filter(u=>u!==n):[...i,n])},k=(n,u)=>{f(g=>(g==null?void 0:g.column)===n&&g.row===u?null:{column:n,row:g&&["computers_count","release_packages"].includes(g.column)&&g.row<u?u-1:u})},y=w.useMemo(()=>[{accessor:"checkbox",className:"checkbox-column",Header:()=>t.jsx(d.CheckboxInput,{inline:!0,label:t.jsx("span",{className:"u-off-screen",children:"Toggle all security issues"}),disabled:m.length===0||a,indeterminate:i.length>0&&i.length<o.length,checked:i.length>0&&i.length===o.length,onChange:()=>{l(i.length>0?[]:o.map(({usn:n})=>n))}}),Cell:({row:{original:n}})=>t.jsx(d.CheckboxInput,{labelClassName:"u-no-margin--bottom u-no-padding--top",label:t.jsx("span",{className:"u-off-screen",children:`Toggle ${n.usn}`}),disabled:a,name:"usn",checked:i.includes(n.usn),onChange:()=>{b(n.usn)}})},{accessor:"usn",Header:"USN",Cell:({row:{index:n,original:u}})=>n===0&&p?t.jsx(Y,{count:c.totalSelectedUsnCount,itemName:{plural:"security issues",singular:"security issue"},onClick:c.onSelectAllClick,totalCount:r}):(s==null?void 0:s.row)===n-1&&["computers_count","release_packages"].includes(s.column)?t.jsx(U,{isRemovable:s.column==="release_packages"&&c.tableType==="paginated",instances:e,listType:s.column==="release_packages"?"packages":"instances",usn:m[s.row].usn}):a&&n===m.length-1?t.jsx(E,{}):t.jsx("a",{href:u.usn_link,target:"_blank",rel:"nofollow noopener noreferrer",children:u.usn})},{accessor:"cves",Header:"CVE(s)",Cell:({row:{original:n,index:u}})=>n.cves.length>0?t.jsx(F,{content:n.cves.map(({cve:g,cve_link:H})=>t.jsx("span",{className:h.cve,children:t.jsx("a",{href:H,target:"_blank",rel:"nofollow noopener noreferrer",className:h.cveLink,children:g})},g)),isExpanded:(s==null?void 0:s.column)==="cves"&&s.row===u,onExpand:()=>{k("cves",u)}}):t.jsx(N,{})},{accessor:"date",Header:"Date published",Cell:({row:n})=>t.jsx(t.Fragment,{children:v(n.original.date).isValid()?t.jsx("span",{className:"font-monospace",children:v(n.original.date).format(V)}):t.jsx(N,{})})},{accessor:"computers_count",Header:"Affected instances",Cell:({column:n,row:{index:u,original:g}})=>t.jsx(d.Button,{type:"button",className:P("p-accordion__tab",h.expandButton),"aria-expanded":(s==null?void 0:s.column)===n.id&&s.row===u,onClick:()=>{k(n.id,u)},children:g.computers_count})},{accessor:"release_packages",Header:"Affected packages",Cell:({column:n,row:{index:u}})=>t.jsx(d.Button,{type:"button",className:P("p-accordion__tab",h.expandButton),"aria-expanded":(s==null?void 0:s.column)===n.id&&s.row===u,onClick:()=>{k(n.id,u)},children:`${(s==null?void 0:s.column)===n.id&&s.row===u?"Hide":"Show"} packages`})}].filter(({accessor:n})=>c.tableType==="paginated"?n!=="computers_count":n!=="date"),[m,a,i.length,c.tableType,s]);return t.jsx("div",{ref:re(_),className:h.wrapper,children:c.tableType==="expandable"?t.jsx(j,{columns:y,data:m,getCellProps:A({expandedCell:s,isUsnsLoading:a,lastUsnIndex:m.length-1,showSelectAllButton:p}),getRowProps:I(s),itemCount:o.length,itemNames:{plural:"security issues",singular:"security issue"},onLimitChange:c.onNextPageFetch,totalCount:r}):t.jsxs(t.Fragment,{children:[t.jsx(q,{columns:y,data:m,getCellProps:A({expandedCell:s,isUsnsLoading:a}),getRowProps:I(s),emptyMsg:`No security issues found with the search "${c.search}"`}),t.jsx(O,{handleClearSelection:()=>{l([])},totalItems:r,currentItemCount:o.length})]})})};export{ue as U};
