import{f as I,c as _,v as q,w as B,p as b,J as L,i as h,an as u,r as S,y as V,z as k,B as N,C as $,j as e,d as c,L as v,R as x,e as D}from"./index-DYykpNVa.js";import{C as O}from"./CodeEditor-B9M2dPM_.js";import{S as M}from"./SidePanelFormButtons-Aj5ThB2m.js";import{N as H}from"./NoData-CT6SeJUX.js";import{g as p}from"./formikErrors-Bw8iTXYS.js";import{u as K}from"./useEditScript-DpNSceZ8.js";import{u as Q,D as U,S as Y}from"./ScriptFormAttachments-DAnYsFsn.js";import{u as z}from"./useFetchOld-BGD2hIpr.js";import{e as G,h as J,i as W}from"./ScriptsTabs-BrOiXEKJ.js";import"./index-Cbj0Sz5k.js";import"./SidePanelFormButtons.module-CcPyiogC.js";import"./AttachmentFile-Dr_XbZxY.js";import"./TablePagination-CIA4CRba.js";import"./TableFilterChips-DLH4XQ-H.js";import"./helpers-DblkVUdf.js";import"./constants-CXofZZ4i.js";import"./ResponsiveTable-C-8YbfBJ.js";import"./StaticLink-BX9qJBBO.js";import"./TruncatedCell-DQQZxgbr.js";import"./Truncated-DtD6hAHP.js";import"./useExpandableRow-CGDZ27WS.js";import"./useRoles-CK1OAvut.js";import"./TextConfirmationModal-DuGXYB1S.js";import"./PageParamFilter-LH49uHXA.js";import"./TableFilter-C7yTBfOe.js";import"./HeaderWithSearch-DH3OfcZg.js";import"./SingleInstanceTabs.module-DvhuGYYD.js";const X=(t,o={enabled:!0})=>{const l=I(),{data:r,isPending:m}=_({queryKey:["scripts","profiles",t],queryFn:async()=>l.get(`scripts/${t}/script-profiles`),...o});return{associatedScriptProfiles:r?.data.results??[],isAssociatedScriptProfilesLoading:m}},Z=()=>{const t=z(),o=q(),{mutateAsync:l,isPending:r}=B({mutationKey:["scripts","removeAttachment"],mutationFn:async m=>t.get("RemoveScriptAttachment",{params:m}),onSuccess:async()=>o.invalidateQueries({queryKey:["scripts"]})});return{removeScriptAttachment:l,isRemovingScriptAttachment:r}},tt="_modal_1lyuv_1",et={modal:tt},st=()=>b().shape({title:h().required("This field is required"),code:h().required("This field is required"),attachments:b().shape({first:u().nullable(),second:u().nullable(),third:u().nullable(),fourth:u().nullable(),fifth:u().nullable()}),attachmentsToRemove:L().of(h())}),it=t=>({title:t.title,code:G({code:t.code,interpreter:t.interpreter}),time_limit:t.time_limit,username:t.username,attachments:{first:null,second:null,third:null,fourth:null,fifth:null},attachmentsToRemove:[]}),at=t=>{const o=t.lastIndexOf(".");return o!==-1?t.slice(0,o):t},_t=({script:t})=>{const o=S.useRef(null),[l,r]=S.useState(!1),{closeSidePanel:m}=V(),y=k(),{notify:A}=N(),{createScriptAttachment:F}=Q(),{removeScriptAttachment:j}=Z(),{editScript:C,isEditing:f}=K(),{associatedScriptProfiles:g,isAssociatedScriptProfilesLoading:w}=X(t.id,{enabled:l}),P=async s=>{const n=Object.values(s.attachments).filter(a=>a!==null);try{const a=[C(J({scriptId:t.id,values:s}))];if(s.attachmentsToRemove.length)for(const d of s.attachmentsToRemove)a.push(j({script_id:t.id,filename:d}));n.length&&a.push(...await W({attachments:n,createScriptAttachment:F,script_id:t.id})),await Promise.all(a),m(),r(!1),A.success({title:`You have successfully submitted a new version of ${t.title}`,message:"All its associated profiles will now be run using this new version."})}catch(a){r(!1),y(a)}},i=$({initialValues:it(t),validationSchema:st(),onSubmit:P}),T=async({target:{files:s}})=>{const n=s?.[0];if(!n)return;const a=i.setFieldValue("code",await n.text());if(i.values.title){await a;return}await Promise.all([i.setFieldValue("title",at(n.name)),a])},R=async s=>{await i.setFieldValue("code",s)},E=()=>o.current?.click();return e.jsxs(c.Form,{onSubmit:i.handleSubmit,noValidate:!0,children:[e.jsx(c.Input,{type:"text",label:"Title",required:!0,...i.getFieldProps("title"),error:p(i,"title")}),e.jsx("input",{ref:o,className:"u-hide",type:"file",onChange:T}),e.jsx(O,{label:"Code",value:i.values.code,onChange:R,error:p(i,"code"),required:!0,defaultValue:U,headerContent:e.jsxs(c.Button,{className:"u-no-margin--bottom",appearance:"base",hasIcon:!0,onClick:E,type:"button",children:[e.jsx(c.Icon,{name:"upload"}),e.jsx("span",{children:"Populate from file"})]})}),e.jsxs(e.Fragment,{children:[e.jsx("h5",{children:"List of attachments"}),e.jsx("p",{className:"u-text--muted",children:"Attachments that will be sent along with the script. You can attach up to 5 files, for a maximum of 1.00MB. Filenames must be unique. On the client, the attachments will be placed in the directory whose name is accessible through the environment variable LANDSCAPE_ATTACHMENTS. They'll be deleted once the script has been run."})]}),e.jsx(Y,{attachments:i.values.attachments,attachmentsToRemove:i.values.attachmentsToRemove,getFileInputError:s=>p(i,["attachments",s]),initialAttachments:t.attachments,onFileInputChange:s=>async n=>i.setFieldValue(`attachments.${s}`,n.target.files?.[0]??null),onInitialAttachmentDelete:async s=>i.setFieldValue("attachmentsToRemove",[...i.values.attachmentsToRemove,s]),scriptId:t.id}),e.jsx(M,{onSubmit:()=>{r(!0)},submitButtonText:"Submit new version"}),l&&e.jsx(c.ConfirmationModal,{title:`Submit new version of "${t.title}"`,confirmButtonLabel:"Submit new version",onConfirm:()=>{i.handleSubmit()},confirmButtonAppearance:"positive",confirmButtonDisabled:f,confirmButtonLoading:f,close:()=>{r(!1)},className:et.modal,confirmButtonProps:{type:"button"},children:g.length>0?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"All future script runs will be done using the latest version of the code. Submitting these changes will affect the following profiles:"}),e.jsx(c.ModularTable,{columns:[{Header:"active profiles",accessor:"title",Cell:({row:s})=>e.jsx(v,{to:x.scripts.root({tab:"profiles"}),state:{scriptProfileId:s.original.id},target:"_blank",children:s.original.title})},{Header:"associated instances",Cell:({row:s})=>{const n=g.find(d=>d.id===s.original.id),a=n?.computers.num_associated_computers;return w?e.jsx(D,{}):a?e.jsxs(v,{to:x.instances.root({tags:n?.tags}),target:"_blank",children:[a," instance",a>1?"s":""]}):e.jsx(H,{})}}],data:t.script_profiles})]}):e.jsx("p",{children:"All future script runs will be done using the latest version of the code."})})]})};export{_t as default};
