const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-CZ2Z6FhI.js","assets/index-CDk-Jgvr.js","assets/index-B4xaleMR.css","assets/SidePanelFormButtons-CsUGQk2E.js","assets/SidePanelFormButtons.module-BuIu-Bem.js","assets/SidePanelFormButtons-CmV-sWf7.css","assets/MultiSelectField-U-nhLr2F.js","assets/MultiSelectField-CD3NDVCz.css","assets/helpers-DN-Xlfal.js","assets/HeaderWithSearch-lC_PsP2p.js","assets/HeaderWithSearch-C2lwo0VI.css","assets/constants-DRKgEQ0k.js","assets/index-BuNt_icW.js"])))=>i.map(i=>d[i]);
import{k as R,l as p,b as ne,g as ae,h as f,i as F,H as A,o as G,n as I,q as ue,v as ce,x,J as ie,j as e,d as n,p as le,F as q,az as de,A as P,_ as B,am as me,au as pe,ap as he,aq as ye,E as ge,L as be,an as xe}from"./index-CDk-Jgvr.js";import{S as ke}from"./SidePanelFormButtons-CsUGQk2E.js";import{g as fe,r as T,U as M,a as je}from"./helpers-DN-Xlfal.js";import{H as we}from"./HeaderWithSearch-lC_PsP2p.js";import{L as O}from"./constants-DRKgEQ0k.js";const L=5e3;function Ue({data:s,sortFunctions:o}){const{sortBy:u,sort:i}=R();return p.useMemo(()=>{const c=o[u];return!u||!i||!c?s:s.toSorted((l,h)=>{const y=c(l,h);return i==="asc"?y:-y})},[s,u,i,o])}function Q(){const s=ne(),o=ae(),u=(r,g={})=>F({queryKey:["users",{...r}],queryFn:async()=>s.get("users",{params:r}),...g}),i=f({mutationKey:["users","new"],mutationFn:async r=>s.post("users",r),onSuccess:async()=>o.invalidateQueries({queryKey:["users"]})}),c=f({mutationKey:["users","edit"],mutationFn:async r=>s.put("users",r),onSuccess:async()=>o.invalidateQueries({queryKey:["users"]})}),l=f({mutationKey:["users","remove"],mutationFn:async r=>s.delete("users",{params:r}),onSuccess:async()=>o.invalidateQueries({queryKey:["users"]})}),h=f({mutationKey:["users","lock"],mutationFn:async r=>s.post("users/lock",r),onSuccess:async()=>o.invalidateQueries({queryKey:["users"]})}),y=f({mutationKey:["users","unlock"],mutationFn:async r=>s.post("users/unlock",r),onSuccess:async()=>o.invalidateQueries({queryKey:["users"]})}),b=(r,g={})=>F({queryKey:["groups",r?.computer_id??""],queryFn:async()=>{if(!r)throw new Error("Missing required parameters");return s.get(`computers/${r.computer_id}/groups`)},...g}),a=(r,g={})=>F({queryKey:["userGroups",r?.computer_id??"",r?.username??""],queryFn:async()=>{if(!r)throw new Error("Missing required parameters");return s.get(`computers/${r.computer_id}/users/${r.username}/groups`)},...g}),d=f({mutationKey:["groups","add"],mutationFn:async r=>s.post(`computers/${r.computer_id}/usergroups/update_bulk`,r),onSuccess:async()=>o.invalidateQueries({queryKey:["users"]})}),t=f({mutationKey:["groups","remove"],mutationFn:async r=>s.post(`computers/${r.computer_id}/usergroups/update_bulk`,r),onSuccess:async()=>o.invalidateQueries({queryKey:["users"]})});return{getUsersQuery:u,getGroupsQuery:b,getUserGroupsQuery:a,createUserQuery:i,removeUserQuery:l,editUserQuery:c,lockUserQuery:h,unlockUserQuery:y,addUserToGroupQuery:d,removeUserFromGroupQuery:t}}const _e="_actions_1l3g0_1",Ce={actions:_e},H=()=>{const{instanceId:s}=A(),o=G(),{closeSidePanel:u}=I(),{createUserQuery:i,getGroupsQuery:c}=Q(),l=Number(s),{mutateAsync:h}=i,{data:y,isLoading:b}=c({computer_id:l}),d=(y?.data.groups??[]).map(r=>({label:r.name,value:r.name})),t=ue({initialValues:{name:"",username:"",password:"",confirmPassword:"",requirePasswordReset:!1,location:"",homePhoneNumber:"",workPhoneNumber:"",primaryGroupValue:""},validationSchema:ce().shape({name:x().required("This field is required"),username:x().required("This field is required"),password:x().required("This field is required"),confirmPassword:x().required("This field is required").oneOf([ie("password"),""],"Passwords must match"),location:x(),homePhoneNumber:x(),workPhoneNumber:x(),primaryGroupValue:x().required("This field is required")}),onSubmit:async r=>{try{await h({computer_ids:[l],name:r.name,username:r.username,password:r.password,require_password_reset:r.requirePasswordReset,location:r.location,home_phone:r.homePhoneNumber,work_phone:r.workPhoneNumber,primary_groupname:r.primaryGroupValue}),u()}catch(g){o(g)}}});return e.jsxs(n.Form,{noValidate:!0,onSubmit:t.handleSubmit,name:"add-new-user",children:[e.jsx(n.Input,{type:"text",label:"Username",autoComplete:"new-username",required:!0,error:t.touched.username&&t.errors.username?t.errors.username:void 0,...t.getFieldProps("username")}),e.jsx(n.Input,{type:"text",label:"Name",required:!0,error:t.touched.name&&t.errors.name?t.errors.name:void 0,...t.getFieldProps("name")}),e.jsx(n.Input,{type:"password",label:"Passphrase",autoComplete:"new-password",required:!0,error:t.touched.password&&t.errors.password?t.errors.password:void 0,...t.getFieldProps("password")}),e.jsx(n.Input,{type:"password",label:"Confirm passphrase",autoComplete:"new-password",required:!0,error:t.touched.confirmPassword&&t.errors.confirmPassword?t.errors.confirmPassword:void 0,...t.getFieldProps("confirmPassword")}),e.jsx(n.Input,{type:"checkbox",label:"Require passphrase reset",help:"User must change password at first login.",...t.getFieldProps("requirePasswordReset"),checked:t.values.requirePasswordReset}),e.jsx(n.Select,{label:"Primary Group",disabled:b,options:[{label:"Select",value:""},...d],...t.getFieldProps("primaryGroupValue"),error:t.touched.primaryGroupValue&&t.errors.primaryGroupValue?t.errors.primaryGroupValue:void 0}),e.jsx(n.Input,{type:"text",label:"Location",error:t.touched.location&&t.errors.location?t.errors.location:void 0,...t.getFieldProps("location")}),e.jsx(n.Input,{type:"text",label:"Home phone",error:t.touched.homePhoneNumber&&t.errors.homePhoneNumber?t.errors.homePhoneNumber:void 0,...t.getFieldProps("homePhoneNumber")}),e.jsx(n.Input,{type:"text",label:"Work phone",error:t.touched.workPhoneNumber&&t.errors.workPhoneNumber?t.errors.workPhoneNumber:void 0,...t.getFieldProps("workPhoneNumber")}),e.jsx(ke,{submitButtonDisabled:t.isSubmitting,submitButtonText:"Add user"})]})},Se=p.lazy(async()=>B(()=>import("./index-CZ2Z6FhI.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11]))),Pe=({selectedUsers:s,handleClearSelection:o,sidePanel:u=!1})=>{const[i,c]=p.useState(!1),{instanceId:l}=A(),h=G(),{notify:y}=le(),{setSidePanelContent:b,closeSidePanel:a}=I(),{removeUserQuery:d,lockUserQuery:t,unlockUserQuery:r}=Q(),[g,j]=p.useState(!1),[N,k]=p.useState(!1),[C,S]=p.useState(!1),{mutateAsync:w,isPending:U}=d,{mutateAsync:V,isPending:E}=t,{mutateAsync:z,isPending:$}=r,W=Number(l),m=s.length===1?s[0]:void 0,{locked:Y,unlocked:J}=fe(s),v=async(_,D)=>{try{await _({computer_ids:[W],usernames:je(s),delete_home:D==="removed"?i:void 0}),o&&o(),a(),y.success({message:`Successfully requested to be ${D}`})}catch(oe){h(oe)}},X=async()=>{await v(V,"locked")},Z=async()=>{await v(z,"unlocked")},ee=async()=>{await v(w,"removed")},se=()=>{b("Add new user",e.jsx(H,{}))},te=_=>{b("Edit user",e.jsx(p.Suspense,{fallback:e.jsx(P,{}),children:e.jsx(Se,{user:_})}))},re=()=>{c(_=>!_)};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:q("p-panel__controls u-no-padding--top",{"u-no-margin--left":u}),children:[!u&&e.jsxs(n.Button,{className:q("u-no-margin--right",{"u-no-margin--bottom":!u}),type:"button",hasIcon:!0,onClick:se,children:[e.jsx(n.Icon,{name:n.ICONS.plus}),e.jsx("span",{children:"Add user"})]}),e.jsx(de,{collapseFrom:u?void 0:"lg",buttons:[(m?.enabled||!u)&&e.jsxs(n.Button,{hasIcon:!0,type:"button",disabled:J===0,onClick:()=>{j(!0)},children:[e.jsx(n.Icon,{name:"lock-locked"}),e.jsx("span",{children:"Lock"})]},"lock"),(!m?.enabled||!u)&&e.jsxs(n.Button,{hasIcon:!0,type:"button",disabled:Y===0,onClick:()=>{k(!0)},children:[e.jsx(n.Icon,{name:"lock-unlock"}),e.jsx("span",{children:"Unlock"})]},"unlock"),u&&m&&e.jsxs(n.Button,{className:q("p-segmented-control__button has-icon",{"u-no-margin--bottom":!u}),type:"button",onClick:()=>{te(m)},children:[e.jsx(n.Icon,{name:"edit"}),e.jsx("span",{children:"Edit"})]},"edit"),e.jsxs(n.Button,{hasIcon:!0,type:"button",disabled:s.length===0,onClick:()=>{S(!0)},children:[e.jsx(n.Icon,{name:n.ICONS.delete}),e.jsx("span",{children:"Delete"})]},"delete")]})]}),g&&e.jsx(n.ConfirmationModal,{title:`Lock ${m?`user ${m.username}`:`${s.length} users`}`,close:()=>{j(!1)},confirmButtonLabel:"Lock",confirmButtonAppearance:"positive",confirmButtonLoading:E,confirmButtonDisabled:E,onConfirm:X,children:T({user:m,selectedUsers:s,userAction:M.Lock})}),N&&e.jsx(n.ConfirmationModal,{title:`Unlock ${m?`user ${m.username}`:`${s.length} users`}`,close:()=>{k(!1)},confirmButtonLabel:"Unlock",confirmButtonAppearance:"positive",confirmButtonLoading:$,confirmButtonDisabled:$,onConfirm:Z,children:T({user:m,selectedUsers:s,userAction:M.Unlock})}),C&&e.jsx(n.ConfirmationModal,{title:`Delete ${m?m.username:"users"}`,close:()=>{S(!1)},confirmButtonLabel:"Delete",confirmButtonAppearance:"negative",confirmButtonLoading:U,confirmButtonDisabled:U,onConfirm:ee,children:e.jsxs("div",{children:[e.jsx("p",{className:"u-no-margin--bottom",children:m?`This will delete user ${m.username}. You can delete this user's home folders at the same time.`:"This will delete selected users. You can delete their home folders as well."}),e.jsx(n.Input,{label:"Delete the home folders as well",type:"checkbox",checked:i,onChange:re})]})})]})},Ie=(s,o)=>s.filter(u=>o.includes(u.uid)),Ne=({selected:s,handleClearSelection:o,users:u})=>e.jsxs(e.Fragment,{children:[e.jsx(we,{actions:e.jsx("div",{className:Ce.actions,children:e.jsx(Pe,{handleClearSelection:o,selectedUsers:Ie(u,s)})})}),e.jsx(me,{filtersToDisplay:["search"]})]}),ve={username:(s,o)=>s.username.localeCompare(o.username),status:(s,o)=>Number(s.enabled)-Number(o.enabled),name:(s,o)=>(s.name||"").localeCompare(o.name||""),uid:(s,o)=>s.uid-o.uid},Fe="_status_xcrdk_1",qe="_statusCell_xcrdk_7",K={status:Fe,statusCell:qe},Le=p.lazy(async()=>B(()=>import("./index-CZ2Z6FhI.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11]))),Ae=p.lazy(async()=>B(()=>import("./index-BuNt_icW.js"),__vite__mapDeps([12,1,2,3,4,5,8,9,10,11]))),Be=({users:s,selected:o,setSelected:u})=>{const{setSidePanelContent:i}=I(),c=a=>{i("Edit user",e.jsx(p.Suspense,{fallback:e.jsx(P,{}),children:e.jsx(Le,{user:a})}))},l=a=>{i("User details",e.jsx(p.Suspense,{fallback:e.jsx(P,{}),children:e.jsx(Ae,{user:a})}))},h=()=>{u(o.length!==0?[]:s.map(({uid:a})=>a))},y=a=>{o.includes(a)?u(o.filter(d=>d!==a)):u([...o,a])},b=p.useMemo(()=>[{accessor:"checkbox",className:"checkbox-column",Header:e.jsx(n.CheckboxInput,{label:e.jsx("span",{className:"u-off-screen",children:"Toggle all"}),labelClassName:"u-no-margin--bottom u-no-padding--top",onChange:h,checked:s.length>0&&o.length===s.length,indeterminate:o.length>0&&o.length<s.length,disabled:s.length===0}),Cell:({row:{original:a}})=>e.jsx(n.CheckboxInput,{inline:!0,label:e.jsxs("span",{className:"u-off-screen",children:["Select user ",a.username]}),disabled:s.length===0,checked:o.includes(a.uid),onChange:()=>{y(a.uid)}})},{Header:"username",role:"rowheader",Cell:({row:{original:a}})=>e.jsx(n.Button,{type:"button",appearance:"link",className:"u-no-margin--bottom u-no-padding--top",onClick:()=>{l(a)},"aria-label":`Show details of user ${a.username}`,children:a.username})},{Header:"status",className:K.statusCell,Cell:({row:{original:a}})=>e.jsx("div",{className:K.status,children:a.enabled?e.jsxs(e.Fragment,{children:[e.jsx(n.Icon,{name:"lock-unlock"}),e.jsx("span",{children:"Unlocked"})]}):e.jsxs(e.Fragment,{children:[e.jsx(n.Icon,{name:"lock-locked-active"}),e.jsx("span",{children:"Locked"})]})})},{Header:"UID",accessor:"uid"},{Header:"Full name",Cell:({row:{original:a}})=>a.name||e.jsx(pe,{})},{Header:O.Header,className:O.className,Cell:({row:{original:a}})=>e.jsx(he,{toggleAriaLabel:`"${a.name}" user actions`,actions:[{icon:"edit",label:"Edit","aria-label":`Edit "${a.name}" user`,onClick:()=>{c(a)}}]})}],[s,o]);return e.jsx(ye,{columns:b,data:s,emptyMsg:"No users available"})},Qe=(s,o)=>s?o.filter(({username:u,name:i})=>{const c=i?.toUpperCase().includes(s.toUpperCase()),l=u.toUpperCase().includes(s.toUpperCase());return c||l}):o,Ee=()=>{const[s,o]=p.useState([]),{instanceId:u,childInstanceId:i}=A(),{search:c,currentPage:l,pageSize:h}=R(),{setSidePanelContent:y}=I(),{getUsersQuery:b}=Q(),a=Number(i??u),{data:d,isLoading:t}=b({computer_id:a,limit:L}),r=d?.data.results??[],g=Ue({data:r,sortFunctions:ve}),j=Qe(c,g),N=(w,U)=>j.slice(U,U+w),k=p.useMemo(()=>N(h,(l-1)*h),[c,j,l,h]),C=()=>{o([])},S=()=>{y("Add new user",e.jsx(H,{}))};return e.jsxs(e.Fragment,{children:[!c&&t&&e.jsx(P,{}),!t&&!c&&(!d||d.data.results.length===0)&&e.jsx(ge,{title:"No users found",body:"Add new users by clicking the button below.",icon:"connected",cta:[e.jsx(n.Button,{type:"button",appearance:"positive",onClick:S,children:"Add user"},"empty-state-add-new-user")]}),(c||!t&&k.length>0)&&e.jsxs(e.Fragment,{children:[e.jsx(Ne,{selected:s,handleClearSelection:C,users:k}),d?.data.count&&d.data.count>L&&e.jsx(n.Notification,{severity:"caution",title:`Fetched ${L} out of ${d?.data.count} users`,children:e.jsxs("span",{children:["The number of requested users is too high. Please"," ",e.jsx(be,{to:"https://support-portal.canonical.com/",children:"contact our support team."})]})}),e.jsx(Be,{selected:s,setSelected:w=>{o(w)},users:k})]}),e.jsx(xe,{handleClearSelection:C,totalItems:j.length,currentItemCount:k.length})]})},Ke=Object.freeze(Object.defineProperty({__proto__:null,default:Ee},Symbol.toStringTag,{value:"Module"}));export{Pe as U,Ke as i,Q as u};
