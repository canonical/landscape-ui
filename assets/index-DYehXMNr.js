import{j as r,m as g,h as N,t as f,i as C,k as o,p as v,f as G,s as A,g as l}from"./index-Cpeb65_5.js";import{C as S,U as O}from"./UdebCheckboxInput-BJhVgjMr.js";import{a as R,F as V}from"./debug-B9lCjRWw.js";import{M as U}from"./MultiSelectField-DSO3OA8U.js";import{S as M}from"./SidePanelFormButtons-DbIKgCpg.js";import{u as $}from"./useGPGKeys-D50HtpSO.js";import{f as w,P as T,g as q,e as L,C as D,A as B}from"./constants-9aTSojuw.js";import{t as I}from"./tests-DFnZqbNV.js";import"./SidePanelFormButtons.module-C5v714vX.js";import"./useFetchOld-Ds6h4VlO.js";import"./usePageParams-Gy7OCRIu.js";import"./NoData-BySmFC_h.js";import"./index-DlEaYhUY.js";import"./TablePagination-C3PDYPre.js";import"./TablePaginationBase-D8r8v-bo.js";import"./StatusFilter-CxZHDNao.js";import"./TableFilter-DlBBiSCn.js";import"./TableFilterChips-P0MPuC1o.js";const K=({groupedOptions:t,group:a,option:d,onChange:p,error:n,emptyOption:c,name:_,label:h="",id:b,onBlur:u,className:y,labelClassName:m,wrapperClassName:e,hidden:k,disabled:x,required:P})=>{const s=b??_.replace(/[_\s]/g,"-").replace(/([a-z])(?=[A-Z])/,"$1-").replace(/([A-Z])(?=[a-z])/,"-$1").toLowerCase();return r.jsxs("div",{className:g("p-form-validation",e,{"is-error":!!n}),children:[h&&r.jsx("label",{className:g("p-form__label",m,{"is-required":P}),htmlFor:s,children:h}),r.jsxs("div",{className:"p-form__control u-clearfix",children:[r.jsx("div",{className:"p-form-validation__select-wrapper",children:r.jsxs("select",{id:s,value:d===""?"":`${a}/${d}`,name:_,className:g("p-form-validation__input",y),onChange:i=>{p(i.target[i.target.selectedIndex].dataset.value??"",i.target[i.target.selectedIndex].dataset.group??"")},onBlur:u,disabled:x,hidden:k,"aria-invalid":!!n,"aria-errormessage":n?"pull-pocket-validation-message":void 0,children:[c&&c.enabled&&r.jsx("option",{value:"","data-group":"","data-value":"",children:c.label??""}),t.map(({optGroup:i,options:F})=>r.jsx("optgroup",{label:i,children:F.map(({value:j,label:E})=>r.jsx("option",{value:`${i}/${j}`,"data-group":i,"data-value":j,children:E},j))},i))]})}),!!n&&r.jsxs("p",{className:"p-form-validation__message",id:"pull-pocket-validation-message",children:[r.jsx("strong",{children:"Error:"})," ",n]})]})]})},Q=[{label:"Mirror",value:"mirror"},{label:"Pull",value:"pull"},{label:"Upload",value:"upload"}],z={type:"ubuntu",series:"",distribution:"",name:"",architectures:q.ubuntu,components:T.ubuntu,gpg_key:"",include_udeb:!1,filter_type:"",mode:"mirror",pull_pocket:"",pull_series:"",mirror_uri:w,upload_allow_unsigned:!1,mirror_suite:"",mirror_gpg_key:"",filter_packages:[],upload_gpg_keys:[]},H=[{label:"Select filter type",value:""},{label:"Allow list",value:"whitelist"},{label:"Disallow list",value:"blacklist"}],Z=t=>{switch(t.mode){case"mirror":return{mode:t.mode,distribution:t.distribution,series:t.series,name:t.name,architectures:t.architectures,components:t.components,gpg_key:t.gpg_key,include_udeb:t.include_udeb,mirror_uri:t.mirror_uri,mirror_suite:t.mirror_suite,mirror_gpg_key:t.mirror_gpg_key};case"upload":return{mode:t.mode,distribution:t.distribution,series:t.series,name:t.name,architectures:t.architectures,components:t.components,gpg_key:t.gpg_key,include_udeb:t.include_udeb,upload_allow_unsigned:t.upload_allow_unsigned};case"pull":return{mode:t.mode,distribution:t.distribution,series:t.series,name:t.name,architectures:t.architectures,components:t.components,gpg_key:t.gpg_key,include_udeb:t.include_udeb,pull_series:t.pull_series,pull_pocket:t.pull_pocket,filter_type:t.filter_type!==""?t.filter_type:void 0,filter_packages:t.filter_packages};default:return R(t.mode,"pocket mode")}},J=t=>N().shape({type:o().required("This field is required."),name:o().required("This field is required").test({test:I.test,message:I.message}).test({params:{series:t},test:a=>!t.pockets.map(({name:d})=>d).includes(a),message:"It must be unique within series."}),distribution:o().required("This field is required"),series:o().required("This field is required"),components:f().defined().of(o().defined()).min(1,"Please choose at least one component").test({name:"flat-mirror-sub-directory",message:"A single component must be passed",test:(a,d)=>{const{mode:p,mirror_suite:n}=d.parent;return p==="mirror"&&/\/$/.test(n)?a.length===1:!0}}).required("This field is required"),architectures:f().defined().of(o().defined()).min(1,"Please choose at least one architecture"),mode:o().required("This field is required"),gpg_key:o().required("This field is required"),include_udeb:C().required("This field is required"),mirror_uri:o().when("mode",{is:"mirror",then:a=>a.required("This field is required")}),mirror_suite:o(),mirror_gpg_key:o(),pull_pocket:o().when("mode",{is:"pull",then:a=>a.required("This field is required")}),pull_series:o(),filter_type:o(),filter_packages:f().of(o().defined()),upload_allow_unsigned:C(),upload_gpg_keys:f().of(o().defined())}),W=(t,a)=>({...z,distribution:t,series:a}),he=({distribution:t,series:a})=>{const d=v(),{closeSidePanel:p}=G(),{createPocketQuery:n,addUploaderGPGKeysToPocketQuery:c}=L(),{getGPGKeysQuery:_}=$(),{mutateAsync:h}=n,{mutateAsync:b}=c,{data:u}=_(),y=((u==null?void 0:u.data)??[]).filter(({has_secret:s})=>s).map(s=>({label:s.name,value:s.name})),m=((u==null?void 0:u.data)??[]).filter(({has_secret:s})=>!s).map(s=>({label:s.name,value:s.name})),e=A({initialValues:W(t.name,a.name),validationSchema:J(a),onSubmit:async s=>{try{await h(Z(s)),s.mode==="upload"&&!s.upload_allow_unsigned&&s.upload_gpg_keys.length&&await b({name:s.name,series:s.series,distribution:s.distribution,gpg_keys:s.upload_gpg_keys}),p()}catch(i){d(i)}}}),k=s=>{const i=s.target.value,F=i==="ubuntu"?{type:i,components:T.ubuntu,architectures:q.ubuntu,mirror_uri:e.values.mode==="mirror"?w:""}:{type:i,components:T.thirdParty,architectures:q.thirdParty,mirror_uri:e.values.mode==="mirror"?"":void 0};e.setValues({...e.values,...F})},x=s=>{const i=s.target.value;i==="mirror"&&e.values.type==="ubuntu"?e.setFieldValue("mirror_uri",w):e.setFieldValue("mirror_uri",""),e.setFieldValue("mode",i)},P=t.series.map(s=>({options:s.pockets.map(({name:i})=>({label:i,value:i})),optGroup:s.name}));return r.jsxs(l.Form,{onSubmit:e.handleSubmit,noValidate:!0,children:[r.jsx(l.Select,{label:"Type",required:!0,options:[{label:"Ubuntu",value:"ubuntu"},{label:"Third party",value:"third-party"}],...e.getFieldProps("type"),onChange:k,error:e.touched.type&&e.errors.type?e.errors.type:void 0}),r.jsx(l.Select,{label:"Mode",required:!0,options:Q,...e.getFieldProps("mode"),onChange:x,error:e.touched.mode&&e.errors.mode?e.errors.mode:void 0}),e.values.mode==="mirror"&&r.jsx(l.Input,{type:"text",label:"Mirror URI",required:!0,...e.getFieldProps("mirror_uri"),error:e.touched.mirror_uri&&e.errors.mirror_uri?e.errors.mirror_uri:void 0}),r.jsxs("div",{className:g({row:e.values.mode==="pull","u-no-padding--left":e.values.mode==="pull","u-no-padding--right":e.values.mode==="pull"}),children:[r.jsx(l.Input,{type:"text",label:"Name",required:!0,wrapperClassName:g({"col-6":e.values.mode==="pull"}),style:{display:"block !important"},...e.getFieldProps("name"),error:e.touched.name&&e.errors.name?e.errors.name:void 0}),e.values.mode=="pull"&&r.jsx(K,{label:"Pull from",required:!0,name:"pull_pocket",wrapperClassName:"col-6",groupedOptions:P,option:e.values.pull_pocket,group:e.values.pull_series,emptyOption:{enabled:!0,label:"Select pull pocket"},onChange:async(s,i)=>{await e.setFieldValue("pull_pocket",s),await e.setFieldValue("pull_series",i)},onBlur:e.handleBlur,error:e.touched.pull_pocket&&e.errors.pull_pocket?e.errors.pull_pocket:void 0})]}),r.jsx(l.Select,{label:"GPG Key",required:!0,options:[{label:"Select GPG key",value:""},...y],...e.getFieldProps("gpg_key"),error:e.touched.gpg_key&&e.errors.gpg_key?e.errors.gpg_key:void 0}),e.values.mode==="mirror"&&r.jsxs(r.Fragment,{children:[r.jsx(l.Input,{type:"text",label:r.jsx(V,{label:"Mirror suite",description:r.jsxs(r.Fragment,{children:[r.jsx("span",{children:"The specific sub-directory under dists/ that should be mirrored. If the suite name ends with a ‘/’, the remote repository is flat (no dists/ structure, see "}),r.jsx("a",{href:"http://wiki.debian.org/RepositoryFormat#Flat_Repository_Format",target:"_blank",rel:"nofollow noopener noreferrer",children:"wiki.debian.org/RepositoryFormat#Flat_Repository_Format"}),r.jsx("span",{children:"); in this case a single value must be passed for the ‘components’ parameter. Packages from the remote repository will be mirrored in the specified component. This parameter is optional and defaults to the same name as local series and pocket."})]})}),...e.getFieldProps("mirror_suite"),error:e.touched.mirror_suite&&e.errors.mirror_suite?e.errors.mirror_suite:void 0}),r.jsx(l.Select,{label:"Mirror GPG key",options:[{label:"Select GPG key",value:""},...m],...e.getFieldProps("mirror_gpg_key"),error:e.touched.mirror_gpg_key&&e.errors.mirror_gpg_key?e.errors.mirror_gpg_key:void 0,help:"If none is given, the stock Ubuntu archive one will be used."})]}),e.values.mode==="pull"&&r.jsxs(r.Fragment,{children:[r.jsx(l.Select,{label:"Filter type",options:H,...e.getFieldProps("filter_type"),error:e.touched.filter_type&&e.errors.filter_type?e.errors.filter_type:void 0}),e.values.filter_type!==""&&r.jsx(l.Textarea,{label:"Filter packages",rows:3,help:"List packages to filter separated by commas",...e.getFieldProps("filter_packages"),onChange:s=>{e.setFieldValue("filter_packages",s.target.value.replace(/\s/g,"").split(","))},value:e.values.filter_packages.join(","),error:e.touched.filter_packages&&e.errors.filter_packages?e.errors.filter_packages:void 0})]}),e.values.mode==="upload"&&r.jsxs(r.Fragment,{children:[r.jsx(l.CheckboxInput,{label:"Allow uploaded packages to be unsigned",...e.getFieldProps("upload_allow_unsigned"),checked:e.values.upload_allow_unsigned}),r.jsx(U,{variant:"condensed",label:"Uploader GPG keys",disabled:e.values.upload_allow_unsigned,items:m,selectedItems:m.filter(({value:s})=>e.values.upload_gpg_keys.includes(s)),onItemsUpdate:s=>{e.setFieldValue("upload_gpg_keys",s.map(({value:i})=>i))},error:e.touched.upload_gpg_keys&&(Array.isArray(e.errors.upload_gpg_keys)?e.errors.upload_gpg_keys[0]:e.errors.upload_gpg_keys)||void 0})]}),e.values.type==="ubuntu"&&r.jsxs(r.Fragment,{children:[r.jsx(S,{label:"Components",required:!0,options:D,...e.getFieldProps("components"),onChange:s=>{e.setFieldValue("components",s)},error:e.touched.components&&e.errors.components?e.errors.components:void 0}),r.jsx(S,{label:"Architectures",required:!0,options:B,...e.getFieldProps("architectures"),onChange:s=>{e.setFieldValue("architectures",s)},error:e.touched.architectures&&e.errors.architectures?e.errors.architectures:void 0})]}),e.values.type==="third-party"&&r.jsxs(r.Fragment,{children:[r.jsx(l.Input,{type:"text",label:"Components",required:!0,...e.getFieldProps("components"),value:e.values.components.join(","),onChange:s=>{e.setFieldValue("components",s.target.value.replace(/\s/g,"").split(","))},error:e.touched.components&&e.errors.components?e.errors.components:void 0}),r.jsx(l.Input,{type:"text",label:"Architectures",required:!0,...e.getFieldProps("architectures"),value:e.values.architectures.join(","),onChange:s=>{e.setFieldValue("architectures",s.target.value.replace(/\s/g,"").split(","))},error:e.touched.architectures&&e.errors.architectures?e.errors.architectures:void 0})]}),r.jsx(O,{formik:e}),r.jsx(M,{submitButtonDisabled:e.isSubmitting,submitButtonText:"Add pocket",submitButtonAriaLabel:"Add pocket"})]})};export{he as default};
