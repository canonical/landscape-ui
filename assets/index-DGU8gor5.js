import{c as y,d as A,i as f,v as T,l as c,J as n,r as j,g as P,q as w,t as I,j as a,h as o}from"./index-vDh6p1re.js";import{C as E}from"./CodeEditor-CohnhYYz.js";import{S as R}from"./SidePanelFormButtons-CrzoUcfJ.js";import{u as q}from"./useRoles-Cobv-tGH.js";import{g as d}from"./formikErrors-Bw8iTXYS.js";import"./usePageParams-C-pi3Kin.js";import{u as V,S as _}from"./ScriptFormAttachments-BEZtL0vU.js";import{u as D}from"./useFetchOld-Dh4_z9Or.js";import{D as k,h as N,e as B,r as L}from"./ScriptsTabs-qWvYCBab.js";import"./index-CCmNm2LP.js";import"./SidePanelFormButtons.module-D2P5PizG.js";import"./TablePagination-s2q42wYR.js";import"./TablePaginationBase-eH-xceTk.js";import"./NoData-ClqjzLea.js";import"./TruncatedCell-BRtEnS33.js";import"./StatusFilter-kNfNcZ7x.js";import"./TableFilter-D9jMhOmC.js";import"./TableFilterChips-BgTfFgZ3.js";import"./HeaderWithSearch-DZAyAsgS.js";import"./SingleInstanceTabs.module-Cm1BYFZQ.js";const O=()=>{const i=D(),l=y(),{mutateAsync:u,isPending:m}=A({mutationKey:["scripts","create"],mutationFn:async h=>i.get("CreateScript",{params:h}),onSuccess:async()=>l.invalidateQueries({queryKey:["scripts"]})});return{createScript:u,isCreatingScript:m}},$={title:"",code:"",access_group:"",attachments:{first:null,second:null,third:null,fourth:null,fifth:null},attachmentsToRemove:[]},M=()=>f().shape({title:c().required("This field is required"),access_group:c().nullable(),code:c().test({name:"required",message:"This field is required",test:i=>!!i}),attachments:f().shape({first:n().nullable(),second:n().nullable(),third:n().nullable(),fourth:n().nullable(),fifth:n().nullable()}),attachmentsToRemove:T().of(c())}),ut=()=>{const i=j.useRef(null),{closeSidePanel:l}=P(),u=w(),{getAccessGroupQuery:m}=q(),{createScript:h}=O(),{createScriptAttachment:g}=V(),{data:p}=m(),b=((p==null?void 0:p.data)??[]).map(e=>({label:e.title,value:e.name})),S=[{label:"Select access group",value:""},...b],x=async e=>{const r=Object.values(e.attachments).filter(s=>s!==null);try{const s=await h(N(e));r.length&&await Promise.all(await B({attachments:r,createScriptAttachment:g,script_id:s.data.id})),l()}catch(s){u(s)}},t=I({initialValues:$,validationSchema:M(),onSubmit:x}),C=async({target:{files:e}})=>{if(!e)return;const[r]=e,s=t.setFieldValue("code",await r.text());if(t.values.title){await s;return}await Promise.all([t.setFieldValue("title",L(r.name)),s])},F=async e=>{await t.setFieldValue("code",e)},v=()=>{var e;return(e=i.current)==null?void 0:e.click()};return a.jsxs(o.Form,{onSubmit:t.handleSubmit,noValidate:!0,children:[a.jsx(o.Input,{type:"text",label:"Title",required:!0,...t.getFieldProps("title"),error:t.touched.title&&t.errors.title?t.errors.title:void 0}),a.jsx("input",{ref:i,className:"u-hide",type:"file",onChange:C}),a.jsx(E,{label:"Code",value:t.values.code,onChange:F,error:d(t,"code"),required:!0,defaultValue:k,headerContent:a.jsxs(o.Button,{className:"u-no-margin--bottom",appearance:"base",hasIcon:!0,onClick:v,type:"button",children:[a.jsx(o.Icon,{name:"upload"}),a.jsx("span",{children:"Populate from file"})]})}),a.jsx(o.Select,{label:"Access group",...t.getFieldProps("access_group"),options:S,error:d(t,"access_group")}),a.jsxs(a.Fragment,{children:[a.jsx("h5",{children:"List of attachments"}),a.jsx("p",{className:"u-text--muted",children:"Attachments that will be sent along with the script. You can attach up to 5 files, for a maximum of 1.00MB. Filenames must be unique. On the client, the attachments will be placed in the directory whose name is accessible through the environment variable LANDSCAPE_ATTACHMENTS. They'll be deleted once the script has been run."})]}),a.jsx(_,{attachments:t.values.attachments,attachmentsToRemove:t.values.attachmentsToRemove,getFileInputError:e=>d(t,["attachments",e]),initialAttachments:[],onFileInputChange:e=>async r=>{var s;return t.setFieldValue(`attachments.${e}`,((s=r.target.files)==null?void 0:s[0])??null)},onInitialAttachmentDelete:e=>{t.setFieldValue("attachmentsToRemove",[...t.values.attachmentsToRemove,e])}}),a.jsx(R,{submitButtonText:"Create script",submitButtonDisabled:t.isSubmitting})]})};export{ut as default};
