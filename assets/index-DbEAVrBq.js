import{r as h,j as i,g as j,k as y,h as L}from"./index-BMhnQnvO.js";import{a as U}from"./useUsns-Dw6dj2_v.js";import{S as R,E as M}from"./SelectAllButton-D_BMBSCB.js";import"./useFetchOld-Cff5y19B.js";import"./useMutation-Diy-BhWO.js";import"./useQuery-Dxk6aJEc.js";import"./ExpandableTableFooter-9RPwl5aD.js";const v=(e,n)=>{const a=new Set(n.computers.map(t=>t.id));return e.some(({exclude_packages:t,id:s})=>a.has(s)&&!t.includes(n.id))},N=(e,n,a)=>{const t=new Set(n.computers.map(({id:s})=>s));return e.map(({id:s,exclude_packages:r})=>{if(!t.has(s))return{id:s,exclude_packages:r};const d=r.filter(o=>o!==n.id);return{id:s,exclude_packages:a?[...d,n.id]:d}})},q=(e,n)=>N(e,n,v(e,n)),F=e=>({column:n,row:a})=>{const t={};return e&&a.index===0?n.id==="checkbox"?t.colSpan=4:(t.style=t.style||{},t.style.display="none",t["aria-hidden"]=!0):n.id==="checkbox"?t["aria-label"]=`Toggle ${a.original.name} instance`:n.id==="title"?t.role="rowheader":n.id==="current_version"?t["aria-label"]="Current version":n.id==="available_version"&&(t["aria-label"]="New version"),t},E=(e,n,a)=>{var t;return!((t=e.find(({id:s})=>s===n))!=null&&t.exclude_packages.includes(a))},z=(e,n,a)=>e.map(({id:t,exclude_packages:s})=>t!==n?{id:t,exclude_packages:s}:{id:t,exclude_packages:s.includes(a)?s.filter(r=>r!==r):[...s,a]}),$=({excludePackages:e,instances:n,limit:a,pkg:t})=>{const s=new Set(t.computers.map(({id:l})=>l)),r=n.filter(({id:l})=>s.has(l)).slice(0,a),d=new Set(e.filter(({exclude_packages:l})=>l.includes(t.id)).map(({id:l})=>l)),o=r.filter(({id:l})=>!d.has(l)).length;return o===0?"unchecked":o===r.length?"checked":"indeterminate"},D=(e,n)=>{const a=new Set(n.computers.map(({id:t})=>t));return e.filter(({exclude_packages:t,id:s})=>a.has(s)&&!t.includes(n.id)).length},O=(e,n)=>N(e,n,!1),V=({currentPackage:e,excludedPackages:n,limit:a,onExcludedPackagesChange:t,onLimitChange:s,selectedInstances:r})=>{const d=new Set(e.computers.map(({id:u})=>u)),o=n.filter(({exclude_packages:u})=>u.includes(e.id)),l=h.useMemo(()=>{const u=new Set(r.slice(0,a).map(({id:m})=>m));return o.some(({id:m})=>!u.has(m))},[o.length,r.length,a]),S=h.useMemo(()=>[...r.slice(0,l?1:0),...r.filter(({id:u})=>d.has(u)).slice(0,a)],[d,a,r,l]),p=()=>{t(q(n,e))},C=u=>{t(z(n,u,e.id))},g=()=>{t(O(n,e))},b=$({excludePackages:n,instances:r,limit:a,pkg:e}),_=h.useMemo(()=>[{accessor:"checkbox",className:"checkbox-column",Header:i.jsx(j.CheckboxInput,{inline:!0,label:i.jsx("span",{className:"u-off-screen",children:"Toggle all instances"}),checked:b==="checked",indeterminate:b==="indeterminate",onChange:p}),Cell:({row:{index:u,original:m}})=>l&&u===0?i.jsx(R,{count:D(n,e),itemName:{plural:"instances",singular:"instance"},onClick:g,totalCount:d.size}):i.jsx(j.CheckboxInput,{inline:!0,label:i.jsxs("span",{className:"u-off-screen",children:["Toggle ",m.title," instance"]}),checked:E(n,m.id,e.id),onChange:()=>C(m.id)})},{accessor:"title",Header:"Name"},{accessor:"current_version",Header:"Current version",Cell:({row:{original:u}})=>{var m;return i.jsx(i.Fragment,{children:(m=e.computers.find(({id:x})=>x===u.id))==null?void 0:m.current_version})}},{accessor:"available_version",Header:"New version",Cell:({row:{original:u}})=>{var m;return i.jsx(i.Fragment,{children:(m=e.computers.find(({id:x})=>x===u.id))==null?void 0:m.available_version})}}],[e,n,S]);return i.jsx(M,{columns:_,data:S,getCellProps:F(l),itemNames:{plural:"instances",singular:"instance"},onLimitChange:s,totalCount:d.size,title:i.jsxs("p",{className:"p-heading--4",children:["Instances affected by ",i.jsx("b",{children:e.name})]})})},k={name:"",computers:[],summary:"",id:-1},G="_nameColumn_s3r66_1",K="_expanded_s3r66_5",P="_expandButton_s3r66_23",Q="_hidden_s3r66_31",Y="_innerTable_s3r66_35",J="_row_s3r66_39",W="_expandedRow_s3r66_45",X="_expandedCell_s3r66_50",Z="_cve_s3r66_55",ee="_cveLink_s3r66_59",w={nameColumn:G,expanded:K,expandButton:P,hidden:Q,innerTable:Y,row:J,expandedRow:W,expandedCell:X,cve:Z,cveLink:ee},te=({expandedRow:e,isPackagesLoading:n,lastPackageIndex:a,showSelectAllButton:t})=>({column:s,row:{index:r,original:d}})=>{const o={};return t&&r===0||n&&r===a||e>-1&&e===r-1?s.id==="name"?(o.colSpan=3,e>-1&&e===r-1&&(o.className=w.innerTable)):(o.className=w.hidden,o["aria-hidden"]=!0):s.id==="checkbox"?o["aria-label"]=`Toggle ${d.name} package`:s.id==="name"?o.role="rowheader":s.id==="version"?o["aria-label"]="Current version":s.id==="new_version"?o["aria-label"]="New version":s.id==="computers.upgrades"&&(o["aria-label"]="Affected instances",o.className=e===r?w.expanded:w.row),o},ne=(e,n)=>n.some(a=>v(e,a)),se=(e,n)=>n.length>0&&n.every(({computers:a,id:t})=>e.filter(({id:s})=>a.some(r=>r.id===s)).every(({exclude_packages:s})=>!s.includes(t))),ae=(e,n,a)=>n.reduce((t,s)=>N(t,s,a),e),re=({expandedRow:e,isPackagesLoading:n,packages:a,showSelectAllButton:t})=>{const s=e>-1?e+1:0;return[...[k].slice(t?0:1),...a.slice(0,s||a.length),...a.slice(s?s-1:a.length),...[k].slice(n?0:1)]},A=(e,n)=>{const a=new Set(n.computers.map(({id:t})=>t));return e.every(({exclude_packages:t,id:s})=>!a.has(s)||!t.includes(n.id))},oe=({excludedPackages:e,hasNoMoreItems:n,instances:a,isPackagesLoading:t,onExcludedPackagesChange:s,onTableLimitChange:r,packages:d,totalPackageCount:o})=>{const[l,S]=h.useState(-1),[p,C]=h.useState(5),g=new Set(e.flatMap(({exclude_packages:c})=>c)),b=h.useMemo(()=>{const c=new Set(d.map(({id:f})=>f));for(const f of g)if(!c.has(f))return!0;return!1},[d.length,g]),_=h.useMemo(()=>re({expandedRow:l,isPackagesLoading:t,packages:d,showSelectAllButton:b}),[d,l,t,b]),u=ne(e,d),m=()=>{s(ae(e,d,u))},x=c=>{s(q(e,c))},B=c=>{C(5),S(f=>f===c?-1:c>f&&f!==-1?c-1:c)},T=se(e,d),H=h.useMemo(()=>[{accessor:"checkbox",className:"checkbox-column",Header:i.jsx(j.CheckboxInput,{inline:!0,label:i.jsx("span",{className:"u-off-screen",children:"Toggle all packages"}),disabled:_.length===0,checked:T,indeterminate:!T&&u,onChange:m}),Cell:({row:{original:c}})=>i.jsx(j.CheckboxInput,{inline:!0,label:i.jsxs("span",{className:"u-off-screen",children:["Toggle ",c.name," package"]}),checked:A(e,c),indeterminate:!A(e,c)&&v(e,c),onChange:()=>x(c)})},{accessor:"name",className:w.nameColumn,Header:"Package name",Cell:({row:{index:c,original:f}})=>b&&c===0?i.jsx(R,{count:o-g.size,itemName:{plural:"packages",singular:"package"},onClick:()=>s(e.map(({id:I})=>({id:I,exclude_packages:[]}))),totalCount:o}):l!==-1&&l===c-1?i.jsx(V,{currentPackage:f,excludedPackages:e,limit:p,onExcludedPackagesChange:s,onLimitChange:()=>C(I=>I+5),selectedInstances:a}):t&&c===_.length-1?i.jsx(y,{}):f.name},{accessor:"computers.upgrades",Header:"Affected instances",Cell:({row:{index:c,original:f}})=>i.jsx(j.Button,{type:"button",className:L("p-accordion__tab",w.expandButton),"aria-expanded":l===c,onClick:()=>B(c),children:new Set(f.computers.map(({id:I})=>I)).size})}],[_,a,e,l,t,p]);return i.jsx(M,{columns:H,data:_,itemCount:d.length,hasNoMoreItems:n,getCellProps:te({expandedRow:l,isPackagesLoading:t,lastPackageIndex:_.length-1,showSelectAllButton:b}),itemNames:{plural:"packages",singular:"package"},onLimitChange:r,totalCount:o})},le=({excludedPackages:e,instances:n,onExcludedPackagesChange:a})=>{const[t,s]=h.useState([]),[r,d]=h.useState(0),o=h.useRef(0),l=h.useRef(-1),{getPackagesQuery:S}=U(),{data:p,isLoading:C}=S({query:`id:${n.map(({id:g})=>g).join(" OR id:")}`,upgrade:!0,limit:5,offset:r});return h.useEffect(()=>{!p||r===l.current||(o.current=p.data.count,l.current=r,s(g=>[...g,...p.data.results]))},[p]),C&&!t.length?i.jsx(y,{}):i.jsx(oe,{excludedPackages:e,hasNoMoreItems:(p==null?void 0:p.data.next)===null,instances:n,isPackagesLoading:C,onExcludedPackagesChange:a,onTableLimitChange:()=>d(g=>g+5),packages:t,totalPackageCount:o.current})},fe=le;export{fe as default};
