import{j as r,c as _,k as E,n as i,w as b,l as q,q as N,i as G,t as A,d as l}from"./index-bwXOAcKK.js";import{C,U as O}from"./UdebCheckboxInput-D0FZoWG1.js";import{a as R,F as V}from"./debug-IAx7sBQy.js";import{M as U}from"./MultiSelectField-CCL0t_k4.js";import{S as M}from"./SidePanelFormButtons-BtqRcXDp.js";import{u as $}from"./useGPGKeys-D_um1_y3.js";import{P as v,g as w,f as T,e as L,C as D,A as B}from"./constants-BLgbS-6G.js";import{t as S}from"./tests-DFnZqbNV.js";import"./SidePanelFormButtons.module-yv6Qz3cN.js";import"./useFetchOld-ByPhVfhm.js";import"./moment-C5S46NFB.js";import"./InfoItem-D5kMV4a4.js";import"./NoData-DpInLn0M.js";import"./index-BGQUQopz.js";import"./moment-MRI66HFk.js";import"./TablePagination-Dw6MtsuZ.js";import"./TablePagination.module-CgQ3jx4B.js";import"./usePageParams-TpNL_kGt.js";const K=({groupedOptions:t,group:a,option:n,onChange:p,error:d,emptyOption:c,name:g,label:h="",id:y,onBlur:u,className:k,labelClassName:m,wrapperClassName:e,hidden:f,disabled:x,required:P})=>{const o=y??g.replace(/[_\s]/g,"-").replace(/([a-z])(?=[A-Z])/,"$1-").replace(/([A-Z])(?=[a-z])/,"-$1").toLowerCase();return r.jsxs("div",{className:_("p-form-validation",e,{"is-error":!!d}),children:[h&&r.jsx("label",{className:_("p-form__label",m,{"is-required":P}),htmlFor:o,children:h}),r.jsxs("div",{className:"p-form__control u-clearfix",children:[r.jsx("div",{className:"p-form-validation__select-wrapper",children:r.jsxs("select",{id:o,value:n===""?"":`${a}/${n}`,name:g,className:_("p-form-validation__input",k),onChange:s=>{p(s.target[s.target.selectedIndex].dataset.value??"",s.target[s.target.selectedIndex].dataset.group??"")},onBlur:u,disabled:x,hidden:f,"aria-invalid":!!d,"aria-errormessage":d?"pull-pocket-validation-message":void 0,children:[c&&c.enabled&&r.jsx("option",{value:"","data-group":"","data-value":"",children:c.label??""}),t.map(({optGroup:s,options:F})=>r.jsx("optgroup",{label:s,children:F.map(({value:j,label:I})=>r.jsx("option",{value:`${s}/${j}`,"data-group":s,"data-value":j,children:I},j))},s))]})}),!!d&&r.jsxs("p",{className:"p-form-validation__message",id:"pull-pocket-validation-message",children:[r.jsx("strong",{children:"Error:"})," ",d]})]})]})},Q=[{label:"Mirror",value:"mirror"},{label:"Pull",value:"pull"},{label:"Upload",value:"upload"}],z={type:"ubuntu",series:"",distribution:"",name:"",architectures:v.ubuntu,components:w.ubuntu,gpg_key:"",include_udeb:!1,filter_type:"",mode:"mirror",pull_pocket:"",pull_series:"",mirror_uri:T,upload_allow_unsigned:!1,mirror_suite:"",mirror_gpg_key:"",filter_packages:[],upload_gpg_keys:[]},H=[{label:"Select filter type",value:""},{label:"Allow list",value:"whitelist"},{label:"Disallow list",value:"blacklist"}],Z=t=>{switch(t.mode){case"mirror":return{mode:t.mode,distribution:t.distribution,series:t.series,name:t.name,architectures:t.architectures,components:t.components,gpg_key:t.gpg_key,include_udeb:t.include_udeb,mirror_uri:t.mirror_uri,mirror_suite:t.mirror_suite,mirror_gpg_key:t.mirror_gpg_key};case"upload":return{mode:t.mode,distribution:t.distribution,series:t.series,name:t.name,architectures:t.architectures,components:t.components,gpg_key:t.gpg_key,include_udeb:t.include_udeb,upload_allow_unsigned:t.upload_allow_unsigned};case"pull":return{mode:t.mode,distribution:t.distribution,series:t.series,name:t.name,architectures:t.architectures,components:t.components,gpg_key:t.gpg_key,include_udeb:t.include_udeb,pull_series:t.pull_series,pull_pocket:t.pull_pocket,filter_type:t.filter_type!==""?t.filter_type:void 0,filter_packages:t.filter_packages};default:return R(t.mode,"pocket mode")}},J=t=>E().shape({type:i().required("This field is required."),name:i().required("This field is required").test({test:S.test,message:S.message}).test({params:{series:t},test:a=>!t.pockets.map(({name:n})=>n).includes(a),message:"It must be unique within series."}),distribution:i().required("This field is required"),series:i().required("This field is required"),components:b().defined().of(i().defined()).min(1,"Please choose at least one component").test({name:"flat-mirror-sub-directory",message:"A single component must be passed",test:(a,n)=>{const{mode:p,mirror_suite:d}=n.parent;return p==="mirror"&&/\/$/.test(d)?a.length===1:!0}}).required("This field is required"),architectures:b().defined().of(i().defined()).min(1,"Please choose at least one architecture"),mode:i().required("This field is required"),gpg_key:i().required("This field is required"),include_udeb:q().required("This field is required"),mirror_uri:i().when("mode",{is:"mirror",then:a=>a.required("This field is required")}),mirror_suite:i(),mirror_gpg_key:i(),pull_pocket:i().when("mode",{is:"pull",then:a=>a.required("This field is required")}),pull_series:i(),filter_type:i(),filter_packages:b().of(i().defined()),upload_allow_unsigned:q(),upload_gpg_keys:b().of(i().defined())}),W=(t,a)=>({...z,distribution:t,series:a}),he=({distribution:t,series:a})=>{const n=N(),{closeSidePanel:p}=G(),{createPocketQuery:d,addUploaderGPGKeysToPocketQuery:c}=L(),{getGPGKeysQuery:g}=$(),{mutateAsync:h}=d,{mutateAsync:y}=c,{data:u}=g(),k=((u==null?void 0:u.data)??[]).filter(({has_secret:o})=>o).map(o=>({label:o.name,value:o.name})),m=((u==null?void 0:u.data)??[]).filter(({has_secret:o})=>!o).map(o=>({label:o.name,value:o.name})),e=A({initialValues:W(t.name,a.name),validationSchema:J(a),onSubmit:async o=>{try{await h(Z(o)),o.mode==="upload"&&!o.upload_allow_unsigned&&o.upload_gpg_keys.length&&await y({name:o.name,series:o.series,distribution:o.distribution,gpg_keys:o.upload_gpg_keys}),p()}catch(s){n(s)}}}),f=o=>{const s=o.target.value,F=s==="ubuntu"?{type:s,components:w.ubuntu,architectures:v.ubuntu,mirror_uri:e.values.mode==="mirror"?T:""}:{type:s,components:w.thirdParty,architectures:v.thirdParty,mirror_uri:e.values.mode==="mirror"?"":void 0};e.setValues({...e.values,...F})},x=o=>{const s=o.target.value;s==="mirror"&&e.values.type==="ubuntu"?e.setFieldValue("mirror_uri",T):e.setFieldValue("mirror_uri",""),e.setFieldValue("mode",s)},P=t.series.map(o=>({options:o.pockets.map(({name:s})=>({label:s,value:s})),optGroup:o.name}));return r.jsxs(l.Form,{onSubmit:e.handleSubmit,noValidate:!0,children:[r.jsx(l.Select,{label:"Type",required:!0,options:[{label:"Ubuntu",value:"ubuntu"},{label:"Third party",value:"third-party"}],...e.getFieldProps("type"),onChange:f,error:e.touched.type&&e.errors.type?e.errors.type:void 0}),r.jsx(l.Select,{label:"Mode",required:!0,options:Q,...e.getFieldProps("mode"),onChange:x,error:e.touched.mode&&e.errors.mode?e.errors.mode:void 0}),e.values.mode==="mirror"&&r.jsx(l.Input,{type:"text",label:"Mirror URI",required:!0,...e.getFieldProps("mirror_uri"),error:e.touched.mirror_uri&&e.errors.mirror_uri?e.errors.mirror_uri:void 0}),r.jsxs("div",{className:_({row:e.values.mode==="pull","u-no-padding--left":e.values.mode==="pull","u-no-padding--right":e.values.mode==="pull"}),children:[r.jsx(l.Input,{type:"text",label:"Name",required:!0,wrapperClassName:_({"col-6":e.values.mode==="pull"}),style:{display:"block !important"},...e.getFieldProps("name"),error:e.touched.name&&e.errors.name?e.errors.name:void 0}),e.values.mode=="pull"&&r.jsx(K,{label:"Pull from",required:!0,name:"pull_pocket",wrapperClassName:"col-6",groupedOptions:P,option:e.values.pull_pocket,group:e.values.pull_series,emptyOption:{enabled:!0,label:"Select pull pocket"},onChange:async(o,s)=>{await e.setFieldValue("pull_pocket",o),await e.setFieldValue("pull_series",s)},onBlur:e.handleBlur,error:e.touched.pull_pocket&&e.errors.pull_pocket?e.errors.pull_pocket:void 0})]}),r.jsx(l.Select,{label:"GPG Key",required:!0,options:[{label:"Select GPG key",value:""},...k],...e.getFieldProps("gpg_key"),error:e.touched.gpg_key&&e.errors.gpg_key?e.errors.gpg_key:void 0}),e.values.mode==="mirror"&&r.jsxs(r.Fragment,{children:[r.jsx(l.Input,{type:"text",label:r.jsx(V,{label:"Mirror suite",description:r.jsxs(r.Fragment,{children:[r.jsx("span",{children:"The specific sub-directory under dists/ that should be mirrored. If the suite name ends with a ‘/’, the remote repository is flat (no dists/ structure, see "}),r.jsx("a",{href:"http://wiki.debian.org/RepositoryFormat#Flat_Repository_Format",target:"_blank",rel:"nofollow noopener noreferrer",children:"wiki.debian.org/RepositoryFormat#Flat_Repository_Format"}),r.jsx("span",{children:"); in this case a single value must be passed for the ‘components’ parameter. Packages from the remote repository will be mirrored in the specified component. This parameter is optional and defaults to the same name as local series and pocket."})]})}),...e.getFieldProps("mirror_suite"),error:e.touched.mirror_suite&&e.errors.mirror_suite?e.errors.mirror_suite:void 0}),r.jsx(l.Select,{label:"Mirror GPG key",options:[{label:"Select GPG key",value:""},...m],...e.getFieldProps("mirror_gpg_key"),error:e.touched.mirror_gpg_key&&e.errors.mirror_gpg_key?e.errors.mirror_gpg_key:void 0,help:"If none is given, the stock Ubuntu archive one will be used."})]}),e.values.mode==="pull"&&r.jsxs(r.Fragment,{children:[r.jsx(l.Select,{label:"Filter type",options:H,...e.getFieldProps("filter_type"),error:e.touched.filter_type&&e.errors.filter_type?e.errors.filter_type:void 0}),e.values.filter_type!==""&&r.jsx(l.Textarea,{label:"Filter packages",rows:3,help:"List packages to filter separated by commas",...e.getFieldProps("filter_packages"),onChange:o=>{e.setFieldValue("filter_packages",o.target.value.replace(/\s/g,"").split(","))},value:e.values.filter_packages.join(","),error:e.touched.filter_packages&&e.errors.filter_packages?e.errors.filter_packages:void 0})]}),e.values.mode==="upload"&&r.jsxs(r.Fragment,{children:[r.jsx(l.CheckboxInput,{label:"Allow uploaded packages to be unsigned",...e.getFieldProps("upload_allow_unsigned"),checked:e.values.upload_allow_unsigned}),r.jsx(U,{variant:"condensed",label:"Uploader GPG keys",disabled:e.values.upload_allow_unsigned,items:m,selectedItems:m.filter(({value:o})=>e.values.upload_gpg_keys.includes(o)),onItemsUpdate:o=>{e.setFieldValue("upload_gpg_keys",o.map(({value:s})=>s))},error:e.touched.upload_gpg_keys&&(Array.isArray(e.errors.upload_gpg_keys)?e.errors.upload_gpg_keys[0]:e.errors.upload_gpg_keys)||void 0})]}),e.values.type==="ubuntu"&&r.jsxs(r.Fragment,{children:[r.jsx(C,{label:"Components",required:!0,options:D,...e.getFieldProps("components"),onChange:o=>{e.setFieldValue("components",o)},error:e.touched.components&&e.errors.components?e.errors.components:void 0}),r.jsx(C,{label:"Architectures",required:!0,options:B,...e.getFieldProps("architectures"),onChange:o=>{e.setFieldValue("architectures",o)},error:e.touched.architectures&&e.errors.architectures?e.errors.architectures:void 0})]}),e.values.type==="third-party"&&r.jsxs(r.Fragment,{children:[r.jsx(l.Input,{type:"text",label:"Components",required:!0,...e.getFieldProps("components"),value:e.values.components.join(","),onChange:o=>{e.setFieldValue("components",o.target.value.replace(/\s/g,"").split(","))},error:e.touched.components&&e.errors.components?e.errors.components:void 0}),r.jsx(l.Input,{type:"text",label:"Architectures",required:!0,...e.getFieldProps("architectures"),value:e.values.architectures.join(","),onChange:o=>{e.setFieldValue("architectures",o.target.value.replace(/\s/g,"").split(","))},error:e.touched.architectures&&e.errors.architectures?e.errors.architectures:void 0})]}),r.jsx(O,{formik:e}),r.jsx(M,{submitButtonDisabled:e.isSubmitting,submitButtonText:"Add pocket",submitButtonAriaLabel:"Add pocket"})]})};export{he as default};
