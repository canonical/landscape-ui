import{h as re,f as le,d as ne,j as e,r as _,x as P,W as de,c as ae,e as a,E as O,g as X,_ as ue}from"./index-7rbqZGOC.js";import{h as Y}from"./moment-Cl4UOzQZ.js";import{I as C}from"./InfoItem-CT4qJo1M.js";import{u as pe}from"./useFetchOld-DEPeqKqM.js";import{u as E}from"./useMutation-CcXaMJpM.js";import{u as G}from"./useQuery-B9bt25H8.js";import{u as oe}from"./useConfirm-B_JFtESx.js";import{u as me}from"./useInstances-rbmDqIqq.js";import{m as he}from"./moment-B798BXKp.js";import"./TablePagination.module-DLVph1Z1.js";import{T as ve}from"./TablePagination-Bvv83kII.js";import{E as ye}from"./EmptyState-Z1WsBfRf.js";import{S as ge}from"./SearchHelpPopup-A_Bc3YVl.js";import{u as se}from"./usePageParams-Bx_W__hi.js";const be="_iconError_j51du_1",_e="_iconWarning_j51du_5",Ae="_iconWarningRed_j51du_9",J={iconError:be,iconWarning:_e,iconWarningRed:Ae},$={succeeded:{icon:"success",label:"Succeeded"},scheduled:{icon:"spinner",label:"Scheduled"},waiting:{icon:"status-waiting",label:"Waiting"},undelivered:{icon:"status-queued",label:"Queued"},delivered:{icon:"status-in-progress",label:"In progress"},blocked:{icon:`warning-grey ${J.iconWarningRed}`,label:"Blocked"},unapproved:{icon:`warning-grey ${J.iconWarning}`,label:"Unapproved"},canceled:{icon:"error-grey",label:"Cancelled"},failed:{icon:`error-grey ${J.iconError}`,label:"Failed"}};function Z(){const r=pe(),t=re(),s=le(),{setSidePanelContent:p}=ne(),y=(i={},u={})=>G({queryKey:["activities",i],queryFn:()=>t.get("activities",{params:i}),...u}),m=({activityId:i,...u},h={})=>G({queryKey:["activities",{activityId:i,...u}],queryFn:()=>t.get(`activities/${i}`,{params:u}),...h}),d=(i={},u={})=>G({queryKey:["activityTypes"],queryFn:()=>r.get("GetActivityTypes",{params:i}),...u}),b=E({mutationKey:["activities","cancel"],mutationFn:i=>r.get("CancelActivities",{params:i}),onSuccess:()=>s.invalidateQueries(["activities"])}),x=E({mutationKey:["activities","approve"],mutationFn:i=>r.get("ApproveActivities",{params:i}),onSuccess:()=>s.invalidateQueries(["activities"])}),g=E({mutationFn:i=>t.post("activities/reapply",{params:i}),onSuccess:()=>s.invalidateQueries(["activities"])}),A=E({mutationFn:i=>t.post("activities/revert",{params:i}),onSuccess:()=>s.invalidateQueries(["activities"])});return{getActivitiesQuery:y,getSingleActivityQuery:m,getActivityTypesQuery:d,cancelActivitiesQuery:b,approveActivitiesQuery:x,redoActivitiesQuery:g,undoActivitiesQuery:A,openActivityDetails:i=>{p(i.summary,e.jsx(_.Suspense,{fallback:e.jsx(P,{}),children:e.jsx(ce,{activityId:i.id})}))}}}function xe(r){const{state:t}=de(),s=t==null?void 0:t.activity;_.useEffect(()=>{t!=null&&t.activity&&(r(t.activity),window.history.replaceState({},""))},[s])}const fe="_statusIcon_1awqe_1",je="_output_1awqe_5",te={statusIcon:fe,output:je},ce=({activityId:r})=>{var Q,F,I,q,B,l,ee;const t=ae(),{confirmModal:s,closeConfirmModal:p}=oe(),{approveActivitiesQuery:y,cancelActivitiesQuery:m,getSingleActivityQuery:d,redoActivitiesQuery:b,undoActivitiesQuery:x}=Z(),{getInstancesQuery:g}=me(),{mutateAsync:A,isLoading:f}=y,{mutateAsync:i,isLoading:u}=m,{mutateAsync:h,isLoading:S}=b,{mutateAsync:w,isLoading:k}=x,{data:o,isLoading:v}=d({activityId:r}),n=o==null?void 0:o.data,{data:N}=g({query:`id:${n==null?void 0:n.computer_id}`,root_only:!1},{enabled:!!(n!=null&&n.computer_id)}),D=N&&N.data.results.length>0?N.data.results[0].title:"",M=async c=>{try{await A({query:`id:${c.id}`})}catch(j){t(j)}finally{p()}},L=c=>{s({title:"Approve activity",body:`Are you sure you want to approve ${c.summary} activity?`,buttons:[e.jsx(a.Button,{appearance:"positive",onClick:()=>M(c),children:"Approve"},"approve")]})},U=async c=>{try{await i({query:`id:${c.id}`})}catch(j){t(j)}finally{p()}},z=c=>{s({title:"Cancel activity",body:`Are you sure you want to cancel ${c.summary} activity?`,buttons:[e.jsx(a.Button,{appearance:"positive",onClick:()=>U(c),children:"Apply"},"cancel")]})},H=async c=>{try{await h({activityIds:[c.id]})}catch(j){t(j)}finally{p()}},W=c=>{s({title:"Redo activity",body:`Are you sure you want to redo ${c.summary} activity?`,buttons:[e.jsx(a.Button,{appearance:"positive",onClick:()=>H(c),children:"Redo"},"redo")]})},V=async c=>{try{await w({activityIds:[c.id]})}catch(j){t(j)}finally{p()}},K=c=>{s({title:"Undo activity",body:`Are you sure you want to undo ${c.summary} activity?`,buttons:[e.jsx(a.Button,{appearance:"positive",onClick:()=>V(c),children:"Undo"},"undo")]})};return e.jsxs(e.Fragment,{children:[v&&e.jsx(P,{}),!v&&n&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"p-segmented-control",children:e.jsxs("div",{className:"p-segmented-control__list",children:[((Q=n.actions)==null?void 0:Q.approvable)&&e.jsx(a.Button,{className:"p-segmented-control__button",type:"button",onClick:()=>L(n),disabled:f,children:"Approve"}),((F=n.actions)==null?void 0:F.cancelable)&&e.jsx(a.Button,{className:"p-segmented-control__button",type:"button",onClick:()=>z(n),disabled:u,children:!((I=n.actions)!=null&&I.approvable)&&!((q=n.actions)!=null&&q.reappliable)&&!((B=n.actions)!=null&&B.revertable)?"Cancel activity":"Cancel"}),((l=n.actions)==null?void 0:l.revertable)&&e.jsx(a.Button,{className:"p-segmented-control__button",type:"button",onClick:()=>K(n),disabled:k,children:"Undo"}),((ee=n.actions)==null?void 0:ee.reappliable)&&e.jsx(a.Button,{className:"p-segmented-control__button",type:"button",onClick:()=>W(n),disabled:S,children:"Redo"})]})},"buttons"),e.jsxs(a.Row,{className:"u-no-padding--left u-no-padding--right",children:[e.jsx(a.Col,{size:12,children:e.jsx(C,{label:"Description",value:n.summary})}),D&&e.jsx(a.Col,{size:12,children:e.jsx(C,{label:"Instance",value:D})}),e.jsx(a.Col,{size:6,children:e.jsx(C,{label:"Status",value:e.jsxs(e.Fragment,{children:[e.jsx(a.Icon,{name:$[n.activity_status].icon,className:te.statusIcon}),e.jsx("span",{children:$[n.activity_status].label})]})})}),e.jsx(a.Col,{size:6,children:e.jsx(C,{label:"Created at",value:Y(n.creation_time).format(O)})}),typeof n.delivery_time=="string"&&e.jsx(a.Col,{size:6,children:e.jsx(C,{label:"Delivered at",value:Y(n.delivery_time).format(O)})}),n.completion_time&&e.jsx(a.Col,{size:6,children:e.jsx(C,{label:"Completed at",value:Y(n.completion_time).format(O)})}),n.result_text&&e.jsx(a.Col,{size:12,children:e.jsx(C,{label:"Output",type:"snippet",value:n.result_text,className:te.output})})]})]})]})},Ce=Object.freeze(Object.defineProperty({__proto__:null,default:ce},Symbol.toStringTag,{value:"Module"})),Se=()=>e.jsx(ye,{body:e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"There are no activities yet."}),e.jsx("a",{href:"https://ubuntu.com/landscape/docs/managing-computers",target:"_blank",rel:"nofollow noopener noreferrer",children:"How to manage computers in Landscape"})]}),icon:"switcher-environments",title:"No activities found"}),we="_wrapper_1qrua_1",ke="_search_1qrua_9",Ne="_buttonContainer_1qrua_13",Te="_button_1qrua_13",$e="_icon_1qrua_43",T={wrapper:we,search:ke,buttonContainer:Ne,button:Te,icon:$e},De=({inputValue:r,onDescriptionClick:t,onInputChange:s,onSearchClick:p,onClear:y})=>e.jsxs("div",{className:T.wrapper,children:[e.jsx(a.SearchBox,{autocomplete:"off",shouldRefocusAfterReset:!0,externallyControlled:!0,value:r,onChange:s,onSearch:p,onClear:y,className:X("u-no-margin--bottom",T.search)}),e.jsx("div",{className:T.buttonContainer,children:e.jsx("button",{type:"button",onClick:t,className:T.button,children:e.jsx("i",{className:X("p-icon--help",T.icon)})})})]}),Le="_container_honpf_1",Qe="_searchContainer_honpf_8",Fe="_select_honpf_12",Ie="_cta_honpf_17",R={container:Le,searchContainer:Qe,select:Fe,cta:Ie},qe=[{term:"id:<activity_id>",description:"Search for activities with a specific ID."},{term:"parent-id:<parent_id>",description:"Search for children activities of a specific ID."},{term:"created-after:<date>",description:e.jsxs("span",{children:["Search for activities created after a specific date or time, specified with the ISO-8601 format. The precision depends on how far you specify, for example ",e.jsx("code",{children:"2011-01"}),", ",e.jsx("code",{children:"2011-01-01"}),","," ",e.jsx("code",{children:"2011-01-01T10:30"})," are valid values."]})},{term:"created-before:<date>",description:"Search for activities created before a specific date or time. The format is the same as created-after."},{term:"creator:<email>",description:"Search for activities created by a particular person (specified by email address)."},{term:"computer:<criteria>",description:"Search for activities related to the given instances. The criteria is itself another query argument to search instances. See Instance Queries for details."},{term:"type:<type>",description:"Search for activities of a specific type."}],Be=[{label:"All",value:""},...Object.entries($).filter(([r])=>r!=="unapproved").map(([r,{label:t}])=>({label:t,value:r}))],Ee=({resetSelectedIds:r,selectedIds:t})=>{const{search:s,status:p,setPageParams:y}=se(),m=ae(),{confirmModal:d,closeConfirmModal:b}=oe(),{approveActivitiesQuery:x,cancelActivitiesQuery:g,redoActivitiesQuery:A,undoActivitiesQuery:f}=Z(),[i,u]=_.useState(s),[h,S]=_.useState(!1),{mutateAsync:w,isLoading:k}=x,{mutateAsync:o,isLoading:v}=g,{mutateAsync:n,isLoading:N}=A,{mutateAsync:D,isLoading:M}=f,L=()=>{y({search:i,status:p}),r()},U=l=>{y({status:l})},z=()=>{y({search:""})},H=l=>{l.preventDefault(),L()},W=async()=>{try{await w({query:`id:${t.join(" OR id:")}`})}catch(l){m(l)}finally{b()}},V=()=>{d({title:`Approve ${t.length===1?"activity":"activities"}`,body:`Are you sure you want to approve selected ${t.length===1?"activity":"activities"}?`,buttons:[e.jsx(a.Button,{appearance:"positive",onClick:W,children:"Approve"},"approve")]})},K=async()=>{try{await o({query:`id:${t.join(" OR id:")}`})}catch(l){m(l)}finally{b()}},Q=()=>{d({title:`Cancel ${t.length===1?"activity":"activities"}`,body:`Are you sure you want to cancel selected ${t.length===1?"activity":"activities"}?`,buttons:[e.jsx(a.Button,{appearance:"positive",onClick:K,children:"Apply"},"cancel")]})},F=async()=>{try{await n({activityIds:t})}catch(l){m(l)}finally{b()}},I=()=>{d({title:`Redo ${t.length===1?"activity":"activities"}`,body:`Are you sure you want to redo selected ${t.length===1?"activity":"activities"}?`,buttons:[e.jsx(a.Button,{appearance:"positive",onClick:F,children:"Redo"},"redo")]})},q=async()=>{try{await D({activityIds:t})}catch(l){m(l)}finally{b()}},B=()=>{d({title:`Undo ${t.length===1?"activity":"activities"}`,body:`Are you sure you want to undo selected ${t.length===1?"activity":"activities"}?`,buttons:[e.jsx(a.Button,{appearance:"positive",onClick:q,children:"Undo"},"undo")]})};return e.jsxs("div",{className:R.container,children:[e.jsxs("div",{className:R.searchContainer,children:[e.jsx(a.Form,{onSubmit:H,noValidate:!0,children:e.jsx(De,{inputValue:i,onInputChange:l=>{u(l)},onSearchClick:L,onDescriptionClick:()=>S(!0),onClear:z})}),e.jsx(ge,{open:h,onClose:()=>{S(!1)},data:qe})]}),e.jsx(a.Select,{label:"Status",labelClassName:"u-no-margin--bottom",wrapperClassName:R.select,className:"u-no-margin--bottom",options:Be,onChange:l=>U(l.target.value),value:p}),e.jsx("div",{className:X("p-segmented-control",R.cta),children:e.jsxs("div",{className:"p-segmented-control__list",children:[e.jsx(a.Button,{className:"p-segmented-control__button u-no-margin--bottom",type:"button",onClick:V,disabled:t.length===0||k,children:"Approve"}),e.jsx(a.Button,{className:"p-segmented-control__button u-no-margin--bottom",type:"button",onClick:Q,disabled:t.length===0||v,children:"Cancel"}),e.jsx(a.Button,{className:"p-segmented-control__button u-no-margin--bottom",type:"button",onClick:B,disabled:t.length===0||M,children:"Undo"}),e.jsx(a.Button,{className:"p-segmented-control__button u-no-margin--bottom",type:"button",onClick:I,disabled:t.length===0||N,children:"Redo"})]})},"buttons")]})},Re="_checkbox_15zhq_1",Oe="_description_15zhq_5",ie={checkbox:Re,description:Oe},Pe=_.lazy(()=>ue(()=>Promise.resolve().then(()=>Ce),void 0)),it=({instanceId:r})=>{const[t,s]=_.useState([]),{search:p,status:y,currentPage:m,pageSize:d}=se(),{setSidePanelContent:b}=ne(),{getActivitiesQuery:x}=Z(),g=`${p}${y?` status:${y}`:""}`,A=o=>{b(o.summary,e.jsx(_.Suspense,{fallback:e.jsx(P,{}),children:e.jsx(Pe,{activityId:o.id})}))};xe(A);const f=()=>{s([])},{data:i,isLoading:u}=x({query:`${r?`computer:id:${r}`:""} ${g??""}`.trim(),limit:d,offset:(m-1)*d}),h=_.useMemo(()=>(i==null?void 0:i.data.results)??[],[i]),S=()=>{s(o=>o.length?[]:h.map(({id:v})=>v))},w=o=>{s(v=>v.includes(o)?v.filter(n=>n!==o):[...v,o])},k=_.useMemo(()=>[{accessor:"checkbox",className:ie.checkbox,Header:e.jsx(a.CheckboxInput,{label:e.jsx("span",{className:"u-off-screen",children:"Toggle all"}),inline:!0,onChange:S,checked:h.length>0&&t.length===h.length,indeterminate:t.length>0&&t.length<h.length}),Cell:({row:o})=>e.jsx(a.CheckboxInput,{label:e.jsx("span",{className:"u-off-screen",children:o.original.summary}),inline:!0,labelClassName:"u-no-margin--bottom u-no-padding--top",checked:t.includes(o.original.id),onChange:()=>{w(o.original.id)}})},{accessor:"summary",className:ie.description,Header:"Description",Cell:({row:o})=>e.jsx(a.Button,{appearance:"link",className:"u-no-margin--bottom u-no-padding--top u-align-text--left",onClick:()=>A(o.original),children:o.original.summary})},{accessor:"activity_status",Header:"Status",Cell:({row:{original:{activity_status:o}}})=>$[o].label,getCellIcon:({row:{original:{activity_status:o}}})=>$[o].icon},{accessor:"creation_time",Header:"Created at",Cell:({row:o})=>e.jsx(e.Fragment,{children:he(o.original.creation_time).format(O)})},{accessor:"creator.name",Header:"Creator",Cell:({row:o})=>{var v;return e.jsx(e.Fragment,{children:((v=o.original.creator)==null?void 0:v.name)??"-"})}}],[h,t]);return e.jsxs(e.Fragment,{children:[!g&&m===1&&d===50&&u&&e.jsx(P,{}),!g&&m===1&&d===50&&!u&&(!i||!i.data.count)&&e.jsx(Se,{}),(!!g||m!==1||d!==50||!u&&i&&i.data.count>0)&&e.jsxs(e.Fragment,{children:[e.jsx(Ee,{resetSelectedIds:f,selectedIds:t}),e.jsx(a.ModularTable,{emptyMsg:`No activities found with the search ${g}`,columns:k,data:h}),e.jsx(ve,{totalItems:i==null?void 0:i.data.count,currentItemCount:h.length,handleClearSelection:f})]})]})};export{$ as ACTIVITY_STATUSES,it as Activities,ce as ActivityDetails,Z as useActivities};
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = []
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
