import{j as e,g as N,m as z,n as f,H as V,p as j,t as D,k as q,v as E,i as G,l as B,h as d}from"./index-DA1zp4UR.js";import{h as L}from"./moment-C5S46NFB.js";import{S as U}from"./SidePanelFormButtons-D2iSfRBl.js";import{I as Y}from"./InfoItem-BjEVUTUX.js";import{u as O}from"./index-CV92uhB3.js";import{a as Q,I}from"./useUsns-BkT66Nsz.js";import{m as x}from"./moment-BhIxFDQN.js";import"./SidePanelFormButtons.module-yv6Qz3cN.js";import"./TablePagination-THfNRSZ8.js";import"./TablePagination.module-CgQ3jx4B.js";import"./usePageParams-BcTq1VJa.js";import"./SearchHelpPopup-Ck6SqPcm.js";import"./useFetchOld-DxdXVajm.js";import"./NoData-erdAyttJ.js";const R=({packageCount:r,securityUpgradePackageCount:a,totalUpgradePackageCount:l})=>{const n=l-a,t=r-l;return e.jsxs("div",{children:[e.jsx("span",{children:"You selected "}),e.jsx("span",{children:e.jsx("b",{children:r})}),e.jsx("span",{children:" packages. This will:"}),e.jsxs("ul",{className:N({"u-no-margin--bottom":t>0}),children:[a>0&&e.jsxs("li",{children:[e.jsx("span",{children:"apply "}),e.jsx("span",{children:e.jsx("b",{children:a})}),e.jsx("span",{children:a===1?" security upgrade":" security upgrades"})]}),n>0&&e.jsxs("li",{children:[e.jsx("span",{children:"apply "}),e.jsx("span",{children:e.jsx("b",{children:n})}),e.jsx("span",{children:n===1?" regular upgrade":" regular upgrades"})]})]}),t>0&&e.jsxs("p",{children:[e.jsx("span",{children:"No upgrades for "}),e.jsx("span",{children:e.jsx("b",{children:t})}),e.jsx("span",{children:t===1?" package needed.":" packages needed."})]})]})},H={deliver_after:"",deliver_delay_window:0,deliver_immediately:!0,randomize_delivery:!1,version:""},K=r=>z({deliver_after:f().when("deliver_immediately",{is:!1,then:a=>a.required("This field is required").test({test:l=>x(l).isValid()&&x(l).isAfter(x()),message:"You have to enter a valid date and time in the future"})}),deliver_delay_window:V().when("randomize_delivery",{is:!0,then:a=>a.min(0,"Delivery delay must be greater than or equal to 0")}),deliver_immediately:j(),randomize_delivery:j(),version:f().test({name:"required",message:"This field is required",params:{action:r},test:a=>r!=="downgrade"||!!a})}),M=(r,a)=>{const l=r.length>1?"selected packages":`${r[0].name} Package`;return`This will ${a==="hold"?"disable":"enable"} upgrades for the ${l}. It will ${a==="hold"?"not ":""}be eligible to upgrade to the latest available version.`},Z=(r,a,l)=>{const n=a.length>1?`${a.length} packages`:`${a[0].name} Package`,t={downgrade:"downgrade",hold:"held",remove:"uninstall",unhold:"unheld",upgrade:"upgrade"},g={downgrade:`be downgraded to ${l} version`,hold:"disable its upgrades",remove:"be uninstalled",unhold:"enable its upgrades",upgrade:"be upgraded"},v=`You queued ${n} to ${r!=="remove"?"be ":""}${t[r]}.`,_=`${n} ${a.length>1?"are":"is"} queued in Activities and will ${g[r]}.`;return{title:v,message:_}},J="_bold_1hrl2_1",W="_radioGroup_1hrl2_5",X="_marginTop_1hrl2_10",m={bold:J,radioGroup:W,marginTop:X},he=({action:r,packages:a})=>{const{instanceId:l,childInstanceId:n}=D(),t=q(),{notify:g}=E(),{openActivityDetails:v}=O(),{closeSidePanel:_}=G(),{downgradePackageVersionQuery:A,getDowngradePackageVersionsQuery:S,upgradePackagesQuery:k,packagesActionQuery:P}=Q(),u=Number(n??l),{data:y}=S({instanceId:u,packageName:a[0].name},{enabled:r==="downgrade"}),c=(y==null?void 0:y.data.results.map(({version:s})=>({label:s,value:s})))??[];c.unshift({label:"Select version",value:""});const b=a.filter(({status:s,available_version:p})=>s==="security"||s==="installed"&&p).map(({name:s})=>s),w=a.filter(({status:s})=>s==="security").length,{mutateAsync:$}=A,{mutateAsync:T}=k,{mutateAsync:C}=P,F=async s=>{const p={deliver_after:s.deliver_immediately?void 0:`${s.deliver_after}:00Z`,deliver_delay_window:s.randomize_delivery?s.deliver_delay_window:void 0};let h;r==="upgrade"?h=T({...p,packages:b,query:`id:${u}`}):r==="downgrade"?h=$({instanceId:u,package_name:a[0].name,package_version:s.version}):h=C({...p,action:r,computer_ids:[u],package_ids:a.map(({id:o})=>o)});try{const{data:o}=await h;_(),g.success({...Z(r,a,s.version),actions:[{label:"Details",onClick:()=>v(o)}]})}catch(o){t(o)}},i=B({initialValues:H,validationSchema:K(r),onSubmit:F});return e.jsxs(d.Form,{onSubmit:i.handleSubmit,noValidate:!0,children:[r==="downgrade"&&e.jsxs(d.Row,{className:"u-no-padding--left u-no-padding--right",children:[e.jsx(d.Col,{size:6,children:e.jsx(Y,{label:"Current version",value:a[0].current_version})}),e.jsx(d.Col,{size:6,children:c.length>1?e.jsx(d.Select,{label:"New version",className:"",labelClassName:"p-text--small u-text--muted u-no-margin--bottom p-text--small-caps",...i.getFieldProps("version"),options:c}):e.jsx("p",{children:"No downgrade versions"})})]}),r==="upgrade"&&(a.length!==b.length||w>0)&&e.jsx(R,{packageCount:a.length,securityUpgradePackageCount:w,totalUpgradePackageCount:b.length}),(r==="hold"||r==="unhold")&&e.jsx("p",{children:M(a,r)}),["remove","upgrade","hold","unhold"].includes(r)&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:m.bold,children:"Delivery time"}),e.jsxs("div",{className:m.radioGroup,children:[e.jsx(d.Input,{type:"radio",label:"As soon as possible",name:"deliver_immediately",checked:i.values.deliver_immediately,onChange:()=>{i.setFieldValue("deliver_immediately",!0)}}),e.jsx(d.Input,{type:"radio",label:"Scheduled",name:"deliver_immediately",checked:!i.values.deliver_immediately,onChange:()=>{i.setFieldValue("deliver_immediately",!1),i.setFieldValue("deliver_after",L().utc(!0).add(1,"minute").toISOString().slice(0,16))}})]}),!i.values.deliver_immediately&&e.jsx(d.Input,{type:"datetime-local",label:"Deliver after",labelClassName:"u-off-screen",...i.getFieldProps("deliver_after"),error:i.touched.deliver_after&&i.errors.deliver_after?i.errors.deliver_after:void 0}),e.jsx("span",{className:N(m.bold,m.marginTop),children:"Randomise delivery over a time window"}),e.jsxs("div",{className:m.radioGroup,children:[e.jsx(d.Input,{type:"radio",label:"No",name:"randomize_delivery",checked:!i.values.randomize_delivery,onChange:async()=>{await i.setFieldValue("randomize_delivery",!1),await i.setFieldValue("deliver_delay_window",0)}}),e.jsx(d.Input,{type:"radio",label:"Yes",name:"randomize_delivery",checked:i.values.randomize_delivery,onChange:()=>i.setFieldValue("randomize_delivery",!0)})]}),i.values.randomize_delivery&&e.jsx(d.Input,{type:"number",inputMode:"numeric",min:0,label:"Delivery delay window",labelClassName:"u-off-screen",help:"Time in minutes",...i.getFieldProps("deliver_delay_window"),error:i.touched.deliver_delay_window&&i.errors.deliver_delay_window?i.errors.deliver_delay_window:void 0})]}),(r!=="downgrade"||c.length>1)&&e.jsx(U,{submitButtonDisabled:i.isSubmitting,submitButtonText:I[r].label,submitButtonAppearance:I[r].appearance})]})};export{he as default};
