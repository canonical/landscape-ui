import{e as ce,u as re,c as ne,j as e,r as h,t as U,z as le,b as ae,d as a,y as O,f as Z,_ as ue}from"./index-CQs3wXys.js";import{h as G}from"./moment-Cl4UOzQZ.js";import{I as S}from"./InfoItem-BtzYmEJw.js";import{u as de}from"./useFetchOld-D-5JyUuM.js";import{u as P}from"./useMutation-D9dT1mhA.js";import{u as J}from"./useQuery-DrwXjJzc.js";import{u as oe}from"./useConfirm-9PPCxKmU.js";import{u as pe}from"./useInstances-A3J_BhkM.js";import{m as me}from"./moment-DDUBUQL9.js";import{T as he}from"./TablePagination-DIiSuGph.js";import{E as ve}from"./EmptyState-DNkTeHW1.js";import{S as ye}from"./SearchHelpPopup-CAM4EXp1.js";const ge="_iconError_j51du_1",be="_iconWarning_j51du_5",_e="_iconWarningRed_j51du_9",X={iconError:ge,iconWarning:be,iconWarningRed:_e},D={succeeded:{icon:"success",label:"Succeeded"},scheduled:{icon:"spinner",label:"Scheduled"},waiting:{icon:"status-waiting",label:"Waiting"},undelivered:{icon:"status-queued",label:"Queued"},delivered:{icon:"status-in-progress",label:"In progress"},blocked:{icon:`warning-grey ${X.iconWarningRed}`,label:"Blocked"},unapproved:{icon:`warning-grey ${X.iconWarning}`,label:"Unapproved"},canceled:{icon:"error-grey",label:"Cancelled"},failed:{icon:`error-grey ${X.iconError}`,label:"Failed"}};function ee(){const r=de(),o=ce(),i=re(),{setSidePanelContent:c}=ne(),x=(s={},v={})=>J({queryKey:["activities",s],queryFn:()=>o.get("activities",{params:s}),...v}),p=({activityId:s,...v},l={})=>J({queryKey:["activities",{activityId:s,...v}],queryFn:()=>o.get(`activities/${s}`,{params:v}),...l}),u=(s={},v={})=>J({queryKey:["activityTypes"],queryFn:()=>r.get("GetActivityTypes",{params:s}),...v}),y=P({mutationKey:["activities","cancel"],mutationFn:s=>r.get("CancelActivities",{params:s}),onSuccess:()=>i.invalidateQueries(["activities"])}),m=P({mutationKey:["activities","approve"],mutationFn:s=>r.get("ApproveActivities",{params:s}),onSuccess:()=>i.invalidateQueries(["activities"])}),f=P({mutationFn:s=>o.post("activities/reapply",{params:s}),onSuccess:()=>i.invalidateQueries(["activities"])}),_=P({mutationFn:s=>o.post("activities/revert",{params:s}),onSuccess:()=>i.invalidateQueries(["activities"])});return{getActivitiesQuery:x,getSingleActivityQuery:p,getActivityTypesQuery:u,cancelActivitiesQuery:y,approveActivitiesQuery:m,redoActivitiesQuery:f,undoActivitiesQuery:_,openActivityDetails:s=>{c(s.summary,e.jsx(h.Suspense,{fallback:e.jsx(U,{}),children:e.jsx(se,{activityId:s.id})}))}}}function Ae(r){const{state:o}=le(),i=o==null?void 0:o.activity;h.useEffect(()=>{o!=null&&o.activity&&(r(o.activity),window.history.replaceState({},""))},[i])}const xe="_statusIcon_1awqe_1",fe="_output_1awqe_5",te={statusIcon:xe,output:fe},se=({activityId:r})=>{var L,Q,I,q,R,B,E;const o=ae(),{confirmModal:i,closeConfirmModal:c}=oe(),{approveActivitiesQuery:x,cancelActivitiesQuery:p,getSingleActivityQuery:u,redoActivitiesQuery:y,undoActivitiesQuery:m}=ee(),{getInstancesQuery:f}=pe(),{mutateAsync:_,isLoading:A}=x,{mutateAsync:s,isLoading:v}=p,{mutateAsync:l,isLoading:j}=y,{mutateAsync:g,isLoading:k}=m,{data:C,isLoading:w}=u({activityId:r}),t=C==null?void 0:C.data,{data:d}=f({query:`id:${t==null?void 0:t.computer_id}`,root_only:!1},{enabled:!!(t!=null&&t.computer_id)}),$=d&&d.data.results.length>0?d.data.results[0].title:"",H=async n=>{try{await _({query:`id:${n.id}`})}catch(b){o(b)}finally{c()}},M=n=>{i({title:"Approve activity",body:`Are you sure you want to approve ${n.summary} activity?`,buttons:[e.jsx(a.Button,{appearance:"positive",onClick:()=>H(n),children:"Approve"},"approve")]})},N=async n=>{try{await s({query:`id:${n.id}`})}catch(b){o(b)}finally{c()}},F=n=>{i({title:"Cancel activity",body:`Are you sure you want to cancel ${n.summary} activity?`,buttons:[e.jsx(a.Button,{appearance:"positive",onClick:()=>N(n),children:"Apply"},"cancel")]})},W=async n=>{try{await l({activityIds:[n.id]})}catch(b){o(b)}finally{c()}},V=n=>{i({title:"Redo activity",body:`Are you sure you want to redo ${n.summary} activity?`,buttons:[e.jsx(a.Button,{appearance:"positive",onClick:()=>W(n),children:"Redo"},"redo")]})},K=async n=>{try{await g({activityIds:[n.id]})}catch(b){o(b)}finally{c()}},Y=n=>{i({title:"Undo activity",body:`Are you sure you want to undo ${n.summary} activity?`,buttons:[e.jsx(a.Button,{appearance:"positive",onClick:()=>K(n),children:"Undo"},"undo")]})};return e.jsxs(e.Fragment,{children:[w&&e.jsx(U,{}),!w&&t&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"p-segmented-control",children:e.jsxs("div",{className:"p-segmented-control__list",children:[((L=t.actions)==null?void 0:L.approvable)&&e.jsx(a.Button,{className:"p-segmented-control__button",type:"button",onClick:()=>M(t),disabled:A,children:"Approve"}),((Q=t.actions)==null?void 0:Q.cancelable)&&e.jsx(a.Button,{className:"p-segmented-control__button",type:"button",onClick:()=>F(t),disabled:v,children:!((I=t.actions)!=null&&I.approvable)&&!((q=t.actions)!=null&&q.reappliable)&&!((R=t.actions)!=null&&R.revertable)?"Cancel activity":"Cancel"}),((B=t.actions)==null?void 0:B.revertable)&&e.jsx(a.Button,{className:"p-segmented-control__button",type:"button",onClick:()=>Y(t),disabled:k,children:"Undo"}),((E=t.actions)==null?void 0:E.reappliable)&&e.jsx(a.Button,{className:"p-segmented-control__button",type:"button",onClick:()=>V(t),disabled:j,children:"Redo"})]})},"buttons"),e.jsxs(a.Row,{className:"u-no-padding--left u-no-padding--right",children:[e.jsx(a.Col,{size:12,children:e.jsx(S,{label:"Description",value:t.summary})}),$&&e.jsx(a.Col,{size:12,children:e.jsx(S,{label:"Instance",value:$})}),e.jsx(a.Col,{size:6,children:e.jsx(S,{label:"Status",value:e.jsxs(e.Fragment,{children:[e.jsx(a.Icon,{name:D[t.activity_status].icon,className:te.statusIcon}),e.jsx("span",{children:D[t.activity_status].label})]})})}),e.jsx(a.Col,{size:6,children:e.jsx(S,{label:"Created at",value:G(t.creation_time).format(O)})}),typeof t.delivery_time=="string"&&e.jsx(a.Col,{size:6,children:e.jsx(S,{label:"Delivered at",value:G(t.delivery_time).format(O)})}),t.completion_time&&e.jsx(a.Col,{size:6,children:e.jsx(S,{label:"Completed at",value:G(t.completion_time).format(O)})}),t.result_text&&e.jsx(a.Col,{size:12,children:e.jsx(S,{label:"Output",type:"snippet",value:t.result_text,className:te.output})})]})]})]})},je=Object.freeze(Object.defineProperty({__proto__:null,default:se},Symbol.toStringTag,{value:"Module"})),Ce=()=>e.jsx(ve,{body:e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"There are no activities yet."}),e.jsx("a",{href:"https://ubuntu.com/landscape/docs/managing-computers",target:"_blank",rel:"nofollow noopener noreferrer",children:"How to manage computers in Landscape"})]}),icon:"switcher-environments",title:"No activities found"}),Se="_wrapper_1qrua_1",we="_search_1qrua_9",$e="_buttonContainer_1qrua_13",ke="_button_1qrua_13",Ne="_icon_1qrua_43",T={wrapper:Se,search:we,buttonContainer:$e,button:ke,icon:Ne},Te=({inputValue:r,onDescriptionClick:o,onInputChange:i,onSearchClick:c,onClear:x})=>e.jsxs("div",{className:T.wrapper,children:[e.jsx(a.SearchBox,{autocomplete:"off",shouldRefocusAfterReset:!0,externallyControlled:!0,value:r,onChange:i,onSearch:c,onClear:x,className:Z("u-no-margin--bottom",T.search)}),e.jsx("div",{className:T.buttonContainer,children:e.jsx("button",{type:"button",onClick:o,className:T.button,children:e.jsx("i",{className:Z("p-icon--help",T.icon)})})})]}),De="_container_honpf_1",Fe="_searchContainer_honpf_8",Le="_select_honpf_12",Qe="_cta_honpf_17",z={container:De,searchContainer:Fe,select:Le,cta:Qe},Ie=[{term:"id:<activity_id>",description:"Search for activities with a specific ID."},{term:"parent-id:<parent_id>",description:"Search for children activities of a specific ID."},{term:"created-after:<date>",description:e.jsxs("span",{children:["Search for activities created after a specific date or time, specified with the ISO-8601 format. The precision depends on how far you specify, for example ",e.jsx("code",{children:"2011-01"}),", ",e.jsx("code",{children:"2011-01-01"}),","," ",e.jsx("code",{children:"2011-01-01T10:30"})," are valid values."]})},{term:"created-before:<date>",description:"Search for activities created before a specific date or time. The format is the same as created-after."},{term:"creator:<email>",description:"Search for activities created by a particular person (specified by email address)."},{term:"computer:<criteria>",description:"Search for activities related to the given instances. The criteria is itself another query argument to search instances. See Instance Queries for details."},{term:"type:<type>",description:"Search for activities of a specific type."}],qe=[{label:"All",value:""},...Object.entries(D).filter(([r])=>r!=="unapproved").map(([r,{label:o}])=>({label:o,value:r}))],Re=({resetPage:r,resetSelectedIds:o,selectedIds:i,setSearchQuery:c})=>{const[x,p]=h.useState(!1),[u,y]=h.useState(""),[m,f]=h.useState(""),_=ae(),{confirmModal:A,closeConfirmModal:s}=oe(),{approveActivitiesQuery:v,cancelActivitiesQuery:l,redoActivitiesQuery:j,undoActivitiesQuery:g}=ee(),{mutateAsync:k,isLoading:C}=v,{mutateAsync:w,isLoading:t}=l,{mutateAsync:d,isLoading:$}=j,{mutateAsync:H,isLoading:M}=g,N=()=>{r(),o()},F=()=>{c(u?`${u}${m?` status:${m}`:""}`:m?`status:${m}`:""),N()},W=n=>{const b=n.target.value;f(b),c(b?`status:${b}${u?` ${u}`:""}`:u),N()},V=()=>{y(""),c(m?`status:${m}`:""),N()},K=n=>{n.preventDefault(),F()},Y=async()=>{try{await k({query:`id:${i.join(" OR id:")}`})}catch(n){_(n)}finally{s()}},L=()=>{A({title:`Approve ${i.length===1?"activity":"activities"}`,body:`Are you sure you want to approve selected ${i.length===1?"activity":"activities"}?`,buttons:[e.jsx(a.Button,{appearance:"positive",onClick:Y,children:"Approve"},"approve")]})},Q=async()=>{try{await w({query:`id:${i.join(" OR id:")}`})}catch(n){_(n)}finally{s()}},I=()=>{A({title:`Cancel ${i.length===1?"activity":"activities"}`,body:`Are you sure you want to cancel selected ${i.length===1?"activity":"activities"}?`,buttons:[e.jsx(a.Button,{appearance:"positive",onClick:Q,children:"Apply"},"cancel")]})},q=async()=>{try{await d({activityIds:i})}catch(n){_(n)}finally{s()}},R=()=>{A({title:`Redo ${i.length===1?"activity":"activities"}`,body:`Are you sure you want to redo selected ${i.length===1?"activity":"activities"}?`,buttons:[e.jsx(a.Button,{appearance:"positive",onClick:q,children:"Redo"},"redo")]})},B=async()=>{try{await H({activityIds:i})}catch(n){_(n)}finally{s()}},E=()=>{A({title:`Undo ${i.length===1?"activity":"activities"}`,body:`Are you sure you want to undo selected ${i.length===1?"activity":"activities"}?`,buttons:[e.jsx(a.Button,{appearance:"positive",onClick:B,children:"Undo"},"undo")]})};return e.jsxs("div",{className:z.container,children:[e.jsxs("div",{className:z.searchContainer,children:[e.jsx(a.Form,{onSubmit:K,noValidate:!0,children:e.jsx(Te,{inputValue:u,onInputChange:n=>{y(n)},onSearchClick:F,onDescriptionClick:()=>p(!0),onClear:V})}),e.jsx(ye,{open:x,onClose:()=>{p(!1)},data:Ie})]}),e.jsx(a.Select,{label:"Status",labelClassName:"u-no-margin--bottom",wrapperClassName:z.select,className:"u-no-margin--bottom",options:qe,value:m,onChange:W}),e.jsx("div",{className:Z("p-segmented-control",z.cta),children:e.jsxs("div",{className:"p-segmented-control__list",children:[e.jsx(a.Button,{className:"p-segmented-control__button u-no-margin--bottom",type:"button",onClick:L,disabled:i.length===0||C,children:"Approve"}),e.jsx(a.Button,{className:"p-segmented-control__button u-no-margin--bottom",type:"button",onClick:I,disabled:i.length===0||t,children:"Cancel"}),e.jsx(a.Button,{className:"p-segmented-control__button u-no-margin--bottom",type:"button",onClick:E,disabled:i.length===0||M,children:"Undo"}),e.jsx(a.Button,{className:"p-segmented-control__button u-no-margin--bottom",type:"button",onClick:R,disabled:i.length===0||$,children:"Redo"})]})},"buttons")]})},Be="_checkbox_15zhq_1",Ee="_description_15zhq_5",ie={checkbox:Be,description:Ee},Pe=h.lazy(()=>ue(()=>Promise.resolve().then(()=>je),void 0)),Ze=({instanceId:r})=>{const[o,i]=h.useState(1),[c,x]=h.useState(50),[p,u]=h.useState([]),[y,m]=h.useState(""),{setSidePanelContent:f}=ne(),{getActivitiesQuery:_}=ee(),A=t=>{f(t.summary,e.jsx(h.Suspense,{fallback:e.jsx(U,{}),children:e.jsx(Pe,{activityId:t.id})}))};Ae(A);const s=t=>{i(t),u([])},v=t=>{x(t),s(1)},{data:l,isLoading:j}=_({query:`${r?`computer:id:${r}`:""} ${y??""}`.trim(),limit:c,offset:(o-1)*c}),g=h.useMemo(()=>(l==null?void 0:l.data.results)??[],[l]),k=()=>{u(t=>t.length?[]:g.map(({id:d})=>d))},C=t=>{u(d=>d.includes(t)?d.filter($=>$!==t):[...d,t])},w=h.useMemo(()=>[{accessor:"checkbox",className:ie.checkbox,Header:e.jsx(a.CheckboxInput,{label:e.jsx("span",{className:"u-off-screen",children:"Toggle all"}),inline:!0,onChange:k,checked:g.length>0&&p.length===g.length,indeterminate:p.length>0&&p.length<g.length}),Cell:({row:t})=>e.jsx(a.CheckboxInput,{label:e.jsx("span",{className:"u-off-screen",children:t.original.summary}),inline:!0,labelClassName:"u-no-margin--bottom u-no-padding--top",checked:p.includes(t.original.id),onChange:()=>{C(t.original.id)}})},{accessor:"summary",className:ie.description,Header:"Description",Cell:({row:t})=>e.jsx(a.Button,{appearance:"link",className:"u-no-margin--bottom u-no-padding--top u-align-text--left",onClick:()=>A(t.original),children:t.original.summary})},{accessor:"activity_status",Header:"Status",Cell:({row:{original:{activity_status:t}}})=>D[t].label,getCellIcon:({row:{original:{activity_status:t}}})=>D[t].icon},{accessor:"creation_time",Header:"Created at",Cell:({row:t})=>e.jsx(e.Fragment,{children:me(t.original.creation_time).format(O)})},{accessor:"creator.name",Header:"Creator",Cell:({row:t})=>{var d;return e.jsx(e.Fragment,{children:((d=t.original.creator)==null?void 0:d.name)??"-"})}}],[g,p]);return e.jsxs(e.Fragment,{children:[!y&&o===1&&c===50&&j&&e.jsx(U,{}),!y&&o===1&&c===50&&!j&&(!l||!l.data.count)&&e.jsx(Ce,{}),(!!y||o!==1||c!==50||!j&&l&&l.data.count>0)&&e.jsxs(e.Fragment,{children:[e.jsx(Re,{resetPage:()=>i(1),resetSelectedIds:()=>u([]),selectedIds:p,setSearchQuery:t=>{m(t)}}),e.jsx(a.ModularTable,{columns:w,data:g}),e.jsx(he,{currentPage:o,totalItems:l==null?void 0:l.data.count,paginate:s,pageSize:c,setPageSize:v,currentItemCount:g.length})]})]})};export{D as ACTIVITY_STATUSES,Ze as Activities,se as ActivityDetails,ee as useActivities};
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = []
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
