const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-CpEN8w34.js","assets/index-Bd4iIRe_.js","assets/index-C0ZxZ9J6.css","assets/SidePanelFormButtons-vMl4fSkh.js","assets/SidePanelFormButtons.module-C5v714vX.js","assets/SidePanelFormButtons-Cl1KfOFD.css","assets/MultiSelectField-BNuKZ8xw.js","assets/MultiSelectField-GyNA33om.css","assets/TablePagination-9gj_8Kgx.js","assets/usePageParams-CGqhdr-B.js","assets/TablePaginationBase-BDX0aSIU.js","assets/TablePaginationBase-CJl3HN1X.css","assets/helpers-Cr00MT1Y.js","assets/HeaderWithSearch-BZcWm4PV.js","assets/HeaderWithSearch-Dlfhk-35.css","assets/NoData-BBZVu-3W.js","assets/output-DFRNcfG-.js","assets/index-WHHlMfrO.js"])))=>i.map(i=>d[i]);
import{r as b,e as J,b as Z,c as j,d as A,o as L,p as G,f as F,s as ee,h as se,l as y,t as te,j as e,g as r,_ as Q,q as ne,m as oe,n as C,E as re,L as ae}from"./index-Bd4iIRe_.js";import{T as ie}from"./TablePagination-9gj_8Kgx.js";import{u as v}from"./usePageParams-CGqhdr-B.js";import{S as ce}from"./SidePanelFormButtons-vMl4fSkh.js";import{g as ue,r as q,U as K,a as le}from"./helpers-Cr00MT1Y.js";import{H as de}from"./HeaderWithSearch-BZcWm4PV.js";import{N as me}from"./NoData-BBZVu-3W.js";import{g as pe}from"./output-DFRNcfG-.js";function he({data:s,sortFunctions:o}){const{sortBy:i,sort:c}=v();return b.useMemo(()=>{const u=o[i];return!i||!c||!u?s:s.toSorted((m,p)=>{const h=u(m,p);return c==="asc"?h:-h})},[s,i,c,o])}function $(){const s=J(),o=Z(),i=(t,g={})=>A({queryKey:["users",{...t}],queryFn:()=>s.get("users",{params:t}),...g}),c=j({mutationKey:["users","new"],mutationFn:t=>s.post("users",t),onSuccess:()=>o.invalidateQueries({queryKey:["users"]})}),u=j({mutationKey:["users","edit"],mutationFn:t=>s.put("users",t),onSuccess:()=>o.invalidateQueries({queryKey:["users"]})}),m=j({mutationKey:["users","remove"],mutationFn:t=>s.delete("users",{params:t}),onSuccess:()=>o.invalidateQueries({queryKey:["users"]})}),p=j({mutationKey:["users","lock"],mutationFn:t=>s.post("users/lock",t),onSuccess:()=>o.invalidateQueries({queryKey:["users"]})}),h=j({mutationKey:["users","unlock"],mutationFn:t=>s.post("users/unlock",t),onSuccess:()=>o.invalidateQueries({queryKey:["users"]})}),f=(t,g={})=>A({queryKey:["groups",(t==null?void 0:t.computer_id)??""],queryFn:()=>{if(!t)throw new Error("Missing required parameters");return s.get(`computers/${t.computer_id}/groups`)},...g}),x=(t,g={})=>A({queryKey:["userGroups",(t==null?void 0:t.computer_id)??"",(t==null?void 0:t.username)??""],queryFn:()=>{if(!t)throw new Error("Missing required parameters");return s.get(`computers/${t.computer_id}/users/${t.username}/groups`)},...g}),d=j({mutationKey:["groups","add"],mutationFn:t=>s.post(`computers/${t.computer_id}/usergroups/update_bulk`,t),onSuccess:()=>o.invalidateQueries({queryKey:["users"]})}),n=j({mutationKey:["groups","remove"],mutationFn:t=>s.post(`computers/${t.computer_id}/usergroups/update_bulk`,t),onSuccess:()=>o.invalidateQueries({queryKey:["users"]})});return{getUsersQuery:i,getGroupsQuery:f,getUserGroupsQuery:x,createUserQuery:c,removeUserQuery:m,editUserQuery:u,lockUserQuery:p,unlockUserQuery:h,addUserToGroupQuery:d,removeUserFromGroupQuery:n}}const ge="_actions_1l3g0_1",be={actions:ge},O=()=>{const{instanceId:s}=L(),o=G(),{closeSidePanel:i}=F(),{createUserQuery:c,getGroupsQuery:u}=$(),m=Number(s),{mutateAsync:p}=c,{data:h,isLoading:f}=u({computer_id:m}),d=((h==null?void 0:h.data.groups)??[]).map(t=>({label:t.name,value:t.name})),n=ee({initialValues:{name:"",username:"",password:"",confirmPassword:"",requirePasswordReset:!1,location:"",homePhoneNumber:"",workPhoneNumber:"",primaryGroupValue:""},validationSchema:se().shape({name:y().required("This field is required"),username:y().required("This field is required"),password:y().required("This field is required"),confirmPassword:y().required("This field is required").oneOf([te("password"),""],"Passwords must match"),location:y(),homePhoneNumber:y(),workPhoneNumber:y(),primaryGroupValue:y().required("This field is required")}),onSubmit:async t=>{try{await p({computer_ids:[m],name:t.name,username:t.username,password:t.password,require_password_reset:t.requirePasswordReset,location:t.location,home_phone:t.homePhoneNumber,work_phone:t.workPhoneNumber,primary_groupname:t.primaryGroupValue}),i()}catch(g){o(g)}}});return e.jsxs(r.Form,{noValidate:!0,onSubmit:n.handleSubmit,name:"add-new-user",children:[e.jsx(r.Input,{type:"text",label:"Username",autoComplete:"new-username",required:!0,error:n.touched.username&&n.errors.username?n.errors.username:void 0,...n.getFieldProps("username")}),e.jsx(r.Input,{type:"text",label:"Name",required:!0,error:n.touched.name&&n.errors.name?n.errors.name:void 0,...n.getFieldProps("name")}),e.jsx(r.Input,{type:"password",label:"Passphrase",autoComplete:"new-password",required:!0,error:n.touched.password&&n.errors.password?n.errors.password:void 0,...n.getFieldProps("password")}),e.jsx(r.Input,{type:"password",label:"Confirm passphrase",autoComplete:"new-password",required:!0,error:n.touched.confirmPassword&&n.errors.confirmPassword?n.errors.confirmPassword:void 0,...n.getFieldProps("confirmPassword")}),e.jsx(r.Input,{type:"checkbox",label:"Require passphrase reset",help:"User must change password at first login",...n.getFieldProps("requirePasswordReset"),checked:n.values.requirePasswordReset}),e.jsx(r.Select,{label:"Primary Group",disabled:f,options:[{label:"Select",value:""},...d],...n.getFieldProps("primaryGroupValue"),error:n.touched.primaryGroupValue&&n.errors.primaryGroupValue?n.errors.primaryGroupValue:void 0}),e.jsx(r.Input,{type:"text",label:"Location",error:n.touched.location&&n.errors.location?n.errors.location:void 0,...n.getFieldProps("location")}),e.jsx(r.Input,{type:"text",label:"Home phone",error:n.touched.homePhoneNumber&&n.errors.homePhoneNumber?n.errors.homePhoneNumber:void 0,...n.getFieldProps("homePhoneNumber")}),e.jsx(r.Input,{type:"text",label:"Work phone",error:n.touched.workPhoneNumber&&n.errors.workPhoneNumber?n.errors.workPhoneNumber:void 0,...n.getFieldProps("workPhoneNumber")}),e.jsx(ce,{submitButtonDisabled:n.isSubmitting,submitButtonText:"Add user"})]})},fe=b.lazy(()=>Q(()=>import("./index-CpEN8w34.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16]))),xe=({selectedUsers:s,handleClearSelection:o,sidePanel:i=!1})=>{const[c,u]=b.useState(!1),{instanceId:m}=L(),p=G(),{notify:h}=ne(),{setSidePanelContent:f,closeSidePanel:x}=F(),{removeUserQuery:d,lockUserQuery:n,unlockUserQuery:t}=$(),{mutateAsync:g,isPending:a}=d,{mutateAsync:_,isPending:k}=n,{mutateAsync:U,isPending:N}=t,w=Number(m),l=s.length===1?s[0]:void 0,{locked:T,unlocked:D}=ue(s),B=async(S,M)=>{try{await S({computer_ids:[w],usernames:le(s),delete_home:M==="removed"?c:void 0}),o&&o(),x(),h.success({message:`Successfully requested to be ${M}`})}catch(X){p(X)}},V=async()=>{await B(_,"locked")},R=async()=>{await B(U,"unlocked")},H=async()=>{await B(g,"removed")},z=()=>{f("Add new user",e.jsx(O,{}))},Y=S=>{f("Edit user",e.jsx(b.Suspense,{fallback:e.jsx(C,{}),children:e.jsx(fe,{user:S})}))},W=()=>{u(S=>!S)};return e.jsxs("div",{className:oe("p-panel__controls u-no-padding--top",{"u-no-margin--left":i}),children:[!i&&e.jsxs(r.Button,{className:"u-no-margin--right",type:"button",hasIcon:!0,onClick:z,children:[e.jsx(r.Icon,{name:r.ICONS.plus}),e.jsx("span",{children:"Add user"})]}),e.jsx("div",{className:"p-segmented-control",children:e.jsxs("div",{className:"p-segmented-control__list",children:[((l==null?void 0:l.enabled)||!i)&&e.jsxs(r.ConfirmationButton,{className:"p-segmented-control__button has-icon",type:"button",disabled:D===0,"aria-disabled":D===0,confirmationModalProps:{title:`Lock ${l?`user ${l.username}`:`${s.length} users`}`,children:q({user:l,selectedUsers:s,userAction:K.Lock}),confirmButtonLabel:"Lock",confirmButtonAppearance:"positive",confirmButtonLoading:k,confirmButtonDisabled:k,onConfirm:V},children:[e.jsx(r.Icon,{name:"lock-locked"}),e.jsx("span",{children:"Lock"})]}),(!(l!=null&&l.enabled)||!i)&&e.jsxs(r.ConfirmationButton,{className:"p-segmented-control__button has-icon",type:"button",disabled:T===0,"aria-disabled":T===0,confirmationModalProps:{title:`Unlock ${l?`user ${l.username}`:`${s.length} users`}`,children:q({user:l,selectedUsers:s,userAction:K.Unlock}),confirmButtonLabel:"Unlock",confirmButtonAppearance:"positive",confirmButtonLoading:N,confirmButtonDisabled:N,onConfirm:R},children:[e.jsx(r.Icon,{name:"lock-unlock"}),e.jsx("span",{children:"Unlock"})]}),i&&l&&e.jsxs(r.Button,{className:"p-segmented-control__button",type:"button",onClick:()=>Y(l),children:[e.jsx(r.Icon,{name:"edit"}),e.jsx("span",{children:"Edit"})]}),e.jsxs(r.ConfirmationButton,{className:"p-segmented-control__button has-icon",type:"button",disabled:s.length===0,"aria-disabled":s.length===0,confirmationModalProps:{title:`Delete ${l?l.username:"users"}`,children:e.jsxs("div",{children:[e.jsx("p",{className:"u-no-margin--bottom",children:l?`This will delete user ${l.username}. You can delete this user's home folders at the same time.`:"This will delete selected users. You can delete their home folders as well."}),e.jsx(r.Input,{label:"Delete the home folders as well",type:"checkbox",checked:c,onChange:W})]}),confirmButtonLabel:"Delete",confirmButtonAppearance:"negative",confirmButtonLoading:a,confirmButtonDisabled:a,onConfirm:H},children:[e.jsx(r.Icon,{name:r.ICONS.delete}),e.jsx("span",{children:"Delete"})]})]})})]})},ye=(s,o)=>s.filter(i=>o.includes(i.uid)),ke=({selected:s,handleClearSelection:o,users:i})=>{const{setPageParams:c}=v(),u=m=>{c({search:m}),o()};return e.jsx(de,{onSearch:u,actions:e.jsx("div",{className:be.actions,children:e.jsx(xe,{handleClearSelection:o,selectedUsers:ye(i,s)})})})},P={username:"username",status:"status",name:"name",uid:"uid"},je={username:(s,o)=>s.username.localeCompare(o.username),status:(s,o)=>Number(s.enabled)-Number(o.enabled),name:(s,o)=>(s.name||"").localeCompare(o.name||""),uid:(s,o)=>s.uid-o.uid},_e="_status_r5cf6_1",we="_statusCell_r5cf6_7",Se="_actions_r5cf6_12",I={status:_e,statusCell:we,actions:Se},Ue=b.lazy(()=>Q(()=>import("./index-CpEN8w34.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16]))),Ne=b.lazy(()=>Q(()=>import("./index-WHHlMfrO.js"),__vite__mapDeps([17,1,2,15,8,9,10,11,3,4,5,12,13,14,16]))),Pe=({users:s,selected:o,setSelected:i})=>{const{setPageParams:c,sortBy:u,sort:m}=v(),{setSidePanelContent:p}=F(),h=a=>{p("Edit user",e.jsx(b.Suspense,{fallback:e.jsx(C,{}),children:e.jsx(Ue,{user:a})}))},f=a=>{p("User details",e.jsx(b.Suspense,{fallback:e.jsx(C,{}),children:e.jsx(Ne,{user:a})}))},x=()=>{i(o.length!==0?[]:s.map(({uid:a})=>a))},d=a=>{o.includes(a)?i(o.filter(_=>_!==a)):i([...o,a])},n=b.useMemo(()=>[{className:"checkbox-column",content:e.jsx(r.CheckboxInput,{label:e.jsx("span",{className:"u-off-screen",children:"Toggle all"}),labelClassName:"u-no-margin--bottom u-no-padding--top",onChange:x,checked:s.length>0&&o.length===s.length,indeterminate:o.length>0&&o.length<s.length,disabled:s.length===0})},{sortKey:P.username,content:"username"},{content:"status",sortKey:P.status},{content:"uid",sortKey:P.uid},{content:"full name",sortKey:P.name},{content:null,className:I.actions}],[s,o]),t=b.useMemo(()=>s.map(a=>({columns:[{accessor:"checkbox",className:"checkbox-column",content:e.jsx(r.CheckboxInput,{inline:!0,label:e.jsxs("span",{className:"u-off-screen",children:["Select user ",a.username]}),disabled:s.length===0,checked:o.includes(a.uid),onChange:()=>d(a.uid)})},{content:e.jsx(r.Button,{type:"button",appearance:"link",className:"u-no-margin--bottom u-no-padding--top",onClick:()=>f(a),"aria-label":`Show details of user ${a.username}`,children:a.username}),role:"rowheader"},{className:I.statusCell,content:e.jsx("div",{className:I.status,children:a.enabled?e.jsxs(e.Fragment,{children:[e.jsx(r.Icon,{name:"lock-unlock"}),e.jsx("span",{children:"Unlocked"})]}):e.jsxs(e.Fragment,{children:[e.jsx(r.Icon,{name:"lock-locked-active"}),e.jsx("span",{children:"Locked"})]})})},{content:a.uid},{content:a.name||e.jsx(me,{})},{className:I.actions,content:e.jsx(r.Tooltip,{message:"Edit",position:"btm-center",children:e.jsx(r.Button,{type:"button",small:!0,hasIcon:!0,appearance:"base",className:"u-no-margin--bottom u-no-padding--left","aria-label":`Edit ${a.name} profile`,onClick:()=>h(a),children:e.jsx(r.Icon,{name:"edit",className:"u-no-margin--left"})})})}]})),[s,o]),g=a=>{if(i([]),!a){c({sort:null,sortBy:""});return}c({sort:a===u&&m==="asc"?"desc":"asc",sortBy:a})};return e.jsx(r.MainTable,{headers:n,rows:t,onUpdateSort:g,defaultSort:u,defaultSortDirection:pe(m),sortable:!0,emptyStateMsg:"No users available"})},Ie=(s,o)=>s?o.filter(({username:i,name:c})=>{const u=c==null?void 0:c.toUpperCase().includes(s.toUpperCase()),m=i.toUpperCase().includes(s.toUpperCase());return u||m}):o,Ce="_link_1wvsk_1",Fe={link:Ce},E=5e3,ve=()=>{const[s,o]=b.useState([]),{instanceId:i,childInstanceId:c}=L(),{search:u,currentPage:m,pageSize:p}=v(),{setSidePanelContent:h}=F(),{getUsersQuery:f}=$(),x=Number(c??i),{data:d,isLoading:n}=f({computer_id:x,limit:E}),t=(d==null?void 0:d.data.results)??[],g=he({data:t,sortFunctions:je}),a=Ie(u,g),_=(w,l)=>a.slice(l,l+w),k=b.useMemo(()=>_(p,(m-1)*p),[u,a,m,p]),U=()=>{o([])},N=()=>{h("Add new user",e.jsx(O,{}))};return e.jsxs(e.Fragment,{children:[!u&&n&&e.jsx(C,{}),!n&&!u&&(!d||d.data.results.length===0)&&e.jsx(re,{title:"No users found",body:"Add new users by clicking the button below",icon:"connected",cta:[e.jsx(r.Button,{type:"button",appearance:"positive",onClick:N,children:"Add user"},"empty-state-add-new-user")]}),(u||!n&&k.length>0)&&e.jsxs(e.Fragment,{children:[e.jsx(ke,{selected:s,handleClearSelection:U,users:k}),(d==null?void 0:d.data.count)&&d.data.count>E&&e.jsx(r.Notification,{severity:"caution",title:`Fetched ${E} out of ${d==null?void 0:d.data.count} users`,children:e.jsxs("span",{children:["The number of requested users is too high. Please"," ",e.jsx(ae,{to:"https://support-portal.canonical.com/",className:Fe.link,children:"contact our support team."})]})}),e.jsx(Pe,{selected:s,setSelected:w=>o(w),users:k})]}),e.jsx(ie,{handleClearSelection:U,totalItems:a.length,currentItemCount:k.length})]})},Me=Object.freeze(Object.defineProperty({__proto__:null,default:ve},Symbol.toStringTag,{value:"Module"}));export{xe as U,Me as i,$ as u};
