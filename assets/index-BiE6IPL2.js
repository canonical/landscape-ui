import{d as S,k as M,l as D,z as O,O as E,ar as w,B as $,f as x,C as q,aU as H,aV as L,ab as Q,s as U,n as v,t as z,v as Y,w as g,j as e,aW as K,e as l,K as y,ag as m,m as V,a2 as W,Q as j,I as h,x as X,U as J}from"./index-HcaOzkr4.js";import{A as Z}from"./AssociationBlock-ZImVauAG.js";import{M as ee}from"./MultiSelectField-DajN5Spa.js";import{S as te}from"./SidePanelFormButtons-BaCjyXPu.js";import{u as k}from"./useRoles-BAQFoUXg.js";import{R as oe}from"./RandomizationBlock-CdvHWvH5.js";import{R as re,a as ie}from"./index-9Zzq3JSP.js";import{b as Qe,c as Ue,d as ze}from"./index-9Zzq3JSP.js";import"./useGetTags-LHsNFzsT.js";import"./SidePanelFormButtons.module-CcPyiogC.js";import"./RadioGroup-BCNL1V85.js";import"./PageMain-Chfz0_-y.js";import"./HeaderWithSearch-CBNpUALV.js";import"./constants-BZzpu2au.js";import"./TextConfirmationModal-_9Djb0j-.js";import"./table-CdFwMAPu.js";function se(){const t=S(),i=M(),n=D({mutationKey:["rebootprofiles","create"],mutationFn:async c=>t.post("rebootprofiles",c),onSuccess:async()=>i.invalidateQueries({queryKey:["rebootprofiles"]})}),{mutateAsync:s,isPending:o}=n;return{createRebootProfile:s,isCreatingRebootProfile:o}}function ae(){const t=S(),i=M(),n=D({mutationKey:["rebootprofiles","edit"],mutationFn:async({id:c,...u})=>t.patch(`rebootprofiles/${c}`,u),onSuccess:async()=>i.invalidateQueries({queryKey:["rebootprofiles"]})}),{mutateAsync:s,isPending:o}=n;return{editRebootProfile:s,isEditingRebootProfile:o}}const F={add:"added",edit:"updated",duplicate:"added"},ne={add:"Add reboot profile",duplicate:"Add reboot profile",edit:"Save changes"},T=[{label:"Sunday",order:0,value:"su"},{label:"Monday",order:1,value:"mo"},{label:"Tuesday",order:2,value:"tu"},{label:"Wednesday",order:3,value:"we"},{label:"Thursday",order:4,value:"th"},{label:"Friday",order:5,value:"fr"},{label:"Saturday",order:6,value:"sa"}],le=`If Landscape cannot reboot the
associated instances by this point,
the reboot will be canceled.`,B=t=>{const i=new Map(t.split(";").map(u=>{const[b,_]=u.split("=");return[b.toUpperCase(),_]})),n=i.get("FREQ")?.toLowerCase()??"",s=parseInt(i.get("BYHOUR")??"",10),o=parseInt(i.get("BYMINUTE")??"",10),c=(i.get("BYDAY")??"").split(",").map(u=>u.toLowerCase());return{freq:n,at_hour:s,at_minute:o,on_days:c}},ce=t=>O().shape({...q,title:x().test({name:"required",message:"This field is required.",test:i=>!!i||t!=="add"}),access_group:x(),all_computers:$(),at_hour:w().required("Hour is required.").integer("Hour must be an integer.").min(0,"Hour must be between 0 and 23.").max(L,"Hour must be between 0 and 23."),at_minute:w().required("Minute is required.").integer("Minute must be an integer.").min(0,"Minute must be between 0 and 59.").max(H,"Minute must be between 0 and 59."),deliver_within:w().integer("'Expires after' must be an integer.").min(0,"'Expires after' must be at least 0."),tags:E().of(x()),on_days:E().of(x()).min(1,"At least one day must be selected.")}),de=t=>{if(t.action==="add")return{title:"",access_group:Q,all_computers:!1,randomize_delivery:!1,deliver_delay_window:0,tags:[],at_hour:"",at_minute:"",deliver_within:0,on_days:[]};const{at_hour:i,at_minute:n,on_days:s}=B(t.profile.schedule);return{title:t.action==="duplicate"?`${t.profile.title} (copy)`:t.profile.title,access_group:t.profile.access_group,all_computers:t.profile.all_computers,randomize_delivery:!!t.profile.deliver_delay_window,deliver_delay_window:t.profile.deliver_delay_window||0,tags:t.profile.tags,at_hour:i,at_minute:n,deliver_within:t.profile.deliver_within,on_days:s}},ue="_container_1bra5_1",me="_timeContainer_1bra5_13",pe="_time_1bra5_13",be="_timeInput_1bra5_27",he="_inputDescriptionAfter_1bra5_32",_e="_colon_1bra5_37",fe="_tooltip_1bra5_43",ge="_expiration_1bra5_47",p={container:ue,timeContainer:me,time:pe,timeInput:be,inputDescriptionAfter:he,colon:_e,tooltip:fe,expiration:ge},A=t=>{const{getAccessGroupQuery:i}=k(),n=U(),{sidePath:s,popSidePath:o,setPageParams:c}=v(),{notify:u}=z(),{data:b}=i(),{createRebootProfile:_,isCreatingRebootProfile:P}=se(),{editRebootProfile:R,isEditingRebootProfile:I}=ae(),G=b?.data.map(({name:r,title:f})=>({label:f,value:r}))??[],C=()=>{c({sidePath:[],profile:""})},a=Y({initialValues:de(t),enableReinitialize:!0,onSubmit:async r=>{try{t.action==="edit"?await R({id:t.profile.id,access_group:r.access_group,at_hour:Number(r.at_hour),at_minute:Number(r.at_minute),deliver_delay_window:r.randomize_delivery?r.deliver_delay_window:0,deliver_within:r.deliver_within,on_days:r.on_days,title:r.title,tags:r.tags,every:"week",all_computers:r.all_computers}):await _({title:r.title,tags:r.tags,access_group:r.access_group,on_days:r.on_days,every:"week",at_hour:Number(r.at_hour),at_minute:Number(r.at_minute),deliver_delay_window:r.randomize_delivery?r.deliver_delay_window:0,deliver_within:r.deliver_within,all_computers:r.all_computers}),C(),u.success({message:`Reboot profile "${r.title}" has been ${F[t.action]} `,title:`Reboot profile ${F[t.action]}`})}catch(f){n(f)}},validationSchema:ce(t.action)}),d=[g(a,"at_hour"),g(a,"at_minute"),g(a,"deliver_within")];return e.jsx(K,{value:a,children:e.jsxs(l.Form,{onSubmit:a.handleSubmit,noValidate:!0,children:[e.jsx(l.Input,{type:"text",label:"Title",required:t.action==="add",...a.getFieldProps("title"),error:a.touched.title&&a.errors.title}),e.jsx(l.Select,{label:"Access group","aria-label":"Access group",options:G,...a.getFieldProps("access_group"),error:g(a,"access_group")}),e.jsxs("div",{className:p.container,children:[e.jsx("p",{className:"p-heading--5",children:"Schedule"}),e.jsx(ee,{variant:"condensed",label:"Days",items:T,selectedItems:T.filter(({value:r})=>a.values.on_days.includes(r)),onItemsUpdate:async r=>a.setFieldValue("on_days",r.map(({value:f})=>f)),isSortedAlphabetically:!1,hasSelectedItemsFirst:!1,error:g(a,"on_days")}),e.jsxs("div",{className:p.timeContainer,children:[e.jsxs("div",{className:p.time,children:[e.jsxs(e.Fragment,{children:[e.jsx(l.Input,{type:"number",label:"Time","aria-label":"at hour",placeholder:"HH",className:p.timeInput,wrapperClassName:y({"is-error":d[0]}),...a.getFieldProps("at_hour"),"aria-errormessage":d[0]?"hour-error":void 0}),e.jsx("span",{className:p.colon,children:":"})]}),e.jsx(l.Input,{type:"number",label:"At minute",labelClassName:"u-off-screen","aria-label":"at minute",className:p.timeInput,wrapperClassName:y({"is-error":d[1]}),placeholder:"MM",...a.getFieldProps("at_minute"),"aria-errormessage":d[1]?"minute-error":void 0}),e.jsx(l.Input,{type:"number",label:e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"Expires after "}),e.jsx(l.Tooltip,{message:le,position:"top-right",tooltipClassName:p.tooltip,children:e.jsx(l.Icon,{name:"help"})})]}),wrapperClassName:y(p.expiration,{"is-error":d[2]}),className:p.timeInput,...a.getFieldProps("deliver_within"),"aria-errormessage":"expires-error"}),e.jsx("span",{className:p.inputDescriptionAfter,children:"hours"})]}),d.filter(Boolean).length>0&&e.jsxs("div",{className:y({"is-error":d.filter(Boolean).length>0}),children:[d[0]&&e.jsx("p",{className:"p-form-validation__message",id:"hour-error",children:e.jsx("span",{children:d[0]})}),d[1]&&e.jsx("p",{className:"p-form-validation__message",id:"minute-error",children:e.jsx("span",{children:d[1]})}),d[2]&&e.jsxs("p",{className:"p-form-validation__message",id:"expires-error",children:[e.jsx("strong",{children:"Error: "}),e.jsx("span",{children:d[2]})]})]})]}),e.jsx(oe,{formik:a})]}),e.jsx(Z,{formik:a}),e.jsx(te,{submitButtonText:ne[t.action],submitButtonDisabled:a.isSubmitting||P||I,onCancel:C,hasBackButton:s.length>1,onBackButtonPress:o})]})})},Ge=()=>e.jsxs(e.Fragment,{children:[e.jsx(m.Header,{children:"Add reboot profile"}),e.jsx(m.Content,{children:e.jsx(A,{action:"add"})})]});function xe(t,i={}){const n=S(),{data:s,isPending:o,error:c}=V({queryKey:["rebootprofile",t.id],queryFn:async({signal:b})=>n.get("rebootprofiles",{signal:b}),...i}),u=s?.data.results.find(({id:b})=>b===t.id);return{rebootProfile:u,rebootProfileError:s&&!u?new Error("The reboot profile could not be found."):c,isGettingRebootProfile:o}}const N=()=>{const{profile:t}=v(),{isGettingRebootProfile:i,rebootProfile:n,rebootProfileError:s}=xe({id:parseInt(t)});if(s)throw s;return i?{rebootProfile:void 0,isGettingRebootProfile:!0}:{rebootProfile:n,isGettingRebootProfile:!1}},ye={mo:"Monday",tu:"Tuesday",we:"Wednesday",th:"Thursday",fr:"Friday",sa:"Saturday",su:"Sunday"},je=t=>t.length===2?`${t[0]} and ${t[1]}`:t.length>2?`${t.slice(0,-1).join(", ")}, and ${t[t.length-1]}`:t[0]??"",Pe=t=>{const{freq:i,on_days:n}=B(t.schedule);if(i!=="weekly"||!n.length)return"One-time";const s=n.map(c=>ye[c.toLowerCase()]);return`Every week on ${je(s)}`},Oe=()=>{const{value:t,setFalse:i,setTrue:n}=W(),{pushSidePath:s}=v(),{rebootProfile:o,isGettingRebootProfile:c}=N(),{getAccessGroupQuery:u}=k(),{data:b,isPending:_}=u();if(c||_)return e.jsx(m.LoadingState,{});const P=()=>{s("edit")},R=()=>{s("duplicate")};return e.jsxs(e.Fragment,{children:[e.jsx(m.Header,{children:o.title}),e.jsxs(m.Content,{children:[e.jsxs("div",{className:"p-segmented-control",children:[e.jsxs(l.Button,{type:"button",hasIcon:!0,className:"p-segmented-control__button",onClick:P,"aria-label":`Edit reboot profile ${o.title}`,children:[e.jsx(l.Icon,{name:"edit"}),e.jsx("span",{children:"Edit"})]}),e.jsxs(l.Button,{type:"button",hasIcon:!0,className:"p-segmented-control__button",onClick:R,"aria-label":`Edit reboot profile ${o.title}`,children:[e.jsx(l.Icon,{name:"canvas"}),e.jsx("span",{children:"Duplicate"})]}),e.jsxs(l.Button,{className:"p-segmented-control__button has-icon",type:"button",hasIcon:!0,onClick:n,"aria-label":`Remove reboot profile ${o.title}`,children:[e.jsx(l.Icon,{name:l.ICONS.delete}),e.jsx("span",{children:"Remove"})]})]}),e.jsxs(j,{children:[e.jsx(j.Item,{children:e.jsxs(h,{children:[e.jsx(h.Item,{label:"Title",value:o.title}),e.jsx(h.Item,{label:"Access group",value:b?.data.find(I=>I.name===o.access_group)?.title??o.access_group})]})}),e.jsx(j.Item,{title:"Reboot schedule",children:e.jsxs(h,{children:[e.jsx(h.Item,{label:"Schedule",large:!0,value:Pe(o)}),e.jsx(h.Item,{label:"Next reboot",large:!0,value:X(o.next_run).format(J)})]})}),e.jsxs(j.Item,{title:"Association",children:[o.all_computers&&e.jsx("p",{children:"This profile has been associated with all instances."}),!o.all_computers&&!o.tags.length&&e.jsx("p",{children:"This profile has not yet been associated with any instances."}),(o.all_computers||!!o.tags.length)&&e.jsxs(h,{children:[!o.all_computers&&e.jsx(h.Item,{label:"Tags",large:!0,value:o.tags.join(", ")||null,type:"truncated"}),e.jsx(h.Item,{label:"Associated instances",large:!0,value:e.jsx(re,{rebootProfile:o})})]})]})]})]}),e.jsx(ie,{close:i,opened:t,rebootProfile:o})]})},$e=()=>{const{rebootProfile:t,isGettingRebootProfile:i}=N();return i?e.jsx(m.LoadingState,{}):e.jsxs(e.Fragment,{children:[e.jsxs(m.Header,{children:["Duplicate ",t.title]}),e.jsx(m.Content,{children:e.jsx(A,{action:"duplicate",profile:t})})]})},qe=()=>{const{rebootProfile:t,isGettingRebootProfile:i}=N();return i?e.jsx(m.LoadingState,{}):e.jsxs(e.Fragment,{children:[e.jsxs(m.Header,{children:["Edit ",t.title]}),e.jsxs(m.Content,{children:[e.jsx(A,{action:"edit",profile:t}),";"]})]})};export{Ge as RebootProfileAddSidePanel,Oe as RebootProfileDetailsSidePanel,$e as RebootProfileDuplicateSidePanel,qe as RebootProfileEditSidePanel,Qe as RebootProfilesContainer,A as RebootProfilesForm,Ue as RebootProfilesHeader,ze as RebootProfilesList};
