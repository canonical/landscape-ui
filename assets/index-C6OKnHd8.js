import{b as pe,g as ge,h as fe,i as E,l as _,j as e,F as B,d as r,J as $,B as D,o as L,ah as be,p as J,n as k,H as Z,z as xe,A as _e,y as R,t as I,q as je,w as Ce,aC as ve,ap as Se,I as N,P as X,aw as Ne,k as Ie,D as z,E as ye,aq as we}from"./index-DvQ7Ypp3.js";import{S as ee}from"./SidePanelFormButtons-C0IpdDKq.js";import{D as $e}from"./downshift.esm-fS1Sir0I.js";import{H as Be}from"./HeaderWithSearch-CxYGZV3d.js";import{f as K}from"./helpers-I1DEN13Z.js";import{D as ke}from"./DeliveryBlock-Bll7K9hq.js";import{R as Fe}from"./RandomizationBlock-BT6CTbmt.js";import"./SidePanelFormButtons.module-BuIu-Bem.js";import"./RadioGroup-C1vJwcRf.js";const F=()=>{const n=pe(),a=ge(),c=(l,b={})=>{if(!l)throw new Error("Missing required parameters");const{instance_id:f,...s}=l;return E({queryKey:["snaps",{...l}],queryFn:async()=>n.get(`computers/${f}/snaps/installed`,{params:s}),...b})},p=(l,b={})=>E({queryKey:["snaps",{...l}],queryFn:async()=>{if(!l)throw new Error("Missing required parameters");return n.get(`computers/${l.instance_id}/snaps/available?name_startswith=${l.query}`)},...b}),i=(l,b={})=>E({queryKey:["snaps",{...l}],queryFn:async()=>{if(!l)throw new Error("Missing required parameters");return n.get(`computers/${l.instance_id}/snaps/${l.name}/info`)},...b}),x=fe({mutationKey:["snaps","action"],mutationFn:async l=>n.post("snaps",l),onSuccess:async()=>a.invalidateQueries({queryKey:["snaps"]})});return{getSnapsQuery:c,getAvailableSnapInfo:i,getAvailableSnaps:p,snapsActionQuery:x}},He="_toBeConfirmedCard_mibcv_1",Ae="_toBeConfirmedCard__buttons_mibcv_6",Te="_toBeConfirmedCard__confirmButton_mibcv_13",De="_bold_mibcv_18",T={toBeConfirmedCard:He,toBeConfirmedCard__buttons:Ae,toBeConfirmedCard__confirmButton:Te,bold:De},Ue=({name:n,handleDeleteToBeConfirmedItem:a,handleAddToSelectedItems:c,instanceId:p})=>{const[i,x]=_.useState(""),{getAvailableSnapInfo:l}=F(),{data:b,isLoading:f}=l({instance_id:p,name:n}),s=b?.data,t=_.useMemo(()=>s?s["channel-map"].sort((d,u)=>d.channel.architecture.localeCompare(u.channel.architecture)).map(d=>({label:`${d.channel.name} - ${d.channel.architecture}`,value:`${d.channel.name} - ${d.channel.architecture}`})):[],[s]),j=d=>{x(d)};return _.useEffect(()=>{t.length>0&&x(t[0].value)},[t]),e.jsxs(e.Fragment,{children:[f&&e.jsx(B,{}),s&&e.jsx(r.Form,{name:"add-snap",onSubmit:d=>{d.preventDefault(),c({"snap-id":s["snap-id"],name:s.name,snap:s.snap,revision:s["channel-map"].find(u=>`${u.channel.name} - ${u.channel.architecture}`===i)?.revision.toString()??"Unknown revision",channel:s["channel-map"].find(u=>`${u.channel.name} - ${u.channel.architecture}`===i)?.channel.name??"Unknown channel"})},children:e.jsxs("li",{className:$("p-autocomplete__result p-list__item p-card u-no-margin--bottom u-no-padding--bottom",T.toBeConfirmedCard),children:[e.jsx("div",{className:T.bold,children:s.name}),e.jsx("span",{children:e.jsx("small",{className:"u-text--muted p-text--small",children:s.snap.publisher["display-name"]})}),e.jsx(r.Select,{label:e.jsx("span",{className:"u-text--muted p-text--small",children:"Release"}),required:!0,value:i,options:t,onChange:d=>{j(d.currentTarget.value)},help:s["channel-map"].find(d=>`${d.channel.name} - ${d.channel.architecture}`===i)?.confinement==="classic"?e.jsxs("span",{children:[e.jsx(r.Icon,{name:r.ICONS.warning}),"This release requires classic permission."," ",e.jsx("a",{href:"https://snapcraft.io/docs",target:"_blank",rel:"nofollow noopener noreferrer",children:"Learn more"})]}):void 0}),e.jsxs("div",{className:T.toBeConfirmedCard__buttons,children:[e.jsx(r.Button,{small:!0,type:"button",appearance:"base",onClick:()=>{a()},children:"Cancel"}),e.jsx(r.Button,{small:!0,className:T.toBeConfirmedCard__confirmButton,type:"submit",appearance:"positive",children:"Add"})]})]})})]})},Ee="_container_113js_1",Re="_suggestionsContainer_113js_5",Pe="_pointer_113js_12",Le="_highlighted_113js_17",Ve="_selectedContainer_113js_21",w={container:Ee,suggestionsContainer:Re,pointer:Pe,highlighted:Le,selectedContainer:Ve},Me=200,Oe=(n,a)=>{const c=n.toLowerCase(),p=a.toLowerCase(),i=c.indexOf(p);return i>=0?e.jsxs(e.Fragment,{children:[n.substring(0,i),e.jsx("strong",{children:n.substring(i,i+a.length)}),n.substring(i+a.length)]}):n},qe=({selectedItems:n,setSelectedItems:a,setConfirming:c})=>{const{instanceId:p}=D(),i=L(),{getAvailableSnaps:x}=F(),[l,b]=_.useState(""),[f,s]=_.useState(!1),[t,j]=_.useState(),[d,u]=_.useState(""),C=_.useRef(null),g=Number(p),{data:H,isFetching:m}=x({instance_id:g,query:l},{enabled:l.length>2}),v=H?.data?.results??[],U=h=>!n.map(y=>y.name).includes(h),S=v.filter(h=>U(h.name));_.useEffect(()=>{t||C.current?.focus()},[t]);const le=h=>{a(n.filter(y=>y.name!==h))},V=()=>{j(null),c&&c(!1)},oe=()=>{t||s(!1)},M=()=>{u(""),b("")},O=()=>{d.length>2?s(!0):s(!1)},re=h=>{u(h),h.length>2&&b(h)},ie=be(()=>{try{O()}catch(h){i(h)}},Me),ce=h=>{a([...n,h]),M(),V()},de=h=>{h&&(c(!0),j(h))},ue=h=>{h.key==="Escape"?h.currentTarget.blur():ie()},q=!f&&d.length<3?"Min 3. characters":v.length===0&&l&&!m?`No snaps found by "${l}"`:null;return e.jsxs("div",{className:w.container,children:[e.jsx($e,{onSelect:de,itemToString:()=>"",isOpen:f,children:({getInputProps:h,getItemProps:y,getMenuProps:he,highlightedIndex:me})=>e.jsxs("div",{className:"p-autocomplete",children:[e.jsx(r.SearchBox,{...h(),placeholder:"Search for available snaps",className:"u-no-margin--bottom",shouldRefocusAfterReset:!0,externallyControlled:!0,autocomplete:"off",value:d,ref:C,disabled:!!t,onChange:re,onClear:M,onBlur:oe,onFocus:O,onKeyUp:ue}),q?e.jsx("span",{className:"p-form-help-text",children:q}):null,f&&(S.length>0||m)?e.jsx("ul",{className:$("p-list p-card--highlighted u-no-padding u-no-margin--bottom p-autocomplete__suggestions",w.suggestionsContainer),...he(),children:t&&g?e.jsx(Ue,{handleAddToSelectedItems:ce,handleDeleteToBeConfirmedItem:V,name:t.name,instanceId:g},t["snap-id"]):m?e.jsx(B,{}):S.map((A,Q)=>e.jsxs("li",{className:$("p-list__item",w.pointer,{[w.highlighted]:me===Q}),...y({item:A,index:Q}),children:[e.jsx("div",{className:"u-truncate","data-testid":"dropdownElement",children:Oe(A.name,l)}),e.jsx("small",{className:"u-text-muted",children:A.snap.publisher["display-name"]})]},A["snap-id"]))}):null]})}),e.jsx("ul",{className:"p-list p-autocomplete__result-list u-no-margin--bottom",children:n.length?n.map(h=>e.jsxs("li",{className:$("p-autocomplete__result p-list__item p-card u-no-margin--bottom",w.selectedContainer),children:[e.jsxs("div",{children:[e.jsx("div",{children:h.name}),e.jsx("span",{children:e.jsx("small",{className:"u-text--muted p-text--small",children:`${h.snap.publisher["display-name"]} | ${h.channel}`})})]}),e.jsx(r.Button,{type:"button",appearance:"link",className:"u-no-margin--bottom",onClick:()=>le(h.name),children:e.jsx(r.Icon,{name:r.ICONS.delete})})]},h["snap-id"])):null})]})},ne=()=>{const[n,a]=_.useState([]),[c,p]=_.useState(!1),i=L(),{notify:x}=J(),{closeSidePanel:l}=k(),{snapsActionQuery:b}=F(),{instanceId:f}=D(),s=Number(f),{mutateAsync:t,isPending:j}=b,d=async()=>{try{await t({computer_ids:[s],snaps:n.map(u=>({name:u.name,channel:u.channel,revision:u.revision})),action:"install"}),l(),x.success({message:`You queued ${Z(n.length,`snap ${n[0].name}`,`${n.length} snaps`)} to be installed.`}),a([])}catch(u){i(u)}};return e.jsxs(e.Fragment,{children:[e.jsx(qe,{selectedItems:n,setSelectedItems:u=>{a(u)},setConfirming:u=>{p(u)}}),e.jsx(ee,{submitButtonDisabled:n.length===0||c||j,cancelButtonDisabled:j,submitButtonText:"Install snaps",submitButtonAppearance:"positive",onSubmit:d})]})};var o=(n=>(n.Switch="Switch",n.Refresh="Refresh",n.Uninstall="Uninstall",n.Hold="Hold",n.Unhold="Unhold",n))(o||{});const ae=n=>n.reduce((a,c)=>(c.held_until!==null?a.held++:a.unheld++,a),{held:0,unheld:0}),se=(n,a)=>n.filter(c=>a.includes(c.snap.id)),Qe="_bold_1hrl2_1",ze="_radioGroup_1hrl2_5",Y={bold:Qe,radioGroup:ze},P={..._e,...xe},Ke=n=>{switch(n){case o.Switch:return{...P,release:R().required("Release is required")};case o.Hold:return{...P,hold:R(),hold_until:R().test({test:a=>a?I(a).isValid():!0,message:"You have to enter a valid date and time"})};default:return{...P}}},Ye={single:{[o.Refresh]:"This will update {snapName} to the latest version available. Automatic updates will resume, and {snapName} will be upgraded based on the regular refresh schedule.",[o.Uninstall]:"This will remove the snap from your system",[o.Hold]:"This will pause automatic updates for that particular snap. {snapName} will maintain the current version",[o.Unhold]:"This will resume automatic updates for that particular snap. {snapName} will be eligible for the latest version upgrades based on the regular refresh schedule."},multiple:{[o.Refresh]:"This will update the selected snaps to the latest version available. Automatic updates will resume, and the snaps will be upgraded based on the regular refresh schedule.",[o.Uninstall]:"This will remove the selected snaps from your system",[o.Hold]:"Holding a snap will pause automatic updates for that particular snap.",[o.Unhold]:"Unholding a snap will resume automatic updates for that particular snap."}},Ge=(n,a)=>{if(n===o.Switch)return null;const{held:c,unheld:p}=ae(a),i=Ye[a.length===1?"single":"multiple"][n].replaceAll("{snapName}",a[0].snap.name);return n===o.Refresh||n===o.Uninstall||a.length===1||c===0||p===0?e.jsx("p",{children:i}):e.jsxs(e.Fragment,{children:[e.jsx("p",{children:i}),e.jsxs("span",{children:["You selected ",a.length," snaps. This will:"]}),e.jsxs("ul",{children:[e.jsxs("li",{children:[n===o.Hold?"hold":"unhold"," ",K({count:n===o.Hold?p:c,singular:"snap"})]}),e.jsxs("li",{children:["leave"," ",K({count:n===o.Hold?c:p,singular:"snap"})," ",n===o.Hold?"held":"unheld"]})]})]})},We=({installedSnaps:n,type:a})=>{const{instanceId:c}=D(),p=L(),{notify:i}=J(),{closeSidePanel:x}=k(),{snapsActionQuery:l,getAvailableSnapInfo:b}=F(),f=Number(c),{mutateAsync:s}=l,{data:t}=b({instance_id:f,name:n[0].snap.name},{enabled:a===o.Switch}),j=_.useMemo(()=>t?.data["channel-map"].sort((m,v)=>m.channel.architecture.localeCompare(v.channel.architecture)).map(m=>({label:`${m.channel.name} - ${m.channel.architecture}`,value:`${m.channel.name} - ${m.channel.architecture}`}))??[],[t?.data]),d=Ke(a),u=n.length===1?n[0]:null,C=u?t?.data["channel-map"][0]:null,g=je({initialValues:{release:void 0,hold:a===o.Hold?"forever":void 0,hold_until:a===o.Hold?"":void 0,deliver_immediately:!0,randomize_delivery:!1,deliver_delay_window:0,deliver_after:""},validationSchema:Ce().shape(d),onSubmit:async m=>{try{s({computer_ids:[f],action:a===o.Uninstall?"remove":a===o.Switch?"refresh":a.toLowerCase(),snaps:n.map(U=>({name:U.snap.name,channel:m.release?t?.data["channel-map"].find(S=>`${S.channel.name} - ${S.channel.architecture}`===m.release)?.channel.name:void 0,revision:t?.data["channel-map"].find(S=>`${S.channel.name} - ${S.channel.architecture}`===m.release)?.revision.toString(),time:m.hold==="forever"?"forever":m.hold_until?I(m.hold_until).format():void 0})),deliver_after:m.deliver_immediately?void 0:m.deliver_after?I(m.deliver_after).format():void 0,deliver_after_window:m.randomize_delivery?m.deliver_delay_window:void 0}),x();const v=a===o.Hold?"held":a===o.Unhold?"unheld":`${a.toLowerCase()}ed`;i.success({message:`You queued ${u?u.snap.name:`${n.length} snaps`} to be ${v}.`})}catch(v){p(v)}}});_.useEffect(()=>{C&&a===o.Switch&&!g.values.release&&g.setFieldValue("release",`${C.channel.name} - ${C.channel.architecture}`)},[C]);const H=m=>{g.setFieldValue("hold",m.currentTarget.value),m.currentTarget.value==="date"&&g.setFieldValue("hold_until",I().toISOString().slice(0,16))};return e.jsxs(r.Form,{onSubmit:g.handleSubmit,noValidate:!0,children:[Ge(a,n),a===o.Switch&&e.jsx(r.Select,{label:"release",labelClassName:"p-text--small p-text--small-caps",options:j,disabled:j.length===0,...g.getFieldProps("release")}),a===o.Hold&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:Y.bold,children:"Hold"}),e.jsxs("div",{className:Y.radioGroup,children:[e.jsx(r.Input,{type:"radio",label:"Indefinitely",...g.getFieldProps("hold"),onChange:H,checked:g.values.hold==="forever",value:"forever"}),e.jsx(r.Input,{type:"radio",label:"Select date",...g.getFieldProps("hold"),onChange:H,checked:g.values.hold==="date",value:"date"})]}),g.values.hold==="date"&&e.jsx(r.Input,{type:"datetime-local",error:g.touched.hold_until&&g.errors.hold_until?g.errors.hold_until:void 0,...g.getFieldProps("hold_until")})]}),e.jsx(ke,{formik:g}),e.jsx(Fe,{formik:g}),e.jsx(ee,{submitButtonText:a,submitButtonAppearance:a===o.Uninstall?"negative":"positive",submitButtonDisabled:g.isSubmitting})]})},Je="_container_11i26_1",G={container:Je},te=({selectedSnapIds:n,installedSnaps:a,sidePanel:c=!1})=>{const{setSidePanelContent:p}=k(),i=a.length===1?a[0]:null,x=se(a,n),{held:l,unheld:b}=ae(x),f=t=>{const j=t===o.Unhold?l:t===o.Hold?b:n.length,d=i?`${t} ${i.snap.name}${t===o.Switch?"'s channel":""}`:`${t} ${j} ${Z(j,"snap")}`;p(d,e.jsx(_.Suspense,{fallback:e.jsx(B,{}),children:e.jsx(We,{installedSnaps:x,type:t})}))},s=()=>{p("Install snaps",e.jsx(ne,{}))};return e.jsxs("div",{className:G.container,children:[!c&&e.jsxs(r.Button,{type:"button",onClick:s,hasIcon:!0,className:$("u-no-margin--bottom",G.noWrap),children:[e.jsx(r.Icon,{name:r.ICONS.plus}),e.jsx("span",{children:"Install"})]}),e.jsx(ve,{collapseFrom:"lg",buttons:[i&&c&&e.jsxs(r.Button,{type:"button",className:"p-segmented-control__button has-icon u-no-margin--bottom",disabled:n.length===0,onClick:()=>{f(o.Switch)},children:[e.jsx(r.Icon,{name:"fork"}),e.jsx("span",{children:"Switch channel"})]},"switch-channel"),e.jsxs(r.Button,{type:"button",className:"p-segmented-control__button has-icon u-no-margin--bottom",disabled:n.length===0,onClick:()=>{f(o.Uninstall)},children:[e.jsx(r.Icon,{name:r.ICONS.delete}),e.jsx("span",{children:"Uninstall"})]},"uninstall"),(i?.held_until===null||!c)&&e.jsxs(r.Button,{type:"button",className:"p-segmented-control__button has-icon u-no-margin--bottom",disabled:b===0,onClick:()=>{f(o.Hold)},children:[e.jsx(r.Icon,{name:"pause"}),e.jsx("span",{children:"Hold"})]},"hold"),(i?.held_until!==null||!c)&&e.jsxs(r.Button,{type:"button",className:"p-segmented-control__button has-icon u-no-margin--bottom",disabled:l===0,onClick:()=>{f(o.Unhold)},children:[e.jsx(r.Icon,{name:"play"}),e.jsx("span",{children:"Unhold"})]},"unhold"),e.jsxs(r.Button,{type:"button",className:"p-segmented-control__button has-icon u-no-margin--bottom",disabled:n.length===0,onClick:()=>{f(o.Refresh)},children:[e.jsx(r.Icon,{name:"change-version"}),e.jsx("span",{children:"Refresh"})]},"refresh")]})]})},Ze="_actions_1l3g0_1",Xe={actions:Ze},en=({handleClearSelection:n,selectedSnapIds:a,installedSnaps:c})=>e.jsxs(e.Fragment,{children:[e.jsx(Be,{afterSearch:n,actions:e.jsx("div",{className:Xe.actions,children:e.jsx(te,{selectedSnapIds:a,installedSnaps:se(c,a)})})}),e.jsx(Se,{filtersToDisplay:["search"]})]}),nn=({installedSnap:n})=>e.jsxs(e.Fragment,{children:[e.jsx(te,{selectedSnapIds:[n.snap.id],installedSnaps:[n],sidePanel:!0}),e.jsxs(N,{spaced:!0,children:[e.jsx(N.Item,{label:"Name",large:!0,value:n.snap.name}),e.jsx(N.Item,{label:"Channel",value:n.tracking_channel}),e.jsx(N.Item,{label:"Version",value:n.version}),e.jsx(N.Item,{label:"Confinement",value:n.confinement}),e.jsx(N.Item,{label:"Held until",value:I(n.held_until).isValid()?I(n.held_until).format(X):null}),e.jsx(N.Item,{label:"Summary",large:!0,value:n.snap.summary}),e.jsx(N.Item,{label:"Publisher",large:!0,value:n.snap.publisher.username})]})]}),an="_details_9i6m6_1",sn="_pause_9i6m6_5",W={details:an,pause:sn},tn=n=>{const a={};switch(n.column.id){case"name":a.role="rowheader";break;case"channel":a["aria-label"]="Channel";break;case"held until":a["aria-label"]="Held until";break;case"version":a["aria-label"]="Version";break;case"summary":a["aria-label"]="Summary";break}return a},ln=({installedSnaps:n,selectedSnapIds:a,isSnapsLoading:c,setSelectedSnapIds:p})=>{const{setSidePanelContent:i}=k(),x=s=>{a.includes(s.original.snap.id)?p(a.filter(t=>t!==s.original.snap.id)):p([...a,s.original.snap.id])},l=()=>{p(a.length!==0?[]:n.map(({snap:s})=>s.id))},b=s=>{i(`${s.snap.name} details`,e.jsx(_.Suspense,{fallback:e.jsx(B,{}),children:e.jsx(nn,{installedSnap:s})}))},f=_.useMemo(()=>[{Header:e.jsxs(e.Fragment,{children:[e.jsx(r.CheckboxInput,{label:e.jsx("span",{className:"u-off-screen",children:"Toggle all"}),inline:!0,onChange:l,checked:a.length===n.length&&n.length!==0,indeterminate:a.length!==0&&a.length<n.length}),e.jsx("span",{children:"Name"})]}),accessor:"name",Cell:({row:s})=>e.jsxs(e.Fragment,{children:[e.jsx(r.CheckboxInput,{label:e.jsx("span",{className:"u-off-screen",children:s.original.snap.name}),inline:!0,checked:a.includes(s.original.snap.id),onChange:()=>{x(s)}}),e.jsx(r.Button,{type:"button",appearance:"link",className:"u-no-margin--bottom u-no-padding--top",onClick:()=>{b(s.original)},"aria-label":`Show details of snap ${s.original.snap.name}`,children:s.original.snap.name})]})},{Header:"channel",accessor:"channel",Cell:({row:s})=>e.jsx(e.Fragment,{children:s.original.tracking_channel})},{Header:"held until",accessor:"held_until",Cell:({row:s})=>e.jsx(e.Fragment,{children:I(s.original.held_until).isValid()?e.jsxs("span",{className:"font-monospace",children:[" ",I(s.original.held_until).format(X)]}):e.jsx(Ne,{})})},{Header:"version",accessor:"version",Cell:({row:s})=>e.jsx(e.Fragment,{children:s.original.held_until?e.jsx(r.Tooltip,{message:"This snap is held",children:s.original.version}):s.original.version}),getCellIcon:({row:s})=>s.original.held_until?`pause ${W.pause}`:null},{Header:"summary",accessor:"summary",className:W.details,Cell:({row:s})=>e.jsx(e.Fragment,{children:s.original.snap.summary})}],[a,n]);return e.jsx(r.ModularTable,{columns:f,data:n,getCellProps:tn,emptyMsg:c?"Loading...":"No snaps found from the search"})},bn=()=>{const[n,a]=_.useState([]),{instanceId:c,childInstanceId:p}=D(),{search:i,currentPage:x,pageSize:l}=Ie(),{getSnapsQuery:b}=F(),{setSidePanelContent:f}=k(),s=Number(p??c),{data:t,isLoading:j}=b({instance_id:s,limit:l,offset:(x-1)*l,search:i}),d=()=>{f("Install snaps",e.jsx(ne,{}))},u=_.useMemo(()=>t?.data?.results??[],[t]),C=()=>{a([])};return e.jsxs(e.Fragment,{children:[!i&&j&&x===1&&l===z&&e.jsx(B,{}),!j&&!i&&(!t||t.data.results.length===0)&&e.jsx(ye,{title:"You haven't installed any snaps yet",cta:[e.jsx(r.Button,{type:"button",appearance:"positive",onClick:d,children:"Install snaps"},"empty-state-install-snap")]}),(i||x!==1||l!==z||t&&t?.data.results.length>0)&&e.jsxs(e.Fragment,{children:[e.jsx(en,{selectedSnapIds:n,installedSnaps:u,handleClearSelection:C}),e.jsx(ln,{selectedSnapIds:n,setSelectedSnapIds:g=>{a(g)},installedSnaps:u,isSnapsLoading:j})]}),e.jsx(we,{handleClearSelection:C,totalItems:t?.data?.count,currentItemCount:t?.data?.results.length})]})};export{bn as default};
