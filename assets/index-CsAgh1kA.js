const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-BvH-rCNH.js","assets/index-D6VckuHd.js","assets/index-D3DIubem.css","assets/SidePanelFormButtons-BmXQ9T7n.js","assets/SidePanelFormButtons.module-C5v714vX.js","assets/SidePanelFormButtons-Cl1KfOFD.css","assets/MultiSelectField-B16BLhl7.js","assets/MultiSelectField-GyNA33om.css","assets/TablePagination-LU4hETMf.js","assets/usePageParams-D-1GJFJQ.js","assets/TablePaginationBase-ma4DISjg.js","assets/TablePaginationBase-CJl3HN1X.css","assets/helpers-b-A0-B4e.js","assets/HeaderWithSearch-Bmg3zv6y.js","assets/HeaderWithSearch-C2lwo0VI.css","assets/TableFilterChips-GgNMVMYl.js","assets/TableFilterChips-CHqetGbX.css","assets/NoData-PTgT8zVR.js","assets/output-DFRNcfG-.js","assets/index-CHCHLBAy.js"])))=>i.map(i=>d[i]);
import{r as b,e as Z,b as ee,c as k,d as B,o as E,p as G,f as P,s as se,h as te,k as y,v as oe,j as e,g as r,q as ne,m as re,n as I,_ as L,E as ae,L as ie}from"./index-D6VckuHd.js";import{u as q,T as ce}from"./TablePagination-LU4hETMf.js";import{u as Q}from"./usePageParams-D-1GJFJQ.js";import{S as ue}from"./SidePanelFormButtons-BmXQ9T7n.js";import{g as le,r as K,U as O,a as de}from"./helpers-b-A0-B4e.js";import{H as me}from"./HeaderWithSearch-Bmg3zv6y.js";import{T as pe}from"./TableFilterChips-GgNMVMYl.js";import{N as he}from"./NoData-PTgT8zVR.js";import{g as ge}from"./output-DFRNcfG-.js";const A=5e3;function be({data:s,sortFunctions:n}){const{sortBy:i,sort:l}=Q();return b.useMemo(()=>{const d=n[i];return!i||!l||!d?s:s.toSorted((m,p)=>{const h=d(m,p);return l==="asc"?h:-h})},[s,i,l,n])}function T(){const s=Z(),n=ee(),i=(t,g={})=>B({queryKey:["users",{...t}],queryFn:()=>s.get("users",{params:t}),...g}),l=k({mutationKey:["users","new"],mutationFn:t=>s.post("users",t),onSuccess:()=>n.invalidateQueries({queryKey:["users"]})}),d=k({mutationKey:["users","edit"],mutationFn:t=>s.put("users",t),onSuccess:()=>n.invalidateQueries({queryKey:["users"]})}),m=k({mutationKey:["users","remove"],mutationFn:t=>s.delete("users",{params:t}),onSuccess:()=>n.invalidateQueries({queryKey:["users"]})}),p=k({mutationKey:["users","lock"],mutationFn:t=>s.post("users/lock",t),onSuccess:()=>n.invalidateQueries({queryKey:["users"]})}),h=k({mutationKey:["users","unlock"],mutationFn:t=>s.post("users/unlock",t),onSuccess:()=>n.invalidateQueries({queryKey:["users"]})}),f=(t,g={})=>B({queryKey:["groups",(t==null?void 0:t.computer_id)??""],queryFn:()=>{if(!t)throw new Error("Missing required parameters");return s.get(`computers/${t.computer_id}/groups`)},...g}),x=(t,g={})=>B({queryKey:["userGroups",(t==null?void 0:t.computer_id)??"",(t==null?void 0:t.username)??""],queryFn:()=>{if(!t)throw new Error("Missing required parameters");return s.get(`computers/${t.computer_id}/users/${t.username}/groups`)},...g}),u=k({mutationKey:["groups","add"],mutationFn:t=>s.post(`computers/${t.computer_id}/usergroups/update_bulk`,t),onSuccess:()=>n.invalidateQueries({queryKey:["users"]})}),o=k({mutationKey:["groups","remove"],mutationFn:t=>s.post(`computers/${t.computer_id}/usergroups/update_bulk`,t),onSuccess:()=>n.invalidateQueries({queryKey:["users"]})});return{getUsersQuery:i,getGroupsQuery:f,getUserGroupsQuery:x,createUserQuery:l,removeUserQuery:m,editUserQuery:d,lockUserQuery:p,unlockUserQuery:h,addUserToGroupQuery:u,removeUserFromGroupQuery:o}}const fe="_actions_1l3g0_1",xe={actions:fe},V=()=>{const{instanceId:s}=E(),n=G(),{closeSidePanel:i}=P(),{createUserQuery:l,getGroupsQuery:d}=T(),m=Number(s),{mutateAsync:p}=l,{data:h,isLoading:f}=d({computer_id:m}),u=((h==null?void 0:h.data.groups)??[]).map(t=>({label:t.name,value:t.name})),o=se({initialValues:{name:"",username:"",password:"",confirmPassword:"",requirePasswordReset:!1,location:"",homePhoneNumber:"",workPhoneNumber:"",primaryGroupValue:""},validationSchema:te().shape({name:y().required("This field is required"),username:y().required("This field is required"),password:y().required("This field is required"),confirmPassword:y().required("This field is required").oneOf([oe("password"),""],"Passwords must match"),location:y(),homePhoneNumber:y(),workPhoneNumber:y(),primaryGroupValue:y().required("This field is required")}),onSubmit:async t=>{try{await p({computer_ids:[m],name:t.name,username:t.username,password:t.password,require_password_reset:t.requirePasswordReset,location:t.location,home_phone:t.homePhoneNumber,work_phone:t.workPhoneNumber,primary_groupname:t.primaryGroupValue}),i()}catch(g){n(g)}}});return e.jsxs(r.Form,{noValidate:!0,onSubmit:o.handleSubmit,name:"add-new-user",children:[e.jsx(r.Input,{type:"text",label:"Username",autoComplete:"new-username",required:!0,error:o.touched.username&&o.errors.username?o.errors.username:void 0,...o.getFieldProps("username")}),e.jsx(r.Input,{type:"text",label:"Name",required:!0,error:o.touched.name&&o.errors.name?o.errors.name:void 0,...o.getFieldProps("name")}),e.jsx(r.Input,{type:"password",label:"Passphrase",autoComplete:"new-password",required:!0,error:o.touched.password&&o.errors.password?o.errors.password:void 0,...o.getFieldProps("password")}),e.jsx(r.Input,{type:"password",label:"Confirm passphrase",autoComplete:"new-password",required:!0,error:o.touched.confirmPassword&&o.errors.confirmPassword?o.errors.confirmPassword:void 0,...o.getFieldProps("confirmPassword")}),e.jsx(r.Input,{type:"checkbox",label:"Require passphrase reset",help:"User must change password at first login",...o.getFieldProps("requirePasswordReset"),checked:o.values.requirePasswordReset}),e.jsx(r.Select,{label:"Primary Group",disabled:f,options:[{label:"Select",value:""},...u],...o.getFieldProps("primaryGroupValue"),error:o.touched.primaryGroupValue&&o.errors.primaryGroupValue?o.errors.primaryGroupValue:void 0}),e.jsx(r.Input,{type:"text",label:"Location",error:o.touched.location&&o.errors.location?o.errors.location:void 0,...o.getFieldProps("location")}),e.jsx(r.Input,{type:"text",label:"Home phone",error:o.touched.homePhoneNumber&&o.errors.homePhoneNumber?o.errors.homePhoneNumber:void 0,...o.getFieldProps("homePhoneNumber")}),e.jsx(r.Input,{type:"text",label:"Work phone",error:o.touched.workPhoneNumber&&o.errors.workPhoneNumber?o.errors.workPhoneNumber:void 0,...o.getFieldProps("workPhoneNumber")}),e.jsx(ue,{submitButtonDisabled:o.isSubmitting,submitButtonText:"Add user"})]})},ye=b.lazy(()=>L(()=>import("./index-BvH-rCNH.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18]))),je=({selectedUsers:s,handleClearSelection:n,sidePanel:i=!1})=>{const[l,d]=b.useState(!1),{instanceId:m}=E(),p=G(),{notify:h}=ne(),{setSidePanelContent:f,closeSidePanel:x}=P(),{removeUserQuery:u,lockUserQuery:o,unlockUserQuery:t}=T(),{mutateAsync:g,isPending:a}=u,{mutateAsync:_,isPending:j}=o,{mutateAsync:N,isPending:C}=t,w=Number(m),c=s.length===1?s[0]:void 0,{locked:$,unlocked:D}=le(s),F=async(S,M)=>{try{await S({computer_ids:[w],usernames:de(s),delete_home:M==="removed"?l:void 0}),n&&n(),x(),h.success({message:`Successfully requested to be ${M}`})}catch(J){p(J)}},R=async()=>{await F(_,"locked")},H=async()=>{await F(N,"unlocked")},z=async()=>{await F(g,"removed")},Y=()=>{f("Add new user",e.jsx(V,{}))},W=S=>{f("Edit user",e.jsx(b.Suspense,{fallback:e.jsx(I,{}),children:e.jsx(ye,{user:S})}))},X=()=>{d(S=>!S)};return e.jsxs("div",{className:re("p-panel__controls u-no-padding--top",{"u-no-margin--left":i}),children:[!i&&e.jsxs(r.Button,{className:"u-no-margin--right",type:"button",hasIcon:!0,onClick:Y,children:[e.jsx(r.Icon,{name:r.ICONS.plus}),e.jsx("span",{children:"Add user"})]}),e.jsx("div",{className:"p-segmented-control",children:e.jsxs("div",{className:"p-segmented-control__list",children:[((c==null?void 0:c.enabled)||!i)&&e.jsxs(r.ConfirmationButton,{className:"p-segmented-control__button has-icon",type:"button",disabled:D===0,"aria-disabled":D===0,confirmationModalProps:{title:`Lock ${c?`user ${c.username}`:`${s.length} users`}`,children:K({user:c,selectedUsers:s,userAction:O.Lock}),confirmButtonLabel:"Lock",confirmButtonAppearance:"positive",confirmButtonLoading:j,confirmButtonDisabled:j,onConfirm:R},children:[e.jsx(r.Icon,{name:"lock-locked"}),e.jsx("span",{children:"Lock"})]}),(!(c!=null&&c.enabled)||!i)&&e.jsxs(r.ConfirmationButton,{className:"p-segmented-control__button has-icon",type:"button",disabled:$===0,"aria-disabled":$===0,confirmationModalProps:{title:`Unlock ${c?`user ${c.username}`:`${s.length} users`}`,children:K({user:c,selectedUsers:s,userAction:O.Unlock}),confirmButtonLabel:"Unlock",confirmButtonAppearance:"positive",confirmButtonLoading:C,confirmButtonDisabled:C,onConfirm:H},children:[e.jsx(r.Icon,{name:"lock-unlock"}),e.jsx("span",{children:"Unlock"})]}),i&&c&&e.jsxs(r.Button,{className:"p-segmented-control__button",type:"button",onClick:()=>W(c),children:[e.jsx(r.Icon,{name:"edit"}),e.jsx("span",{children:"Edit"})]}),e.jsxs(r.ConfirmationButton,{className:"p-segmented-control__button has-icon",type:"button",disabled:s.length===0,"aria-disabled":s.length===0,confirmationModalProps:{title:`Delete ${c?c.username:"users"}`,children:e.jsxs("div",{children:[e.jsx("p",{className:"u-no-margin--bottom",children:c?`This will delete user ${c.username}. You can delete this user's home folders at the same time.`:"This will delete selected users. You can delete their home folders as well."}),e.jsx(r.Input,{label:"Delete the home folders as well",type:"checkbox",checked:l,onChange:X})]}),confirmButtonLabel:"Delete",confirmButtonAppearance:"negative",confirmButtonLoading:a,confirmButtonDisabled:a,onConfirm:z},children:[e.jsx(r.Icon,{name:r.ICONS.delete}),e.jsx("span",{children:"Delete"})]})]})})]})},ke=(s,n)=>s.filter(i=>n.includes(i.uid)),_e=({selected:s,handleClearSelection:n,users:i})=>e.jsxs(e.Fragment,{children:[e.jsx(me,{actions:e.jsx("div",{className:xe.actions,children:e.jsx(je,{handleClearSelection:n,selectedUsers:ke(i,s)})})}),e.jsx(pe,{filtersToDisplay:["search"]})]}),U={username:"username",status:"status",name:"name",uid:"uid"},we={username:(s,n)=>s.username.localeCompare(n.username),status:(s,n)=>Number(s.enabled)-Number(n.enabled),name:(s,n)=>(s.name||"").localeCompare(n.name||""),uid:(s,n)=>s.uid-n.uid},Se="_status_r5cf6_1",Ue="_statusCell_r5cf6_7",Ne="_actions_r5cf6_12",v={status:Se,statusCell:Ue,actions:Ne},Ce=b.lazy(()=>L(()=>import("./index-BvH-rCNH.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18]))),ve=b.lazy(()=>L(()=>import("./index-CHCHLBAy.js"),__vite__mapDeps([19,1,2,17,8,9,10,11,3,4,5,12,13,14,15,16,18]))),Ie=({users:s,selected:n,setSelected:i})=>{const{setPageParams:l,sortBy:d,sort:m}=Q(),{setSidePanelContent:p}=P();q("sortBy",Object.values(U)),q("sort",["asc","desc"]);const h=a=>{p("Edit user",e.jsx(b.Suspense,{fallback:e.jsx(I,{}),children:e.jsx(Ce,{user:a})}))},f=a=>{p("User details",e.jsx(b.Suspense,{fallback:e.jsx(I,{}),children:e.jsx(ve,{user:a})}))},x=()=>{i(n.length!==0?[]:s.map(({uid:a})=>a))},u=a=>{n.includes(a)?i(n.filter(_=>_!==a)):i([...n,a])},o=b.useMemo(()=>[{className:"checkbox-column",content:e.jsx(r.CheckboxInput,{label:e.jsx("span",{className:"u-off-screen",children:"Toggle all"}),labelClassName:"u-no-margin--bottom u-no-padding--top",onChange:x,checked:s.length>0&&n.length===s.length,indeterminate:n.length>0&&n.length<s.length,disabled:s.length===0})},{sortKey:U.username,content:"username"},{content:"status",sortKey:U.status},{content:"uid",sortKey:U.uid},{content:"full name",sortKey:U.name},{content:null,className:v.actions}],[s,n]),t=b.useMemo(()=>s.map(a=>({columns:[{accessor:"checkbox",className:"checkbox-column",content:e.jsx(r.CheckboxInput,{inline:!0,label:e.jsxs("span",{className:"u-off-screen",children:["Select user ",a.username]}),disabled:s.length===0,checked:n.includes(a.uid),onChange:()=>u(a.uid)})},{content:e.jsx(r.Button,{type:"button",appearance:"link",className:"u-no-margin--bottom u-no-padding--top",onClick:()=>f(a),"aria-label":`Show details of user ${a.username}`,children:a.username}),role:"rowheader"},{className:v.statusCell,content:e.jsx("div",{className:v.status,children:a.enabled?e.jsxs(e.Fragment,{children:[e.jsx(r.Icon,{name:"lock-unlock"}),e.jsx("span",{children:"Unlocked"})]}):e.jsxs(e.Fragment,{children:[e.jsx(r.Icon,{name:"lock-locked-active"}),e.jsx("span",{children:"Locked"})]})})},{content:a.uid},{content:a.name||e.jsx(he,{})},{className:v.actions,content:e.jsx(r.Tooltip,{message:"Edit",position:"btm-center",children:e.jsx(r.Button,{type:"button",small:!0,hasIcon:!0,appearance:"base",className:"u-no-margin--bottom u-no-padding--left","aria-label":`Edit ${a.name} profile`,onClick:()=>h(a),children:e.jsx(r.Icon,{name:"edit",className:"u-no-margin--left"})})})}]})),[s,n]),g=a=>{if(i([]),!a){l({sort:null,sortBy:""});return}l({sort:a===d&&m==="asc"?"desc":"asc",sortBy:a})};return e.jsx(r.MainTable,{headers:o,rows:t,onUpdateSort:g,defaultSort:d,defaultSortDirection:ge(m),sortable:!0,emptyStateMsg:"No users available"})},Pe=(s,n)=>s?n.filter(({username:i,name:l})=>{const d=l==null?void 0:l.toUpperCase().includes(s.toUpperCase()),m=i.toUpperCase().includes(s.toUpperCase());return d||m}):n,Fe="_link_1wvsk_1",Be={link:Fe},Ae=()=>{const[s,n]=b.useState([]),{instanceId:i,childInstanceId:l}=E(),{search:d,currentPage:m,pageSize:p}=Q(),{setSidePanelContent:h}=P(),{getUsersQuery:f}=T(),x=Number(l??i),{data:u,isLoading:o}=f({computer_id:x,limit:A}),t=(u==null?void 0:u.data.results)??[],g=be({data:t,sortFunctions:we}),a=Pe(d,g),_=(w,c)=>a.slice(c,c+w),j=b.useMemo(()=>_(p,(m-1)*p),[d,a,m,p]),N=()=>{n([])},C=()=>{h("Add new user",e.jsx(V,{}))};return e.jsxs(e.Fragment,{children:[!d&&o&&e.jsx(I,{}),!o&&!d&&(!u||u.data.results.length===0)&&e.jsx(ae,{title:"No users found",body:"Add new users by clicking the button below",icon:"connected",cta:[e.jsx(r.Button,{type:"button",appearance:"positive",onClick:C,children:"Add user"},"empty-state-add-new-user")]}),(d||!o&&j.length>0)&&e.jsxs(e.Fragment,{children:[e.jsx(_e,{selected:s,handleClearSelection:N,users:j}),(u==null?void 0:u.data.count)&&u.data.count>A&&e.jsx(r.Notification,{severity:"caution",title:`Fetched ${A} out of ${u==null?void 0:u.data.count} users`,children:e.jsxs("span",{children:["The number of requested users is too high. Please"," ",e.jsx(ie,{to:"https://support-portal.canonical.com/",className:Be.link,children:"contact our support team."})]})}),e.jsx(Ie,{selected:s,setSelected:w=>n(w),users:j})]}),e.jsx(ce,{handleClearSelection:N,totalItems:a.length,currentItemCount:j.length})]})},Oe=Object.freeze(Object.defineProperty({__proto__:null,default:Ae},Symbol.toStringTag,{value:"Module"}));export{je as U,Oe as i,T as u};
