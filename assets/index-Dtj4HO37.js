import{j as e,d as n,F as x,a5 as L,v as z,x as v,I as F,w as T,y as b,aN as H,aO as V,aP as k,o as M,p as $,k as U,q as Q,l as Y,a8 as _,f as X,i as W,z as K,N as Z,C as B,Z as J,M as j,K as m,a1 as ee}from"./index-u3-RAyfG.js";import{A as te}from"./AssociationBlock-fsM2pgDT.js";import{S as re}from"./SidePanelFormButtons-DQWWEfaM.js";import{u as G}from"./useRoles-aTSChSCW.js";import{u as O}from"./index-DhdTxkOp.js";import{U as ze,a as He,b as Ve}from"./index-DhdTxkOp.js";import{M as ae}from"./MultiSelectField-CDc9Ngoy.js";import{T as ie}from"./TextConfirmationModal-Ia9Wzkzd.js";import"./useGetTags-xCWOoIoo.js";import"./SidePanelFormButtons.module-BuIu-Bem.js";import"./PageMain-CdSZokyu.js";import"./constants-CBW_8zE3.js";import"./constants-DLWjfxLz.js";import"./HeaderWithSearch-DuxVyN2q.js";const D=[{label:"Sunday",order:0,value:"su"},{label:"Monday",order:1,value:"mo"},{label:"Tuesday",order:2,value:"tu"},{label:"Wednesday",order:3,value:"we"},{label:"Thursday",order:4,value:"th"},{label:"Friday",order:5,value:"fr"},{label:"Saturday",order:6,value:"sa"}],se=`If Landscape cannot upgrade the
associated instances by this point,
the upgrade will be canceled.`,ne="_container_6ykim_1",oe="_radioGroup_6ykim_7",le="_timeContainer_6ykim_13",de="_time_6ykim_13",ue="_timeInput_6ykim_27",ce="_inputDescriptionAfter_6ykim_32",pe="_inputDescriptionBefore_6ykim_37",me="_colon_6ykim_42",he="_tooltip_6ykim_48",ge="_expiration_6ykim_52",_e="_windowInputContainer_6ykim_59",ye="_windowInput_6ykim_59",ve="_windowInputDescription_6ykim_68",d={container:ne,radioGroup:oe,timeContainer:le,time:de,timeInput:ue,inputDescriptionAfter:ce,inputDescriptionBefore:pe,colon:me,tooltip:he,expiration:ge,windowInputContainer:_e,windowInput:ye,windowInputDescription:ve},fe=({formik:t})=>{const r=[t.touched.at_hour&&t.errors.at_hour||void 0,t.touched.at_minute&&t.errors.at_minute||void 0,t.touched.deliver_within&&t.errors.deliver_within||void 0];return e.jsxs("div",{className:d.container,children:[e.jsx("p",{className:"p-heading--5",children:"Schedule"}),e.jsx(ae,{variant:"condensed",label:"Days",items:D,selectedItems:D.filter(({value:o})=>t.values.on_days.includes(o)),onItemsUpdate:o=>t.setFieldValue("on_days",o.map(({value:u})=>u)),isSortedAlphabetically:!1,hasSelectedItemsFirst:!1,error:t.touched.on_days&&typeof t.errors.on_days=="string"?t.errors.on_days:void 0}),e.jsxs("div",{className:d.radioGroup,children:[e.jsx(n.RadioInput,{label:"At a specific time",...t.getFieldProps("every"),checked:t.values.every==="week",onChange:()=>t.setFieldValue("every","week")}),e.jsx(n.RadioInput,{label:"Hourly",...t.getFieldProps("every"),checked:t.values.every==="hour",onChange:()=>t.setFieldValue("every","hour")})]}),e.jsxs("div",{className:d.timeContainer,children:[e.jsxs("div",{className:d.time,children:[t.values.every==="week"&&e.jsxs(e.Fragment,{children:[e.jsx(n.Input,{type:"number",label:"Time","aria-label":"at hour",placeholder:"HH",className:d.timeInput,wrapperClassName:x({"is-error":r[0]}),...t.getFieldProps("at_hour"),"aria-errormessage":r[0]?"hour-error":void 0}),e.jsx("span",{className:d.colon,children:":"})]}),t.values.every==="hour"&&e.jsx("span",{className:d.inputDescriptionBefore,children:"at"}),e.jsx(n.Input,{type:"number",label:"At minute",labelClassName:"u-off-screen","aria-label":"at minute",className:d.timeInput,wrapperClassName:x({"is-error":r[1]}),placeholder:"MM",...t.getFieldProps("at_minute"),"aria-errormessage":r[1]?"minute-error":void 0}),t.values.every==="hour"&&e.jsx("span",{className:d.inputDescriptionAfter,children:"minute"}),e.jsx(n.Input,{type:"number",label:e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"Expires after "}),e.jsx(n.Tooltip,{message:se,position:"top-right",tooltipClassName:d.tooltip,children:e.jsx(n.Icon,{name:"help"})})]}),wrapperClassName:x(d.expiration,{"is-error":r[2]}),className:d.timeInput,...t.getFieldProps("deliver_within"),"aria-errormessage":"expires-error"}),e.jsx("span",{className:d.inputDescriptionAfter,children:"hours"})]}),r.filter(Boolean).length>0&&e.jsxs("div",{className:x({"is-error":r.filter(Boolean).length>0}),children:[r[0]&&e.jsx("p",{className:"p-form-validation__message",id:"hour-error",children:e.jsx("span",{children:r[0]})}),r[1]&&e.jsx("p",{className:"p-form-validation__message",id:"minute-error",children:e.jsx("span",{children:r[1]})}),r[2]&&e.jsxs("p",{className:"p-form-validation__message",id:"expires-error",children:[e.jsx("strong",{children:"Error: "}),e.jsx("span",{children:r[2]})]})]})]}),e.jsx("p",{children:"Randomise delivery over a time window"}),e.jsxs("div",{className:d.radioGroup,children:[e.jsx(n.RadioInput,{label:"No",...t.getFieldProps("randomizeDelivery"),checked:!t.values.randomizeDelivery,onChange:async()=>{await t.setFieldValue("randomizeDelivery",!1),await t.setFieldValue("deliver_delay_window","")}}),e.jsx(n.RadioInput,{label:"Yes",...t.getFieldProps("randomizeDelivery"),checked:t.values.randomizeDelivery,onChange:()=>t.setFieldValue("randomizeDelivery",!0)})]}),t.values.randomizeDelivery&&e.jsxs("div",{className:d.windowInputContainer,children:[e.jsx(n.Input,{type:"number",inputMode:"numeric",min:0,label:"Deliver delay window",labelClassName:"u-off-screen",className:d.windowInput,...t.getFieldProps("deliver_delay_window"),error:t.touched.deliver_delay_window&&t.errors.deliver_delay_window?t.errors.deliver_delay_window:void 0}),e.jsx("span",{className:d.windowInputDescription,children:"minutes"})]})]})},we={add:"Add upgrade profile",edit:"Save changes"},xe={access_group:L,all_computers:!1,at_hour:"",at_minute:"",autoremove:!1,deliver_delay_window:"",deliver_within:1,every:"week",on_days:[],randomizeDelivery:!1,tags:[],title:"",upgrade_type:"all"},C={add:"added",edit:"updated"},be=t=>z().shape({access_group:v(),all_computers:T(),at_hour:b().when("every",{is:"week",then:r=>r.required("Hour is required.").integer("Hour must be an integer.").min(0,"Hour must be between 0 and 23.").max(k,"Hour must be between 0 and 23.")}),at_minute:b().required("Minute is required.").integer("Minute must be an integer.").min(0,"Minute must be between 0 and 59.").max(V,"Minute must be between 0 and 59."),deliver_delay_window:b().when("randomizeDelivery",{is:!0,then:r=>r.required("This field is required.").integer("This field must be an integer.").max(H,"Deliver delay window in minutes must be a number less than or equal to 30 days (43200 minutes)").test((o,{createError:u,parent:c})=>o<parseInt(c.deliver_within)*60||u({message:`Deliver delay window of '${o}' minutes should be shorter than the 'deliver within' expiration time of ${c.deliver_within} ${c.deliver_within==="1"?"hour":"hours"}.`})).min(0,"Deliver delay window must be at least 0.")}),deliver_within:b().integer("'Expires after' must be an integer.").min(0,"'Expires after' must be at least 0."),every:v().required("This field is required."),on_days:F().of(v()).when("every",{is:"week",then:r=>r.min(1,"At least one day must be selected.")}),randomizeDelivery:T(),tags:F().of(v()),title:v().test({name:"required",message:"This field is required.",params:{action:t},test:r=>!!r||t!=="add"}),upgrade_type:v().required("This field is required.")}),R=t=>{const r=M(),{notify:o}=$(),{sidePath:u,popSidePath:c,setPageParams:p}=U(),{createUpgradeProfileQuery:a,editUpgradeProfileQuery:g}=O(),{getAccessGroupQuery:h}=G(),{data:y}=h({},{enabled:t.action==="add"}),I=y?.data.map(({name:s,title:l})=>({label:l,value:s}))??[],{mutateAsync:f}=a,{mutateAsync:P}=g,w=()=>{p({sidePath:[],profile:""})},i=Q({initialValues:xe,onSubmit:async s=>{const l={access_group:s.access_group,all_computers:s.all_computers,at_minute:s.at_minute,autoremove:s.autoremove,deliver_within:s.deliver_within,every:s.every,on_days:s.on_days,title:s.title,upgrade_type:s.upgrade_type};s.every==="week"&&(l.at_hour=s.at_hour),s.randomizeDelivery&&(l.deliver_delay_window=s.deliver_delay_window),!s.all_computers&&s.tags.length&&(l.tags=s.tags);try{t.action==="edit"?await P({all_computers:l.all_computers,at_hour:l.at_hour,at_minute:l.at_minute,autoremove:l.autoremove,deliver_delay_window:l.deliver_delay_window,deliver_within:l.deliver_within,every:l.every,name:t.profile.name,on_days:l.on_days,tags:l.tags,title:l.title,upgrade_type:l.upgrade_type}):await f(l),w(),o.success({message:`Upgrade profile "${s.title}" has been ${C[t.action]} `,title:`Upgrade profile ${C[t.action]}`})}catch(A){r(A)}},validationSchema:be(t.action)});return Y.useEffect(()=>{t.action!=="edit"||!t.profile||i.setValues({access_group:t.profile.access_group,all_computers:t.profile.all_computers,at_hour:t.profile.at_hour?parseInt(t.profile.at_hour):"",at_minute:parseInt(t.profile.at_minute),autoremove:t.profile.autoremove,deliver_delay_window:parseInt(t.profile.deliver_delay_window),deliver_within:parseInt(t.profile.deliver_within),every:t.profile.every,on_days:t.profile.on_days??[],randomizeDelivery:t.profile.deliver_delay_window!=="0",tags:t.profile.tags,title:t.profile.title,upgrade_type:t.profile.upgrade_type})},[t]),e.jsxs(n.Form,{onSubmit:i.handleSubmit,noValidate:!0,children:[e.jsx(n.Input,{type:"text",required:t.action==="add",label:"Title",...i.getFieldProps("title"),error:i.touched.title&&i.errors.title?i.errors.title:void 0}),e.jsx(n.Input,{type:"checkbox",label:"Only upgrade security issues",help:"Regular upgrades will not be applied",...i.getFieldProps("upgrade_type"),checked:i.values.upgrade_type==="security",onChange:async()=>i.setFieldValue("upgrade_type",i.values.upgrade_type==="all"?"security":"all")}),e.jsx(n.Input,{type:"checkbox",label:"Remove packages that are no longer needed",help:"This will affect packages installed to satisfy dependencies that are no longer required after upgrading.",...i.getFieldProps("autoremove"),checked:i.values.autoremove}),e.jsx(n.Select,{label:"Access group","aria-label":"Access group",options:I,...i.getFieldProps("access_group"),error:i.touched.access_group&&i.errors.access_group?i.errors.access_group:void 0}),e.jsx(fe,{formik:i}),e.jsx(te,{formik:i}),e.jsx(re,{submitButtonDisabled:i.isSubmitting,submitButtonText:we[t.action],onCancel:w,hasBackButton:u.length>1,onBackButtonPress:c})]})},Ge=()=>e.jsxs(e.Fragment,{children:[e.jsx(_.Header,{children:"Add upgrade profile"}),e.jsx(_.Content,{children:e.jsx(R,{action:"add"})})]}),je=t=>{const r=X(),{data:o,isPending:u,error:c}=W({queryKey:["upgradeProfile",t],queryFn:async({signal:a})=>r.get("GetUpgradeProfiles",{signal:a})}),p=o?.data.find(({id:a})=>a===t);return{upgradeProfile:p,upgradeProfileError:o&&!p?new Error("The upgrade profile could not be found."):c,isGettingUpgradeProfile:u}},q=()=>{const{profile:t}=U(),{isGettingUpgradeProfile:r,upgradeProfile:o,upgradeProfileError:u}=je(parseInt(t));if(u)throw u;return r?{upgradeProfile:void 0,isGettingUpgradeProfile:!0}:{upgradeProfile:o,isGettingUpgradeProfile:!1}},E=t=>D.filter(({value:r})=>t.includes(r)).sort((r,o)=>r.order-o.order).map(({label:r})=>r).join(", ").replace(/,(?= \w+$)/," and"),Ie=t=>{const{at_hour:r,deliver_within:o,every:u,next_run:c,on_days:p}=t,a=K(c).utc().format(`ddd, ${Z} [UTC (expires after ${o}h)]`);let g="Every ";const h=parseInt(t.at_minute);if(u==="hour"&&(g+=`hour at ${h} ${B(h,"minute")}`,p&&(g+=` on ${E(p)}`)),u==="week"){if(!p||!r)return{scheduleMessage:"Every week",nextRunMessage:a};const y=parseInt(r);g+=`${E(p)} at ${y>9?y:`0${y}`}:${h>9?h:`0${h}`} UTC`}return{scheduleMessage:g,nextRunMessage:a}},Oe=()=>{const t=M(),{notify:r}=$(),{pushSidePath:o,setPageParams:u}=U(),{getAccessGroupQuery:c}=G(),{removeUpgradeProfileQuery:p}=O(),{upgradeProfile:a,isGettingUpgradeProfile:g}=q(),{data:h,isPending:y}=c(),{mutateAsync:I,isPending:f}=p,{value:P,setTrue:w,setFalse:N}=J();if(g||y)return e.jsx(_.LoadingState,{});const{scheduleMessage:i,nextRunMessage:s}=Ie(a),l=async()=>{try{await I({name:a.name}),u({sidePath:[],profile:""}),r.success({title:"Upgrade profile removed",message:`Upgrade profile ${a.title} has been removed`})}catch(S){t(S)}finally{N()}},A=()=>{o("edit")};return e.jsxs(e.Fragment,{children:[e.jsx(_.Header,{children:a.title}),e.jsxs(_.Content,{children:[e.jsxs("div",{className:"p-segmented-control",children:[e.jsxs(n.Button,{type:"button",hasIcon:!0,className:"p-segmented-control__button",onClick:A,"aria-label":`Edit upgrade profile ${a.title}`,children:[e.jsx(n.Icon,{name:"edit"}),e.jsx("span",{children:"Edit"})]}),e.jsxs(n.Button,{className:"has-icon p-segmented-control__button","aria-label":`Remove upgrade profile ${a.title}`,type:"button",onClick:w,children:[e.jsx(n.Icon,{name:n.ICONS.delete}),e.jsx("span",{children:"Remove"})]})]}),e.jsxs(j,{children:[e.jsx(j.Item,{children:e.jsxs(m,{children:[e.jsx(m.Item,{label:"Title",value:a.title}),e.jsx(m.Item,{label:"Name",value:a.name}),e.jsx(m.Item,{label:"Access group",value:h?.data.find(S=>S.name===a.access_group)?.title??a.access_group}),e.jsx(m.Item,{label:"Upgrade type",value:a.upgrade_type==="all"?"All":"Security"}),e.jsx(m.Item,{label:"Auto remove packages",value:a.autoremove?"On":"Off"})]})}),e.jsx(j.Item,{title:"Schedule",children:e.jsxs(m,{children:[e.jsx(m.Item,{label:"Schedule",large:!0,value:i}),e.jsx(m.Item,{label:"Next run",large:!0,value:s}),e.jsx(m.Item,{label:"Delivery delay window",large:!0,value:`${a.deliver_delay_window} ${B(Number(a.deliver_delay_window),"minute")}`})]})}),e.jsx(j.Item,{title:"Association",children:e.jsxs(e.Fragment,{children:[a.all_computers&&e.jsx("p",{children:"This profile has been associated with all instances."}),!a.all_computers&&!a.tags.length&&e.jsx("p",{children:"This profile has not yet been associated with any instances."}),!a.all_computers&&a.tags.length>0&&e.jsx(ee,{label:"Tags",value:a.tags.join(", ")||null})]})})]})]}),e.jsx(ie,{isOpen:P,title:"Remove upgrade profile",confirmButtonLabel:"Remove",confirmButtonAppearance:"negative",confirmButtonDisabled:f,confirmButtonLoading:f,onConfirm:l,close:N,confirmationText:`remove ${a.title}`,children:e.jsxs("p",{children:['This will remove "',a.title,'" upgrade profile. This action is ',e.jsx("b",{children:"irreversible"}),"."]})})]})},Re=()=>{const{upgradeProfile:t,isGettingUpgradeProfile:r}=q();return r?e.jsx(_.LoadingState,{}):e.jsxs(e.Fragment,{children:[e.jsxs(_.Header,{children:['Edit "',t.title,'" profile']}),e.jsxs(_.Content,{children:[e.jsx(R,{action:"edit",profile:t}),";"]})]})};export{R as SingleUpgradeProfileForm,Ge as UpgradeProfileAddSidePanel,Oe as UpgradeProfileDetailsSidePanel,Re as UpgradeProfileEditSidePanel,ze as UpgradeProfileList,He as UpgradeProfilesEmptyState,Ve as UpgradeProfilesHeader,O as useUpgradeProfiles};
