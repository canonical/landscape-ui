import{r as _,j as S,u as U,C as M,d as x}from"./index-Dfc97QGW.js";import{C as W}from"./CodeEditor-HNBBpJH4.js";import{S as X}from"./SidePanelFormButtons-BdOP5SSP.js";import{W as H,L as j,N as V,K as q,Q,e as Y,C as z,f as J,h as N,B as P,i as $,j as B,k as Z,l as ee,V as te,P as re,m as G,n as K,I as se,T as ne,b as ie,o as oe}from"./InstancesPageActions-Dns4Yse-.js";import{g as ae}from"./formikErrors-Bw8iTXYS.js";import{u as ue}from"./useInstanceSearchHelpTerms-CQVimD-E.js";import"./index-DiSNWm9B.js";import"./SidePanelFormButtons.module-CcPyiogC.js";import"./index-S_kjB96R.js";import"./NoData-DMN9LLPq.js";import"./ResponsiveTable-ViIMTRR6.js";import"./TablePagination-B0v8QAQr.js";import"./TableFilterChips-DXWGZ6VK.js";import"./useFetchOld-BgGVMMmJ.js";import"./PageParamFilter-C5PJgjVf.js";import"./TableFilter-BmLRyeMD.js";import"./ListTitle-DsIgCqjQ.js";import"./StaticLink-BNg3qc2M.js";import"./TruncatedCell-Cf7_euhM.js";import"./Truncated-D8EZCoK1.js";import"./useExpandableRow-DYtdXwcw.js";import"./TextConfirmationModal-O9rtHEfo.js";import"./InfoGrid-CrJbMYy5.js";import"./InfoItem-DImpX37B.js";const le=({label:e,value:t,onChange:r,onBlur:s,error:n=!1,required:i=!1,className:m,labelClassName:l,headerContent:a,options:o,languageId:c,terms:E,languageConfig:T,configureSearchLanguage:g})=>{const u=_.useCallback(v=>{E.length>0&&g(v,c,E,T)},[c,E,T,g]);return S.jsx(W,{label:e,value:t,onChange:r,onBlur:s,error:n,required:i,className:m,labelClassName:l,headerContent:a,language:c,monacoBeforeMount:u,options:{fixedOverflowWidgets:!0,suggestOnTriggerCharacters:!0,quickSuggestions:!0,...o}})},O=new Set,A=new Set,w={},ce=e=>e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),de=e=>new RegExp(`\\b(${e})(?=:)`),me=(e,t,r,s,n)=>{const i=(o,c,E=!1)=>({label:o,kind:E?s.languages.CompletionItemKind.Keyword:s.languages.CompletionItemKind.EnumMember,insertText:o,range:r,detail:c}),m=(o,c)=>({label:`<${o}>`,kind:s.languages.CompletionItemKind.Text,insertText:`<${o}>`,range:r,detail:c});if(t===1)return n.profileTypes.map(o=>i(o,"Profile Type"));const a=e[1];if(t===2)return[m("profile_id",`ID for ${a}`)];if(t===3){if(a==="security"&&n.usgStatuses.length>0)return n.usgStatuses.map(o=>i(o,"Audit Result"));if(a==="wsl"&&n.wslStatuses.length>0)return n.wslStatuses.map(o=>i(o,"Compliance Status"))}return[]},pe=(e,t,r)=>{const s=(n,i)=>({label:`<${n}>`,kind:r.languages.CompletionItemKind.Text,insertText:`<${n}>`,range:t,detail:i});return e===1?[s("key","Annotation Key")]:e===2?[s("string","Value substring match")]:[]},C=(e,t,r,s)=>e.map(n=>({label:n,kind:s.languages.CompletionItemKind.EnumMember,insertText:n,range:r,detail:t})),fe=(e,t,r,s)=>{const[n]=e,i=e.length-1;switch(n){case"profile":return me(e,i,t,r,s);case"alert":return i===1?C(B,"Alert Type",t,r):[];case"license-type":return i===1?C($,"License Type",t,r):[];case"needs":return i===1?C(["reboot","license"],"Requirement",t,r):[];case"has-pro-management":return i===1?C(P,"Boolean",t,r):[];case"annotation":return pe(i,t,r);default:return[]}},Ee=(e,t,r,s)=>{const n=r.map(l=>l.trim()).filter(Boolean),i=Array.from(new Set(n));w[t]={terms:i,config:s};const m=i.length>0?i.map(ce).join("|"):"NEVER_MATCH";O.has(t)||(e.languages.register({id:t}),O.add(t)),e.languages.setMonarchTokensProvider(t,{tokenizer:{root:[[H,"white"],[j,"keyword"],[de(m),"type.identifier"],[V,"number"],[q,"type.identifier"],[Q,"string"],[Y,"number"],[z,"delimiter"]]}}),A.has(t)||(e.languages.registerCompletionItemProvider(t,{triggerCharacters:[":"," ",'"'],provideCompletionItems(l,a){const o=l.getWordUntilPosition(a),c={startLineNumber:a.lineNumber,endLineNumber:a.lineNumber,startColumn:o.startColumn,endColumn:o.endColumn},E=l.getLineContent(a.lineNumber),T=a.column-1,b=(E.slice(0,T).match(J)?.[1]??"").split(":"),k=b.length>1,y=w[t],p=y?.config??{profileTypes:[],usgStatuses:[],wslStatuses:[]};if(k)return{suggestions:fe(b,c,e,p)};const L=(y?.terms??[]).map(h=>({label:h,kind:e.languages.CompletionItemKind.Keyword,insertText:`${h}:`,range:c,detail:"Search term"})),F=N.map(h=>({label:h,kind:e.languages.CompletionItemKind.Operator,insertText:h,range:c,detail:"Logical operator"}));return{suggestions:[...L,...F]}}}),A.add(t))},D=e=>se.test(e),ge=(e,t)=>t.includes(e),Te=(e,t)=>t.includes(e),he=(e,t)=>t.includes(e),Se=e=>$.includes(e),ve=e=>P.includes(e),be=e=>N.includes(e),ye=e=>te.includes(e),d=(e,t)=>`"${e}" ${t}`,Ce=(e,t,r,s)=>!!(!(e===t)||r||s),Re=(e,t)=>{const r=e.toUpperCase();if(be(r))return t===0&&(r==="AND"||r==="OR")?`"${r}" cannot start a query.`:void 0},_e=e=>{if(!B.includes(e))return d("alert",`has invalid value "${e}".`)},ke=e=>{if(!Se(e))return d("license-type",`has invalid value "${e}".`)},Le=e=>{if(!ve(e))return d("has-pro-management",'must be "true", "false", "1", or "0".')},xe=e=>{if(!["reboot","license"].includes(e))return d("needs",`has invalid value "${e}".`)},Oe=([,e,t,r],s)=>{const n="profile",i=s.profileTypes??re,m=s.usgStatuses??G,l=s.wslStatuses??K;if(!he(e,i))return d(n,`has invalid profile type "${e}".`);if(!t||!t.trim())return d(n,"requires an ID.");if(!D(t))return d(n,"ID must be a number.");if(e==="security"||e==="wsl"){if(!r)return d(`${n}:${e}`,"requires a status.");if(e==="security"&&!ge(r,m))return d(`${n}:${e}`,`has invalid security status "${r}".`);if(e==="wsl"&&!Te(r,l))return d(`${n}:${e}`,`has invalid WSL status "${r}".`)}},Ae=(e,t)=>{if(!D(t))return d(e,"requires a number.")},we=e=>{if(!e.trim())return d("annotation","key cannot be empty.")},Ie=(e,t)=>{const[r,s]=e;if(!ye(r))return d(r,"is not a valid query key.");if(!s||!s.trim())return d(r,"requires a value.");switch(r){case"alert":return _e(s);case"license-type":return ke(s);case"has-pro-management":return Le(s);case"needs":return xe(s);case"profile":return Oe(e,t);case"annotation":return we(s);case"id":case"contract":case"contract-expires-within-days":case"license-expires-within-days":return Ae(r,s);default:return}},Ne=(e,t,r)=>{if(!e.includes(":"))return Re(e,t);const s=e.split(":");return Ie(s,r)},I=(e,t=!1,r={})=>{if(!e||!e.trim())return;const s=ne.test(e),n=e.match(Z)??[],i=n.length-1;for(const[m,l]of n.entries()){if(!Ce(m,i,t,s))continue;const a=l.replace(ee,""),o=Ne(a,m,r);if(o)return o}},R=(e,t,r={})=>!e||!e.trim()?"This field is required.":t==="typing"?I(e,!1,r):I(e,!0,r),Pe="instance-search-query",it=({initialValues:e,onSubmit:t,mode:r,onBackButtonPress:s})=>{const n=ue(),{isFeatureEnabled:i}=U(),m=i("script-profiles"),l=i("usg-profiles"),a=i("wsl-child-instance-profiles"),o=_.useMemo(()=>({profileTypes:ie({isScriptProfilesEnabled:m,isUsgProfilesEnabled:l,isWslProfilesEnabled:a}),usgStatuses:l?G:[],wslStatuses:a?K:[]}),[m,l,a]),c=!!e.search?.trim(),E=c?R(e.search,"strict",o):void 0,[T,g]=_.useState(E),u=M({initialValues:e,validationSchema:oe,enableReinitialize:!0,validateOnMount:!0,initialTouched:{title:!1,search:c},onSubmit:async p=>{await t(p)}}),v=_.useMemo(()=>Array.from(new Set(n.flatMap(({term:p})=>p.split(/\s+OR\s+/i).map(f=>f.split(":")[0]).filter(f=>f!==void 0)))),[n]),b=()=>{u.setFieldTouched("search",!0,!1);const p=R(u.values.search,"strict",o);g(p)},k=async p=>{p.preventDefault();const f=R(u.values.search,"strict",o);g(f),!f&&u.handleSubmit()},y=u.isSubmitting||!u.values.search.trim()||!!u.errors.title;return S.jsxs(x.Form,{noValidate:!0,onSubmit:k,children:[S.jsx(x.Input,{type:"text",label:"Title",disabled:r==="edit",required:!0,...u.getFieldProps("title"),error:ae(u,"title")}),S.jsx(le,{label:"Search query",required:!0,value:u.values.search,onBlur:b,configureSearchLanguage:Ee,languageConfig:o,onChange:p=>{const f=p??"";u.setFieldValue("search",f),u.setFieldTouched("search",!0,!1);const L=R(f,"typing",o);g(L)},error:u.touched.search?T:void 0,languageId:Pe,terms:v,options:{wordWrap:"on",automaticLayout:!0,lineNumbers:"off",lineDecorationsWidth:0,lineNumbersMinChars:0}}),S.jsx(X,{submitButtonText:r==="create"?"Add saved search":"Save changes",submitButtonLoading:u.isSubmitting,submitButtonDisabled:y,hasBackButton:!!s,onBackButtonPress:s})]})};export{it as default};
