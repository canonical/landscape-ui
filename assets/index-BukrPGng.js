import{f as A,g as v,h as y,a5 as T,v as d,I as j,x as c,ak as r,l as P,n as E,o as R,q as I,j as a,d as o,s as l}from"./index-CDk-Jgvr.js";import{C as w}from"./CodeEditor-CRtMIC7q.js";import{S as _}from"./SidePanelFormButtons-CsUGQk2E.js";import{u as q}from"./useRoles-BvJMVkR7.js";import{u as V,D,S as k}from"./ScriptFormAttachments-CnVu-0iZ.js";import{j as N,i as L,r as O}from"./ScriptsTabs-Brc46TKb.js";import"./index-C_IEMtmD.js";import"./SidePanelFormButtons.module-BuIu-Bem.js";import"./AttachmentFile-hOzh9wnz.js";import"./constants-DRKgEQ0k.js";import"./TextConfirmationModal-BxLh3OQM.js";import"./HeaderWithSearch-lC_PsP2p.js";import"./SingleInstanceTabs.module-Cm1BYFZQ.js";const B=()=>{const i=A(),u=v(),{mutateAsync:m,isPending:h}=y({mutationKey:["scripts","create"],mutationFn:async p=>i.get("CreateScript",{params:p}),onSuccess:async()=>u.invalidateQueries({queryKey:["scripts"]})});return{createScript:m,isCreatingScript:h}},G={title:"",code:"",access_group:T,attachments:{first:null,second:null,third:null,fourth:null,fifth:null},attachmentsToRemove:[]},M=()=>d().shape({title:c().required("This field is required"),access_group:c().nullable(),code:c().test({name:"required",message:"This field is required",test:i=>!!i}),attachments:d().shape({first:r().nullable(),second:r().nullable(),third:r().nullable(),fourth:r().nullable(),fifth:r().nullable()}),attachmentsToRemove:j().of(c())}),se=()=>{const i=P.useRef(null),{closeSidePanel:u}=E(),m=R(),{getAccessGroupQuery:h}=q(),{createScript:p}=B(),{createScriptAttachment:f}=V(),{data:g}=h(),S=(g?.data??[]).map(t=>({label:t.title,value:t.name})),b=async t=>{const n=Object.values(t.attachments).filter(s=>s!==null);try{const s=await p(N(t));n.length&&await Promise.all(await L({attachments:n,createScriptAttachment:f,script_id:s.data.id})),u()}catch(s){m(s)}},e=I({initialValues:G,validationSchema:M(),onSubmit:b}),C=async({target:{files:t}})=>{if(!t)return;const[n]=t,s=e.setFieldValue("code",await n.text());if(e.values.title){await s;return}await Promise.all([e.setFieldValue("title",O(n.name)),s])},x=async t=>{await e.setFieldValue("code",t)},F=()=>i.current?.click();return a.jsxs(o.Form,{onSubmit:e.handleSubmit,noValidate:!0,children:[a.jsx(o.Input,{type:"text",label:"Title",required:!0,...e.getFieldProps("title"),error:l(e,"title")}),a.jsx("input",{ref:i,className:"u-hide",type:"file",onChange:C}),a.jsx(w,{label:"Code",value:e.values.code,onChange:x,error:l(e,"code"),required:!0,defaultValue:D,headerContent:a.jsxs(o.Button,{className:"u-no-margin--bottom",appearance:"base",hasIcon:!0,onClick:F,type:"button",children:[a.jsx(o.Icon,{name:"upload"}),a.jsx("span",{children:"Populate from file"})]})}),a.jsx(o.Select,{label:"Access group",...e.getFieldProps("access_group"),options:S,error:l(e,"access_group")}),a.jsxs(a.Fragment,{children:[a.jsx("h5",{children:"List of attachments"}),a.jsx("p",{className:"u-text--muted",children:"Attachments that will be sent along with the script. You can attach up to 5 files, for a maximum of 1.00MB. Filenames must be unique. On the client, the attachments will be placed in the directory whose name is accessible through the environment variable LANDSCAPE_ATTACHMENTS. They'll be deleted once the script has been run."})]}),a.jsx(k,{attachments:e.values.attachments,attachmentsToRemove:e.values.attachmentsToRemove,getFileInputError:t=>l(e,["attachments",t]),initialAttachments:[],onFileInputChange:t=>async n=>e.setFieldValue(`attachments.${t}`,n.target.files?.[0]??null),onInitialAttachmentDelete:t=>{e.setFieldValue("attachmentsToRemove",[...e.values.attachmentsToRemove,t])}}),a.jsx(_,{submitButtonText:"Create script",submitButtonDisabled:e.isSubmitting})]})};export{se as default};
