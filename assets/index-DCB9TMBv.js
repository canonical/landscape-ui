import{m as W,t as L,v as M,f as Z,ag as X,H as G,W as O,I as B,ax as J,o as x,z as $,w,B as U,C as D,j as e,am as b,d as o,F as p,a4 as A,Y as C,Q as m,aY as ee,ad as te,aU as se,r as F,aB as ie,l as ae,S as ne,R as oe,aV as le,G as re,Z as ce,N as ue,V as de,aD as pe,i as me,aM as ge}from"./index-BniO5lih.js";import{W as fe,a as he}from"./index-dgYXauAB.js";import{b as Pt,c as jt,d as yt,u as St,e as _t}from"./index-dgYXauAB.js";import{d as V}from"./WslInstancesEmptyState-C2dCgPAx.js";import{e as Ft,u as Ct}from"./WslInstancesEmptyState-C2dCgPAx.js";import{A as Q}from"./AssociationBlock-Zj-_6Rr_.js";import{C as xe}from"./CodeEditor-14PL8VtM.js";import{F as be}from"./FileInput-w9rWQLby.js";import{S as H}from"./SidePanelFormButtons-bG-J2X_B.js";import{u as z}from"./useGetWslInstanceTypes-_TzFH298.js";import{u as N}from"./useRoles-DRKlPdx8.js";import{P as q}from"./ProfileAssociatedInstancesLink-DI07A0S1.js";import{P as Ie}from"./ProfileAssociationInfo-C914mW5E.js";import"./index-CCM0AgEZ.js";import{L as Pe}from"./constants-HWGNn3R9.js";import{u as je}from"./useGetInstances-CYwqcOV3.js";import{u as ye}from"./useSelection-p6Ak6tLO.js";import"./PageMain-DMSiaUeu.js";import"./useGetWslLimits-CpJyx7Wp.js";import"./HeaderWithSearch-S6PnmELF.js";import"./constants-n-s_Ig12.js";import"./table-CdFwMAPu.js";import"./MultiSelectField-CyRN2UEo.js";import"./useGetTags-CPW6gZD2.js";import"./SidePanelFormButtons.module-CcPyiogC.js";const Se=()=>{const t=W(),i=L(),{isPending:s,mutateAsync:l}=M({mutationFn:async u=>t.post("child-instance-profiles",u),onSuccess:async()=>i.invalidateQueries({queryKey:["wslProfiles"]})});return{isAddingWslProfile:s,addWslProfile:l}},_e=()=>{const t=W(),i=L(),{isPending:s,mutateAsync:l}=M({mutationFn:async({name:u,...g})=>t.patch(`child-instance-profiles/${u}`,g),onSuccess:async()=>i.invalidateQueries({queryKey:["wslProfiles"]})});return{editWslProfile:l,isEditingWslProfile:s}},Te=({profile_name:t},i={})=>{const s=W(),{data:l,isPending:u,error:g}=Z({queryKey:["wslProfile",t],queryFn:async({signal:I})=>s.get(`child-instance-profiles/${t}`,{signal:I}),...i});return{wslProfile:l?.data,wslProfileError:g,isGettingWslProfile:u}},Fe=1,Y=[{label:"Select",value:""},{label:"From a file",value:"file"},{label:"Plain text",value:"text"}],Ce="You can use a cloud-init configuration YAML file under 1MB to register new WSL instances. Cloud-init streamlines the setup by automating installation and configuration tasks.",we=[/^ubuntu$/,/^ubuntu-preview$/,/^ubuntu-[0-9]{2}\.[0-9]{2}$/],Re={title:"",access_group:X,description:"",instanceType:"",customImageName:"",rootfsImage:"",cloudInitType:"",cloudInit:null,all_computers:!1,tags:[]},K=t=>{const i=new Blob([t],{type:"application/x-yaml"});return new File([i],"myFile.yaml",{type:"application/x-yaml"})},ve=()=>G().shape({title:x().required("This field is required"),access_group:x().required("This field is required"),description:x().required("This field is required"),instanceType:x().required("This field is required"),rootfsImage:x().when("instanceType",{is:"custom",then:t=>t.required("This field is required"),otherwise:t=>t.notRequired()}),customImageName:x().when("instanceType",{is:"custom",then:t=>t.required("This field is required").test("not-match-reserved-patterns","Instance name cannot match 'ubuntu', 'ubuntu-preview', or 'ubuntu-<dd>.<dd>'",i=>!we.some(s=>s.test(i.toLowerCase()))),otherwise:t=>t.notRequired()}),cloudInitType:x(),cloudInit:J().nullable().when("cloudInitType",{is:t=>t==="file"||t==="text",then:t=>t.required("This field is required").test("file-size","File size must be less than 1MB",i=>(typeof i=="string"&&(i=K(i)),i?i.size===void 0?!1:i.size<=Fe*1024*1024:!0)),otherwise:t=>t.notRequired()}),all_computers:B(),tags:O().of(x())}),We=t=>{if(t)return new Promise((i,s)=>{const l=new FileReader;l.readAsDataURL(t),l.onload=()=>{i(l.result)},l.onerror=u=>{s(u)}})},Ae=async t=>{if(t===null)return;let i;typeof t=="string"?i=K(t):i=t;const s=await We(i);return s?s.split(",")[1]:void 0},Ne="_block_tz139_1",Ee={block:Ne},gt=()=>{const t=$(),{createPageParamsSetter:i}=w(),{notify:s}=U(),{getAccessGroupQuery:l}=N(),{addWslProfile:u}=Se(),{data:g}=l(),{isGettingWslInstanceTypes:I,wslInstanceTypes:P}=z(),j=P.map(({label:n,name:d})=>({label:n,value:d}))||[],y=[{label:"Select",value:""},...j,{label:"From URL",value:"custom"}],f=g?.data.map(({name:n,title:d})=>({label:d,value:n}))??[],S=i({sidePath:[]}),a=D({initialValues:Re,onSubmit:async n=>{try{const d=await Ae(n.cloudInit),c=(await u({title:n.title,access_group:n.access_group,description:n.description,image_name:n.instanceType==="custom"?n.customImageName:n.instanceType,image_source:n.rootfsImage,cloud_init_contents:d,all_computers:n.all_computers,tags:n.tags})).data.computers.constrained.length;S(),s.success({title:`Profile "${n.title}" added successfully`,message:`It has been associated with ${c} instances`})}catch(d){t(d)}},validationSchema:ve()}),T=async n=>{await a.setFieldValue("cloudInit",n[0])},r=async()=>{await a.setFieldValue("cloudInit",null)};return e.jsxs(e.Fragment,{children:[e.jsx(b.Header,{children:"Add WSL profile"}),e.jsx(b.Content,{children:e.jsxs(o.Form,{onSubmit:a.handleSubmit,noValidate:!0,children:[e.jsx(o.Input,{type:"text",label:"Title",required:!0,...a.getFieldProps("title"),error:p(a,"title")}),e.jsx(o.Input,{type:"text",label:"Description",required:!0,...a.getFieldProps("description"),error:p(a,"description")}),e.jsx(o.Select,{label:"Access group","aria-label":"Access group",required:!0,options:f,...a.getFieldProps("access_group"),error:p(a,"access_group")}),e.jsxs("div",{className:Ee.block,children:[(a.values.instanceType!==""||a.values.cloudInitType!=="")&&e.jsx(o.Notification,{severity:"caution",title:"Warning",children:e.jsx("span",{children:"Once the profile is added, you cannot modify the rootfs image or cloud-init file."})}),e.jsx(o.Select,{label:"Rootfs image",disabled:I,"aria-label":"Rootfs image",options:y,required:!0,...a.getFieldProps("instanceType"),error:p(a,"instanceType")}),a.values.instanceType==="custom"&&e.jsxs(e.Fragment,{children:[e.jsx(o.Input,{label:"Image name",type:"text",required:!0,...a.getFieldProps("customImageName"),error:p(a,"customImageName")}),e.jsx(o.Input,{type:"text",label:"Rootfs image URL",required:!0,...a.getFieldProps("rootfsImage"),error:p(a,"rootfsImage"),help:"The file path must be reachable by the affected WSL instances."})]}),e.jsx(o.Select,{label:"Cloud-init","aria-label":"Cloud-init",options:Y,...a.getFieldProps("cloudInitType"),onChange:async n=>{a.getFieldProps("cloudInitType").onChange(n),await a.setFieldValue("cloudInit",null)},error:p(a,"cloudInitType")}),a.values.cloudInitType==="file"&&e.jsx(be,{label:"Upload cloud-init",labelClassName:"u-off-screen",accept:".yaml",...a.getFieldProps("cloudInit"),value:a.values.cloudInit instanceof File?a.values.cloudInit:null,onFileRemove:r,onFileUpload:T,help:Ce,error:p(a,"cloudInit")}),a.values.cloudInitType==="text"&&e.jsx(xe,{label:"Cloud-init configuration",onChange:n=>{a.setFieldValue("cloudInit",n??"")},value:typeof a.values.cloudInit=="string"?a.values.cloudInit:"",language:"yaml",defaultValue:"# paste cloud-init config here",error:p(a,"cloudInit")})]}),e.jsx(Q,{formik:a}),e.jsx(H,{submitButtonText:"Add WSL profile",submitButtonAriaLabel:"Add a new WSL profile",submitButtonDisabled:a.isSubmitting,onCancel:S})]})})]})},E=()=>{const{profile:t}=w(),{wslProfile:i,isGettingWslProfile:s,wslProfileError:l}=Te({profile_name:t});if(l)throw l;return s?{wslProfile:void 0,isGettingWslProfile:!0}:{wslProfile:i,isGettingWslProfile:!1}},ft=()=>{const{createSidePathPusher:t}=w(),{getAccessGroupQuery:i}=N(),{wslProfile:s,isGettingWslProfile:l}=E(),{data:u,isPending:g}=i(),{value:I,setTrue:P,setFalse:j}=A();if(l||g)return e.jsx(b.LoadingState,{});const y=t("edit");return e.jsxs(e.Fragment,{children:[e.jsx(b.Header,{children:s.title}),e.jsxs(b.Content,{children:[e.jsx("div",{className:"p-segmented-control",children:e.jsxs("div",{className:"p-segmented-control__list",children:[e.jsxs(o.Button,{type:"button",hasIcon:!0,className:"p-segmented-control__button",onClick:y,children:[e.jsx(o.Icon,{name:"edit"}),e.jsx("span",{children:"Edit"})]}),e.jsxs(o.Button,{type:"button",hasIcon:!0,className:"p-segmented-control__button","aria-label":`Remove ${s.title} profile`,onClick:P,children:[e.jsx(o.Icon,{name:o.ICONS.delete}),e.jsx("span",{children:"Remove"})]})]})}),e.jsxs(C,{children:[e.jsx(C.Item,{children:e.jsxs(m,{children:[e.jsx(m.Item,{label:"Title",value:s.title}),e.jsx(m.Item,{label:"Name",value:s.name}),e.jsx(m.Item,{label:"Access group",value:ee(s.access_group,u)}),e.jsx(m.Item,{label:"Description",large:!0,value:s.description})]})}),e.jsx(C.Item,{children:e.jsxs(m,{children:[e.jsx(m.Item,{label:"Rootfs image name",large:!0,value:s.image_name}),s.image_source!==null&&e.jsx(m.Item,{label:"Rootfs image source",large:!0,value:s.image_source,type:"truncated"}),e.jsx(m.Item,{label:"Cloud-init",large:!0,value:s.cloud_init_contents})]})}),e.jsx(C.Item,{title:"Association",children:e.jsx(Ie,{profile:s,children:e.jsxs(m,{children:[e.jsx(m.Item,{label:"Tags",large:!0,value:s.tags.join(", "),type:"truncated"}),e.jsx(m.Item,{label:"Associated parents",large:!0,value:e.jsx(q,{count:s.computers.constrained.length,profile:s,query:`wsl:${s.id}`})}),e.jsx(m.Item,{label:"Not compliant",value:e.jsx(fe,{wslProfile:s,onClick:t("noncompliant")})}),e.jsx(m.Item,{label:"Compliant",value:e.jsx(q,{profile:s,count:s.computers.constrained.length-s.computers["non-compliant"].length,query:`wsl:${s.id}:compliant`})})]})})})]})]}),e.jsx(he,{isOpen:I,close:j,wslProfile:s})]})},qe=()=>G().shape({title:x().required("This field is required"),description:x().required("This field is required"),access_group:x().required("This field is required"),all_computers:B(),tags:O().of(x())}),ke="_block_tz139_1",Le={block:ke},Me=({profile:t})=>{const{getAccessGroupQuery:i}=N(),s=$(),{sidePath:l,popSidePath:u,createPageParamsSetter:g}=w(),{notify:I}=U(),{editWslProfile:P}=_e(),{wslInstanceTypes:j}=z(),y=j.map(({label:n,name:d})=>({label:n,value:d}))||[],f=[{label:"Select",value:""},...y,{label:"From URL",value:"custom"}],{data:S}=i(),h=S?.data.map(({name:n,title:d})=>({label:d,value:n}))??[],a=g({sidePath:[],profile:""}),T=async n=>{try{await P({name:t.name,title:n.title,access_group:n.access_group,description:n.description,all_computers:n.all_computers,tags:n.tags}),a(),I.success({title:"WSL profile updated",message:`WSL profile "${t.title}" updated successfully`})}catch(d){s(d)}},r=D({initialValues:{title:t.title,access_group:t.access_group,description:t.description,instanceType:t.image_source?"custom":t.image_name,customImageName:t.image_source?t.image_name:"",rootfsImage:t.image_source||"",all_computers:t.all_computers,tags:t.tags},onSubmit:T,validationSchema:qe()});return e.jsxs(o.Form,{onSubmit:r.handleSubmit,noValidate:!0,children:[e.jsx(o.Input,{type:"text",label:"Title",required:!0,...r.getFieldProps("title"),error:p(r,"title")}),e.jsx(o.Input,{type:"text",label:"Description",required:!0,...r.getFieldProps("description"),error:p(r,"description")}),e.jsx(o.Select,{label:"Access group","aria-label":"Access group",options:h,required:!0,...r.getFieldProps("access_group"),error:p(r,"access_group")}),e.jsxs("div",{className:Le.block,children:[e.jsx(o.Notification,{severity:"caution",title:"Editing unavailable",children:e.jsx("span",{children:"You cannot edit rootfs image or cloud-init file. To modify these fields, create a new profile."})}),e.jsx(o.Select,{disabled:!0,label:"Rootfs image","aria-label":"Rootfs image",options:f,...r.getFieldProps("instanceType"),error:p(r,"instanceType")}),r.values.instanceType==="custom"&&e.jsxs(e.Fragment,{children:[e.jsx(o.Input,{disabled:!0,label:"Image name",type:"text",required:!0,...r.getFieldProps("customImageName"),error:p(r,"customImageName")}),e.jsx(o.Input,{disabled:!0,type:"text",label:"Rootfs image URL",required:!0,...r.getFieldProps("rootfsImage"),error:p(r,"rootfsImage"),help:"The file path must be reachable by the affected WSL instances."})]}),e.jsx(o.Select,{label:"Cloud-init","aria-label":"Cloud-init",options:Y,disabled:!0})]}),e.jsx(Q,{formik:r}),e.jsx(H,{submitButtonText:"Save changes",submitButtonDisabled:r.isSubmitting,onCancel:a,hasBackButton:l.length>1,onBackButtonPress:u})]})},ht=()=>{const{wslProfile:t,isGettingWslProfile:i}=E();return i?e.jsx(b.LoadingState,{}):e.jsxs(e.Fragment,{children:[e.jsxs(b.Header,{children:['Edit "',t.title,'" profile']}),e.jsx(b.Content,{children:e.jsx(Me,{profile:t})})]})},Ge="_header_513lp_1",Oe="_search_513lp_8",k={header:Ge,search:Oe},Be=({instance:t})=>{const{value:i,setTrue:s,setFalse:l}=A();return e.jsxs(e.Fragment,{children:[e.jsx(te,{destructiveActions:[{icon:"security-tick",label:"Make compliant",onClick:s}],toggleAriaLabel:`${t.title} actions`}),e.jsx(V,{close:l,instances:[t],isOpen:i})]})},$e=t=>({column:i,row:{index:s}})=>i.id==="profiles"&&t===s?{className:"expandedCell"}:{},Ue=t=>({index:i})=>t===i?{className:"expandedRow"}:{},De=({wslProfile:t})=>{const{expandedRowIndex:i,getTableRowsRef:s,handleExpand:l}=se(),[u,g]=F.useState(""),[I]=F.useState(ie),[P]=F.useState(ae),[j,y]=F.useState(""),{instances:f,isGettingInstances:S}=je({query:[j,`profile:wsl:${t.id}:noncompliant`].filter(Boolean).join(" "),limit:P,offset:(I-1)*P,with_wsl_profiles:!0}),{selectedItems:h,setSelectedItems:a}=ye(f,S),{value:T,setTrue:r,setFalse:n}=A(),d=F.useMemo(()=>[{accessor:"title",Header:e.jsxs(e.Fragment,{children:[e.jsx(o.CheckboxInput,{label:e.jsx("span",{className:"u-off-screen",children:"Toggle all instances"}),inline:!0,disabled:!f.length,indeterminate:!!h.length&&h.length<f.length,checked:!!f.length&&h.length===f.length,onChange:({currentTarget:{checked:c}})=>{a(c?f:[])}}),"Instance name"]}),Cell:({row:{original:c}})=>e.jsxs(e.Fragment,{children:[e.jsx(o.CheckboxInput,{inline:!0,label:e.jsxs("span",{className:"u-off-screen",children:["Select ",c.title]}),checked:h.includes(c),onChange:({currentTarget:{checked:_}})=>{a(_?[...h,c]:h.filter(v=>v!==c))}}),e.jsx(ne,{to:oe.instances.details.single(c.id),children:c.title})]})},{Header:"OS",Cell:({row:{original:c}})=>c.distribution_info?.description},{accessor:"profiles",Header:"WSL profiles",Cell:({row:{original:c,index:_}})=>e.jsx(le,{content:c.wsl_profiles?.map(v=>v.title).join(", "),isExpanded:_===i,onExpand:()=>{l(_)}})},{Header:"Last ping",Cell:({row:{original:c}})=>{const _=re(c.last_ping_time);return _.isValid()?e.jsx("span",{className:"font-monospace",children:_.format(ce)}):e.jsx(ue,{})}},{...Pe,Cell:({row:{original:c}})=>e.jsx(Be,{instance:c})}],[f,h,i]),R=()=>{g(""),y("")};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:k.header,children:[e.jsx(o.SearchBox,{className:de("u-no-margin--bottom",k.search),externallyControlled:!0,value:u,onChange:g,onClear:R,onSearch:y,autoComplete:"off"}),e.jsxs(o.Button,{type:"button",className:"u-no-margin",hasIcon:!0,onClick:r,disabled:!h.length,children:[e.jsx(o.Icon,{name:"security-tick"}),e.jsx("span",{children:"Make compliant"})]})]}),e.jsx(pe,{filters:[{label:"Search",item:j||void 0,clear:R}]}),S?e.jsx(me,{}):e.jsx("div",{ref:s,children:e.jsx(ge,{columns:d,data:f,emptyMsg:"No Windows instances found according to your search parameters.",getCellProps:$e(i),getRowProps:Ue(i)})}),e.jsx(V,{close:n,instances:h,isOpen:T})]})},xt=()=>{const{wslProfile:t,isGettingWslProfile:i}=E();return i?e.jsx(b.LoadingState,{}):e.jsxs(e.Fragment,{children:[e.jsxs(b.Header,{children:["Instances not compliant with ",t.title]}),e.jsx(b.Content,{children:e.jsx(De,{wslProfile:t})})]})};export{gt as WslProfileAddSidePanel,ft as WslProfileDetailsSidePanel,ht as WslProfileEditSidePanel,xt as WslProfileNonCompliantInstancesSidePanel,Pt as WslProfilesEmptyState,jt as WslProfilesHeader,yt as WslProfilesList,Se as useAddWslProfile,St as useDeleteWslProfile,_e as useEditWslProfile,Te as useGetWslProfile,_t as useGetWslProfiles,Ft as useMakeWindowsInstancesCompliant,Ct as useReapplyWslProfile};
