import{l as d,j as i,F as j,d as P,J as A}from"./index-Y1sHRQPW.js";import{S as I,E as S}from"./SelectAllButton-ocsw-Ogb.js";import{a as B}from"./useUsns-CHU4IE48.js";import"./ExpandableTableFooter-B1Ux1Gkh.js";import"./constants-Co65QhYz.js";const E="_hidden_vofak_1",H={hidden:E},q=({lastPackageIndex:e,loading:t,showToggle:r})=>({column:l,row:{index:o}})=>{const n={};return(r&&o===0||t&&o===e)&&(l.id==="checkbox"?n.colSpan=5:(n.className=H.hidden,n["aria-hidden"]=!0)),n},z=(e,t,r)=>[...e.slice(t?-1:e.length),...e,...e.slice(r?-1:e.length)],M=(e,t)=>{const r=new Set(e),l=t.filter(({id:o})=>!r.has(o)).length;return l===0?"unchecked":l===t.length?"checked":"indeterminate"},v=({excludedPackages:e,instance:t,onExcludedPackagesChange:r,onLimitChange:l,packages:o,packagesCount:n,packagesLoading:g})=>{const m=e.find(({id:s})=>s===t.id)?.exclude_packages??[],f=d.useMemo(()=>{const s=new Set(o.map(({id:a})=>a));return m.length>0&&m.some(a=>!s.has(a))},[m.length,o]),h=d.useMemo(()=>z(o,f,g),[o,f,g]),b=()=>{const s=o.map(({id:a})=>a);r(e.map(({id:a,exclude_packages:u})=>a!==t.id?{id:a,exclude_packages:u}:{id:a,exclude_packages:u.length<s.length?s:[]}))},k=s=>{r(e.map(({id:a,exclude_packages:u})=>a!==t.id?{id:a,exclude_packages:u}:{id:a,exclude_packages:u.includes(s)?u.filter(C=>C!==s):[...u,s]}))},x=M(m,o),N=d.useMemo(()=>[{accessor:"checkbox",className:"checkbox-column",Header:i.jsx(P.CheckboxInput,{inline:!0,label:i.jsx("span",{className:"u-off-screen",children:"Toggle all packages"}),disabled:h.length===0,checked:x==="checked",indeterminate:x==="indeterminate",onChange:b}),Cell:({row:{index:s,original:a}})=>g&&s===h.length-1?i.jsx(j,{}):s===0&&f?i.jsx(I,{count:n-m.length,itemName:{plural:"packages",singular:"package"},onClick:()=>{r(e.map(({id:u,exclude_packages:C})=>({id:u,exclude_packages:u!==t.id?C:[]})))},totalCount:n}):i.jsx(P.CheckboxInput,{inline:!0,label:i.jsxs("span",{className:"u-off-screen",children:["Toggle ",a.name," package"]}),checked:!m.includes(a.id),onChange:()=>{k(a.id)}})},{accessor:"name",Header:"Name"},{accessor:"current_version",Header:"Current version"},{accessor:"available_version",Header:"New version"},{accessor:"summary",Header:"Details"}],[h.length,g,m.length]);return g&&!o.length?i.jsx(j,{}):i.jsx(S,{columns:N,data:h,itemCount:o.length,itemNames:{plural:"packages",singular:"package"},onLimitChange:l,totalCount:n,title:i.jsxs("p",{className:"p-heading--4",children:["Packages affected on ",i.jsx("b",{children:t.title})]}),getCellProps:q({lastPackageIndex:h.length-1,loading:g,showToggle:f})})},D="_nameColumn_zpxqd_7",R="_expanded_zpxqd_11",y="_expandButton_zpxqd_29",L="_hidden_zpxqd_38",$="_innerTable_zpxqd_42",F="_row_zpxqd_46",_={nameColumn:D,expanded:R,expandButton:y,hidden:L,innerTable:$,row:F},J=e=>({column:t,row:{index:r}})=>{const l={};return e>-1&&e===r-1?t.id==="title"?(l.colSpan=2,e>-1&&e===r-1&&(l.className=_.innerTable)):(l.className=_.hidden,l["aria-hidden"]=!0):t.id==="title"?l.role="rowheader":t.id==="upgrades"&&(l["aria-label"]="Affected packages",l.className=e===r?_.expanded:_.row),l},V=({excludedPackages:e,instances:t,onExcludedPackagesChange:r})=>{const[l,o]=d.useState(5),[n,g]=d.useState(-1),[m,f]=d.useState([]),[h,b]=d.useState(0),k=d.useRef(0),x=d.useRef(-1),{getInstancePackagesQuery:N}=B(),{data:s,isLoading:a}=N({instance_id:t[n]?.id,limit:5,offset:h,upgrade:!0},{enabled:n>-1});d.useEffect(()=>{s&&(k.current=s.data.count,h!==x.current?(x.current=h,f(c=>[...c,...s.data.results])):(x.current=h,f(c=>[...c.slice(0,-1*s.data.results.length),...s.data.results])))},[s]);const u=c=>{b(0),f([]),g(p=>p===c?-1:p>-1&&p<c?c-1:c)},C=d.useMemo(()=>n>-1?[...t.slice(0,n+1),...t.slice(n,l)]:t.slice(0,l),[t,l,n]),w=d.useMemo(()=>[{accessor:"title",className:_.nameColumn,Header:"Name",Cell:({row:{index:c,original:p}})=>n===-1||c!==n+1?p.title:i.jsx(v,{excludedPackages:e,instance:p,onExcludedPackagesChange:r,onLimitChange:()=>b(T=>T+5),packages:m,packagesCount:k.current,packagesLoading:a})},{accessor:"upgrades",Header:"Affected packages",Cell:({row:{index:c,original:p}})=>i.jsx(P.Button,{type:"button",className:A("p-accordion__tab",_.expandButton),"aria-expanded":n===c,onClick:()=>u(c),children:null})}],[e,n,a,m,C.length]);return i.jsx(S,{columns:w,data:C,getCellProps:J(n),itemNames:{plural:"instances",singular:"instance"},onLimitChange:()=>o(c=>c+5),totalCount:t.length})};export{V as default};
