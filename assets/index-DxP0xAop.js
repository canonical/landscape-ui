import{B as C,F as n,K as y,C as A,G as P,v as u,y as N,z as O,l as $,J as R,j as t,m as i,a7 as f}from"./index-CTElUWT8.js";import{M as S}from"./MultiSelectField-C38mD8NI.js";import{S as k}from"./SidePanelFormButtons-CYT4_L0-.js";import{u as V}from"./useInstances-DAWYsyRJ.js";import{u as E,D as w}from"./DeliveryBlock-Psc-XpIQ.js";import{b as B}from"./helpers-O_hCTU4S.js";import{u as D}from"./useRoles-DZQyhFA2.js";import"./InstancesPageActions-CPs_Z2IQ.js";import{g as m}from"./formikErrors-Bw8iTXYS.js";import"./SidePanelFormButtons.module-D2P5PizG.js";const G={access_group:"",deliver_after:"",deliverImmediately:!0,instanceIds:[],queryType:"tags",tags:[],username:"root",time_limit:300},L=C().shape({access_group:n(),deliverImmediately:A().required("This field is required."),deliver_after:n().when("deliverImmediately",{is:!1,then:r=>r.required("This field is required").test({test:o=>u(o).isValid()&&u(o).isAfter(u()),message:"You have to enter a valid date and time in the future"})}),instanceIds:y().of(P()).when("queryType",{is:"ids",then:r=>r.min(1,"At least one instance is required.")}),queryType:n().required("This field is required."),tags:y().of(n()).when("queryType",{is:"tags",then:r=>r.min(1,"At least one tag is required.")}),username:n().required("This field is required.")}),U="_instanceSelectionContainer_16uxl_1",z={instanceSelectionContainer:U},te=({script:r})=>{const o=N(),{notify:h}=O(),{closeSidePanel:I}=$(),{getAllInstanceTagsQuery:b,getInstancesQuery:q}=V(),{getAccessGroupQuery:v}=D(),{data:l,isLoading:x}=v(),_=((l==null?void 0:l.data)??[]).map(e=>({label:e.title,value:e.name})),T=[{label:"Select access group",value:""},..._],{runScript:j}=E(),s=R({initialValues:G,onSubmit:async e=>{const a={query:e.queryType==="ids"?`id:${e.instanceIds.join(" OR id:")}`:`tag:${e.tags.join(" OR tag:")}`,script_id:r.id,username:e.username,time_limit:Number(e.time_limit),in_access_group:e.access_group,deliver_after:e.deliverImmediately?void 0:f(e.deliver_after).toISOString().replace(/\.\d+(?=Z$)/,"")};e.deliverImmediately||(a.deliver_after=f(e.deliver_after).toISOString().replace(/\.\d+(?=Z$)/,""));try{await j(a),I(),h.success({message:`"${r.title}" script queued to execute successfully`,title:"Script execution queued"})}catch(F){o(F)}},validationSchema:L}),{data:d}=b(),p=(d==null?void 0:d.data.results.map(e=>({label:e,value:e})))??[],{data:c}=q(),g=(c==null?void 0:c.data.results.filter(e=>B("runScripts",e)).map(({title:e,id:a})=>({label:e,value:a})))??[];return t.jsxs(i.Form,{onSubmit:s.handleSubmit,noValidate:!0,children:[t.jsx("p",{className:"u-no-margin--bottom",children:"Select instances by:"}),t.jsx("div",{className:"is-required",children:t.jsxs("div",{children:[t.jsx(i.Input,{type:"radio",label:"Tags",...s.getFieldProps("queryType"),value:"tags",checked:s.values.queryType==="tags"}),t.jsx(i.Input,{type:"radio",label:"Instance names",...s.getFieldProps("queryType"),value:"ids",checked:s.values.queryType==="ids"}),t.jsxs("div",{className:z.instanceSelectionContainer,children:[s.values.queryType==="tags"&&t.jsx(S,{placeholder:"Select tags",variant:"condensed",label:"Tags",labelClassName:"u-off-screen",required:!0,...s.getFieldProps("tags"),items:p,selectedItems:p.filter(({value:e})=>s.values.tags.includes(e)),onItemsUpdate:async e=>s.setFieldValue("tags",e.map(({value:a})=>a)),error:s.touched.tags&&typeof s.errors.tags=="string"?s.errors.tags:void 0}),s.values.queryType==="ids"&&t.jsx(S,{placeholder:"Select instances",variant:"condensed",label:"Instances",labelClassName:"u-off-screen",required:!0,...s.getFieldProps("instanceIds"),items:g,selectedItems:g.filter(({value:e})=>s.values.instanceIds.includes(e)),onItemsUpdate:async e=>s.setFieldValue("instanceIds",e.map(({value:a})=>a)),error:s.touched.instanceIds&&typeof s.errors.instanceIds=="string"?s.errors.instanceIds:void 0})]})]})}),t.jsx(i.Select,{label:"Access group",disabled:x,options:T,error:m(s,"access_group"),...s.getFieldProps("parent")}),t.jsxs(i.Row,{className:"u-no-padding--left u-no-padding--right",children:[t.jsx(i.Col,{size:6,children:t.jsx(i.Input,{type:"text",label:"Run as user",autoComplete:"off",required:!0,...s.getFieldProps("username"),error:m(s,"username")})}),t.jsx(i.Col,{size:6,children:t.jsx(i.Input,{type:"text",label:"Time limit (seconds)",autoComplete:"off",required:!0,...s.getFieldProps("time_limit"),error:m(s,"time_limit")})})]}),t.jsx(w,{formik:s}),t.jsx(k,{submitButtonDisabled:s.isSubmitting,submitButtonText:"Run script"})]})};export{te as default};
