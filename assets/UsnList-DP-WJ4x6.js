import{r as b,j as a,a as B,q as H,s as R,p as P,d as k,R as E,o as v,M,D as $,c as C}from"./index-bwXOAcKK.js";import{m as N}from"./moment-MRI66HFk.js";import{E as w,S as D}from"./SelectAllButton-BOxBaDek.js";import{N as L}from"./NoData-DpInLn0M.js";import{T as S}from"./TablePagination-Dw6MtsuZ.js";import{T as F}from"./TruncatedCell-Z8nCtKmG.js";import{u as O}from"./usePageParams-TpNL_kGt.js";import{u as I}from"./useUsns-D5-sQRN5.js";import{g as V,c as j,a as q,h as _,b as T}from"./helpers-B4Ea794_.js";const Q=({column:c})=>{const s={};return c.id==="title"?s.role="rowheader":c.id==="upgrades.security"&&(s["aria-label"]="Affected packages"),s},Y="_security_16o7z_1",z={security:Y},W=({instances:c,limit:s,onLimitChange:m,usn:l,usnPackages:i})=>{const n=b.useMemo(()=>c.filter(({id:e})=>i.flatMap(({computer_ids:g})=>g).includes(e)).slice(0,s),[c,s,i]),o=b.useMemo(()=>[{accessor:"title",Header:"Name"},{accessor:"upgrades.security",className:z.security,Header:"Affected packages",Cell:({row:{original:e}})=>i.filter(({computer_ids:g})=>g.includes(e.id)).length}],[n.length]);return a.jsx(w,{columns:o,data:n,itemNames:{plural:"instances",singular:"instance"},onLimitChange:m,totalCount:n.length,title:a.jsxs("p",{className:"p-heading--4",children:["Instances affected by ",a.jsx("b",{children:l})]}),getCellProps:Q})},G=({instanceTitle:c,usn:s})=>{const m=B(),l=H(),{notify:i}=R(),{removeUsnPackagesQuery:n}=I(),{setPageParams:o}=O(),{instanceId:e,childInstanceId:g}=P(),p=Number(e),{mutateAsync:h,isPending:u}=n,f=()=>{m(`${E}instances/${g?`${p}/${g}`:`${p}`}`),o({tab:"activities"}),i.clear()},y=async()=>{try{await h({usns:s,instanceId:p}),i.success({title:"You queued packages to be uninstalled",message:`Packages affected by "${s}" security issue will be uninstalled and are queued in Activities.`,actions:[{label:"View details",onClick:f}]})}catch(x){l(x)}};return a.jsxs(k.ConfirmationButton,{type:"button",className:"is-small is-dense has-icon",confirmationModalProps:{title:"Uninstall USN packages",children:a.jsxs("p",{children:['This will uninstall packages affected by "',s,'" security issue from the "',c,'" instance.']}),confirmButtonLabel:"Uninstall",confirmButtonAppearance:"negative",confirmButtonDisabled:u,confirmButtonLoading:u,onConfirm:y},children:[a.jsx(k.Icon,{name:"delete",className:"u-no-margin--left"}),a.jsx("span",{children:"Uninstall packages"})]},"remove")},J=({column:c})=>{const s={};return c.id==="name"?s.role="rowheader":c.id==="current_version"?s["aria-label"]="Current version":c.id==="new_version"?s["aria-label"]="New version":c.id==="summary"&&(s["aria-label"]="Details"),s},K=({instanceTitle:c,limit:s,onLimitChange:m,showRemoveButton:l,usn:i,usnPackages:n})=>{const o=b.useMemo(()=>n.slice(0,s),[s,n]),e=b.useMemo(()=>[{accessor:"name",Header:"Package"},{accessor:"current_version",Header:"Current version"},{accessor:"new_version",Header:"New version"},{accessor:"summary",Header:"Details"}],[o.length]);return a.jsx(w,{additionalCta:l&&a.jsx(G,{instanceTitle:c,usn:i}),columns:e,data:o,itemNames:{plural:"packages",singular:"package"},onLimitChange:m,title:a.jsxs("p",{className:"p-heading--4",children:["Packages affected by ",a.jsx("b",{children:i})]}),totalCount:n.length,getCellProps:J})},X=({instances:c,isRemovable:s,listType:m,usn:l})=>{const[i,n]=b.useState(5),{getAffectedPackagesQuery:o}=I(),{instanceId:e}=P(),g=Number(e),{data:p,isLoading:h}=o({usn:l,computer_ids:s?[g]:c.map(({id:f})=>f)}),u=(p==null?void 0:p.data)??[];return a.jsxs(a.Fragment,{children:[h&&a.jsx(v,{}),!h&&m==="instances"&&a.jsx(W,{instances:c,limit:i,onLimitChange:()=>n(f=>f+5),usn:l,usnPackages:u}),!h&&m==="packages"&&a.jsx(K,{instanceTitle:c[0].title,limit:i,onLimitChange:()=>n(f=>f+5),showRemoveButton:s,usn:l,usnPackages:u})]})},oe=({instances:c,isUsnsLoading:s,onSelectedUsnsChange:m,selectedUsns:l,totalUsnCount:i,usns:n,...o})=>{const[e,g]=b.useState(null),p=b.useRef([]);M({current:(e==null?void 0:e.column)==="cves"?p.current[e.row]:null},()=>g(null));const h=o.tableType==="expandable"&&o.showSelectAllButton,u=b.useMemo(()=>V({expandedCell:e,isUsnsLoading:s,showSelectAllButton:h,usns:n}),[n,e,s,h]),f=t=>{m(l.includes(t)?l.filter(r=>r!==t):[...l,t])},y=(t,r)=>{g(d=>(d==null?void 0:d.column)===t&&d.row===r?null:{column:t,row:d&&["computers_count","release_packages"].includes(d.column)&&d.row<r?r-1:r})},x=b.useMemo(()=>[{accessor:"checkbox",className:"checkbox-column",Header:()=>a.jsx(k.CheckboxInput,{inline:!0,label:a.jsx("span",{className:"u-off-screen",children:"Toggle all security issues"}),disabled:u.length===0||s,indeterminate:l.length>0&&l.length<n.length,checked:l.length>0&&l.length===n.length,onChange:()=>m(l.length>0?[]:n.map(({usn:t})=>t))}),Cell:({row:{original:t}})=>a.jsx(k.CheckboxInput,{labelClassName:"u-no-margin--bottom u-no-padding--top",label:a.jsx("span",{className:"u-off-screen",children:`Toggle ${t.usn}`}),disabled:s,name:"usn",checked:l.includes(t.usn),onChange:()=>f(t.usn)})},{accessor:"usn",Header:"USN",Cell:({row:{index:t,original:r}})=>t===0&&h?a.jsx(D,{count:o.totalSelectedUsnCount,itemName:{plural:"security issues",singular:"security issue"},onClick:o.onSelectAllClick,totalCount:i}):(e==null?void 0:e.row)===t-1&&["computers_count","release_packages"].includes(e.column)?a.jsx(X,{isRemovable:e.column==="release_packages"&&o.tableType==="paginated",instances:c,listType:e.column==="release_packages"?"packages":"instances",usn:u[e.row].usn}):s&&t===u.length-1?a.jsx(v,{}):a.jsx("a",{href:r.usn_link,target:"_blank",rel:"nofollow noopener noreferrer",children:r.usn})},{accessor:"cves",Header:"CVE(s)",Cell:({row:{original:t,index:r}})=>a.jsx(F,{content:t.cves.map(({cve:d,cve_link:A})=>a.jsx("span",{className:j.cve,children:a.jsx("a",{href:A,target:"_blank",rel:"nofollow noopener noreferrer",className:j.cveLink,children:d})},d)),isExpanded:(e==null?void 0:e.column)==="cves"&&e.row===r,onExpand:()=>y("cves",r)})},{accessor:"date",Header:"Date published",Cell:({row:t})=>a.jsx(a.Fragment,{children:N(t.original.date).isValid()?N(t.original.date).format($):a.jsx(L,{})})},{accessor:"computers_count",Header:"Affected instances",Cell:({column:t,row:{index:r,original:d}})=>a.jsx(k.Button,{type:"button",className:C("p-accordion__tab",j.expandButton),"aria-expanded":(e==null?void 0:e.column)===t.id&&e.row===r,onClick:()=>y(t.id,r),children:d.computers_count})},{accessor:"release_packages",Header:"Affected packages",Cell:({column:t,row:{index:r}})=>a.jsx(k.Button,{type:"button",className:C("p-accordion__tab",j.expandButton),"aria-expanded":(e==null?void 0:e.column)===t.id&&e.row===r,onClick:()=>y(t.id,r),children:`${(e==null?void 0:e.column)===t.id&&e.row===r?"Hide":"Show"} packages`})}].filter(({accessor:t})=>o.tableType==="paginated"?t!=="computers_count":t!=="date"),[u,s,l.length,o.tableType,e]);return a.jsx("div",{ref:q(p),children:o.tableType==="expandable"?a.jsx(w,{columns:x,data:u,getCellProps:_({expandedCell:e,isUsnsLoading:s,lastUsnIndex:u.length-1,showSelectAllButton:h}),getRowProps:T(e),itemCount:n.length,itemNames:{plural:"security issues",singular:"security issue"},onLimitChange:o.onNextPageFetch,totalCount:i}):a.jsxs(a.Fragment,{children:[a.jsx(k.ModularTable,{columns:x,data:u,getCellProps:_({expandedCell:e,isUsnsLoading:s}),getRowProps:T(e),emptyMsg:`No security issues found with the search "${o.search}"`}),n.length>0&&a.jsx(S,{handleClearSelection:()=>m([]),totalItems:i,currentItemCount:n.length})]})})};export{oe as U};
