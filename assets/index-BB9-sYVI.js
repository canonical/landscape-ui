import{j as r,o as _,G,Q as f,H as I,J as o,p as O,n as A,s as R,d as n,t as a}from"./index-Bcke6Ud3.js";import{C as S}from"./CheckboxGroup-DwfWcQ1R.js";import{a as V,u as U,F as M}from"./debug-dEHYMw0h.js";import{M as D}from"./MultiSelectField-_GapqmSa.js";import{S as L}from"./SidePanelFormButtons-tjUR1Fah.js";import{U as $}from"./UdebCheckboxInput-wsfF7D26.js";import{e as T,P as C,g as q,M as w,f as K,C as B,A as H}from"./constants-ClgNyJcB.js";import{t as E}from"./tests-DFnZqbNV.js";import"./useGPGKeys-DlhKtpkM.js";import"./SidePanelFormButtons.module-BuIu-Bem.js";const Q=({groupedOptions:t,group:l,option:p,onChange:c,error:u,emptyOption:m,name:h,label:b="",id:k,onBlur:g,className:e,labelClassName:x,wrapperClassName:P,hidden:F,disabled:i,required:s})=>{const y=k??h.replace(/[_\s]/g,"-").replace(/([a-z])(?=[A-Z])/,"$1-").replace(/([A-Z])(?=[a-z])/,"-$1").toLowerCase();return r.jsxs("div",{className:_("p-form-validation",P,{"is-error":!!u}),children:[b&&r.jsx("label",{className:_("p-form__label",x,{"is-required":s}),htmlFor:y,children:b}),r.jsxs("div",{className:"p-form__control u-clearfix",children:[r.jsx("div",{className:"p-form-validation__select-wrapper",children:r.jsxs("select",{id:y,value:p===""?"":`${l}/${p}`,name:h,className:_("p-form-validation__input",e),onChange:d=>{c(d.target[d.target.selectedIndex].dataset.value??"",d.target[d.target.selectedIndex].dataset.group??"")},onBlur:g,disabled:i,hidden:F,"aria-invalid":!!u,"aria-errormessage":u?"pull-pocket-validation-message":void 0,children:[m&&m.enabled&&r.jsx("option",{value:"","data-group":"","data-value":"",children:m.label??""}),t.map(({optGroup:d,options:N})=>r.jsx("optgroup",{label:d,children:N.map(({value:j,label:v})=>r.jsx("option",{value:`${d}/${j}`,"data-group":d,"data-value":j,children:v},j))},d))]})}),!!u&&r.jsxs("p",{className:"p-form-validation__message",id:"pull-pocket-validation-message",children:[r.jsx("strong",{children:"Error:"})," ",u]})]})]})},z=[{label:"Mirror",value:"mirror"},{label:"Pull",value:"pull"},{label:"Upload",value:"upload"}],Z={type:"ubuntu",series:"",distribution:"",name:"",architectures:q.ubuntu,components:C.ubuntu,gpg_key:"",include_udeb:!1,filter_type:"",mode:"mirror",pull_pocket:"",pull_series:"",mirror_uri:T,upload_allow_unsigned:!1,mirror_suite:"",mirror_gpg_key:"",filter_packages:[],upload_gpg_keys:[]},J=[{label:"Select filter type",value:""},{label:"Allow list",value:"whitelist"},{label:"Disallow list",value:"blacklist"}],W=t=>{switch(t.mode){case"mirror":return{mode:t.mode,distribution:t.distribution,series:t.series,name:t.name,architectures:t.architectures,components:t.components,gpg_key:t.gpg_key,include_udeb:t.include_udeb,mirror_uri:t.mirror_uri,mirror_suite:t.mirror_suite,mirror_gpg_key:t.mirror_gpg_key};case"upload":return{mode:t.mode,distribution:t.distribution,series:t.series,name:t.name,architectures:t.architectures,components:t.components,gpg_key:t.gpg_key,include_udeb:t.include_udeb,upload_allow_unsigned:t.upload_allow_unsigned};case"pull":return{mode:t.mode,distribution:t.distribution,series:t.series,name:t.name,architectures:t.architectures,components:t.components,gpg_key:t.gpg_key,include_udeb:t.include_udeb,pull_series:t.pull_series,pull_pocket:t.pull_pocket,filter_type:t.filter_type!==""?t.filter_type:void 0,filter_packages:t.filter_packages};default:return V(t.mode,"pocket mode")}},X=t=>G().shape({type:o().required("This field is required."),name:o().required("This field is required").test({test:E.test,message:E.message}).test({params:{series:t},test:l=>!t.pockets.map(({name:p})=>p).includes(l),message:"It must be unique within series."}),distribution:o().required("This field is required"),series:o().required("This field is required"),components:f().defined().of(o().defined()).min(w,"Please choose at least one component").test({name:"flat-mirror-sub-directory",message:"A single component must be passed",test:(l,p)=>{const{mode:c,mirror_suite:u}=p.parent;return c==="mirror"&&u?.endsWith("/")?w===l.length:!0}}).required("This field is required"),architectures:f().defined().of(o().defined()).min(w,"Please choose at least one architecture"),mode:o().required("This field is required"),gpg_key:o().required("This field is required"),include_udeb:I().required("This field is required"),mirror_uri:o().when("mode",{is:"mirror",then:l=>l.required("This field is required")}),mirror_suite:o(),mirror_gpg_key:o(),pull_pocket:o().when("mode",{is:"pull",then:l=>l.required("This field is required")}),pull_series:o(),filter_type:o(),filter_packages:f().of(o().defined()),upload_allow_unsigned:I(),upload_gpg_keys:f().of(o().defined())}),Y=(t,l)=>({...Z,distribution:t,series:l}),de=({distribution:t,series:l})=>{const p=O(),{closeSidePanel:c}=A(),{createPocketQuery:u,addUploaderGPGKeysToPocketQuery:m}=K(),{mutateAsync:h}=u,{mutateAsync:b}=m,{privateGPGKeysOptions:k,publicGPGKeysOptions:g}=U(),e=R({initialValues:Y(t.name,l.name),validationSchema:X(l),onSubmit:async i=>{try{await h(W(i)),i.mode==="upload"&&!i.upload_allow_unsigned&&i.upload_gpg_keys.length&&await b({name:i.name,series:i.series,distribution:i.distribution,gpg_keys:i.upload_gpg_keys}),c()}catch(s){p(s)}}}),x=i=>{const s=i.target.value,y=s==="ubuntu"?{type:s,components:C.ubuntu,architectures:q.ubuntu,mirror_uri:e.values.mode==="mirror"?T:""}:{type:s,components:C.thirdParty,architectures:q.thirdParty,mirror_uri:e.values.mode==="mirror"?"":void 0};e.setValues({...e.values,...y})},P=i=>{const s=i.target.value;s==="mirror"&&e.values.type==="ubuntu"?e.setFieldValue("mirror_uri",T):e.setFieldValue("mirror_uri",""),e.setFieldValue("mode",s)},F=t.series.map(i=>({options:i.pockets.map(({name:s})=>({label:s,value:s})),optGroup:i.name}));return r.jsxs(n.Form,{onSubmit:e.handleSubmit,noValidate:!0,children:[r.jsx(n.Select,{label:"Type",required:!0,options:[{label:"Ubuntu",value:"ubuntu"},{label:"Third party",value:"third-party"}],...e.getFieldProps("type"),onChange:x,error:a(e,"type")}),r.jsx(n.Select,{label:"Mode",required:!0,options:z,...e.getFieldProps("mode"),onChange:P,error:a(e,"mode")}),e.values.mode==="mirror"&&r.jsx(n.Input,{type:"text",label:"Mirror URI",required:!0,...e.getFieldProps("mirror_uri"),error:a(e,"mirror_uri")}),r.jsxs("div",{className:_({row:e.values.mode==="pull","u-no-padding--left":e.values.mode==="pull","u-no-padding--right":e.values.mode==="pull"}),children:[r.jsx(n.Input,{type:"text",label:"Name",required:!0,wrapperClassName:_({"col-6":e.values.mode==="pull"}),style:{display:"block !important"},...e.getFieldProps("name"),error:a(e,"name")}),e.values.mode=="pull"&&r.jsx(Q,{label:"Pull from",required:!0,name:"pull_pocket",wrapperClassName:"col-6",groupedOptions:F,option:e.values.pull_pocket,group:e.values.pull_series,emptyOption:{enabled:!0,label:"Select pull pocket"},onChange:async(i,s)=>{await e.setFieldValue("pull_pocket",i),await e.setFieldValue("pull_series",s)},onBlur:e.handleBlur,error:a(e,"pull_pocket")})]}),r.jsx(n.Select,{label:"GPG Key",required:!0,options:[{label:"Select GPG key",value:""},...k],...e.getFieldProps("gpg_key"),error:a(e,"gpg_key")}),e.values.mode==="mirror"&&r.jsxs(r.Fragment,{children:[r.jsx(n.Input,{type:"text",label:r.jsx(M,{label:"Mirror suite",description:r.jsxs(r.Fragment,{children:[r.jsx("span",{children:"The specific sub-directory under dists/ that should be mirrored. If the suite name ends with a ‘/’, the remote repository is flat (no dists/ structure, see "}),r.jsx("a",{href:"http://wiki.debian.org/RepositoryFormat#Flat_Repository_Format",target:"_blank",rel:"nofollow noopener noreferrer",children:"wiki.debian.org/RepositoryFormat#Flat_Repository_Format"}),r.jsx("span",{children:"); in this case a single value must be passed for the ‘components’ parameter. Packages from the remote repository will be mirrored in the specified component. This parameter is optional and defaults to the same name as local series and pocket."})]})}),...e.getFieldProps("mirror_suite"),error:a(e,"mirror_suite")}),r.jsx(n.Select,{label:"Mirror GPG key",options:[{label:"Select GPG key",value:""},...g],...e.getFieldProps("mirror_gpg_key"),error:a(e,"mirror_gpg_key"),help:"If none is given, the stock Ubuntu archive one will be used."})]}),e.values.mode==="pull"&&r.jsxs(r.Fragment,{children:[r.jsx(n.Select,{label:"Filter type",options:J,...e.getFieldProps("filter_type"),error:a(e,"filter_type")}),e.values.filter_type!==""&&r.jsx(n.Textarea,{label:"Filter packages",rows:3,help:"List packages to filter separated by commas.",...e.getFieldProps("filter_packages"),onChange:i=>{e.setFieldValue("filter_packages",i.target.value.replace(/\s/g,"").split(","))},value:e.values.filter_packages.join(","),error:a(e,"filter_packages")})]}),e.values.mode==="upload"&&r.jsxs(r.Fragment,{children:[r.jsx(n.CheckboxInput,{label:"Allow uploaded packages to be unsigned",...e.getFieldProps("upload_allow_unsigned"),checked:e.values.upload_allow_unsigned}),r.jsx(D,{variant:"condensed",label:"Uploader GPG keys",disabled:e.values.upload_allow_unsigned,items:g,selectedItems:g.filter(({value:i})=>e.values.upload_gpg_keys.includes(i)),onItemsUpdate:i=>{e.setFieldValue("upload_gpg_keys",i.map(({value:s})=>s))},error:a(e,"upload_gpg_keys")})]}),e.values.type==="ubuntu"&&r.jsxs(r.Fragment,{children:[r.jsx(S,{label:"Components",required:!0,options:B,...e.getFieldProps("components"),onChange:i=>{e.setFieldValue("components",i)},error:a(e,"components")}),r.jsx(S,{label:"Architectures",required:!0,options:H,...e.getFieldProps("architectures"),onChange:i=>{e.setFieldValue("architectures",i)},error:a(e,"architectures")})]}),e.values.type==="third-party"&&r.jsxs(r.Fragment,{children:[r.jsx(n.Input,{type:"text",label:"Components",required:!0,...e.getFieldProps("components"),value:e.values.components.join(","),onChange:i=>{e.setFieldValue("components",i.target.value.replace(/\s/g,"").split(","))},error:a(e,"components")}),r.jsx(n.Input,{type:"text",label:"Architectures",required:!0,...e.getFieldProps("architectures"),value:e.values.architectures.join(","),onChange:i=>{e.setFieldValue("architectures",i.target.value.replace(/\s/g,"").split(","))},error:a(e,"architectures")})]}),r.jsx($,{formik:e}),r.jsx(L,{submitButtonDisabled:e.isSubmitting,submitButtonText:"Add pocket",submitButtonAriaLabel:"Add pocket"})]})};export{de as default};
