import{j as e,d as o,V as y,ag as B,H as O,o as f,W as A,av as P,I as D,J as R,b2 as H,b3 as L,z as V,B as k,w,C as z,F as N,am as _,s as Q,f as Y,G as X,Z as W,x as T,a4 as J,Y as v,Q as p,aY as K,aa as Z}from"./index-BniO5lih.js";import{A as ee}from"./AssociationBlock-Zj-_6Rr_.js";import{S as te}from"./SidePanelFormButtons-bG-J2X_B.js";import{u as E}from"./useRoles-DRKlPdx8.js";import{u as ae,U as re}from"./index-N8QioU8C.js";import{a as ke,b as ze,c as Qe}from"./index-N8QioU8C.js";import{M as se}from"./MultiSelectField-CyRN2UEo.js";import{R as ie}from"./RandomizationBlock-cuENj1Cm.js";import{P as oe}from"./ProfileAssociationInfo-C914mW5E.js";import"./useGetTags-CPW6gZD2.js";import"./SidePanelFormButtons.module-CcPyiogC.js";import"./PageMain-DMSiaUeu.js";import"./constants-HWGNn3R9.js";import"./constants-n-s_Ig12.js";import"./table-CdFwMAPu.js";import"./HeaderWithSearch-S6PnmELF.js";import"./RadioGroup-RQ17m8oI.js";const I=[{label:"Sunday",order:0,value:"su"},{label:"Monday",order:1,value:"mo"},{label:"Tuesday",order:2,value:"tu"},{label:"Wednesday",order:3,value:"we"},{label:"Thursday",order:4,value:"th"},{label:"Friday",order:5,value:"fr"},{label:"Saturday",order:6,value:"sa"}],ne=`If Landscape cannot upgrade the
associated instances by this point,
the upgrade will be canceled.`,le="_container_x7xq2_1",de="_radioGroup_x7xq2_7",ue="_timeContainer_x7xq2_13",ce="_time_x7xq2_13",pe="_timeInput_x7xq2_27",me="_inputDescriptionAfter_x7xq2_32",ge="_inputDescriptionBefore_x7xq2_37",_e="_colon_x7xq2_42",he="_tooltip_x7xq2_48",xe="_expiration_x7xq2_52",d={container:le,radioGroup:de,timeContainer:ue,time:ce,timeInput:pe,inputDescriptionAfter:me,inputDescriptionBefore:ge,colon:_e,tooltip:he,expiration:xe},fe=({formik:t})=>{const a=[t.touched.at_hour&&t.errors.at_hour||void 0,t.touched.at_minute&&t.errors.at_minute||void 0,t.touched.deliver_within&&t.errors.deliver_within||void 0];return e.jsxs("div",{className:d.container,children:[e.jsx("p",{className:"p-heading--5",children:"Schedule"}),e.jsx(se,{variant:"condensed",label:"Days",items:I,selectedItems:I.filter(({value:r})=>t.values.on_days.includes(r)),onItemsUpdate:r=>t.setFieldValue("on_days",r.map(({value:l})=>l)),isSortedAlphabetically:!1,hasSelectedItemsFirst:!1,error:t.touched.on_days&&typeof t.errors.on_days=="string"?t.errors.on_days:void 0}),e.jsxs("div",{className:d.radioGroup,children:[e.jsx(o.RadioInput,{label:"At a specific time",...t.getFieldProps("every"),checked:t.values.every==="week",onChange:()=>t.setFieldValue("every","week")}),e.jsx(o.RadioInput,{label:"Hourly",...t.getFieldProps("every"),checked:t.values.every==="hour",onChange:()=>t.setFieldValue("every","hour")})]}),e.jsxs("div",{className:d.timeContainer,children:[e.jsxs("div",{className:d.time,children:[t.values.every==="week"&&e.jsxs(e.Fragment,{children:[e.jsx(o.Input,{type:"number",label:"Time","aria-label":"at hour",placeholder:"HH",className:d.timeInput,wrapperClassName:y({"is-error":a[0]}),...t.getFieldProps("at_hour"),"aria-errormessage":a[0]?"hour-error":void 0}),e.jsx("span",{className:d.colon,children:":"})]}),t.values.every==="hour"&&e.jsx("span",{className:d.inputDescriptionBefore,children:"at"}),e.jsx(o.Input,{type:"number",label:"At minute",labelClassName:"u-off-screen","aria-label":"at minute",className:d.timeInput,wrapperClassName:y({"is-error":a[1]}),placeholder:"MM",...t.getFieldProps("at_minute"),"aria-errormessage":a[1]?"minute-error":void 0}),t.values.every==="hour"&&e.jsx("span",{className:d.inputDescriptionAfter,children:"minute"}),e.jsx(o.Input,{type:"number",label:e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"Expires after "}),e.jsx(o.Tooltip,{message:ne,position:"top-right",tooltipClassName:d.tooltip,children:e.jsx(o.Icon,{name:"help"})})]}),wrapperClassName:y(d.expiration,{"is-error":a[2]}),className:d.timeInput,...t.getFieldProps("deliver_within"),"aria-errormessage":"expires-error"}),e.jsx("span",{className:d.inputDescriptionAfter,children:"hours"})]}),a.filter(Boolean).length>0&&e.jsxs("div",{className:y({"is-error":a.filter(Boolean).length>0}),children:[a[0]&&e.jsx("p",{className:"p-form-validation__message",id:"hour-error",children:e.jsx("span",{children:a[0]})}),a[1]&&e.jsx("p",{className:"p-form-validation__message",id:"minute-error",children:e.jsx("span",{children:a[1]})}),a[2]&&e.jsxs("p",{className:"p-form-validation__message",id:"expires-error",children:[e.jsx("strong",{children:"Error: "}),e.jsx("span",{children:a[2]})]})]})]}),e.jsx(ie,{formik:t})]})},ye={add:"Add upgrade profile",edit:"Save changes"},ve={access_group:B,all_computers:!1,at_hour:"",at_minute:"",autoremove:!1,deliver_delay_window:0,deliver_within:1,every:"week",on_days:[],randomize_delivery:!1,tags:[],title:"",upgrade_type:"all"},U={add:"added",edit:"updated"},je=t=>O().shape({...R,access_group:f(),all_computers:D(),at_hour:P().when("every",{is:"week",then:a=>a.required("Hour is required.").integer("Hour must be an integer.").min(0,"Hour must be between 0 and 23.").max(L,"Hour must be between 0 and 23.")}),at_minute:P().required("Minute is required.").integer("Minute must be an integer.").min(0,"Minute must be between 0 and 59.").max(H,"Minute must be between 0 and 59."),deliver_within:P().integer("'Expires after' must be an integer.").min(0,"'Expires after' must be at least 0."),every:f().required("This field is required."),on_days:A().of(f()).when("every",{is:"week",then:a=>a.min(1,"At least one day must be selected.")}),tags:A().of(f()),title:f().test({name:"required",message:"This field is required.",params:{action:t},test:a=>!!a||t!=="add"}),upgrade_type:f().required("This field is required.")}),C=t=>{const a=V(),{notify:r}=k(),{sidePath:l,popSidePath:h,createPageParamsSetter:u}=w(),{createUpgradeProfileQuery:c,editUpgradeProfileQuery:g}=ae(),{getAccessGroupQuery:m}=E(),{data:x}=m({},{enabled:t.action==="add"}),j=x?.data.map(({name:s,title:i})=>({label:i,value:s}))??[],{mutateAsync:b}=c,{mutateAsync:q}=g,S=u({sidePath:[],profile:""}),G=async s=>{const i={access_group:s.access_group,all_computers:s.all_computers,at_minute:s.at_minute,autoremove:s.autoremove,deliver_within:s.deliver_within,every:s.every,on_days:s.on_days,title:s.title,upgrade_type:s.upgrade_type};s.every==="week"&&(i.at_hour=s.at_hour),s.randomize_delivery&&(i.deliver_delay_window=`${s.deliver_delay_window}`),!s.all_computers&&s.tags.length&&(i.tags=s.tags);try{t.action==="edit"?await q({all_computers:i.all_computers,at_hour:i.at_hour,at_minute:i.at_minute,autoremove:i.autoremove,deliver_delay_window:i.deliver_delay_window,deliver_within:i.deliver_within,every:i.every,name:t.profile.name,on_days:i.on_days,tags:i.tags,title:i.title,upgrade_type:i.upgrade_type}):await b(i),S(),r.success({message:`Upgrade profile "${s.title}" has been ${U[t.action]} `,title:`Upgrade profile ${U[t.action]}`})}catch($){a($)}},n=z({initialValues:t.action==="edit"?{access_group:t.profile.access_group,all_computers:t.profile.all_computers,at_hour:t.profile.at_hour?parseInt(t.profile.at_hour):"",at_minute:parseInt(t.profile.at_minute),autoremove:t.profile.autoremove,deliver_delay_window:parseInt(t.profile.deliver_delay_window),deliver_within:parseInt(t.profile.deliver_within),every:t.profile.every,on_days:t.profile.on_days??[],randomize_delivery:t.profile.deliver_delay_window!=="0",tags:t.profile.tags,title:t.profile.title,upgrade_type:t.profile.upgrade_type}:ve,onSubmit:G,validationSchema:je(t.action)});return e.jsxs(o.Form,{onSubmit:n.handleSubmit,noValidate:!0,children:[e.jsx(o.Input,{type:"text",required:t.action==="add",label:"Title",...n.getFieldProps("title"),error:N(n,"title")}),e.jsx(o.Input,{type:"checkbox",label:"Only upgrade security issues",help:"Regular upgrades will not be applied",...n.getFieldProps("upgrade_type"),checked:n.values.upgrade_type==="security",onChange:async()=>n.setFieldValue("upgrade_type",n.values.upgrade_type==="all"?"security":"all")}),e.jsx(o.Input,{type:"checkbox",label:"Remove packages that are no longer needed",help:"This will affect packages installed to satisfy dependencies that are no longer required after upgrading.",...n.getFieldProps("autoremove"),checked:n.values.autoremove}),e.jsx(o.Select,{label:"Access group","aria-label":"Access group",options:j,...n.getFieldProps("access_group"),error:N(n,"access_group")}),e.jsx(fe,{formik:n}),e.jsx(ee,{formik:n}),e.jsx(te,{submitButtonDisabled:n.isSubmitting,submitButtonText:ye[t.action],onCancel:S,hasBackButton:l.length>1,onBackButtonPress:h})]})},De=()=>e.jsxs(e.Fragment,{children:[e.jsx(_.Header,{children:"Add upgrade profile"}),e.jsx(_.Content,{children:e.jsx(C,{action:"add"})})]}),be=t=>{const a=Q(),{data:r,isPending:l,error:h}=Y({queryKey:["upgradeProfile",t],queryFn:async({signal:c})=>a.get("GetUpgradeProfiles",{signal:c})}),u=r?.data.find(({id:c})=>c===t);return{upgradeProfile:u,upgradeProfileError:r&&!u?new Error("The upgrade profile could not be found."):h,isGettingUpgradeProfile:l}},M=()=>{const{profile:t}=w(),{isGettingUpgradeProfile:a,upgradeProfile:r,upgradeProfileError:l}=be(parseInt(t));if(l)throw l;return a?{upgradeProfile:void 0,isGettingUpgradeProfile:!0}:{upgradeProfile:r,isGettingUpgradeProfile:!1}},F=t=>I.filter(({value:a})=>t.includes(a)).sort((a,r)=>a.order-r.order).map(({label:a})=>a).join(", ").replace(/,(?= \w+$)/," and"),Pe=t=>{const{at_hour:a,deliver_within:r,every:l,next_run:h,on_days:u}=t,c=X(h).utc().format(`ddd, ${W} [UTC (expires after ${r}h)]`);let g="Every ";const m=parseInt(t.at_minute);if(l==="hour"&&(g+=`hour at ${m} ${T(m,"minute")}`,u&&(g+=` on ${F(u)}`)),l==="week"){if(!u||!a)return{scheduleMessage:"Every week",nextRunMessage:c};const x=parseInt(a);g+=`${F(u)} at ${x>9?x:`0${x}`}:${m>9?m:`0${m}`} UTC`}return{scheduleMessage:g,nextRunMessage:c}},Re=()=>{const{createSidePathPusher:t}=w(),{getAccessGroupQuery:a}=E(),{upgradeProfile:r,isGettingUpgradeProfile:l}=M(),{data:h,isPending:u}=a(),{value:c,setTrue:g,setFalse:m}=J();if(l||u)return e.jsx(_.LoadingState,{});const{scheduleMessage:x,nextRunMessage:j}=Pe(r),b=t("edit");return e.jsxs(e.Fragment,{children:[e.jsx(_.Header,{children:r.title}),e.jsxs(_.Content,{children:[e.jsxs("div",{className:"p-segmented-control",children:[e.jsxs(o.Button,{type:"button",hasIcon:!0,className:"p-segmented-control__button",onClick:b,"aria-label":`Edit upgrade profile ${r.title}`,children:[e.jsx(o.Icon,{name:"edit"}),e.jsx("span",{children:"Edit"})]}),e.jsxs(o.Button,{className:"has-icon p-segmented-control__button","aria-label":`Remove upgrade profile ${r.title}`,type:"button",onClick:g,children:[e.jsx(o.Icon,{name:o.ICONS.delete}),e.jsx("span",{children:"Remove"})]})]}),e.jsxs(v,{children:[e.jsx(v.Item,{children:e.jsxs(p,{children:[e.jsx(p.Item,{label:"Title",value:r.title}),e.jsx(p.Item,{label:"Name",value:r.name}),e.jsx(p.Item,{label:"Access group",value:K(r.access_group,h)}),e.jsx(p.Item,{label:"Upgrade type",value:r.upgrade_type==="all"?"All":"Security"}),e.jsx(p.Item,{label:"Auto remove packages",value:r.autoremove?"On":"Off"})]})}),e.jsx(v.Item,{title:"Schedule",children:e.jsxs(p,{children:[e.jsx(p.Item,{label:"Schedule",large:!0,value:x}),e.jsx(p.Item,{label:"Next run",large:!0,value:j}),e.jsx(p.Item,{label:"Delivery delay window",large:!0,value:`${r.deliver_delay_window} ${T(Number(r.deliver_delay_window),"minute")}`})]})}),e.jsx(v.Item,{title:"Association",children:e.jsx(oe,{profile:r,children:e.jsx(Z,{label:"Tags",value:r.tags.join(", ")})})})]})]}),e.jsx(re,{close:m,isOpen:c,upgradeProfile:r})]})},He=()=>{const{upgradeProfile:t,isGettingUpgradeProfile:a}=M();return a?e.jsx(_.LoadingState,{}):e.jsxs(e.Fragment,{children:[e.jsxs(_.Header,{children:['Edit "',t.title,'" profile']}),e.jsxs(_.Content,{children:[e.jsx(C,{action:"edit",profile:t}),";"]})]})};export{C as SingleUpgradeProfileForm,De as UpgradeProfileAddSidePanel,Re as UpgradeProfileDetailsSidePanel,He as UpgradeProfileEditSidePanel,ke as UpgradeProfileList,ze as UpgradeProfilesEmptyState,Qe as UpgradeProfilesHeader,ae as useUpgradeProfiles};
