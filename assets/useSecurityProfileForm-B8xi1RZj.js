import{i as N,aU as I,j as t,d as r,o as L,S as u,y as v,a_ as C,A as b,D as M,I as E,B as F,u as $,t as y,a$ as B,ab as Y,p as U,n as z,s as V,G as H,aa as W,J as x,K as w}from"./index-Cl3Ng_mk.js";import{A as G}from"./AssociationBlock-C1rpvall.js";import{u as K}from"./useGetInstances-C-V4hpoF.js";import{F as J}from"./FileInput-CR95Z8xH.js";import{F as Q}from"./Flow-DifGehjW.js";import{u as Z}from"./useOrgSettings-Dy8b-IHm.js";import{u as X}from"./useRoles-CILegiw-.js";import{I as k,R as T}from"./RadioGroup-yX-TMEBf.js";import{M as D}from"./MultiSelectField-C1seasqq.js";const A=[{label:"Sundays",value:"SU"},{label:"Mondays",value:"MO"},{label:"Tuesdays",value:"TU"},{label:"Wednesdays",value:"WE"},{label:"Thursdays",value:"TH"},{label:"Fridays",value:"FR"},{label:"Saturdays",value:"SA"}],R=[{label:"January",value:1},{label:"February",value:2},{label:"March",value:3},{label:"April",value:4},{label:"May",value:5},{label:"June",value:6},{label:"July",value:7},{label:"August",value:8},{label:"September",value:9},{label:"October",value:10},{label:"November",value:11},{label:"December",value:12}];function ee(e){const{instancesCount:s,isGettingInstances:i}=K({query:e.values.all_computers?void 0:e.values.tags.map(h=>`tag:${h}`).join(" OR "),limit:1}),[l,o]=N.useState(!1);return N.useEffect(()=>{if(s!==void 0){if(!e.values.tags.length&&!e.values.all_computers){o(!1);return}o(s>I)}},[s]),{isLoading:i,isValid:!l,description:"Associate the security profile. Apply it to all instances or limit it to specific instances using a tag.",content:t.jsxs(t.Fragment,{children:[l&&t.jsxs(r.Notification,{severity:"negative",inline:!0,title:"Associated instances limit reached:",children:["You've reached the limit of"," ",t.jsxs("strong",{children:[I," associated instances"]}),". Decrease the number of associated instances."]}),t.jsx(G,{formik:e})]}),submitButtonText:"Next"}}const te="_description_lcyzv_1",ae="_link_lcyzv_6",O={description:te,link:ae},p=({className:e,description:s,label:i,link:l})=>t.jsxs(t.Fragment,{children:[t.jsx("p",{className:L("u-no-margin--bottom",e),children:i}),t.jsxs("small",{className:O.description,children:[s,l&&t.jsx("a",{className:O.link,href:l,target:"_blank",rel:"noreferrer",onClick:o=>{o.stopPropagation()},children:"learn more"})]})]});function se(e,s){const i=async o=>{await e.setFieldValue("tailoring_file",o[0])},l=async()=>{await e.setFieldValue("tailoring_file",null)};return{isValid:!e.errors.benchmark&&!e.errors.mode,description:"Select a security profile benchmark, choose the profile mode, and optionally upload a tailoring file to customize the security profile.",content:t.jsxs(t.Fragment,{children:[!s&&t.jsx(r.Notification,{severity:"caution",title:"Changes restricted:",inline:!0,children:"After profile creation, the security profile benchmark and mode cannot be changed. Please review before proceeding."}),t.jsx(r.CustomSelect,{label:"Base profile",disabled:s,options:[{label:t.jsx(p,{className:"u-no-padding--top",label:u.cis_level1_workstation,description:"Center for Internet Security",link:"https://ubuntu.com/security/cis"}),value:"cis_level1_workstation",text:u.cis_level1_workstation},{label:t.jsx(p,{className:"u-no-padding--top",label:u.cis_level1_server,description:"Center for Internet Security",link:"https://ubuntu.com/security/cis"}),value:"cis_level1_server",text:u.cis_level1_server},{label:t.jsx(p,{className:"u-no-padding--top",label:u.cis_level2_workstation,description:"Center for Internet Security",link:"https://ubuntu.com/security/cis"}),value:"cis_level2_workstation",text:u.cis_level2_workstation},{label:t.jsx(p,{className:"u-no-padding--top",label:u.cis_level2_server,description:"Center for Internet Security",link:"https://ubuntu.com/security/cis"}),value:"cis_level2_server",text:u.cis_level2_server},{label:t.jsx(p,{className:"u-no-padding--top",label:u.disa_stig,description:"Defense Information System Agency (DISA) for the U.S. Department of Defense (DoD)",link:"https://ubuntu.com/security/disa-stig"}),value:"disa_stig",text:u.disa_stig}],value:e.values.benchmark??"",onChange:async o=>e.setFieldValue("benchmark",o),required:!0,searchable:"never"}),t.jsx(r.CustomSelect,{label:"Mode",disabled:s,options:[{label:t.jsx(p,{className:"u-no-padding--top",label:v.audit,description:"Generates an audit without applying any fixes or remediation."}),value:"audit",text:v.audit},{label:t.jsx(p,{className:"u-no-padding--top",label:v["audit-fix"],description:"Applies fixes and generates an audit after remediation."}),value:"audit-fix",text:v["audit-fix"]},{label:t.jsx(p,{className:"u-no-padding--top",label:v["audit-fix-restart"],description:`Applies fixes, requires a machine restart, and generates an
                  audit after remediation.`}),value:"audit-fix-restart",text:v["audit-fix-restart"]}],value:e.values.mode??"",onChange:async o=>e.setFieldValue("mode",o),required:!0}),t.jsx(J,{label:"Upload tailoring file",disabled:s,accept:".xml",...e.getFieldProps("tailoring_file"),help:t.jsxs(t.Fragment,{children:["Customize your security profile by adjusting or disabling rules to fit your system while staying compliant.",t.jsx("br",{}),"Max file size: 5mb. Supported format: .xml."]}),onFileRemove:l,onFileUpload:i})]}),submitButtonText:"Next"}}function re(e){return{isValid:!0,description:`This will ${C([e.values.mode!="audit"?"apply fixes":null,e.values.mode=="audit-fix-restart"?"restart instances":null,"generate an audit"].filter(s=>s!=null))} on the selected next run date.`,content:t.jsx(Q,{cards:[{header:"Next run date",description:t.jsxs(t.Fragment,{children:["Security profile's next run date arrives",t.jsx("br",{}),b(e.values.start_date).format(`${M}`)]}),iconName:"revisions"},e.values.mode!="audit"?{header:"Apply fixes",description:"Security profile will attempt to apply remediations before the next audit, helping maintain instances' compliance with the security profile.",iconName:"open-terminal"}:null,e.values.mode=="audit-fix-restart"?{header:"Restart instances",description:"To complete the fixes, instances must be restarted.",iconName:"restart",children:t.jsxs(t.Fragment,{children:[t.jsx(r.Row,{className:"u-no-padding",children:t.jsx(E,{label:"Delivery time",value:e.values.delivery_time=="asap"?"As soon as possible":`Delayed by ${e.values.restart_deliver_delay} ${F(e.values.restart_deliver_delay,"hour")}`})}),t.jsx(r.Row,{className:"u-no-padding",children:t.jsx(E,{label:"Randomize delivery over a time window",value:e.values.randomize_delivery=="yes"?`Yes, over ${e.values.restart_deliver_delay_window} ${F(e.values.restart_deliver_delay_window,"minute")}`:"No"})})]})}:null,{header:"Generate an audit",description:"Security profile will generate an audit for all instances associated, aggregated in the audit view to show pass/fail results and allow detailed inspection.",iconName:"file-blank"}].filter(s=>s!=null)}),submitButtonText:"Add"}}function ie(e){const{isSelfHosted:s}=$(),{getOrganisationPreferences:i}=Z(),{getAccessGroupQuery:l}=X(),{data:o,isLoading:h}=l(),{data:_,isLoading:S}=i(),j=()=>{const c=_?.data.audit_retention_period;return!c||c===-1?"Infinite":`${c} ${F(c,"day")}`};return{isLoading:h||S,isValid:!e.errors.title,description:"Choose a descriptive title and the right access group for your security profile.",content:t.jsxs(t.Fragment,{children:[t.jsx(r.Input,{type:"text",label:"Title",...e.getFieldProps("title"),error:y(e,"title"),required:!0}),t.jsx(r.Select,{label:"Access group",options:o?.data.map(c=>({label:c.title,value:c.name})),...e.getFieldProps("access_group"),error:y(e,"access_group"),required:!0,disabled:h}),s&&t.jsx(r.Input,{type:"text",label:"Audit retention",required:!0,disabled:!0,value:j(),help:"You can change this limit in the Landscape server configuration file."})]}),submitButtonText:"Next"}}const ne=({formik:{values:e,...s}})=>{switch(e.unit_of_time){case"WEEKLY":return t.jsx(D,{variant:"condensed",label:"On",items:[...A],selectedItems:A.filter(({value:i})=>e.days.includes(i)),onItemsUpdate:async i=>s.setFieldValue("days",i.map(({value:l})=>l)),scrollOverflow:!0,isSortedAlphabetically:!1,hasSelectedItemsFirst:!1,required:!0});case"MONTHLY":return!!e.start_date&&t.jsx(r.Select,{label:"On",options:B(new Date(e.start_date)),...s.getFieldProps("day_of_month_type"),required:!0});case"YEARLY":return t.jsx(D,{variant:"condensed",label:"On",items:[...R],selectedItems:R.filter(({value:i})=>e.months.includes(i)),onItemsUpdate:async i=>s.setFieldValue("months",i.map(({value:l})=>l)),isSortedAlphabetically:!1,hasSelectedItemsFirst:!1,scrollOverflow:!0,required:!0})}},le=({formik:e})=>{const s=b().format(Y);switch(e.values.start_type){case"on-a-date":return t.jsx(r.Input,{type:"datetime-local",label:"Date",min:s,...e.getFieldProps("start_date"),error:y(e,"start_date"),required:!0});case"recurring":return t.jsxs(t.Fragment,{children:[t.jsx(r.Input,{type:"datetime-local",label:"Start date",min:s,...e.getFieldProps("start_date"),error:y(e,"start_date"),required:!0}),t.jsxs(r.Row,{className:"u-no-padding",children:[t.jsx(r.Col,{size:6,children:t.jsx(r.Input,{...e.getFieldProps("every"),type:"number",label:"Repeat every",min:e.values.unit_of_time==="DAILY"?7:1,error:y(e,"every"),required:!0})}),t.jsx(r.Col,{size:6,children:t.jsx(r.Select,{label:"Repeat every",options:[{label:"Day",value:"DAILY"},{label:"Week",value:"WEEKLY"},{label:"Month",value:"MONTHLY"},{label:"Year",value:"YEARLY"}].map(i=>e.values.every==1?i:{...i,label:`${i.label}s`}),...e.getFieldProps("unit_of_time"),required:!0})})]}),t.jsx(ne,{formik:e}),t.jsx(r.Select,{label:"Ends",options:[{label:"Never",value:"never"},{label:"On a date",value:"on-a-date"}],...e.getFieldProps("end_type"),required:!0}),e.values.end_type=="on-a-date"&&t.jsx(r.Input,{type:"datetime-local",label:"End date",min:e.values.start_date,...e.getFieldProps("end_date"),error:y(e,"end_date"),required:!0})]})}},oe=({formik:e})=>t.jsxs(t.Fragment,{children:[t.jsx(r.Select,{label:"Schedule",options:[{label:"Select",value:"",hidden:!0},{label:"On a date",value:"on-a-date"},{label:"Recurring",value:"recurring"}],...e.getFieldProps("start_type"),required:!0}),t.jsx(k,{children:t.jsx(le,{formik:e})})]}),de="_inputContainer_1k4iz_1",ue="_input_1k4iz_1",ce="_inputDescription_1k4iz_10",m={inputContainer:de,input:ue,inputDescription:ce};function pe(e){return{isValid:!e.errors.start_type&&!e.errors.start_date&&!e.errors.every&&!e.errors.end_date&&!e.errors.restart_deliver_delay_window&&!e.errors.restart_deliver_delay,description:"Add a schedule for the security profile. Select a specific date or a recurring schedule for continuous audit generation.",content:t.jsxs(t.Fragment,{children:[t.jsx(oe,{formik:e}),e.values.mode=="audit-fix-restart"&&t.jsxs(t.Fragment,{children:[t.jsx(p,{label:"Restart schedule",description:"You can choose when to perform the required restart."}),t.jsx(T,{field:"delivery_time",formik:e,label:"Delivery time",inputs:[{label:"As soon as possible",key:"asap"},{label:"Delayed",key:"delayed",expansion:t.jsxs("div",{className:m.inputContainer,children:[t.jsx(r.Input,{type:"number",required:!0,className:m.input,wrapperClassName:m.inputWrapper,...e.getFieldProps("restart_deliver_delay"),error:y(e,"restart_deliver_delay")}),t.jsx("span",{className:m.inputDescription,children:"hours"})]})}]}),t.jsx(T,{field:"randomize_delivery",formik:e,label:"Randomize delivery over a time window",inputs:[{label:"No",key:"no"},{label:"Yes",key:"yes",expansion:t.jsxs("div",{className:m.inputContainer,children:[t.jsx(r.Input,{type:"number",required:!0,className:m.input,wrapperClassName:m.inputWrapper,...e.getFieldProps("restart_deliver_delay_window"),error:y(e,"restart_deliver_delay_window")}),t.jsx("span",{className:m.inputDescription,children:"minutes"})]})}]})]})]}),submitButtonText:"Next"}}const je=({initialValues:e,mutate:s,benchmarkStepDisabled:i,onSuccess:l=()=>{}})=>{const o=U(),{closeSidePanel:h}=z(),_=V({initialValues:e,validateOnMount:!0,validationSchema:H().shape({benchmark:x().required("This field is required."),end_date:x().when(["start_date","start_type","end_type"],([a,n,d],g)=>n=="recurring"&&d=="on-a-date"?g.required("This field is required.").test({test:f=>b(f).isAfter(b(a)),message:"The end date must be after the start date."}):g),every:w().when("start_type",([a],n)=>a=="recurring"?n.required("This field is required.").positive("Enter a positive number.").integer("Enter an integer.").when("unit_of_time",([d])=>d==="DAILY"?n.min(7,"Enter an interval of at least 7 days."):n):n),mode:x().required("This field is required."),restart_deliver_delay_window:w().when(["mode","randomize_delivery"],([a,n],d)=>a=="audit-fix-restart"&&n=="yes"?d.required("This field is required.").positive("Enter a positive number.").integer("Enter an integer."):d),restart_deliver_delay:w().when(["mode","delivery_time"],([a,n],d)=>a=="audit-fix-restart"&&n=="delayed"?d.required("This field is required.").positive("Enter a positive number.").integer("Enter an integer."):d),start_date:x().required("This field is required."),title:x().required("This field is required.")}),onSubmit:async a=>{if(!a.benchmark||!a.mode)return;const n=[];if(a.start_type=="recurring"){switch(n.push(`FREQ=${a.unit_of_time}`,`INTERVAL=${a.every}`),a.unit_of_time){case"WEEKLY":{n.push(`BYDAY=${a.days.join(",")}`);break}case"MONTHLY":{const d=new Date(a.start_date),g=d.getDate();switch(a.day_of_month_type){case"day-of-month":{n.push(`BYMONTHDAY=${g}`);break}case"day-of-week":{const f=Math.ceil(g/7);n.push(`BYDAY=${f>4?-1:f}${A[d.getDay()].value}`);break}}break}case"YEARLY":{n.push(`BYMONTH=${a.months.join(",")}`);break}}a.end_type=="on-a-date"&&n.push(`UNTIL=${b(a.end_date).format("YYYYMMDDTHHmmss")}Z`)}else n.push("FREQ=WEEKLY","COUNT=1");try{await s({access_group:a.access_group==W?void 0:a.access_group,all_computers:a.all_computers||void 0,benchmark:a.benchmark,mode:a.mode,restart_deliver_delay_window:a.mode=="audit-fix-restart"?a.restart_deliver_delay_window:void 0,restart_deliver_delay:a.mode=="audit-fix-restart"?a.restart_deliver_delay:void 0,schedule:n.join(";"),start_date:`${b(a.start_date).format(Y)}Z`,tags:a.all_computers?void 0:a.tags,tailoring_file:await a.tailoring_file?.text(),title:a.title})}catch(d){o(d);return}h(),l(a)}}),S=ie(_),j=se(_,i),c=pe(_),P=ee(_),q=re(_);return{formik:_,steps:[S,j,c,P,q]}};export{je as u};
