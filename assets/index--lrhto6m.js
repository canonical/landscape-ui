const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-CoexrMKU.js","assets/index-BYYwtqOb.js","assets/index-Da3lfBeW.css","assets/useInstances-WVnlBmJQ.js","assets/useFetchOld-BTtqmpM9.js","assets/SidePanelFormButtons-COrpH7DO.js","assets/SidePanelFormButtons.module-yv6Qz3cN.js","assets/SidePanelFormButtons-CxAXtF89.css","assets/useRoles-BL077fRQ.js","assets/index-xpGVtYVE.js","assets/CodeEditor-BdValBBR.js","assets/CodeEditor-CA89WJcJ.css","assets/moment-C5S46NFB.js","assets/index-Cg_wu4YD.css"])))=>i.map(i=>d[i]);
import{j as e,g as v,Y as te,r as l,h as a,n as X,Z as se,V as ne,s as Q,G as ae,m as oe,p as re,H as ie,_ as ee,a as le,k as ce,w as de,i as ue,l as me,R as W}from"./index-BYYwtqOb.js";import{u as U}from"./useInstances-WVnlBmJQ.js";import{I as pe}from"./InfoItem-Cti4fCWB.js";import{u as he}from"./WslInstancesHeader-Ci9k9ZBg.js";import{u as fe}from"./useRoles-BL077fRQ.js";import{m as Y}from"./moment-BRVkbQ11.js";import{N as j}from"./NoData-CGwk0mn8.js";import{h as G}from"./moment-C5S46NFB.js";import{u as ge}from"./index-C68HcqAE.js";import"./useFetchOld-BTtqmpM9.js";import"./HeaderWithSearch-Bg5cwKr-.js";import"./usePageParams-B645fm9D.js";import"./TablePagination-DWPTC5u3.js";import"./TablePagination.module-CgQ3jx4B.js";import"./SearchHelpPopup-CQnR1lC2.js";const xe="_infoContainer_1ca11_1",_e="_amount_1ca11_9",K={infoContainer:xe,amount:_e},be=({isExpanded:t,overflowingChipsAmount:s})=>s>0&&!t&&e.jsx("div",{className:K.infoContainer,children:e.jsx("span",{className:v("u-text--muted",K.amount),children:`+${s}`})}),je=({containerRef:t,onDismiss:s,onOverflowingItemsAmountChange:c,tagData:d})=>{const p=()=>{if(!t.current)return;const i=t.current.querySelectorAll("span.p-chip");c(Array.from(i).filter(({offsetHeight:g,offsetTop:h})=>h>g).length)};return te("resize",p),l.useEffect(()=>{p()},[d.length]),d.map(i=>e.jsx(a.Chip,{value:i,onDismiss:()=>s(i)},i))},ve="_container_1f6mu_1",Ie="_list_1f6mu_6",ye="_listItem_1f6mu_11",we="_search_1f6mu_17",L={container:ve,list:Ie,listItem:ye,search:we},Ce=({onTagClick:t,tags:s})=>s.length?e.jsxs("div",{className:L.container,children:[e.jsx("p",{className:"p-text--small-caps u-text--muted p-text--small",children:"Tags"}),e.jsx("ul",{className:v("p-list--divided u-no-margin--bottom",L.list),children:s.map(c=>e.jsx("li",{children:e.jsx("div",{className:L.listItem,children:e.jsx(a.Button,{type:"button",appearance:"base",className:L.search,onClick:()=>t(c),children:c})})},c))})]}):null,Se="_container_fqj7b_1",Ne="_prompt_fqj7b_10",Ae="_saveButton_fqj7b_17",H={container:Se,prompt:Ne,saveButton:Ae},Re=({onTagAdd:t,search:s})=>e.jsx(e.Fragment,{children:s&&e.jsxs("div",{className:H.container,children:[e.jsxs("span",{className:H.prompt,children:[e.jsx("span",{children:"Search for "}),e.jsx("span",{className:"p-search-and-filter__search-query",children:s}),e.jsx("span",{children:"..."})]}),e.jsx(a.Button,{type:"button",appearance:"link",onClick:t,className:H.saveButton,children:"Add tag"})]})}),J=X().matches(/^[a-zA-Z]/,{message:"Tag must starts with a letter",excludeEmptyString:!0}).matches(/^[a-zA-Z][a-zA-Z0-9_-]*$/,{message:"Tag can only contain letters, numbers, hyphens, and underscores",excludeEmptyString:!0}),ke="_searchContainer_qgkjy_1",Te="_box_qgkjy_8",Be="_inputContainer_qgkjy_13",Ee="_inputError_qgkjy_18",P={searchContainer:ke,box:Te,inputContainer:Be,inputError:Ee},De=({onTagsChange:t,tags:s,label:c,labelClassName:d,required:p})=>{var o;const[i,g]=l.useState(""),[h,_]=l.useState(""),[$,N]=l.useState(!1),[w,q]=l.useState(""),[x,I]=l.useState(!1),[C,O]=l.useState(0),{height:A}=se(),[b,R]=l.useState({top:"100%",bottom:"auto"}),{getAllInstanceTagsQuery:k}=U(),T=l.useRef(null),m=l.useRef(null);l.useEffect(()=>{if(!m.current)return;const n=m.current.querySelector("input");n&&q(n.id)},[m.current]),l.useEffect(()=>{!x||!m.current||F()},[A,x,m.current,(o=m.current)==null?void 0:o.clientHeight]);const F=()=>{if(!m.current)return;const{top:n,height:u}=m.current.getBoundingClientRect();n+u+379<A?R({top:"100%",bottom:"auto"}):R({top:"auto",bottom:"100%"})},S=()=>{I(!1)};ne(T,S);const Z=n=>{t(s.filter(u=>u!==n))},{data:r,isLoading:B}=k(),V=l.useMemo(()=>r?!i&&!s.length?r.data.results:r.data.results.filter(n=>!s.includes(n)).filter(n=>n.toLowerCase().includes(i.trim().toLowerCase())):[],[r,i,s]),E=n=>{t([...s,n])},D=()=>{if(i.trim())try{const n=J.validateSync(i.trim())??"";E(n),g(""),_(""),N(!1)}catch(n){n instanceof Error&&(_(n.message),N(!0))}},z=n=>{if(g(n.target.value),$)try{J.validateSync(n.target.value),_("")}catch(u){u instanceof Error&&_(u.message)}},y=n=>{const{key:u}=n;x?(u==="Escape"&&S(),u==="Enter"&&D()):u==="Enter"&&I(!0)};return e.jsxs("div",{children:[e.jsx("label",{className:v("p-form__label",{"is-required":p},d),htmlFor:w,children:c||"Tags"}),e.jsxs("div",{className:"p-search-and-filter",ref:T,children:[e.jsxs("div",{className:v("p-search-and-filter__search-container",P.searchContainer),"aria-expanded":x,ref:m,onClick:()=>I(!0),children:[e.jsx(je,{containerRef:m,onDismiss:Z,onOverflowingItemsAmountChange:n=>O(n),tagData:s}),e.jsx("div",{className:v("p-search-and-filter__box",P.box),children:e.jsx("div",{className:P.inputContainer,children:e.jsx(a.Input,{type:"text",autoComplete:"off",value:i,onChange:z,placeholder:"Add tags",className:"u-no-margin--bottom",onClick:()=>I(!0),onKeyUp:y,wrapperClassName:h?"is-error":"","aria-errormessage":h?`${w}-error`:void 0,"aria-invalid":!!h})})}),h&&e.jsx("div",{className:"is-error",children:e.jsxs("p",{className:v("p-form-validation__message",P.inputError),id:`${w}-error`,children:[e.jsx("strong",{children:"Error: "}),e.jsx("span",{children:h})]})}),e.jsx(be,{isExpanded:x,overflowingChipsAmount:C})]}),x&&B&&e.jsx(Q,{}),x&&!B&&e.jsxs("div",{className:"p-search-and-filter__panel",style:b,children:[e.jsx(Re,{onTagAdd:D,search:i}),e.jsx(Ce,{onTagClick:E,tags:V})]})]})]})},Le=t=>{var c;const s=(c=t.grouped_hardware)==null?void 0:c.network;return!Array.isArray(s)||s.length===0?e.jsx(j,{}):s.filter(({ip:d})=>d!=="Not available").map(({ip:d})=>d).join(", ")||e.jsx(j,{})},Pe=(t,s)=>{var c,d,p;return[{label:"instance ID",value:t.id},{label:"Hostname",value:t.hostname},{label:"IP Address",value:Le(t)},{label:"Serial number",value:((c=t.grouped_hardware)==null?void 0:c.system.serial)??e.jsx(j,{})},{label:"Product identifier",value:((d=t.grouped_hardware)==null?void 0:d.system.model)??e.jsx(j,{})},{label:"Distribution",value:t.distribution??"Unknown"},{label:"Access group",value:((p=s.find(({value:i})=>i===t.access_group))==null?void 0:p.label)||t.access_group},{label:"Last ping time",value:t.last_ping_time&&Y(t.last_ping_time).isValid()?Y(t.last_ping_time).format(ae):e.jsx(j,{})},{label:"Annotations",value:t.annotations?Object.entries(t.annotations).map(([i,g],h,_)=>e.jsxs(e.Fragment,{children:[e.jsx("span",{children:`${i}: ${g}`}),h<_.length-1&&e.jsx("br",{})]})):e.jsx(j,{})},{label:"Comment",value:t.comment||e.jsx(j,{})}]},$e="_titleRow_lxk0r_1",qe="_flexContainer_lxk0r_6",Oe="_italic_lxk0r_11",Fe="_infoRow_lxk0r_15",Ve="_tagSection_lxk0r_20",ze="_tagsRow_lxk0r_25",Me="_tagsButton_lxk0r_33",f={titleRow:$e,flexContainer:qe,italic:Oe,infoRow:Fe,tagSection:Ve,tagsRow:ze,tagsButton:Me},He={deliver_after:"",deliverImmediately:!0,action:null},Qe=oe().shape({deliver_after:X().when("deliverImmediately",{is:!1,then:t=>t.required("This field is required").test({message:"Invalid date",test:s=>G(s).isValid()}).test({message:"Date must be in the future",test:s=>G(s).isAfter()})}),deliverImmediately:re(),action:ie().oneOf(["shutdown","reboot"]).required()}),Ue=l.lazy(()=>ee(()=>import("./index-CoexrMKU.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8]))),Ze=l.lazy(()=>ee(()=>import("./index-xpGVtYVE.js").then(t=>t.i),__vite__mapDeps([9,1,2,10,11,5,6,7,4,8,12,13])).then(t=>({default:t.RunInstanceScriptForm}))),ct=({instance:t})=>{const[s,c]=l.useState(t.tags),d=le(),p=ce(),{openActivityDetails:i}=ge(),{notify:g}=de(),{setSidePanelContent:h}=ue(),{getAccessGroupQuery:_}=fe(),{removeInstancesQuery:$,rebootInstancesQuery:N,shutdownInstancesQuery:w}=U(),{deleteChildInstancesQuery:q}=he(),{editInstanceQuery:x}=U(),{mutateAsync:I}=x,{data:C}=_(),O=(C==null?void 0:C.data.map(({name:o,title:n})=>({label:n,value:o})))??[],{mutateAsync:A,isPending:b}=$,{mutateAsync:R,isPending:k}=N,{mutateAsync:T,isPending:m}=w,{mutateAsync:F,isPending:S}=q,r=me({initialValues:He,validationSchema:Qe,onSubmit:async o=>{if(!o.action)return;const n={computer_ids:[t.id],deliver_after:o.deliverImmediately?void 0:`${o.deliver_after}:00Z`};try{const{data:u}=o.action==="reboot"?await R(n):await T(n),M=o.action==="reboot"?"restarted":"shut down";g.success({title:`You queued "${t.title}" to be ${M}`,message:`Instance "${t.title}" will be ${M} and is queued in Activities`,actions:[{label:"View details",onClick:()=>i(u)}]})}catch(u){p(u)}}}),B=async()=>{try{await I({instanceId:t.id,tags:s}),g.success({title:"Tags updated",message:`"${t.title}" instance tags have been updated successfully`})}catch(o){p(o)}},V=async()=>{try{await A({computer_ids:[t.id]}),d(`${W}instances`,{replace:!0})}catch(o){p(o)}},E=()=>{h("Edit Instance",e.jsx(l.Suspense,{fallback:e.jsx(Q,{}),children:e.jsx(Ue,{instance:t})}))},D=()=>{h("Run script",e.jsx(l.Suspense,{fallback:e.jsx(Q,{}),children:e.jsx(Ze,{query:`id:${t.id}`})}))},z=async()=>{try{await F({computer_ids:[t.id]}),d(`${W}instances`,{replace:!0})}catch(o){p(o)}},y=async o=>{await r.setFieldValue("action",o),r.handleSubmit()};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:f.titleRow,children:[e.jsxs("div",{className:f.flexContainer,children:[e.jsx("p",{className:"p-heading--4 u-no-padding--top u-no-margin--bottom",children:t.title}),t.is_wsl_instance&&e.jsx("p",{className:v("u-text--muted u-no-margin--bottom",f.italic),children:"WSL Instance"})]}),e.jsxs("div",{className:f.flexContainer,children:[t.is_wsl_instance&&e.jsx(a.ConfirmationButton,{className:"u-no-margin--bottom u-no-margin--right",type:"button",confirmationModalProps:{title:"Delete instance",children:e.jsxs("p",{children:["This will permanently delete the instance"," ",e.jsx("b",{children:t.title})," from both the Windows host machine and Landscape."]}),confirmButtonLabel:"Delete",confirmButtonAppearance:"negative",confirmButtonDisabled:S,confirmButtonLoading:S,onConfirm:z},children:"Delete instance"}),e.jsx("div",{className:"p-segmented-control",children:e.jsxs("div",{className:"p-segmented-control__list",children:[e.jsxs(a.Button,{className:"p-segmented-control__button u-no-margin--bottom",type:"button",onClick:E,children:[e.jsx(a.Icon,{name:"edit"}),e.jsx("span",{children:"Edit"})]}),e.jsxs(a.Button,{className:"p-segmented-control__button u-no-margin--bottom",type:"button",onClick:D,children:[e.jsx(a.Icon,{name:"code"}),e.jsx("span",{children:"Run script"})]}),e.jsxs(a.ConfirmationButton,{className:"p-segmented-control__button u-no-margin--bottom has-icon",type:"button",disabled:b,confirmationModalProps:{title:"Remove instance from Landscape",children:e.jsxs("p",{children:["This will remove the instance ",e.jsx("b",{children:t.title})," from Landscape.",e.jsx("br",{}),e.jsx("br",{}),"It will remain on the parent machine. You can re-register it to Landscape at any time."]}),confirmButtonLabel:"Remove",confirmButtonAppearance:"negative",confirmButtonDisabled:b,confirmButtonLoading:b,onConfirm:V},children:[e.jsx(a.Icon,{name:a.ICONS.delete}),e.jsx("span",{children:"Remove from Landscape"})]}),e.jsxs(a.ConfirmationButton,{className:"p-segmented-control__button u-no-margin--bottom has-icon",type:"button",disabled:b,confirmationModalProps:{title:"Restart instance",children:e.jsxs(a.Form,{onSubmit:()=>y("reboot"),noValidate:!0,children:[e.jsx(a.CheckboxInput,{label:"Deliver as soon as possible",...r.getFieldProps("deliverImmediately"),checked:r.values.deliverImmediately}),e.jsx(a.Input,{type:"datetime-local",label:"Schedule time",labelClassName:"u-off-screen",className:f.input,placeholder:"Scheduled time",...r.getFieldProps("deliver_after"),disabled:r.values.deliverImmediately,error:r.touched.deliver_after&&r.errors.deliver_after?r.errors.deliver_after:void 0}),e.jsxs("p",{children:['This will restart "',t.title,'" instance.']})]}),confirmButtonLabel:"Restart",confirmButtonAppearance:"negative",confirmButtonDisabled:k,confirmButtonLoading:k,onConfirm:()=>y("reboot")},children:[e.jsx(a.Icon,{name:"restart"}),e.jsx("span",{children:"Restart"})]}),e.jsxs(a.ConfirmationButton,{className:"p-segmented-control__button u-no-margin--bottom has-icon",type:"button",disabled:b,confirmationModalProps:{title:"Shut down instance",children:e.jsxs(a.Form,{onSubmit:()=>y("shutdown"),noValidate:!0,children:[e.jsx(a.CheckboxInput,{label:"Deliver as soon as possible",...r.getFieldProps("deliverImmediately"),checked:r.values.deliverImmediately}),e.jsx(a.Input,{type:"datetime-local",label:"Schedule time",labelClassName:"u-off-screen",className:f.input,placeholder:"Scheduled time",...r.getFieldProps("deliver_after"),disabled:r.values.deliverImmediately,error:r.touched.deliver_after&&r.errors.deliver_after?r.errors.deliver_after:void 0}),e.jsxs("p",{children:['This will shut down "',t.title,'" instance.']})]}),confirmButtonLabel:"Shutdown",confirmButtonAppearance:"negative",confirmButtonDisabled:m,confirmButtonLoading:m,onConfirm:()=>y("shutdown")},children:[e.jsx(a.Icon,{name:"power-off"}),e.jsx("span",{children:"Shutdown"})]})]})},"buttons")]})]}),e.jsx("div",{className:f.infoRow,children:e.jsx(a.Row,{className:"u-no-padding--left u-no-padding--right u-no-max-width",children:Pe(t,O).map(o=>e.jsx(a.Col,{size:4,children:e.jsx(pe,{...o})},o.label))})}),e.jsx("div",{className:f.tagSection,children:e.jsxs(a.Row,{className:f.tagsRow,children:[e.jsx(a.Col,{size:4,children:e.jsx(De,{labelClassName:"p-text--small p-text--small-caps u-text--muted",onTagsChange:o=>c(o),tags:s})}),e.jsx(a.Col,{size:2,className:f.tagsButton,children:e.jsx(a.Button,{type:"button",className:"u-no-margin--bottom",onClick:B,children:"Update"})})]})})]})};export{ct as default};
