import{r as p,ao as G,D as V,j as s,d as a,p as M,i as d,J as T,l as B,z as D,B as L,y as O,C as k,e as U}from"./index-Dfc97QGW.js";import{M as v}from"./MultiSelectField-fcXogomg.js";import{S as z}from"./SidePanelFormButtons-BdOP5SSP.js";import{u as x}from"./useGetInstances-Ccq0NH3v.js";import{s as _}from"./InstancesPageActions-Dns4Yse-.js";import"./index-DiSNWm9B.js";import{g as m}from"./formikErrors-Bw8iTXYS.js";import{u as W}from"./useGetTags-oA_gPXb8.js";import{m as q}from"./index-S_kjB96R.js";import{u as Z}from"./useRunScript-Yt_xBd8E.js";import{T as H}from"./TablePagination-B0v8QAQr.js";import{d as J}from"./helpers-BbXQOWxJ.js";import{D as K}from"./DeliveryBlock-FX2F7SvQ.js";import"./SidePanelFormButtons.module-CcPyiogC.js";import"./useFetchOld-BgGVMMmJ.js";import"./ListTitle-DsIgCqjQ.js";import"./NoData-DMN9LLPq.js";import"./ResponsiveTable-ViIMTRR6.js";import"./StaticLink-BNg3qc2M.js";import"./TruncatedCell-Cf7_euhM.js";import"./Truncated-D8EZCoK1.js";import"./useExpandableRow-DYtdXwcw.js";import"./TextConfirmationModal-O9rtHEfo.js";import"./InfoGrid-CrJbMYy5.js";import"./InfoItem-DImpX37B.js";import"./PageParamFilter-C5PJgjVf.js";import"./TableFilterChips-DXWGZ6VK.js";import"./TableFilter-BmLRyeMD.js";import"./RadioGroup-DkbRD5zc.js";const Q="_pagination_svwl5_1",X={pagination:Q},Y=({instances:i})=>{const[r,g]=p.useState(G),[o,f]=p.useState(V),y=p.useMemo(()=>[{Header:"Instance",Cell:({row:{original:c}})=>c.title}],[]),e=(r-1)*o,l=i.slice(e,e+o);return s.jsxs(s.Fragment,{children:[s.jsx(a.ModularTable,{columns:y,data:l}),s.jsx(H,{className:X.pagination,currentItemCount:l.length,currentPage:r,pageSize:o,paginate:g,setPageSize:f,totalItems:i.length})]})},ee={deliver_after:"",deliver_immediately:!0,instanceIds:[],queryType:"tags",tags:[],username:"root",time_limit:300},te=M().shape({...J,access_group:d(),instanceIds:T().of(B()).when("queryType",{is:"ids",then:i=>i.min(1,"At least one instance is required.")}),queryType:d().required("This field is required."),tags:T().of(d()).when("queryType",{is:"tags",then:i=>i.min(1,"At least one tag is required.")}),username:d().required("This field is required.")}),se="_instanceSelectionContainer_f2qf2_1",ie="_radioGroup_f2qf2_9",j={instanceSelectionContainer:se,radioGroup:ie},we=({script:i})=>{const r=D(),{notify:g}=L(),{closeSidePanel:o}=O(),{runScript:f}=Z(),e=k({initialValues:ee,onSubmit:async t=>{const n={query:t.queryType==="ids"?`id:${t.instanceIds.join(" OR id:")}`:`tag:${t.tags.join(" OR tag:")}`,script_id:i.id,username:t.username,time_limit:Number(t.time_limit),deliver_after:t.deliver_immediately?void 0:q(t.deliver_after).toISOString().replace(/\.\d+(?=Z$)/,"")};t.deliver_immediately||(n.deliver_after=q(t.deliver_after).toISOString().replace(/\.\d+(?=Z$)/,""));try{await f(n),o(),g.success({message:`"${i.title}" script queued to execute successfully`,title:"Script execution queued"})}catch(A){r(A)}},validateOnMount:!0,validationSchema:te}),[l,c]=p.useState(!1),{tags:F,isGettingTags:C}=W(),{instances:$,isGettingInstances:P}=x({query:`access-group-recursive:${i.access_group}`}),{instances:E,isGettingInstances:S,instancesError:h}=x({query:`access-group-recursive:${i.access_group} ${e.values.tags.map(t=>`tag:${t}`).join(" OR ")}`},void 0,{enabled:!!e.values.tags.length});if(C||P)return s.jsx(U,{});h&&r(h);const R=()=>{c(!1)},N=()=>{c(!0)},I=F.map(t=>({label:t,value:t}))??[],u=($.filter(t=>_(t).scripts)??[]).map(({title:t,id:n})=>({label:t,value:n})),w=E.filter(t=>_(t).scripts)??[],b=()=>{e.values.queryType=="tags"?N():e.handleSubmit()};return s.jsxs(s.Fragment,{children:[s.jsxs(a.Form,{onSubmit:b,noValidate:!0,children:[s.jsx("p",{className:"u-no-margin--bottom",children:"Select instances by:"}),s.jsx("div",{className:"is-required",children:s.jsxs("div",{children:[s.jsxs("div",{className:j.radioGroup,children:[s.jsx(a.Input,{type:"radio",label:"Tags",...e.getFieldProps("queryType"),onChange:async t=>{e.getFieldProps("queryType").onChange(t),await Promise.all([e.setFieldValue("tags",[]),e.setFieldTouched("tags",!1),e.setFieldValue("instanceIds",[]),e.setFieldTouched("instanceIds",!1)])},value:"tags",checked:e.values.queryType==="tags"}),s.jsx(a.Input,{type:"radio",label:"Instance names",...e.getFieldProps("queryType"),value:"ids",checked:e.values.queryType==="ids",disabled:!u.length,help:!u.length&&"There are no available instances in this script's access group."})]}),s.jsxs("div",{className:j.instanceSelectionContainer,children:[e.values.queryType==="tags"&&s.jsx(v,{placeholder:"Select tags",variant:"condensed",label:"Tags",labelClassName:"u-off-screen",required:!0,...e.getFieldProps("tags"),items:I,selectedItems:I.filter(({value:t})=>e.values.tags.includes(t)),onItemsUpdate:async t=>{e.setFieldValue("tags",t.map(({value:n})=>n)),e.setFieldTouched("tags",!0,!1)},error:m(e,"tags")}),e.values.queryType==="ids"&&s.jsx(v,{placeholder:"Select instances",variant:"condensed",label:"Instances",labelClassName:"u-off-screen",required:!0,...e.getFieldProps("instanceIds"),items:u,selectedItems:u.filter(({value:t})=>e.values.instanceIds.includes(t)),onItemsUpdate:async t=>{e.setFieldValue("instanceIds",t.map(({value:n})=>n)),e.setFieldTouched("instanceIds",!0,!1)},error:m(e,"instanceIds")})]})]})}),s.jsxs(a.Row,{className:"u-no-padding--left u-no-padding--right",children:[s.jsx(a.Col,{size:6,children:s.jsx(a.Input,{type:"text",label:"Run as user",autoComplete:"off",required:!0,...e.getFieldProps("username"),error:m(e,"username")})}),s.jsx(a.Col,{size:6,children:s.jsx(a.Input,{type:"text",label:"Time limit (seconds)",autoComplete:"off",required:!0,...e.getFieldProps("time_limit"),error:m(e,"time_limit")})})]}),s.jsx(K,{formik:e}),s.jsx(z,{submitButtonDisabled:e.isSubmitting||!e.isValid,submitButtonText:"Run script",onSubmit:b})]}),l&&s.jsxs(a.ConfirmationModal,{title:`Run ${i.title} script on ${e.values.tags.length>1?`${e.values.tags.length} tags`:`${e.values.tags[0]} tag`}`,confirmButtonLabel:"Run script",onConfirm:()=>{e.handleSubmit()},confirmButtonDisabled:e.isSubmitting||!!h||S,confirmButtonLoading:S,close:R,confirmButtonAppearance:"positive",children:[s.jsxs("p",{children:["This script will run on the following instances, which are associated with the selected"," ",e.values.tags.length==1?"tag":"tags","."]}),s.jsx(Y,{instances:w})]})]})};export{we as default};
