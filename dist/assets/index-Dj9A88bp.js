import{j as e,x as c,I as N,p as D,i as V,G as C,z as T,B as z,y as B,C as E,d as l}from"./index-DYykpNVa.js";import{D as F}from"./DeliveryBlock-C-KDxUEZ.js";import{R as q}from"./RandomizationBlock-DjoHppMG.js";import{d as Q,r as R}from"./helpers-DblkVUdf.js";import{S as L}from"./SidePanelFormButtons-Aj5ThB2m.js";import{I as U}from"./InfoItem-DMBAN7ig.js";import{u as G}from"./index-C2TKYmcI.js";import{a as O,I as y}from"./useUsns-Ky-uaXGZ.js";import"./formikErrors-Bw8iTXYS.js";import"./RadioGroup-DD61dFf3.js";import"./SidePanelFormButtons.module-CcPyiogC.js";import"./NoData-CT6SeJUX.js";import"./Truncated-DtD6hAHP.js";import"./ResponsiveTable-C-8YbfBJ.js";import"./TablePagination-CIA4CRba.js";import"./TableFilterChips-DLH4XQ-H.js";import"./useFetchOld-BGD2hIpr.js";import"./PageParamFilter-LH49uHXA.js";import"./TableFilter-C7yTBfOe.js";import"./constants-CXofZZ4i.js";import"./InstancesPageActions-nbDXpXLr.js";import"./ListTitle-anvzyHx6.js";import"./StaticLink-BX9qJBBO.js";import"./TruncatedCell-DQQZxgbr.js";import"./useExpandableRow-CGDZ27WS.js";import"./index-Cbj0Sz5k.js";import"./TextConfirmationModal-DuGXYB1S.js";import"./InfoGrid-CVtcW3Y8.js";const Y=({packageCount:s,securityUpgradePackageCount:r,totalUpgradePackageCount:n})=>{const t=n-r,i=s-n;return e.jsxs("div",{children:[e.jsx("span",{children:"You selected "}),e.jsx("span",{children:e.jsx("b",{children:s})}),e.jsx("span",{children:" packages. This will:"}),e.jsxs("ul",{className:N({"u-no-margin--bottom":i>0}),children:[r>0&&e.jsxs("li",{children:[e.jsx("span",{children:"apply "}),e.jsx("span",{children:e.jsxs("b",{children:[r," "]})}),e.jsxs("span",{children:["security ",c(r,"upgrade")]})]}),t>0&&e.jsxs("li",{children:[e.jsx("span",{children:"apply "}),e.jsx("span",{children:e.jsx("b",{children:t})}),e.jsxs("span",{children:["regular ",c(t,"upgrade")]})]})]}),i>0&&e.jsxs("p",{children:[e.jsx("span",{children:"No upgrades for "}),e.jsx("span",{children:e.jsx("b",{children:i})}),e.jsxs("span",{children:[c(i,"package")," needed."]})]})]})},K={deliver_after:"",deliver_delay_window:0,deliver_immediately:!0,randomize_delivery:!1,version:""},Z=s=>D({...R,...Q,version:V().test({name:"required",message:"This field is required",params:{action:s},test:r=>s!=="downgrade"||!!r})}),H=(s,r)=>{const n=c(s.length,`${s[0]?.name??""} Package`,"selected packages");return`This will ${r==="hold"?"disable":"enable"} upgrades for the ${n}. It will ${r==="hold"?"not ":""}be eligible to upgrade to the latest available version.`},J=(s,r,n)=>{const t=c(r.length,`${r[0]?.name??""} Package`,"selected packages"),i={downgrade:"downgraded",hold:"held",remove:"uninstall",unhold:"unheld",upgrade:"upgraded"},h={downgrade:`be downgraded to ${n} version`,hold:"disable its upgrades",remove:"be uninstalled",unhold:"enable its upgrades",upgrade:"be upgraded"},x=`You queued ${t} to ${s!=="remove"?"be ":""}${i[s]}.`,b=`${t} ${r.length>1?"are":"is"} queued in Activities and will ${h[s]}.`;return{title:x,message:b}},Pe=({action:s,packages:r})=>{const{instanceId:n,childInstanceId:t}=C(),i=T(),{notify:h}=z(),{openActivityDetails:x}=G(),{closeSidePanel:b}=B(),{downgradePackageVersionQuery:f,getDowngradePackageVersionsQuery:w,upgradePackagesQuery:_,packagesActionQuery:I}=O(),m=Number(t??n),{data:P}=w({instanceId:m,packageName:r[0].name},{enabled:s==="downgrade"}),p=P?.data.results.map(({version:a})=>({label:a,value:a}))??[];p.unshift({label:"Select version",value:""});const j=r.filter(({status:a,available_version:u})=>a==="security"||a==="installed"&&u).map(({name:a})=>a),v=r.filter(({status:a})=>a==="security").length,{mutateAsync:S}=f,{mutateAsync:A}=_,{mutateAsync:k}=I,$=async a=>{const u={deliver_after:a.deliver_immediately?void 0:`${a.deliver_after}:00Z`,deliver_delay_window:a.randomize_delivery?a.deliver_delay_window:void 0};let g;s==="upgrade"?g=A({...u,packages:j,query:`id:${m}`}):s==="downgrade"?g=S({instanceId:m,package_name:r[0].name,package_version:a.version}):g=k({...u,action:s,computer_ids:[m],package_ids:r.map(({id:d})=>d)});try{const{data:d}=await g;b(),h.success({...J(s,r,a.version),actions:[{label:"Details",onClick:()=>{x(d)}}]})}catch(d){i(d)}},o=E({initialValues:K,validationSchema:Z(s),onSubmit:$});return e.jsxs(l.Form,{onSubmit:o.handleSubmit,noValidate:!0,children:[s==="downgrade"&&e.jsxs(l.Row,{className:"u-no-padding--left u-no-padding--right",children:[e.jsx(l.Col,{size:6,children:e.jsx(U,{label:"Current version",value:r[0].current_version})}),e.jsx(l.Col,{size:6,children:p.length>1?e.jsx(l.Select,{label:"New version",className:"",labelClassName:"p-text--small u-text--muted u-no-margin--bottom p-text--small-caps",...o.getFieldProps("version"),options:p}):e.jsx("p",{children:"No downgrade versions"})})]}),s==="upgrade"&&(r.length!==j.length||v>0)&&e.jsx(Y,{packageCount:r.length,securityUpgradePackageCount:v,totalUpgradePackageCount:j.length}),(s==="hold"||s==="unhold")&&e.jsx("p",{children:H(r,s)}),["remove","upgrade","hold","unhold"].includes(s)&&e.jsxs(e.Fragment,{children:[e.jsx(F,{formik:o}),e.jsx(q,{formik:o})]}),(s!=="downgrade"||p.length>1)&&e.jsx(L,{submitButtonDisabled:o.isSubmitting,submitButtonText:y[s].label,submitButtonAppearance:y[s].appearance})]})};export{Pe as default};
