import{f as $,v as te,w as H,c as ye,r as L,j as e,d as l,I as ie,o as g,N as V,x as R,a as he,ag as Q,z as W,s as N,C as se,ac as ae,p as re,i as B,l as k,B as Y,g as _e,aw as fe,aJ as D,e as ge,P as xe,R as be}from"./index-DYykpNVa.js";import{S as J,c as P,a as T}from"./useGetOverLimitSecurityProfiles-DhgD9daD.js";import{A as _i,b as fi,u as gi}from"./useGetOverLimitSecurityProfiles-DhgD9daD.js";import{p as ne,g as ve,a as Se,n as le,u as je,b as Pe,c as Ie,d as we,S as Ae,e as Ne,f as oe,h as Fe,i as Te}from"./index-DXIP_nUU.js";import{j as bi,k as vi,l as Si}from"./index-DXIP_nUU.js";import{S as E}from"./SidePanelFormButtons-Aj5ThB2m.js";import{S as v}from"./SidePanel-DVyPWXM9.js";import{r as Be}from"./helpers-DblkVUdf.js";import{A as Re}from"./AssociationBlock-Bs5is6Zl.js";import{u as De}from"./useGetInstances-CQaSwVqm.js";import"./InstancesPageActions-nbDXpXLr.js";import"./index-Cbj0Sz5k.js";import{F as Le}from"./FileInput-B1IY8xqt.js";import{I as y}from"./InfoGrid-CVtcW3Y8.js";import{g as I}from"./formikErrors-Bw8iTXYS.js";import{u as Ce}from"./useOrgSettings-BfuduGZV.js";import"./constants-Dy8_1E-v.js";import{u as de}from"./useRoles-CK1OAvut.js";import{I as Ee,R as z}from"./RadioGroup-DD61dFf3.js";import{R as qe}from"./RandomizationBlock-DjoHppMG.js";import{M as Z}from"./MultiSelectField-85mhFA5_.js";import{B as C}from"./Blocks-C-bFP-tp.js";import{u as Oe}from"./index-C2TKYmcI.js";import{P as $e}from"./ProfileAssociatedInstancesLink-CRAimTVK.js";import{P as Ye}from"./ProfileAssociationInfo-3j9RTKgZ.js";import"./PageMain-BnPck7ZK.js";import"./TableFilterChips-DLH4XQ-H.js";import"./TablePagination-CIA4CRba.js";import"./PageParamFilter-LH49uHXA.js";import"./TableFilter-C7yTBfOe.js";import"./HeaderWithSearch-DH3OfcZg.js";import"./constants-CXofZZ4i.js";import"./constants-C7fhH3UY.js";import"./ListTitle-anvzyHx6.js";import"./NoData-CT6SeJUX.js";import"./ResponsiveTable-C-8YbfBJ.js";import"./TextConfirmationModal-DuGXYB1S.js";import"./table-CdFwMAPu.js";import"./useGetActivities-BUXsLbmh.js";import"./SidePanelFormButtons.module-CcPyiogC.js";import"./useGetTags-BbkSXw8M.js";import"./useFetchOld-BGD2hIpr.js";import"./StaticLink-BX9qJBBO.js";import"./TruncatedCell-DQQZxgbr.js";import"./Truncated-DtD6hAHP.js";import"./useExpandableRow-CGDZ27WS.js";import"./InfoItem-DMBAN7ig.js";const ce=()=>{const t=$(),s=te(),{isPending:i,mutateAsync:r}=H({mutationFn:async o=>t.post("security-profiles",o),onSuccess:async()=>s.invalidateQueries({queryKey:["securityProfiles"]})});return{isSecurityProfileAdding:i,addSecurityProfile:r}},Me=(t,s)=>{const i=$(),{data:r,isPending:o,error:d}=ye({queryKey:["securityProfile",t],queryFn:async({signal:a})=>i.get("security-profiles",{signal:a}),...s}),c=r?.data.results.find(({id:a})=>a===t);return{securityProfile:c,securityProfileError:r&&!c?new Error("The security profile could not be found."):d,isGettingSecurityProfile:o}},ke=()=>{const t=$(),{isPending:s,mutateAsync:i}=H({mutationFn:async({id:r,...o})=>t.get(`security-profiles/${r}/report`,{params:o})});return{getSecurityProfileReport:i,isSecurityProfileReportLoading:s}},Ge=()=>{const t=$(),s=te(),{isPending:i,mutateAsync:r}=H({mutationFn:async({id:o,...d})=>t.patch(`security-profiles/${o}`,d),onSuccess:async()=>s.invalidateQueries({queryKey:["securityProfiles"]})});return{isSecurityProfileUpdating:i,updateSecurityProfile:r}},U=[{label:"Sundays",value:"SU"},{label:"Mondays",value:"MO"},{label:"Tuesdays",value:"TU"},{label:"Wednesdays",value:"WE"},{label:"Thursdays",value:"TH"},{label:"Fridays",value:"FR"},{label:"Saturdays",value:"SA"}],X=[{label:"January",value:1},{label:"February",value:2},{label:"March",value:3},{label:"April",value:4},{label:"May",value:5},{label:"June",value:6},{label:"July",value:7},{label:"August",value:8},{label:"September",value:9},{label:"October",value:10},{label:"November",value:11},{label:"December",value:12}];function Ve(t){const{instancesCount:s,isGettingInstances:i}=De({query:t.values.all_computers?void 0:t.values.tags.map(d=>`tag:${d}`).join(" OR "),limit:1}),[r,o]=L.useState(!1);return L.useEffect(()=>{if(s!==void 0){if(!t.values.tags.length&&!t.values.all_computers){o(!1);return}o(s>J)}},[s]),{isLoading:i,isValid:!r,description:"Associate the security profile. Apply it to all instances or limit it to specific instances using a tag.",content:e.jsxs(e.Fragment,{children:[r&&e.jsxs(l.Notification,{severity:"negative",inline:!0,title:"Associated instances limit reached:",children:["You've reached the limit of"," ",e.jsxs("strong",{children:[J," associated instances"]}),". Decrease the number of associated instances."]}),e.jsx(Re,{formik:t})]}),submitButtonText:"Next"}}const ze="_description_lcyzv_1",Ue="_link_lcyzv_6",ee={description:ze,link:Ue},A=({className:t,description:s,label:i,link:r})=>e.jsxs(e.Fragment,{children:[e.jsx("p",{className:ie("u-no-margin--bottom",t),children:i}),e.jsxs("small",{className:ee.description,children:[s,r&&e.jsx("a",{className:ee.link,href:r,target:"_blank",rel:"noreferrer",onClick:o=>{o.stopPropagation()},children:"learn more"})]})]});function He(t,s){const i=async o=>{await t.setFieldValue("tailoring_file",o[0])},r=async()=>{await t.setFieldValue("tailoring_file",null)};return{isValid:!t.errors.benchmark&&!t.errors.mode,isLoading:!1,description:"Select a security profile benchmark, choose the profile mode, and optionally upload a tailoring file to customize the security profile.",content:e.jsxs(e.Fragment,{children:[!s&&e.jsx(l.Notification,{severity:"caution",title:"Changes restricted:",inline:!0,children:"After profile creation, the security profile benchmark and mode cannot be changed. Please review before proceeding."}),e.jsx(l.CustomSelect,{label:"Base profile",disabled:s,options:[{label:e.jsx(A,{className:"u-no-padding--top",label:P.cis_level1_workstation,description:"Center for Internet Security",link:"https://ubuntu.com/security/cis"}),value:"cis_level1_workstation",text:P.cis_level1_workstation},{label:e.jsx(A,{className:"u-no-padding--top",label:P.cis_level1_server,description:"Center for Internet Security",link:"https://ubuntu.com/security/cis"}),value:"cis_level1_server",text:P.cis_level1_server},{label:e.jsx(A,{className:"u-no-padding--top",label:P.cis_level2_workstation,description:"Center for Internet Security",link:"https://ubuntu.com/security/cis"}),value:"cis_level2_workstation",text:P.cis_level2_workstation},{label:e.jsx(A,{className:"u-no-padding--top",label:P.cis_level2_server,description:"Center for Internet Security",link:"https://ubuntu.com/security/cis"}),value:"cis_level2_server",text:P.cis_level2_server},{label:e.jsx(A,{className:"u-no-padding--top",label:P.disa_stig,description:"Defense Information System Agency (DISA) for the U.S. Department of Defense (DoD)",link:"https://ubuntu.com/security/disa-stig"}),value:"disa_stig",text:P.disa_stig}],value:t.values.benchmark??"",onChange:async o=>t.setFieldValue("benchmark",o),required:!0,searchable:"never"}),e.jsx(l.CustomSelect,{label:"Mode",disabled:s,options:[{label:e.jsx(A,{className:"u-no-padding--top",label:T.audit,description:"Generates an audit without applying any fixes or remediation."}),value:"audit",text:T.audit},{label:e.jsx(A,{className:"u-no-padding--top",label:T["audit-fix"],description:"Applies fixes and generates an audit after remediation."}),value:"audit-fix",text:T["audit-fix"]},{label:e.jsx(A,{className:"u-no-padding--top",label:T["audit-fix-restart"],description:`Applies fixes, requires a machine restart, and generates an
                  audit after remediation.`}),value:"audit-fix-restart",text:T["audit-fix-restart"]}],value:t.values.mode??"",onChange:async o=>t.setFieldValue("mode",o),required:!0}),e.jsx(Le,{label:"Upload tailoring file",disabled:s,accept:".xml",...t.getFieldProps("tailoring_file"),help:e.jsxs(e.Fragment,{children:["Customize your security profile by adjusting or disabling rules to fit your system while staying compliant.",e.jsx("br",{}),"Max file size: 5mb. Supported format: .xml."]}),onFileRemove:r,onFileUpload:i})]}),submitButtonText:"Next"}}const Qe="_body_ybcyh_1",We="_header_ybcyh_5",Ke="_description_ybcyh_11",Je="_line_ybcyh_16",Ze="_smallCard_ybcyh_23",Xe="_children_ybcyh_30",F={body:Qe,header:We,description:Ke,line:Je,smallCard:Ze,children:Xe},ue=({cards:t})=>e.jsxs(e.Fragment,{children:[e.jsx("div",{className:F.smallCard,children:"Start"}),e.jsx("div",{className:F.line}),t.map((s,i)=>e.jsxs("div",{children:[e.jsx(l.Card,{className:"u-no-margin--bottom",children:e.jsxs("div",{children:[e.jsxs("div",{className:F.header,children:[e.jsx(l.Icon,{name:s.iconName}),e.jsx("p",{className:"u-no-margin--bottom u-no-padding--top",children:e.jsx("strong",{children:s.header})})]}),e.jsxs("div",{className:F.body,children:[e.jsx("p",{className:"u-no-margin--bottom u-no-padding--top",children:e.jsx("small",{className:F.description,children:s.description})}),s.children&&e.jsx("div",{className:F.children,children:s.children})]})]})}),e.jsx("div",{className:F.line})]},i)),e.jsx("div",{className:F.smallCard,children:"End"})]});function et(t){return{isValid:!0,isLoading:!1,description:`This will ${ne([t.values.mode!="audit"?"apply fixes":null,t.values.mode=="audit-fix-restart"?"restart instances":null,"generate an audit"].filter(s=>s!=null))} on the selected next run date.`,content:e.jsx(ue,{cards:[{header:"Next run date",description:e.jsxs(e.Fragment,{children:["Security profile's next run date arrives",e.jsx("br",{}),g(t.values.start_date).format(`${V}`)]}),iconName:"revisions"},t.values.mode!="audit"?{header:"Apply fixes",description:"Security profile will attempt to apply remediations before the next audit, helping maintain instances' compliance with the security profile.",iconName:"open-terminal"}:null,t.values.mode=="audit-fix-restart"?{header:"Restart instances",description:"To complete the fixes, instances must be restarted.",iconName:"restart",children:e.jsxs(y,{children:[e.jsx(y.Item,{label:"Delivery time",large:!0,value:t.values.delivery_time==="asap"?"As soon as possible":`Delayed by ${t.values.restart_deliver_delay} ${R(t.values.restart_deliver_delay,"hour")}`}),e.jsx(y.Item,{label:"Randomize delivery over a time window",large:!0,value:t.values.randomize_delivery===!0?`Yes, over ${t.values.deliver_delay_window} ${R(t.values.deliver_delay_window,"minute")}`:"No"})]})}:null,{header:"Generate an audit",description:"Security profile will generate an audit for all instances associated, aggregated in the audit view to show pass/fail results and allow detailed inspection.",iconName:"file-blank"}].filter(s=>s!=null)}),submitButtonText:"Add"}}function tt(t,s){const{isSelfHosted:i}=he(),{getOrganisationPreferences:r}=Ce(),{getAccessGroupQuery:o}=de(),{data:d,isLoading:c}=o({},{enabled:s==="add"}),{data:a,isLoading:m}=r(),f=()=>{const h=a?.data.audit_retention_period;return!h||h===-1?"Infinite":`${h} ${R(h,"day")}`};return{isLoading:c||m,isValid:!t.errors.title,description:"Choose a descriptive title and the right access group for your security profile.",content:e.jsxs(e.Fragment,{children:[e.jsx(l.Input,{type:"text",label:"Title",...t.getFieldProps("title"),error:I(t,"title"),required:!0}),e.jsx(l.Select,{label:"Access group",options:d?.data.map(h=>({label:h.title,value:h.name})),...t.getFieldProps("access_group"),error:I(t,"access_group"),required:!0,disabled:c||s==="edit"}),i&&e.jsx(l.Input,{type:"text",label:"Audit retention",required:!0,disabled:!0,value:f(),help:"You can change this limit in the Landscape server configuration file."})]}),submitButtonText:"Next"}}const it=({formik:{values:t,...s}})=>{switch(t.unit_of_time){case"WEEKLY":return e.jsx(Z,{variant:"condensed",label:"On",items:[...U],selectedItems:U.filter(({value:i})=>t.days.includes(i)),onItemsUpdate:async i=>s.setFieldValue("days",i.map(({value:r})=>r)),isSortedAlphabetically:!1,hasSelectedItemsFirst:!1,required:!0});case"MONTHLY":return!!t.start_date&&e.jsx(l.Select,{label:"On",options:ve(new Date(t.start_date)),...s.getFieldProps("day_of_month_type"),required:!0});case"YEARLY":return e.jsx(Z,{variant:"condensed",label:"On",items:[...X],selectedItems:X.filter(({value:i})=>t.months.includes(i)),onItemsUpdate:async i=>s.setFieldValue("months",i.map(({value:r})=>r)),isSortedAlphabetically:!1,hasSelectedItemsFirst:!1,required:!0});default:return null}},st=({formik:t})=>{const s=g().format(Q);switch(t.values.start_type){case"on-a-date":return e.jsx(l.Input,{type:"datetime-local",label:"Date",min:s,...t.getFieldProps("start_date"),error:I(t,"start_date"),required:!0});case"recurring":return e.jsxs(e.Fragment,{children:[e.jsx(l.Input,{type:"datetime-local",label:"Start date",min:s,...t.getFieldProps("start_date"),error:I(t,"start_date"),required:!0}),e.jsxs(l.Row,{className:"u-no-padding",children:[e.jsx(l.Col,{size:6,children:e.jsx(l.Input,{...t.getFieldProps("every"),type:"number",label:"Repeat every",min:t.values.unit_of_time==="DAILY"?7:1,error:I(t,"every"),required:!0})}),e.jsx(l.Col,{size:6,children:e.jsx(l.Select,{label:"Repeat every",options:[{label:"Day",value:"DAILY"},{label:"Week",value:"WEEKLY"},{label:"Month",value:"MONTHLY"},{label:"Year",value:"YEARLY"}].map(i=>t.values.every==1?i:{...i,label:`${i.label}s`}),...t.getFieldProps("unit_of_time"),required:!0})})]}),e.jsx(it,{formik:t}),e.jsx(l.Select,{label:"Ends",options:[{label:"Never",value:"never"},{label:"On a date",value:"on-a-date"}],...t.getFieldProps("end_type"),required:!0}),t.values.end_type=="on-a-date"&&e.jsx(l.Input,{type:"datetime-local",label:"End date",min:t.values.start_date,...t.getFieldProps("end_date"),error:I(t,"end_date"),required:!0})]})}},at=({formik:t})=>e.jsxs(e.Fragment,{children:[e.jsx(l.Select,{label:"Schedule",options:[{label:"Select",value:"",hidden:!0},{label:"On a date",value:"on-a-date"},{label:"Recurring",value:"recurring"}],...t.getFieldProps("start_type"),required:!0}),e.jsx(Ee,{children:e.jsx(st,{formik:t})})]}),rt="_inputContainer_1k4iz_1",nt="_input_1k4iz_1",lt="_inputDescription_1k4iz_10",G={inputContainer:rt,input:nt,inputDescription:lt};function ot(t){return{isValid:!t.errors.start_type&&!t.errors.start_date&&!t.errors.every&&!t.errors.end_date&&!t.errors.deliver_delay_window&&!t.errors.restart_deliver_delay,isLoading:!1,description:"Add a schedule for the security profile. Select a specific date or a recurring schedule for continuous audit generation.",content:e.jsxs(e.Fragment,{children:[e.jsx(at,{formik:t}),t.values.mode=="audit-fix-restart"&&e.jsxs(e.Fragment,{children:[e.jsx(A,{label:"Restart schedule",description:"You can choose when to perform the required restart."}),e.jsx(z,{field:"delivery_time",formik:t,label:"Delivery time",inputs:[{label:"As soon as possible",key:"asap",value:"asap"},{label:"Delayed",value:"delayed",key:"delayed",expansion:e.jsxs("div",{className:G.inputContainer,children:[e.jsx(l.Input,{type:"number",required:!0,className:G.input,...t.getFieldProps("restart_deliver_delay"),error:I(t,"restart_deliver_delay")}),e.jsx("span",{className:G.inputDescription,children:"hours"})]})}]}),e.jsx(qe,{formik:t})]})]}),submitButtonText:"Next"}}const pe=({initialValues:t,mutate:s,benchmarkStepDisabled:i,onSuccess:r=()=>{},formMode:o})=>{const d=W(),{setPageParams:c}=N(),a=se({initialValues:t,validateOnMount:!0,validationSchema:re().shape({...Be,benchmark:B().required("This field is required."),end_date:B().when(["start_date","start_type","end_type"],([n,p,_],x)=>p=="recurring"&&_=="on-a-date"?x.required("This field is required.").test({test:b=>g(b).isAfter(g(n)),message:"The end date must be after the start date."}):x),every:k().when("start_type",([n],p)=>n=="recurring"?p.required("This field is required.").positive("Enter a positive number.").integer("Enter an integer.").when("unit_of_time",([_])=>_==="DAILY"?p.min(7,"Enter an interval of at least 7 days."):p):p),mode:B().required("This field is required."),deliver_delay_window:k().when(["mode","randomize_delivery"],([n,p],_)=>n=="audit-fix-restart"&&p==!0?_.required("This field is required.").positive("Enter a positive number.").integer("Enter an integer."):_),restart_deliver_delay:k().when(["mode","delivery_time"],([n,p],_)=>n=="audit-fix-restart"&&p=="delayed"?_.required("This field is required.").positive("Enter a positive number.").integer("Enter an integer."):_),start_date:B().required("This field is required."),title:B().required("This field is required.")}),onSubmit:async n=>{if(!n.benchmark||!n.mode)return;const p=[];if(n.start_type=="recurring"){switch(p.push(`FREQ=${n.unit_of_time}`,`INTERVAL=${n.every}`),n.unit_of_time){case"WEEKLY":{p.push(`BYDAY=${n.days.join(",")}`);break}case"MONTHLY":{const _=new Date(n.start_date),x=_.getDate();switch(n.day_of_month_type){case"day-of-month":{p.push(`BYMONTHDAY=${x}`);break}case"day-of-week":{const b=Math.ceil(x/7),j=Se(_);p.push(`BYDAY=${b>4?-1:b}${U[j].value}`);break}}break}case"YEARLY":{p.push(`BYMONTH=${n.months.join(",")}`);break}}n.end_type=="on-a-date"&&p.push(`UNTIL=${g(n.end_date).format("YYYYMMDDTHHmmss")}Z`)}else p.push("FREQ=WEEKLY","COUNT=1");try{await s({access_group:n.access_group==ae?void 0:n.access_group,all_computers:n.all_computers||void 0,benchmark:n.benchmark,mode:n.mode,restart_deliver_delay_window:n.mode=="audit-fix-restart"?n.deliver_delay_window:void 0,restart_deliver_delay:n.mode=="audit-fix-restart"?n.restart_deliver_delay:void 0,schedule:p.join(";"),start_date:`${g(n.start_date).format(Q)}Z`,tags:n.all_computers?void 0:n.tags,tailoring_file:await n.tailoring_file?.text(),title:n.title})}catch(_){d(_);return}c({sidePath:[],profile:""}),r(n)}}),m=tt(a,o),f=He(a,i),h=ot(a),u=Ve(a),S=et(a);return{formik:a,steps:[m,f,h,u,S]}},dt="_step_koqdi_1",ct={step:dt},oi=({onSuccess:t})=>{const{notify:s}=Y(),{createPageParamsSetter:i}=N(),{addSecurityProfile:r,isSecurityProfileAdding:o}=ce(),[d,c]=L.useState(0),{formik:a,steps:m}=pe({formMode:"add",initialValues:{all_computers:!1,access_group:ae,day_of_month_type:"day-of-month",days:[],delivery_time:"asap",end_date:"",end_type:"never",every:7,months:[],randomize_delivery:!1,deliver_delay_window:1,restart_deliver_delay:1,start_date:g().utc().format(Q),start_type:"on-a-date",tags:[],tailoring_file:null,title:"",unit_of_time:"DAILY"},mutate:async u=>{r({access_group:u.access_group,all_computers:u.all_computers,benchmark:u.benchmark,mode:u.mode,restart_deliver_delay:u.restart_deliver_delay,restart_deliver_delay_window:u.restart_deliver_delay_window,schedule:u.schedule,start_date:u.start_date,tags:u.tags,tailoring_file:u.tailoring_file,title:u.title})},onSuccess:u=>{le(u,s),t(u)}}),f=()=>{d!==0&&c(d-1)},h=()=>{d<m.length-1?c(d+1):a.handleSubmit()};return e.jsxs(e.Fragment,{children:[e.jsxs(v.Header,{children:["Add security profile",e.jsxs("small",{className:ie(ct.step,"u-text--muted"),children:["Step ",d+1," of ",m.length]})]}),e.jsxs(v.Content,{children:[e.jsx("p",{children:m[d].description}),m[d].content,e.jsx(E,{hasBackButton:d>0,onBackButtonPress:d>0?f:void 0,onSubmit:h,submitButtonDisabled:m[d].isLoading||!m[d].isValid||o,submitButtonLoading:m[d].isLoading||o,submitButtonText:m[d].submitButtonText,onCancel:i({sidePath:[]})})]})]})},q=()=>{const{profile:t}=N(),{isGettingSecurityProfile:s,securityProfile:i,securityProfileError:r}=Me(parseInt(t));if(r)throw r;return s?{securityProfile:void 0,isGettingSecurityProfile:!0}:{securityProfile:i,isGettingSecurityProfile:!1}},di=()=>{const{createSidePathPusher:t}=N(),{getAccessGroupQuery:s}=de(),{securityProfile:i,isGettingSecurityProfile:r}=q(),o=je(),{data:d,isPending:c}=s(),{value:a,setTrue:m,setFalse:f}=_e();return r||c?e.jsx(v.LoadingState,{}):e.jsxs(e.Fragment,{children:[e.jsx(v.Header,{children:i.title}),e.jsxs(v.Content,{children:[e.jsx("div",{className:"p-segmented-control",children:e.jsxs("div",{className:"p-segmented-control__list",children:[e.jsxs(l.Button,{className:"p-segmented-control__button",type:"button",hasIcon:!0,onClick:t("download"),children:[e.jsx(l.Icon,{name:"file-blank"}),e.jsx("span",{children:"Download audit"})]}),i.status!=="archived"&&e.jsxs(l.Button,{className:"p-segmented-control__button",type:"button",hasIcon:!0,onClick:t("edit"),children:[e.jsx(l.Icon,{name:"edit"}),e.jsx("span",{children:"Edit"})]}),i.status!=="archived"&&e.jsxs(l.Button,{className:"p-segmented-control__button",type:"button",hasIcon:!0,onClick:t("run"),disabled:!i.associated_instances,children:[e.jsx(l.Icon,{name:"play"}),e.jsx("span",{children:"Run"})]}),e.jsxs(l.Button,{className:"p-segmented-control__button",type:"button",hasIcon:!0,onClick:t("duplicate"),disabled:o,children:[e.jsx(l.Icon,{name:"canvas"}),e.jsx("span",{children:"Duplicate"})]}),i.status!=="archived"&&e.jsxs(l.Button,{className:"p-segmented-control__button",type:"button",hasIcon:!0,onClick:m,children:[e.jsx(l.Icon,{name:"archive"}),e.jsx("span",{children:"Archive"})]})]})}),e.jsxs(C,{children:[e.jsx(C.Item,{children:e.jsxs(y,{children:[e.jsx(y.Item,{label:"Title",value:i.title}),e.jsx(y.Item,{label:"Name",value:i.name}),e.jsx(y.Item,{label:"Access group",value:fe(i.access_group,d)}),e.jsx(y.Item,{label:"Status",value:Pe(i).label})]})}),e.jsx(C.Item,{title:"Security profile",children:e.jsxs(y,{children:[e.jsx(y.Item,{label:"Benchmark",value:P[i.benchmark]}),e.jsx(y.Item,{label:"Tailoring file",value:Ie(i)}),e.jsx(y.Item,{label:"Mode",large:!0,value:T[i.mode]})]})}),e.jsx(C.Item,{title:"Schedule",children:e.jsxs(y,{children:[e.jsx(y.Item,{label:"Schedule",large:!0,value:we(i)}),e.jsx(y.Item,{label:"Last run",value:i.last_run_results.timestamp?`${g(i.last_run_results.timestamp).format(V)} GMT`:null}),e.jsx(y.Item,{label:"Next run",value:i.next_run_time?`${g(i.next_run_time).format(V)} GMT`:null}),i.mode==="audit-fix-restart"&&e.jsx(y.Item,{label:"Restart schedule",large:!0,value:`${i.restart_deliver_delay?`Delayed by ${i.restart_deliver_delay} ${R(i.restart_deliver_delay,"hour")}`:"As soon as possible"}${i.restart_deliver_delay_window?`, randomize delivery over ${i.restart_deliver_delay_window} ${R(i.restart_deliver_delay_window,"minute")}`:""}`})]})}),e.jsx(C.Item,{title:"Association",children:e.jsx(Ye,{profile:i,children:e.jsxs(y,{children:[e.jsx(y.Item,{label:"Associated instances",large:!0,value:e.jsx($e,{count:i.associated_instances,profile:i,query:`security:${i.id}`})}),e.jsx(y.Item,{label:"Tags",large:!0,value:i.tags.join(", "),type:"truncated"})]})})})]})]}),e.jsx(Ae,{close:f,opened:a,profile:i})]})},ut="_dateRange_1sfaj_1",pt="_date_1sfaj_1",mt="_separator_1sfaj_9",O={dateRange:ut,date:pt,separator:mt},yt=({securityProfile:t})=>{const s=W(),{sidePath:i,popSidePath:r,createPageParamsSetter:o}=N(),{getSingleActivityQuery:d}=Oe(),{getSecurityProfileReport:c,isSecurityProfileReportLoading:a}=ke(),m=Ne(),[f,h]=L.useState({type:"okay"}),u=JSON.parse(localStorage.getItem("_landscape_pendingSecurityProfileReports")??"[]"),{id:S}=t,w=u.find(b=>b.profileId==S),{data:n,isLoading:p,isError:_}=d({activityId:w?.activityId??0},{enabled:!!w&&f.type=="pending",refetchInterval:1e3});_&&f.type!="error"&&h({type:"error"}),L.useEffect(()=>{n&&(n.data.activity_status=="succeeded"?h({type:"ready",report_uri:n.data.result_text}):h({type:"pending"}))},[n]);const x=se({initialValues:{audit_timeframe:"specific-date",end_date:g().format(D),start_date:g().format(D),level_of_detail:"summary-only"},validateOnMount:!0,validationSchema:re().shape({end_date:B().when(["audit_timeframe","start_date"],([b,j],K)=>b=="date-range"?K.required("This field is required.").test({test:M=>g(M).isSameOrAfter(g(j)),message:"The end date must not be before the start date."}).test({test:M=>g(M).utc(!0).isSameOrBefore(g()),message:"The end date must not be in the future."}):K),start_date:B().required("This field is required.").test({test:b=>g(b).utc(!0).isSameOrBefore(g()),message:"The date must not be in the future."})}),onSubmit:async b=>{try{const j=(await c({id:S,detailed:b.level_of_detail=="detailed-view"||void 0,end_date:b.end_date,start_date:b.start_date})).data;if(j.activity_status=="succeeded"){h({type:"ready",report_uri:j.result_text});return}h({type:"pending"}),w?w.activityId=j.id:u.push({activityId:j.id,profileId:S}),localStorage.setItem("_landscape_pendingSecurityProfileReports",JSON.stringify(u))}catch(j){s(j);return}}});return p?e.jsx(ge,{}):e.jsxs(e.Fragment,{children:[f.type=="pending"&&e.jsx(l.Notification,{inline:!0,title:"Your audit is being generated:",children:"Depending on the size and complexity of the audit, this may take up to 5 minutes."}),f.type=="ready"&&e.jsxs(l.Notification,{inline:!0,title:"Your requested audit is ready:",onDismiss:()=>{const b=u.findIndex(j=>j.profileId==S);h({type:"okay"}),b!=-1&&(u.splice(b,1),u.length?localStorage.setItem("_landscape_pendingSecurityProfileReports",JSON.stringify(u)):localStorage.removeItem("_landscape_pendingSecurityProfileReports"))},children:["It has been successfully generated and is now available for download."," ",e.jsx(l.Button,{appearance:"link",type:"button",className:"u-no-margin--bottom u-no-padding--top",onClick:()=>{m(f.report_uri)},children:"Download audit"})]}),e.jsx("p",{children:"Customize the audit by selecting the scope and the timeframe."}),e.jsx(z,{label:"Audit timeframe",field:"audit_timeframe",formik:x,inputs:[{key:"specific-date",value:"specific-date",label:"Specific date",expansion:e.jsx(l.Input,{type:"date",...x.getFieldProps("start_date"),error:I(x,"start_date"),max:g().utc().format(D)})},{key:"date-range",value:"date-range",label:"Date range",expansion:e.jsxs("div",{className:O.dateRange,children:[e.jsx("div",{className:O.date,children:e.jsx(l.Input,{type:"date",...x.getFieldProps("start_date"),error:I(x,"start_date"),max:g(x.values.end_date).utc().format(D)})}),e.jsx("span",{className:O.separator,children:"-"}),e.jsx("div",{className:O.date,children:e.jsx(l.Input,{type:"date",...x.getFieldProps("end_date"),error:I(x,"end_date"),max:g().utc().format(D),min:g(x.values.start_date).format(D)})})]})}]}),e.jsx(z,{label:"Level of detail",field:"level_of_detail",formik:x,inputs:[{key:"summary-only",value:"summary-only",label:"Summary only",help:"High-level overview of audit results"},{key:"detailed-view",value:"detailed-view",label:"Detailed view",help:"Includes rules ID, severity, identifiers and references, description, rationale"}]}),e.jsx(E,{onSubmit:()=>{x.handleSubmit()},submitButtonDisabled:!x.isValid||a,submitButtonLoading:a,submitButtonText:"Generate CSV",hasBackButton:i.length>1,onBackButtonPress:r,onCancel:o({sidePath:[],profile:""})})]})},ci=()=>{const{securityProfile:t,isGettingSecurityProfile:s}=q();return s?e.jsx(v.LoadingState,{}):e.jsxs(e.Fragment,{children:[e.jsxs(v.Header,{children:["Download audit for ",t.title," security profile"]}),e.jsx(v.Content,{children:e.jsx(yt,{securityProfile:t})})]})},ht="_container_6gega_1",_t={container:ht},me=({getConfirmationStepDisabled:t=()=>!1,confirmationStepDescription:s,submitButtonText:i="",submitting:r=!1,hasBackButton:o,onBackButtonPress:d,...c})=>{const{createPageParamsSetter:a}=N(),{formik:m,steps:f}=pe(c),[h,u]=L.useState(!1),S=()=>{m.handleSubmit()},w=()=>{if(t(m.values)){S();return}u(!0)},n=()=>{u(!1)};if(h){const _=f[4];return e.jsxs(e.Fragment,{children:[e.jsxs("p",{children:[s," This will"," ",ne([m.values.mode!="audit"?"apply fixes":null,m.values.mode=="audit-fix-restart"?"restart instances":null,"generate an audit"].filter(x=>x!=null))," ","on the selected next run date."]}),_.content,e.jsx(E,{hasBackButton:!0,onBackButtonPress:n,onSubmit:S,submitButtonDisabled:!!_.isLoading||r,submitButtonLoading:_.isLoading||r,submitButtonText:i,onCancel:a({sidePath:[],profile:""})})]})}return e.jsxs(e.Fragment,{children:[f[0].content,f.slice(1,-1).map((p,_)=>e.jsx("div",{className:_t.container,children:p.content},_)),e.jsx(E,{onSubmit:w,submitButtonDisabled:!m.isValid||r,submitButtonLoading:f.some(p=>p.isLoading)||r,submitButtonText:i,hasBackButton:o,onBackButtonPress:d,onCancel:a({sidePath:[],profile:""})})]})},ui=()=>{const{notify:t}=Y(),{sidePath:s,popSidePath:i}=N(),{securityProfile:r,isGettingSecurityProfile:o}=q(),{addSecurityProfile:d,isSecurityProfileAdding:c}=ce();return o?e.jsx(v.LoadingState,{}):e.jsxs(e.Fragment,{children:[e.jsxs(v.Header,{children:["Duplicate ",r.title]}),e.jsxs(v.Content,{children:[e.jsx(me,{formMode:"add",confirmationStepDescription:"To duplicate the profile, you need to run it.",initialValues:{...oe(r),title:`${r.title} copy`},mutate:async a=>{d({access_group:a.access_group,all_computers:a.all_computers,benchmark:a.benchmark,mode:a.mode,restart_deliver_delay:a.restart_deliver_delay,restart_deliver_delay_window:a.restart_deliver_delay_window,schedule:a.schedule,start_date:a.start_date,tags:a.tags,tailoring_file:a.tailoring_file,title:a.title})},onSuccess:a=>{le(a,t)},submitButtonText:"Duplicate",submitting:c,hasBackButton:s.length>1,onBackButtonPress:i}),";"]})]})},pi=()=>{const{notify:t}=Y(),{sidePath:s,popSidePath:i}=N(),{securityProfile:r,isGettingSecurityProfile:o}=q(),{updateSecurityProfile:d,isSecurityProfileUpdating:c}=Ge();return o?e.jsx(v.LoadingState,{}):e.jsxs(e.Fragment,{children:[e.jsxs(v.Header,{children:["Edit ",r.title]}),e.jsx(v.Content,{children:e.jsx(me,{formMode:"edit",benchmarkStepDisabled:!0,confirmationStepDescription:"To save your changes, you need to run the profile.",getConfirmationStepDisabled:a=>a.mode=="audit",initialValues:oe(r),mutate:async a=>{d({id:r.id,all_computers:a.all_computers,restart_deliver_delay:a.restart_deliver_delay,restart_deliver_delay_window:a.restart_deliver_delay_window,schedule:a.schedule,tags:a.tags,title:a.title})},onSuccess:a=>{t.success({title:`You have successfully saved changes for ${a.title} security profile.`,message:"Your changes have been saved successfully."})},submitButtonText:"Save changes",submitting:c,hasBackButton:s.length>1,onBackButtonPress:i})})]})},mi=()=>{const t=W(),s=xe(),{notify:i}=Y(),{sidePath:r,popSidePath:o,createPageParamsSetter:d}=N(),{securityProfile:c,isGettingSecurityProfile:a}=q(),{runSecurityProfile:m}=Fe();if(a)return e.jsx(v.LoadingState,{});const f=d({sidePath:[],profile:""}),h=async u=>{u.preventDefault();try{const{data:S}=await m({id:c.id});f();const w=Te(c.mode);i.success({title:`You have successfully initiated run of the ${c.title} security profile`,message:w,actions:[{label:"View details",onClick:()=>{s(be.activities.root({query:`parent-id:${S.id}`}))}}]})}catch(S){t(S)}};return e.jsxs(e.Fragment,{children:[e.jsxs(v.Header,{children:['Run "',c.title,'" profile']}),e.jsx(v.Content,{children:e.jsxs(l.Form,{style:{display:"flex",flexDirection:"column"},onSubmit:h,children:[e.jsx("p",{children:"Running this profile will apply remediation fixes to the associated instances, restart them, and generate an audit. Proceed to execute the run manually."}),e.jsx(ue,{cards:[{header:"Apply fixes",description:"Security profile will attempt to apply remediations before the next audit, helping maintain instances' compliance with the security profile.",iconName:"open-terminal"},{header:"Restart instances",description:"To complete the fixes, instances must be restarted.",iconName:"restart",children:e.jsxs(y,{children:[e.jsx(y.Item,{label:"Delivery time",large:!0,value:c.restart_deliver_delay===0?"As soon as possible":`Delayed by ${c.restart_deliver_delay} ${R(c.restart_deliver_delay,"hour")}`}),e.jsx(y.Item,{label:"Randomize delivery over a time window",large:!0,value:c.restart_deliver_delay_window?`Yes, over ${c.restart_deliver_delay_window} ${R(c.restart_deliver_delay_window,"minute")}`:"No"})]})},{header:"Generate an audit",description:"Security profile will generate an audit for all instances associated, aggregated in the audit view to show pass/fail results and allow detailed inspection.",iconName:"file-blank"}].filter(u=>c.mode.includes("restart")||u.header!=="Restart instances")}),e.jsx(E,{submitButtonDisabled:!1,submitButtonText:"Run",onCancel:f,hasBackButton:r.length>1,onBackButtonPress:o})]})})]})};export{_i as ACTIVE_SECURITY_PROFILES_LIMIT,J as SECURITY_PROFILE_ASSOCIATED_INSTANCES_LIMIT,oi as SecurityProfileAddSidePanel,di as SecurityProfileDetailsSidePanel,ci as SecurityProfileDownloadAuditSidePanel,ui as SecurityProfileDuplicateSidePanel,pi as SecurityProfileEditSidePanel,me as SecurityProfileForm,mi as SecurityProfileRunFixSidePanel,bi as SecurityProfilesContainer,vi as SecurityProfilesHeader,Si as SecurityProfilesList,fi as useGetOverLimitSecurityProfiles,gi as useGetSecurityProfiles,je as useIsSecurityProfilesLimitReached,Ge as useUpdateSecurityProfile};
