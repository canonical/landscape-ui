import{v as T,f as W,w as _,c as $,z as q,B as D,r as j,C as L,p as z,J as H,i as V,j as e,d as i,X as B,u as P,I as S,e as U}from"./index-Dfc97QGW.js";import{P as Y,a as G,b as J}from"./PageMain-LS0GxKmV.js";import{s as x}from"./constants-BOGKJCKf.js";import{I as A}from"./InfoItem-DImpX37B.js";import{u as X}from"./useFetchOld-BgGVMMmJ.js";import{M as O}from"./MultiSelectField-fcXogomg.js";import{g as Z}from"./formikErrors-Bw8iTXYS.js";import{R as ee}from"./ResponsiveTable-ViIMTRR6.js";import{u as se}from"./useGetTags-oA_gPXb8.js";import"./constants-BTpoIHxf.js";import"./NoData-DMN9LLPq.js";import"./index-S_kjB96R.js";import"./TablePagination-B0v8QAQr.js";import"./TableFilterChips-DXWGZ6VK.js";import"./PageParamFilter-C5PJgjVf.js";import"./TableFilter-BmLRyeMD.js";import"./Truncated-D8EZCoK1.js";const E=s=>s?"Yes":"No";function w(){const s=T(),a=W(),n=X(),r=()=>$({queryKey:["alert"],queryFn:async()=>a.get("alerts")}),u=_({mutationKey:["alert","subscribe"],mutationFn:async o=>n.get("SubscribeToAlert",{params:o}),onSuccess:async()=>s.invalidateQueries({queryKey:["alert"]})}),d=_({mutationKey:["alert","unsubscribe"],mutationFn:async o=>n.get("UnsubscribeFromAlert",{params:o}),onSuccess:async()=>s.invalidateQueries({queryKey:["alert"]})}),m=_({mutationKey:["alert","associate"],mutationFn:async o=>n.get("AssociateAlert",{params:o}),onSuccess:async()=>s.invalidateQueries({queryKey:["alert"]})}),c=_({mutationKey:["alert","disassociate"],mutationFn:async o=>n.get("DisassociateAlert",{params:o}),onSuccess:async()=>s.invalidateQueries({queryKey:["alert"]})});return{getAlertsQuery:r,subscribeQuery:u,unsubscribeQuery:d,associateAlert:m,disassociateAlert:c}}const te="_footer_1qn3u_1",ae="_multiSelect_1qn3u_7",Q={footer:te,multiSelect:ae},M=(s,a)=>{const n=new Set(a);return s.filter(r=>!n.has(r))},I=({alert:s,availableTagOptions:a})=>{const n=q(),{notify:r}=D(),{associateAlert:u,disassociateAlert:d}=w(),m=j.useRef(null),{mutateAsync:c}=u,{mutateAsync:o}=d,p=s.all_computers?["All"]:s.tags,C=async({tags:l})=>{try{const b=M(s.tags,l),h=M(l,s.tags),F=l.includes("All"),R=s.all_computers&&!F;if(F)await c({name:s.alert_type,tags:void 0,all_computers:!0});else if(R)await Promise.all([c({name:s.alert_type,tags:l.filter(f=>f!=="All"),all_computers:!1}),o({name:s.alert_type,all_computers:!0})]);else{const f=[];h.length>0&&f.push(c({name:s.alert_type,tags:h,all_computers:!1})),b.length>0&&f.push(o({name:s.alert_type,tags:b,all_computers:!1})),await Promise.all(f)}r.success({title:"Alert tags updated",message:`You changed ${s.label}'s tags`})}catch(b){n(b)}},t=L({initialValues:{tags:p},validationSchema:z().shape({tags:H().of(V())}),onSubmit:C}),y=t.values.tags.includes("All")?a.filter(({value:l})=>l!=="All"):void 0,v=t.values.tags.includes("All")?a:a.filter(({value:l})=>t.values.tags.includes(l)),K=l=>{const b=l.some(({value:h})=>h==="All")?["All"]:l.map(({value:h})=>h);t.setValues({tags:b})};j.useEffect(()=>{const l=m.current?.querySelector(".multi-select__condensed-text");l&&l.textContent.includes("All instances")&&(l.textContent="All instances")},[t.values.tags]);const N=()=>t.isSubmitting?!0:p.length===t.values.tags.length&&p.every(l=>t.values.tags.includes(l));return e.jsx(i.Form,{onSubmit:t.handleSubmit,noValidate:!0,children:e.jsx(O,{innerRef:m,required:!0,variant:"condensed",className:Q.multiSelect,items:a,selectedItems:v,disabledItems:y,onItemsUpdate:K,placeholder:"Select tags",error:Z(t,"tags"),dropdownFooter:e.jsxs("div",{className:Q.footer,children:[e.jsx(i.Button,{type:"button",dense:!0,small:!0,className:"u-no-margin--bottom",disabled:N(),onClick:()=>t.setFieldValue("tags",p),children:"Revert"}),e.jsx(i.Button,{type:"button",dense:!0,small:!0,appearance:"positive",className:"u-no-margin--bottom",disabled:N(),onClick:()=>t.submitForm(),children:"Save changes"})]})})})},le="_noWrap_1ld5g_19",ne="_alertsWrapper_1ld5g_23",re="_emailColumn_1ld5g_31",ce="_nameColumn_1ld5g_35",oe="_tags_1ld5g_39",g={switch:"_switch_1ld5g_1",noWrap:le,alertsWrapper:ne,emailColumn:re,nameColumn:ce,tags:oe},ie=s=>{const a={};switch(s.column.id){case"label":a.role="rowheader";break;case"subscribed":a["aria-label"]="Email";break;case"tags":a["aria-label"]="Tags";break;case"description":a["aria-label"]="Description";break}return a},ue=({alerts:s,availableTagOptions:a})=>{const n=B("(min-width: 620px)"),r=q(),{unsubscribeQuery:u,subscribeQuery:d}=w(),{user:m}=P(),{mutateAsync:c}=d,{mutateAsync:o}=u,p=async t=>{const y=t.subscribed?o:c;try{await y({alert_type:t.alert_type})}catch(v){r(v)}},C=j.useMemo(()=>[{accessor:"label",className:g.nameColumn,Header:"Name"},{Header:e.jsxs("div",{className:g.noWrap,children:[e.jsx("span",{children:"Email "}),m&&e.jsx(i.Tooltip,{position:"btm-left",message:`Enabling email notifications will send alerts to ${m.email}, associated with your account`,children:e.jsx(i.Icon,{name:"help"})})]}),accessor:"subscribed",className:g.emailColumn,Cell:({row:t})=>e.jsx("div",{className:g.switch,children:e.jsx(i.Switch,{label:E(t.original.subscribed),defaultChecked:t.original.subscribed,onChange:()=>p(t.original)})})},{accessor:"tags",Header:"Enabled for",className:g.tags,Cell:({row:{original:t}})=>e.jsx(I,{alert:t,availableTagOptions:a})},{Header:"Description",accessor:"description",Cell:({row:{original:t}})=>e.jsx(e.Fragment,{children:t.description})}],[s]);return n?e.jsx(ee,{columns:C,data:s,getCellProps:ie,emptyMsg:"No data available"}):s.map((t,y)=>e.jsxs(i.Row,{className:S("u-no-padding--left u-no-padding--right",g.alertsWrapper),children:[e.jsx(i.Col,{size:2,small:2,children:e.jsx(A,{label:"Name",value:t.label})}),e.jsx(i.Col,{size:2,small:2,children:e.jsx(A,{label:"Email",value:e.jsx("div",{className:g.switch,children:e.jsx(i.Switch,{label:E(t.subscribed),defaultChecked:t.subscribed,onChange:()=>p(t)})})})}),e.jsx(i.Col,{size:2,small:2,children:e.jsx(A,{label:"Enabled for",value:e.jsx(I,{alert:t,availableTagOptions:a})})}),e.jsx(i.Col,{size:2,small:2,children:e.jsx(A,{label:"Description",value:t.description})})]},y))},me="_card_pmu7i_1",de="_content_pmu7i_7",k={card:me,content:de},pe=({alerts:s,availableTagOptions:a})=>{const{user:n}=P(),r=n?.accounts.find(u=>u.name===n.current_account);return e.jsxs("div",{className:S(x.card,k.card),children:[e.jsx("div",{className:x.header,children:e.jsx("p",{className:x.title,children:r?.title||"Alerts"})}),e.jsx("div",{className:S(x.content,k.content),children:e.jsx(ue,{alerts:s,availableTagOptions:a})})]})},Me=()=>{const{getAlertsQuery:s}=w(),{tags:a}=se(),{data:n,isLoading:r}=s(),u=j.useMemo(()=>n?.data.filter(c=>!c.alert_type.toUpperCase().includes("LICENSE"))??[],[n]),d=a.map(c=>({label:c,value:c,group:"Tags"}))??[],m=[{label:"All instances",value:"All"},...d];return e.jsxs(Y,{children:[e.jsx(G,{title:"Alerts"}),e.jsxs(J,{hasTable:!0,children:[r&&e.jsx(U,{}),!r&&u&&e.jsx(pe,{alerts:u,availableTagOptions:m})]})]})};export{Me as default};
