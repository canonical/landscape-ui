import{f as v,v as D,w as M,p as q,J as C,i as x,l as R,aD as H,aE as L,n as Q,ac as U,z as Y,s as S,B as z,C as K,j as e,aH as V,d as c,I as P,c as W,aI as X,g as J,aw as Z,o as ee,N as te}from"./index-DYykpNVa.js";import{S as m}from"./SidePanel-DVyPWXM9.js";import{A as oe}from"./AssociationBlock-Bs5is6Zl.js";import{g as _}from"./formikErrors-Bw8iTXYS.js";import{R as re}from"./RandomizationBlock-DjoHppMG.js";import{r as ie}from"./helpers-DblkVUdf.js";import{M as se}from"./MultiSelectField-85mhFA5_.js";import{S as ae}from"./SidePanelFormButtons-Aj5ThB2m.js";import{u as B}from"./useRoles-CK1OAvut.js";import{P as ne}from"./ProfileAssociatedInstancesLink-CRAimTVK.js";import{P as le}from"./ProfileAssociationInfo-3j9RTKgZ.js";import{B as y}from"./Blocks-C-bFP-tp.js";import{I as b}from"./InfoGrid-CVtcW3Y8.js";import{R as ce}from"./index-BelJ4njl.js";import{a as dt,b as ut,c as mt}from"./index-BelJ4njl.js";import"./useGetTags-BbkSXw8M.js";import"./RadioGroup-DD61dFf3.js";import"./SidePanelFormButtons.module-CcPyiogC.js";import"./useFetchOld-BGD2hIpr.js";import"./NoData-CT6SeJUX.js";import"./StaticLink-BX9qJBBO.js";import"./InfoItem-DMBAN7ig.js";import"./Truncated-DtD6hAHP.js";import"./PageMain-BnPck7ZK.js";import"./HeaderWithSearch-DH3OfcZg.js";import"./TableFilterChips-DLH4XQ-H.js";import"./constants-CXofZZ4i.js";import"./ResponsiveTable-C-8YbfBJ.js";import"./TruncatedCell-DQQZxgbr.js";import"./useExpandableRow-CGDZ27WS.js";import"./TextConfirmationModal-DuGXYB1S.js";import"./table-CdFwMAPu.js";function de(){const t=v(),o=D(),s=M({mutationKey:["rebootprofiles","create"],mutationFn:async n=>t.post("rebootprofiles",n),onSuccess:async()=>o.invalidateQueries({queryKey:["rebootprofiles"]})}),{mutateAsync:i,isPending:r}=s;return{createRebootProfile:i,isCreatingRebootProfile:r}}function ue(){const t=v(),o=D(),s=M({mutationKey:["rebootprofiles","edit"],mutationFn:async({id:n,...u})=>t.patch(`rebootprofiles/${n}`,u),onSuccess:async()=>o.invalidateQueries({queryKey:["rebootprofiles"]})}),{mutateAsync:i,isPending:r}=s;return{editRebootProfile:i,isEditingRebootProfile:r}}const E={add:"added",edit:"updated",duplicate:"added"},me={add:"Add reboot profile",duplicate:"Add reboot profile",edit:"Save changes"},F=[{label:"Sunday",order:0,value:"su"},{label:"Monday",order:1,value:"mo"},{label:"Tuesday",order:2,value:"tu"},{label:"Wednesday",order:3,value:"we"},{label:"Thursday",order:4,value:"th"},{label:"Friday",order:5,value:"fr"},{label:"Saturday",order:6,value:"sa"}],pe=`If Landscape cannot reboot the
associated instances by this point,
the reboot will be canceled.`,k=t=>{const o=new Map(t.split(";").map(u=>{const[f,g]=u.split("=",2);return[f.toUpperCase(),g]})),s=o.get("FREQ")?.toLowerCase()??"",i=parseInt(o.get("BYHOUR")??"",10),r=parseInt(o.get("BYMINUTE")??"",10),n=(o.get("BYDAY")??"").split(",").map(u=>u.toLowerCase());return{freq:s,at_hour:i,at_minute:r,on_days:n}},fe=t=>q().shape({...ie,title:x().test({name:"required",message:"This field is required.",test:o=>!!o||t!=="add"}),access_group:x(),all_computers:Q(),at_hour:R().required("Hour is required.").integer("Hour must be an integer.").min(0,"Hour must be between 0 and 23.").max(L,"Hour must be between 0 and 23."),at_minute:R().required("Minute is required.").integer("Minute must be an integer.").min(0,"Minute must be between 0 and 59.").max(H,"Minute must be between 0 and 59."),deliver_within:R().integer("'Expires after' must be an integer.").min(0,"'Expires after' must be at least 0."),tags:C().of(x()),on_days:C().of(x()).min(1,"At least one day must be selected.")}),be=t=>{if(t.action==="add")return{title:"",access_group:U,all_computers:!1,randomize_delivery:!1,deliver_delay_window:0,tags:[],at_hour:"",at_minute:"",deliver_within:0,on_days:[]};const{at_hour:o,at_minute:s,on_days:i}=k(t.profile.schedule);return{title:t.action==="duplicate"?`${t.profile.title} (copy)`:t.profile.title,access_group:t.profile.access_group,all_computers:t.profile.all_computers,randomize_delivery:!!t.profile.deliver_delay_window,deliver_delay_window:t.profile.deliver_delay_window||0,tags:t.profile.tags,at_hour:o,at_minute:s,deliver_within:t.profile.deliver_within,on_days:i}},he="_container_1bra5_1",_e="_timeContainer_1bra5_13",ge="_time_1bra5_13",xe="_timeInput_1bra5_27",Pe="_inputDescriptionAfter_1bra5_32",ye="_colon_1bra5_37",je="_tooltip_1bra5_43",Ie="_expiration_1bra5_47",p={container:he,timeContainer:_e,time:ge,timeInput:xe,inputDescriptionAfter:Pe,colon:ye,tooltip:je,expiration:Ie},A=t=>{const{getAccessGroupQuery:o}=B(),s=Y(),{sidePath:i,popSidePath:r,createPageParamsSetter:n}=S(),{notify:u}=z(),{data:f}=o(),{createRebootProfile:g,isCreatingRebootProfile:j}=de(),{editRebootProfile:I,isEditingRebootProfile:G}=ue(),$=f?.data.map(({name:l,title:h})=>({label:h,value:l}))??[],N=n({sidePath:[],profile:""}),a=K({initialValues:be(t),enableReinitialize:!0,onSubmit:async l=>{const h={all_computers:l.all_computers,at_hour:Number(l.at_hour),at_minute:Number(l.at_minute),deliver_delay_window:l.deliver_delay_window,deliver_within:l.deliver_within,every:"week",on_days:l.on_days,tags:l.tags,title:l.title};try{t.action==="edit"?await I({id:t.profile.id,...h}):await g({access_group:l.access_group,...h}),N(),u.success({message:`Reboot profile "${l.title}" has been ${E[t.action]} `,title:`Reboot profile ${E[t.action]}`})}catch(O){s(O)}},validationSchema:fe(t.action)}),d=[_(a,"at_hour"),_(a,"at_minute"),_(a,"deliver_within")];return e.jsx(V,{value:a,children:e.jsxs(c.Form,{onSubmit:a.handleSubmit,noValidate:!0,children:[e.jsx(c.Input,{type:"text",label:"Title",required:t.action==="add",...a.getFieldProps("title"),error:_(a,"title")}),e.jsx(c.Select,{label:"Access group","aria-label":"Access group",options:$,disabled:t.action==="edit",...a.getFieldProps("access_group"),error:_(a,"access_group")}),e.jsxs("div",{className:p.container,children:[e.jsx("p",{className:"p-heading--5",children:"Schedule"}),e.jsx(se,{variant:"condensed",label:"Days",items:F,selectedItems:F.filter(({value:l})=>a.values.on_days.includes(l)),onItemsUpdate:async l=>a.setFieldValue("on_days",l.map(({value:h})=>h)),isSortedAlphabetically:!1,hasSelectedItemsFirst:!1,error:_(a,"on_days")}),e.jsxs("div",{className:p.timeContainer,children:[e.jsxs("div",{className:p.time,children:[e.jsxs(e.Fragment,{children:[e.jsx(c.Input,{type:"number",label:"Time","aria-label":"at hour",placeholder:"HH",className:p.timeInput,wrapperClassName:P({"is-error":d[0]}),...a.getFieldProps("at_hour"),"aria-errormessage":d[0]?"hour-error":void 0}),e.jsx("span",{className:p.colon,children:":"})]}),e.jsx(c.Input,{type:"number",label:"At minute",labelClassName:"u-off-screen","aria-label":"at minute",className:p.timeInput,wrapperClassName:P({"is-error":d[1]}),placeholder:"MM",...a.getFieldProps("at_minute"),"aria-errormessage":d[1]?"minute-error":void 0}),e.jsx(c.Input,{type:"number",label:e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"Expires after "}),e.jsx(c.Tooltip,{message:pe,position:"top-right",tooltipClassName:p.tooltip,children:e.jsx(c.Icon,{name:"help"})})]}),wrapperClassName:P(p.expiration,{"is-error":d[2]}),className:p.timeInput,...a.getFieldProps("deliver_within"),"aria-errormessage":"expires-error"}),e.jsx("span",{className:p.inputDescriptionAfter,children:"hours"})]}),d.filter(Boolean).length>0&&e.jsxs("div",{className:P({"is-error":d.filter(Boolean).length>0}),children:[d[0]&&e.jsx("p",{className:"p-form-validation__message",id:"hour-error",children:e.jsx("span",{children:d[0]})}),d[1]&&e.jsx("p",{className:"p-form-validation__message",id:"minute-error",children:e.jsx("span",{children:d[1]})}),d[2]&&e.jsxs("p",{className:"p-form-validation__message",id:"expires-error",children:[e.jsx("strong",{children:"Error: "}),e.jsx("span",{children:d[2]})]})]})]}),e.jsx(re,{formik:a})]}),e.jsx(oe,{formik:a}),e.jsx(ae,{submitButtonText:me[t.action],submitButtonDisabled:a.isSubmitting||j||G,onCancel:N,hasBackButton:i.length>1,onBackButtonPress:r})]})})},it=()=>e.jsxs(e.Fragment,{children:[e.jsx(m.Header,{children:"Add reboot profile"}),e.jsx(m.Content,{children:e.jsx(A,{action:"add"})})]});function Re(t,o={}){const s=v(),{data:i,isPending:r,error:n}=W({queryKey:["rebootprofile",t.id],queryFn:async({signal:f})=>s.get("rebootprofiles",{signal:f}),...o}),u=i?.data.results.find(({id:f})=>f===t.id);return{rebootProfile:u,rebootProfileError:i&&!u?new Error("The reboot profile could not be found."):n,isGettingRebootProfile:r}}const w=()=>{const{profile:t}=S(),{isGettingRebootProfile:o,rebootProfile:s,rebootProfileError:i}=Re({id:parseInt(t)});if(i)throw i;return o?{rebootProfile:void 0,isGettingRebootProfile:!0}:{rebootProfile:s,isGettingRebootProfile:!1}},T={mo:"Monday",tu:"Tuesday",we:"Wednesday",th:"Thursday",fr:"Friday",sa:"Saturday",su:"Sunday"},ve=t=>t.length===2?`${t[0]} and ${t[1]}`:t.length>2?`${t.slice(0,-1).join(", ")}, and ${t[t.length-1]}`:t[0]??"",Se=t=>{const{freq:o,on_days:s}=k(t.schedule);if(o!=="weekly"||!s.length)return"One-time";const i=s.map(n=>n.toLowerCase()).filter(n=>X(T,n)).map(n=>T[n]);return`Every week on ${ve(i)}`},st=()=>{const{value:t,setFalse:o,setTrue:s}=J(),{createSidePathPusher:i}=S(),{rebootProfile:r,isGettingRebootProfile:n}=w(),{getAccessGroupQuery:u}=B(),{data:f,isPending:g}=u();if(n||g)return e.jsx(m.LoadingState,{});const j=i("edit"),I=i("duplicate");return e.jsxs(e.Fragment,{children:[e.jsx(m.Header,{children:r.title}),e.jsxs(m.Content,{children:[e.jsxs("div",{className:"p-segmented-control",children:[e.jsxs(c.Button,{type:"button",hasIcon:!0,className:"p-segmented-control__button",onClick:j,"aria-label":`Edit reboot profile ${r.title}`,children:[e.jsx(c.Icon,{name:"edit"}),e.jsx("span",{children:"Edit"})]}),e.jsxs(c.Button,{type:"button",hasIcon:!0,className:"p-segmented-control__button",onClick:I,"aria-label":`Edit reboot profile ${r.title}`,children:[e.jsx(c.Icon,{name:"canvas"}),e.jsx("span",{children:"Duplicate"})]}),e.jsxs(c.Button,{className:"p-segmented-control__button has-icon",type:"button",hasIcon:!0,onClick:s,"aria-label":`Remove reboot profile ${r.title}`,children:[e.jsx(c.Icon,{name:c.ICONS.delete}),e.jsx("span",{children:"Remove"})]})]}),e.jsxs(y,{children:[e.jsx(y.Item,{children:e.jsxs(b,{children:[e.jsx(b.Item,{label:"Title",value:r.title}),e.jsx(b.Item,{label:"Access group",value:Z(r.access_group,f)})]})}),e.jsx(y.Item,{title:"Reboot schedule",children:e.jsxs(b,{children:[e.jsx(b.Item,{label:"Schedule",large:!0,value:Se(r)}),e.jsx(b.Item,{label:"Next reboot",large:!0,value:ee(r.next_run).format(te)})]})}),e.jsx(y.Item,{title:"Association",children:e.jsx(le,{profile:r,children:e.jsxs(b,{children:[e.jsx(b.Item,{label:"Tags",large:!0,value:r.tags.join(", "),type:"truncated"}),e.jsx(b.Item,{label:"Associated instances",large:!0,value:e.jsx(ne,{profile:r,count:r.num_computers,query:`reboot:${r.id}`})})]})})})]})]}),e.jsx(ce,{close:o,opened:t,rebootProfile:r})]})},at=()=>{const{rebootProfile:t,isGettingRebootProfile:o}=w();return o?e.jsx(m.LoadingState,{}):e.jsxs(e.Fragment,{children:[e.jsxs(m.Header,{children:["Duplicate ",t.title]}),e.jsx(m.Content,{children:e.jsx(A,{action:"duplicate",profile:t})})]})},nt=()=>{const{rebootProfile:t,isGettingRebootProfile:o}=w();return o?e.jsx(m.LoadingState,{}):e.jsxs(e.Fragment,{children:[e.jsxs(m.Header,{children:["Edit ",t.title]}),e.jsxs(m.Content,{children:[e.jsx(A,{action:"edit",profile:t}),";"]})]})};export{it as RebootProfileAddSidePanel,st as RebootProfileDetailsSidePanel,at as RebootProfileDuplicateSidePanel,nt as RebootProfileEditSidePanel,dt as RebootProfilesContainer,A as RebootProfilesForm,ut as RebootProfilesHeader,mt as RebootProfilesList};
