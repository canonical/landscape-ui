import{f as W,c as $,X as D,Y as M,j as e,d as p,I as y,s as S,v as U,w as V,B as X,z as J,y as k,r as d,e as _,D as Y,q as ee,aL as se}from"./index-DYykpNVa.js";import{P as te,a as ae,b as ne}from"./PageMain-BnPck7ZK.js";import{u as oe}from"./useGetInstances-CQaSwVqm.js";import{y as re,E as ce,S as L,z as G,F as v,G as ie,J as le,M as ue}from"./InstancesPageActions-nbDXpXLr.js";import"./index-Cbj0Sz5k.js";import{u as de}from"./useSelection-B6RCntWn.js";import{a as pe}from"./TablePagination-CIA4CRba.js";import{P as F}from"./PageParamFilter-LH49uHXA.js";import{u as C,a as he}from"./TableFilterChips-DLH4XQ-H.js";import{T as b}from"./TableFilter-C7yTBfOe.js";import{S as me}from"./index-C2TKYmcI.js";import{u as z}from"./useFetchOld-BGD2hIpr.js";import{S as xe}from"./SidePanelTablePagination-ci5SCdZ3.js";import{L as ge}from"./constants-CXofZZ4i.js";import{T as ve}from"./TruncatedCell-DQQZxgbr.js";import{u as Se}from"./useExpandableRow-CGDZ27WS.js";import{u as fe}from"./useGetTags-BbkSXw8M.js";import{u as je}from"./useRoles-CK1OAvut.js";import{u as _e}from"./useInstanceSearchHelpTerms-B6zUvV92.js";import"./ListTitle-anvzyHx6.js";import"./NoData-CT6SeJUX.js";import"./ResponsiveTable-C-8YbfBJ.js";import"./StaticLink-BX9qJBBO.js";import"./TextConfirmationModal-DuGXYB1S.js";import"./InfoGrid-CVtcW3Y8.js";import"./InfoItem-DMBAN7ig.js";import"./Truncated-DtD6hAHP.js";import"./formikErrors-Bw8iTXYS.js";const ye=()=>{const s=W(),{data:t,isPending:a}=$({queryKey:["availabilityZones"],queryFn:async()=>s.get("computers/availability-zones")});return{availabilityZones:t?.data.values??[],isGettingAvailabilityZones:a}},Ce="_menuContainer_5qitl_1",be="_wrapper_5qitl_6",q={menuContainer:Ce,wrapper:be},Pe=({filters:s,collapseFrom:t="md",className:a,menuPosition:o="left",isCollapsed:c=!1,menuLabel:i=e.jsxs(e.Fragment,{children:[e.jsx(p.Icon,{name:"filter"}),e.jsx("span",{children:"Filters"})]})})=>{const r=D(`(min-width: ${M[t]}px)`);return e.jsx("div",{className:y(q.wrapper,a),children:r&&!c?s.map((n,l)=>e.jsx("span",{children:n},l)):e.jsx(p.ContextualMenu,{position:o,hasToggleIcon:!0,toggleLabel:i,toggleClassName:"u-no-margin--bottom",children:e.jsx("div",{className:q.menuContainer,children:s.map((n,l)=>n.type.name?e.jsx(re,{el:n},l):n)})})})},Ie="_label_1i8qt_1",we={label:Ie},Ne=({options:s,label:t,inline:a=!1})=>{const{disabledColumns:o,setPageParams:c}=S(),i=r=>s.filter(({value:n})=>!r.includes(n)).map(({value:n})=>n);return C("disabledColumns",s.filter(r=>r.canBeHidden).map(r=>r.value)),e.jsx(b,{type:"multiple",showSelectedItemCount:!0,label:e.jsxs(e.Fragment,{children:[e.jsx(p.Icon,{name:"settings"}),e.jsx("span",{className:we.label,children:t})]}),onItemsSelect:r=>{c({disabledColumns:i(r)})},options:s,disabledOptions:s.filter(({canBeHidden:r})=>!r),selectedItems:i(o),inline:a})},Q=(s,t={})=>{const a=z(),{data:o,isLoading:c}=$({queryKey:["savedSearches",s],queryFn:async()=>a.get("GetSavedSearches",{params:s}),...t});return{savedSearches:o?.data??[],isLoadingSavedSearches:c}},Be=()=>{const s=z(),t=U(),{mutateAsync:a,isPending:o}=V({mutationKey:["savedSearches","remove"],mutationFn:async c=>s.get("RemoveSavedSearch",{params:c}),onSuccess:async()=>t.invalidateQueries({queryKey:["savedSearches"]})});return{removeSavedSearch:a,isRemovingSavedSearch:o}},Te=({savedSearch:s,onSavedSearchRemove:t})=>{const{removeSavedSearch:a,isRemovingSavedSearch:o}=Be(),{notify:c}=X(),i=J(),r=async n=>{try{await a({name:n}),t&&t(),c.success({message:`Saved search ${n} successfully removed`,title:"Saved search removed"})}catch(l){i(l)}};return e.jsx(p.ConfirmationButton,{className:"has-icon u-no-margin--bottom u-no-padding--bottom u-no-padding--top",type:"button",appearance:"base","aria-label":`Remove ${s.title} saved search`,confirmationModalProps:{title:"Remove saved search",children:e.jsxs("p",{children:['This will remove the saved search "',s.title,'".']}),confirmButtonLabel:"Remove",confirmButtonAppearance:"negative",confirmButtonDisabled:o,confirmButtonLoading:o,onConfirm:()=>r(s.name)},children:e.jsx(p.Icon,{name:p.ICONS.delete})})},Ee="_actions_1yd1y_1",Re={actions:Ee},Z=({savedSearch:s,onSavedSearchRemove:t,onBackButtonPress:a})=>e.jsxs("div",{className:Re.actions,children:[e.jsx(ce,{savedSearch:s,onBackButtonPress:a}),e.jsx(Te,{savedSearch:s,onSavedSearchRemove:t})]}),Fe=s=>t=>{const a={};return t.column.id==="search"&&t.row.index===s&&(a.className="expandedCell"),a},ke=s=>t=>{const a={};return t.index===s&&(a.className="expandedRow"),a},Le=({savedSearches:s})=>{const{setSidePanelContent:t}=k(),{expandedRowIndex:a,getTableRowsRef:o,handleExpand:c}=Se(),i=d.useCallback(()=>{t("Manage saved searches",e.jsx(d.Suspense,{fallback:e.jsx(_,{}),children:e.jsx(O,{})}),L)},[t]),r=d.useMemo(()=>[{accessor:"title",Header:"Title"},{accessor:"search",Header:"Search Query",Cell:({row:{original:n,index:l}})=>e.jsx(ve,{content:e.jsx("code",{children:n.search}),isExpanded:l===a,onExpand:()=>{c(l)}})},{...ge,Cell:({row:n})=>e.jsx(Z,{savedSearch:n.original,onBackButtonPress:i})}],[a,c,i]);return e.jsx("div",{ref:o,children:e.jsx(p.ModularTable,{columns:r,data:s,emptyMsg:"No saved searches found.",getCellProps:Fe(a),getRowProps:ke(a)})})},O=()=>{const[s,t]=d.useState(1),[a,o]=d.useState(Y),{savedSearches:c,isLoadingSavedSearches:i}=Q(),{setSidePanelContent:r}=k(),n=d.useMemo(()=>{const l=(s-1)*a,u=l+a;return c.slice(l,u)},[c,s,a]);return i?e.jsx(_,{}):e.jsxs("div",{children:[e.jsx(G,{onBackButtonPress:()=>{r("Manage saved searches",e.jsx(d.Suspense,{fallback:e.jsx(_,{}),children:e.jsx(O,{})}),L)}}),e.jsx(Le,{savedSearches:n}),e.jsx(xe,{currentPage:s,totalItems:c.length,pageSize:a,paginate:l=>{t(l)},setPageSize:l=>{o(l)}})]})},Oe="_container_hvgkv_1",qe="_header_hvgkv_6",Ae="_list_hvgkv_12",$e="_listItem_hvgkv_17",De="_actions_hvgkv_25",Me="_search_hvgkv_33",Ge="_row_hvgkv_45",ze="_truncated_hvgkv_53",Qe="_searchQuery_hvgkv_77",m={container:Oe,header:qe,list:Ae,listItem:$e,actions:De,search:Me,row:Ge,truncated:ze,searchQuery:Qe},Ze=({onSavedSearchClick:s,savedSearches:t,onManageSearches:a,onSavedSearchRemove:o})=>{const{setSidePanelContent:c}=k(),i=D(`(min-width: ${M.lg}px)`);if(!t.length)return null;const r=()=>{a(),c("Manage saved searches",e.jsx(d.Suspense,{fallback:e.jsx(_,{}),children:e.jsx(O,{})}),L)};return e.jsxs("div",{className:m.container,children:[e.jsxs("div",{className:m.header,children:[e.jsx("p",{className:"p-text--small-caps u-text--muted p-text--small",children:"Saved searches"}),e.jsx(p.Button,{type:"button",appearance:"secondary",className:"is-small",onClick:r,children:"Manage"})]}),e.jsx("ul",{className:y("p-list--divided u-no-margin--bottom",m.list),children:t.map(n=>e.jsx("li",{children:e.jsxs("div",{className:m.listItem,children:[e.jsx(p.Button,{type:"button",appearance:"base",className:m.search,onClick:()=>{s(n)},children:e.jsxs(p.Row,{className:m.row,children:[e.jsx(p.Col,{size:4,children:e.jsx(p.Tooltip,{message:n.title,positionElementClassName:m.truncated,children:e.jsx("span",{children:n.title})})}),e.jsx(p.Col,{size:8,className:y(!i&&m.searchQuery),children:e.jsx(p.Tooltip,{message:n.search,positionElementClassName:m.truncated,children:e.jsx("code",{children:n.search})})})]})}),e.jsx("div",{className:m.actions,children:e.jsx(Z,{savedSearch:n,onSavedSearchRemove:o})})]})},n.name))})]})},He="_infoContainer_qggov_1",Ke="_helpButtonContainer_qggov_9",We="_helpButton_qggov_9",B={infoContainer:He,helpButtonContainer:Ke,helpButton:We},Ue=({onHelpButtonClick:s})=>e.jsx("div",{className:B.infoContainer,children:e.jsx("div",{className:B.helpButtonContainer,children:e.jsx(p.Button,{type:"button",appearance:"base",hasIcon:!0,"aria-label":"Search help",className:B.helpButton,onClick:t=>{t.stopPropagation(),s()},children:e.jsx(p.Icon,{name:p.ICONS.help})})})}),Ve="_container_fqj7b_1",Xe="_prompt_fqj7b_10",Je="_saveButton_fqj7b_17",T={container:Ve,prompt:Xe,saveButton:Je},Ye=({onSearchSave:s,search:t})=>e.jsx(e.Fragment,{children:t&&e.jsxs("div",{className:T.container,children:[e.jsxs("span",{className:T.prompt,children:[e.jsx("span",{children:"Search for "}),e.jsx("span",{className:"p-search-and-filter__search-query",children:t}),e.jsx("span",{children:"..."})]}),e.jsx(G,{buttonLabel:"Save search",appearance:"link",className:T.saveButton,afterCreate:s,search:t})]})}),es="_searchContainer_pk8ic_1",ss="_form_pk8ic_8",ts="_searchBoxContainer_pk8ic_13",as="_input_pk8ic_17",w={searchContainer:es,form:ss,searchBoxContainer:ts,input:as},A=({inputText:s,savedSearches:t,search:a})=>{if(!t)return[];let o=t;if(a){const c=a.split(",").filter(Boolean);o=o.filter(({name:i})=>c.every(r=>r!==`search:${i}`))}if(s){const c=s.trim().toLowerCase();o=o.filter(({name:i,search:r})=>i.toLowerCase().includes(c)||r.toLowerCase().includes(c))}return o},ns=({onHelpButtonClick:s})=>{const{query:t,setPageParams:a}=S(),[o,c]=d.useState(t??""),[i,r]=d.useState(!1),{savedSearches:n,isLoadingSavedSearches:l}=Q(),u=d.useRef(null),f=d.useRef(null);ee(u,h=>{const g=document.querySelector(".p-modal");g&&g.contains(h.target)||r(!1)}),d.useEffect(()=>{c(t??"")},[t]);const P=d.useMemo(()=>A({inputText:o,savedSearches:n,search:t}),[n,o,t]),j=()=>{const h=o.trim();if(!h)return;const H=A({inputText:"",savedSearches:n,search:t}).some(({name:K})=>K.toLowerCase()===h.toLowerCase())?"search:":"";a({query:`${H}${h}`})},I=h=>{a({query:`search:${h.name}`})},x=h=>{const{key:g}=h;i?(g==="Escape"&&r(!1),g==="Enter"&&j()):g==="Enter"&&r(!0)};return e.jsxs("div",{className:"p-search-and-filter",ref:u,children:[e.jsxs("div",{className:y("p-search-and-filter__search-container",w.searchContainer),"aria-expanded":i,ref:f,onClick:()=>{r(!0)},children:[e.jsx(p.Form,{onSubmit:h=>{h.preventDefault(),j()},className:y("p-search-and-filter__box",w.form),children:e.jsx("div",{className:w.searchBoxContainer,children:e.jsx(p.SearchBox,{externallyControlled:!0,shouldRefocusAfterReset:!0,autocomplete:"off",className:w.input,value:o,onChange:h=>{c(h)},onClear:()=>{c(""),a({query:""})},onSearch:j,onClick:()=>{r(!0)},onKeyUp:x})})}),e.jsx(Ue,{onHelpButtonClick:s})]}),i&&l&&e.jsx(_,{}),i&&!l&&e.jsxs("div",{className:"p-search-and-filter__panel",children:[e.jsx(Ye,{onSearchSave:()=>{c("")},search:o.trim()}),e.jsx(Ze,{onSavedSearchClick:I,onManageSearches:()=>{r(!1)},onSavedSearchRemove:()=>{r(!0)},savedSearches:P})]})]})},os=({options:s,label:t,inline:a=!1})=>{const{accessGroups:o,setPageParams:c}=S();return C("accessGroups",s.map(i=>i.value)),e.jsx(b,{type:"multiple",label:t,hasToggleIcon:!0,hasBadge:!0,options:s,onItemsSelect:i=>{c({accessGroups:i})},selectedItems:o,inline:a})},rs=({options:s,label:t,inline:a=!1})=>{const[o,c]=d.useState(""),{availabilityZones:i,setPageParams:r}=S(),n=s.length>9&&o?s.filter(({value:u})=>u!=="none"&&u.includes(o)):s;C("availabilityZones",n.map(u=>u.value));const l=u=>{u[u.length-1]==="none"?r({availabilityZones:["none"]}):r({availabilityZones:u[0]!=="none"?u:u.filter(f=>f!=="none")})};return e.jsx(b,{type:"multiple",label:t,hasToggleIcon:!0,hasBadge:!0,onSearch:s.length>9?u=>{c(u)}:void 0,options:n,onItemsSelect:l,selectedItems:i,inline:a})},cs=({options:s,label:t,inline:a=!1})=>e.jsx(F,{pageParamKey:"contractExpiryDays",label:t,options:s,inline:a}),is=({options:s,label:t,inline:a=!1})=>{const[o,c]=d.useState(""),{tags:i,setPageParams:r}=S(),n=s.filter(({value:l})=>l.includes(o));return C("tags",n.map(l=>l.value)),e.jsx(b,{type:"multiple",label:t,hasToggleIcon:!0,hasBadge:!0,options:n,onItemsSelect:l=>{r({tags:l})},onSearch:l=>{c(l)},selectedItems:i,inline:a})},ls=({label:s,options:t,inline:a=!1})=>{const{wsl:o,setPageParams:c}=S();return C("wsl",["parent","child"]),e.jsx(b,{type:"multiple",label:s,hasToggleIcon:!0,hasBadge:!0,options:t,onItemsSelect:i=>{c({wsl:i})},selectedItems:o,inline:a})},us="_top_pb55r_1",ds="_searchContainer_pb55r_9",ps="_divider_pb55r_18",E={top:us,searchContainer:ds,divider:ps},hs=({columnFilterOptions:s})=>{const t=_e(),[a,o]=d.useState(!1),{getAccessGroupQuery:c}=je(),{tags:i}=fe(),r=i.map(x=>({label:x,value:x}))??[],{availabilityZones:n}=ye(),l=n.reduce((x,h)=>(x.push({label:h,value:h}),x),[{label:"Without zones",value:"none",group:"1"}]),{data:u}=c(),f=u?.data.map(({name:x,title:h})=>({value:x,label:h}))??[],N=v.status.options,P=v.os.options,j=v.wsl.options,I=v.contractExpiryDays.options;return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:E.top,children:[e.jsx("div",{className:E.searchContainer,children:e.jsx(ns,{onHelpButtonClick:()=>{o(!0)}})}),e.jsx(Pe,{isCollapsed:!0,filters:[e.jsx(F,{pageParamKey:"status",label:"Status",options:N},"status"),e.jsx(F,{label:"OS",options:P,pageParamKey:"os"},"os"),e.jsx(rs,{label:"Availability zones",options:l},"availability-zone"),e.jsx(os,{label:"Access groups",options:f},"access-group"),e.jsx(is,{label:"Tags",options:r},"tag"),e.jsx(ls,{label:"WSL",options:j},"wsl"),e.jsx(cs,{label:"Contract expiry",options:I},"contract-expiry"),e.jsx("span",{className:E.divider},"divider-2"),e.jsx(Ne,{label:"Columns",options:s},"column")]})]}),e.jsx(he,{filtersToDisplay:["accessGroups","os","availabilityZones","status","tags","wsl","contractExpiryDays"],accessGroupOptions:f,availabilityZonesOptions:l,osOptions:P,statusOptions:N,tagOptions:r,wslOptions:j,contractExpiryOptions:I}),e.jsx(me,{open:a,data:t,onClose:()=>{o(!1)}}),e.jsx(ie,{})]})},ms=d.memo(function({instanceCount:t,instances:a,isGettingInstances:o,selectedInstances:c,setSelectedInstances:i}){const[r,n]=d.useState([]),l=d.useCallback(()=>{i([])},[]);return e.jsxs(e.Fragment,{children:[e.jsx(hs,{columnFilterOptions:r}),o?e.jsx(_,{}):e.jsx(le,{instances:a,selectedInstances:c,setColumnFilterOptions:n,setSelectedInstances:i}),e.jsx(pe,{totalItems:t,handleClearSelection:l,currentItemCount:a.length})]})}),R=(s,t)=>s.type==="select"?s.options.find(a=>a.value===t)?.query??"":"",xs=({accessGroups:s,availabilityZones:t,contractExpiryDays:a,os:o,query:c,status:i,tags:r})=>{const n=[];return o&&n.push(R(v.os,o)),i&&n.push(R(v.status,i)),a&&n.push(R(v.contractExpiryDays,a)),c&&n.push(...c.split(",")),r.length&&n.push(`tag:${r.join(" OR tag:")}`),s.length&&n.push(`access-group:${s.join(" OR access-group:")}`),t.length&&n.push(t.includes("none")?"availability-zone:null":`availability-zone:${t.join(" OR availability-zone:")}`),n.join(" ")},Qs=()=>{const{currentPage:s,pageSize:t,wsl:a,...o}=S(),{instances:c,instancesCount:i,isGettingInstances:r,isErrorInstances:n}=oe({query:xs(o),archived_only:o.status==="archived",with_alerts:!0,with_upgrades:se,limit:t,offset:(s-1)*t,wsl_children:a.includes("child"),wsl_parents:a.includes("parent")}),{selectedItems:l,setSelectedItems:u}=de(c,r||n);return e.jsxs(te,{children:[e.jsx(ae,{title:"Instances",actions:[e.jsx(ue,{isGettingInstances:r,selectedInstances:l},"actions")]}),e.jsx(ne,{hasTable:!0,children:e.jsx(ms,{instanceCount:i,instances:c,isGettingInstances:r,selectedInstances:l,setSelectedInstances:u})})]})};export{Qs as default};
