import{v as I,w as M,z as P,B as k,y as $,r as h,g as O,j as n,d as l,e as q,x as E}from"./index-DYykpNVa.js";import{S as G}from"./SidePanelFormButtons-Aj5ThB2m.js";import{u as N,T as R}from"./TagsAddConfirmationModal-BaByvYt8.js";import{u as z}from"./useGetTags-BbkSXw8M.js";import{u as D}from"./useFetchOld-BGD2hIpr.js";import"./SidePanelFormButtons.module-CcPyiogC.js";import"./ModalTablePagination-C4fLxOQV.js";const Q=()=>{const e=D(),r=I(),{isPending:d,mutateAsync:g}=M({mutationFn:async m=>e.get("AddTagsToComputers",{params:m}),onSuccess:async()=>r.invalidateQueries({queryKey:["instances"]})});return{addTagsToInstances:g,isAddingTagsToInstances:d}},X=({selected:e})=>{const r=P(),{notify:d}=k(),{closeSidePanel:g}=$(),{addTagsToInstances:m,isAddingTagsToInstances:f}=Q(),{tags:T,isGettingTags:x}=z(),[t,u]=h.useState([]),{isFetchingProfileChanges:C,refetchProfileChanges:b}=N({instance_ids:e.map(s=>s.id),tags:T,limit:10},{enabled:!1}),{value:v,setFalse:j,setTrue:S}=O(),[c,w]=h.useState(""),y=async()=>{try{await m({query:e.map(({id:s})=>`id:${s}`).join(" OR "),tags:t}),g(),d.success({title:"Tags assigned",message:`Tags successfully assigned to ${E(e.length,`"${e[0]?.title??""}" instance`,`${e.length} instances`)}`})}catch(s){r(s)}},A=async()=>{const s=await b();if(!s.isSuccess){r(s.error);return}s.data.data.count?S():await y()},o=T.filter(s=>s.toLowerCase().includes(c.toLowerCase()))??[],F=()=>{o.every(s=>t.includes(s))?u([]):u(o)},L=h.useMemo(()=>[{accessor:"value",Header:n.jsxs(n.Fragment,{children:[n.jsx(l.CheckboxInput,{inline:!0,label:null,disabled:o.every(s=>e.every(i=>i.tags.includes(s))),checked:o.every(s=>t.includes(s)||e.every(i=>i.tags.includes(s))),indeterminate:o.some(s=>e.some(i=>!i.tags.includes(s)))&&o.some(s=>e.some(i=>i.tags.includes(s))),onChange:F}),"Name"]}),Cell:({row:{original:{value:s},index:i}})=>{const B=()=>{if(t.includes(s)){u(t.toSpliced(t.findIndex(a=>a==s),1));return}e.every(a=>a.tags.includes(s))||u([...t,s])};return n.jsx(l.CheckboxInput,{inline:!0,label:s,disabled:e.every(a=>a.tags.includes(s)),name:`tag-${i}`,checked:t.includes(s)||e.every(a=>a.tags.includes(s)),indeterminate:!t.includes(s)&&e.some(a=>a.tags.includes(s))&&e.some(a=>!a.tags.includes(s)),onChange:B})}}],[t,o]);if(x)return n.jsx(q,{});const p=o.map(s=>({value:s}));return n.jsxs(n.Fragment,{children:[n.jsx("p",{children:"Adding tags will associate the instance with the profiles that tag is linked to. This may change configurations on your instance."}),n.jsx(l.SearchBox,{value:c,onChange:s=>{w(s)}}),n.jsx(l.ModularTable,{emptyMsg:"No tags found",columns:L,data:[...p.filter(({value:s})=>s.toLowerCase().startsWith(c.toLowerCase())),...p.filter(({value:s})=>!s.toLowerCase().startsWith(c.toLowerCase()))]}),n.jsx(G,{onSubmit:A,submitButtonDisabled:!t.length,submitButtonLoading:f||C,submitButtonText:"Assign"}),v&&n.jsx(R,{instances:e,tags:t,onConfirm:y,confirmButtonLoading:f,close:j})]})};export{X as default};
