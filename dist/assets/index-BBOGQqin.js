const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-C5_sZ19O.js","assets/index-DYykpNVa.js","assets/index-hef1aQzf.css","assets/useRoles-CK1OAvut.js","assets/useFetchOld-BGD2hIpr.js","assets/SidePanelFormButtons-Aj5ThB2m.js","assets/SidePanelFormButtons.module-CcPyiogC.js","assets/SidePanelFormButtons-DP4HE5AU.css","assets/formikErrors-Bw8iTXYS.js","assets/PageMain-BnPck7ZK.js","assets/PageMain-30196XJe.css","assets/constants-CXofZZ4i.js","assets/ResponsiveTable-C-8YbfBJ.js","assets/ResponsiveTable-Czda4kFo.css","assets/TruncatedCell-DQQZxgbr.js","assets/Truncated-DtD6hAHP.js","assets/Truncated-uqJp6ujM.css","assets/TruncatedCell-DraJKZqh.css"])))=>i.map(i=>d[i]);
import{r as g,j as o,d as v,z as k,B,y as j,C as V,p as $,J as C,i as _,g as Q,ab as H,x as z,e as A,q as U,E as q,$ as E}from"./index-DYykpNVa.js";import{P as W,a as Y,b as J}from"./PageMain-BnPck7ZK.js";import{u as w}from"./useRoles-CK1OAvut.js";import{L as K}from"./constants-CXofZZ4i.js";import{R as X}from"./ResponsiveTable-C-8YbfBJ.js";import{T}from"./TruncatedCell-DQQZxgbr.js";import{S as Z}from"./SidePanelFormButtons-Aj5ThB2m.js";const N=s=>s.reduce((e,{global:t,name:n,title:l})=>{if(n==="RemoveComputerFromAccessGroup")return e;const a=/view/i.test(n)?"view":"manage",r=n==="AddComputerToAccessGroup"?"access group":l.replace(/(view|manage) /i,"").replace(/computer/i,"instance"),u=e.find(({label:i})=>i===r)||{global:t,label:r,values:{manage:"",view:""}};return u.values[a]=n,[...e.filter(({label:i})=>i!==r),u]},[]),ee=s=>{const e={maxDepth:0,options:s.filter(t=>t.parent==="").map(({name:t,title:n})=>({children:[],depth:0,label:n,parents:[],value:t}))};for(;e.maxDepth>=0;){const t=e.options.filter(({depth:l})=>l===e.maxDepth);e.maxDepth++;const n=s.filter(({parent:l})=>t.some(({value:a})=>a===l));if(n.length===0)break;for(const{name:l,parent:a,title:r}of n){const u=t.find(({value:c})=>c===a);if(!u)continue;const i=[a,...u.parents];e.options.push({children:[],depth:e.maxDepth,label:r,parents:i,value:l});for(const c of i){const d=e.options.find(({value:m})=>m===c);d&&d.children.push(l)}}}return e.options},S=(s,e,t)=>{const n=t.find(l=>l.depth===e&&s.includes(l.value));if(n)return n.value;throw new Error},se=s=>s.sort((e,t)=>{if(e.children.includes(t.value))return-1;if(t.children.includes(e.value))return 1;for(let n=0;n<Math.min(e.depth,t.depth);n++){const l=S(e.parents,n,s),a=S(t.parents,n,s);if(l!==a)return l.localeCompare(a)}return e.value.localeCompare(t.value)}),ne=(s,e)=>{const t=Math.max(...e.map(({depth:l})=>l)),n=s;if(s.length>0)for(let l=0;l<t;l++){const a=e.filter(({depth:r})=>r===l).filter(({value:r})=>s.includes(r));for(const r of a)if(r.children.every(u=>s.includes(u))){const u=s.filter(i=>!r.children.includes(i));s.splice(0,s.length,...u)}}return n},ae="_container_1huj5_1",te="_checkboxColumn_1huj5_7",R={container:ae,checkboxColumn:te},oe=({option:s,permissions:e})=>s.values.view===""||e.includes(s.values.manage),G=({description:s,onPermissionChange:e,options:t,permissions:n,title:l})=>{const a=g.useMemo(()=>t.sort((i,c)=>i.values.view===""&&c.values.view!==""?-1:i.values.view!==""&&c.values.view===""?1:i.label.localeCompare(c.label)),[t]),r=(i,c)=>{n.includes(i.values[c])?e(n.filter(d=>d!==i.values[c])):e(c==="view"?[...n,i.values.view]:i.values.view!==""&&!n.includes(i.values.view)?[...n,i.values.manage,i.values.view]:[...n,i.values.manage])},u=g.useMemo(()=>[{accessor:"label",Header:"Property",Cell:({row:i})=>i.original.label.replace(/^\w/,c=>c.toUpperCase())},{accessor:"view",className:R.checkboxColumn,Header:"View",Cell:({row:i})=>o.jsx(v.CheckboxInput,{inline:!0,label:o.jsx("span",{className:"u-off-screen",children:`View ${i.original.label}`}),name:"permissions",value:i.original.values.view,disabled:oe({option:i.original,permissions:n}),checked:i.original.values.view===""||n.includes(i.original.values.view),onChange:()=>{r(i.original,"view")}})},{accessor:"manage",className:R.checkboxColumn,Header:"Manage",Cell:({row:i})=>o.jsx(v.CheckboxInput,{inline:!0,label:o.jsx("span",{className:"u-off-screen",children:`Manage ${i.original.label}`}),name:"permissions",value:i.original.values.manage,disabled:i.original.values.manage==="",checked:n.includes(i.original.values.manage),onChange:()=>{r(i.original,"manage")}})}],[a,n.length]);return o.jsxs("div",{className:R.container,children:[o.jsx("p",{className:"p-heading--5 u-no-margin--bottom",children:l}),o.jsx("p",{className:"p-text--small u-text--muted",children:s}),o.jsx(v.ModularTable,{columns:u,data:a,getHeaderProps:()=>({className:"u-text--muted"})})]})},ie=1.5,re=({accessGroupOptions:s,accessGroups:e,onAccessGroupChange:t})=>{const n=(a,r)=>{if(e.includes(a.value)||e.some(u=>a.children.includes(u)))t(e.filter(u=>![a.value,...a.children,...a.parents].includes(u)));else{const u=[...e,a.value,...a.children];for(let i=a.depth-1;i>=0;i--){const c=r.filter(({depth:d})=>d===i).find(({value:d})=>a.parents.includes(d));if(c&&c.children.every(d=>u.includes(d)))u.push(c.value);else break}t(u)}},l=a=>a.some(r=>e.includes(r))&&a.some(r=>!e.includes(r));return o.jsxs(o.Fragment,{children:[o.jsx("p",{className:"p-heading--5 u-no-margin--bottom",children:"Access Groups"}),s.map((a,r,u)=>o.jsx("div",{style:{marginLeft:`${ie*a.depth}rem`},children:o.jsx(v.CheckboxInput,{label:a.label,labelClassName:"u-no-margin",name:"access_groups",checked:e.includes(a.value),indeterminate:l(a.children),onChange:()=>{n(a,u)}},a.value)},a.value))]})},y=(s,e)=>{const t=new Set(s);for(const n of e)n.values.manage&&t.has(n.values.manage)&&t.add(n.values.view);return Array.from(t)},le=(s,e,t,n)=>{const l=e.global_permissions?[...e.permissions,...e.global_permissions]:e.permissions,a=y(l,n),r=y(s.permissions,n),u=r.filter(p=>!a.includes(p)),i=a.filter(p=>!r.includes(p));u.includes("AddComputerToAccessGroup")&&u.push("RemoveComputerFromAccessGroup"),i.includes("AddComputerToAccessGroup")&&i.push("RemoveComputerFromAccessGroup");const c=ne(s.accessGroups,t),d=c.filter(p=>!e.access_groups.includes(p)),m=e.access_groups.filter(p=>!c.includes(p));return{accessGroupsToAdd:d,accessGroupsToRemove:m,permissionsToAdd:u,permissionsToRemove:i}},ce=(s,e,t,n,l)=>{const{addAccessGroups:a,addPermissions:r,removeAccessGroups:u,removePermissions:i}=l,c={},{accessGroupsToAdd:d,accessGroupsToRemove:m,permissionsToAdd:p,permissionsToRemove:b}=le(s,e,t,n);return d.length>0&&(c.addAccessGroupsPromise=a({name:e.name,access_groups:d})),m.length>0&&(c.removeAccessGroupsPromise=u({name:e.name,access_groups:m})),b.length>0&&(c.removePermissionsPromise=i({name:e.name,permissions:b})),p.length>0&&(c.addPermissionsPromise=r({name:e.name,permissions:p})),c},ue=(s,e,t)=>{const n=[...s.access_groups,...s.access_groups.flatMap(r=>e.find(({value:u})=>u===r)?.children||[])],l=s.global_permissions?[...s.permissions,...s.global_permissions]:s.permissions,a=y(l,t);return{accessGroups:n,permissions:a}},de={accessGroups:[],permissions:[]},me=$().shape({accessGroups:C().of(_()),permissions:C().of(_())}),pe=({role:s})=>{const e=k(),{notify:t}=B(),{closeSidePanel:n}=j(),{addPermissionsToRoleQuery:l,addAccessGroupsToRoleQuery:a,getAccessGroupQuery:r,getPermissionsQuery:u,removeAccessGroupsFromRoleQuery:i,removePermissionsFromRoleQuery:c}=w(),{data:d}=u(),m=d?N(d.data):[],{data:p}=r(),b=p?se(ee(p.data)):[],{mutateAsync:D}=l,{mutateAsync:F}=a,{mutateAsync:L}=i,{mutateAsync:M}=c,f=V({initialValues:de,validationSchema:me,onSubmit:async h=>{const x=ce(h,s,b,m,{addAccessGroups:F,addPermissions:D,removeAccessGroups:L,removePermissions:M});if(!Object.values(x).some(Boolean)){n();return}try{x.addPermissionsPromise&&x.removePermissionsPromise?(await Promise.all(Object.entries(x).filter(([P,O])=>P!=="addPermissionsPromise"&&O).map(([,P])=>P)),await x.addPermissionsPromise):await Promise.all(Object.values(x).filter(Boolean)),n(),t.success({title:"Role changes have been saved",message:`You modified the role '${s.name}'`})}catch(P){e(P)}}});return g.useEffect(()=>{f.setValues(ue(s,b,m))},[s,b.length]),o.jsxs(v.Form,{onSubmit:f.handleSubmit,noValidate:!0,children:[o.jsx(G,{description:"These permissions are for managing the account as a whole. They are not limited to the specified access groups, but instead apply globally.",onPermissionChange:h=>f.setFieldValue("permissions",h),options:m.filter(({global:h})=>h),permissions:f.values.permissions,title:"Global permissions"}),o.jsx(G,{description:"These permissions only apply to selected access groups.",onPermissionChange:h=>f.setFieldValue("permissions",h),options:m.filter(({global:h})=>!h),permissions:f.values.permissions,title:"Permissions"}),o.jsx(re,{accessGroupOptions:b,accessGroups:f.values.accessGroups,onAccessGroupChange:h=>{f.setFieldValue("accessGroups",h)}}),o.jsx(Z,{submitButtonDisabled:f.isSubmitting,submitButtonText:"Save changes"})]})},ge=({role:s})=>{const e=k(),{setSidePanelContent:t}=j(),{removeRoleQuery:n}=w(),{value:l,setTrue:a,setFalse:r}=Q(),{mutateAsync:u,isPending:i}=n,c=async()=>{try{await u({name:s.name})}catch(m){e(m)}finally{r()}},d=()=>{t(`Edit "${s.name}" role`,o.jsx(g.Suspense,{fallback:o.jsx(A,{}),children:o.jsx(pe,{role:s})}))};return o.jsxs(o.Fragment,{children:[o.jsx(H,{toggleAriaLabel:`${s.name} role actions`,actions:[{icon:"edit",label:"Edit","aria-label":`Edit "${s.name}" role`,onClick:d}],destructiveActions:[{icon:"delete",label:"Remove","aria-label":`Remove "${s.name}" role`,onClick:a}]}),l&&o.jsx(v.ConfirmationModal,{close:r,title:`Remove '${s.name}' role`,confirmButtonLabel:"Remove",confirmButtonAppearance:"negative",confirmButtonDisabled:i,confirmButtonLoading:i,onConfirm:c,children:o.jsxs("p",{children:[o.jsx("span",{children:`This will remove '${s.name}' role.`}),s.persons.length>0&&o.jsxs(o.Fragment,{children:[o.jsx("br",{}),o.jsx("strong",{children:`This will affect ${s.persons.length} ${z(s.persons.length,"administrator")}.`})]})]})})]})},I=(s,e,t)=>{const n=s.global_permissions?[...s.permissions,...s.global_permissions]:s.permissions,l=[...new Set(n.filter(a=>t==="manage"?!/(view|remove)/i.test(a):!/(remove)/i.test(a)&&!e.find(({values:r})=>r.manage===a&&!r.view)).map(a=>e.find(({values:r})=>t==="manage"?r.manage===a:r.view===a||r.manage===a)?.label??""))];return l.length===0?"":l.length!==e.filter(({values:a})=>!!a[t]).length?l.map((a,r)=>r>0?a:a.replace(/^\w/,u=>u.toUpperCase())).join(", "):"All properties"},he=s=>({column:e,row:{index:t}})=>{const n={};return s&&s.rowIndex===t&&s.columnId===e.id&&(n.className="expandedCell"),e.id==="name"?n.role="rowheader":e.id==="persons"?n["aria-label"]="Administrators":e.id==="view"?n["aria-label"]="View permissions":e.id==="manage"?n["aria-label"]="Manage permissions":e.id==="actions"&&(n["aria-label"]="Actions"),n},fe=s=>({index:e})=>{const t={};return s===e&&(t.className="expandedRow"),t},ve=s=>e=>{e&&(s.current=[...e.querySelectorAll("tbody tr")])},be="_administrators_18216_1",xe={administrators:be},Pe=({roleList:s})=>{const[e,t]=g.useState(null),n=g.useRef([]);U({current:e?n.current[e.rowIndex]:null},()=>{t(null)});const{getPermissionsQuery:l}=w(),{data:a}=l(),r=a?N(a.data):[],u=g.useMemo(()=>s,[s]),i=g.useMemo(()=>[{accessor:"name",Header:"Name"},{accessor:"persons",Header:"Administrators",className:xe.administrators,Cell:({row:c})=>c.original.persons.length},{accessor:"view",Header:"View",Cell:({row:{original:c,index:d}})=>o.jsx(T,{content:I(c,r,"view"),isExpanded:!!e&&e.rowIndex===d&&e.columnId==="view",onExpand:()=>{t({rowIndex:d,columnId:"view"})}})},{accessor:"manage",Header:"Manage",Cell:({row:{original:c,index:d}})=>o.jsx(T,{content:I(c,r,"manage"),isExpanded:e?.rowIndex===d&&e.columnId==="manage",onExpand:()=>{t({rowIndex:d,columnId:"manage"})}})},{...K,Cell:({row:c})=>c.original.name=="GlobalAdmin"?null:o.jsx(ge,{role:c.original})}],[u,a,e]);return o.jsx(X,{ref:ve(n),columns:i,data:u,getCellProps:he(e),getRowProps:fe(e?.rowIndex)})},Ae=g.lazy(()=>E(()=>import("./index-C5_sZ19O.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17]))),je=()=>{const{setSidePanelContent:s}=j(),{getRolesQuery:e}=w(),{data:t,isLoading:n}=e();return o.jsxs(o.Fragment,{children:[n&&o.jsx(A,{}),!n&&(!t||!t.data.length)&&o.jsx(q,{title:"No roles found",body:o.jsxs(o.Fragment,{children:[o.jsx("p",{className:"u-no-margin--bottom",children:"You havenâ€™t added any roles yet."}),o.jsx("a",{href:"https://ubuntu.com/landscape/docs/administrators",target:"_blank",rel:"nofollow noopener noreferrer",children:"How to manage administrators in Landscape"})]}),cta:[o.jsx(v.Button,{type:"button",appearance:"positive",onClick:()=>{s("Add role",o.jsx(g.Suspense,{fallback:o.jsx(A,{}),children:o.jsx(Ae,{})}))},children:"Add role"},"add")]}),!n&&t&&t.data.length>0&&o.jsx(Pe,{roleList:t.data})]})},we=g.lazy(()=>E(()=>import("./index-C5_sZ19O.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17]))),Re=()=>{const{setSidePanelContent:s}=j(),e=()=>{s("Add Role",o.jsx(g.Suspense,{fallback:o.jsx(A,{}),children:o.jsx(we,{})}))};return o.jsxs(W,{children:[o.jsx(Y,{title:"Roles",actions:[o.jsx(v.Button,{type:"button",onClick:e,appearance:"positive",children:"Add role"},"add-role")]}),o.jsx(J,{hasTable:!0,children:o.jsx(je,{})})]})},Ee=Object.freeze(Object.defineProperty({__proto__:null,default:Re},Symbol.toStringTag,{value:"Module"}));export{re as A,G as P,N as a,se as b,ee as c,ne as g,Ee as i};
